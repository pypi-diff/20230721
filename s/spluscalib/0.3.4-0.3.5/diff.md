# Comparing `tmp/spluscalib-0.3.4-py3-none-any.whl.zip` & `tmp/spluscalib-0.3.5-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,17 +1,17 @@
-Zip file size: 149492 bytes, number of entries: 50
+Zip file size: 149477 bytes, number of entries: 50
 -rw-rw-r--  2.0 unx        0 b- defN 21-May-14 02:47 spluscalib/__init__.py
 -rw-rw-r--  2.0 unx     5765 b- defN 21-Jun-05 10:32 spluscalib/dust_laws.py
 -rw-rw-r--  2.0 unx    18909 b- defN 23-Jul-06 23:27 spluscalib/pipeline.py
 -rw-rw-r--  2.0 unx    24012 b- defN 23-May-24 18:21 spluscalib/pipeline_backup.py
 -rw-rw-r--  2.0 unx    22256 b- defN 23-Jun-29 19:03 spluscalib/quality_check.py
 -rw-rw-r--  2.0 unx    12013 b- defN 22-Apr-28 12:37 spluscalib/quality_check_PSF.py
 -rw-rw-r--  2.0 unx    12039 b- defN 22-Mar-07 07:29 spluscalib/quality_check_PSFbackup.py
 -rw-rw-r--  2.0 unx    12938 b- defN 21-Oct-21 22:08 spluscalib/sed_fitting.py
--rw-rw-r--  2.0 unx   211616 b- defN 23-Jul-21 13:30 spluscalib/utils.py
+-rw-rw-r--  2.0 unx   211556 b- defN 23-Jul-21 13:34 spluscalib/utils.py
 -rw-rw-r--  2.0 unx        0 b- defN 21-May-14 02:47 spluscalib/additionalsteps/__init__.py
 -rw-rw-r--  2.0 unx    10844 b- defN 22-May-10 20:35 spluscalib/additionalsteps/combine_calibration_catalogs.py
 -rw-rw-r--  2.0 unx     8615 b- defN 21-Oct-24 08:28 spluscalib/additionalsteps/compute_XY_maps.py
 -rw-rw-r--  2.0 unx     6498 b- defN 22-Apr-26 04:41 spluscalib/additionalsteps/fit_inst_offsets.py
 -rw-rw-r--  2.0 unx     7383 b- defN 22-Apr-26 04:41 spluscalib/additionalsteps/fit_zp_offsets.py
 -rw-rw-r--  2.0 unx        0 b- defN 21-May-14 02:47 spluscalib/steps/__init__.py
 -rw-rw-r--  2.0 unx    19310 b- defN 22-May-11 17:52 spluscalib/steps/calibration_catalog.py
@@ -40,13 +40,13 @@
 -rw-rw-r--  2.0 unx        0 b- defN 21-May-14 02:47 spluscalib/vacs/__init__.py
 -rw-rw-r--  2.0 unx        1 b- defN 21-May-14 02:47 stellarlibrary/__init__.py
 -rw-rw-r--  2.0 unx     5766 b- defN 21-Aug-18 02:59 stellarlibrary/dust_laws.py
 -rw-rw-r--  2.0 unx     2789 b- defN 22-Jun-14 05:33 stellarlibrary/generate_models_photometry.py
 -rw-rw-r--  2.0 unx     2840 b- defN 23-Jul-06 23:12 stellarlibrary/generate_models_photometry_iDR5.py
 -rw-rw-r--  2.0 unx    23858 b- defN 23-Jul-06 23:26 stellarlibrary/models.py
 -rw-rw-r--  2.0 unx    11821 b- defN 21-Sep-14 16:27 stellarlibrary/prior.py
--rw-rw-r--  2.0 unx    35149 b- defN 23-Jul-21 13:31 spluscalib-0.3.4.dist-info/LICENSE
--rw-rw-r--  2.0 unx      558 b- defN 23-Jul-21 13:31 spluscalib-0.3.4.dist-info/METADATA
--rw-rw-r--  2.0 unx       92 b- defN 23-Jul-21 13:31 spluscalib-0.3.4.dist-info/WHEEL
--rw-rw-r--  2.0 unx       26 b- defN 23-Jul-21 13:31 spluscalib-0.3.4.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     4561 b- defN 23-Jul-21 13:31 spluscalib-0.3.4.dist-info/RECORD
-50 files, 706180 bytes uncompressed, 142140 bytes compressed:  79.9%
+-rw-rw-r--  2.0 unx    35149 b- defN 23-Jul-21 13:35 spluscalib-0.3.5.dist-info/LICENSE
+-rw-rw-r--  2.0 unx      558 b- defN 23-Jul-21 13:35 spluscalib-0.3.5.dist-info/METADATA
+-rw-rw-r--  2.0 unx       92 b- defN 23-Jul-21 13:35 spluscalib-0.3.5.dist-info/WHEEL
+-rw-rw-r--  2.0 unx       26 b- defN 23-Jul-21 13:35 spluscalib-0.3.5.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     4561 b- defN 23-Jul-21 13:35 spluscalib-0.3.5.dist-info/RECORD
+50 files, 706120 bytes uncompressed, 142125 bytes compressed:  79.9%
```

## zipnote {}

```diff
@@ -129,23 +129,23 @@
 
 Filename: stellarlibrary/models.py
 Comment: 
 
 Filename: stellarlibrary/prior.py
 Comment: 
 
-Filename: spluscalib-0.3.4.dist-info/LICENSE
+Filename: spluscalib-0.3.5.dist-info/LICENSE
 Comment: 
 
-Filename: spluscalib-0.3.4.dist-info/METADATA
+Filename: spluscalib-0.3.5.dist-info/METADATA
 Comment: 
 
-Filename: spluscalib-0.3.4.dist-info/WHEEL
+Filename: spluscalib-0.3.5.dist-info/WHEEL
 Comment: 
 
-Filename: spluscalib-0.3.4.dist-info/top_level.txt
+Filename: spluscalib-0.3.5.dist-info/top_level.txt
 Comment: 
 
-Filename: spluscalib-0.3.4.dist-info/RECORD
+Filename: spluscalib-0.3.5.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## spluscalib/utils.py

```diff
@@ -984,12243 +984,12240 @@
 00003d70: 6963 7469 6f6e 6172 7920 7769 7468 2066  ictionary with f
 00003d80: 6f72 6d61 7465 6420 7061 7468 730a 2020  ormated paths.  
 00003d90: 2020 2222 220a 0a20 2020 2070 6174 6873    """..    paths
 00003da0: 203d 205b 2773 6176 655f 7061 7468 272c   = ['save_path',
 00003db0: 0a20 2020 2020 2020 2020 2020 2020 2772  .             'r
 00003dc0: 756e 5f70 6174 6827 2c0a 2020 2020 2020  un_path',.      
 00003dd0: 2020 2020 2020 2027 7061 7468 5f74 6f5f         'path_to_
-00003de0: 7365 7827 2c0a 2020 2020 2020 2020 2020  sex',.          
-00003df0: 2020 2027 7061 7468 5f74 6f5f 7377 6172     'path_to_swar
-00003e00: 7027 2c0a 2020 2020 2020 2020 2020 2020  p',.            
-00003e10: 2027 7061 7468 5f74 6f5f 7374 696c 7473   'path_to_stilts
-00003e20: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00003e30: 2770 6174 685f 746f 5f64 6f70 686f 7427  'path_to_dophot'
+00003de0: 7374 696c 7473 272c 0a20 2020 2020 2020  stilts',.       
+00003df0: 2020 2020 2020 2770 6174 685f 746f 5f64        'path_to_d
+00003e00: 6f70 686f 7427 2c0a 2020 2020 2020 2020  ophot',.        
+00003e10: 2020 2020 2027 7061 7468 5f74 6f5f 696d       'path_to_im
+00003e20: 6167 6573 272c 0a20 2020 2020 2020 2020  ages',.         
+00003e30: 2020 2020 2773 6578 5f63 6f6e 6669 6727      'sex_config'
 00003e40: 2c0a 2020 2020 2020 2020 2020 2020 2027  ,.             '
-00003e50: 7061 7468 5f74 6f5f 696d 6167 6573 272c  path_to_images',
-00003e60: 0a20 2020 2020 2020 2020 2020 2020 2773  .             's
-00003e70: 6578 5f63 6f6e 6669 6727 2c0a 2020 2020  ex_config',.    
-00003e80: 2020 2020 2020 2020 2027 7365 785f 7061           'sex_pa
-00003e90: 7261 6d27 2c0a 2020 2020 2020 2020 2020  ram',.          
-00003ea0: 2020 2027 7377 6172 705f 636f 6e66 6967     'swarp_config
-00003eb0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00003ec0: 2764 6f70 686f 745f 636f 6e66 6967 272c  'dophot_config',
-00003ed0: 0a20 2020 2020 2020 2020 2020 2020 2758  .             'X
-00003ee0: 595f 636f 7272 6563 7469 6f6e 5f6d 6170  Y_correction_map
-00003ef0: 735f 7061 7468 272c 0a20 2020 2020 2020  s_path',.       
-00003f00: 2020 2020 2020 2765 7874 696e 6374 696f        'extinctio
-00003f10: 6e5f 6d61 7073 5f70 6174 6827 2c0a 2020  n_maps_path',.  
-00003f20: 2020 2020 2020 2020 2020 2027 7061 7468             'path
-00003f30: 5f74 6f5f 7265 6665 7265 6e63 6527 2c0a  _to_reference',.
-00003f40: 2020 2020 2020 2020 2020 2020 2027 7061               'pa
-00003f50: 7468 5f74 6f5f 6d6f 6465 6c73 272c 0a20  th_to_models',. 
-00003f60: 2020 2020 2020 2020 2020 2020 276f 6666              'off
-00003f70: 7365 745f 746f 5f73 706c 7573 5f72 6566  set_to_splus_ref
-00003f80: 6361 6c69 6227 2c0a 2020 2020 2020 2020  calib',.        
-00003f90: 2020 2020 2027 7374 656c 6c61 725f 6c6f       'stellar_lo
-00003fa0: 6375 735f 7265 6665 7265 6e63 6527 2c0a  cus_reference',.
-00003fb0: 2020 2020 2020 2020 2020 2020 2027 7061               'pa
-00003fc0: 7468 5f74 6f5f 6761 6961 275d 0a0a 2020  th_to_gaia']..  
-00003fd0: 2020 666f 7220 6b65 7920 696e 2063 6f6e    for key in con
-00003fe0: 662e 6b65 7973 2829 3a0a 0a20 2020 2020  f.keys():..     
-00003ff0: 2020 2069 6620 6b65 7920 696e 2070 6174     if key in pat
-00004000: 6873 3a0a 0a20 2020 2020 2020 2020 2020  hs:..           
-00004010: 2023 2043 6f6e 7665 7274 2074 6f20 7379   # Convert to sy
-00004020: 7374 656d 2070 6174 6820 666f 726d 6174  stem path format
-00004030: 0a20 2020 2020 2020 2020 2020 2070 6174  .            pat
-00004040: 685f 6c69 7374 203d 2063 6f6e 665b 6b65  h_list = conf[ke
-00004050: 795d 2e73 706c 6974 2827 2f27 290a 0a20  y].split('/').. 
-00004060: 2020 2020 2020 2020 2020 2069 6620 7061             if pa
-00004070: 7468 5f6c 6973 745b 305d 203d 3d20 272e  th_list[0] == '.
-00004080: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
-00004090: 2020 2070 6174 685f 7379 7320 3d20 6f73     path_sys = os
-000040a0: 2e70 6174 682e 6a6f 696e 2870 6970 656c  .path.join(pipel
-000040b0: 696e 655f 7061 7468 2c20 2a70 6174 685f  ine_path, *path_
-000040c0: 6c69 7374 5b31 3a5d 290a 0a20 2020 2020  list[1:])..     
-000040d0: 2020 2020 2020 2065 6c69 6620 7061 7468         elif path
-000040e0: 5f6c 6973 745b 305d 203d 3d20 272e 2e27  _list[0] == '..'
-000040f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00004100: 2020 7061 7468 5f73 7973 203d 206f 732e    path_sys = os.
-00004110: 7061 7468 2e6a 6f69 6e28 7370 6c75 7363  path.join(splusc
-00004120: 616c 6962 5f70 6174 682c 202a 7061 7468  alib_path, *path
-00004130: 5f6c 6973 745b 313a 5d29 0a0a 2020 2020  _list[1:])..    
-00004140: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00004150: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00004160: 7468 5f73 7973 203d 206f 732e 7061 7468  th_sys = os.path
-00004170: 2e6a 6f69 6e28 2a70 6174 685f 6c69 7374  .join(*path_list
-00004180: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-00004190: 2052 6570 6c61 6365 2064 6566 6175 6c74   Replace default
-000041a0: 2070 6970 656c 696e 6520 7061 7468 2074   pipeline path t
-000041b0: 6f20 7573 6572 2070 6970 656c 696e 6520  o user pipeline 
-000041c0: 7061 7468 0a20 2020 2020 2020 2020 2020  path.           
-000041d0: 2069 6620 227b 7069 7065 6c69 6e65 5f70   if "{pipeline_p
-000041e0: 6174 687d 2220 696e 2070 6174 685f 7379  ath}" in path_sy
-000041f0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00004200: 2020 2070 6174 685f 7379 7320 3d20 7061     path_sys = pa
-00004210: 7468 5f73 7973 2e66 6f72 6d61 7428 7069  th_sys.format(pi
-00004220: 7065 6c69 6e65 5f70 6174 683d 7069 7065  peline_path=pipe
-00004230: 6c69 6e65 5f70 6174 6829 0a0a 2020 2020  line_path)..    
-00004240: 2020 2020 2020 2020 2320 5265 706c 6163          # Replac
-00004250: 6520 6465 6661 756c 7420 7370 6c75 7363  e default splusc
-00004260: 616c 6962 2070 6174 6820 746f 2075 7365  alib path to use
-00004270: 7220 7370 6c75 7363 616c 6962 2070 6174  r spluscalib pat
-00004280: 680a 2020 2020 2020 2020 2020 2020 6966  h.            if
-00004290: 2022 7b73 706c 7573 6361 6c69 625f 7061   "{spluscalib_pa
-000042a0: 7468 7d22 2069 6e20 7061 7468 5f73 7973  th}" in path_sys
-000042b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000042c0: 2020 7061 7468 5f73 7973 203d 2070 6174    path_sys = pat
-000042d0: 685f 7379 732e 666f 726d 6174 2873 706c  h_sys.format(spl
-000042e0: 7573 6361 6c69 625f 7061 7468 3d73 706c  uscalib_path=spl
-000042f0: 7573 6361 6c69 625f 7061 7468 290a 0a20  uscalib_path).. 
-00004300: 2020 2020 2020 2020 2020 2023 2041 6464             # Add
-00004310: 2069 6e69 7469 616c 202f 0a20 2020 2020   initial /.     
-00004320: 2020 2020 2020 2023 6966 2070 6174 685f         #if path_
-00004330: 7379 735b 305d 2021 3d20 272f 273a 0a20  sys[0] != '/':. 
-00004340: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-00004350: 7061 7468 5f73 7973 203d 2027 2f27 202b  path_sys = '/' +
-00004360: 2070 6174 685f 7379 730a 0a20 2020 2020   path_sys..     
-00004370: 2020 2020 2020 2023 2052 656d 6f76 6520         # Remove 
-00004380: 646f 7562 6c65 202f 0a20 2020 2020 2020  double /.       
-00004390: 2020 2020 2070 6174 685f 7379 7320 3d20       path_sys = 
-000043a0: 7061 7468 5f73 7973 2e72 6570 6c61 6365  path_sys.replace
-000043b0: 2822 2f2f 222c 2022 2f22 290a 0a20 2020  ("//", "/")..   
-000043c0: 2020 2020 2020 2020 2023 2055 7064 6174           # Updat
-000043d0: 6520 7061 7468 2074 6f20 7379 7374 656d  e path to system
-000043e0: 2070 6174 680a 2020 2020 2020 2020 2020   path.          
-000043f0: 2020 636f 6e66 5b6b 6579 5d20 3d20 7061    conf[key] = pa
-00004400: 7468 5f73 7973 0a0a 2020 2020 7265 7475  th_sys..    retu
-00004410: 726e 2063 6f6e 660a 0a0a 2323 2323 2323  rn conf...######
-00004420: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004430: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004440: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004450: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004460: 2323 2323 2323 2323 2323 0a23 204c 6f67  ##########.# Log
-00004470: 0a0a 6465 6620 7072 696e 746c 6f67 286d  ..def printlog(m
-00004480: 6573 7361 6765 2c20 6c6f 675f 6669 6c65  essage, log_file
-00004490: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-000044a0: 2022 2222 0a20 2020 2050 7269 6e74 7320   """.    Prints 
-000044b0: 6d65 7373 6167 6520 746f 2063 6f6e 736f  message to conso
-000044c0: 6c65 2061 6e64 2073 6176 6520 6974 2074  le and save it t
-000044d0: 6f20 7468 6520 6c6f 6720 6669 6c65 0a0a  o the log file..
-000044e0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-000044f0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-00004500: 2020 6d65 7373 6167 6520 3a20 7374 720a    message : str.
-00004510: 2020 2020 2020 2020 6d65 7373 6167 6520          message 
-00004520: 746f 2070 7269 6e74 2061 6e64 2073 6176  to print and sav
-00004530: 6520 746f 206c 6f67 2066 696c 650a 0a20  e to log file.. 
-00004540: 2020 206c 6f67 5f66 696c 6520 3a20 7374     log_file : st
-00004550: 720a 2020 2020 2020 2020 7468 6520 6c6f  r.        the lo
-00004560: 6361 7469 6f6e 206f 6620 7468 6520 6c6f  cation of the lo
-00004570: 6720 6669 6c65 0a20 2020 2022 2222 0a20  g file.    """. 
-00004580: 2020 200a 2020 2020 7465 726d 636f 6c6f     .    termcolo
-00004590: 722e 6370 7269 6e74 286d 6573 7361 6765  r.cprint(message
-000045a0: 2c20 2a2a 6b77 6172 6773 290a 0a20 2020  , **kwargs)..   
-000045b0: 2023 2047 6574 2074 696d 6520 7374 616d   # Get time stam
-000045c0: 700a 2020 2020 7374 616d 7020 3d20 6765  p.    stamp = ge
-000045d0: 745f 7469 6d65 5f73 7461 6d70 2829 0a0a  t_time_stamp()..
-000045e0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-000045f0: 2077 6974 6820 6f70 656e 286c 6f67 5f66   with open(log_f
-00004600: 696c 652c 2027 6127 2920 6173 206c 6f67  ile, 'a') as log
-00004610: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-00004620: 672e 7772 6974 6528 7374 616d 7020 2b20  g.write(stamp + 
-00004630: 6d65 7373 6167 6529 0a20 2020 2020 2020  message).       
-00004640: 2020 2020 206c 6f67 2e77 7269 7465 2827       log.write('
-00004650: 5c6e 2729 0a0a 2020 2020 6578 6365 7074  \n')..    except
-00004660: 2046 696c 654e 6f74 466f 756e 6445 7272   FileNotFoundErr
-00004670: 6f72 3a0a 2020 2020 2020 2020 7769 7468  or:.        with
-00004680: 206f 7065 6e28 6c6f 675f 6669 6c65 2c20   open(log_file, 
-00004690: 2777 2729 2061 7320 6c6f 673a 0a20 2020  'w') as log:.   
-000046a0: 2020 2020 2020 2020 206c 6f67 2e77 7269           log.wri
-000046b0: 7465 2873 7461 6d70 202b 206d 6573 7361  te(stamp + messa
-000046c0: 6765 290a 2020 2020 2020 2020 2020 2020  ge).            
-000046d0: 6c6f 672e 7772 6974 6528 275c 6e27 290a  log.write('\n').
-000046e0: 0a0a 6465 6620 6765 6e5f 6c6f 6766 696c  ..def gen_logfil
-000046f0: 655f 6e61 6d65 286c 6f67 5f66 696c 652c  e_name(log_file,
-00004700: 2066 6972 7374 5f72 756e 203d 2054 7275   first_run = Tru
-00004710: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
-00004720: 4765 6e65 7261 7465 7320 7468 6520 6e61  Generates the na
-00004730: 6d65 206f 6620 7468 6520 6c6f 6720 6669  me of the log fi
-00004740: 6c65 2e20 4966 2064 6573 6972 6564 2066  le. If desired f
-00004750: 696c 6520 616c 7265 6164 7920 6578 6973  ile already exis
-00004760: 7473 2c0a 2020 2020 6164 6473 205f 2a6e  ts,.    adds _*n
-00004770: 756d 6265 722a 2069 6e20 7468 6520 656e  umber* in the en
-00004780: 6420 6f66 2074 6865 2066 696c 6520 6e61  d of the file na
-00004790: 6d65 2e0a 2020 2020 5573 6564 2074 6f20  me..    Used to 
-000047a0: 6e6f 7420 6f76 6572 7772 6974 6520 6578  not overwrite ex
-000047b0: 6973 7469 6e67 206c 6f67 2066 696c 6573  isting log files
-000047c0: 2e0a 0a20 2020 2050 6172 616d 6574 6572  ...    Parameter
-000047d0: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-000047e0: 0a20 2020 206c 6f67 5f66 696c 6520 3a20  .    log_file : 
-000047f0: 7374 720a 2020 2020 2020 2020 4465 7369  str.        Desi
-00004800: 7265 6420 6c6f 6720 6669 6c65 206c 6f63  red log file loc
-00004810: 6174 696f 6e2e 204d 7573 7420 656e 6420  ation. Must end 
-00004820: 696e 202e 6c6f 670a 0a20 2020 2066 6972  in .log..    fir
-00004830: 7374 5f72 756e 203a 2062 6f6f 6c0a 2020  st_run : bool.  
-00004840: 2020 2020 2020 5573 6564 2069 6e74 6572        Used inter
-00004850: 6e61 6c6c 7920 746f 2063 6f6e 7472 6f6c  nally to control
-00004860: 2072 6563 7572 7369 7669 7479 0a0a 2020   recursivity..  
-00004870: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
-00004880: 2d2d 2d2d 2d0a 2020 2020 7374 720a 2020  -----.    str.  
-00004890: 2020 2020 2020 4c6f 6720 6669 6c65 206c        Log file l
-000048a0: 6f63 6174 696f 6e2e 0a20 2020 2022 2222  ocation..    """
-000048b0: 0a0a 2020 2020 6966 206c 6f67 5f66 696c  ..    if log_fil
-000048c0: 655b 2d34 3a5d 2021 3d20 272e 6c6f 6727  e[-4:] != '.log'
-000048d0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-000048e0: 4e61 6d65 4572 726f 7228 226c 6f67 2066  NameError("log f
-000048f0: 696c 6520 6d75 7374 2065 6e64 2069 6e20  ile must end in 
-00004900: 2e6c 6f67 2229 0a0a 2020 2020 6966 206e  .log")..    if n
-00004910: 6f74 206f 732e 7061 7468 2e65 7869 7374  ot os.path.exist
-00004920: 7328 6c6f 675f 6669 6c65 293a 0a20 2020  s(log_file):.   
-00004930: 2020 2020 2072 6574 7572 6e20 6c6f 675f       return log_
-00004940: 6669 6c65 0a0a 2020 2020 656c 7365 3a0a  file..    else:.
-00004950: 2020 2020 2020 2020 6966 2066 6972 7374          if first
-00004960: 5f72 756e 3a0a 2020 2020 2020 2020 2020  _run:.          
-00004970: 2020 6e65 775f 6669 6c65 203d 206c 6f67    new_file = log
-00004980: 5f66 696c 652e 7265 706c 6163 6528 222e  _file.replace(".
-00004990: 6c6f 6722 2c20 225f 312e 6c6f 6722 290a  log", "_1.log").
-000049a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000049b0: 726e 2067 656e 5f6c 6f67 6669 6c65 5f6e  rn gen_logfile_n
-000049c0: 616d 6528 6e65 775f 6669 6c65 2c20 6669  ame(new_file, fi
-000049d0: 7273 745f 7275 6e3d 4661 6c73 6529 0a0a  rst_run=False)..
-000049e0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000049f0: 2020 2020 2020 2020 2020 6c6f 675f 6e75            log_nu
-00004a00: 6d62 6572 203d 2069 6e74 286c 6f67 5f66  mber = int(log_f
-00004a10: 696c 652e 7370 6c69 7428 225f 2229 5b2d  ile.split("_")[-
-00004a20: 315d 5b3a 2d34 5d29 0a20 2020 2020 2020  1][:-4]).       
-00004a30: 2020 2020 206e 6577 5f66 696c 6520 3d20       new_file = 
-00004a40: 6c6f 675f 6669 6c65 2e72 6570 6c61 6365  log_file.replace
-00004a50: 2866 227b 6c6f 675f 6e75 6d62 6572 7d2e  (f"{log_number}.
-00004a60: 6c6f 6722 2c0a 2020 2020 2020 2020 2020  log",.          
-00004a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004a80: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00004a90: 7b6c 6f67 5f6e 756d 6265 722b 317d 2e6c  {log_number+1}.l
-00004aa0: 6f67 2229 0a0a 2020 2020 2020 2020 2020  og")..          
-00004ab0: 2020 7265 7475 726e 2067 656e 5f6c 6f67    return gen_log
-00004ac0: 6669 6c65 5f6e 616d 6528 6e65 775f 6669  file_name(new_fi
-00004ad0: 6c65 2c20 6669 7273 745f 7275 6e20 3d20  le, first_run = 
-00004ae0: 4661 6c73 6529 0a0a 0a64 6566 2067 6574  False)...def get
-00004af0: 5f74 696d 655f 7374 616d 7028 293a 0a20  _time_stamp():. 
-00004b00: 2020 2022 2222 0a20 2020 2047 656e 6572     """.    Gener
-00004b10: 6174 6573 2061 2074 696d 6520 7374 616d  ates a time stam
-00004b20: 700a 0a20 2020 2052 6574 7572 6e73 0a20  p..    Returns. 
-00004b30: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-00004b40: 2020 7374 720a 2020 2020 2020 2020 6375    str.        cu
-00004b50: 7272 656e 7420 7469 6d65 2073 7461 6d70  rrent time stamp
-00004b60: 0a20 2020 2022 2222 0a0a 2020 2020 6374  .    """..    ct
-00004b70: 203d 2064 6174 6574 696d 652e 6461 7465   = datetime.date
-00004b80: 7469 6d65 2e6e 6f77 2829 0a0a 2020 2020  time.now()..    
-00004b90: 7374 616d 7020 3d20 225b 7b79 6561 727d  stamp = "[{year}
-00004ba0: 2f7b 6d6f 6e3a 3032 647d 2f7b 6461 793a  /{mon:02d}/{day:
-00004bb0: 3032 647d 207b 6868 3a30 3264 7d3a 7b6d  02d} {hh:02d}:{m
-00004bc0: 6d3a 3032 647d 3a7b 7373 3a30 3264 7d5d  m:02d}:{ss:02d}]
-00004bd0: 2022 2e66 6f72 6d61 7428 0a20 2020 2020   ".format(.     
-00004be0: 2020 2079 6561 723d 6374 2e79 6561 722c     year=ct.year,
-00004bf0: 0a20 2020 2020 2020 206d 6f6e 3d63 742e  .        mon=ct.
-00004c00: 6d6f 6e74 682c 0a20 2020 2020 2020 2064  month,.        d
-00004c10: 6179 3d63 742e 6461 792c 0a20 2020 2020  ay=ct.day,.     
-00004c20: 2020 2068 683d 6374 2e68 6f75 722c 0a20     hh=ct.hour,. 
-00004c30: 2020 2020 2020 206d 6d3d 6374 2e6d 696e         mm=ct.min
-00004c40: 7574 652c 0a20 2020 2020 2020 2073 733d  ute,.        ss=
-00004c50: 6374 2e73 6563 6f6e 6429 0a0a 2020 2020  ct.second)..    
-00004c60: 7265 7475 726e 2073 7461 6d70 0a0a 0a23  return stamp...#
+00003e50: 7365 785f 7061 7261 6d27 2c0a 2020 2020  sex_param',.    
+00003e60: 2020 2020 2020 2020 2027 7377 6172 705f           'swarp_
+00003e70: 636f 6e66 6967 272c 0a20 2020 2020 2020  config',.       
+00003e80: 2020 2020 2020 2764 6f70 686f 745f 636f        'dophot_co
+00003e90: 6e66 6967 272c 0a20 2020 2020 2020 2020  nfig',.         
+00003ea0: 2020 2020 2758 595f 636f 7272 6563 7469      'XY_correcti
+00003eb0: 6f6e 5f6d 6170 735f 7061 7468 272c 0a20  on_maps_path',. 
+00003ec0: 2020 2020 2020 2020 2020 2020 2765 7874              'ext
+00003ed0: 696e 6374 696f 6e5f 6d61 7073 5f70 6174  inction_maps_pat
+00003ee0: 6827 2c0a 2020 2020 2020 2020 2020 2020  h',.            
+00003ef0: 2027 7061 7468 5f74 6f5f 7265 6665 7265   'path_to_refere
+00003f00: 6e63 6527 2c0a 2020 2020 2020 2020 2020  nce',.          
+00003f10: 2020 2027 7061 7468 5f74 6f5f 6d6f 6465     'path_to_mode
+00003f20: 6c73 272c 0a20 2020 2020 2020 2020 2020  ls',.           
+00003f30: 2020 276f 6666 7365 745f 746f 5f73 706c    'offset_to_spl
+00003f40: 7573 5f72 6566 6361 6c69 6227 2c0a 2020  us_refcalib',.  
+00003f50: 2020 2020 2020 2020 2020 2027 7374 656c             'stel
+00003f60: 6c61 725f 6c6f 6375 735f 7265 6665 7265  lar_locus_refere
+00003f70: 6e63 6527 2c0a 2020 2020 2020 2020 2020  nce',.          
+00003f80: 2020 2027 7061 7468 5f74 6f5f 6761 6961     'path_to_gaia
+00003f90: 275d 0a0a 2020 2020 666f 7220 6b65 7920  ']..    for key 
+00003fa0: 696e 2063 6f6e 662e 6b65 7973 2829 3a0a  in conf.keys():.
+00003fb0: 0a20 2020 2020 2020 2069 6620 6b65 7920  .        if key 
+00003fc0: 696e 2070 6174 6873 3a0a 0a20 2020 2020  in paths:..     
+00003fd0: 2020 2020 2020 2023 2043 6f6e 7665 7274         # Convert
+00003fe0: 2074 6f20 7379 7374 656d 2070 6174 6820   to system path 
+00003ff0: 666f 726d 6174 0a20 2020 2020 2020 2020  format.         
+00004000: 2020 2070 6174 685f 6c69 7374 203d 2063     path_list = c
+00004010: 6f6e 665b 6b65 795d 2e73 706c 6974 2827  onf[key].split('
+00004020: 2f27 290a 0a20 2020 2020 2020 2020 2020  /')..           
+00004030: 2069 6620 7061 7468 5f6c 6973 745b 305d   if path_list[0]
+00004040: 203d 3d20 272e 273a 0a20 2020 2020 2020   == '.':.       
+00004050: 2020 2020 2020 2020 2070 6174 685f 7379           path_sy
+00004060: 7320 3d20 6f73 2e70 6174 682e 6a6f 696e  s = os.path.join
+00004070: 2870 6970 656c 696e 655f 7061 7468 2c20  (pipeline_path, 
+00004080: 2a70 6174 685f 6c69 7374 5b31 3a5d 290a  *path_list[1:]).
+00004090: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+000040a0: 6620 7061 7468 5f6c 6973 745b 305d 203d  f path_list[0] =
+000040b0: 3d20 272e 2e27 3a0a 2020 2020 2020 2020  = '..':.        
+000040c0: 2020 2020 2020 2020 7061 7468 5f73 7973          path_sys
+000040d0: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
+000040e0: 7370 6c75 7363 616c 6962 5f70 6174 682c  spluscalib_path,
+000040f0: 202a 7061 7468 5f6c 6973 745b 313a 5d29   *path_list[1:])
+00004100: 0a0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+00004110: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00004120: 2020 2020 7061 7468 5f73 7973 203d 206f      path_sys = o
+00004130: 732e 7061 7468 2e6a 6f69 6e28 2a70 6174  s.path.join(*pat
+00004140: 685f 6c69 7374 290a 0a20 2020 2020 2020  h_list)..       
+00004150: 2020 2020 2023 2052 6570 6c61 6365 2064       # Replace d
+00004160: 6566 6175 6c74 2070 6970 656c 696e 6520  efault pipeline 
+00004170: 7061 7468 2074 6f20 7573 6572 2070 6970  path to user pip
+00004180: 656c 696e 6520 7061 7468 0a20 2020 2020  eline path.     
+00004190: 2020 2020 2020 2069 6620 227b 7069 7065         if "{pipe
+000041a0: 6c69 6e65 5f70 6174 687d 2220 696e 2070  line_path}" in p
+000041b0: 6174 685f 7379 733a 0a20 2020 2020 2020  ath_sys:.       
+000041c0: 2020 2020 2020 2020 2070 6174 685f 7379           path_sy
+000041d0: 7320 3d20 7061 7468 5f73 7973 2e66 6f72  s = path_sys.for
+000041e0: 6d61 7428 7069 7065 6c69 6e65 5f70 6174  mat(pipeline_pat
+000041f0: 683d 7069 7065 6c69 6e65 5f70 6174 6829  h=pipeline_path)
+00004200: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00004210: 5265 706c 6163 6520 6465 6661 756c 7420  Replace default 
+00004220: 7370 6c75 7363 616c 6962 2070 6174 6820  spluscalib path 
+00004230: 746f 2075 7365 7220 7370 6c75 7363 616c  to user spluscal
+00004240: 6962 2070 6174 680a 2020 2020 2020 2020  ib path.        
+00004250: 2020 2020 6966 2022 7b73 706c 7573 6361      if "{splusca
+00004260: 6c69 625f 7061 7468 7d22 2069 6e20 7061  lib_path}" in pa
+00004270: 7468 5f73 7973 3a0a 2020 2020 2020 2020  th_sys:.        
+00004280: 2020 2020 2020 2020 7061 7468 5f73 7973          path_sys
+00004290: 203d 2070 6174 685f 7379 732e 666f 726d   = path_sys.form
+000042a0: 6174 2873 706c 7573 6361 6c69 625f 7061  at(spluscalib_pa
+000042b0: 7468 3d73 706c 7573 6361 6c69 625f 7061  th=spluscalib_pa
+000042c0: 7468 290a 0a20 2020 2020 2020 2020 2020  th)..           
+000042d0: 2023 2041 6464 2069 6e69 7469 616c 202f   # Add initial /
+000042e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000042f0: 7061 7468 5f73 7973 5b30 5d20 213d 2027  path_sys[0] != '
+00004300: 2f27 3a0a 2020 2020 2020 2020 2020 2020  /':.            
+00004310: 2020 2020 7061 7468 5f73 7973 203d 2027      path_sys = '
+00004320: 2f27 202b 2070 6174 685f 7379 730a 0a20  /' + path_sys.. 
+00004330: 2020 2020 2020 2020 2020 2023 2052 656d             # Rem
+00004340: 6f76 6520 646f 7562 6c65 202f 0a20 2020  ove double /.   
+00004350: 2020 2020 2020 2020 2070 6174 685f 7379           path_sy
+00004360: 7320 3d20 7061 7468 5f73 7973 2e72 6570  s = path_sys.rep
+00004370: 6c61 6365 2822 2f2f 222c 2022 2f22 290a  lace("//", "/").
+00004380: 0a20 2020 2020 2020 2020 2020 2023 2055  .            # U
+00004390: 7064 6174 6520 7061 7468 2074 6f20 7379  pdate path to sy
+000043a0: 7374 656d 2070 6174 680a 2020 2020 2020  stem path.      
+000043b0: 2020 2020 2020 636f 6e66 5b6b 6579 5d20        conf[key] 
+000043c0: 3d20 7061 7468 5f73 7973 0a0a 2020 2020  = path_sys..    
+000043d0: 7265 7475 726e 2063 6f6e 660a 0a0a 2323  return conf...##
+000043e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000043f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004400: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004410: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004420: 2323 2323 2323 2323 2323 2323 2323 0a23  ##############.#
+00004430: 204c 6f67 0a0a 6465 6620 7072 696e 746c   Log..def printl
+00004440: 6f67 286d 6573 7361 6765 2c20 6c6f 675f  og(message, log_
+00004450: 6669 6c65 2c20 2a2a 6b77 6172 6773 293a  file, **kwargs):
+00004460: 0a20 2020 2022 2222 0a20 2020 2050 7269  .    """.    Pri
+00004470: 6e74 7320 6d65 7373 6167 6520 746f 2063  nts message to c
+00004480: 6f6e 736f 6c65 2061 6e64 2073 6176 6520  onsole and save 
+00004490: 6974 2074 6f20 7468 6520 6c6f 6720 6669  it to the log fi
+000044a0: 6c65 0a0a 2020 2020 5061 7261 6d65 7465  le..    Paramete
+000044b0: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+000044c0: 2d0a 2020 2020 6d65 7373 6167 6520 3a20  -.    message : 
+000044d0: 7374 720a 2020 2020 2020 2020 6d65 7373  str.        mess
+000044e0: 6167 6520 746f 2070 7269 6e74 2061 6e64  age to print and
+000044f0: 2073 6176 6520 746f 206c 6f67 2066 696c   save to log fil
+00004500: 650a 0a20 2020 206c 6f67 5f66 696c 6520  e..    log_file 
+00004510: 3a20 7374 720a 2020 2020 2020 2020 7468  : str.        th
+00004520: 6520 6c6f 6361 7469 6f6e 206f 6620 7468  e location of th
+00004530: 6520 6c6f 6720 6669 6c65 0a20 2020 2022  e log file.    "
+00004540: 2222 0a20 2020 200a 2020 2020 7465 726d  "".    .    term
+00004550: 636f 6c6f 722e 6370 7269 6e74 286d 6573  color.cprint(mes
+00004560: 7361 6765 2c20 2a2a 6b77 6172 6773 290a  sage, **kwargs).
+00004570: 0a20 2020 2023 2047 6574 2074 696d 6520  .    # Get time 
+00004580: 7374 616d 700a 2020 2020 7374 616d 7020  stamp.    stamp 
+00004590: 3d20 6765 745f 7469 6d65 5f73 7461 6d70  = get_time_stamp
+000045a0: 2829 0a0a 2020 2020 7472 793a 0a20 2020  ()..    try:.   
+000045b0: 2020 2020 2077 6974 6820 6f70 656e 286c       with open(l
+000045c0: 6f67 5f66 696c 652c 2027 6127 2920 6173  og_file, 'a') as
+000045d0: 206c 6f67 3a0a 2020 2020 2020 2020 2020   log:.          
+000045e0: 2020 6c6f 672e 7772 6974 6528 7374 616d    log.write(stam
+000045f0: 7020 2b20 6d65 7373 6167 6529 0a20 2020  p + message).   
+00004600: 2020 2020 2020 2020 206c 6f67 2e77 7269           log.wri
+00004610: 7465 2827 5c6e 2729 0a0a 2020 2020 6578  te('\n')..    ex
+00004620: 6365 7074 2046 696c 654e 6f74 466f 756e  cept FileNotFoun
+00004630: 6445 7272 6f72 3a0a 2020 2020 2020 2020  dError:.        
+00004640: 7769 7468 206f 7065 6e28 6c6f 675f 6669  with open(log_fi
+00004650: 6c65 2c20 2777 2729 2061 7320 6c6f 673a  le, 'w') as log:
+00004660: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00004670: 2e77 7269 7465 2873 7461 6d70 202b 206d  .write(stamp + m
+00004680: 6573 7361 6765 290a 2020 2020 2020 2020  essage).        
+00004690: 2020 2020 6c6f 672e 7772 6974 6528 275c      log.write('\
+000046a0: 6e27 290a 0a0a 6465 6620 6765 6e5f 6c6f  n')...def gen_lo
+000046b0: 6766 696c 655f 6e61 6d65 286c 6f67 5f66  gfile_name(log_f
+000046c0: 696c 652c 2066 6972 7374 5f72 756e 203d  ile, first_run =
+000046d0: 2054 7275 6529 3a0a 2020 2020 2222 220a   True):.    """.
+000046e0: 2020 2020 4765 6e65 7261 7465 7320 7468      Generates th
+000046f0: 6520 6e61 6d65 206f 6620 7468 6520 6c6f  e name of the lo
+00004700: 6720 6669 6c65 2e20 4966 2064 6573 6972  g file. If desir
+00004710: 6564 2066 696c 6520 616c 7265 6164 7920  ed file already 
+00004720: 6578 6973 7473 2c0a 2020 2020 6164 6473  exists,.    adds
+00004730: 205f 2a6e 756d 6265 722a 2069 6e20 7468   _*number* in th
+00004740: 6520 656e 6420 6f66 2074 6865 2066 696c  e end of the fil
+00004750: 6520 6e61 6d65 2e0a 2020 2020 5573 6564  e name..    Used
+00004760: 2074 6f20 6e6f 7420 6f76 6572 7772 6974   to not overwrit
+00004770: 6520 6578 6973 7469 6e67 206c 6f67 2066  e existing log f
+00004780: 696c 6573 2e0a 0a20 2020 2050 6172 616d  iles...    Param
+00004790: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
+000047a0: 2d2d 2d2d 0a20 2020 206c 6f67 5f66 696c  ----.    log_fil
+000047b0: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
+000047c0: 4465 7369 7265 6420 6c6f 6720 6669 6c65  Desired log file
+000047d0: 206c 6f63 6174 696f 6e2e 204d 7573 7420   location. Must 
+000047e0: 656e 6420 696e 202e 6c6f 670a 0a20 2020  end in .log..   
+000047f0: 2066 6972 7374 5f72 756e 203a 2062 6f6f   first_run : boo
+00004800: 6c0a 2020 2020 2020 2020 5573 6564 2069  l.        Used i
+00004810: 6e74 6572 6e61 6c6c 7920 746f 2063 6f6e  nternally to con
+00004820: 7472 6f6c 2072 6563 7572 7369 7669 7479  trol recursivity
+00004830: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+00004840: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 7374    -------.    st
+00004850: 720a 2020 2020 2020 2020 4c6f 6720 6669  r.        Log fi
+00004860: 6c65 206c 6f63 6174 696f 6e2e 0a20 2020  le location..   
+00004870: 2022 2222 0a0a 2020 2020 6966 206c 6f67   """..    if log
+00004880: 5f66 696c 655b 2d34 3a5d 2021 3d20 272e  _file[-4:] != '.
+00004890: 6c6f 6727 3a0a 2020 2020 2020 2020 7261  log':.        ra
+000048a0: 6973 6520 4e61 6d65 4572 726f 7228 226c  ise NameError("l
+000048b0: 6f67 2066 696c 6520 6d75 7374 2065 6e64  og file must end
+000048c0: 2069 6e20 2e6c 6f67 2229 0a0a 2020 2020   in .log")..    
+000048d0: 6966 206e 6f74 206f 732e 7061 7468 2e65  if not os.path.e
+000048e0: 7869 7374 7328 6c6f 675f 6669 6c65 293a  xists(log_file):
+000048f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00004900: 6c6f 675f 6669 6c65 0a0a 2020 2020 656c  log_file..    el
+00004910: 7365 3a0a 2020 2020 2020 2020 6966 2066  se:.        if f
+00004920: 6972 7374 5f72 756e 3a0a 2020 2020 2020  irst_run:.      
+00004930: 2020 2020 2020 6e65 775f 6669 6c65 203d        new_file =
+00004940: 206c 6f67 5f66 696c 652e 7265 706c 6163   log_file.replac
+00004950: 6528 222e 6c6f 6722 2c20 225f 312e 6c6f  e(".log", "_1.lo
+00004960: 6722 290a 2020 2020 2020 2020 2020 2020  g").            
+00004970: 7265 7475 726e 2067 656e 5f6c 6f67 6669  return gen_logfi
+00004980: 6c65 5f6e 616d 6528 6e65 775f 6669 6c65  le_name(new_file
+00004990: 2c20 6669 7273 745f 7275 6e3d 4661 6c73  , first_run=Fals
+000049a0: 6529 0a0a 2020 2020 2020 2020 656c 7365  e)..        else
+000049b0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+000049c0: 675f 6e75 6d62 6572 203d 2069 6e74 286c  g_number = int(l
+000049d0: 6f67 5f66 696c 652e 7370 6c69 7428 225f  og_file.split("_
+000049e0: 2229 5b2d 315d 5b3a 2d34 5d29 0a20 2020  ")[-1][:-4]).   
+000049f0: 2020 2020 2020 2020 206e 6577 5f66 696c           new_fil
+00004a00: 6520 3d20 6c6f 675f 6669 6c65 2e72 6570  e = log_file.rep
+00004a10: 6c61 6365 2866 227b 6c6f 675f 6e75 6d62  lace(f"{log_numb
+00004a20: 6572 7d2e 6c6f 6722 2c0a 2020 2020 2020  er}.log",.      
+00004a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004a50: 2020 6622 7b6c 6f67 5f6e 756d 6265 722b    f"{log_number+
+00004a60: 317d 2e6c 6f67 2229 0a0a 2020 2020 2020  1}.log")..      
+00004a70: 2020 2020 2020 7265 7475 726e 2067 656e        return gen
+00004a80: 5f6c 6f67 6669 6c65 5f6e 616d 6528 6e65  _logfile_name(ne
+00004a90: 775f 6669 6c65 2c20 6669 7273 745f 7275  w_file, first_ru
+00004aa0: 6e20 3d20 4661 6c73 6529 0a0a 0a64 6566  n = False)...def
+00004ab0: 2067 6574 5f74 696d 655f 7374 616d 7028   get_time_stamp(
+00004ac0: 293a 0a20 2020 2022 2222 0a20 2020 2047  ):.    """.    G
+00004ad0: 656e 6572 6174 6573 2061 2074 696d 6520  enerates a time 
+00004ae0: 7374 616d 700a 0a20 2020 2052 6574 7572  stamp..    Retur
+00004af0: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  ns.    ---------
+00004b00: 2d0a 2020 2020 7374 720a 2020 2020 2020  -.    str.      
+00004b10: 2020 6375 7272 656e 7420 7469 6d65 2073    current time s
+00004b20: 7461 6d70 0a20 2020 2022 2222 0a0a 2020  tamp.    """..  
+00004b30: 2020 6374 203d 2064 6174 6574 696d 652e    ct = datetime.
+00004b40: 6461 7465 7469 6d65 2e6e 6f77 2829 0a0a  datetime.now()..
+00004b50: 2020 2020 7374 616d 7020 3d20 225b 7b79      stamp = "[{y
+00004b60: 6561 727d 2f7b 6d6f 6e3a 3032 647d 2f7b  ear}/{mon:02d}/{
+00004b70: 6461 793a 3032 647d 207b 6868 3a30 3264  day:02d} {hh:02d
+00004b80: 7d3a 7b6d 6d3a 3032 647d 3a7b 7373 3a30  }:{mm:02d}:{ss:0
+00004b90: 3264 7d5d 2022 2e66 6f72 6d61 7428 0a20  2d}] ".format(. 
+00004ba0: 2020 2020 2020 2079 6561 723d 6374 2e79         year=ct.y
+00004bb0: 6561 722c 0a20 2020 2020 2020 206d 6f6e  ear,.        mon
+00004bc0: 3d63 742e 6d6f 6e74 682c 0a20 2020 2020  =ct.month,.     
+00004bd0: 2020 2064 6179 3d63 742e 6461 792c 0a20     day=ct.day,. 
+00004be0: 2020 2020 2020 2068 683d 6374 2e68 6f75         hh=ct.hou
+00004bf0: 722c 0a20 2020 2020 2020 206d 6d3d 6374  r,.        mm=ct
+00004c00: 2e6d 696e 7574 652c 0a20 2020 2020 2020  .minute,.       
+00004c10: 2073 733d 6374 2e73 6563 6f6e 6429 0a0a   ss=ct.second)..
+00004c20: 2020 2020 7265 7475 726e 2073 7461 6d70      return stamp
+00004c30: 0a0a 0a23 2323 2323 2323 2323 2323 2323  ...#############
+00004c40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004c50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004c60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00004c70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004c80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004c90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00004c80: 2323 230a 2320 5068 6f74 6f6d 6574 7279  ###.# Photometry
+00004c90: 0a0a 2323 2323 2323 2323 2323 2323 2323  ..##############
 00004ca0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004cb0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00004cc0: 2320 5068 6f74 6f6d 6574 7279 0a0a 2323  # Photometry..##
-00004cd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00004ce0: 2323 2323 2323 2323 2323 2323 230a 2320  #############.# 
-00004cf0: 5369 6e67 6c65 202f 2044 7561 6c20 6d6f  Single / Dual mo
-00004d00: 6465 2070 686f 746f 6d65 7472 790a 0a23  de photometry..#
-00004d10: 2047 656e 6572 6174 6520 436f 6e66 6967   Generate Config
-00004d20: 7572 6174 696f 6e20 6669 6c65 0a64 6566  uration file.def
-00004d30: 2067 6574 5f73 6578 5f63 6f6e 6669 6728   get_sex_config(
-00004d40: 7361 7665 5f66 696c 652c 2064 6566 6175  save_file, defau
-00004d50: 6c74 5f73 6578 636f 6e66 6967 2c20 6465  lt_sexconfig, de
-00004d60: 6661 756c 745f 7365 7870 6172 616d 2c0a  fault_sexparam,.
-00004d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004d80: 2020 2063 6174 616c 6f67 5f66 696c 652c     catalog_file,
-00004d90: 2069 6d61 6765 5f66 696c 652c 2069 6e73   image_file, ins
-00004da0: 745f 7a70 2c20 7061 7468 5f74 6f5f 7365  t_zp, path_to_se
-00004db0: 782c 0a20 2020 2020 2020 2020 2020 2020  x,.             
-00004dc0: 2020 2020 2020 7573 655f 7765 6967 6874        use_weight
-00004dd0: 3d46 616c 7365 2c20 6d6f 6465 3d4e 6f6e  =False, mode=Non
-00004de0: 652c 2063 6865 636b 5f61 7065 7269 6d61  e, check_aperima
-00004df0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
-00004e00: 2020 2020 2020 2020 2020 6368 6563 6b5f            check_
-00004e10: 7365 6769 6d61 3d4e 6f6e 652c 2064 6574  segima=None, det
-00004e20: 6563 7469 6f6e 5f66 696c 653d 4e6f 6e65  ection_file=None
-00004e30: 2c20 7368 6f72 7473 3d46 616c 7365 293a  , shorts=False):
-00004e40: 0a0a 2020 2020 2320 5265 6164 2067 656e  ..    # Read gen
-00004e50: 6572 616c 2063 6f6e 6669 6775 7261 7469  eral configurati
-00004e60: 6f6e 2066 696c 650a 2020 2020 7769 7468  on file.    with
-00004e70: 206f 7065 6e28 6465 6661 756c 745f 7365   open(default_se
-00004e80: 7863 6f6e 6669 672c 2027 7227 2920 6173  xconfig, 'r') as
-00004e90: 2066 3a0a 2020 2020 2020 2020 7365 785f   f:.        sex_
-00004ea0: 636f 6e66 6967 203d 2066 2e72 6561 646c  config = f.readl
-00004eb0: 696e 6573 2829 0a20 2020 2020 2020 2073  ines().        s
-00004ec0: 6578 5f63 6f6e 6669 6720 3d20 2222 2e6a  ex_config = "".j
-00004ed0: 6f69 6e28 7365 785f 636f 6e66 6967 290a  oin(sex_config).
-00004ee0: 0a20 2020 2023 2052 6561 6420 7061 7261  .    # Read para
-00004ef0: 6d65 7465 7273 2066 726f 6d20 696d 6167  meters from imag
-00004f00: 6520 6865 6164 6572 0a20 2020 2069 6620  e header.    if 
-00004f10: 7368 6f72 7473 3a0a 2020 2020 2020 2020  shorts:.        
-00004f20: 7361 7475 7220 3d20 3530 3030 300a 2020  satur = 50000.  
-00004f30: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00004f40: 7361 7475 7220 3d20 7370 6c75 735f 696d  satur = splus_im
-00004f50: 6167 655f 7361 7475 725f 6c65 7665 6c28  age_satur_level(
-00004f60: 696d 6167 655f 6669 6c65 290a 2020 2020  image_file).    
-00004f70: 0a20 2020 2073 6565 696e 6720 3d20 7370  .    seeing = sp
-00004f80: 6c75 735f 696d 6167 655f 7365 6569 6e67  lus_image_seeing
-00004f90: 2869 6d61 6765 5f66 696c 6529 0a20 2020  (image_file).   
-00004fa0: 2067 6169 6e20 3d20 7370 6c75 735f 696d   gain = splus_im
-00004fb0: 6167 655f 6761 696e 2869 6d61 6765 5f66  age_gain(image_f
-00004fc0: 696c 6529 0a0a 2020 2020 2320 5570 6461  ile)..    # Upda
-00004fd0: 7465 2073 6578 636f 6e66 6967 0a20 2020  te sexconfig.   
-00004fe0: 2073 6578 5f63 6f6e 6669 6720 3d20 7365   sex_config = se
-00004ff0: 785f 636f 6e66 6967 2e66 6f72 6d61 7428  x_config.format(
-00005000: 6361 7461 6c6f 675f 6669 6c65 3d63 6174  catalog_file=cat
-00005010: 616c 6f67 5f66 696c 652c 0a20 2020 2020  alog_file,.     
+00004cb0: 230a 2320 5369 6e67 6c65 202f 2044 7561  #.# Single / Dua
+00004cc0: 6c20 6d6f 6465 2070 686f 746f 6d65 7472  l mode photometr
+00004cd0: 790a 0a23 2047 656e 6572 6174 6520 436f  y..# Generate Co
+00004ce0: 6e66 6967 7572 6174 696f 6e20 6669 6c65  nfiguration file
+00004cf0: 0a64 6566 2067 6574 5f73 6578 5f63 6f6e  .def get_sex_con
+00004d00: 6669 6728 7361 7665 5f66 696c 652c 2064  fig(save_file, d
+00004d10: 6566 6175 6c74 5f73 6578 636f 6e66 6967  efault_sexconfig
+00004d20: 2c20 6465 6661 756c 745f 7365 7870 6172  , default_sexpar
+00004d30: 616d 2c0a 2020 2020 2020 2020 2020 2020  am,.            
+00004d40: 2020 2020 2020 2063 6174 616c 6f67 5f66         catalog_f
+00004d50: 696c 652c 2069 6d61 6765 5f66 696c 652c  ile, image_file,
+00004d60: 2069 6e73 745f 7a70 2c20 7061 7468 5f74   inst_zp, path_t
+00004d70: 6f5f 7365 782c 0a20 2020 2020 2020 2020  o_sex,.         
+00004d80: 2020 2020 2020 2020 2020 7573 655f 7765            use_we
+00004d90: 6967 6874 3d46 616c 7365 2c20 6d6f 6465  ight=False, mode
+00004da0: 3d4e 6f6e 652c 2063 6865 636b 5f61 7065  =None, check_ape
+00004db0: 7269 6d61 3d4e 6f6e 652c 0a20 2020 2020  rima=None,.     
+00004dc0: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+00004dd0: 6563 6b5f 7365 6769 6d61 3d4e 6f6e 652c  eck_segima=None,
+00004de0: 2064 6574 6563 7469 6f6e 5f66 696c 653d   detection_file=
+00004df0: 4e6f 6e65 2c20 7368 6f72 7473 3d46 616c  None, shorts=Fal
+00004e00: 7365 293a 0a0a 2020 2020 2320 5265 6164  se):..    # Read
+00004e10: 2067 656e 6572 616c 2063 6f6e 6669 6775   general configu
+00004e20: 7261 7469 6f6e 2066 696c 650a 2020 2020  ration file.    
+00004e30: 7769 7468 206f 7065 6e28 6465 6661 756c  with open(defaul
+00004e40: 745f 7365 7863 6f6e 6669 672c 2027 7227  t_sexconfig, 'r'
+00004e50: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+00004e60: 7365 785f 636f 6e66 6967 203d 2066 2e72  sex_config = f.r
+00004e70: 6561 646c 696e 6573 2829 0a20 2020 2020  eadlines().     
+00004e80: 2020 2073 6578 5f63 6f6e 6669 6720 3d20     sex_config = 
+00004e90: 2222 2e6a 6f69 6e28 7365 785f 636f 6e66  "".join(sex_conf
+00004ea0: 6967 290a 0a20 2020 2023 2052 6561 6420  ig)..    # Read 
+00004eb0: 7061 7261 6d65 7465 7273 2066 726f 6d20  parameters from 
+00004ec0: 696d 6167 6520 6865 6164 6572 0a20 2020  image header.   
+00004ed0: 2069 6620 7368 6f72 7473 3a0a 2020 2020   if shorts:.    
+00004ee0: 2020 2020 7361 7475 7220 3d20 3530 3030      satur = 5000
+00004ef0: 300a 2020 2020 656c 7365 3a0a 2020 2020  0.    else:.    
+00004f00: 2020 2020 7361 7475 7220 3d20 7370 6c75      satur = splu
+00004f10: 735f 696d 6167 655f 7361 7475 725f 6c65  s_image_satur_le
+00004f20: 7665 6c28 696d 6167 655f 6669 6c65 290a  vel(image_file).
+00004f30: 2020 2020 0a20 2020 2073 6565 696e 6720      .    seeing 
+00004f40: 3d20 7370 6c75 735f 696d 6167 655f 7365  = splus_image_se
+00004f50: 6569 6e67 2869 6d61 6765 5f66 696c 6529  eing(image_file)
+00004f60: 0a20 2020 2067 6169 6e20 3d20 7370 6c75  .    gain = splu
+00004f70: 735f 696d 6167 655f 6761 696e 2869 6d61  s_image_gain(ima
+00004f80: 6765 5f66 696c 6529 0a0a 2020 2020 2320  ge_file)..    # 
+00004f90: 5570 6461 7465 2073 6578 636f 6e66 6967  Update sexconfig
+00004fa0: 0a20 2020 2073 6578 5f63 6f6e 6669 6720  .    sex_config 
+00004fb0: 3d20 7365 785f 636f 6e66 6967 2e66 6f72  = sex_config.for
+00004fc0: 6d61 7428 6361 7461 6c6f 675f 6669 6c65  mat(catalog_file
+00004fd0: 3d63 6174 616c 6f67 5f66 696c 652c 0a20  =catalog_file,. 
+00004fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005000: 2020 7061 7261 6d5f 6669 6c65 3d64 6566    param_file=def
+00005010: 6175 6c74 5f73 6578 7061 7261 6d2c 0a20  ault_sexparam,. 
 00005020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005030: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00005040: 7261 6d5f 6669 6c65 3d64 6566 6175 6c74  ram_file=default
-00005050: 5f73 6578 7061 7261 6d2c 0a20 2020 2020  _sexparam,.     
+00005030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005040: 2020 7061 7468 5f74 6f5f 7365 783d 7061    path_to_sex=pa
+00005050: 7468 5f74 6f5f 7365 782c 0a20 2020 2020  th_to_sex,.     
 00005060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005070: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00005080: 7468 5f74 6f5f 7365 783d 7061 7468 5f74  th_to_sex=path_t
-00005090: 6f5f 7365 782c 0a20 2020 2020 2020 2020  o_sex,.         
+00005070: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00005080: 7374 5f7a 703d 696e 7374 5f7a 702c 0a20  st_zp=inst_zp,. 
+00005090: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000050a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000050b0: 2020 2020 2020 2020 2020 696e 7374 5f7a            inst_z
-000050c0: 703d 696e 7374 5f7a 702c 0a20 2020 2020  p=inst_zp,.     
+000050b0: 2020 7361 7475 723d 7361 7475 722c 0a20    satur=satur,. 
+000050c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000050d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000050e0: 2020 2020 2020 2020 2020 2020 2020 7361                sa
-000050f0: 7475 723d 7361 7475 722c 0a20 2020 2020  tur=satur,.     
+000050e0: 2020 7365 6569 6e67 3d73 6565 696e 672c    seeing=seeing,
+000050f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00005100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005110: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00005120: 6569 6e67 3d73 6565 696e 672c 0a20 2020  eing=seeing,.   
-00005130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005150: 6761 696e 3d67 6169 6e29 0a0a 2020 2020  gain=gain)..    
-00005160: 2320 496e 636c 7564 6520 7765 6967 6874  # Include weight
-00005170: 2069 6d61 6765 0a20 2020 2069 6620 7573   image.    if us
-00005180: 655f 7765 6967 6874 3a0a 2020 2020 2020  e_weight:.      
-00005190: 2020 7769 6d61 6765 5f66 696c 6520 3d20    wimage_file = 
-000051a0: 696d 6167 655f 6669 6c65 2e72 6570 6c61  image_file.repla
-000051b0: 6365 2822 2e66 6974 7322 2c20 2277 6569  ce(".fits", "wei
-000051c0: 6768 742e 6669 7473 2229 0a0a 2020 2020  ght.fits")..    
-000051d0: 2020 2020 6966 206d 6f64 6520 3d3d 2027      if mode == '
-000051e0: 7369 6e67 6c65 273a 0a20 2020 2020 2020  single':.       
-000051f0: 2020 2020 2073 6578 5f63 6f6e 6669 6720       sex_config 
-00005200: 2b3d 2028 2257 4549 4748 545f 5459 5045  += ("WEIGHT_TYPE
-00005210: 204d 4150 5f57 4549 4748 545c 6e22 0a20   MAP_WEIGHT\n". 
-00005220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005230: 2020 2020 2020 2020 2020 2257 4549 4748            "WEIGH
-00005240: 545f 494d 4147 4520 7b77 696d 6167 657d  T_IMAGE {wimage}
-00005250: 2229 2e66 6f72 6d61 7428 7769 6d61 6765  ").format(wimage
-00005260: 3d77 696d 6167 655f 6669 6c65 290a 0a20  =wimage_file).. 
-00005270: 2020 2020 2020 2065 6c69 6620 6d6f 6465         elif mode
-00005280: 203d 3d20 2764 7561 6c27 3a0a 0a20 2020   == 'dual':..   
-00005290: 2020 2020 2020 2020 2077 6465 7465 6374           wdetect
-000052a0: 696f 6e5f 6669 6c65 203d 2064 6574 6563  ion_file = detec
-000052b0: 7469 6f6e 5f66 696c 652e 7265 706c 6163  tion_file.replac
-000052c0: 6528 222e 6669 7473 222c 2022 7765 6967  e(".fits", "weig
-000052d0: 6874 2e66 6974 7322 290a 0a20 2020 2020  ht.fits")..     
-000052e0: 2020 2020 2020 2073 6578 5f63 6f6e 6669         sex_confi
-000052f0: 6720 2b3d 2028 2257 4549 4748 545f 5459  g += ("WEIGHT_TY
-00005300: 5045 204d 4150 5f57 4549 4748 542c 204d  PE MAP_WEIGHT, M
-00005310: 4150 5f57 4549 4748 545c 6e22 0a20 2020  AP_WEIGHT\n".   
-00005320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005330: 2020 2020 2020 2020 2257 4549 4748 545f          "WEIGHT_
-00005340: 494d 4147 4520 7b77 6465 7465 6374 696f  IMAGE {wdetectio
-00005350: 6e7d 2c20 7b77 696d 6167 657d 220a 2020  n}, {wimage}".  
+00005110: 2020 2020 6761 696e 3d67 6169 6e29 0a0a      gain=gain)..
+00005120: 2020 2020 2320 496e 636c 7564 6520 7765      # Include we
+00005130: 6967 6874 2069 6d61 6765 0a20 2020 2069  ight image.    i
+00005140: 6620 7573 655f 7765 6967 6874 3a0a 2020  f use_weight:.  
+00005150: 2020 2020 2020 7769 6d61 6765 5f66 696c        wimage_fil
+00005160: 6520 3d20 696d 6167 655f 6669 6c65 2e72  e = image_file.r
+00005170: 6570 6c61 6365 2822 2e66 6974 7322 2c20  eplace(".fits", 
+00005180: 2277 6569 6768 742e 6669 7473 2229 0a0a  "weight.fits")..
+00005190: 2020 2020 2020 2020 6966 206d 6f64 6520          if mode 
+000051a0: 3d3d 2027 7369 6e67 6c65 273a 0a20 2020  == 'single':.   
+000051b0: 2020 2020 2020 2020 2073 6578 5f63 6f6e           sex_con
+000051c0: 6669 6720 2b3d 2028 2257 4549 4748 545f  fig += ("WEIGHT_
+000051d0: 5459 5045 204d 4150 5f57 4549 4748 545c  TYPE MAP_WEIGHT\
+000051e0: 6e22 0a20 2020 2020 2020 2020 2020 2020  n".             
+000051f0: 2020 2020 2020 2020 2020 2020 2020 2257                "W
+00005200: 4549 4748 545f 494d 4147 4520 7b77 696d  EIGHT_IMAGE {wim
+00005210: 6167 657d 2229 2e66 6f72 6d61 7428 7769  age}").format(wi
+00005220: 6d61 6765 3d77 696d 6167 655f 6669 6c65  mage=wimage_file
+00005230: 290a 0a20 2020 2020 2020 2065 6c69 6620  )..        elif 
+00005240: 6d6f 6465 203d 3d20 2764 7561 6c27 3a0a  mode == 'dual':.
+00005250: 0a20 2020 2020 2020 2020 2020 2077 6465  .            wde
+00005260: 7465 6374 696f 6e5f 6669 6c65 203d 2064  tection_file = d
+00005270: 6574 6563 7469 6f6e 5f66 696c 652e 7265  etection_file.re
+00005280: 706c 6163 6528 222e 6669 7473 222c 2022  place(".fits", "
+00005290: 7765 6967 6874 2e66 6974 7322 290a 0a20  weight.fits").. 
+000052a0: 2020 2020 2020 2020 2020 2073 6578 5f63             sex_c
+000052b0: 6f6e 6669 6720 2b3d 2028 2257 4549 4748  onfig += ("WEIGH
+000052c0: 545f 5459 5045 204d 4150 5f57 4549 4748  T_TYPE MAP_WEIGH
+000052d0: 542c 204d 4150 5f57 4549 4748 545c 6e22  T, MAP_WEIGHT\n"
+000052e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000052f0: 2020 2020 2020 2020 2020 2020 2257 4549              "WEI
+00005300: 4748 545f 494d 4147 4520 7b77 6465 7465  GHT_IMAGE {wdete
+00005310: 6374 696f 6e7d 2c20 7b77 696d 6167 657d  ction}, {wimage}
+00005320: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00005330: 2020 2020 2020 2020 2020 2020 2022 2229               "")
+00005340: 2e66 6f72 6d61 7428 7769 6d61 6765 3d77  .format(wimage=w
+00005350: 696d 6167 655f 6669 6c65 2c0a 2020 2020  image_file,.    
 00005360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005370: 2020 2020 2020 2020 2022 2229 2e66 6f72           "").for
-00005380: 6d61 7428 7769 6d61 6765 3d77 696d 6167  mat(wimage=wimag
-00005390: 655f 6669 6c65 2c0a 2020 2020 2020 2020  e_file,.        
-000053a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000053b0: 2020 2020 2020 2020 2020 2020 2020 7764                wd
-000053c0: 6574 6563 7469 6f6e 3d77 6465 7465 6374  etection=wdetect
-000053d0: 696f 6e5f 6669 6c65 290a 0a20 2020 2023  ion_file)..    #
-000053e0: 2041 6464 2061 7065 7220 616e 6420 7365   Add aper and se
-000053f0: 676d 2069 6d61 6765 0a20 2020 2069 6620  gm image.    if 
-00005400: 6368 6563 6b5f 6170 6572 696d 6120 6973  check_aperima is
-00005410: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00005420: 2020 2073 6578 5f63 6f6e 6669 6720 2b3d     sex_config +=
-00005430: 2028 225c 6e43 4845 434b 494d 4147 455f   ("\nCHECKIMAGE_
-00005440: 5459 5045 2041 5045 5254 5552 4553 2c53  TYPE APERTURES,S
-00005450: 4547 4d45 4e54 4154 494f 4e5c 6e22 0a20  EGMENTATION\n". 
+00005370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005380: 2020 7764 6574 6563 7469 6f6e 3d77 6465    wdetection=wde
+00005390: 7465 6374 696f 6e5f 6669 6c65 290a 0a20  tection_file).. 
+000053a0: 2020 2023 2041 6464 2061 7065 7220 616e     # Add aper an
+000053b0: 6420 7365 676d 2069 6d61 6765 0a20 2020  d segm image.   
+000053c0: 2069 6620 6368 6563 6b5f 6170 6572 696d   if check_aperim
+000053d0: 6120 6973 206e 6f74 204e 6f6e 653a 0a20  a is not None:. 
+000053e0: 2020 2020 2020 2073 6578 5f63 6f6e 6669         sex_confi
+000053f0: 6720 2b3d 2028 225c 6e43 4845 434b 494d  g += ("\nCHECKIM
+00005400: 4147 455f 5459 5045 2041 5045 5254 5552  AGE_TYPE APERTUR
+00005410: 4553 2c53 4547 4d45 4e54 4154 494f 4e5c  ES,SEGMENTATION\
+00005420: 6e22 0a20 2020 2020 2020 2020 2020 2020  n".             
+00005430: 2020 2020 2020 2020 2020 2243 4845 434b            "CHECK
+00005440: 494d 4147 455f 4e41 4d45 207b 6170 6572  IMAGE_NAME {aper
+00005450: 696d 617d 2c20 7b73 6567 696d 617d 220a  ima}, {segima}".
 00005460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005470: 2020 2020 2020 2243 4845 434b 494d 4147        "CHECKIMAG
-00005480: 455f 4e41 4d45 207b 6170 6572 696d 617d  E_NAME {aperima}
-00005490: 2c20 7b73 6567 696d 617d 220a 2020 2020  , {segima}".    
+00005470: 2020 2020 2020 2022 2229 2e66 6f72 6d61         "").forma
+00005480: 7428 6170 6572 696d 613d 6368 6563 6b5f  t(aperima=check_
+00005490: 6170 6572 696d 612c 0a20 2020 2020 2020  aperima,.       
 000054a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000054b0: 2020 2022 2229 2e66 6f72 6d61 7428 6170     "").format(ap
-000054c0: 6572 696d 613d 6368 6563 6b5f 6170 6572  erima=check_aper
-000054d0: 696d 612c 0a20 2020 2020 2020 2020 2020  ima,.           
-000054e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000054f0: 2020 2020 2020 2073 6567 696d 613d 6368         segima=ch
-00005500: 6563 6b5f 7365 6769 6d61 290a 0a20 2020  eck_segima)..   
-00005510: 2023 2053 6176 6520 636f 6e66 6967 2066   # Save config f
-00005520: 696c 650a 2020 2020 7769 7468 206f 7065  ile.    with ope
-00005530: 6e28 7361 7665 5f66 696c 652c 2027 7727  n(save_file, 'w'
-00005540: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-00005550: 662e 7772 6974 6528 7365 785f 636f 6e66  f.write(sex_conf
-00005560: 6967 290a 0a0a 0a64 6566 2073 706c 7573  ig)....def splus
-00005570: 5f69 6d61 6765 5f73 6174 7572 5f6c 6576  _image_satur_lev
-00005580: 656c 2869 6d61 6765 5f66 696c 6529 3a0a  el(image_file):.
-00005590: 2020 2020 2222 220a 2020 2020 5265 6164      """.    Read
-000055a0: 7320 7468 6520 532d 504c 5553 2069 6d61  s the S-PLUS ima
-000055b0: 6765 2068 6561 6465 7220 616e 6420 7265  ge header and re
-000055c0: 7475 726e 7320 7468 6520 7361 7475 7261  turns the satura
-000055d0: 7469 6f6e 206c 6576 656c 0a0a 2020 2020  tion level..    
-000055e0: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-000055f0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 696d  ---------.    im
-00005600: 6167 655f 6669 6c65 203a 2073 7472 0a20  age_file : str. 
-00005610: 2020 2020 2020 204c 6f63 6174 696f 6e20         Location 
-00005620: 6f66 2053 2d50 4c55 5320 696d 6167 6520  of S-PLUS image 
-00005630: 2866 6974 7320 6f72 2066 7a29 0a0a 2020  (fits or fz)..  
-00005640: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
-00005650: 2d2d 2d2d 2d0a 2020 2020 666c 6f61 740a  -----.    float.
-00005660: 2020 2020 2020 2020 5661 6c75 6520 6f66          Value of
-00005670: 2073 6174 7572 6174 696f 6e20 6c65 7665   saturation leve
-00005680: 6c20 2827 5341 5455 5241 5445 2729 0a20  l ('SATURATE'). 
-00005690: 2020 2022 2222 0a0a 2020 2020 2320 4765     """..    # Ge
-000056a0: 7420 6669 6c65 2065 7874 656e 7369 6f6e  t file extension
-000056b0: 0a20 2020 2065 7874 656e 7369 6f6e 203d  .    extension =
-000056c0: 206f 732e 7061 7468 2e73 706c 6974 6578   os.path.splitex
-000056d0: 7428 696d 6167 655f 6669 6c65 295b 315d  t(image_file)[1]
-000056e0: 5b31 3a5d 0a0a 2020 2020 6966 2065 7874  [1:]..    if ext
-000056f0: 656e 7369 6f6e 203d 3d20 2766 7a27 3a0a  ension == 'fz':.
-00005700: 2020 2020 2020 2020 6865 6164 203d 2066          head = f
-00005710: 6974 732e 6f70 656e 2869 6d61 6765 5f66  its.open(image_f
-00005720: 696c 6529 5b31 5d2e 6865 6164 6572 0a0a  ile)[1].header..
-00005730: 2020 2020 656c 6966 2065 7874 656e 7369      elif extensi
-00005740: 6f6e 203d 3d20 2766 6974 7327 3a0a 2020  on == 'fits':.  
-00005750: 2020 2020 2020 6865 6164 203d 2066 6974        head = fit
-00005760: 732e 6f70 656e 2869 6d61 6765 5f66 696c  s.open(image_fil
-00005770: 6529 5b30 5d2e 6865 6164 6572 0a0a 2020  e)[0].header..  
-00005780: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00005790: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-000057a0: 2822 496d 6167 6520 6578 7465 6e73 696f  ("Image extensio
-000057b0: 6e20 6d75 7374 2062 6520 2766 6974 7327  n must be 'fits'
-000057c0: 206f 7220 2766 7a27 2229 0a0a 2020 2020   or 'fz'")..    
-000057d0: 7361 7475 7220 3d20 666c 6f61 7428 6865  satur = float(he
-000057e0: 6164 5b27 5341 5455 5241 5445 275d 290a  ad['SATURATE']).
-000057f0: 0a20 2020 2072 6574 7572 6e20 7361 7475  .    return satu
-00005800: 720a 0a0a 6465 6620 7370 6c75 735f 696d  r...def splus_im
-00005810: 6167 655f 6761 696e 2869 6d61 6765 5f66  age_gain(image_f
-00005820: 696c 6529 3a0a 2020 2020 2222 220a 2020  ile):.    """.  
-00005830: 2020 5265 6164 7320 7468 6520 532d 504c    Reads the S-PL
-00005840: 5553 2069 6d61 6765 2068 6561 6465 7220  US image header 
-00005850: 616e 6420 7265 7475 726e 7320 7468 6520  and returns the 
-00005860: 6761 696e 0a0a 2020 2020 5061 7261 6d65  gain..    Parame
-00005870: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-00005880: 2d2d 2d0a 2020 2020 696d 6167 655f 6669  ---.    image_fi
-00005890: 6c65 203a 2073 7472 0a20 2020 2020 2020  le : str.       
-000058a0: 204c 6f63 6174 696f 6e20 6f66 2053 2d50   Location of S-P
-000058b0: 4c55 5320 696d 6167 6520 2866 6974 7320  LUS image (fits 
-000058c0: 6f72 2066 7a29 0a0a 2020 2020 5265 7475  or fz)..    Retu
-000058d0: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-000058e0: 2020 2020 666c 6f61 740a 2020 2020 2020      float.      
-000058f0: 2020 5661 6c75 6520 6f66 2067 6169 6e20    Value of gain 
-00005900: 2827 4741 494e 2729 0a20 2020 2022 2222  ('GAIN').    """
-00005910: 0a0a 2020 2020 2320 4765 7420 6669 6c65  ..    # Get file
-00005920: 2065 7874 656e 7369 6f6e 0a20 2020 2065   extension.    e
-00005930: 7874 656e 7369 6f6e 203d 206f 732e 7061  xtension = os.pa
-00005940: 7468 2e73 706c 6974 6578 7428 696d 6167  th.splitext(imag
-00005950: 655f 6669 6c65 295b 315d 5b31 3a5d 0a0a  e_file)[1][1:]..
-00005960: 2020 2020 6966 2065 7874 656e 7369 6f6e      if extension
-00005970: 203d 3d20 2766 7a27 3a0a 2020 2020 2020   == 'fz':.      
-00005980: 2020 6865 6164 203d 2066 6974 732e 6f70    head = fits.op
-00005990: 656e 2869 6d61 6765 5f66 696c 6529 5b31  en(image_file)[1
-000059a0: 5d2e 6865 6164 6572 0a0a 2020 2020 656c  ].header..    el
-000059b0: 6966 2065 7874 656e 7369 6f6e 203d 3d20  if extension == 
-000059c0: 2766 6974 7327 3a0a 2020 2020 2020 2020  'fits':.        
-000059d0: 6865 6164 203d 2066 6974 732e 6f70 656e  head = fits.open
-000059e0: 2869 6d61 6765 5f66 696c 6529 5b30 5d2e  (image_file)[0].
-000059f0: 6865 6164 6572 0a0a 2020 2020 656c 7365  header..    else
-00005a00: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-00005a10: 5661 6c75 6545 7272 6f72 2822 496d 6167  ValueError("Imag
-00005a20: 6520 6578 7465 6e73 696f 6e20 6d75 7374  e extension must
-00005a30: 2062 6520 2766 6974 7327 206f 7220 2766   be 'fits' or 'f
-00005a40: 7a27 2229 0a0a 2020 2020 6761 696e 203d  z'")..    gain =
-00005a50: 2066 6c6f 6174 2868 6561 645b 2747 4149   float(head['GAI
-00005a60: 4e27 5d29 0a0a 2020 2020 7265 7475 726e  N'])..    return
-00005a70: 2067 6169 6e0a 0a0a 6465 6620 7370 6c75   gain...def splu
-00005a80: 735f 696d 6167 655f 7365 6569 6e67 2869  s_image_seeing(i
-00005a90: 6d61 6765 5f66 696c 6529 3a0a 2020 2020  mage_file):.    
-00005aa0: 2222 220a 2020 2020 5265 6164 7320 7468  """.    Reads th
-00005ab0: 6520 532d 504c 5553 2069 6d61 6765 2068  e S-PLUS image h
-00005ac0: 6561 6465 7220 616e 6420 7265 7475 726e  eader and return
-00005ad0: 7320 7468 6520 6f62 7365 7276 6174 696f  s the observatio
-00005ae0: 6e20 7365 6569 6e67 0a0a 2020 2020 5061  n seeing..    Pa
-00005af0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-00005b00: 2d2d 2d2d 2d2d 2d0a 2020 2020 696d 6167  -------.    imag
-00005b10: 655f 6669 6c65 203a 2073 7472 0a20 2020  e_file : str.   
-00005b20: 2020 2020 204c 6f63 6174 696f 6e20 6f66       Location of
-00005b30: 2053 2d50 4c55 5320 696d 6167 6520 2866   S-PLUS image (f
-00005b40: 6974 7320 6f72 2066 7a29 0a0a 2020 2020  its or fz)..    
-00005b50: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
-00005b60: 2d2d 2d0a 2020 2020 666c 6f61 740a 2020  ---.    float.  
-00005b70: 2020 2020 2020 5661 6c75 6520 6f66 2067        Value of g
-00005b80: 6169 6e20 2827 4849 4552 4152 4348 204f  ain ('HIERARCH O
-00005b90: 414a 2050 524f 2046 5748 4d53 4558 5427  AJ PRO FWHMSEXT'
-00005ba0: 290a 2020 2020 2222 220a 0a20 2020 2023  ).    """..    #
-00005bb0: 2047 6574 2066 696c 6520 6578 7465 6e73   Get file extens
-00005bc0: 696f 6e0a 2020 2020 6578 7465 6e73 696f  ion.    extensio
-00005bd0: 6e20 3d20 6f73 2e70 6174 682e 7370 6c69  n = os.path.spli
-00005be0: 7465 7874 2869 6d61 6765 5f66 696c 6529  text(image_file)
-00005bf0: 5b31 5d5b 313a 5d0a 0a20 2020 2069 6620  [1][1:]..    if 
-00005c00: 6578 7465 6e73 696f 6e20 3d3d 2027 667a  extension == 'fz
-00005c10: 273a 0a20 2020 2020 2020 2068 6561 6420  ':.        head 
-00005c20: 3d20 6669 7473 2e6f 7065 6e28 696d 6167  = fits.open(imag
-00005c30: 655f 6669 6c65 295b 315d 2e68 6561 6465  e_file)[1].heade
-00005c40: 720a 0a20 2020 2065 6c69 6620 6578 7465  r..    elif exte
-00005c50: 6e73 696f 6e20 3d3d 2027 6669 7473 273a  nsion == 'fits':
-00005c60: 0a20 2020 2020 2020 2068 6561 6420 3d20  .        head = 
-00005c70: 6669 7473 2e6f 7065 6e28 696d 6167 655f  fits.open(image_
-00005c80: 6669 6c65 295b 305d 2e68 6561 6465 720a  file)[0].header.
-00005c90: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00005ca0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00005cb0: 726f 7228 2249 6d61 6765 2065 7874 656e  ror("Image exten
-00005cc0: 7369 6f6e 206d 7573 7420 6265 2027 6669  sion must be 'fi
-00005cd0: 7473 2720 6f72 2027 667a 2722 290a 0a20  ts' or 'fz'").. 
-00005ce0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00005cf0: 7365 6569 6e67 203d 2066 6c6f 6174 2868  seeing = float(h
-00005d00: 6561 645b 2748 4945 5241 5243 4820 4f41  ead['HIERARCH OA
-00005d10: 4a20 5052 4f20 4657 484d 5345 5854 275d  J PRO FWHMSEXT']
-00005d20: 290a 2020 2020 6578 6365 7074 204b 6579  ).    except Key
-00005d30: 4572 726f 723a 0a20 2020 2020 2020 2073  Error:.        s
-00005d40: 6565 696e 6720 3d20 666c 6f61 7428 6865  eeing = float(he
-00005d50: 6164 5b27 4849 4552 4152 4348 204d 4152  ad['HIERARCH MAR
-00005d60: 2050 524f 2046 5748 4d53 4558 5427 5d29   PRO FWHMSEXT'])
-00005d70: 0a0a 2020 2020 7265 7475 726e 2073 6565  ..    return see
-00005d80: 696e 670a 0a0a 6465 6620 6765 745f 7377  ing...def get_sw
-00005d90: 6172 705f 636f 6e66 6967 2873 6176 655f  arp_config(save_
-00005da0: 6669 6c65 2c20 6465 6661 756c 745f 7377  file, default_sw
-00005db0: 6172 7063 6f6e 6669 672c 2064 6574 6563  arpconfig, detec
-00005dc0: 7469 6f6e 5f69 6d61 6765 5f6f 7574 2c0a  tion_image_out,.
-00005dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005de0: 2020 2020 2064 6574 6563 7469 6f6e 5f77       detection_w
-00005df0: 6569 6768 745f 6f75 742c 2072 6573 616d  eight_out, resam
-00005e00: 706c 655f 6469 722c 2078 6d6c 5f6f 7574  ple_dir, xml_out
-00005e10: 7075 742c 0a20 2020 2020 2020 2020 2020  put,.           
-00005e20: 2020 2020 2020 2020 2020 636f 6d62 696e            combin
-00005e30: 655f 7479 7065 2c20 7765 6967 6874 5f74  e_type, weight_t
-00005e40: 7970 652c 2072 6566 5f69 6d61 6765 293a  ype, ref_image):
-00005e50: 0a0a 2020 2020 2222 220a 2020 2020 4765  ..    """.    Ge
-00005e60: 6e65 7261 7465 7320 7468 6520 7377 6172  nerates the swar
-00005e70: 7020 636f 6e66 6967 7572 6174 696f 6e20  p configuration 
-00005e80: 6669 6c65 2c20 696e 636c 7564 696e 6720  file, including 
-00005e90: 6669 656c 6420 7370 6563 6966 6963 2070  field specific p
-00005ea0: 6174 6873 0a0a 2020 2020 5061 7261 6d65  aths..    Parame
-00005eb0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-00005ec0: 2d2d 2d0a 2020 2020 7361 7665 5f66 696c  ---.    save_fil
-00005ed0: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
-00005ee0: 4c6f 6361 7469 6f6e 2074 6f20 7361 7665  Location to save
-00005ef0: 2074 6865 2073 7761 7270 2063 6f6e 6669   the swarp confi
-00005f00: 6775 7261 7469 6f6e 2066 696c 650a 2020  guration file.  
-00005f10: 2020 6465 6661 756c 745f 7377 6172 7063    default_swarpc
-00005f20: 6f6e 6669 6720 3a20 7374 720a 2020 2020  onfig : str.    
-00005f30: 2020 2020 4c6f 6361 7469 6f6e 206f 6620      Location of 
-00005f40: 7468 6520 6765 6e65 7261 6c20 7377 6172  the general swar
-00005f50: 7020 7370 6c75 7320 636f 6e66 6967 7572  p splus configur
-00005f60: 6174 696f 6e20 6669 6c65 0a20 2020 2064  ation file.    d
-00005f70: 6574 6563 7469 6f6e 5f69 6d61 6765 5f6f  etection_image_o
-00005f80: 7574 203a 2073 7472 0a20 2020 2020 2020  ut : str.       
-00005f90: 204c 6f63 6174 696f 6e20 746f 2073 6176   Location to sav
-00005fa0: 6520 7468 6520 6765 6e65 7261 7465 6420  e the generated 
-00005fb0: 6465 7465 6374 696f 6e20 696d 6167 650a  detection image.
-00005fc0: 2020 2020 6465 7465 6374 696f 6e5f 7765      detection_we
-00005fd0: 6967 6874 5f6f 7574 203a 2073 7472 0a20  ight_out : str. 
-00005fe0: 2020 2020 2020 204c 6f63 6174 696f 6e20         Location 
-00005ff0: 746f 2073 6176 6520 7468 6520 6765 6e65  to save the gene
-00006000: 7261 7465 6420 6465 7465 6374 696f 6e20  rated detection 
-00006010: 696d 6167 6520 7765 6967 6874 0a20 2020  image weight.   
-00006020: 2072 6573 616d 706c 655f 6469 7220 3a20   resample_dir : 
-00006030: 7374 720a 2020 2020 2020 2020 4469 7265  str.        Dire
-00006040: 6374 6f72 7920 746f 2073 6176 6520 7468  ctory to save th
-00006050: 6520 7265 7361 6d70 6c65 6420 6669 7473  e resampled fits
-00006060: 2069 6d61 6765 730a 2020 2020 786d 6c5f   images.    xml_
-00006070: 6f75 7470 7574 203a 2073 7472 0a20 2020  output : str.   
-00006080: 2020 2020 204c 6f63 6174 696f 6e20 746f       Location to
-00006090: 2073 6176 6520 7468 6520 7377 6172 7020   save the swarp 
-000060a0: 786d 6c20 6f75 7470 7574 0a20 2020 2063  xml output.    c
-000060b0: 6f6d 6269 6e65 5f74 7970 6520 3a20 7374  ombine_type : st
-000060c0: 720a 2020 2020 2020 2020 7377 6172 7020  r.        swarp 
-000060d0: 636f 6e66 6967 7572 6174 696f 6e20 7061  configuration pa
-000060e0: 7261 6d65 7465 7220 434f 4d42 494e 455f  rameter COMBINE_
-000060f0: 5459 5045 0a20 2020 2077 6569 6768 745f  TYPE.    weight_
-00006100: 7479 7065 203a 2073 7472 0a20 2020 2020  type : str.     
-00006110: 2020 2073 7761 7270 2063 6f6e 6669 6775     swarp configu
-00006120: 7261 7469 6f6e 2070 6172 616d 6574 6572  ration parameter
-00006130: 2057 4549 4748 545f 5459 5045 0a20 2020   WEIGHT_TYPE.   
-00006140: 2072 6566 5f69 6d61 6765 203a 2073 7472   ref_image : str
-00006150: 0a20 2020 2020 2020 2069 6d61 6765 2074  .        image t
-00006160: 6f20 6265 2075 7365 6420 6173 2072 6566  o be used as ref
-00006170: 6572 656e 6365 2074 6f20 7461 6b65 2063  erence to take c
-00006180: 656e 7465 7220 636f 6f72 6469 6e61 7465  enter coordinate
-00006190: 730a 0a20 2020 2052 6574 7572 6e73 0a20  s..    Returns. 
-000061a0: 2020 202d 2d2d 2d2d 2d2d 0a0a 2020 2020     -------..    
-000061b0: 2222 220a 2020 2020 2320 5265 6164 2067  """.    # Read g
-000061c0: 656e 6572 616c 2063 6f6e 6669 6775 7261  eneral configura
-000061d0: 7469 6f6e 2066 696c 650a 2020 2020 7769  tion file.    wi
-000061e0: 7468 206f 7065 6e28 6465 6661 756c 745f  th open(default_
-000061f0: 7377 6172 7063 6f6e 6669 672c 2027 7227  swarpconfig, 'r'
-00006200: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-00006210: 7377 6172 705f 636f 6e66 6967 203d 2066  swarp_config = f
-00006220: 2e72 6561 646c 696e 6573 2829 0a20 2020  .readlines().   
-00006230: 2020 2020 2073 7761 7270 5f63 6f6e 6669       swarp_confi
-00006240: 6720 3d20 2222 2e6a 6f69 6e28 7377 6172  g = "".join(swar
-00006250: 705f 636f 6e66 6967 290a 0a20 2020 2023  p_config)..    #
-00006260: 2047 6574 2063 656e 7465 720a 2020 2020   Get center.    
-00006270: 6578 7465 6e73 696f 6e20 3d20 6f73 2e70  extension = os.p
-00006280: 6174 682e 7370 6c69 7465 7874 2872 6566  ath.splitext(ref
-00006290: 5f69 6d61 6765 295b 315d 5b31 3a5d 0a0a  _image)[1][1:]..
-000062a0: 2020 2020 6966 2065 7874 656e 7369 6f6e      if extension
-000062b0: 203d 3d20 2766 7a27 3a0a 2020 2020 2020   == 'fz':.      
-000062c0: 2020 6865 6164 203d 2066 6974 732e 6f70    head = fits.op
-000062d0: 656e 2872 6566 5f69 6d61 6765 295b 315d  en(ref_image)[1]
-000062e0: 2e68 6561 6465 720a 2020 2020 656c 6966  .header.    elif
-000062f0: 2065 7874 656e 7369 6f6e 203d 3d20 2766   extension == 'f
-00006300: 6974 7327 3a0a 2020 2020 2020 2020 6865  its':.        he
-00006310: 6164 203d 2066 6974 732e 6f70 656e 2872  ad = fits.open(r
-00006320: 6566 5f69 6d61 6765 295b 305d 2e68 6561  ef_image)[0].hea
-00006330: 6465 720a 2020 2020 656c 7365 3a0a 2020  der.    else:.  
-00006340: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00006350: 6545 7272 6f72 2822 496d 6167 6520 6578  eError("Image ex
-00006360: 7465 6e73 696f 6e20 6d75 7374 2062 6520  tension must be 
-00006370: 2766 6974 7327 206f 7220 2766 7a27 2229  'fits' or 'fz'")
-00006380: 0a0a 2020 2020 6365 6e74 6572 5f72 6120  ..    center_ra 
-00006390: 3d20 666c 6f61 7428 6865 6164 5b27 4352  = float(head['CR
-000063a0: 5641 4c31 275d 290a 2020 2020 6365 6e74  VAL1']).    cent
-000063b0: 6572 5f64 6563 203d 2066 6c6f 6174 2868  er_dec = float(h
-000063c0: 6561 645b 2743 5256 414c 3227 5d29 0a0a  ead['CRVAL2'])..
-000063d0: 2020 2020 6365 6e74 6572 203d 2066 227b      center = f"{
-000063e0: 6365 6e74 6572 5f72 617d 2c20 7b63 656e  center_ra}, {cen
-000063f0: 7465 725f 6465 637d 220a 0a20 2020 2023  ter_dec}"..    #
-00006400: 2055 7064 6174 6520 7377 6172 705f 636f   Update swarp_co
-00006410: 6e66 6967 0a20 2020 2073 7761 7270 5f63  nfig.    swarp_c
-00006420: 6f6e 6669 6720 3d20 7377 6172 705f 636f  onfig = swarp_co
-00006430: 6e66 6967 2e66 6f72 6d61 7428 696d 6167  nfig.format(imag
-00006440: 655f 6f75 7420 2020 203d 2064 6574 6563  e_out    = detec
-00006450: 7469 6f6e 5f69 6d61 6765 5f6f 7574 2c0a  tion_image_out,.
-00006460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000054b0: 2020 2020 2020 2020 2020 2073 6567 696d             segim
+000054c0: 613d 6368 6563 6b5f 7365 6769 6d61 290a  a=check_segima).
+000054d0: 0a20 2020 2023 2053 6176 6520 636f 6e66  .    # Save conf
+000054e0: 6967 2066 696c 650a 2020 2020 7769 7468  ig file.    with
+000054f0: 206f 7065 6e28 7361 7665 5f66 696c 652c   open(save_file,
+00005500: 2027 7727 2920 6173 2066 3a0a 2020 2020   'w') as f:.    
+00005510: 2020 2020 662e 7772 6974 6528 7365 785f      f.write(sex_
+00005520: 636f 6e66 6967 290a 0a0a 0a64 6566 2073  config)....def s
+00005530: 706c 7573 5f69 6d61 6765 5f73 6174 7572  plus_image_satur
+00005540: 5f6c 6576 656c 2869 6d61 6765 5f66 696c  _level(image_fil
+00005550: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
+00005560: 5265 6164 7320 7468 6520 532d 504c 5553  Reads the S-PLUS
+00005570: 2069 6d61 6765 2068 6561 6465 7220 616e   image header an
+00005580: 6420 7265 7475 726e 7320 7468 6520 7361  d returns the sa
+00005590: 7475 7261 7469 6f6e 206c 6576 656c 0a0a  turation level..
+000055a0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+000055b0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+000055c0: 2020 696d 6167 655f 6669 6c65 203a 2073    image_file : s
+000055d0: 7472 0a20 2020 2020 2020 204c 6f63 6174  tr.        Locat
+000055e0: 696f 6e20 6f66 2053 2d50 4c55 5320 696d  ion of S-PLUS im
+000055f0: 6167 6520 2866 6974 7320 6f72 2066 7a29  age (fits or fz)
+00005600: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+00005610: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 666c    -------.    fl
+00005620: 6f61 740a 2020 2020 2020 2020 5661 6c75  oat.        Valu
+00005630: 6520 6f66 2073 6174 7572 6174 696f 6e20  e of saturation 
+00005640: 6c65 7665 6c20 2827 5341 5455 5241 5445  level ('SATURATE
+00005650: 2729 0a20 2020 2022 2222 0a0a 2020 2020  ').    """..    
+00005660: 2320 4765 7420 6669 6c65 2065 7874 656e  # Get file exten
+00005670: 7369 6f6e 0a20 2020 2065 7874 656e 7369  sion.    extensi
+00005680: 6f6e 203d 206f 732e 7061 7468 2e73 706c  on = os.path.spl
+00005690: 6974 6578 7428 696d 6167 655f 6669 6c65  itext(image_file
+000056a0: 295b 315d 5b31 3a5d 0a0a 2020 2020 6966  )[1][1:]..    if
+000056b0: 2065 7874 656e 7369 6f6e 203d 3d20 2766   extension == 'f
+000056c0: 7a27 3a0a 2020 2020 2020 2020 6865 6164  z':.        head
+000056d0: 203d 2066 6974 732e 6f70 656e 2869 6d61   = fits.open(ima
+000056e0: 6765 5f66 696c 6529 5b31 5d2e 6865 6164  ge_file)[1].head
+000056f0: 6572 0a0a 2020 2020 656c 6966 2065 7874  er..    elif ext
+00005700: 656e 7369 6f6e 203d 3d20 2766 6974 7327  ension == 'fits'
+00005710: 3a0a 2020 2020 2020 2020 6865 6164 203d  :.        head =
+00005720: 2066 6974 732e 6f70 656e 2869 6d61 6765   fits.open(image
+00005730: 5f66 696c 6529 5b30 5d2e 6865 6164 6572  _file)[0].header
+00005740: 0a0a 2020 2020 656c 7365 3a0a 2020 2020  ..    else:.    
+00005750: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00005760: 7272 6f72 2822 496d 6167 6520 6578 7465  rror("Image exte
+00005770: 6e73 696f 6e20 6d75 7374 2062 6520 2766  nsion must be 'f
+00005780: 6974 7327 206f 7220 2766 7a27 2229 0a0a  its' or 'fz'")..
+00005790: 2020 2020 7361 7475 7220 3d20 666c 6f61      satur = floa
+000057a0: 7428 6865 6164 5b27 5341 5455 5241 5445  t(head['SATURATE
+000057b0: 275d 290a 0a20 2020 2072 6574 7572 6e20  '])..    return 
+000057c0: 7361 7475 720a 0a0a 6465 6620 7370 6c75  satur...def splu
+000057d0: 735f 696d 6167 655f 6761 696e 2869 6d61  s_image_gain(ima
+000057e0: 6765 5f66 696c 6529 3a0a 2020 2020 2222  ge_file):.    ""
+000057f0: 220a 2020 2020 5265 6164 7320 7468 6520  ".    Reads the 
+00005800: 532d 504c 5553 2069 6d61 6765 2068 6561  S-PLUS image hea
+00005810: 6465 7220 616e 6420 7265 7475 726e 7320  der and returns 
+00005820: 7468 6520 6761 696e 0a0a 2020 2020 5061  the gain..    Pa
+00005830: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00005840: 2d2d 2d2d 2d2d 2d0a 2020 2020 696d 6167  -------.    imag
+00005850: 655f 6669 6c65 203a 2073 7472 0a20 2020  e_file : str.   
+00005860: 2020 2020 204c 6f63 6174 696f 6e20 6f66       Location of
+00005870: 2053 2d50 4c55 5320 696d 6167 6520 2866   S-PLUS image (f
+00005880: 6974 7320 6f72 2066 7a29 0a0a 2020 2020  its or fz)..    
+00005890: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+000058a0: 2d2d 2d0a 2020 2020 666c 6f61 740a 2020  ---.    float.  
+000058b0: 2020 2020 2020 5661 6c75 6520 6f66 2067        Value of g
+000058c0: 6169 6e20 2827 4741 494e 2729 0a20 2020  ain ('GAIN').   
+000058d0: 2022 2222 0a0a 2020 2020 2320 4765 7420   """..    # Get 
+000058e0: 6669 6c65 2065 7874 656e 7369 6f6e 0a20  file extension. 
+000058f0: 2020 2065 7874 656e 7369 6f6e 203d 206f     extension = o
+00005900: 732e 7061 7468 2e73 706c 6974 6578 7428  s.path.splitext(
+00005910: 696d 6167 655f 6669 6c65 295b 315d 5b31  image_file)[1][1
+00005920: 3a5d 0a0a 2020 2020 6966 2065 7874 656e  :]..    if exten
+00005930: 7369 6f6e 203d 3d20 2766 7a27 3a0a 2020  sion == 'fz':.  
+00005940: 2020 2020 2020 6865 6164 203d 2066 6974        head = fit
+00005950: 732e 6f70 656e 2869 6d61 6765 5f66 696c  s.open(image_fil
+00005960: 6529 5b31 5d2e 6865 6164 6572 0a0a 2020  e)[1].header..  
+00005970: 2020 656c 6966 2065 7874 656e 7369 6f6e    elif extension
+00005980: 203d 3d20 2766 6974 7327 3a0a 2020 2020   == 'fits':.    
+00005990: 2020 2020 6865 6164 203d 2066 6974 732e      head = fits.
+000059a0: 6f70 656e 2869 6d61 6765 5f66 696c 6529  open(image_file)
+000059b0: 5b30 5d2e 6865 6164 6572 0a0a 2020 2020  [0].header..    
+000059c0: 656c 7365 3a0a 2020 2020 2020 2020 7261  else:.        ra
+000059d0: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
+000059e0: 496d 6167 6520 6578 7465 6e73 696f 6e20  Image extension 
+000059f0: 6d75 7374 2062 6520 2766 6974 7327 206f  must be 'fits' o
+00005a00: 7220 2766 7a27 2229 0a0a 2020 2020 6761  r 'fz'")..    ga
+00005a10: 696e 203d 2066 6c6f 6174 2868 6561 645b  in = float(head[
+00005a20: 2747 4149 4e27 5d29 0a0a 2020 2020 7265  'GAIN'])..    re
+00005a30: 7475 726e 2067 6169 6e0a 0a0a 6465 6620  turn gain...def 
+00005a40: 7370 6c75 735f 696d 6167 655f 7365 6569  splus_image_seei
+00005a50: 6e67 2869 6d61 6765 5f66 696c 6529 3a0a  ng(image_file):.
+00005a60: 2020 2020 2222 220a 2020 2020 5265 6164      """.    Read
+00005a70: 7320 7468 6520 532d 504c 5553 2069 6d61  s the S-PLUS ima
+00005a80: 6765 2068 6561 6465 7220 616e 6420 7265  ge header and re
+00005a90: 7475 726e 7320 7468 6520 6f62 7365 7276  turns the observ
+00005aa0: 6174 696f 6e20 7365 6569 6e67 0a0a 2020  ation seeing..  
+00005ab0: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00005ac0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00005ad0: 696d 6167 655f 6669 6c65 203a 2073 7472  image_file : str
+00005ae0: 0a20 2020 2020 2020 204c 6f63 6174 696f  .        Locatio
+00005af0: 6e20 6f66 2053 2d50 4c55 5320 696d 6167  n of S-PLUS imag
+00005b00: 6520 2866 6974 7320 6f72 2066 7a29 0a0a  e (fits or fz)..
+00005b10: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00005b20: 2d2d 2d2d 2d2d 2d0a 2020 2020 666c 6f61  -------.    floa
+00005b30: 740a 2020 2020 2020 2020 5661 6c75 6520  t.        Value 
+00005b40: 6f66 2067 6169 6e20 2827 4849 4552 4152  of gain ('HIERAR
+00005b50: 4348 204f 414a 2050 524f 2046 5748 4d53  CH OAJ PRO FWHMS
+00005b60: 4558 5427 290a 2020 2020 2222 220a 0a20  EXT').    """.. 
+00005b70: 2020 2023 2047 6574 2066 696c 6520 6578     # Get file ex
+00005b80: 7465 6e73 696f 6e0a 2020 2020 6578 7465  tension.    exte
+00005b90: 6e73 696f 6e20 3d20 6f73 2e70 6174 682e  nsion = os.path.
+00005ba0: 7370 6c69 7465 7874 2869 6d61 6765 5f66  splitext(image_f
+00005bb0: 696c 6529 5b31 5d5b 313a 5d0a 0a20 2020  ile)[1][1:]..   
+00005bc0: 2069 6620 6578 7465 6e73 696f 6e20 3d3d   if extension ==
+00005bd0: 2027 667a 273a 0a20 2020 2020 2020 2068   'fz':.        h
+00005be0: 6561 6420 3d20 6669 7473 2e6f 7065 6e28  ead = fits.open(
+00005bf0: 696d 6167 655f 6669 6c65 295b 315d 2e68  image_file)[1].h
+00005c00: 6561 6465 720a 0a20 2020 2065 6c69 6620  eader..    elif 
+00005c10: 6578 7465 6e73 696f 6e20 3d3d 2027 6669  extension == 'fi
+00005c20: 7473 273a 0a20 2020 2020 2020 2068 6561  ts':.        hea
+00005c30: 6420 3d20 6669 7473 2e6f 7065 6e28 696d  d = fits.open(im
+00005c40: 6167 655f 6669 6c65 295b 305d 2e68 6561  age_file)[0].hea
+00005c50: 6465 720a 0a20 2020 2065 6c73 653a 0a20  der..    else:. 
+00005c60: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00005c70: 7565 4572 726f 7228 2249 6d61 6765 2065  ueError("Image e
+00005c80: 7874 656e 7369 6f6e 206d 7573 7420 6265  xtension must be
+00005c90: 2027 6669 7473 2720 6f72 2027 667a 2722   'fits' or 'fz'"
+00005ca0: 290a 0a20 2020 2074 7279 3a0a 2020 2020  )..    try:.    
+00005cb0: 2020 2020 7365 6569 6e67 203d 2066 6c6f      seeing = flo
+00005cc0: 6174 2868 6561 645b 2748 4945 5241 5243  at(head['HIERARC
+00005cd0: 4820 4f41 4a20 5052 4f20 4657 484d 5345  H OAJ PRO FWHMSE
+00005ce0: 5854 275d 290a 2020 2020 6578 6365 7074  XT']).    except
+00005cf0: 204b 6579 4572 726f 723a 0a20 2020 2020   KeyError:.     
+00005d00: 2020 2073 6565 696e 6720 3d20 666c 6f61     seeing = floa
+00005d10: 7428 6865 6164 5b27 4849 4552 4152 4348  t(head['HIERARCH
+00005d20: 204d 4152 2050 524f 2046 5748 4d53 4558   MAR PRO FWHMSEX
+00005d30: 5427 5d29 0a0a 2020 2020 7265 7475 726e  T'])..    return
+00005d40: 2073 6565 696e 670a 0a0a 6465 6620 6765   seeing...def ge
+00005d50: 745f 7377 6172 705f 636f 6e66 6967 2873  t_swarp_config(s
+00005d60: 6176 655f 6669 6c65 2c20 6465 6661 756c  ave_file, defaul
+00005d70: 745f 7377 6172 7063 6f6e 6669 672c 2064  t_swarpconfig, d
+00005d80: 6574 6563 7469 6f6e 5f69 6d61 6765 5f6f  etection_image_o
+00005d90: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+00005da0: 2020 2020 2020 2020 2064 6574 6563 7469           detecti
+00005db0: 6f6e 5f77 6569 6768 745f 6f75 742c 2072  on_weight_out, r
+00005dc0: 6573 616d 706c 655f 6469 722c 2078 6d6c  esample_dir, xml
+00005dd0: 5f6f 7574 7075 742c 0a20 2020 2020 2020  _output,.       
+00005de0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00005df0: 6d62 696e 655f 7479 7065 2c20 7765 6967  mbine_type, weig
+00005e00: 6874 5f74 7970 652c 2072 6566 5f69 6d61  ht_type, ref_ima
+00005e10: 6765 293a 0a0a 2020 2020 2222 220a 2020  ge):..    """.  
+00005e20: 2020 4765 6e65 7261 7465 7320 7468 6520    Generates the 
+00005e30: 7377 6172 7020 636f 6e66 6967 7572 6174  swarp configurat
+00005e40: 696f 6e20 6669 6c65 2c20 696e 636c 7564  ion file, includ
+00005e50: 696e 6720 6669 656c 6420 7370 6563 6966  ing field specif
+00005e60: 6963 2070 6174 6873 0a0a 2020 2020 5061  ic paths..    Pa
+00005e70: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00005e80: 2d2d 2d2d 2d2d 2d0a 2020 2020 7361 7665  -------.    save
+00005e90: 5f66 696c 6520 3a20 7374 720a 2020 2020  _file : str.    
+00005ea0: 2020 2020 4c6f 6361 7469 6f6e 2074 6f20      Location to 
+00005eb0: 7361 7665 2074 6865 2073 7761 7270 2063  save the swarp c
+00005ec0: 6f6e 6669 6775 7261 7469 6f6e 2066 696c  onfiguration fil
+00005ed0: 650a 2020 2020 6465 6661 756c 745f 7377  e.    default_sw
+00005ee0: 6172 7063 6f6e 6669 6720 3a20 7374 720a  arpconfig : str.
+00005ef0: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
+00005f00: 206f 6620 7468 6520 6765 6e65 7261 6c20   of the general 
+00005f10: 7377 6172 7020 7370 6c75 7320 636f 6e66  swarp splus conf
+00005f20: 6967 7572 6174 696f 6e20 6669 6c65 0a20  iguration file. 
+00005f30: 2020 2064 6574 6563 7469 6f6e 5f69 6d61     detection_ima
+00005f40: 6765 5f6f 7574 203a 2073 7472 0a20 2020  ge_out : str.   
+00005f50: 2020 2020 204c 6f63 6174 696f 6e20 746f       Location to
+00005f60: 2073 6176 6520 7468 6520 6765 6e65 7261   save the genera
+00005f70: 7465 6420 6465 7465 6374 696f 6e20 696d  ted detection im
+00005f80: 6167 650a 2020 2020 6465 7465 6374 696f  age.    detectio
+00005f90: 6e5f 7765 6967 6874 5f6f 7574 203a 2073  n_weight_out : s
+00005fa0: 7472 0a20 2020 2020 2020 204c 6f63 6174  tr.        Locat
+00005fb0: 696f 6e20 746f 2073 6176 6520 7468 6520  ion to save the 
+00005fc0: 6765 6e65 7261 7465 6420 6465 7465 6374  generated detect
+00005fd0: 696f 6e20 696d 6167 6520 7765 6967 6874  ion image weight
+00005fe0: 0a20 2020 2072 6573 616d 706c 655f 6469  .    resample_di
+00005ff0: 7220 3a20 7374 720a 2020 2020 2020 2020  r : str.        
+00006000: 4469 7265 6374 6f72 7920 746f 2073 6176  Directory to sav
+00006010: 6520 7468 6520 7265 7361 6d70 6c65 6420  e the resampled 
+00006020: 6669 7473 2069 6d61 6765 730a 2020 2020  fits images.    
+00006030: 786d 6c5f 6f75 7470 7574 203a 2073 7472  xml_output : str
+00006040: 0a20 2020 2020 2020 204c 6f63 6174 696f  .        Locatio
+00006050: 6e20 746f 2073 6176 6520 7468 6520 7377  n to save the sw
+00006060: 6172 7020 786d 6c20 6f75 7470 7574 0a20  arp xml output. 
+00006070: 2020 2063 6f6d 6269 6e65 5f74 7970 6520     combine_type 
+00006080: 3a20 7374 720a 2020 2020 2020 2020 7377  : str.        sw
+00006090: 6172 7020 636f 6e66 6967 7572 6174 696f  arp configuratio
+000060a0: 6e20 7061 7261 6d65 7465 7220 434f 4d42  n parameter COMB
+000060b0: 494e 455f 5459 5045 0a20 2020 2077 6569  INE_TYPE.    wei
+000060c0: 6768 745f 7479 7065 203a 2073 7472 0a20  ght_type : str. 
+000060d0: 2020 2020 2020 2073 7761 7270 2063 6f6e         swarp con
+000060e0: 6669 6775 7261 7469 6f6e 2070 6172 616d  figuration param
+000060f0: 6574 6572 2057 4549 4748 545f 5459 5045  eter WEIGHT_TYPE
+00006100: 0a20 2020 2072 6566 5f69 6d61 6765 203a  .    ref_image :
+00006110: 2073 7472 0a20 2020 2020 2020 2069 6d61   str.        ima
+00006120: 6765 2074 6f20 6265 2075 7365 6420 6173  ge to be used as
+00006130: 2072 6566 6572 656e 6365 2074 6f20 7461   reference to ta
+00006140: 6b65 2063 656e 7465 7220 636f 6f72 6469  ke center coordi
+00006150: 6e61 7465 730a 0a20 2020 2052 6574 7572  nates..    Retur
+00006160: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a0a  ns.    -------..
+00006170: 2020 2020 2222 220a 2020 2020 2320 5265      """.    # Re
+00006180: 6164 2067 656e 6572 616c 2063 6f6e 6669  ad general confi
+00006190: 6775 7261 7469 6f6e 2066 696c 650a 2020  guration file.  
+000061a0: 2020 7769 7468 206f 7065 6e28 6465 6661    with open(defa
+000061b0: 756c 745f 7377 6172 7063 6f6e 6669 672c  ult_swarpconfig,
+000061c0: 2027 7227 2920 6173 2066 3a0a 2020 2020   'r') as f:.    
+000061d0: 2020 2020 7377 6172 705f 636f 6e66 6967      swarp_config
+000061e0: 203d 2066 2e72 6561 646c 696e 6573 2829   = f.readlines()
+000061f0: 0a20 2020 2020 2020 2073 7761 7270 5f63  .        swarp_c
+00006200: 6f6e 6669 6720 3d20 2222 2e6a 6f69 6e28  onfig = "".join(
+00006210: 7377 6172 705f 636f 6e66 6967 290a 0a20  swarp_config).. 
+00006220: 2020 2023 2047 6574 2063 656e 7465 720a     # Get center.
+00006230: 2020 2020 6578 7465 6e73 696f 6e20 3d20      extension = 
+00006240: 6f73 2e70 6174 682e 7370 6c69 7465 7874  os.path.splitext
+00006250: 2872 6566 5f69 6d61 6765 295b 315d 5b31  (ref_image)[1][1
+00006260: 3a5d 0a0a 2020 2020 6966 2065 7874 656e  :]..    if exten
+00006270: 7369 6f6e 203d 3d20 2766 7a27 3a0a 2020  sion == 'fz':.  
+00006280: 2020 2020 2020 6865 6164 203d 2066 6974        head = fit
+00006290: 732e 6f70 656e 2872 6566 5f69 6d61 6765  s.open(ref_image
+000062a0: 295b 315d 2e68 6561 6465 720a 2020 2020  )[1].header.    
+000062b0: 656c 6966 2065 7874 656e 7369 6f6e 203d  elif extension =
+000062c0: 3d20 2766 6974 7327 3a0a 2020 2020 2020  = 'fits':.      
+000062d0: 2020 6865 6164 203d 2066 6974 732e 6f70    head = fits.op
+000062e0: 656e 2872 6566 5f69 6d61 6765 295b 305d  en(ref_image)[0]
+000062f0: 2e68 6561 6465 720a 2020 2020 656c 7365  .header.    else
+00006300: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00006310: 5661 6c75 6545 7272 6f72 2822 496d 6167  ValueError("Imag
+00006320: 6520 6578 7465 6e73 696f 6e20 6d75 7374  e extension must
+00006330: 2062 6520 2766 6974 7327 206f 7220 2766   be 'fits' or 'f
+00006340: 7a27 2229 0a0a 2020 2020 6365 6e74 6572  z'")..    center
+00006350: 5f72 6120 3d20 666c 6f61 7428 6865 6164  _ra = float(head
+00006360: 5b27 4352 5641 4c31 275d 290a 2020 2020  ['CRVAL1']).    
+00006370: 6365 6e74 6572 5f64 6563 203d 2066 6c6f  center_dec = flo
+00006380: 6174 2868 6561 645b 2743 5256 414c 3227  at(head['CRVAL2'
+00006390: 5d29 0a0a 2020 2020 6365 6e74 6572 203d  ])..    center =
+000063a0: 2066 227b 6365 6e74 6572 5f72 617d 2c20   f"{center_ra}, 
+000063b0: 7b63 656e 7465 725f 6465 637d 220a 0a20  {center_dec}".. 
+000063c0: 2020 2023 2055 7064 6174 6520 7377 6172     # Update swar
+000063d0: 705f 636f 6e66 6967 0a20 2020 2073 7761  p_config.    swa
+000063e0: 7270 5f63 6f6e 6669 6720 3d20 7377 6172  rp_config = swar
+000063f0: 705f 636f 6e66 6967 2e66 6f72 6d61 7428  p_config.format(
+00006400: 696d 6167 655f 6f75 7420 2020 203d 2064  image_out    = d
+00006410: 6574 6563 7469 6f6e 5f69 6d61 6765 5f6f  etection_image_o
+00006420: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+00006430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006440: 2020 2020 2020 2020 2020 2077 6569 6768             weigh
+00006450: 745f 6f75 7420 2020 3d20 6465 7465 6374  t_out   = detect
+00006460: 696f 6e5f 7765 6967 6874 5f6f 7574 2c0a  ion_weight_out,.
 00006470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006480: 2020 2020 2020 2077 6569 6768 745f 6f75         weight_ou
-00006490: 7420 2020 3d20 6465 7465 6374 696f 6e5f  t   = detection_
-000064a0: 7765 6967 6874 5f6f 7574 2c0a 2020 2020  weight_out,.    
-000064b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006490: 2020 2020 2020 2072 6573 616d 706c 655f         resample_
+000064a0: 6469 7220 3d20 7265 7361 6d70 6c65 5f64  dir = resample_d
+000064b0: 6972 2c0a 2020 2020 2020 2020 2020 2020  ir,.            
 000064c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000064d0: 2020 2072 6573 616d 706c 655f 6469 7220     resample_dir 
-000064e0: 3d20 7265 7361 6d70 6c65 5f64 6972 2c0a  = resample_dir,.
-000064f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000064d0: 2020 2020 2020 2020 2020 2078 6d6c 5f6f             xml_o
+000064e0: 7574 7075 7420 2020 3d20 786d 6c5f 6f75  utput   = xml_ou
+000064f0: 7470 7574 2c0a 2020 2020 2020 2020 2020  tput,.          
 00006500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006510: 2020 2020 2020 2078 6d6c 5f6f 7574 7075         xml_outpu
-00006520: 7420 2020 3d20 786d 6c5f 6f75 7470 7574  t   = xml_output
-00006530: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006510: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+00006520: 6269 6e65 5f74 7970 6520 3d20 636f 6d62  bine_type = comb
+00006530: 696e 655f 7479 7065 2c0a 2020 2020 2020  ine_type,.      
 00006540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006550: 2020 2020 2020 2020 2063 6f6d 6269 6e65           combine
-00006560: 5f74 7970 6520 3d20 636f 6d62 696e 655f  _type = combine_
-00006570: 7479 7065 2c0a 2020 2020 2020 2020 2020  type,.          
+00006550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006560: 2077 6569 6768 745f 7479 7065 2020 3d20   weight_type  = 
+00006570: 7765 6967 6874 5f74 7970 652c 0a20 2020  weight_type,.   
 00006580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006590: 2020 2020 2020 2020 2020 2020 2077 6569               wei
-000065a0: 6768 745f 7479 7065 2020 3d20 7765 6967  ght_type  = weig
-000065b0: 6874 5f74 7970 652c 0a20 2020 2020 2020  ht_type,.       
-000065c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000065d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000065e0: 6365 6e74 6572 2020 2020 2020 203d 2063  center       = c
-000065f0: 656e 7465 7229 0a0a 2020 2020 2320 5361  enter)..    # Sa
-00006600: 7665 2063 6f6e 6669 6720 6669 6c65 0a20  ve config file. 
-00006610: 2020 2077 6974 6820 6f70 656e 2873 6176     with open(sav
-00006620: 655f 6669 6c65 2c20 2777 2729 2061 7320  e_file, 'w') as 
-00006630: 663a 0a20 2020 2020 2020 2066 2e77 7269  f:.        f.wri
-00006640: 7465 2873 7761 7270 5f63 6f6e 6669 6729  te(swarp_config)
-00006650: 0a0a 0a64 6566 2075 7064 6174 655f 6465  ...def update_de
-00006660: 7465 6374 696f 6e5f 6865 6164 6572 2864  tection_header(d
-00006670: 6574 6563 7469 6f6e 5f69 6d61 6765 2c20  etection_image, 
-00006680: 696d 6167 655f 6c69 7374 5f66 696c 6529  image_list_file)
-00006690: 3a0a 2020 2020 2222 220a 2020 2020 5570  :.    """.    Up
-000066a0: 6461 7465 7320 6465 7465 6374 696f 6e20  dates detection 
-000066b0: 696d 6167 6520 6865 6164 6572 0a0a 2020  image header..  
-000066c0: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-000066d0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-000066e0: 6465 7465 6374 696f 6e5f 696d 6167 6520  detection_image 
-000066f0: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
-00006700: 6361 7469 6f6e 206f 6620 7468 6520 6465  cation of the de
-00006710: 7465 6374 696f 6e20 696d 6167 6520 6669  tection image fi
-00006720: 6c65 0a20 2020 2069 6d61 6765 5f6c 6973  le.    image_lis
-00006730: 745f 6669 6c65 203a 2073 7472 0a20 2020  t_file : str.   
-00006740: 2020 2020 204c 6f63 6174 696f 6e20 6f66       Location of
-00006750: 2074 6865 2066 696c 6520 6c69 7374 696e   the file listin
-00006760: 6720 7468 6520 636f 6d62 696e 6564 2069  g the combined i
-00006770: 6d61 6765 730a 2020 2020 2222 220a 0a20  mages.    """.. 
-00006780: 2020 2023 2052 6561 6420 6c69 7374 206f     # Read list o
-00006790: 6620 696d 6167 6573 0a20 2020 2077 6974  f images.    wit
-000067a0: 6820 6f70 656e 2869 6d61 6765 5f6c 6973  h open(image_lis
-000067b0: 745f 6669 6c65 2c20 2772 2729 2061 7320  t_file, 'r') as 
-000067c0: 696d 5f6c 6973 743a 0a20 2020 2020 2020  im_list:.       
-000067d0: 2069 6d61 6765 5f6c 6973 7420 3d20 696d   image_list = im
-000067e0: 5f6c 6973 742e 7265 6164 6c69 6e65 7328  _list.readlines(
-000067f0: 290a 0a20 2020 2023 2052 656d 6f76 6520  )..    # Remove 
-00006800: 6c69 6e65 6272 6561 6b73 0a20 2020 2066  linebreaks.    f
-00006810: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
-00006820: 6e28 696d 6167 655f 6c69 7374 2929 3a0a  n(image_list)):.
-00006830: 2020 2020 2020 2020 696d 6167 655f 6c69          image_li
-00006840: 7374 5b69 5d20 3d20 696d 6167 655f 6c69  st[i] = image_li
-00006850: 7374 5b69 5d2e 7265 706c 6163 6528 225c  st[i].replace("\
-00006860: 6e22 2c20 2222 290a 0a20 2020 2023 204c  n", "")..    # L
-00006870: 6f61 6420 696d 6167 6573 0a20 2020 2069  oad images.    i
-00006880: 6d61 6765 7320 3d20 5b5d 0a0a 2020 2020  mages = []..    
-00006890: 666f 7220 6920 696e 2072 616e 6765 286c  for i in range(l
-000068a0: 656e 2869 6d61 6765 5f6c 6973 7429 293a  en(image_list)):
-000068b0: 0a20 2020 2020 2020 2069 6d61 6765 732e  .        images.
-000068c0: 6170 7065 6e64 2866 6974 732e 6f70 656e  append(fits.open
-000068d0: 2869 6d61 6765 5f6c 6973 745b 695d 2929  (image_list[i]))
-000068e0: 0a0a 2020 2020 2320 4c6f 6164 2064 6574  ..    # Load det
-000068f0: 6563 7469 6f6e 2069 6d61 6765 0a20 2020  ection image.   
-00006900: 2064 6574 5f69 6d61 6765 203d 2066 6974   det_image = fit
-00006910: 732e 6f70 656e 2864 6574 6563 7469 6f6e  s.open(detection
-00006920: 5f69 6d61 6765 290a 0a20 2020 2023 2055  _image)..    # U
-00006930: 7064 6174 6520 7061 7261 6d65 7465 7273  pdate parameters
-00006940: 0a20 2020 2064 6574 5f69 6d61 6765 5b30  .    det_image[0
-00006950: 5d2e 6865 6164 6572 5b27 4155 5448 4f52  ].header['AUTHOR
-00006960: 275d 203d 2027 7370 6c75 7363 616c 6962  '] = 'spluscalib
-00006970: 270a 0a20 2020 2023 2041 6464 206e 6577  '..    # Add new
-00006980: 2070 6172 616d 6574 6572 730a 2020 2020   parameters.    
-00006990: 4649 4c54 4552 2020 203d 2027 270a 2020  FILTER   = ''.  
-000069a0: 2020 4e43 4f4d 4249 4e45 203d 2030 0a20    NCOMBINE = 0. 
-000069b0: 2020 2054 4558 504f 5345 4420 3d20 302e     TEXPOSED = 0.
-000069c0: 0a20 2020 2045 4645 4354 494d 4520 3d20  .    EFECTIME = 
-000069d0: 302e 0a0a 2020 2020 666f 7220 6920 696e  0...    for i in
-000069e0: 2072 616e 6765 286c 656e 2869 6d61 6765   range(len(image
-000069f0: 5f6c 6973 7429 293a 0a20 2020 2020 2020  _list)):.       
-00006a00: 2066 696c 7465 725f 6920 3d20 696d 6167   filter_i = imag
-00006a10: 6573 5b69 5d5b 305d 2e68 6561 6465 725b  es[i][0].header[
-00006a20: 2746 494c 5445 5227 5d2e 7370 6c69 7428  'FILTER'].split(
-00006a30: 225f 7377 702e 6669 7473 2229 5b30 5d0a  "_swp.fits")[0].
-00006a40: 2020 2020 2020 2020 6669 6c74 6572 5f69          filter_i
-00006a50: 203d 2066 696c 7465 725f 692e 7370 6c69   = filter_i.spli
-00006a60: 7428 225f 2229 5b2d 315d 0a0a 2020 2020  t("_")[-1]..    
-00006a70: 2020 2020 4649 4c54 4552 202b 3d20 6669      FILTER += fi
-00006a80: 6c74 6572 5f69 2b27 2c27 0a0a 2020 2020  lter_i+','..    
-00006a90: 2020 2020 4e43 4f4d 4249 4e45 202b 3d20      NCOMBINE += 
-00006aa0: 696e 7428 696d 6167 6573 5b69 5d5b 305d  int(images[i][0]
-00006ab0: 2e68 6561 6465 725b 274e 434f 4d42 494e  .header['NCOMBIN
-00006ac0: 4527 5d29 0a20 2020 2020 2020 2054 4558  E']).        TEX
-00006ad0: 504f 5345 4420 2b3d 2066 6c6f 6174 2869  POSED += float(i
-00006ae0: 6d61 6765 735b 695d 5b30 5d2e 6865 6164  mages[i][0].head
-00006af0: 6572 5b27 5445 5850 4f53 4544 275d 290a  er['TEXPOSED']).
-00006b00: 2020 2020 2020 2020 4546 4543 5449 4d45          EFECTIME
-00006b10: 202b 3d20 666c 6f61 7428 696d 6167 6573   += float(images
-00006b20: 5b69 5d5b 305d 2e68 6561 6465 725b 2745  [i][0].header['E
-00006b30: 4645 4354 494d 4527 5d29 0a0a 2020 2020  FECTIME'])..    
-00006b40: 2320 5265 6d6f 7665 206c 6173 7420 636f  # Remove last co
-00006b50: 6d6d 6120 6672 6f6d 2046 494c 5445 520a  mma from FILTER.
-00006b60: 2020 2020 4649 4c54 4552 203d 2046 494c      FILTER = FIL
-00006b70: 5445 525b 3a2d 315d 0a0a 2020 2020 2320  TER[:-1]..    # 
-00006b80: 4164 6420 746f 2074 6865 2068 6561 6465  Add to the heade
-00006b90: 720a 2020 2020 6465 745f 696d 6167 655b  r.    det_image[
-00006ba0: 305d 2e68 6561 6465 725b 2746 494c 5445  0].header['FILTE
-00006bb0: 5227 5d20 3d20 4649 4c54 4552 0a20 2020  R'] = FILTER.   
-00006bc0: 2064 6574 5f69 6d61 6765 5b30 5d2e 6865   det_image[0].he
-00006bd0: 6164 6572 5b27 4e43 4f4d 4249 4e45 275d  ader['NCOMBINE']
-00006be0: 203d 204e 434f 4d42 494e 450a 2020 2020   = NCOMBINE.    
-00006bf0: 6465 745f 696d 6167 655b 305d 2e68 6561  det_image[0].hea
-00006c00: 6465 725b 2754 4558 504f 5345 4427 5d20  der['TEXPOSED'] 
-00006c10: 3d20 5445 5850 4f53 4544 0a20 2020 2064  = TEXPOSED.    d
-00006c20: 6574 5f69 6d61 6765 5b30 5d2e 6865 6164  et_image[0].head
-00006c30: 6572 5b27 4546 4543 5449 4d45 275d 203d  er['EFECTIME'] =
-00006c40: 2045 4645 4354 494d 450a 0a20 2020 2064   EFECTIME..    d
-00006c50: 6574 5f69 6d61 6765 5b30 5d2e 6865 6164  et_image[0].head
-00006c60: 6572 5b27 4649 4c45 4e41 4d45 275d 203d  er['FILENAME'] =
-00006c70: 206f 732e 7061 7468 2e73 706c 6974 2864   os.path.split(d
-00006c80: 6574 6563 7469 6f6e 5f69 6d61 6765 295b  etection_image)[
-00006c90: 315d 0a0a 2020 2020 2320 4164 6420 696d  1]..    # Add im
-00006ca0: 6167 6520 6c69 7374 0a20 2020 2066 6f72  age list.    for
-00006cb0: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
-00006cc0: 696d 6167 655f 6c69 7374 2929 3a0a 2020  image_list)):.  
-00006cd0: 2020 2020 2020 696d 6167 655f 6920 3d20        image_i = 
-00006ce0: 6f73 2e70 6174 682e 7370 6c69 7428 696d  os.path.split(im
-00006cf0: 6167 655f 6c69 7374 5b69 5d29 5b31 5d0a  age_list[i])[1].
-00006d00: 2020 2020 2020 2020 7061 7261 6d5f 6e61          param_na
-00006d10: 6d65 203d 2066 2749 4d41 4745 7b69 3a2e  me = f'IMAGE{i:.
-00006d20: 3066 7d27 0a20 2020 2020 2020 2064 6574  0f}'.        det
-00006d30: 5f69 6d61 6765 5b30 5d2e 6865 6164 6572  _image[0].header
-00006d40: 5b70 6172 616d 5f6e 616d 655d 203d 2069  [param_name] = i
-00006d50: 6d61 6765 5f69 0a0a 2020 2020 2320 4c69  mage_i..    # Li
-00006d60: 7374 206f 6620 7061 7261 6d73 2074 6f20  st of params to 
-00006d70: 7461 6b65 2066 726f 6d20 696d 6167 6530  take from image0
-00006d80: 0a20 2020 2069 6e68 6572 6974 5f70 6172  .    inherit_par
-00006d90: 616d 7320 3d20 5b27 4849 4552 4152 4348  ams = ['HIERARCH
-00006da0: 204f 414a 2051 4320 4e43 4d4f 4445 272c   OAJ QC NCMODE',
-00006db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006dc0: 2020 2020 2020 2027 4849 4552 4152 4348         'HIERARCH
-00006dd0: 204f 414a 2051 4320 4e43 4d49 4450 5427   OAJ QC NCMIDPT'
-00006de0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00006df0: 2020 2020 2020 2020 2748 4945 5241 5243          'HIERARC
-00006e00: 4820 4f41 4a20 5143 204e 434d 4944 524d  H OAJ QC NCMIDRM
-00006e10: 5327 2c0a 2020 2020 2020 2020 2020 2020  S',.            
-00006e20: 2020 2020 2020 2020 2020 2748 4945 5241            'HIERA
-00006e30: 5243 4820 4f41 4a20 5143 204e 434e 4f49  RCH OAJ QC NCNOI
-00006e40: 5345 272c 0a20 2020 2020 2020 2020 2020  SE',.           
-00006e50: 2020 2020 2020 2020 2020 2027 4849 4552             'HIER
-00006e60: 4152 4348 204f 414a 2051 4320 4e43 4e4f  ARCH OAJ QC NCNO
-00006e70: 4952 4d53 272c 0a20 2020 2020 2020 2020  IRMS',.         
-00006e80: 2020 2020 2020 2020 2020 2020 2027 4849               'HI
-00006e90: 4552 4152 4348 204f 414a 2050 524f 2046  ERARCH OAJ PRO F
-00006ea0: 5748 4d53 4558 5427 2c0a 2020 2020 2020  WHMSEXT',.      
-00006eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ec0: 2748 4945 5241 5243 4820 4f41 4a20 5052  'HIERARCH OAJ PR
-00006ed0: 4f20 4657 484d 5352 4d53 272c 0a20 2020  O FWHMSRMS',.   
-00006ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ef0: 2020 2027 4849 4552 4152 4348 204f 414a     'HIERARCH OAJ
-00006f00: 2050 524f 2046 5748 4d4d 4541 4e27 2c0a   PRO FWHMMEAN',.
-00006f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f20: 2020 2020 2020 2748 4945 5241 5243 4820        'HIERARCH 
-00006f30: 4f41 4a20 5052 4f20 4657 484d 4245 5441  OAJ PRO FWHMBETA
-00006f40: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00006f50: 2020 2020 2020 2020 2027 4849 4552 4152           'HIERAR
-00006f60: 4348 204f 414a 2050 524f 2046 5748 4d6e  CH OAJ PRO FWHMn
-00006f70: 7374 6172 7327 2c0a 2020 2020 2020 2020  stars',.        
-00006f80: 2020 2020 2020 2020 2020 2020 2020 2748                'H
-00006f90: 4945 5241 5243 4820 4f41 4a20 5052 4f20  IERARCH OAJ PRO 
-00006fa0: 456c 6c69 706d 6561 6e27 2c0a 2020 2020  Ellipmean',.    
-00006fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006fc0: 2020 2748 4945 5241 5243 4820 4f41 4a20    'HIERARCH OAJ 
-00006fd0: 5052 4f20 5049 5056 4552 5327 2c0a 2020  PRO PIPVERS',.  
-00006fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006ff0: 2020 2020 2748 4945 5241 5243 4820 4f41      'HIERARCH OA
-00007000: 4a20 5052 4f20 5245 4649 4d41 4745 272c  J PRO REFIMAGE',
-00007010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007020: 2020 2020 2020 2027 4849 4552 4152 4348         'HIERARCH
-00007030: 204f 414a 2050 524f 2052 4546 4149 524d   OAJ PRO REFAIRM
-00007040: 4153 5327 2c0a 2020 2020 2020 2020 2020  ASS',.          
-00007050: 2020 2020 2020 2020 2020 2020 2748 4945              'HIE
-00007060: 5241 5243 4820 4f41 4a20 5052 4f20 5245  RARCH OAJ PRO RE
-00007070: 4644 4154 454f 4253 272c 0a20 2020 2020  FDATEOBS',.     
-00007080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007090: 2027 4849 4552 4152 4348 204f 414a 2050   'HIERARCH OAJ P
-000070a0: 524f 2053 5743 4d42 3127 2c0a 2020 2020  RO SWCMB1',.    
-000070b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070c0: 2020 2748 4945 5241 5243 4820 4f41 4a20    'HIERARCH OAJ 
-000070d0: 5052 4f20 5357 5343 414c 4531 272c 0a20  PRO SWSCALE1',. 
-000070e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070f0: 2020 2020 2027 4849 4552 4152 4348 204f       'HIERARCH O
-00007100: 414a 2050 524f 2053 5743 4d42 3227 2c0a  AJ PRO SWCMB2',.
-00007110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007120: 2020 2020 2020 2748 4945 5241 5243 4820        'HIERARCH 
-00007130: 4f41 4a20 5052 4f20 5357 5343 414c 4532  OAJ PRO SWSCALE2
-00007140: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00007150: 2020 2020 2020 2020 2027 4849 4552 4152           'HIERAR
-00007160: 4348 204f 414a 2050 524f 2053 5743 4d42  CH OAJ PRO SWCMB
-00007170: 3327 2c0a 2020 2020 2020 2020 2020 2020  3',.            
-00007180: 2020 2020 2020 2020 2020 2748 4945 5241            'HIERA
-00007190: 5243 4820 4f41 4a20 5052 4f20 5357 5343  RCH OAJ PRO SWSC
-000071a0: 414c 4533 275d 0a0a 2020 2020 7265 6d6f  ALE3']..    remo
-000071b0: 7665 5f70 6172 616d 7320 3d20 5b5d 0a0a  ve_params = []..
-000071c0: 2020 2020 666f 7220 7061 7261 6d20 696e      for param in
-000071d0: 2069 6e68 6572 6974 5f70 6172 616d 733a   inherit_params:
-000071e0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-000071f0: 2020 2020 2020 2020 2020 6465 745f 696d            det_im
-00007200: 6167 655b 305d 2e68 6561 6465 725b 7061  age[0].header[pa
-00007210: 7261 6d5d 203d 2069 6d61 6765 735b 305d  ram] = images[0]
-00007220: 5b30 5d2e 6865 6164 6572 5b70 6172 616d  [0].header[param
-00007230: 5d0a 2020 2020 2020 2020 6578 6365 7074  ].        except
-00007240: 204b 6579 4572 726f 723a 0a20 2020 2020   KeyError:.     
-00007250: 2020 2020 2020 2072 656d 6f76 655f 7061         remove_pa
-00007260: 7261 6d73 2e61 7070 656e 6428 7061 7261  rams.append(para
-00007270: 6d29 0a0a 2020 2020 2020 2020 2020 2020  m)..            
-00007280: 6d73 6720 3d20 2866 2249 6d61 6765 207b  msg = (f"Image {
-00007290: 696d 6167 655f 6c69 7374 5b30 5d7d 2064  image_list[0]} d
-000072a0: 6f65 7320 6e6f 7420 636f 6e74 6169 6e20  oes not contain 
-000072b0: 6865 6164 6572 2070 6172 616d 6574 6572  header parameter
-000072c0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-000072d0: 2020 2020 2020 6622 7b70 6172 616d 7d2e        f"{param}.
-000072e0: 2054 6869 7320 7061 7261 6d65 7465 7220   This parameter 
-000072f0: 7769 6c6c 206e 6f74 2062 6520 6164 6465  will not be adde
-00007300: 6420 746f 2074 6865 2022 0a20 2020 2020  d to the ".     
-00007310: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00007320: 6465 7465 6374 696f 6e20 696d 6167 6520  detection image 
-00007330: 6865 6164 6572 2e22 290a 2020 2020 2020  header.").      
-00007340: 2020 2020 2020 7761 726e 696e 6773 2e77        warnings.w
-00007350: 6172 6e28 6d73 6729 0a0a 2020 2020 666f  arn(msg)..    fo
-00007360: 7220 7061 7261 6d20 696e 2072 656d 6f76  r param in remov
-00007370: 655f 7061 7261 6d73 3a0a 2020 2020 2020  e_params:.      
-00007380: 2020 696e 6865 7269 745f 7061 7261 6d73    inherit_params
-00007390: 2e72 656d 6f76 6528 7061 7261 6d29 0a0a  .remove(param)..
-000073a0: 2020 2020 2320 4164 6469 6e67 2063 6f6d      # Adding com
-000073b0: 6d65 6e74 7320 746f 2074 6865 2068 6561  ments to the hea
-000073c0: 6465 720a 2020 2020 6465 745f 696d 6167  der.    det_imag
-000073d0: 655b 305d 2e68 6561 6465 722e 6164 645f  e[0].header.add_
-000073e0: 636f 6d6d 656e 7428 2220 5570 6461 7465  comment(" Update
-000073f0: 6420 4865 6164 6572 204b 6579 776f 7264  d Header Keyword
-00007400: 7322 2c20 6166 7465 723d 2250 5343 414c  s", after="PSCAL
-00007410: 4554 3222 290a 2020 2020 6465 745f 696d  ET2").    det_im
-00007420: 6167 655b 305d 2e68 6561 6465 722e 6164  age[0].header.ad
-00007430: 645f 636f 6d6d 656e 7428 2222 2c20 6166  d_comment("", af
-00007440: 7465 723d 2250 5343 414c 4554 3222 290a  ter="PSCALET2").
-00007450: 0a20 2020 2064 6574 5f69 6d61 6765 5b30  .    det_image[0
-00007460: 5d2e 6865 6164 6572 2e61 6464 5f63 6f6d  ].header.add_com
-00007470: 6d65 6e74 2822 204c 6973 7420 6f66 2063  ment(" List of c
-00007480: 6f6d 6269 6e65 6420 696d 6167 6573 222c  ombined images",
-00007490: 2061 6674 6572 3d22 4546 4543 5449 4d45   after="EFECTIME
-000074a0: 2229 0a20 2020 2064 6574 5f69 6d61 6765  ").    det_image
-000074b0: 5b30 5d2e 6865 6164 6572 2e61 6464 5f63  [0].header.add_c
-000074c0: 6f6d 6d65 6e74 2822 222c 2061 6674 6572  omment("", after
-000074d0: 3d22 4546 4543 5449 4d45 2229 0a0a 2020  ="EFECTIME")..  
-000074e0: 2020 6465 745f 696d 6167 655b 305d 2e68    det_image[0].h
-000074f0: 6561 6465 722e 6164 645f 636f 6d6d 656e  eader.add_commen
-00007500: 7428 2220 5061 7261 6d73 2066 726f 6d20  t(" Params from 
-00007510: 494d 4147 4530 222c 0a20 2020 2020 2020  IMAGE0",.       
-00007520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007530: 2020 2020 2020 2020 2020 2020 2061 6674               aft
-00007540: 6572 3d69 6e68 6572 6974 5f70 6172 616d  er=inherit_param
-00007550: 735b 2d31 5d29 0a20 2020 2064 6574 5f69  s[-1]).    det_i
-00007560: 6d61 6765 5b30 5d2e 6865 6164 6572 2e61  mage[0].header.a
-00007570: 6464 5f63 6f6d 6d65 6e74 2822 222c 2061  dd_comment("", a
-00007580: 6674 6572 3d69 6e68 6572 6974 5f70 6172  fter=inherit_par
-00007590: 616d 735b 2d31 5d29 0a0a 2020 2020 2320  ams[-1])..    # 
-000075a0: 5361 7665 2075 7064 6174 6564 2064 6574  Save updated det
-000075b0: 6563 7469 6f6e 2069 6d61 6765 0a20 2020  ection image.   
-000075c0: 2064 6574 5f69 6d61 6765 2e77 7269 7465   det_image.write
-000075d0: 746f 2864 6574 6563 7469 6f6e 5f69 6d61  to(detection_ima
-000075e0: 6765 2c20 6f76 6572 7772 6974 653d 5472  ge, overwrite=Tr
-000075f0: 7565 290a 0a0a 6465 6620 7570 6461 7465  ue)...def update
-00007600: 5f64 6574 6563 7469 6f6e 5f68 6561 6465  _detection_heade
-00007610: 725f 4d41 5228 6465 7465 6374 696f 6e5f  r_MAR(detection_
-00007620: 696d 6167 652c 2069 6d61 6765 5f6c 6973  image, image_lis
-00007630: 745f 6669 6c65 293a 0a20 2020 2022 2222  t_file):.    """
-00007640: 0a20 2020 2055 7064 6174 6573 2064 6574  .    Updates det
-00007650: 6563 7469 6f6e 2069 6d61 6765 2068 6561  ection image hea
-00007660: 6465 720a 0a20 2020 2050 6172 616d 6574  der..    Paramet
-00007670: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-00007680: 2d2d 0a20 2020 2064 6574 6563 7469 6f6e  --.    detection
-00007690: 5f69 6d61 6765 203a 2073 7472 0a20 2020  _image : str.   
-000076a0: 2020 2020 204c 6f63 6174 696f 6e20 6f66       Location of
-000076b0: 2074 6865 2064 6574 6563 7469 6f6e 2069   the detection i
-000076c0: 6d61 6765 2066 696c 650a 2020 2020 696d  mage file.    im
-000076d0: 6167 655f 6c69 7374 5f66 696c 6520 3a20  age_list_file : 
-000076e0: 7374 720a 2020 2020 2020 2020 4c6f 6361  str.        Loca
-000076f0: 7469 6f6e 206f 6620 7468 6520 6669 6c65  tion of the file
-00007700: 206c 6973 7469 6e67 2074 6865 2063 6f6d   listing the com
-00007710: 6269 6e65 6420 696d 6167 6573 0a20 2020  bined images.   
-00007720: 2022 2222 0a0a 2020 2020 2320 5265 6164   """..    # Read
-00007730: 206c 6973 7420 6f66 2069 6d61 6765 730a   list of images.
-00007740: 2020 2020 7769 7468 206f 7065 6e28 696d      with open(im
-00007750: 6167 655f 6c69 7374 5f66 696c 652c 2027  age_list_file, '
-00007760: 7227 2920 6173 2069 6d5f 6c69 7374 3a0a  r') as im_list:.
-00007770: 2020 2020 2020 2020 696d 6167 655f 6c69          image_li
-00007780: 7374 203d 2069 6d5f 6c69 7374 2e72 6561  st = im_list.rea
-00007790: 646c 696e 6573 2829 0a0a 2020 2020 2320  dlines()..    # 
-000077a0: 5265 6d6f 7665 206c 696e 6562 7265 616b  Remove linebreak
-000077b0: 730a 2020 2020 666f 7220 6920 696e 2072  s.    for i in r
-000077c0: 616e 6765 286c 656e 2869 6d61 6765 5f6c  ange(len(image_l
-000077d0: 6973 7429 293a 0a20 2020 2020 2020 2069  ist)):.        i
-000077e0: 6d61 6765 5f6c 6973 745b 695d 203d 2069  mage_list[i] = i
-000077f0: 6d61 6765 5f6c 6973 745b 695d 2e72 6570  mage_list[i].rep
-00007800: 6c61 6365 2822 5c6e 222c 2022 2229 0a0a  lace("\n", "")..
-00007810: 2020 2020 2320 4c6f 6164 2069 6d61 6765      # Load image
-00007820: 730a 2020 2020 696d 6167 6573 203d 205b  s.    images = [
-00007830: 5d0a 0a20 2020 2066 6f72 2069 2069 6e20  ]..    for i in 
-00007840: 7261 6e67 6528 6c65 6e28 696d 6167 655f  range(len(image_
-00007850: 6c69 7374 2929 3a0a 2020 2020 2020 2020  list)):.        
-00007860: 696d 6167 6573 2e61 7070 656e 6428 6669  images.append(fi
-00007870: 7473 2e6f 7065 6e28 696d 6167 655f 6c69  ts.open(image_li
-00007880: 7374 5b69 5d29 290a 0a20 2020 2023 204c  st[i]))..    # L
-00007890: 6f61 6420 6465 7465 6374 696f 6e20 696d  oad detection im
-000078a0: 6167 650a 2020 2020 6465 745f 696d 6167  age.    det_imag
-000078b0: 6520 3d20 6669 7473 2e6f 7065 6e28 6465  e = fits.open(de
-000078c0: 7465 6374 696f 6e5f 696d 6167 6529 0a0a  tection_image)..
-000078d0: 2020 2020 2320 5570 6461 7465 2070 6172      # Update par
-000078e0: 616d 6574 6572 730a 2020 2020 6465 745f  ameters.    det_
-000078f0: 696d 6167 655b 305d 2e68 6561 6465 725b  image[0].header[
-00007900: 2741 5554 484f 5227 5d20 3d20 2773 706c  'AUTHOR'] = 'spl
-00007910: 7573 6361 6c69 6227 0a0a 2020 2020 2320  uscalib'..    # 
-00007920: 4164 6420 6e65 7720 7061 7261 6d65 7465  Add new paramete
-00007930: 7273 0a20 2020 2046 494c 5445 5220 2020  rs.    FILTER   
-00007940: 3d20 2727 0a20 2020 204e 434f 4d42 494e  = ''.    NCOMBIN
-00007950: 4520 3d20 300a 2020 2020 4558 5054 494d  E = 0.    EXPTIM
-00007960: 4520 3d20 302e 0a0a 2020 2020 494d 5f49  E = 0...    IM_I
-00007970: 4420 3d20 300a 0a20 2020 2066 6f72 2069  D = 0..    for i
-00007980: 2069 6e20 7261 6e67 6528 6c65 6e28 696d   in range(len(im
-00007990: 6167 655f 6c69 7374 2929 3a0a 2020 2020  age_list)):.    
-000079a0: 2020 2020 6669 6c74 6572 5f69 203d 2069      filter_i = i
-000079b0: 6d61 6765 735b 695d 5b30 5d2e 6865 6164  mages[i][0].head
-000079c0: 6572 5b27 4649 4c54 4552 275d 2e73 706c  er['FILTER'].spl
-000079d0: 6974 2822 5f73 7770 2e66 6974 7322 295b  it("_swp.fits")[
-000079e0: 305d 0a20 2020 2020 2020 2066 696c 7465  0].        filte
-000079f0: 725f 6920 3d20 6669 6c74 6572 5f69 2e73  r_i = filter_i.s
-00007a00: 706c 6974 2822 5f22 295b 2d31 5d0a 0a20  plit("_")[-1].. 
-00007a10: 2020 2020 2020 2046 494c 5445 5220 2b3d         FILTER +=
-00007a20: 2066 696c 7465 725f 692b 272c 270a 0a20   filter_i+','.. 
-00007a30: 2020 2020 2020 204e 434f 4d42 494e 455f         NCOMBINE_
-00007a40: 6920 3d20 696d 6167 6573 5b69 5d5b 305d  i = images[i][0]
-00007a50: 2e68 6561 6465 725b 224e 434f 4d42 494e  .header["NCOMBIN
-00007a60: 4522 5d0a 2020 2020 2020 2020 4e43 4f4d  E"].        NCOM
-00007a70: 4249 4e45 202b 3d20 4e43 4f4d 4249 4e45  BINE += NCOMBINE
-00007a80: 5f69 0a20 2020 2020 2020 2045 5850 5449  _i.        EXPTI
-00007a90: 4d45 202b 3d20 666c 6f61 7428 696d 6167  ME += float(imag
-00007aa0: 6573 5b69 5d5b 305d 2e68 6561 6465 725b  es[i][0].header[
-00007ab0: 2745 5850 5449 4d45 275d 290a 0a20 2020  'EXPTIME'])..   
-00007ac0: 2020 2020 2066 6f72 206a 2069 6e20 7261       for j in ra
-00007ad0: 6e67 6528 4e43 4f4d 4249 4e45 5f69 293a  nge(NCOMBINE_i):
-00007ae0: 0a20 2020 2020 2020 2020 2020 2064 6574  .            det
-00007af0: 5f69 6d61 6765 5b30 5d2e 6865 6164 6572  _image[0].header
-00007b00: 5b66 2743 4f4d 425f 7b49 4d5f 4944 7d27  [f'COMB_{IM_ID}'
-00007b10: 5d20 3d20 5c0a 2020 2020 2020 2020 2020  ] = \.          
-00007b20: 2020 2020 2020 696d 6167 6573 5b69 5d5b        images[i][
-00007b30: 305d 2e68 6561 6465 725b 6622 434f 4d42  0].header[f"COMB
-00007b40: 5f7b 6a7d 225d 0a20 2020 2020 2020 2020  _{j}"].         
-00007b50: 2020 2064 6574 5f69 6d61 6765 5b30 5d2e     det_image[0].
-00007b60: 6865 6164 6572 5b66 2745 5850 5f7b 494d  header[f'EXP_{IM
-00007b70: 5f49 447d 275d 203d 205c 0a20 2020 2020  _ID}'] = \.     
-00007b80: 2020 2020 2020 2020 2020 2069 6d61 6765             image
-00007b90: 735b 695d 5b30 5d2e 6865 6164 6572 5b66  s[i][0].header[f
-00007ba0: 2245 5850 5f7b 6a7d 225d 0a20 2020 2020  "EXP_{j}"].     
-00007bb0: 2020 2020 2020 2064 6574 5f69 6d61 6765         det_image
-00007bc0: 5b30 5d2e 6865 6164 6572 5b66 2746 494c  [0].header[f'FIL
-00007bd0: 5445 525f 7b49 4d5f 4944 7d27 5d20 3d20  TER_{IM_ID}'] = 
-00007be0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-00007bf0: 2020 696d 6167 6573 5b69 5d5b 305d 2e68    images[i][0].h
-00007c00: 6561 6465 725b 6622 4649 4c54 4552 225d  eader[f"FILTER"]
-00007c10: 0a20 2020 2020 2020 2020 2020 2049 4d5f  .            IM_
-00007c20: 4944 202b 3d20 310a 0a20 2020 2023 2052  ID += 1..    # R
-00007c30: 656d 6f76 6520 6c61 7374 2063 6f6d 6d61  emove last comma
-00007c40: 2066 726f 6d20 4649 4c54 4552 0a20 2020   from FILTER.   
-00007c50: 2046 494c 5445 5220 3d20 4649 4c54 4552   FILTER = FILTER
-00007c60: 5b3a 2d31 5d0a 0a20 2020 2023 2041 6464  [:-1]..    # Add
-00007c70: 2074 6f20 7468 6520 6865 6164 6572 0a20   to the header. 
-00007c80: 2020 2064 6574 5f69 6d61 6765 5b30 5d2e     det_image[0].
-00007c90: 6865 6164 6572 5b27 4649 4c54 4552 275d  header['FILTER']
-00007ca0: 203d 2046 494c 5445 520a 2020 2020 6465   = FILTER.    de
-00007cb0: 745f 696d 6167 655b 305d 2e68 6561 6465  t_image[0].heade
-00007cc0: 725b 274e 434f 4d42 494e 4527 5d20 3d20  r['NCOMBINE'] = 
-00007cd0: 4e43 4f4d 4249 4e45 0a20 2020 2064 6574  NCOMBINE.    det
-00007ce0: 5f69 6d61 6765 5b30 5d2e 6865 6164 6572  _image[0].header
-00007cf0: 5b27 4558 5054 494d 4527 5d20 3d20 4558  ['EXPTIME'] = EX
-00007d00: 5054 494d 450a 0a20 2020 2064 6574 5f69  PTIME..    det_i
-00007d10: 6d61 6765 5b30 5d2e 6865 6164 6572 5b27  mage[0].header['
-00007d20: 4649 4c45 4e41 4d45 275d 203d 206f 732e  FILENAME'] = os.
-00007d30: 7061 7468 2e73 706c 6974 2864 6574 6563  path.split(detec
-00007d40: 7469 6f6e 5f69 6d61 6765 295b 315d 0a0a  tion_image)[1]..
-00007d50: 2020 2020 2320 4164 6420 696d 6167 6520      # Add image 
-00007d60: 6c69 7374 0a20 2020 2066 6f72 2069 2069  list.    for i i
-00007d70: 6e20 7261 6e67 6528 6c65 6e28 696d 6167  n range(len(imag
-00007d80: 655f 6c69 7374 2929 3a0a 2020 2020 2020  e_list)):.      
-00007d90: 2020 696d 6167 655f 6920 3d20 6f73 2e70    image_i = os.p
-00007da0: 6174 682e 7370 6c69 7428 696d 6167 655f  ath.split(image_
-00007db0: 6c69 7374 5b69 5d29 5b31 5d0a 2020 2020  list[i])[1].    
-00007dc0: 2020 2020 7061 7261 6d5f 6e61 6d65 203d      param_name =
-00007dd0: 2066 2749 4d41 4745 7b69 3a2e 3066 7d27   f'IMAGE{i:.0f}'
-00007de0: 0a20 2020 2020 2020 2064 6574 5f69 6d61  .        det_ima
-00007df0: 6765 5b30 5d2e 6865 6164 6572 5b70 6172  ge[0].header[par
-00007e00: 616d 5f6e 616d 655d 203d 2069 6d61 6765  am_name] = image
-00007e10: 5f69 0a0a 2020 2020 2320 4c69 7374 206f  _i..    # List o
-00007e20: 6620 7061 7261 6d73 2074 6f20 7461 6b65  f params to take
-00007e30: 2066 726f 6d20 696d 6167 6530 0a20 2020   from image0.   
-00007e40: 2069 6e68 6572 6974 5f70 6172 616d 7320   inherit_params 
-00007e50: 3d20 5b27 4849 4552 4152 4348 204d 4152  = ['HIERARCH MAR
-00007e60: 2051 4320 4e43 4d4f 4445 272c 0a20 2020   QC NCMODE',.   
-00007e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e80: 2020 2027 4849 4552 4152 4348 204d 4152     'HIERARCH MAR
-00007e90: 2051 4320 4e43 4d49 4450 5427 2c0a 2020   QC NCMIDPT',.  
-00007ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007eb0: 2020 2020 2748 4945 5241 5243 4820 4d41      'HIERARCH MA
-00007ec0: 5220 5143 204e 434d 4944 524d 5327 2c0a  R QC NCMIDRMS',.
-00007ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ee0: 2020 2020 2020 2748 4945 5241 5243 4820        'HIERARCH 
-00007ef0: 4d41 5220 5143 204e 434e 4f49 5345 272c  MAR QC NCNOISE',
-00007f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007f10: 2020 2020 2020 2027 4849 4552 4152 4348         'HIERARCH
-00007f20: 204d 4152 2051 4320 4e43 4e4f 4952 4d53   MAR QC NCNOIRMS
-00007f30: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00007f40: 2020 2020 2020 2020 2027 4849 4552 4152           'HIERAR
-00007f50: 4348 204d 4152 2050 524f 2046 5748 4d53  CH MAR PRO FWHMS
-00007f60: 4558 5427 2c0a 2020 2020 2020 2020 2020  EXT',.          
-00007f70: 2020 2020 2020 2020 2020 2020 2748 4945              'HIE
-00007f80: 5241 5243 4820 4d41 5220 5052 4f20 4657  RARCH MAR PRO FW
-00007f90: 484d 5352 4d53 272c 0a20 2020 2020 2020  HMSRMS',.       
-00007fa0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00007fb0: 4849 4552 4152 4348 204d 4152 2050 524f  HIERARCH MAR PRO
-00007fc0: 2046 5748 4d4d 4541 4e27 2c0a 2020 2020   FWHMMEAN',.    
-00007fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007fe0: 2020 2748 4945 5241 5243 4820 4d41 5220    'HIERARCH MAR 
-00007ff0: 5052 4f20 4657 484d 4245 5441 272c 0a20  PRO FWHMBETA',. 
-00008000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008010: 2020 2020 2027 4849 4552 4152 4348 204d       'HIERARCH M
-00008020: 4152 2050 524f 2046 5748 4d4e 5354 4152  AR PRO FWHMNSTAR
-00008030: 5327 2c0a 2020 2020 2020 2020 2020 2020  S',.            
-00008040: 2020 2020 2020 2020 2020 2748 4945 5241            'HIERA
-00008050: 5243 4820 4d41 5220 5052 4f20 454c 4c49  RCH MAR PRO ELLI
-00008060: 504d 4541 4e27 5d0a 0a20 2020 2072 656d  PMEAN']..    rem
-00008070: 6f76 655f 7061 7261 6d73 203d 205b 5d0a  ove_params = [].
-00008080: 0a20 2020 2066 6f72 2070 6172 616d 2069  .    for param i
-00008090: 6e20 696e 6865 7269 745f 7061 7261 6d73  n inherit_params
-000080a0: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
-000080b0: 2020 2020 2020 2020 2020 2064 6574 5f69             det_i
-000080c0: 6d61 6765 5b30 5d2e 6865 6164 6572 5b70  mage[0].header[p
-000080d0: 6172 616d 5d20 3d20 696d 6167 6573 5b30  aram] = images[0
-000080e0: 5d5b 305d 2e68 6561 6465 725b 7061 7261  ][0].header[para
-000080f0: 6d5d 0a20 2020 2020 2020 2065 7863 6570  m].        excep
-00008100: 7420 4b65 7945 7272 6f72 3a0a 2020 2020  t KeyError:.    
-00008110: 2020 2020 2020 2020 7265 6d6f 7665 5f70          remove_p
-00008120: 6172 616d 732e 6170 7065 6e64 2870 6172  arams.append(par
-00008130: 616d 290a 0a20 2020 2020 2020 2020 2020  am)..           
-00008140: 206d 7367 203d 2028 6622 496d 6167 6520   msg = (f"Image 
-00008150: 7b69 6d61 6765 5f6c 6973 745b 305d 7d20  {image_list[0]} 
-00008160: 646f 6573 206e 6f74 2063 6f6e 7461 696e  does not contain
-00008170: 2068 6561 6465 7220 7061 7261 6d65 7465   header paramete
-00008180: 7220 220a 2020 2020 2020 2020 2020 2020  r ".            
-00008190: 2020 2020 2020 2066 227b 7061 7261 6d7d         f"{param}
-000081a0: 2e20 5468 6973 2070 6172 616d 6574 6572  . This parameter
-000081b0: 2077 696c 6c20 6e6f 7420 6265 2061 6464   will not be add
-000081c0: 6564 2074 6f20 7468 6520 220a 2020 2020  ed to the ".    
-000081d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000081e0: 2264 6574 6563 7469 6f6e 2069 6d61 6765  "detection image
-000081f0: 2068 6561 6465 722e 2229 0a20 2020 2020   header.").     
-00008200: 2020 2020 2020 2077 6172 6e69 6e67 732e         warnings.
-00008210: 7761 726e 286d 7367 290a 0a20 2020 2066  warn(msg)..    f
-00008220: 6f72 2070 6172 616d 2069 6e20 7265 6d6f  or param in remo
-00008230: 7665 5f70 6172 616d 733a 0a20 2020 2020  ve_params:.     
-00008240: 2020 2069 6e68 6572 6974 5f70 6172 616d     inherit_param
-00008250: 732e 7265 6d6f 7665 2870 6172 616d 290a  s.remove(param).
-00008260: 0a20 2020 2023 2041 6464 696e 6720 636f  .    # Adding co
-00008270: 6d6d 656e 7473 2074 6f20 7468 6520 6865  mments to the he
-00008280: 6164 6572 0a20 2020 2064 6574 5f69 6d61  ader.    det_ima
-00008290: 6765 5b30 5d2e 6865 6164 6572 2e61 6464  ge[0].header.add
-000082a0: 5f63 6f6d 6d65 6e74 2822 2055 7064 6174  _comment(" Updat
-000082b0: 6564 2048 6561 6465 7220 4b65 7977 6f72  ed Header Keywor
-000082c0: 6473 222c 2061 6674 6572 3d22 5053 4341  ds", after="PSCA
-000082d0: 4c45 5432 2229 0a20 2020 2064 6574 5f69  LET2").    det_i
-000082e0: 6d61 6765 5b30 5d2e 6865 6164 6572 2e61  mage[0].header.a
-000082f0: 6464 5f63 6f6d 6d65 6e74 2822 222c 2061  dd_comment("", a
-00008300: 6674 6572 3d22 5053 4341 4c45 5432 2229  fter="PSCALET2")
-00008310: 0a0a 2020 2020 6465 745f 696d 6167 655b  ..    det_image[
-00008320: 305d 2e68 6561 6465 722e 6164 645f 636f  0].header.add_co
-00008330: 6d6d 656e 7428 2220 4c69 7374 206f 6620  mment(" List of 
-00008340: 636f 6d62 696e 6564 2069 6d61 6765 7322  combined images"
-00008350: 2c20 6166 7465 723d 2245 5850 5449 4d45  , after="EXPTIME
-00008360: 2229 0a20 2020 2064 6574 5f69 6d61 6765  ").    det_image
-00008370: 5b30 5d2e 6865 6164 6572 2e61 6464 5f63  [0].header.add_c
-00008380: 6f6d 6d65 6e74 2822 222c 2061 6674 6572  omment("", after
-00008390: 3d22 4558 5054 494d 4522 290a 0a20 2020  ="EXPTIME")..   
-000083a0: 2064 6574 5f69 6d61 6765 5b30 5d2e 6865   det_image[0].he
-000083b0: 6164 6572 2e61 6464 5f63 6f6d 6d65 6e74  ader.add_comment
-000083c0: 2822 2050 6172 616d 7320 6672 6f6d 2049  (" Params from I
-000083d0: 4d41 4745 3022 2c0a 2020 2020 2020 2020  MAGE0",.        
-000083e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000083f0: 2020 2020 2020 2020 2020 2020 6166 7465              afte
-00008400: 723d 696e 6865 7269 745f 7061 7261 6d73  r=inherit_params
-00008410: 5b2d 315d 290a 2020 2020 6465 745f 696d  [-1]).    det_im
-00008420: 6167 655b 305d 2e68 6561 6465 722e 6164  age[0].header.ad
-00008430: 645f 636f 6d6d 656e 7428 2222 2c20 6166  d_comment("", af
-00008440: 7465 723d 696e 6865 7269 745f 7061 7261  ter=inherit_para
-00008450: 6d73 5b2d 315d 290a 0a20 2020 2023 2053  ms[-1])..    # S
-00008460: 6176 6520 7570 6461 7465 6420 6465 7465  ave updated dete
-00008470: 6374 696f 6e20 696d 6167 650a 2020 2020  ction image.    
-00008480: 6465 745f 696d 6167 652e 7772 6974 6574  det_image.writet
-00008490: 6f28 6465 7465 6374 696f 6e5f 696d 6167  o(detection_imag
-000084a0: 652c 206f 7665 7277 7269 7465 3d54 7275  e, overwrite=Tru
-000084b0: 6529 0a0a 0a64 6566 2067 6574 5f73 6578  e)...def get_sex
-000084c0: 636f 6e66 5f66 7768 6d28 7365 7863 6f6e  conf_fwhm(sexcon
-000084d0: 6629 3a0a 2020 2020 2222 220a 2020 2020  f):.    """.    
-000084e0: 5265 6164 7320 6120 5345 7874 7261 6374  Reads a SExtract
-000084f0: 6f72 2063 6f6e 6669 6720 6669 6c65 2061  or config file a
-00008500: 6e64 2065 7874 7261 6374 7320 7468 6520  nd extracts the 
-00008510: 4657 484d 2076 616c 7565 0a0a 2020 2020  FWHM value..    
-00008520: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-00008530: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7365  ---------.    se
-00008540: 7863 6f6e 6620 3a20 7374 720a 2020 2020  xconf : str.    
-00008550: 2020 2020 4c6f 6361 7469 6f6e 206f 6620      Location of 
-00008560: 5345 7874 7261 6374 6f72 2063 6f6e 6669  SExtractor confi
-00008570: 6720 6669 6c65 0a0a 2020 2020 5265 7475  g file..    Retu
-00008580: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00008590: 2020 2020 666c 6f61 740a 2020 2020 2020      float.      
-000085a0: 2020 4657 484d 2075 7365 6420 696e 2053    FWHM used in S
-000085b0: 4578 7472 6163 746f 7220 636f 6e66 6967  Extractor config
-000085c0: 7572 6174 696f 6e0a 2020 2020 2222 220a  uration.    """.
-000085d0: 0a0a 2020 2020 6677 686d 203d 204e 6f6e  ..    fwhm = Non
-000085e0: 650a 0a20 2020 2077 6974 6820 6f70 656e  e..    with open
-000085f0: 2873 6578 636f 6e66 2c20 2772 2729 2061  (sexconf, 'r') a
-00008600: 7320 663a 0a20 2020 2020 2020 206c 696e  s f:.        lin
-00008610: 6573 203d 2066 2e72 6561 646c 696e 6573  es = f.readlines
-00008620: 2829 0a0a 2020 2020 2020 2020 666f 7220  ()..        for 
-00008630: 6c69 6e65 2069 6e20 6c69 6e65 733a 0a20  line in lines:. 
-00008640: 2020 2020 2020 2020 2020 206c 696e 6520             line 
-00008650: 3d20 6c69 6e65 2e73 706c 6974 2829 0a0a  = line.split()..
-00008660: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-00008670: 696e 655b 305d 203d 3d20 2753 4545 494e  ine[0] == 'SEEIN
-00008680: 475f 4657 484d 273a 0a20 2020 2020 2020  G_FWHM':.       
-00008690: 2020 2020 2020 2020 2066 7768 6d20 3d20           fwhm = 
-000086a0: 666c 6f61 7428 6c69 6e65 5b31 5d29 0a20  float(line[1]). 
-000086b0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-000086c0: 7265 616b 0a0a 2020 2020 7265 7475 726e  reak..    return
-000086d0: 2066 7768 6d0a 0a0a 6465 6620 706c 6f74   fwhm...def plot
-000086e0: 5f73 6578 5f64 6961 676e 6f73 7469 6328  _sex_diagnostic(
-000086f0: 6361 7461 6c6f 672c 2073 6176 655f 6669  catalog, save_fi
-00008700: 6c65 2c20 7332 6e63 7574 2c20 7374 6172  le, s2ncut, star
-00008710: 6375 742c 2073 6578 636f 6e66 2c20 6669  cut, sexconf, fi
-00008720: 6c74 2c0a 2020 2020 2020 2020 2020 2020  lt,.            
-00008730: 2020 2020 2020 2020 2020 2020 6d61 675f              mag_
-00008740: 6375 7420 3d20 2831 302c 2032 3529 293a  cut = (10, 25)):
-00008750: 0a20 2020 2022 2222 0a20 2020 204d 616b  .    """.    Mak
-00008760: 6573 2064 6961 676e 6f73 7469 6320 706c  es diagnostic pl
-00008770: 6f74 7320 6f66 2074 6865 2070 686f 746f  ots of the photo
-00008780: 6d65 7472 7920 696e 2061 2067 6976 656e  metry in a given
-00008790: 2053 4578 7472 6163 746f 7220 6f75 7470   SExtractor outp
-000087a0: 7574 0a0a 2020 2020 5061 7261 6d65 7465  ut..    Paramete
-000087b0: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-000087c0: 2d0a 2020 2020 6361 7461 6c6f 6720 3a20  -.    catalog : 
-000087d0: 7374 720a 2020 2020 2020 2020 4c6f 6361  str.        Loca
-000087e0: 7469 6f6e 206f 6620 5345 7874 7261 6374  tion of SExtract
-000087f0: 6f72 206f 7574 7075 7420 6361 7461 6c6f  or output catalo
-00008800: 670a 2020 2020 7361 7665 5f66 696c 6520  g.    save_file 
-00008810: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
-00008820: 6361 7469 6f6e 2074 6f20 7361 7665 2070  cation to save p
-00008830: 6c6f 7473 0a20 2020 2073 326e 6375 7420  lots.    s2ncut 
-00008840: 3a20 6c69 7374 0a20 2020 2020 2020 205b  : list.        [
-00008850: 6d69 6e2c 206d 6178 5d20 7661 6c75 6573  min, max] values
-00008860: 206f 6620 7468 6520 7332 6e20 6361 6c69   of the s2n cali
-00008870: 6272 6174 696f 6e20 6375 740a 2020 2020  bration cut.    
-00008880: 7374 6172 6375 7420 3a20 666c 6f61 740a  starcut : float.
-00008890: 2020 2020 2020 2020 6d69 6e20 7661 6c75          min valu
-000088a0: 6520 6f66 2074 6865 2063 6c61 7373 5f73  e of the class_s
-000088b0: 7461 7220 6361 6c69 6272 6174 696f 6e20  tar calibration 
-000088c0: 6375 740a 2020 2020 7365 7863 6f6e 6620  cut.    sexconf 
-000088d0: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
-000088e0: 6361 7469 6f6e 206f 6620 5345 7874 7261  cation of SExtra
-000088f0: 6374 6f72 2063 6f6e 6669 6775 7261 7469  ctor configurati
-00008900: 6f6e 2066 696c 650a 2020 2020 6669 6c74  on file.    filt
-00008910: 203a 2073 7472 0a20 2020 2020 2020 204e   : str.        N
-00008920: 616d 6520 6f66 2074 6865 2070 686f 746f  ame of the photo
-00008930: 6d65 7472 6963 2066 696c 7465 720a 0a20  metric filter.. 
-00008940: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
-00008950: 2d2d 2d2d 2d2d 0a20 2020 2053 6176 6573  ------.    Saves
-00008960: 2064 6961 676e 6f73 7469 6320 706c 6f74   diagnostic plot
-00008970: 730a 2020 2020 2222 220a 0a20 2020 2073  s.    """..    s
-00008980: 6578 6361 7420 3d20 5461 626c 652e 7265  excat = Table.re
-00008990: 6164 2863 6174 616c 6f67 290a 0a20 2020  ad(catalog)..   
-000089a0: 2073 656c 6563 742c 206d 6564 6961 6e46   select, medianF
-000089b0: 5748 4d20 3d20 7374 6172 5f73 656c 6563  WHM = star_selec
-000089c0: 746f 7228 6361 7461 6c6f 6720 2020 2020  tor(catalog     
-000089d0: 2020 3d20 7365 7863 6174 2c0a 2020 2020    = sexcat,.    
+00006590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000065a0: 2020 2020 6365 6e74 6572 2020 2020 2020      center      
+000065b0: 203d 2063 656e 7465 7229 0a0a 2020 2020   = center)..    
+000065c0: 2320 5361 7665 2063 6f6e 6669 6720 6669  # Save config fi
+000065d0: 6c65 0a20 2020 2077 6974 6820 6f70 656e  le.    with open
+000065e0: 2873 6176 655f 6669 6c65 2c20 2777 2729  (save_file, 'w')
+000065f0: 2061 7320 663a 0a20 2020 2020 2020 2066   as f:.        f
+00006600: 2e77 7269 7465 2873 7761 7270 5f63 6f6e  .write(swarp_con
+00006610: 6669 6729 0a0a 0a64 6566 2075 7064 6174  fig)...def updat
+00006620: 655f 6465 7465 6374 696f 6e5f 6865 6164  e_detection_head
+00006630: 6572 2864 6574 6563 7469 6f6e 5f69 6d61  er(detection_ima
+00006640: 6765 2c20 696d 6167 655f 6c69 7374 5f66  ge, image_list_f
+00006650: 696c 6529 3a0a 2020 2020 2222 220a 2020  ile):.    """.  
+00006660: 2020 5570 6461 7465 7320 6465 7465 6374    Updates detect
+00006670: 696f 6e20 696d 6167 6520 6865 6164 6572  ion image header
+00006680: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00006690: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+000066a0: 2020 2020 6465 7465 6374 696f 6e5f 696d      detection_im
+000066b0: 6167 6520 3a20 7374 720a 2020 2020 2020  age : str.      
+000066c0: 2020 4c6f 6361 7469 6f6e 206f 6620 7468    Location of th
+000066d0: 6520 6465 7465 6374 696f 6e20 696d 6167  e detection imag
+000066e0: 6520 6669 6c65 0a20 2020 2069 6d61 6765  e file.    image
+000066f0: 5f6c 6973 745f 6669 6c65 203a 2073 7472  _list_file : str
+00006700: 0a20 2020 2020 2020 204c 6f63 6174 696f  .        Locatio
+00006710: 6e20 6f66 2074 6865 2066 696c 6520 6c69  n of the file li
+00006720: 7374 696e 6720 7468 6520 636f 6d62 696e  sting the combin
+00006730: 6564 2069 6d61 6765 730a 2020 2020 2222  ed images.    ""
+00006740: 220a 0a20 2020 2023 2052 6561 6420 6c69  "..    # Read li
+00006750: 7374 206f 6620 696d 6167 6573 0a20 2020  st of images.   
+00006760: 2077 6974 6820 6f70 656e 2869 6d61 6765   with open(image
+00006770: 5f6c 6973 745f 6669 6c65 2c20 2772 2729  _list_file, 'r')
+00006780: 2061 7320 696d 5f6c 6973 743a 0a20 2020   as im_list:.   
+00006790: 2020 2020 2069 6d61 6765 5f6c 6973 7420       image_list 
+000067a0: 3d20 696d 5f6c 6973 742e 7265 6164 6c69  = im_list.readli
+000067b0: 6e65 7328 290a 0a20 2020 2023 2052 656d  nes()..    # Rem
+000067c0: 6f76 6520 6c69 6e65 6272 6561 6b73 0a20  ove linebreaks. 
+000067d0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+000067e0: 6528 6c65 6e28 696d 6167 655f 6c69 7374  e(len(image_list
+000067f0: 2929 3a0a 2020 2020 2020 2020 696d 6167  )):.        imag
+00006800: 655f 6c69 7374 5b69 5d20 3d20 696d 6167  e_list[i] = imag
+00006810: 655f 6c69 7374 5b69 5d2e 7265 706c 6163  e_list[i].replac
+00006820: 6528 225c 6e22 2c20 2222 290a 0a20 2020  e("\n", "")..   
+00006830: 2023 204c 6f61 6420 696d 6167 6573 0a20   # Load images. 
+00006840: 2020 2069 6d61 6765 7320 3d20 5b5d 0a0a     images = []..
+00006850: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+00006860: 6765 286c 656e 2869 6d61 6765 5f6c 6973  ge(len(image_lis
+00006870: 7429 293a 0a20 2020 2020 2020 2069 6d61  t)):.        ima
+00006880: 6765 732e 6170 7065 6e64 2866 6974 732e  ges.append(fits.
+00006890: 6f70 656e 2869 6d61 6765 5f6c 6973 745b  open(image_list[
+000068a0: 695d 2929 0a0a 2020 2020 2320 4c6f 6164  i]))..    # Load
+000068b0: 2064 6574 6563 7469 6f6e 2069 6d61 6765   detection image
+000068c0: 0a20 2020 2064 6574 5f69 6d61 6765 203d  .    det_image =
+000068d0: 2066 6974 732e 6f70 656e 2864 6574 6563   fits.open(detec
+000068e0: 7469 6f6e 5f69 6d61 6765 290a 0a20 2020  tion_image)..   
+000068f0: 2023 2055 7064 6174 6520 7061 7261 6d65   # Update parame
+00006900: 7465 7273 0a20 2020 2064 6574 5f69 6d61  ters.    det_ima
+00006910: 6765 5b30 5d2e 6865 6164 6572 5b27 4155  ge[0].header['AU
+00006920: 5448 4f52 275d 203d 2027 7370 6c75 7363  THOR'] = 'splusc
+00006930: 616c 6962 270a 0a20 2020 2023 2041 6464  alib'..    # Add
+00006940: 206e 6577 2070 6172 616d 6574 6572 730a   new parameters.
+00006950: 2020 2020 4649 4c54 4552 2020 203d 2027      FILTER   = '
+00006960: 270a 2020 2020 4e43 4f4d 4249 4e45 203d  '.    NCOMBINE =
+00006970: 2030 0a20 2020 2054 4558 504f 5345 4420   0.    TEXPOSED 
+00006980: 3d20 302e 0a20 2020 2045 4645 4354 494d  = 0..    EFECTIM
+00006990: 4520 3d20 302e 0a0a 2020 2020 666f 7220  E = 0...    for 
+000069a0: 6920 696e 2072 616e 6765 286c 656e 2869  i in range(len(i
+000069b0: 6d61 6765 5f6c 6973 7429 293a 0a20 2020  mage_list)):.   
+000069c0: 2020 2020 2066 696c 7465 725f 6920 3d20       filter_i = 
+000069d0: 696d 6167 6573 5b69 5d5b 305d 2e68 6561  images[i][0].hea
+000069e0: 6465 725b 2746 494c 5445 5227 5d2e 7370  der['FILTER'].sp
+000069f0: 6c69 7428 225f 7377 702e 6669 7473 2229  lit("_swp.fits")
+00006a00: 5b30 5d0a 2020 2020 2020 2020 6669 6c74  [0].        filt
+00006a10: 6572 5f69 203d 2066 696c 7465 725f 692e  er_i = filter_i.
+00006a20: 7370 6c69 7428 225f 2229 5b2d 315d 0a0a  split("_")[-1]..
+00006a30: 2020 2020 2020 2020 4649 4c54 4552 202b          FILTER +
+00006a40: 3d20 6669 6c74 6572 5f69 2b27 2c27 0a0a  = filter_i+','..
+00006a50: 2020 2020 2020 2020 4e43 4f4d 4249 4e45          NCOMBINE
+00006a60: 202b 3d20 696e 7428 696d 6167 6573 5b69   += int(images[i
+00006a70: 5d5b 305d 2e68 6561 6465 725b 274e 434f  ][0].header['NCO
+00006a80: 4d42 494e 4527 5d29 0a20 2020 2020 2020  MBINE']).       
+00006a90: 2054 4558 504f 5345 4420 2b3d 2066 6c6f   TEXPOSED += flo
+00006aa0: 6174 2869 6d61 6765 735b 695d 5b30 5d2e  at(images[i][0].
+00006ab0: 6865 6164 6572 5b27 5445 5850 4f53 4544  header['TEXPOSED
+00006ac0: 275d 290a 2020 2020 2020 2020 4546 4543  ']).        EFEC
+00006ad0: 5449 4d45 202b 3d20 666c 6f61 7428 696d  TIME += float(im
+00006ae0: 6167 6573 5b69 5d5b 305d 2e68 6561 6465  ages[i][0].heade
+00006af0: 725b 2745 4645 4354 494d 4527 5d29 0a0a  r['EFECTIME'])..
+00006b00: 2020 2020 2320 5265 6d6f 7665 206c 6173      # Remove las
+00006b10: 7420 636f 6d6d 6120 6672 6f6d 2046 494c  t comma from FIL
+00006b20: 5445 520a 2020 2020 4649 4c54 4552 203d  TER.    FILTER =
+00006b30: 2046 494c 5445 525b 3a2d 315d 0a0a 2020   FILTER[:-1]..  
+00006b40: 2020 2320 4164 6420 746f 2074 6865 2068    # Add to the h
+00006b50: 6561 6465 720a 2020 2020 6465 745f 696d  eader.    det_im
+00006b60: 6167 655b 305d 2e68 6561 6465 725b 2746  age[0].header['F
+00006b70: 494c 5445 5227 5d20 3d20 4649 4c54 4552  ILTER'] = FILTER
+00006b80: 0a20 2020 2064 6574 5f69 6d61 6765 5b30  .    det_image[0
+00006b90: 5d2e 6865 6164 6572 5b27 4e43 4f4d 4249  ].header['NCOMBI
+00006ba0: 4e45 275d 203d 204e 434f 4d42 494e 450a  NE'] = NCOMBINE.
+00006bb0: 2020 2020 6465 745f 696d 6167 655b 305d      det_image[0]
+00006bc0: 2e68 6561 6465 725b 2754 4558 504f 5345  .header['TEXPOSE
+00006bd0: 4427 5d20 3d20 5445 5850 4f53 4544 0a20  D'] = TEXPOSED. 
+00006be0: 2020 2064 6574 5f69 6d61 6765 5b30 5d2e     det_image[0].
+00006bf0: 6865 6164 6572 5b27 4546 4543 5449 4d45  header['EFECTIME
+00006c00: 275d 203d 2045 4645 4354 494d 450a 0a20  '] = EFECTIME.. 
+00006c10: 2020 2064 6574 5f69 6d61 6765 5b30 5d2e     det_image[0].
+00006c20: 6865 6164 6572 5b27 4649 4c45 4e41 4d45  header['FILENAME
+00006c30: 275d 203d 206f 732e 7061 7468 2e73 706c  '] = os.path.spl
+00006c40: 6974 2864 6574 6563 7469 6f6e 5f69 6d61  it(detection_ima
+00006c50: 6765 295b 315d 0a0a 2020 2020 2320 4164  ge)[1]..    # Ad
+00006c60: 6420 696d 6167 6520 6c69 7374 0a20 2020  d image list.   
+00006c70: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00006c80: 6c65 6e28 696d 6167 655f 6c69 7374 2929  len(image_list))
+00006c90: 3a0a 2020 2020 2020 2020 696d 6167 655f  :.        image_
+00006ca0: 6920 3d20 6f73 2e70 6174 682e 7370 6c69  i = os.path.spli
+00006cb0: 7428 696d 6167 655f 6c69 7374 5b69 5d29  t(image_list[i])
+00006cc0: 5b31 5d0a 2020 2020 2020 2020 7061 7261  [1].        para
+00006cd0: 6d5f 6e61 6d65 203d 2066 2749 4d41 4745  m_name = f'IMAGE
+00006ce0: 7b69 3a2e 3066 7d27 0a20 2020 2020 2020  {i:.0f}'.       
+00006cf0: 2064 6574 5f69 6d61 6765 5b30 5d2e 6865   det_image[0].he
+00006d00: 6164 6572 5b70 6172 616d 5f6e 616d 655d  ader[param_name]
+00006d10: 203d 2069 6d61 6765 5f69 0a0a 2020 2020   = image_i..    
+00006d20: 2320 4c69 7374 206f 6620 7061 7261 6d73  # List of params
+00006d30: 2074 6f20 7461 6b65 2066 726f 6d20 696d   to take from im
+00006d40: 6167 6530 0a20 2020 2069 6e68 6572 6974  age0.    inherit
+00006d50: 5f70 6172 616d 7320 3d20 5b27 4849 4552  _params = ['HIER
+00006d60: 4152 4348 204f 414a 2051 4320 4e43 4d4f  ARCH OAJ QC NCMO
+00006d70: 4445 272c 0a20 2020 2020 2020 2020 2020  DE',.           
+00006d80: 2020 2020 2020 2020 2020 2027 4849 4552             'HIER
+00006d90: 4152 4348 204f 414a 2051 4320 4e43 4d49  ARCH OAJ QC NCMI
+00006da0: 4450 5427 2c0a 2020 2020 2020 2020 2020  DPT',.          
+00006db0: 2020 2020 2020 2020 2020 2020 2748 4945              'HIE
+00006dc0: 5241 5243 4820 4f41 4a20 5143 204e 434d  RARCH OAJ QC NCM
+00006dd0: 4944 524d 5327 2c0a 2020 2020 2020 2020  IDRMS',.        
+00006de0: 2020 2020 2020 2020 2020 2020 2020 2748                'H
+00006df0: 4945 5241 5243 4820 4f41 4a20 5143 204e  IERARCH OAJ QC N
+00006e00: 434e 4f49 5345 272c 0a20 2020 2020 2020  CNOISE',.       
+00006e10: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00006e20: 4849 4552 4152 4348 204f 414a 2051 4320  HIERARCH OAJ QC 
+00006e30: 4e43 4e4f 4952 4d53 272c 0a20 2020 2020  NCNOIRMS',.     
+00006e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006e50: 2027 4849 4552 4152 4348 204f 414a 2050   'HIERARCH OAJ P
+00006e60: 524f 2046 5748 4d53 4558 5427 2c0a 2020  RO FWHMSEXT',.  
+00006e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006e80: 2020 2020 2748 4945 5241 5243 4820 4f41      'HIERARCH OA
+00006e90: 4a20 5052 4f20 4657 484d 5352 4d53 272c  J PRO FWHMSRMS',
+00006ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006eb0: 2020 2020 2020 2027 4849 4552 4152 4348         'HIERARCH
+00006ec0: 204f 414a 2050 524f 2046 5748 4d4d 4541   OAJ PRO FWHMMEA
+00006ed0: 4e27 2c0a 2020 2020 2020 2020 2020 2020  N',.            
+00006ee0: 2020 2020 2020 2020 2020 2748 4945 5241            'HIERA
+00006ef0: 5243 4820 4f41 4a20 5052 4f20 4657 484d  RCH OAJ PRO FWHM
+00006f00: 4245 5441 272c 0a20 2020 2020 2020 2020  BETA',.         
+00006f10: 2020 2020 2020 2020 2020 2020 2027 4849               'HI
+00006f20: 4552 4152 4348 204f 414a 2050 524f 2046  ERARCH OAJ PRO F
+00006f30: 5748 4d6e 7374 6172 7327 2c0a 2020 2020  WHMnstars',.    
+00006f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f50: 2020 2748 4945 5241 5243 4820 4f41 4a20    'HIERARCH OAJ 
+00006f60: 5052 4f20 456c 6c69 706d 6561 6e27 2c0a  PRO Ellipmean',.
+00006f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f80: 2020 2020 2020 2748 4945 5241 5243 4820        'HIERARCH 
+00006f90: 4f41 4a20 5052 4f20 5049 5056 4552 5327  OAJ PRO PIPVERS'
+00006fa0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006fb0: 2020 2020 2020 2020 2748 4945 5241 5243          'HIERARC
+00006fc0: 4820 4f41 4a20 5052 4f20 5245 4649 4d41  H OAJ PRO REFIMA
+00006fd0: 4745 272c 0a20 2020 2020 2020 2020 2020  GE',.           
+00006fe0: 2020 2020 2020 2020 2020 2027 4849 4552             'HIER
+00006ff0: 4152 4348 204f 414a 2050 524f 2052 4546  ARCH OAJ PRO REF
+00007000: 4149 524d 4153 5327 2c0a 2020 2020 2020  AIRMASS',.      
+00007010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007020: 2748 4945 5241 5243 4820 4f41 4a20 5052  'HIERARCH OAJ PR
+00007030: 4f20 5245 4644 4154 454f 4253 272c 0a20  O REFDATEOBS',. 
+00007040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007050: 2020 2020 2027 4849 4552 4152 4348 204f       'HIERARCH O
+00007060: 414a 2050 524f 2053 5743 4d42 3127 2c0a  AJ PRO SWCMB1',.
+00007070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007080: 2020 2020 2020 2748 4945 5241 5243 4820        'HIERARCH 
+00007090: 4f41 4a20 5052 4f20 5357 5343 414c 4531  OAJ PRO SWSCALE1
+000070a0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000070b0: 2020 2020 2020 2020 2027 4849 4552 4152           'HIERAR
+000070c0: 4348 204f 414a 2050 524f 2053 5743 4d42  CH OAJ PRO SWCMB
+000070d0: 3227 2c0a 2020 2020 2020 2020 2020 2020  2',.            
+000070e0: 2020 2020 2020 2020 2020 2748 4945 5241            'HIERA
+000070f0: 5243 4820 4f41 4a20 5052 4f20 5357 5343  RCH OAJ PRO SWSC
+00007100: 414c 4532 272c 0a20 2020 2020 2020 2020  ALE2',.         
+00007110: 2020 2020 2020 2020 2020 2020 2027 4849               'HI
+00007120: 4552 4152 4348 204f 414a 2050 524f 2053  ERARCH OAJ PRO S
+00007130: 5743 4d42 3327 2c0a 2020 2020 2020 2020  WCMB3',.        
+00007140: 2020 2020 2020 2020 2020 2020 2020 2748                'H
+00007150: 4945 5241 5243 4820 4f41 4a20 5052 4f20  IERARCH OAJ PRO 
+00007160: 5357 5343 414c 4533 275d 0a0a 2020 2020  SWSCALE3']..    
+00007170: 7265 6d6f 7665 5f70 6172 616d 7320 3d20  remove_params = 
+00007180: 5b5d 0a0a 2020 2020 666f 7220 7061 7261  []..    for para
+00007190: 6d20 696e 2069 6e68 6572 6974 5f70 6172  m in inherit_par
+000071a0: 616d 733a 0a20 2020 2020 2020 2074 7279  ams:.        try
+000071b0: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
+000071c0: 745f 696d 6167 655b 305d 2e68 6561 6465  t_image[0].heade
+000071d0: 725b 7061 7261 6d5d 203d 2069 6d61 6765  r[param] = image
+000071e0: 735b 305d 5b30 5d2e 6865 6164 6572 5b70  s[0][0].header[p
+000071f0: 6172 616d 5d0a 2020 2020 2020 2020 6578  aram].        ex
+00007200: 6365 7074 204b 6579 4572 726f 723a 0a20  cept KeyError:. 
+00007210: 2020 2020 2020 2020 2020 2072 656d 6f76             remov
+00007220: 655f 7061 7261 6d73 2e61 7070 656e 6428  e_params.append(
+00007230: 7061 7261 6d29 0a0a 2020 2020 2020 2020  param)..        
+00007240: 2020 2020 6d73 6720 3d20 2866 2249 6d61      msg = (f"Ima
+00007250: 6765 207b 696d 6167 655f 6c69 7374 5b30  ge {image_list[0
+00007260: 5d7d 2064 6f65 7320 6e6f 7420 636f 6e74  ]} does not cont
+00007270: 6169 6e20 6865 6164 6572 2070 6172 616d  ain header param
+00007280: 6574 6572 2022 0a20 2020 2020 2020 2020  eter ".         
+00007290: 2020 2020 2020 2020 2020 6622 7b70 6172            f"{par
+000072a0: 616d 7d2e 2054 6869 7320 7061 7261 6d65  am}. This parame
+000072b0: 7465 7220 7769 6c6c 206e 6f74 2062 6520  ter will not be 
+000072c0: 6164 6465 6420 746f 2074 6865 2022 0a20  added to the ". 
+000072d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000072e0: 2020 6622 6465 7465 6374 696f 6e20 696d    f"detection im
+000072f0: 6167 6520 6865 6164 6572 2e22 290a 2020  age header.").  
+00007300: 2020 2020 2020 2020 2020 7761 726e 696e            warnin
+00007310: 6773 2e77 6172 6e28 6d73 6729 0a0a 2020  gs.warn(msg)..  
+00007320: 2020 666f 7220 7061 7261 6d20 696e 2072    for param in r
+00007330: 656d 6f76 655f 7061 7261 6d73 3a0a 2020  emove_params:.  
+00007340: 2020 2020 2020 696e 6865 7269 745f 7061        inherit_pa
+00007350: 7261 6d73 2e72 656d 6f76 6528 7061 7261  rams.remove(para
+00007360: 6d29 0a0a 2020 2020 2320 4164 6469 6e67  m)..    # Adding
+00007370: 2063 6f6d 6d65 6e74 7320 746f 2074 6865   comments to the
+00007380: 2068 6561 6465 720a 2020 2020 6465 745f   header.    det_
+00007390: 696d 6167 655b 305d 2e68 6561 6465 722e  image[0].header.
+000073a0: 6164 645f 636f 6d6d 656e 7428 2220 5570  add_comment(" Up
+000073b0: 6461 7465 6420 4865 6164 6572 204b 6579  dated Header Key
+000073c0: 776f 7264 7322 2c20 6166 7465 723d 2250  words", after="P
+000073d0: 5343 414c 4554 3222 290a 2020 2020 6465  SCALET2").    de
+000073e0: 745f 696d 6167 655b 305d 2e68 6561 6465  t_image[0].heade
+000073f0: 722e 6164 645f 636f 6d6d 656e 7428 2222  r.add_comment(""
+00007400: 2c20 6166 7465 723d 2250 5343 414c 4554  , after="PSCALET
+00007410: 3222 290a 0a20 2020 2064 6574 5f69 6d61  2")..    det_ima
+00007420: 6765 5b30 5d2e 6865 6164 6572 2e61 6464  ge[0].header.add
+00007430: 5f63 6f6d 6d65 6e74 2822 204c 6973 7420  _comment(" List 
+00007440: 6f66 2063 6f6d 6269 6e65 6420 696d 6167  of combined imag
+00007450: 6573 222c 2061 6674 6572 3d22 4546 4543  es", after="EFEC
+00007460: 5449 4d45 2229 0a20 2020 2064 6574 5f69  TIME").    det_i
+00007470: 6d61 6765 5b30 5d2e 6865 6164 6572 2e61  mage[0].header.a
+00007480: 6464 5f63 6f6d 6d65 6e74 2822 222c 2061  dd_comment("", a
+00007490: 6674 6572 3d22 4546 4543 5449 4d45 2229  fter="EFECTIME")
+000074a0: 0a0a 2020 2020 6465 745f 696d 6167 655b  ..    det_image[
+000074b0: 305d 2e68 6561 6465 722e 6164 645f 636f  0].header.add_co
+000074c0: 6d6d 656e 7428 2220 5061 7261 6d73 2066  mment(" Params f
+000074d0: 726f 6d20 494d 4147 4530 222c 0a20 2020  rom IMAGE0",.   
+000074e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000074f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007500: 2061 6674 6572 3d69 6e68 6572 6974 5f70   after=inherit_p
+00007510: 6172 616d 735b 2d31 5d29 0a20 2020 2064  arams[-1]).    d
+00007520: 6574 5f69 6d61 6765 5b30 5d2e 6865 6164  et_image[0].head
+00007530: 6572 2e61 6464 5f63 6f6d 6d65 6e74 2822  er.add_comment("
+00007540: 222c 2061 6674 6572 3d69 6e68 6572 6974  ", after=inherit
+00007550: 5f70 6172 616d 735b 2d31 5d29 0a0a 2020  _params[-1])..  
+00007560: 2020 2320 5361 7665 2075 7064 6174 6564    # Save updated
+00007570: 2064 6574 6563 7469 6f6e 2069 6d61 6765   detection image
+00007580: 0a20 2020 2064 6574 5f69 6d61 6765 2e77  .    det_image.w
+00007590: 7269 7465 746f 2864 6574 6563 7469 6f6e  riteto(detection
+000075a0: 5f69 6d61 6765 2c20 6f76 6572 7772 6974  _image, overwrit
+000075b0: 653d 5472 7565 290a 0a0a 6465 6620 7570  e=True)...def up
+000075c0: 6461 7465 5f64 6574 6563 7469 6f6e 5f68  date_detection_h
+000075d0: 6561 6465 725f 4d41 5228 6465 7465 6374  eader_MAR(detect
+000075e0: 696f 6e5f 696d 6167 652c 2069 6d61 6765  ion_image, image
+000075f0: 5f6c 6973 745f 6669 6c65 293a 0a20 2020  _list_file):.   
+00007600: 2022 2222 0a20 2020 2055 7064 6174 6573   """.    Updates
+00007610: 2064 6574 6563 7469 6f6e 2069 6d61 6765   detection image
+00007620: 2068 6561 6465 720a 0a20 2020 2050 6172   header..    Par
+00007630: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+00007640: 2d2d 2d2d 2d2d 0a20 2020 2064 6574 6563  ------.    detec
+00007650: 7469 6f6e 5f69 6d61 6765 203a 2073 7472  tion_image : str
+00007660: 0a20 2020 2020 2020 204c 6f63 6174 696f  .        Locatio
+00007670: 6e20 6f66 2074 6865 2064 6574 6563 7469  n of the detecti
+00007680: 6f6e 2069 6d61 6765 2066 696c 650a 2020  on image file.  
+00007690: 2020 696d 6167 655f 6c69 7374 5f66 696c    image_list_fil
+000076a0: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
+000076b0: 4c6f 6361 7469 6f6e 206f 6620 7468 6520  Location of the 
+000076c0: 6669 6c65 206c 6973 7469 6e67 2074 6865  file listing the
+000076d0: 2063 6f6d 6269 6e65 6420 696d 6167 6573   combined images
+000076e0: 0a20 2020 2022 2222 0a0a 2020 2020 2320  .    """..    # 
+000076f0: 5265 6164 206c 6973 7420 6f66 2069 6d61  Read list of ima
+00007700: 6765 730a 2020 2020 7769 7468 206f 7065  ges.    with ope
+00007710: 6e28 696d 6167 655f 6c69 7374 5f66 696c  n(image_list_fil
+00007720: 652c 2027 7227 2920 6173 2069 6d5f 6c69  e, 'r') as im_li
+00007730: 7374 3a0a 2020 2020 2020 2020 696d 6167  st:.        imag
+00007740: 655f 6c69 7374 203d 2069 6d5f 6c69 7374  e_list = im_list
+00007750: 2e72 6561 646c 696e 6573 2829 0a0a 2020  .readlines()..  
+00007760: 2020 2320 5265 6d6f 7665 206c 696e 6562    # Remove lineb
+00007770: 7265 616b 730a 2020 2020 666f 7220 6920  reaks.    for i 
+00007780: 696e 2072 616e 6765 286c 656e 2869 6d61  in range(len(ima
+00007790: 6765 5f6c 6973 7429 293a 0a20 2020 2020  ge_list)):.     
+000077a0: 2020 2069 6d61 6765 5f6c 6973 745b 695d     image_list[i]
+000077b0: 203d 2069 6d61 6765 5f6c 6973 745b 695d   = image_list[i]
+000077c0: 2e72 6570 6c61 6365 2822 5c6e 222c 2022  .replace("\n", "
+000077d0: 2229 0a0a 2020 2020 2320 4c6f 6164 2069  ")..    # Load i
+000077e0: 6d61 6765 730a 2020 2020 696d 6167 6573  mages.    images
+000077f0: 203d 205b 5d0a 0a20 2020 2066 6f72 2069   = []..    for i
+00007800: 2069 6e20 7261 6e67 6528 6c65 6e28 696d   in range(len(im
+00007810: 6167 655f 6c69 7374 2929 3a0a 2020 2020  age_list)):.    
+00007820: 2020 2020 696d 6167 6573 2e61 7070 656e      images.appen
+00007830: 6428 6669 7473 2e6f 7065 6e28 696d 6167  d(fits.open(imag
+00007840: 655f 6c69 7374 5b69 5d29 290a 0a20 2020  e_list[i]))..   
+00007850: 2023 204c 6f61 6420 6465 7465 6374 696f   # Load detectio
+00007860: 6e20 696d 6167 650a 2020 2020 6465 745f  n image.    det_
+00007870: 696d 6167 6520 3d20 6669 7473 2e6f 7065  image = fits.ope
+00007880: 6e28 6465 7465 6374 696f 6e5f 696d 6167  n(detection_imag
+00007890: 6529 0a0a 2020 2020 2320 5570 6461 7465  e)..    # Update
+000078a0: 2070 6172 616d 6574 6572 730a 2020 2020   parameters.    
+000078b0: 6465 745f 696d 6167 655b 305d 2e68 6561  det_image[0].hea
+000078c0: 6465 725b 2741 5554 484f 5227 5d20 3d20  der['AUTHOR'] = 
+000078d0: 2773 706c 7573 6361 6c69 6227 0a0a 2020  'spluscalib'..  
+000078e0: 2020 2320 4164 6420 6e65 7720 7061 7261    # Add new para
+000078f0: 6d65 7465 7273 0a20 2020 2046 494c 5445  meters.    FILTE
+00007900: 5220 2020 3d20 2727 0a20 2020 204e 434f  R   = ''.    NCO
+00007910: 4d42 494e 4520 3d20 300a 2020 2020 4558  MBINE = 0.    EX
+00007920: 5054 494d 4520 3d20 302e 0a0a 2020 2020  PTIME = 0...    
+00007930: 494d 5f49 4420 3d20 300a 0a20 2020 2066  IM_ID = 0..    f
+00007940: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
+00007950: 6e28 696d 6167 655f 6c69 7374 2929 3a0a  n(image_list)):.
+00007960: 2020 2020 2020 2020 6669 6c74 6572 5f69          filter_i
+00007970: 203d 2069 6d61 6765 735b 695d 5b30 5d2e   = images[i][0].
+00007980: 6865 6164 6572 5b27 4649 4c54 4552 275d  header['FILTER']
+00007990: 2e73 706c 6974 2822 5f73 7770 2e66 6974  .split("_swp.fit
+000079a0: 7322 295b 305d 0a20 2020 2020 2020 2066  s")[0].        f
+000079b0: 696c 7465 725f 6920 3d20 6669 6c74 6572  ilter_i = filter
+000079c0: 5f69 2e73 706c 6974 2822 5f22 295b 2d31  _i.split("_")[-1
+000079d0: 5d0a 0a20 2020 2020 2020 2046 494c 5445  ]..        FILTE
+000079e0: 5220 2b3d 2066 696c 7465 725f 692b 272c  R += filter_i+',
+000079f0: 270a 0a20 2020 2020 2020 204e 434f 4d42  '..        NCOMB
+00007a00: 494e 455f 6920 3d20 696d 6167 6573 5b69  INE_i = images[i
+00007a10: 5d5b 305d 2e68 6561 6465 725b 224e 434f  ][0].header["NCO
+00007a20: 4d42 494e 4522 5d0a 2020 2020 2020 2020  MBINE"].        
+00007a30: 4e43 4f4d 4249 4e45 202b 3d20 4e43 4f4d  NCOMBINE += NCOM
+00007a40: 4249 4e45 5f69 0a20 2020 2020 2020 2045  BINE_i.        E
+00007a50: 5850 5449 4d45 202b 3d20 666c 6f61 7428  XPTIME += float(
+00007a60: 696d 6167 6573 5b69 5d5b 305d 2e68 6561  images[i][0].hea
+00007a70: 6465 725b 2745 5850 5449 4d45 275d 290a  der['EXPTIME']).
+00007a80: 0a20 2020 2020 2020 2066 6f72 206a 2069  .        for j i
+00007a90: 6e20 7261 6e67 6528 4e43 4f4d 4249 4e45  n range(NCOMBINE
+00007aa0: 5f69 293a 0a20 2020 2020 2020 2020 2020  _i):.           
+00007ab0: 2064 6574 5f69 6d61 6765 5b30 5d2e 6865   det_image[0].he
+00007ac0: 6164 6572 5b66 2743 4f4d 425f 7b49 4d5f  ader[f'COMB_{IM_
+00007ad0: 4944 7d27 5d20 3d20 5c0a 2020 2020 2020  ID}'] = \.      
+00007ae0: 2020 2020 2020 2020 2020 696d 6167 6573            images
+00007af0: 5b69 5d5b 305d 2e68 6561 6465 725b 6622  [i][0].header[f"
+00007b00: 434f 4d42 5f7b 6a7d 225d 0a20 2020 2020  COMB_{j}"].     
+00007b10: 2020 2020 2020 2064 6574 5f69 6d61 6765         det_image
+00007b20: 5b30 5d2e 6865 6164 6572 5b66 2745 5850  [0].header[f'EXP
+00007b30: 5f7b 494d 5f49 447d 275d 203d 205c 0a20  _{IM_ID}'] = \. 
+00007b40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00007b50: 6d61 6765 735b 695d 5b30 5d2e 6865 6164  mages[i][0].head
+00007b60: 6572 5b66 2245 5850 5f7b 6a7d 225d 0a20  er[f"EXP_{j}"]. 
+00007b70: 2020 2020 2020 2020 2020 2064 6574 5f69             det_i
+00007b80: 6d61 6765 5b30 5d2e 6865 6164 6572 5b66  mage[0].header[f
+00007b90: 2746 494c 5445 525f 7b49 4d5f 4944 7d27  'FILTER_{IM_ID}'
+00007ba0: 5d20 3d20 5c0a 2020 2020 2020 2020 2020  ] = \.          
+00007bb0: 2020 2020 2020 696d 6167 6573 5b69 5d5b        images[i][
+00007bc0: 305d 2e68 6561 6465 725b 6622 4649 4c54  0].header[f"FILT
+00007bd0: 4552 225d 0a20 2020 2020 2020 2020 2020  ER"].           
+00007be0: 2049 4d5f 4944 202b 3d20 310a 0a20 2020   IM_ID += 1..   
+00007bf0: 2023 2052 656d 6f76 6520 6c61 7374 2063   # Remove last c
+00007c00: 6f6d 6d61 2066 726f 6d20 4649 4c54 4552  omma from FILTER
+00007c10: 0a20 2020 2046 494c 5445 5220 3d20 4649  .    FILTER = FI
+00007c20: 4c54 4552 5b3a 2d31 5d0a 0a20 2020 2023  LTER[:-1]..    #
+00007c30: 2041 6464 2074 6f20 7468 6520 6865 6164   Add to the head
+00007c40: 6572 0a20 2020 2064 6574 5f69 6d61 6765  er.    det_image
+00007c50: 5b30 5d2e 6865 6164 6572 5b27 4649 4c54  [0].header['FILT
+00007c60: 4552 275d 203d 2046 494c 5445 520a 2020  ER'] = FILTER.  
+00007c70: 2020 6465 745f 696d 6167 655b 305d 2e68    det_image[0].h
+00007c80: 6561 6465 725b 274e 434f 4d42 494e 4527  eader['NCOMBINE'
+00007c90: 5d20 3d20 4e43 4f4d 4249 4e45 0a20 2020  ] = NCOMBINE.   
+00007ca0: 2064 6574 5f69 6d61 6765 5b30 5d2e 6865   det_image[0].he
+00007cb0: 6164 6572 5b27 4558 5054 494d 4527 5d20  ader['EXPTIME'] 
+00007cc0: 3d20 4558 5054 494d 450a 0a20 2020 2064  = EXPTIME..    d
+00007cd0: 6574 5f69 6d61 6765 5b30 5d2e 6865 6164  et_image[0].head
+00007ce0: 6572 5b27 4649 4c45 4e41 4d45 275d 203d  er['FILENAME'] =
+00007cf0: 206f 732e 7061 7468 2e73 706c 6974 2864   os.path.split(d
+00007d00: 6574 6563 7469 6f6e 5f69 6d61 6765 295b  etection_image)[
+00007d10: 315d 0a0a 2020 2020 2320 4164 6420 696d  1]..    # Add im
+00007d20: 6167 6520 6c69 7374 0a20 2020 2066 6f72  age list.    for
+00007d30: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
+00007d40: 696d 6167 655f 6c69 7374 2929 3a0a 2020  image_list)):.  
+00007d50: 2020 2020 2020 696d 6167 655f 6920 3d20        image_i = 
+00007d60: 6f73 2e70 6174 682e 7370 6c69 7428 696d  os.path.split(im
+00007d70: 6167 655f 6c69 7374 5b69 5d29 5b31 5d0a  age_list[i])[1].
+00007d80: 2020 2020 2020 2020 7061 7261 6d5f 6e61          param_na
+00007d90: 6d65 203d 2066 2749 4d41 4745 7b69 3a2e  me = f'IMAGE{i:.
+00007da0: 3066 7d27 0a20 2020 2020 2020 2064 6574  0f}'.        det
+00007db0: 5f69 6d61 6765 5b30 5d2e 6865 6164 6572  _image[0].header
+00007dc0: 5b70 6172 616d 5f6e 616d 655d 203d 2069  [param_name] = i
+00007dd0: 6d61 6765 5f69 0a0a 2020 2020 2320 4c69  mage_i..    # Li
+00007de0: 7374 206f 6620 7061 7261 6d73 2074 6f20  st of params to 
+00007df0: 7461 6b65 2066 726f 6d20 696d 6167 6530  take from image0
+00007e00: 0a20 2020 2069 6e68 6572 6974 5f70 6172  .    inherit_par
+00007e10: 616d 7320 3d20 5b27 4849 4552 4152 4348  ams = ['HIERARCH
+00007e20: 204d 4152 2051 4320 4e43 4d4f 4445 272c   MAR QC NCMODE',
+00007e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007e40: 2020 2020 2020 2027 4849 4552 4152 4348         'HIERARCH
+00007e50: 204d 4152 2051 4320 4e43 4d49 4450 5427   MAR QC NCMIDPT'
+00007e60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007e70: 2020 2020 2020 2020 2748 4945 5241 5243          'HIERARC
+00007e80: 4820 4d41 5220 5143 204e 434d 4944 524d  H MAR QC NCMIDRM
+00007e90: 5327 2c0a 2020 2020 2020 2020 2020 2020  S',.            
+00007ea0: 2020 2020 2020 2020 2020 2748 4945 5241            'HIERA
+00007eb0: 5243 4820 4d41 5220 5143 204e 434e 4f49  RCH MAR QC NCNOI
+00007ec0: 5345 272c 0a20 2020 2020 2020 2020 2020  SE',.           
+00007ed0: 2020 2020 2020 2020 2020 2027 4849 4552             'HIER
+00007ee0: 4152 4348 204d 4152 2051 4320 4e43 4e4f  ARCH MAR QC NCNO
+00007ef0: 4952 4d53 272c 0a20 2020 2020 2020 2020  IRMS',.         
+00007f00: 2020 2020 2020 2020 2020 2020 2027 4849               'HI
+00007f10: 4552 4152 4348 204d 4152 2050 524f 2046  ERARCH MAR PRO F
+00007f20: 5748 4d53 4558 5427 2c0a 2020 2020 2020  WHMSEXT',.      
+00007f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f40: 2748 4945 5241 5243 4820 4d41 5220 5052  'HIERARCH MAR PR
+00007f50: 4f20 4657 484d 5352 4d53 272c 0a20 2020  O FWHMSRMS',.   
+00007f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f70: 2020 2027 4849 4552 4152 4348 204d 4152     'HIERARCH MAR
+00007f80: 2050 524f 2046 5748 4d4d 4541 4e27 2c0a   PRO FWHMMEAN',.
+00007f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007fa0: 2020 2020 2020 2748 4945 5241 5243 4820        'HIERARCH 
+00007fb0: 4d41 5220 5052 4f20 4657 484d 4245 5441  MAR PRO FWHMBETA
+00007fc0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00007fd0: 2020 2020 2020 2020 2027 4849 4552 4152           'HIERAR
+00007fe0: 4348 204d 4152 2050 524f 2046 5748 4d4e  CH MAR PRO FWHMN
+00007ff0: 5354 4152 5327 2c0a 2020 2020 2020 2020  STARS',.        
+00008000: 2020 2020 2020 2020 2020 2020 2020 2748                'H
+00008010: 4945 5241 5243 4820 4d41 5220 5052 4f20  IERARCH MAR PRO 
+00008020: 454c 4c49 504d 4541 4e27 5d0a 0a20 2020  ELLIPMEAN']..   
+00008030: 2072 656d 6f76 655f 7061 7261 6d73 203d   remove_params =
+00008040: 205b 5d0a 0a20 2020 2066 6f72 2070 6172   []..    for par
+00008050: 616d 2069 6e20 696e 6865 7269 745f 7061  am in inherit_pa
+00008060: 7261 6d73 3a0a 2020 2020 2020 2020 7472  rams:.        tr
+00008070: 793a 0a20 2020 2020 2020 2020 2020 2064  y:.            d
+00008080: 6574 5f69 6d61 6765 5b30 5d2e 6865 6164  et_image[0].head
+00008090: 6572 5b70 6172 616d 5d20 3d20 696d 6167  er[param] = imag
+000080a0: 6573 5b30 5d5b 305d 2e68 6561 6465 725b  es[0][0].header[
+000080b0: 7061 7261 6d5d 0a20 2020 2020 2020 2065  param].        e
+000080c0: 7863 6570 7420 4b65 7945 7272 6f72 3a0a  xcept KeyError:.
+000080d0: 2020 2020 2020 2020 2020 2020 7265 6d6f              remo
+000080e0: 7665 5f70 6172 616d 732e 6170 7065 6e64  ve_params.append
+000080f0: 2870 6172 616d 290a 0a20 2020 2020 2020  (param)..       
+00008100: 2020 2020 206d 7367 203d 2028 6622 496d       msg = (f"Im
+00008110: 6167 6520 7b69 6d61 6765 5f6c 6973 745b  age {image_list[
+00008120: 305d 7d20 646f 6573 206e 6f74 2063 6f6e  0]} does not con
+00008130: 7461 696e 2068 6561 6465 7220 7061 7261  tain header para
+00008140: 6d65 7465 7220 220a 2020 2020 2020 2020  meter ".        
+00008150: 2020 2020 2020 2020 2020 2066 227b 7061             f"{pa
+00008160: 7261 6d7d 2e20 5468 6973 2070 6172 616d  ram}. This param
+00008170: 6574 6572 2077 696c 6c20 6e6f 7420 6265  eter will not be
+00008180: 2061 6464 6564 2074 6f20 7468 6520 220a   added to the ".
+00008190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000081a0: 2020 2066 2264 6574 6563 7469 6f6e 2069     f"detection i
+000081b0: 6d61 6765 2068 6561 6465 722e 2229 0a20  mage header."). 
+000081c0: 2020 2020 2020 2020 2020 2077 6172 6e69             warni
+000081d0: 6e67 732e 7761 726e 286d 7367 290a 0a20  ngs.warn(msg).. 
+000081e0: 2020 2066 6f72 2070 6172 616d 2069 6e20     for param in 
+000081f0: 7265 6d6f 7665 5f70 6172 616d 733a 0a20  remove_params:. 
+00008200: 2020 2020 2020 2069 6e68 6572 6974 5f70         inherit_p
+00008210: 6172 616d 732e 7265 6d6f 7665 2870 6172  arams.remove(par
+00008220: 616d 290a 0a20 2020 2023 2041 6464 696e  am)..    # Addin
+00008230: 6720 636f 6d6d 656e 7473 2074 6f20 7468  g comments to th
+00008240: 6520 6865 6164 6572 0a20 2020 2064 6574  e header.    det
+00008250: 5f69 6d61 6765 5b30 5d2e 6865 6164 6572  _image[0].header
+00008260: 2e61 6464 5f63 6f6d 6d65 6e74 2822 2055  .add_comment(" U
+00008270: 7064 6174 6564 2048 6561 6465 7220 4b65  pdated Header Ke
+00008280: 7977 6f72 6473 222c 2061 6674 6572 3d22  ywords", after="
+00008290: 5053 4341 4c45 5432 2229 0a20 2020 2064  PSCALET2").    d
+000082a0: 6574 5f69 6d61 6765 5b30 5d2e 6865 6164  et_image[0].head
+000082b0: 6572 2e61 6464 5f63 6f6d 6d65 6e74 2822  er.add_comment("
+000082c0: 222c 2061 6674 6572 3d22 5053 4341 4c45  ", after="PSCALE
+000082d0: 5432 2229 0a0a 2020 2020 6465 745f 696d  T2")..    det_im
+000082e0: 6167 655b 305d 2e68 6561 6465 722e 6164  age[0].header.ad
+000082f0: 645f 636f 6d6d 656e 7428 2220 4c69 7374  d_comment(" List
+00008300: 206f 6620 636f 6d62 696e 6564 2069 6d61   of combined ima
+00008310: 6765 7322 2c20 6166 7465 723d 2245 5850  ges", after="EXP
+00008320: 5449 4d45 2229 0a20 2020 2064 6574 5f69  TIME").    det_i
+00008330: 6d61 6765 5b30 5d2e 6865 6164 6572 2e61  mage[0].header.a
+00008340: 6464 5f63 6f6d 6d65 6e74 2822 222c 2061  dd_comment("", a
+00008350: 6674 6572 3d22 4558 5054 494d 4522 290a  fter="EXPTIME").
+00008360: 0a20 2020 2064 6574 5f69 6d61 6765 5b30  .    det_image[0
+00008370: 5d2e 6865 6164 6572 2e61 6464 5f63 6f6d  ].header.add_com
+00008380: 6d65 6e74 2822 2050 6172 616d 7320 6672  ment(" Params fr
+00008390: 6f6d 2049 4d41 4745 3022 2c0a 2020 2020  om IMAGE0",.    
+000083a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000083b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000083c0: 6166 7465 723d 696e 6865 7269 745f 7061  after=inherit_pa
+000083d0: 7261 6d73 5b2d 315d 290a 2020 2020 6465  rams[-1]).    de
+000083e0: 745f 696d 6167 655b 305d 2e68 6561 6465  t_image[0].heade
+000083f0: 722e 6164 645f 636f 6d6d 656e 7428 2222  r.add_comment(""
+00008400: 2c20 6166 7465 723d 696e 6865 7269 745f  , after=inherit_
+00008410: 7061 7261 6d73 5b2d 315d 290a 0a20 2020  params[-1])..   
+00008420: 2023 2053 6176 6520 7570 6461 7465 6420   # Save updated 
+00008430: 6465 7465 6374 696f 6e20 696d 6167 650a  detection image.
+00008440: 2020 2020 6465 745f 696d 6167 652e 7772      det_image.wr
+00008450: 6974 6574 6f28 6465 7465 6374 696f 6e5f  iteto(detection_
+00008460: 696d 6167 652c 206f 7665 7277 7269 7465  image, overwrite
+00008470: 3d54 7275 6529 0a0a 0a64 6566 2067 6574  =True)...def get
+00008480: 5f73 6578 636f 6e66 5f66 7768 6d28 7365  _sexconf_fwhm(se
+00008490: 7863 6f6e 6629 3a0a 2020 2020 2222 220a  xconf):.    """.
+000084a0: 2020 2020 5265 6164 7320 6120 5345 7874      Reads a SExt
+000084b0: 7261 6374 6f72 2063 6f6e 6669 6720 6669  ractor config fi
+000084c0: 6c65 2061 6e64 2065 7874 7261 6374 7320  le and extracts 
+000084d0: 7468 6520 4657 484d 2076 616c 7565 0a0a  the FWHM value..
+000084e0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+000084f0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+00008500: 2020 7365 7863 6f6e 6620 3a20 7374 720a    sexconf : str.
+00008510: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
+00008520: 206f 6620 5345 7874 7261 6374 6f72 2063   of SExtractor c
+00008530: 6f6e 6669 6720 6669 6c65 0a0a 2020 2020  onfig file..    
+00008540: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+00008550: 2d2d 2d0a 2020 2020 666c 6f61 740a 2020  ---.    float.  
+00008560: 2020 2020 2020 4657 484d 2075 7365 6420        FWHM used 
+00008570: 696e 2053 4578 7472 6163 746f 7220 636f  in SExtractor co
+00008580: 6e66 6967 7572 6174 696f 6e0a 2020 2020  nfiguration.    
+00008590: 2222 220a 0a0a 2020 2020 6677 686d 203d  """...    fwhm =
+000085a0: 204e 6f6e 650a 0a20 2020 2077 6974 6820   None..    with 
+000085b0: 6f70 656e 2873 6578 636f 6e66 2c20 2772  open(sexconf, 'r
+000085c0: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
+000085d0: 206c 696e 6573 203d 2066 2e72 6561 646c   lines = f.readl
+000085e0: 696e 6573 2829 0a0a 2020 2020 2020 2020  ines()..        
+000085f0: 666f 7220 6c69 6e65 2069 6e20 6c69 6e65  for line in line
+00008600: 733a 0a20 2020 2020 2020 2020 2020 206c  s:.            l
+00008610: 696e 6520 3d20 6c69 6e65 2e73 706c 6974  ine = line.split
+00008620: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
+00008630: 6966 206c 696e 655b 305d 203d 3d20 2753  if line[0] == 'S
+00008640: 4545 494e 475f 4657 484d 273a 0a20 2020  EEING_FWHM':.   
+00008650: 2020 2020 2020 2020 2020 2020 2066 7768               fwh
+00008660: 6d20 3d20 666c 6f61 7428 6c69 6e65 5b31  m = float(line[1
+00008670: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00008680: 2020 2062 7265 616b 0a0a 2020 2020 7265     break..    re
+00008690: 7475 726e 2066 7768 6d0a 0a0a 6465 6620  turn fwhm...def 
+000086a0: 706c 6f74 5f73 6578 5f64 6961 676e 6f73  plot_sex_diagnos
+000086b0: 7469 6328 6361 7461 6c6f 672c 2073 6176  tic(catalog, sav
+000086c0: 655f 6669 6c65 2c20 7332 6e63 7574 2c20  e_file, s2ncut, 
+000086d0: 7374 6172 6375 742c 2073 6578 636f 6e66  starcut, sexconf
+000086e0: 2c20 6669 6c74 2c0a 2020 2020 2020 2020  , filt,.        
+000086f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008700: 6d61 675f 6375 7420 3d20 2831 302c 2032  mag_cut = (10, 2
+00008710: 3529 293a 0a20 2020 2022 2222 0a20 2020  5)):.    """.   
+00008720: 204d 616b 6573 2064 6961 676e 6f73 7469   Makes diagnosti
+00008730: 6320 706c 6f74 7320 6f66 2074 6865 2070  c plots of the p
+00008740: 686f 746f 6d65 7472 7920 696e 2061 2067  hotometry in a g
+00008750: 6976 656e 2053 4578 7472 6163 746f 7220  iven SExtractor 
+00008760: 6f75 7470 7574 0a0a 2020 2020 5061 7261  output..    Para
+00008770: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
+00008780: 2d2d 2d2d 2d0a 2020 2020 6361 7461 6c6f  -----.    catalo
+00008790: 6720 3a20 7374 720a 2020 2020 2020 2020  g : str.        
+000087a0: 4c6f 6361 7469 6f6e 206f 6620 5345 7874  Location of SExt
+000087b0: 7261 6374 6f72 206f 7574 7075 7420 6361  ractor output ca
+000087c0: 7461 6c6f 670a 2020 2020 7361 7665 5f66  talog.    save_f
+000087d0: 696c 6520 3a20 7374 720a 2020 2020 2020  ile : str.      
+000087e0: 2020 4c6f 6361 7469 6f6e 2074 6f20 7361    Location to sa
+000087f0: 7665 2070 6c6f 7473 0a20 2020 2073 326e  ve plots.    s2n
+00008800: 6375 7420 3a20 6c69 7374 0a20 2020 2020  cut : list.     
+00008810: 2020 205b 6d69 6e2c 206d 6178 5d20 7661     [min, max] va
+00008820: 6c75 6573 206f 6620 7468 6520 7332 6e20  lues of the s2n 
+00008830: 6361 6c69 6272 6174 696f 6e20 6375 740a  calibration cut.
+00008840: 2020 2020 7374 6172 6375 7420 3a20 666c      starcut : fl
+00008850: 6f61 740a 2020 2020 2020 2020 6d69 6e20  oat.        min 
+00008860: 7661 6c75 6520 6f66 2074 6865 2063 6c61  value of the cla
+00008870: 7373 5f73 7461 7220 6361 6c69 6272 6174  ss_star calibrat
+00008880: 696f 6e20 6375 740a 2020 2020 7365 7863  ion cut.    sexc
+00008890: 6f6e 6620 3a20 7374 720a 2020 2020 2020  onf : str.      
+000088a0: 2020 4c6f 6361 7469 6f6e 206f 6620 5345    Location of SE
+000088b0: 7874 7261 6374 6f72 2063 6f6e 6669 6775  xtractor configu
+000088c0: 7261 7469 6f6e 2066 696c 650a 2020 2020  ration file.    
+000088d0: 6669 6c74 203a 2073 7472 0a20 2020 2020  filt : str.     
+000088e0: 2020 204e 616d 6520 6f66 2074 6865 2070     Name of the p
+000088f0: 686f 746f 6d65 7472 6963 2066 696c 7465  hotometric filte
+00008900: 720a 0a20 2020 2052 6574 7572 6e73 0a20  r..    Returns. 
+00008910: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2053     -------.    S
+00008920: 6176 6573 2064 6961 676e 6f73 7469 6320  aves diagnostic 
+00008930: 706c 6f74 730a 2020 2020 2222 220a 0a20  plots.    """.. 
+00008940: 2020 2073 6578 6361 7420 3d20 5461 626c     sexcat = Tabl
+00008950: 652e 7265 6164 2863 6174 616c 6f67 290a  e.read(catalog).
+00008960: 0a20 2020 2073 656c 6563 742c 206d 6564  .    select, med
+00008970: 6961 6e46 5748 4d20 3d20 7374 6172 5f73  ianFWHM = star_s
+00008980: 656c 6563 746f 7228 6361 7461 6c6f 6720  elector(catalog 
+00008990: 2020 2020 2020 3d20 7365 7863 6174 2c0a        = sexcat,.
+000089a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000089b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000089c0: 2020 2020 2020 2073 326e 6375 7420 2020         s2ncut   
+000089d0: 2020 2020 203d 2073 326e 6375 742c 0a20       = s2ncut,. 
 000089e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000089f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a00: 2020 2073 326e 6375 7420 2020 2020 2020     s2ncut       
-00008a10: 203d 2073 326e 6375 742c 0a20 2020 2020   = s2ncut,.     
+00008a00: 2020 2020 2020 7374 6172 6375 7420 2020        starcut   
+00008a10: 2020 2020 3d20 7374 6172 6375 742c 0a20      = starcut,. 
 00008a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00008a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a40: 2020 7374 6172 6375 7420 2020 2020 2020    starcut       
-00008a50: 3d20 7374 6172 6375 742c 0a20 2020 2020  = starcut,.     
+00008a40: 2020 2020 2020 6d61 675f 7061 7274 6974        mag_partit
+00008a50: 696f 6e20 3d20 322c 0a20 2020 2020 2020  ion = 2,.       
 00008a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00008a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a80: 2020 6d61 675f 7061 7274 6974 696f 6e20    mag_partition 
-00008a90: 3d20 322c 0a20 2020 2020 2020 2020 2020  = 2,.           
-00008aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ab0: 2020 2020 2020 2020 2020 2020 7665 7262              verb
-00008ac0: 6f73 6520 2020 2020 2020 3d20 4661 6c73  ose       = Fals
-00008ad0: 6529 0a0a 2020 2020 6669 672c 2061 7873  e)..    fig, axs
-00008ae0: 203d 2070 6c74 2e73 7562 706c 6f74 7328   = plt.subplots(
-00008af0: 332c 2066 6967 7369 7a65 203d 205b 352c  3, figsize = [5,
-00008b00: 3135 5d29 0a0a 2020 2020 2323 2323 2323  15])..    ######
-00008b10: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-00008b20: 2320 506c 6f74 2063 6c61 7373 2073 7461  # Plot class sta
-00008b30: 720a 0a20 2020 2023 2050 6c6f 7420 616c  r..    # Plot al
-00008b40: 6c20 706f 696e 7473 0a20 2020 2061 7873  l points.    axs
-00008b50: 5b30 5d2e 7363 6174 7465 7228 7365 7863  [0].scatter(sexc
-00008b60: 6174 5b27 4d41 475f 4155 544f 275d 2c20  at['MAG_AUTO'], 
-00008b70: 7365 7863 6174 5b27 434c 4153 535f 5354  sexcat['CLASS_ST
-00008b80: 4152 275d 2c0a 2020 2020 2020 2020 2020  AR'],.          
-00008b90: 2020 2020 2020 2020 2063 3d22 2341 4141           c="#AAA
-00008ba0: 4141 4122 2c20 733d 3130 2c20 616c 7068  AAA", s=10, alph
-00008bb0: 613d 302e 3129 0a0a 2020 2020 2320 506c  a=0.1)..    # Pl
-00008bc0: 6f74 2073 656c 6563 7469 6f6e 0a20 2020  ot selection.   
-00008bd0: 2061 7873 5b30 5d2e 7363 6174 7465 7228   axs[0].scatter(
-00008be0: 7365 6c65 6374 5b27 4d41 475f 4155 544f  select['MAG_AUTO
-00008bf0: 275d 2c20 7365 6c65 6374 5b27 434c 4153  '], select['CLAS
-00008c00: 535f 5354 4152 275d 2c0a 2020 2020 2020  S_STAR'],.      
-00008c10: 2020 2020 2020 2020 2020 2020 2063 3d22               c="
-00008c20: 2332 3236 3646 4622 2c20 733d 3130 2c20  #2266FF", s=10, 
-00008c30: 616c 7068 613d 302e 332c 0a20 2020 2020  alpha=0.3,.     
-00008c40: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-00008c50: 6265 6c3d 6622 7332 6e63 7574 3a20 7b73  bel=f"s2ncut: {s
-00008c60: 326e 6375 747d 5c6e 2620 7374 6172 6375  2ncut}\n& starcu
-00008c70: 743a 207b 7374 6172 6375 747d 2229 0a0a  t: {starcut}")..
-00008c80: 2020 2020 2320 506c 6f74 2063 7574 206c      # Plot cut l
-00008c90: 696e 650a 2020 2020 6178 735b 305d 2e68  ine.    axs[0].h
-00008ca0: 6c69 6e65 7328 7374 6172 6375 742c 206d  lines(starcut, m
-00008cb0: 6167 5f63 7574 5b30 5d2c 206d 6167 5f63  ag_cut[0], mag_c
-00008cc0: 7574 5b31 5d2c 0a20 2020 2020 2020 2020  ut[1],.         
-00008cd0: 2020 2020 2020 2020 2063 6f6c 6f72 733d           colors=
-00008ce0: 2223 3232 3636 4646 222c 207a 6f72 6465  "#2266FF", zorde
-00008cf0: 723d 3129 0a0a 2020 2020 2320 506c 6f74  r=1)..    # Plot
-00008d00: 2067 7269 6420 6c69 6e65 730a 2020 2020   grid lines.    
-00008d10: 6178 735b 305d 2e68 6c69 6e65 7328 6e70  axs[0].hlines(np
-00008d20: 2e61 7261 6e67 6528 2d30 2e31 2c20 312e  .arange(-0.1, 1.
-00008d30: 312c 2030 2e31 292c 206d 6167 5f63 7574  1, 0.1), mag_cut
-00008d40: 5b30 5d2c 206d 6167 5f63 7574 5b31 5d2c  [0], mag_cut[1],
-00008d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008d60: 2020 2063 6f6c 6f72 733d 2223 4545 4545     colors="#EEEE
-00008d70: 4545 222c 207a 6f72 6465 723d 2d31 290a  EE", zorder=-1).
-00008d80: 0a20 2020 2061 7873 5b30 5d2e 6c65 6765  .    axs[0].lege
-00008d90: 6e64 286c 6f63 3d31 290a 2020 2020 6178  nd(loc=1).    ax
-00008da0: 735b 305d 2e73 6574 5f78 6c69 6d28 6d61  s[0].set_xlim(ma
-00008db0: 675f 6375 7429 0a20 2020 2061 7873 5b30  g_cut).    axs[0
-00008dc0: 5d2e 7365 745f 796c 696d 285b 2d30 2e31  ].set_ylim([-0.1
-00008dd0: 2c20 312e 315d 290a 2020 2020 6178 735b  , 1.1]).    axs[
-00008de0: 305d 2e73 6574 5f79 6c61 6265 6c28 2743  0].set_ylabel('C
-00008df0: 4c41 5353 5f53 5441 5227 290a 2020 2020  LASS_STAR').    
-00008e00: 6178 735b 305d 2e6d 696e 6f72 7469 636b  axs[0].minortick
-00008e10: 735f 6f6e 2829 0a0a 2020 2020 2323 2323  s_on()..    ####
-00008e20: 2323 2323 2323 0a20 2020 2023 2050 6c6f  ######.    # Plo
-00008e30: 7420 7332 6e0a 0a20 2020 2023 2050 6c6f  t s2n..    # Plo
-00008e40: 7420 616c 6c20 706f 696e 7473 0a20 2020  t all points.   
-00008e50: 2073 326e 5f63 6174 203d 2073 6578 6361   s2n_cat = sexca
-00008e60: 745b 2746 4c55 585f 4155 544f 275d 202f  t['FLUX_AUTO'] /
-00008e70: 2073 6578 6361 745b 2746 4c55 5845 5252   sexcat['FLUXERR
-00008e80: 5f41 5554 4f27 5d0a 2020 2020 6178 735b  _AUTO'].    axs[
-00008e90: 315d 2e73 6361 7474 6572 2873 6578 6361  1].scatter(sexca
-00008ea0: 745b 274d 4147 5f41 5554 4f27 5d2c 2073  t['MAG_AUTO'], s
-00008eb0: 326e 5f63 6174 2c0a 2020 2020 2020 2020  2n_cat,.        
-00008ec0: 2020 2020 2020 2020 2020 2063 3d22 2341             c="#A
-00008ed0: 4141 4141 4122 2c20 733d 3130 2c20 616c  AAAAA", s=10, al
-00008ee0: 7068 613d 302e 3129 0a0a 2020 2020 2320  pha=0.1)..    # 
-00008ef0: 506c 6f74 2073 656c 6563 7469 6f6e 0a20  Plot selection. 
-00008f00: 2020 2073 326e 5f73 656c 203d 2073 656c     s2n_sel = sel
-00008f10: 6563 745b 2746 4c55 585f 4155 544f 275d  ect['FLUX_AUTO']
-00008f20: 202f 2073 656c 6563 745b 2746 4c55 5845   / select['FLUXE
-00008f30: 5252 5f41 5554 4f27 5d0a 2020 2020 6178  RR_AUTO'].    ax
-00008f40: 735b 315d 2e73 6361 7474 6572 2873 656c  s[1].scatter(sel
-00008f50: 6563 745b 274d 4147 5f41 5554 4f27 5d2c  ect['MAG_AUTO'],
-00008f60: 2073 326e 5f73 656c 2c0a 2020 2020 2020   s2n_sel,.      
-00008f70: 2020 2020 2020 2020 2020 2020 2063 3d22               c="
-00008f80: 2332 3236 3646 4622 2c20 733d 3130 2c20  #2266FF", s=10, 
-00008f90: 616c 7068 613d 302e 3329 0a0a 2020 2020  alpha=0.3)..    
-00008fa0: 2320 506c 6f74 2063 7574 206c 696e 650a  # Plot cut line.
-00008fb0: 2020 2020 6178 735b 315d 2e68 6c69 6e65      axs[1].hline
-00008fc0: 7328 7332 6e63 7574 2c20 6d61 675f 6375  s(s2ncut, mag_cu
-00008fd0: 745b 305d 2c20 6d61 675f 6375 745b 315d  t[0], mag_cut[1]
-00008fe0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00008ff0: 2020 2020 636f 6c6f 7273 3d22 2332 3236      colors="#226
-00009000: 3646 4622 2c20 7a6f 7264 6572 3d31 290a  6FF", zorder=1).
-00009010: 0a20 2020 2023 2050 6c6f 7420 6772 6964  .    # Plot grid
-00009020: 206c 696e 6573 0a20 2020 2061 7873 5b31   lines.    axs[1
-00009030: 5d2e 686c 696e 6573 285b 302e 312c 2031  ].hlines([0.1, 1
-00009040: 2c20 3130 2c20 3130 302c 2031 3030 302c  , 10, 100, 1000,
-00009050: 2031 3030 3030 5d2c 206d 6167 5f63 7574   10000], mag_cut
-00009060: 5b30 5d2c 206d 6167 5f63 7574 5b31 5d2c  [0], mag_cut[1],
-00009070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009080: 2020 2063 6f6c 6f72 733d 2223 4545 4545     colors="#EEEE
-00009090: 4545 222c 207a 6f72 6465 723d 2d31 290a  EE", zorder=-1).
-000090a0: 0a20 2020 2061 7873 5b31 5d2e 7365 745f  .    axs[1].set_
-000090b0: 786c 696d 286d 6167 5f63 7574 290a 2020  xlim(mag_cut).  
-000090c0: 2020 6178 735b 315d 2e73 6574 5f79 7363    axs[1].set_ysc
-000090d0: 616c 6528 276c 6f67 2729 0a20 2020 2061  ale('log').    a
-000090e0: 7873 5b31 5d2e 7365 745f 796c 696d 285b  xs[1].set_ylim([
-000090f0: 302e 312c 2032 202a 2073 326e 6375 745b  0.1, 2 * s2ncut[
-00009100: 315d 5d29 0a20 2020 2061 7873 5b31 5d2e  1]]).    axs[1].
-00009110: 7365 745f 796c 6162 656c 2827 532f 4e27  set_ylabel('S/N'
-00009120: 290a 2020 2020 6178 735b 315d 2e6d 696e  ).    axs[1].min
-00009130: 6f72 7469 636b 735f 6f6e 2829 0a0a 2020  orticks_on()..  
-00009140: 2020 2323 2323 2323 2323 2323 230a 2020    ###########.  
-00009150: 2020 2320 506c 6f74 2046 5748 4d0a 0a20    # Plot FWHM.. 
-00009160: 2020 2023 2050 6c6f 7420 616c 6c20 706f     # Plot all po
-00009170: 696e 7473 0a20 2020 2061 7873 5b32 5d2e  ints.    axs[2].
-00009180: 7363 6174 7465 7228 7365 7863 6174 5b27  scatter(sexcat['
-00009190: 4d41 475f 4155 544f 275d 2c20 7365 7863  MAG_AUTO'], sexc
-000091a0: 6174 5b27 4657 484d 5f57 4f52 4c44 275d  at['FWHM_WORLD']
-000091b0: 202a 2033 3630 302c 0a20 2020 2020 2020   * 3600,.       
-000091c0: 2020 2020 2020 2020 2020 2020 633d 2223              c="#
-000091d0: 4141 4141 4141 222c 2073 3d31 302c 2061  AAAAAA", s=10, a
-000091e0: 6c70 6861 3d30 2e31 290a 0a20 2020 2023  lpha=0.1)..    #
-000091f0: 2050 6c6f 7420 7365 6c65 6374 696f 6e0a   Plot selection.
-00009200: 2020 2020 6178 735b 325d 2e73 6361 7474      axs[2].scatt
-00009210: 6572 2873 656c 6563 745b 274d 4147 5f41  er(select['MAG_A
-00009220: 5554 4f27 5d2c 2073 656c 6563 745b 2746  UTO'], select['F
-00009230: 5748 4d5f 574f 524c 4427 5d20 2a20 3336  WHM_WORLD'] * 36
-00009240: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-00009250: 2020 2020 2020 2063 3d22 2332 3236 3646         c="#2266F
-00009260: 4622 2c20 733d 3130 2c20 616c 7068 613d  F", s=10, alpha=
-00009270: 302e 332c 207a 6f72 6465 723d 3229 0a0a  0.3, zorder=2)..
-00009280: 2020 2020 2320 506c 6f74 2063 7574 206c      # Plot cut l
-00009290: 696e 650a 2020 2020 6677 686d 5f63 6f6e  ine.    fwhm_con
-000092a0: 6669 6720 3d20 6765 745f 7365 7863 6f6e  fig = get_sexcon
-000092b0: 665f 6677 686d 2873 6578 636f 6e66 3d73  f_fwhm(sexconf=s
-000092c0: 6578 636f 6e66 290a 2020 2020 6677 686d  exconf).    fwhm
-000092d0: 5f65 7374 696d 6174 6564 203d 206d 6564  _estimated = med
-000092e0: 6961 6e46 5748 4d20 2a20 3336 3030 0a0a  ianFWHM * 3600..
-000092f0: 2020 2020 6178 735b 325d 2e70 6c6f 7428      axs[2].plot(
-00009300: 5b6d 6167 5f63 7574 5b30 5d2c 206d 6167  [mag_cut[0], mag
-00009310: 5f63 7574 5b31 5d5d 2c20 5b66 7768 6d5f  _cut[1]], [fwhm_
-00009320: 636f 6e66 6967 2c20 6677 686d 5f63 6f6e  config, fwhm_con
-00009330: 6669 675d 2c0a 2020 2020 2020 2020 2020  fig],.          
-00009340: 2020 2020 2020 636f 6c6f 723d 2223 4646        color="#FF
-00009350: 3636 3232 222c 207a 6f72 6465 723d 312c  6622", zorder=1,
-00009360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009370: 206c 6162 656c 3d72 2246 5748 4d24 5f7b   label=r"FWHM$_{
-00009380: 5c6d 6174 6872 6d7b 636f 6e66 6967 7d7d  \mathrm{config}}
-00009390: 2422 202b 2066 223a 207b 6677 686d 5f63  $" + f": {fwhm_c
-000093a0: 6f6e 6669 673a 2e33 667d 2229 0a0a 2020  onfig:.3f}")..  
-000093b0: 2020 6178 735b 325d 2e70 6c6f 7428 5b6d    axs[2].plot([m
-000093c0: 6167 5f63 7574 5b30 5d2c 206d 6167 5f63  ag_cut[0], mag_c
-000093d0: 7574 5b31 5d5d 2c20 5b66 7768 6d5f 6573  ut[1]], [fwhm_es
-000093e0: 7469 6d61 7465 642c 2066 7768 6d5f 6573  timated, fwhm_es
-000093f0: 7469 6d61 7465 645d 2c0a 2020 2020 2020  timated],.      
-00009400: 2020 2020 2020 2020 2020 636f 6c6f 723d            color=
-00009410: 2223 3232 4141 3636 222c 207a 6f72 6465  "#22AA66", zorde
-00009420: 723d 312c 0a20 2020 2020 2020 2020 2020  r=1,.           
-00009430: 2020 2020 206c 6162 656c 3d72 2246 5748       label=r"FWH
-00009440: 4d24 5f7b 5c6d 6174 6872 6d7b 6573 7469  M$_{\mathrm{esti
-00009450: 6d61 7465 647d 7d24 2220 2b20 6622 3a20  mated}}$" + f": 
-00009460: 7b66 7768 6d5f 6573 7469 6d61 7465 643a  {fwhm_estimated:
-00009470: 2e33 667d 2229 0a0a 2020 2020 2320 506c  .3f}")..    # Pl
-00009480: 6f74 2067 7269 6420 6c69 6e65 730a 2020  ot grid lines.  
-00009490: 2020 6178 735b 325d 2e68 6c69 6e65 7328    axs[2].hlines(
-000094a0: 6e70 2e61 7261 6e67 6528 302c 2031 352c  np.arange(0, 15,
-000094b0: 2032 292c 206d 6167 5f63 7574 5b30 5d2c   2), mag_cut[0],
-000094c0: 206d 6167 5f63 7574 5b31 5d2c 0a20 2020   mag_cut[1],.   
-000094d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000094e0: 6f6c 6f72 733d 2223 4545 4545 4545 222c  olors="#EEEEEE",
-000094f0: 207a 6f72 6465 723d 2d31 290a 0a20 2020   zorder=-1)..   
-00009500: 2061 7873 5b32 5d2e 6c65 6765 6e64 286c   axs[2].legend(l
-00009510: 6f63 3d32 290a 2020 2020 6178 735b 325d  oc=2).    axs[2]
-00009520: 2e73 6574 5f78 6c69 6d28 6d61 675f 6375  .set_xlim(mag_cu
-00009530: 7429 0a20 2020 2061 7873 5b32 5d2e 7365  t).    axs[2].se
-00009540: 745f 796c 696d 285b 302c 2031 355d 290a  t_ylim([0, 15]).
-00009550: 2020 2020 6178 735b 325d 2e73 6574 5f79      axs[2].set_y
-00009560: 6c61 6265 6c28 2746 5748 4d20 5b61 7263  label('FWHM [arc
-00009570: 7365 635d 2729 0a20 2020 2061 7873 5b32  sec]').    axs[2
-00009580: 5d2e 6d69 6e6f 7274 6963 6b73 5f6f 6e28  ].minorticks_on(
-00009590: 290a 0a20 2020 2061 7873 5b32 5d2e 7365  )..    axs[2].se
-000095a0: 745f 786c 6162 656c 2866 227b 6669 6c74  t_xlabel(f"{filt
-000095b0: 7d5f 4155 544f 205b 696e 7374 5d22 290a  }_AUTO [inst]").
-000095c0: 0a20 2020 2070 6c74 2e73 7562 706c 6f74  .    plt.subplot
-000095d0: 735f 6164 6a75 7374 286c 6566 743d 302e  s_adjust(left=0.
-000095e0: 3134 2c20 7269 6768 743d 302e 3938 2c20  14, right=0.98, 
-000095f0: 746f 703d 302e 3938 2c20 626f 7474 6f6d  top=0.98, bottom
-00009600: 3d30 2e30 362c 2068 7370 6163 653d 302e  =0.06, hspace=0.
-00009610: 3129 0a0a 2020 2020 706c 742e 7361 7665  1)..    plt.save
-00009620: 6669 6728 7361 7665 5f66 696c 6529 0a20  fig(save_file). 
-00009630: 2020 2070 6c74 2e63 6c6f 7365 2866 6967     plt.close(fig
-00009640: 290a 0a0a 2323 2323 2323 2323 2323 2323  )...############
-00009650: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00009660: 2323 230a 2320 5053 4620 7068 6f74 6f6d  ###.# PSF photom
-00009670: 6574 7279 0a0a 0a64 6566 2067 6574 5f64  etry...def get_d
-00009680: 6f70 686f 745f 636f 6e66 6967 2869 6d61  ophot_config(ima
-00009690: 6765 5f69 6e2c 206f 626a 6563 7473 5f6f  ge_in, objects_o
-000096a0: 7574 2c20 636f 6e66 6967 5f66 696c 652c  ut, config_file,
-000096b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000096c0: 2020 2020 2020 2061 7065 7263 6f72 725f         apercorr_
-000096d0: 6d61 785f 6170 6572 7475 7265 2c20 7265  max_aperture, re
-000096e0: 6475 6374 696f 6e20 3d20 224f 414a 2229  duction = "OAJ")
-000096f0: 3a0a 2020 2020 2222 220a 2020 2020 5265  :.    """.    Re
-00009700: 7475 726e 7320 7468 6520 646f 7068 6f74  turns the dophot
-00009710: 2074 756e 6575 7020 6669 6c65 2066 6f72   tuneup file for
-00009720: 2061 2067 6976 656e 2053 2d50 4c55 5320   a given S-PLUS 
-00009730: 696d 6167 650a 0a20 2020 2050 6172 616d  image..    Param
-00009740: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
-00009750: 2d2d 2d2d 0a20 2020 2069 6d61 6765 5f69  ----.    image_i
-00009760: 6e20 3a20 7374 720a 2020 2020 2020 2020  n : str.        
-00009770: 4c6f 6361 7469 6f6e 206f 6620 532d 504c  Location of S-PL
-00009780: 5553 2069 6d61 6765 2074 6f20 7275 6e20  US image to run 
-00009790: 646f 7068 6f74 0a20 2020 206f 626a 6563  dophot.    objec
-000097a0: 7473 5f6f 7574 203a 2073 7472 0a20 2020  ts_out : str.   
-000097b0: 2020 2020 204c 6f63 6174 696f 6e20 6f66       Location of
-000097c0: 2064 6573 6972 6564 2064 6f70 686f 7420   desired dophot 
-000097d0: 6f75 7470 7574 2066 696c 650a 2020 2020  output file.    
-000097e0: 636f 6e66 6967 5f66 696c 6520 3a20 7374  config_file : st
-000097f0: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
-00009800: 6f6e 2074 6f20 7361 7665 2064 6f70 686f  on to save dopho
-00009810: 7420 7475 6e65 7570 2066 696c 6520 666f  t tuneup file fo
-00009820: 7220 7468 6973 2069 6d61 6765 0a20 2020  r this image.   
-00009830: 2061 7065 7263 6f72 725f 6d61 785f 6170   apercorr_max_ap
-00009840: 6572 7475 7265 203a 2066 6c6f 6174 0a20  erture : float. 
-00009850: 2020 2020 2020 2044 6961 6d65 7465 7220         Diameter 
-00009860: 5b70 6978 656c 735d 2063 6f6e 7369 6465  [pixels] conside
-00009870: 7265 6420 666f 7220 7468 6520 6170 6572  red for the aper
-00009880: 7475 7265 2063 6f72 7265 6374 696f 6e0a  ture correction.
-00009890: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
-000098a0: 202d 2d2d 2d2d 2d2d 0a20 2020 2073 6176   -------.    sav
-000098b0: 6573 2064 6f70 686f 7420 7475 6e65 7570  es dophot tuneup
-000098c0: 2066 696c 6520 696e 2074 6865 2070 6172   file in the par
-000098d0: 616d 3a63 6f6e 6669 675f 6669 6c65 206c  am:config_file l
-000098e0: 6f63 6174 696f 6e0a 0a20 2020 2022 2222  ocation..    """
-000098f0: 0a0a 2020 2020 2320 4c6f 6164 2053 2d50  ..    # Load S-P
-00009900: 4c55 5320 696d 6167 650a 2020 2020 6865  LUS image.    he
-00009910: 6164 203d 2066 6974 732e 6f70 656e 2869  ad = fits.open(i
-00009920: 6d61 6765 5f69 6e29 5b30 5d2e 6865 6164  mage_in)[0].head
-00009930: 6572 0a0a 2020 2020 2320 4765 7420 696d  er..    # Get im
-00009940: 6167 6520 616e 6420 6361 7461 6c6f 6720  age and catalog 
-00009950: 6e61 6d65 730a 2020 2020 696d 6167 655f  names.    image_
-00009960: 6e61 6d65 2020 203d 206f 732e 7061 7468  name   = os.path
-00009970: 2e73 706c 6974 2869 6d61 6765 5f69 6e29  .split(image_in)
-00009980: 5b31 5d0a 2020 2020 6f62 6a65 6374 735f  [1].    objects_
-00009990: 6e61 6d65 203d 206f 732e 7061 7468 2e73  name = os.path.s
-000099a0: 706c 6974 286f 626a 6563 7473 5f6f 7574  plit(objects_out
-000099b0: 295b 315d 0a0a 2020 2020 2320 4361 6c63  )[1]..    # Calc
-000099c0: 756c 6174 696e 6720 646f 7068 6f74 2070  ulating dophot p
-000099d0: 6172 616d 6574 6572 730a 2020 2020 2320  arameters.    # 
-000099e0: 5265 6665 7265 6e63 653a 204a 6176 6965  Reference: Javie
-000099f0: 7220 416c 6f6e 736f 202d 2050 7269 7661  r Alonso - Priva
-00009a00: 7465 2043 6f6d 6d75 6e69 6361 7469 6f6e  te Communication
-00009a10: 0a0a 2020 2020 6966 2072 6564 7563 7469  ..    if reducti
-00009a20: 6f6e 203d 3d20 224f 414a 223a 0a20 2020  on == "OAJ":.   
-00009a30: 2020 200a 2020 2020 2020 2020 4657 484d     .        FWHM
-00009a40: 203d 2066 6c6f 6174 2868 6561 645b 2748   = float(head['H
-00009a50: 4945 5241 5243 4820 4f41 4a20 5052 4f20  IERARCH OAJ PRO 
-00009a60: 4657 484d 4d45 414e 275d 2920 2f20 666c  FWHMMEAN']) / fl
-00009a70: 6f61 7428 6865 6164 5b27 5049 5853 4341  oat(head['PIXSCA
-00009a80: 4c45 275d 290a 2020 2020 2020 2020 534b  LE']).        SK
-00009a90: 5920 3d20 666c 6f61 7428 6865 6164 5b27  Y = float(head['
-00009aa0: 4849 4552 4152 4348 204f 414a 2051 4320  HIERARCH OAJ QC 
-00009ab0: 4e43 4d49 4450 5427 5d29 0a20 2020 200a  NCMIDPT']).    .
-00009ac0: 2020 2020 2020 2020 5445 5850 4f53 4544          TEXPOSED
-00009ad0: 203d 2066 6c6f 6174 2868 6561 645b 2754   = float(head['T
-00009ae0: 4558 504f 5345 4427 5d29 202f 2066 6c6f  EXPOSED']) / flo
-00009af0: 6174 2868 6561 645b 274e 434f 4d42 494e  at(head['NCOMBIN
-00009b00: 4527 5d29 0a0a 2020 2020 2020 2020 5349  E'])..        SI
-00009b10: 4753 4b59 203d 2066 6c6f 6174 2868 6561  GSKY = float(hea
-00009b20: 645b 2748 4945 5241 5243 4820 4f41 4a20  d['HIERARCH OAJ 
-00009b30: 5143 204e 434e 4f49 5345 275d 2920 2a20  QC NCNOISE']) * 
-00009b40: 5445 5850 4f53 4544 0a0a 2020 2020 2020  TEXPOSED..      
-00009b50: 2020 4550 4552 444e 203d 2066 6c6f 6174    EPERDN = float
-00009b60: 2868 6561 645b 2747 4149 4e27 5d29 202f  (head['GAIN']) /
-00009b70: 2054 4558 504f 5345 440a 0a20 2020 2020   TEXPOSED..     
-00009b80: 2020 2052 444e 4f49 5345 203d 2033 2e34     RDNOISE = 3.4
-00009b90: 3320 2a20 6e70 2e73 7172 7428 666c 6f61  3 * np.sqrt(floa
-00009ba0: 7428 6865 6164 5b27 4e43 4f4d 4249 4e45  t(head['NCOMBINE
-00009bb0: 275d 2929 0a0a 2020 2020 2020 2020 544f  ']))..        TO
-00009bc0: 5020 3d20 666c 6f61 7428 6865 6164 5b27  P = float(head['
-00009bd0: 5341 5455 5241 5445 275d 2920 2a20 5445  SATURATE']) * TE
-00009be0: 5850 4f53 4544 0a0a 2020 2020 656c 6966  XPOSED..    elif
-00009bf0: 2072 6564 7563 7469 6f6e 203d 3d20 224d   reduction == "M
-00009c00: 4152 223a 0a20 2020 2020 2020 200a 2020  AR":.        .  
-00009c10: 2020 2020 2020 4e43 4f4d 4249 4e45 203d        NCOMBINE =
-00009c20: 2068 6561 645b 224e 434f 4d42 494e 4522   head["NCOMBINE"
-00009c30: 5d0a 2020 2020 2020 2020 0a20 2020 2020  ].        .     
-00009c40: 2020 2046 5748 4d20 3d20 666c 6f61 7428     FWHM = float(
-00009c50: 6865 6164 5b27 4849 4552 4152 4348 204d  head['HIERARCH M
-00009c60: 4152 2050 524f 2046 5748 4d53 4558 5427  AR PRO FWHMSEXT'
-00009c70: 5d29 202f 2066 6c6f 6174 2868 6561 645b  ]) / float(head[
-00009c80: 2750 4958 5343 414c 4527 5d29 0a20 2020  'PIXSCALE']).   
-00009c90: 2020 2020 200a 2020 2020 2020 2020 534b       .        SK
-00009ca0: 5920 3d20 666c 6f61 7428 6865 6164 5b27  Y = float(head['
-00009cb0: 4849 4552 4152 4348 204d 4152 2051 4320  HIERARCH MAR QC 
-00009cc0: 4e43 4d49 4450 5427 5d29 0a0a 2020 2020  NCMIDPT'])..    
-00009cd0: 2020 2020 5445 5850 4f53 4544 203d 2066      TEXPOSED = f
-00009ce0: 6c6f 6174 2868 6561 645b 2745 5850 5449  loat(head['EXPTI
-00009cf0: 4d45 275d 2920 2f20 4e43 4f4d 4249 4e45  ME']) / NCOMBINE
-00009d00: 0a0a 2020 2020 2020 2020 5349 4753 4b59  ..        SIGSKY
-00009d10: 203d 2066 6c6f 6174 2868 6561 645b 2748   = float(head['H
-00009d20: 4945 5241 5243 4820 4d41 5220 5143 204e  IERARCH MAR QC N
-00009d30: 434e 4f49 5345 275d 2920 2a20 5445 5850  CNOISE']) * TEXP
-00009d40: 4f53 4544 0a0a 2020 2020 2020 2020 4550  OSED..        EP
-00009d50: 4552 444e 203d 2066 6c6f 6174 2868 6561  ERDN = float(hea
-00009d60: 645b 2747 4149 4e27 5d29 202f 2054 4558  d['GAIN']) / TEX
-00009d70: 504f 5345 440a 0a20 2020 2020 2020 2052  POSED..        R
-00009d80: 444e 4f49 5345 203d 2033 2e34 3320 2a20  DNOISE = 3.43 * 
-00009d90: 6e70 2e73 7172 7428 4e43 4f4d 4249 4e45  np.sqrt(NCOMBINE
-00009da0: 290a 0a20 2020 2020 2020 2054 4f50 203d  )..        TOP =
-00009db0: 2066 6c6f 6174 2868 6561 645b 2753 4154   float(head['SAT
-00009dc0: 5552 4154 4527 5d29 202a 2054 4558 504f  URATE']) * TEXPO
-00009dd0: 5345 440a 0a20 2020 200a 2020 2020 5343  SED..    .    SC
-00009de0: 414c 4541 5052 4144 4955 5320 3d20 6e70  ALEAPRADIUS = np
-00009df0: 2e61 726f 756e 6428 2861 7065 7263 6f72  .around((apercor
-00009e00: 725f 6d61 785f 6170 6572 7475 7265 2f32  r_max_aperture/2
-00009e10: 2920 2f20 4657 484d 2c33 290a 0a20 2020  ) / FWHM,3)..   
-00009e20: 2023 2047 656e 6572 6174 696e 6720 636f   # Generating co
-00009e30: 6e66 6967 2066 696c 650a 2020 2020 636f  nfig file.    co
-00009e40: 6e66 6967 203d 2028 6622 4657 484d 203d  nfig = (f"FWHM =
-00009e50: 2020 2020 207b 4657 484d 7d5c 6e22 0a20       {FWHM}\n". 
-00009e60: 2020 2020 2020 2020 2020 2020 2066 2253               f"S
-00009e70: 4b59 203d 2020 2020 2020 7b53 4b59 7d5c  KY =      {SKY}\
-00009e80: 6e22 0a20 2020 2020 2020 2020 2020 2020  n".             
-00009e90: 2066 2253 4947 534b 5920 3d20 2020 7b53   f"SIGSKY =   {S
-00009ea0: 4947 534b 597d 5c6e 220a 2020 2020 2020  IGSKY}\n".      
-00009eb0: 2020 2020 2020 2020 6622 4550 4552 444e          f"EPERDN
-00009ec0: 203d 2020 207b 4550 4552 444e 7d5c 6e22   =   {EPERDN}\n"
-00009ed0: 0a20 2020 2020 2020 2020 2020 2020 2066  .              f
-00009ee0: 2252 444e 4f49 5345 203d 2020 7b52 444e  "RDNOISE =  {RDN
-00009ef0: 4f49 5345 7d5c 6e22 0a20 2020 2020 2020  OISE}\n".       
-00009f00: 2020 2020 2020 2066 2254 4f50 203d 2020         f"TOP =  
-00009f10: 2020 2020 7b54 4f50 7d5c 6e22 0a20 2020      {TOP}\n".   
-00009f20: 2020 2020 2020 2020 2020 2066 2254 4558             f"TEX
-00009f30: 504f 5345 4420 3d20 7b54 4558 504f 5345  POSED = {TEXPOSE
-00009f40: 447d 5c6e 220a 2020 2020 2020 2020 2020  D}\n".          
-00009f50: 2020 2020 6622 494d 4147 455f 494e 203d      f"IMAGE_IN =
-00009f60: 2027 7b69 6d61 6765 5f6e 616d 657d 275c   '{image_name}'\
-00009f70: 6e22 0a20 2020 2020 2020 2020 2020 2020  n".             
-00009f80: 2066 224f 424a 4543 5453 5f4f 5554 203d   f"OBJECTS_OUT =
-00009f90: 2027 7b6f 626a 6563 7473 5f6e 616d 657d   '{objects_name}
-00009fa0: 275c 6e22 0a20 2020 2020 2020 2020 2020  '\n".           
-00009fb0: 2020 2022 5041 5241 4d53 5f44 4546 4155     "PARAMS_DEFAU
-00009fc0: 4c54 203d 2070 6172 616d 6465 6661 756c  LT = paramdefaul
-00009fd0: 7422 290a 0a20 2020 2023 2053 6176 696e  t")..    # Savin
-00009fe0: 6720 636f 6e66 6967 2066 696c 650a 2020  g config file.  
-00009ff0: 2020 7769 7468 206f 7065 6e28 636f 6e66    with open(conf
-0000a000: 6967 5f66 696c 652c 2022 7722 2920 6173  ig_file, "w") as
-0000a010: 2066 3a0a 2020 2020 2020 2020 662e 7772   f:.        f.wr
-0000a020: 6974 6528 636f 6e66 6967 290a 0a64 6566  ite(config)..def
-0000a030: 2070 7366 5f66 6c61 6773 7461 7228 6669   psf_flagstar(fi
-0000a040: 746d 6167 2c20 6669 7473 6b79 2c20 6572  tmag, fitsky, er
-0000a050: 725f 6669 746d 6167 2c20 6d61 785f 6572  r_fitmag, max_er
-0000a060: 7220 3d20 302e 3032 2c20 7570 7065 725f  r = 0.02, upper_
-0000a070: 6c69 6d69 7420 3d20 302e 3529 3a0a 2020  limit = 0.5):.  
-0000a080: 2020 2222 220a 2020 2020 4372 6561 7465    """.    Create
-0000a090: 2061 2073 7461 7220 666c 6167 2028 3120   a star flag (1 
-0000a0a0: 636c 6173 7369 6669 6564 2061 7320 7374  classified as st
-0000a0b0: 6172 2c20 3020 6e6f 7420 636c 6173 7369  ar, 0 not classi
-0000a0c0: 6669 6564 2920 666f 7220 7468 6520 646f  fied) for the do
-0000a0d0: 7068 6f74 0a20 2020 206f 7574 7075 7420  phot.    output 
-0000a0e0: 6361 7461 6c6f 6720 7573 696e 6720 7468  catalog using th
-0000a0f0: 6520 636f 6c75 6d6e 7320 6669 746d 6167  e columns fitmag
-0000a100: 2c20 6669 7473 6b79 2061 6e64 2065 7272  , fitsky and err
-0000a110: 5f66 6974 6d61 672e 0a0a 2020 2020 5061  _fitmag...    Pa
-0000a120: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-0000a130: 2d2d 2d2d 2d2d 2d0a 2020 2020 6669 746d  -------.    fitm
-0000a140: 6167 203a 206e 702e 6172 7261 790a 2020  ag : np.array.  
-0000a150: 2020 2020 2020 646f 7068 6f74 2063 6174        dophot cat
-0000a160: 616c 6f67 2066 6974 6d61 6720 636f 6c75  alog fitmag colu
-0000a170: 6d6e 0a20 2020 2066 6974 736b 7920 3a20  mn.    fitsky : 
-0000a180: 6e70 2e61 7272 6179 0a20 2020 2020 2020  np.array.       
-0000a190: 2064 6f70 686f 7420 6361 7461 6c6f 6720   dophot catalog 
-0000a1a0: 6669 7473 6b79 2063 6f6c 756d 6e0a 2020  fitsky column.  
-0000a1b0: 2020 6572 725f 6669 746d 6167 203a 206e    err_fitmag : n
-0000a1c0: 702e 6172 7261 790a 2020 2020 2020 2020  p.array.        
-0000a1d0: 646f 7068 6f74 2063 6174 616c 6f67 2065  dophot catalog e
-0000a1e0: 7272 5f66 6974 6d61 6720 636f 6c75 6d6e  rr_fitmag column
-0000a1f0: 0a20 2020 206d 6178 5f65 7272 203a 2066  .    max_err : f
-0000a200: 6c6f 6174 0a20 2020 2020 2020 206d 6178  loat.        max
-0000a210: 2076 616c 7565 206f 6620 6572 725f 6669   value of err_fi
-0000a220: 746d 6167 2073 656c 6563 7465 6420 666f  tmag selected fo
-0000a230: 7220 6c69 6e65 6172 2072 6567 7265 7373  r linear regress
-0000a240: 696f 6e0a 2020 2020 7570 7065 725f 6c69  ion.    upper_li
-0000a250: 6d69 7420 3a20 666c 6f61 740a 2020 2020  mit : float.    
-0000a260: 2020 2020 7661 6c75 6520 6162 6f76 6520      value above 
-0000a270: 6c69 6e65 6172 2072 6567 7265 7373 696f  linear regressio
-0000a280: 6e20 6c69 6d69 7469 6e67 2074 6865 2073  n limiting the s
-0000a290: 7461 7220 636c 6173 7369 6669 6361 7469  tar classificati
-0000a2a0: 6f6e 0a0a 2020 2020 5265 7475 726e 730a  on..    Returns.
-0000a2b0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-0000a2c0: 6e70 2e61 7272 6179 0a20 2020 2020 2020  np.array.       
-0000a2d0: 2073 7461 7266 6c61 6720 6172 7261 7920   starflag array 
-0000a2e0: 2831 2063 6c61 7373 6966 6965 6420 6173  (1 classified as
-0000a2f0: 2073 7461 722c 2030 206e 6f74 2063 6c61   star, 0 not cla
-0000a300: 7373 6966 6965 6429 0a20 2020 2022 2222  ssified).    """
-0000a310: 0a0a 2020 2020 6e72 6f77 7320 3d20 6c65  ..    nrows = le
-0000a320: 6e28 6669 746d 6167 290a 0a20 2020 2023  n(fitmag)..    #
-0000a330: 2043 7265 6174 6520 666c 6167 5f73 7461   Create flag_sta
-0000a340: 7220 6172 7261 790a 2020 2020 666c 6167  r array.    flag
-0000a350: 7374 6172 203d 206e 702e 7a65 726f 7328  star = np.zeros(
-0000a360: 6e72 6f77 7329 0a0a 2020 2020 2320 7365  nrows)..    # se
-0000a370: 6c65 6374 2070 6f69 6e74 7320 666f 7220  lect points for 
-0000a380: 6669 740a 2020 2020 6630 203d 2066 6974  fit.    f0 = fit
-0000a390: 736b 7920 3e20 300a 2020 2020 6665 7272  sky > 0.    ferr
-0000a3a0: 203d 2065 7272 5f66 6974 6d61 6720 3c20   = err_fitmag < 
-0000a3b0: 6d61 785f 6572 720a 0a20 2020 2023 2046  max_err..    # F
-0000a3c0: 6978 2077 6865 6e20 6e6f 2070 6f69 6e74  ix when no point
-0000a3d0: 7320 6172 6520 7365 6c65 6374 6564 2077  s are selected w
-0000a3e0: 6974 6869 6e20 7468 6973 2065 7272 6f72  ithin this error
-0000a3f0: 0a20 2020 204e 706f 696e 7473 203d 206c  .    Npoints = l
-0000a400: 656e 2866 6974 736b 795b 6630 2026 2066  en(fitsky[f0 & f
-0000a410: 6572 725d 290a 2020 2020 6966 204e 706f  err]).    if Npo
-0000a420: 696e 7473 203c 2033 303a 0a20 2020 2020  ints < 30:.     
-0000a430: 2020 206d 7367 203d 2028 6622 5365 6c65     msg = (f"Sele
-0000a440: 6374 6564 206f 6e6c 7920 7b4e 706f 696e  cted only {Npoin
-0000a450: 7473 7d20 706f 696e 7473 2077 6974 6820  ts} points with 
-0000a460: 6572 725f 6669 746d 6167 203c 207b 6d61  err_fitmag < {ma
-0000a470: 785f 6572 727d 2e20 220a 2020 2020 2020  x_err}. ".      
-0000a480: 2020 2020 2020 2020 6622 5573 696e 6720          f"Using 
-0000a490: 6d61 675f 6572 7220 3d20 7b31 2e35 2a6d  mag_err = {1.5*m
-0000a4a0: 6178 5f65 7272 7d20 696e 7374 6561 642e  ax_err} instead.
-0000a4b0: 2229 0a20 2020 2020 2020 2077 6172 6e69  ").        warni
-0000a4c0: 6e67 732e 7761 726e 286d 7367 290a 0a20  ngs.warn(msg).. 
-0000a4d0: 2020 2020 2020 206d 6178 5f65 7272 203d         max_err =
-0000a4e0: 2031 2e35 2a6d 6178 5f65 7272 0a20 2020   1.5*max_err.   
-0000a4f0: 2020 2020 2066 6572 7220 3d20 6572 725f       ferr = err_
-0000a500: 6669 746d 6167 203c 206d 6178 5f65 7272  fitmag < max_err
-0000a510: 0a0a 2020 2020 2320 4765 6e65 7261 7465  ..    # Generate
-0000a520: 2078 2061 6e64 2079 0a20 2020 2079 203d   x and y.    y =
-0000a530: 206e 702e 6c6f 6731 3028 6669 7473 6b79   np.log10(fitsky
-0000a540: 5b66 3020 2620 6665 7272 5d29 0a20 2020  [f0 & ferr]).   
-0000a550: 2078 203d 2066 6974 6d61 675b 6630 2026   x = fitmag[f0 &
-0000a560: 2066 6572 725d 0a0a 2020 2020 2320 4c69   ferr]..    # Li
-0000a570: 6e65 6172 2066 6974 3a20 6c6f 6731 3028  near fit: log10(
-0000a580: 6669 7473 6b79 2920 3d20 6120 2a20 6669  fitsky) = a * fi
-0000a590: 746d 6167 202b 2062 0a20 2020 2061 2c20  tmag + b.    a, 
-0000a5a0: 6220 3d20 6e70 2e70 6f6c 7966 6974 2878  b = np.polyfit(x
-0000a5b0: 2c20 792c 2031 290a 0a20 2020 2023 2053  , y, 1)..    # S
-0000a5c0: 7461 7220 636c 6173 7369 6669 6361 7469  tar classificati
-0000a5d0: 6f6e 0a20 2020 2073 656c 6563 7469 6f6e  on.    selection
-0000a5e0: 203d 206e 702e 6c6f 6731 3028 6669 7473   = np.log10(fits
-0000a5f0: 6b79 5b66 305d 2920 3c20 2875 7070 6572  ky[f0]) < (upper
-0000a600: 5f6c 696d 6974 202b 2061 2a66 6974 6d61  _limit + a*fitma
-0000a610: 675b 6630 5d20 2b20 6229 0a0a 2020 2020  g[f0] + b)..    
-0000a620: 666c 6167 7374 6172 5b66 305d 203d 2073  flagstar[f0] = s
-0000a630: 656c 6563 7469 6f6e 2e61 7374 7970 6528  election.astype(
-0000a640: 696e 7429 0a0a 2020 2020 2320 416c 7365  int)..    # Alse
-0000a650: 2073 6574 2070 6f69 6e74 7320 7769 7468   set points with
-0000a660: 2066 6974 736b 7920 3c20 3020 6173 2073   fitsky < 0 as s
-0000a670: 7461 7273 0a20 2020 2066 6c61 6773 7461  tars.    flagsta
-0000a680: 725b 7e66 305d 203d 2031 0a0a 2020 2020  r[~f0] = 1..    
-0000a690: 7265 7475 726e 2066 6c61 6773 7461 722e  return flagstar.
-0000a6a0: 6173 7479 7065 2869 6e74 290a 0a0a 6465  astype(int)...de
-0000a6b0: 6620 666f 726d 6174 5f64 6f70 686f 745f  f format_dophot_
-0000a6c0: 6361 7461 6c6f 6728 6361 7461 6c6f 675f  catalog(catalog_
-0000a6d0: 696e 2c20 6361 7461 6c6f 675f 6f75 742c  in, catalog_out,
-0000a6e0: 2069 6d61 6765 2c20 6669 6c74 203d 2027   image, filt = '
-0000a6f0: 6e61 6e27 2c0a 2020 2020 2020 2020 2020  nan',.          
-0000a700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a710: 6669 656c 6420 3d20 274e 6f46 6965 6c64  field = 'NoField
-0000a720: 4e61 6d65 272c 2064 726e 616d 6520 3d20  Name', drname = 
-0000a730: 274e 6f44 526e 616d 6527 293a 0a20 2020  'NoDRname'):.   
-0000a740: 2022 2222 0a20 2020 2046 6f72 6d61 7473   """.    Formats
-0000a750: 2064 6f70 686f 7420 6f75 7470 7574 2063   dophot output c
-0000a760: 6174 616c 6f67 2069 6e74 6f20 616e 2061  atalog into an a
-0000a770: 7363 6969 2074 6162 6c65 2c20 6164 6469  scii table, addi
-0000a780: 6e67 2052 412c 2044 4543 2063 6f6c 756d  ng RA, DEC colum
-0000a790: 6e73 0a20 2020 2061 6e64 2061 6c73 6f20  ns.    and also 
-0000a7a0: 636c 6173 7369 6669 6e67 2073 7461 7273  classifing stars
-0000a7b0: 2028 636f 6c75 6d6e 2053 5441 525f 464c   (column STAR_FL
-0000a7c0: 4147 203d 2031 290a 0a20 2020 2049 7427  AG = 1)..    It'
-0000a7d0: 7320 616c 736f 206e 6563 6573 7361 7279  s also necessary
-0000a7e0: 2074 6f20 696e 7075 7420 7468 6520 6c6f   to input the lo
-0000a7f0: 6361 7469 6f6e 206f 6620 7468 6520 6669  cation of the fi
-0000a800: 656c 6427 7320 2e66 7a0a 2020 2020 696d  eld's .fz.    im
-0000a810: 6167 652e 2054 6865 2057 4353 2064 6174  age. The WCS dat
-0000a820: 6120 6672 6f6d 2074 6865 2068 6561 6465  a from the heade
-0000a830: 7220 6973 2075 7365 6420 746f 2063 6f6e  r is used to con
-0000a840: 7665 7274 2078 2c20 7920 636f 6f72 6469  vert x, y coordi
-0000a850: 6e61 7465 7320 746f 0a20 2020 2052 4120  nates to.    RA 
-0000a860: 616e 6420 4445 432e 0a0a 2020 2020 5061  and DEC...    Pa
-0000a870: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-0000a880: 2d2d 2d2d 2d2d 2d0a 2020 2020 6361 7461  -------.    cata
-0000a890: 6c6f 675f 696e 203a 2073 7472 0a20 2020  log_in : str.   
-0000a8a0: 2020 2020 204c 6f63 6174 696f 6e20 6f66       Location of
-0000a8b0: 2064 6f70 686f 7420 2e73 756d 2063 6174   dophot .sum cat
-0000a8c0: 616c 6f67 0a20 2020 2063 6174 616c 6f67  alog.    catalog
-0000a8d0: 5f6f 7574 203a 2073 7472 0a20 2020 2020  _out : str.     
-0000a8e0: 2020 2044 6573 6972 6564 206c 6f63 6174     Desired locat
-0000a8f0: 696f 6e20 6f66 2074 6865 2066 6f72 6d61  ion of the forma
-0000a900: 7465 6420 6361 7461 6c6f 670a 2020 2020  ted catalog.    
-0000a910: 696d 6167 6520 3a20 7374 720a 2020 2020  image : str.    
-0000a920: 2020 2020 4c6f 6361 7469 6f6e 206f 6620      Location of 
-0000a930: 532d 504c 5553 2066 6965 6c64 2069 6d61  S-PLUS field ima
-0000a940: 6765 0a20 2020 2066 696c 7420 3a20 7374  ge.    filt : st
-0000a950: 720a 2020 2020 2020 2020 4e61 6d65 206f  r.        Name o
-0000a960: 6620 7468 6520 6669 6c74 6572 0a20 2020  f the filter.   
-0000a970: 2066 6965 6c64 203a 2073 7472 0a20 2020   field : str.   
-0000a980: 2020 2020 204e 616d 6520 6f66 2074 6865       Name of the
-0000a990: 2066 6965 6c64 2074 6f20 6265 2061 6464   field to be add
-0000a9a0: 6564 2074 6f20 7468 6520 6669 6c74 6572  ed to the filter
-0000a9b0: 5f49 440a 2020 2020 6472 6e61 6d65 203a  _ID.    drname :
-0000a9c0: 2073 7472 0a20 2020 2020 2020 2044 6174   str.        Dat
-0000a9d0: 6120 7265 6c65 6173 6520 6465 7369 676e  a release design
-0000a9e0: 6174 696f 6e20 746f 2062 6520 6164 6465  ation to be adde
-0000a9f0: 6420 746f 2074 6865 2066 696c 7465 725f  d to the filter_
-0000aa00: 4944 0a20 2020 2073 6578 6d6f 6465 203a  ID.    sexmode :
-0000aa10: 2073 7472 0a20 2020 2020 2020 2064 7561   str.        dua
-0000aa20: 6c2f 7369 6e67 6c65 2053 4578 7472 6163  l/single SExtrac
-0000aa30: 746f 7220 6d6f 6465 2074 6f20 6265 2061  tor mode to be a
-0000aa40: 6464 6564 2074 6f20 7468 6520 6669 6c74  dded to the filt
-0000aa50: 6572 5f49 440a 0a20 2020 2052 6574 7572  er_ID..    Retur
-0000aa60: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-0000aa70: 2020 2053 6176 6573 2066 6f72 6d61 7465     Saves formate
-0000aa80: 6420 6361 7461 6c6f 6720 746f 2074 6865  d catalog to the
-0000aa90: 2070 6172 616d 3a63 6174 616c 6f67 5f6f   param:catalog_o
-0000aaa0: 7574 206c 6f63 6174 696f 6e0a 2020 2020  ut location.    
-0000aab0: 2222 220a 0a20 2020 2064 6f70 686f 745f  """..    dophot_
-0000aac0: 636f 6c75 6d6e 5f6e 616d 6573 203d 205b  column_names = [
-0000aad0: 2253 7461 725f 6e75 6d62 6572 222c 2022  "Star_number", "
-0000aae0: 7870 6f73 222c 2022 7970 6f73 222c 2022  xpos", "ypos", "
-0000aaf0: 6669 746d 6167 222c 0a20 2020 2020 2020  fitmag",.       
-0000ab00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab10: 2020 2020 2265 7272 5f66 6974 6d61 6722      "err_fitmag"
-0000ab20: 2c20 2266 6974 736b 7922 2c20 226f 626a  , "fitsky", "obj
-0000ab30: 7479 7065 222c 2022 6368 6922 2c20 2261  type", "chi", "a
-0000ab40: 7063 6f72 7222 5d0a 0a20 2020 2064 6f70  pcorr"]..    dop
-0000ab50: 686f 745f 6461 7461 5f74 7970 6573 203d  hot_data_types =
-0000ab60: 207b 2753 7461 725f 6e75 6d62 6572 273a   {'Star_number':
-0000ab70: 2069 6e74 2c20 2778 706f 7327 3a20 666c   int, 'xpos': fl
-0000ab80: 6f61 742c 2027 7970 6f73 273a 2066 6c6f  oat, 'ypos': flo
-0000ab90: 6174 2c0a 2020 2020 2020 2020 2020 2020  at,.            
-0000aba0: 2020 2020 2020 2020 2020 2020 2027 6669               'fi
-0000abb0: 746d 6167 273a 2066 6c6f 6174 2c20 2765  tmag': float, 'e
-0000abc0: 7272 5f66 6974 6d61 6727 3a20 666c 6f61  rr_fitmag': floa
-0000abd0: 742c 2027 6669 7473 6b79 273a 2066 6c6f  t, 'fitsky': flo
-0000abe0: 6174 2c0a 2020 2020 2020 2020 2020 2020  at,.            
-0000abf0: 2020 2020 2020 2020 2020 2020 2027 6f62               'ob
-0000ac00: 6a74 7970 6527 3a20 696e 742c 2027 6368  jtype': int, 'ch
-0000ac10: 6927 3a20 666c 6f61 742c 2027 6170 636f  i': float, 'apco
-0000ac20: 7272 273a 2066 6c6f 6174 7d0a 0a20 2020  rr': float}..   
-0000ac30: 2063 6174 5f64 6174 6120 3d20 7064 2e72   cat_data = pd.r
-0000ac40: 6561 645f 6373 7628 6361 7461 6c6f 675f  ead_csv(catalog_
-0000ac50: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
-0000ac60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000ac70: 6b69 7072 6f77 7320 3d20 332c 0a20 2020  kiprows = 3,.   
+00008a80: 7665 7262 6f73 6520 2020 2020 2020 3d20  verbose       = 
+00008a90: 4661 6c73 6529 0a0a 2020 2020 6669 672c  False)..    fig,
+00008aa0: 2061 7873 203d 2070 6c74 2e73 7562 706c   axs = plt.subpl
+00008ab0: 6f74 7328 332c 2066 6967 7369 7a65 203d  ots(3, figsize =
+00008ac0: 205b 352c 3135 5d29 0a0a 2020 2020 2323   [5,15])..    ##
+00008ad0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+00008ae0: 2020 2020 2320 506c 6f74 2063 6c61 7373      # Plot class
+00008af0: 2073 7461 720a 0a20 2020 2023 2050 6c6f   star..    # Plo
+00008b00: 7420 616c 6c20 706f 696e 7473 0a20 2020  t all points.   
+00008b10: 2061 7873 5b30 5d2e 7363 6174 7465 7228   axs[0].scatter(
+00008b20: 7365 7863 6174 5b27 4d41 475f 4155 544f  sexcat['MAG_AUTO
+00008b30: 275d 2c20 7365 7863 6174 5b27 434c 4153  '], sexcat['CLAS
+00008b40: 535f 5354 4152 275d 2c0a 2020 2020 2020  S_STAR'],.      
+00008b50: 2020 2020 2020 2020 2020 2020 2063 3d22               c="
+00008b60: 2341 4141 4141 4122 2c20 733d 3130 2c20  #AAAAAA", s=10, 
+00008b70: 616c 7068 613d 302e 3129 0a0a 2020 2020  alpha=0.1)..    
+00008b80: 2320 506c 6f74 2073 656c 6563 7469 6f6e  # Plot selection
+00008b90: 0a20 2020 2061 7873 5b30 5d2e 7363 6174  .    axs[0].scat
+00008ba0: 7465 7228 7365 6c65 6374 5b27 4d41 475f  ter(select['MAG_
+00008bb0: 4155 544f 275d 2c20 7365 6c65 6374 5b27  AUTO'], select['
+00008bc0: 434c 4153 535f 5354 4152 275d 2c0a 2020  CLASS_STAR'],.  
+00008bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008be0: 2063 3d22 2332 3236 3646 4622 2c20 733d   c="#2266FF", s=
+00008bf0: 3130 2c20 616c 7068 613d 302e 332c 0a20  10, alpha=0.3,. 
+00008c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c10: 2020 6c61 6265 6c3d 6622 7332 6e63 7574    label=f"s2ncut
+00008c20: 3a20 7b73 326e 6375 747d 5c6e 2620 7374  : {s2ncut}\n& st
+00008c30: 6172 6375 743a 207b 7374 6172 6375 747d  arcut: {starcut}
+00008c40: 2229 0a0a 2020 2020 2320 506c 6f74 2063  ")..    # Plot c
+00008c50: 7574 206c 696e 650a 2020 2020 6178 735b  ut line.    axs[
+00008c60: 305d 2e68 6c69 6e65 7328 7374 6172 6375  0].hlines(starcu
+00008c70: 742c 206d 6167 5f63 7574 5b30 5d2c 206d  t, mag_cut[0], m
+00008c80: 6167 5f63 7574 5b31 5d2c 0a20 2020 2020  ag_cut[1],.     
+00008c90: 2020 2020 2020 2020 2020 2020 2063 6f6c               col
+00008ca0: 6f72 733d 2223 3232 3636 4646 222c 207a  ors="#2266FF", z
+00008cb0: 6f72 6465 723d 3129 0a0a 2020 2020 2320  order=1)..    # 
+00008cc0: 506c 6f74 2067 7269 6420 6c69 6e65 730a  Plot grid lines.
+00008cd0: 2020 2020 6178 735b 305d 2e68 6c69 6e65      axs[0].hline
+00008ce0: 7328 6e70 2e61 7261 6e67 6528 2d30 2e31  s(np.arange(-0.1
+00008cf0: 2c20 312e 312c 2030 2e31 292c 206d 6167  , 1.1, 0.1), mag
+00008d00: 5f63 7574 5b30 5d2c 206d 6167 5f63 7574  _cut[0], mag_cut
+00008d10: 5b31 5d2c 0a20 2020 2020 2020 2020 2020  [1],.           
+00008d20: 2020 2020 2020 2063 6f6c 6f72 733d 2223         colors="#
+00008d30: 4545 4545 4545 222c 207a 6f72 6465 723d  EEEEEE", zorder=
+00008d40: 2d31 290a 0a20 2020 2061 7873 5b30 5d2e  -1)..    axs[0].
+00008d50: 6c65 6765 6e64 286c 6f63 3d31 290a 2020  legend(loc=1).  
+00008d60: 2020 6178 735b 305d 2e73 6574 5f78 6c69    axs[0].set_xli
+00008d70: 6d28 6d61 675f 6375 7429 0a20 2020 2061  m(mag_cut).    a
+00008d80: 7873 5b30 5d2e 7365 745f 796c 696d 285b  xs[0].set_ylim([
+00008d90: 2d30 2e31 2c20 312e 315d 290a 2020 2020  -0.1, 1.1]).    
+00008da0: 6178 735b 305d 2e73 6574 5f79 6c61 6265  axs[0].set_ylabe
+00008db0: 6c28 2743 4c41 5353 5f53 5441 5227 290a  l('CLASS_STAR').
+00008dc0: 2020 2020 6178 735b 305d 2e6d 696e 6f72      axs[0].minor
+00008dd0: 7469 636b 735f 6f6e 2829 0a0a 2020 2020  ticks_on()..    
+00008de0: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
+00008df0: 2050 6c6f 7420 7332 6e0a 0a20 2020 2023   Plot s2n..    #
+00008e00: 2050 6c6f 7420 616c 6c20 706f 696e 7473   Plot all points
+00008e10: 0a20 2020 2073 326e 5f63 6174 203d 2073  .    s2n_cat = s
+00008e20: 6578 6361 745b 2746 4c55 585f 4155 544f  excat['FLUX_AUTO
+00008e30: 275d 202f 2073 6578 6361 745b 2746 4c55  '] / sexcat['FLU
+00008e40: 5845 5252 5f41 5554 4f27 5d0a 2020 2020  XERR_AUTO'].    
+00008e50: 6178 735b 315d 2e73 6361 7474 6572 2873  axs[1].scatter(s
+00008e60: 6578 6361 745b 274d 4147 5f41 5554 4f27  excat['MAG_AUTO'
+00008e70: 5d2c 2073 326e 5f63 6174 2c0a 2020 2020  ], s2n_cat,.    
+00008e80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00008e90: 3d22 2341 4141 4141 4122 2c20 733d 3130  ="#AAAAAA", s=10
+00008ea0: 2c20 616c 7068 613d 302e 3129 0a0a 2020  , alpha=0.1)..  
+00008eb0: 2020 2320 506c 6f74 2073 656c 6563 7469    # Plot selecti
+00008ec0: 6f6e 0a20 2020 2073 326e 5f73 656c 203d  on.    s2n_sel =
+00008ed0: 2073 656c 6563 745b 2746 4c55 585f 4155   select['FLUX_AU
+00008ee0: 544f 275d 202f 2073 656c 6563 745b 2746  TO'] / select['F
+00008ef0: 4c55 5845 5252 5f41 5554 4f27 5d0a 2020  LUXERR_AUTO'].  
+00008f00: 2020 6178 735b 315d 2e73 6361 7474 6572    axs[1].scatter
+00008f10: 2873 656c 6563 745b 274d 4147 5f41 5554  (select['MAG_AUT
+00008f20: 4f27 5d2c 2073 326e 5f73 656c 2c0a 2020  O'], s2n_sel,.  
+00008f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008f40: 2063 3d22 2332 3236 3646 4622 2c20 733d   c="#2266FF", s=
+00008f50: 3130 2c20 616c 7068 613d 302e 3329 0a0a  10, alpha=0.3)..
+00008f60: 2020 2020 2320 506c 6f74 2063 7574 206c      # Plot cut l
+00008f70: 696e 650a 2020 2020 6178 735b 315d 2e68  ine.    axs[1].h
+00008f80: 6c69 6e65 7328 7332 6e63 7574 2c20 6d61  lines(s2ncut, ma
+00008f90: 675f 6375 745b 305d 2c20 6d61 675f 6375  g_cut[0], mag_cu
+00008fa0: 745b 315d 2c0a 2020 2020 2020 2020 2020  t[1],.          
+00008fb0: 2020 2020 2020 2020 636f 6c6f 7273 3d22          colors="
+00008fc0: 2332 3236 3646 4622 2c20 7a6f 7264 6572  #2266FF", zorder
+00008fd0: 3d31 290a 0a20 2020 2023 2050 6c6f 7420  =1)..    # Plot 
+00008fe0: 6772 6964 206c 696e 6573 0a20 2020 2061  grid lines.    a
+00008ff0: 7873 5b31 5d2e 686c 696e 6573 285b 302e  xs[1].hlines([0.
+00009000: 312c 2031 2c20 3130 2c20 3130 302c 2031  1, 1, 10, 100, 1
+00009010: 3030 302c 2031 3030 3030 5d2c 206d 6167  000, 10000], mag
+00009020: 5f63 7574 5b30 5d2c 206d 6167 5f63 7574  _cut[0], mag_cut
+00009030: 5b31 5d2c 0a20 2020 2020 2020 2020 2020  [1],.           
+00009040: 2020 2020 2020 2063 6f6c 6f72 733d 2223         colors="#
+00009050: 4545 4545 4545 222c 207a 6f72 6465 723d  EEEEEE", zorder=
+00009060: 2d31 290a 0a20 2020 2061 7873 5b31 5d2e  -1)..    axs[1].
+00009070: 7365 745f 786c 696d 286d 6167 5f63 7574  set_xlim(mag_cut
+00009080: 290a 2020 2020 6178 735b 315d 2e73 6574  ).    axs[1].set
+00009090: 5f79 7363 616c 6528 276c 6f67 2729 0a20  _yscale('log'). 
+000090a0: 2020 2061 7873 5b31 5d2e 7365 745f 796c     axs[1].set_yl
+000090b0: 696d 285b 302e 312c 2032 202a 2073 326e  im([0.1, 2 * s2n
+000090c0: 6375 745b 315d 5d29 0a20 2020 2061 7873  cut[1]]).    axs
+000090d0: 5b31 5d2e 7365 745f 796c 6162 656c 2827  [1].set_ylabel('
+000090e0: 532f 4e27 290a 2020 2020 6178 735b 315d  S/N').    axs[1]
+000090f0: 2e6d 696e 6f72 7469 636b 735f 6f6e 2829  .minorticks_on()
+00009100: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
+00009110: 230a 2020 2020 2320 506c 6f74 2046 5748  #.    # Plot FWH
+00009120: 4d0a 0a20 2020 2023 2050 6c6f 7420 616c  M..    # Plot al
+00009130: 6c20 706f 696e 7473 0a20 2020 2061 7873  l points.    axs
+00009140: 5b32 5d2e 7363 6174 7465 7228 7365 7863  [2].scatter(sexc
+00009150: 6174 5b27 4d41 475f 4155 544f 275d 2c20  at['MAG_AUTO'], 
+00009160: 7365 7863 6174 5b27 4657 484d 5f57 4f52  sexcat['FWHM_WOR
+00009170: 4c44 275d 202a 2033 3630 302c 0a20 2020  LD'] * 3600,.   
+00009180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009190: 633d 2223 4141 4141 4141 222c 2073 3d31  c="#AAAAAA", s=1
+000091a0: 302c 2061 6c70 6861 3d30 2e31 290a 0a20  0, alpha=0.1).. 
+000091b0: 2020 2023 2050 6c6f 7420 7365 6c65 6374     # Plot select
+000091c0: 696f 6e0a 2020 2020 6178 735b 325d 2e73  ion.    axs[2].s
+000091d0: 6361 7474 6572 2873 656c 6563 745b 274d  catter(select['M
+000091e0: 4147 5f41 5554 4f27 5d2c 2073 656c 6563  AG_AUTO'], selec
+000091f0: 745b 2746 5748 4d5f 574f 524c 4427 5d20  t['FWHM_WORLD'] 
+00009200: 2a20 3336 3030 2c0a 2020 2020 2020 2020  * 3600,.        
+00009210: 2020 2020 2020 2020 2020 2063 3d22 2332             c="#2
+00009220: 3236 3646 4622 2c20 733d 3130 2c20 616c  266FF", s=10, al
+00009230: 7068 613d 302e 332c 207a 6f72 6465 723d  pha=0.3, zorder=
+00009240: 3229 0a0a 2020 2020 2320 506c 6f74 2063  2)..    # Plot c
+00009250: 7574 206c 696e 650a 2020 2020 6677 686d  ut line.    fwhm
+00009260: 5f63 6f6e 6669 6720 3d20 6765 745f 7365  _config = get_se
+00009270: 7863 6f6e 665f 6677 686d 2873 6578 636f  xconf_fwhm(sexco
+00009280: 6e66 3d73 6578 636f 6e66 290a 2020 2020  nf=sexconf).    
+00009290: 6677 686d 5f65 7374 696d 6174 6564 203d  fwhm_estimated =
+000092a0: 206d 6564 6961 6e46 5748 4d20 2a20 3336   medianFWHM * 36
+000092b0: 3030 0a0a 2020 2020 6178 735b 325d 2e70  00..    axs[2].p
+000092c0: 6c6f 7428 5b6d 6167 5f63 7574 5b30 5d2c  lot([mag_cut[0],
+000092d0: 206d 6167 5f63 7574 5b31 5d5d 2c20 5b66   mag_cut[1]], [f
+000092e0: 7768 6d5f 636f 6e66 6967 2c20 6677 686d  whm_config, fwhm
+000092f0: 5f63 6f6e 6669 675d 2c0a 2020 2020 2020  _config],.      
+00009300: 2020 2020 2020 2020 2020 636f 6c6f 723d            color=
+00009310: 2223 4646 3636 3232 222c 207a 6f72 6465  "#FF6622", zorde
+00009320: 723d 312c 0a20 2020 2020 2020 2020 2020  r=1,.           
+00009330: 2020 2020 206c 6162 656c 3d72 2246 5748       label=r"FWH
+00009340: 4d24 5f7b 5c6d 6174 6872 6d7b 636f 6e66  M$_{\mathrm{conf
+00009350: 6967 7d7d 2422 202b 2066 223a 207b 6677  ig}}$" + f": {fw
+00009360: 686d 5f63 6f6e 6669 673a 2e33 667d 2229  hm_config:.3f}")
+00009370: 0a0a 2020 2020 6178 735b 325d 2e70 6c6f  ..    axs[2].plo
+00009380: 7428 5b6d 6167 5f63 7574 5b30 5d2c 206d  t([mag_cut[0], m
+00009390: 6167 5f63 7574 5b31 5d5d 2c20 5b66 7768  ag_cut[1]], [fwh
+000093a0: 6d5f 6573 7469 6d61 7465 642c 2066 7768  m_estimated, fwh
+000093b0: 6d5f 6573 7469 6d61 7465 645d 2c0a 2020  m_estimated],.  
+000093c0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+000093d0: 6c6f 723d 2223 3232 4141 3636 222c 207a  lor="#22AA66", z
+000093e0: 6f72 6465 723d 312c 0a20 2020 2020 2020  order=1,.       
+000093f0: 2020 2020 2020 2020 206c 6162 656c 3d72           label=r
+00009400: 2246 5748 4d24 5f7b 5c6d 6174 6872 6d7b  "FWHM$_{\mathrm{
+00009410: 6573 7469 6d61 7465 647d 7d24 2220 2b20  estimated}}$" + 
+00009420: 6622 3a20 7b66 7768 6d5f 6573 7469 6d61  f": {fwhm_estima
+00009430: 7465 643a 2e33 667d 2229 0a0a 2020 2020  ted:.3f}")..    
+00009440: 2320 506c 6f74 2067 7269 6420 6c69 6e65  # Plot grid line
+00009450: 730a 2020 2020 6178 735b 325d 2e68 6c69  s.    axs[2].hli
+00009460: 6e65 7328 6e70 2e61 7261 6e67 6528 302c  nes(np.arange(0,
+00009470: 2031 352c 2032 292c 206d 6167 5f63 7574   15, 2), mag_cut
+00009480: 5b30 5d2c 206d 6167 5f63 7574 5b31 5d2c  [0], mag_cut[1],
+00009490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000094a0: 2020 2063 6f6c 6f72 733d 2223 4545 4545     colors="#EEEE
+000094b0: 4545 222c 207a 6f72 6465 723d 2d31 290a  EE", zorder=-1).
+000094c0: 0a20 2020 2061 7873 5b32 5d2e 6c65 6765  .    axs[2].lege
+000094d0: 6e64 286c 6f63 3d32 290a 2020 2020 6178  nd(loc=2).    ax
+000094e0: 735b 325d 2e73 6574 5f78 6c69 6d28 6d61  s[2].set_xlim(ma
+000094f0: 675f 6375 7429 0a20 2020 2061 7873 5b32  g_cut).    axs[2
+00009500: 5d2e 7365 745f 796c 696d 285b 302c 2031  ].set_ylim([0, 1
+00009510: 355d 290a 2020 2020 6178 735b 325d 2e73  5]).    axs[2].s
+00009520: 6574 5f79 6c61 6265 6c28 2746 5748 4d20  et_ylabel('FWHM 
+00009530: 5b61 7263 7365 635d 2729 0a20 2020 2061  [arcsec]').    a
+00009540: 7873 5b32 5d2e 6d69 6e6f 7274 6963 6b73  xs[2].minorticks
+00009550: 5f6f 6e28 290a 0a20 2020 2061 7873 5b32  _on()..    axs[2
+00009560: 5d2e 7365 745f 786c 6162 656c 2866 227b  ].set_xlabel(f"{
+00009570: 6669 6c74 7d5f 4155 544f 205b 696e 7374  filt}_AUTO [inst
+00009580: 5d22 290a 0a20 2020 2070 6c74 2e73 7562  ]")..    plt.sub
+00009590: 706c 6f74 735f 6164 6a75 7374 286c 6566  plots_adjust(lef
+000095a0: 743d 302e 3134 2c20 7269 6768 743d 302e  t=0.14, right=0.
+000095b0: 3938 2c20 746f 703d 302e 3938 2c20 626f  98, top=0.98, bo
+000095c0: 7474 6f6d 3d30 2e30 362c 2068 7370 6163  ttom=0.06, hspac
+000095d0: 653d 302e 3129 0a0a 2020 2020 706c 742e  e=0.1)..    plt.
+000095e0: 7361 7665 6669 6728 7361 7665 5f66 696c  savefig(save_fil
+000095f0: 6529 0a20 2020 2070 6c74 2e63 6c6f 7365  e).    plt.close
+00009600: 2866 6967 290a 0a0a 2323 2323 2323 2323  (fig)...########
+00009610: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00009620: 2323 2323 2323 230a 2320 5053 4620 7068  #######.# PSF ph
+00009630: 6f74 6f6d 6574 7279 0a0a 0a64 6566 2067  otometry...def g
+00009640: 6574 5f64 6f70 686f 745f 636f 6e66 6967  et_dophot_config
+00009650: 2869 6d61 6765 5f69 6e2c 206f 626a 6563  (image_in, objec
+00009660: 7473 5f6f 7574 2c20 636f 6e66 6967 5f66  ts_out, config_f
+00009670: 696c 652c 0a20 2020 2020 2020 2020 2020  ile,.           
+00009680: 2020 2020 2020 2020 2020 2061 7065 7263             aperc
+00009690: 6f72 725f 6d61 785f 6170 6572 7475 7265  orr_max_aperture
+000096a0: 2c20 7265 6475 6374 696f 6e20 3d20 224f  , reduction = "O
+000096b0: 414a 2229 3a0a 2020 2020 2222 220a 2020  AJ"):.    """.  
+000096c0: 2020 5265 7475 726e 7320 7468 6520 646f    Returns the do
+000096d0: 7068 6f74 2074 756e 6575 7020 6669 6c65  phot tuneup file
+000096e0: 2066 6f72 2061 2067 6976 656e 2053 2d50   for a given S-P
+000096f0: 4c55 5320 696d 6167 650a 0a20 2020 2050  LUS image..    P
+00009700: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+00009710: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2069 6d61  --------.    ima
+00009720: 6765 5f69 6e20 3a20 7374 720a 2020 2020  ge_in : str.    
+00009730: 2020 2020 4c6f 6361 7469 6f6e 206f 6620      Location of 
+00009740: 532d 504c 5553 2069 6d61 6765 2074 6f20  S-PLUS image to 
+00009750: 7275 6e20 646f 7068 6f74 0a20 2020 206f  run dophot.    o
+00009760: 626a 6563 7473 5f6f 7574 203a 2073 7472  bjects_out : str
+00009770: 0a20 2020 2020 2020 204c 6f63 6174 696f  .        Locatio
+00009780: 6e20 6f66 2064 6573 6972 6564 2064 6f70  n of desired dop
+00009790: 686f 7420 6f75 7470 7574 2066 696c 650a  hot output file.
+000097a0: 2020 2020 636f 6e66 6967 5f66 696c 6520      config_file 
+000097b0: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
+000097c0: 6361 7469 6f6e 2074 6f20 7361 7665 2064  cation to save d
+000097d0: 6f70 686f 7420 7475 6e65 7570 2066 696c  ophot tuneup fil
+000097e0: 6520 666f 7220 7468 6973 2069 6d61 6765  e for this image
+000097f0: 0a20 2020 2061 7065 7263 6f72 725f 6d61  .    apercorr_ma
+00009800: 785f 6170 6572 7475 7265 203a 2066 6c6f  x_aperture : flo
+00009810: 6174 0a20 2020 2020 2020 2044 6961 6d65  at.        Diame
+00009820: 7465 7220 5b70 6978 656c 735d 2063 6f6e  ter [pixels] con
+00009830: 7369 6465 7265 6420 666f 7220 7468 6520  sidered for the 
+00009840: 6170 6572 7475 7265 2063 6f72 7265 6374  aperture correct
+00009850: 696f 6e0a 0a20 2020 2052 6574 7572 6e73  ion..    Returns
+00009860: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+00009870: 2073 6176 6573 2064 6f70 686f 7420 7475   saves dophot tu
+00009880: 6e65 7570 2066 696c 6520 696e 2074 6865  neup file in the
+00009890: 2070 6172 616d 3a63 6f6e 6669 675f 6669   param:config_fi
+000098a0: 6c65 206c 6f63 6174 696f 6e0a 0a20 2020  le location..   
+000098b0: 2022 2222 0a0a 2020 2020 2320 4c6f 6164   """..    # Load
+000098c0: 2053 2d50 4c55 5320 696d 6167 650a 2020   S-PLUS image.  
+000098d0: 2020 6865 6164 203d 2066 6974 732e 6f70    head = fits.op
+000098e0: 656e 2869 6d61 6765 5f69 6e29 5b30 5d2e  en(image_in)[0].
+000098f0: 6865 6164 6572 0a0a 2020 2020 2320 4765  header..    # Ge
+00009900: 7420 696d 6167 6520 616e 6420 6361 7461  t image and cata
+00009910: 6c6f 6720 6e61 6d65 730a 2020 2020 696d  log names.    im
+00009920: 6167 655f 6e61 6d65 2020 203d 206f 732e  age_name   = os.
+00009930: 7061 7468 2e73 706c 6974 2869 6d61 6765  path.split(image
+00009940: 5f69 6e29 5b31 5d0a 2020 2020 6f62 6a65  _in)[1].    obje
+00009950: 6374 735f 6e61 6d65 203d 206f 732e 7061  cts_name = os.pa
+00009960: 7468 2e73 706c 6974 286f 626a 6563 7473  th.split(objects
+00009970: 5f6f 7574 295b 315d 0a0a 2020 2020 2320  _out)[1]..    # 
+00009980: 4361 6c63 756c 6174 696e 6720 646f 7068  Calculating doph
+00009990: 6f74 2070 6172 616d 6574 6572 730a 2020  ot parameters.  
+000099a0: 2020 2320 5265 6665 7265 6e63 653a 204a    # Reference: J
+000099b0: 6176 6965 7220 416c 6f6e 736f 202d 2050  avier Alonso - P
+000099c0: 7269 7661 7465 2043 6f6d 6d75 6e69 6361  rivate Communica
+000099d0: 7469 6f6e 0a0a 2020 2020 6966 2072 6564  tion..    if red
+000099e0: 7563 7469 6f6e 203d 3d20 224f 414a 223a  uction == "OAJ":
+000099f0: 0a20 2020 2020 200a 2020 2020 2020 2020  .      .        
+00009a00: 4657 484d 203d 2066 6c6f 6174 2868 6561  FWHM = float(hea
+00009a10: 645b 2748 4945 5241 5243 4820 4f41 4a20  d['HIERARCH OAJ 
+00009a20: 5052 4f20 4657 484d 4d45 414e 275d 2920  PRO FWHMMEAN']) 
+00009a30: 2f20 666c 6f61 7428 6865 6164 5b27 5049  / float(head['PI
+00009a40: 5853 4341 4c45 275d 290a 2020 2020 2020  XSCALE']).      
+00009a50: 2020 534b 5920 3d20 666c 6f61 7428 6865    SKY = float(he
+00009a60: 6164 5b27 4849 4552 4152 4348 204f 414a  ad['HIERARCH OAJ
+00009a70: 2051 4320 4e43 4d49 4450 5427 5d29 0a20   QC NCMIDPT']). 
+00009a80: 2020 200a 2020 2020 2020 2020 5445 5850     .        TEXP
+00009a90: 4f53 4544 203d 2066 6c6f 6174 2868 6561  OSED = float(hea
+00009aa0: 645b 2754 4558 504f 5345 4427 5d29 202f  d['TEXPOSED']) /
+00009ab0: 2066 6c6f 6174 2868 6561 645b 274e 434f   float(head['NCO
+00009ac0: 4d42 494e 4527 5d29 0a0a 2020 2020 2020  MBINE'])..      
+00009ad0: 2020 5349 4753 4b59 203d 2066 6c6f 6174    SIGSKY = float
+00009ae0: 2868 6561 645b 2748 4945 5241 5243 4820  (head['HIERARCH 
+00009af0: 4f41 4a20 5143 204e 434e 4f49 5345 275d  OAJ QC NCNOISE']
+00009b00: 2920 2a20 5445 5850 4f53 4544 0a0a 2020  ) * TEXPOSED..  
+00009b10: 2020 2020 2020 4550 4552 444e 203d 2066        EPERDN = f
+00009b20: 6c6f 6174 2868 6561 645b 2747 4149 4e27  loat(head['GAIN'
+00009b30: 5d29 202f 2054 4558 504f 5345 440a 0a20  ]) / TEXPOSED.. 
+00009b40: 2020 2020 2020 2052 444e 4f49 5345 203d         RDNOISE =
+00009b50: 2033 2e34 3320 2a20 6e70 2e73 7172 7428   3.43 * np.sqrt(
+00009b60: 666c 6f61 7428 6865 6164 5b27 4e43 4f4d  float(head['NCOM
+00009b70: 4249 4e45 275d 2929 0a0a 2020 2020 2020  BINE']))..      
+00009b80: 2020 544f 5020 3d20 666c 6f61 7428 6865    TOP = float(he
+00009b90: 6164 5b27 5341 5455 5241 5445 275d 2920  ad['SATURATE']) 
+00009ba0: 2a20 5445 5850 4f53 4544 0a0a 2020 2020  * TEXPOSED..    
+00009bb0: 656c 6966 2072 6564 7563 7469 6f6e 203d  elif reduction =
+00009bc0: 3d20 224d 4152 223a 0a20 2020 2020 2020  = "MAR":.       
+00009bd0: 200a 2020 2020 2020 2020 4e43 4f4d 4249   .        NCOMBI
+00009be0: 4e45 203d 2068 6561 645b 224e 434f 4d42  NE = head["NCOMB
+00009bf0: 494e 4522 5d0a 2020 2020 2020 2020 0a20  INE"].        . 
+00009c00: 2020 2020 2020 2046 5748 4d20 3d20 666c         FWHM = fl
+00009c10: 6f61 7428 6865 6164 5b27 4849 4552 4152  oat(head['HIERAR
+00009c20: 4348 204d 4152 2050 524f 2046 5748 4d53  CH MAR PRO FWHMS
+00009c30: 4558 5427 5d29 202f 2066 6c6f 6174 2868  EXT']) / float(h
+00009c40: 6561 645b 2750 4958 5343 414c 4527 5d29  ead['PIXSCALE'])
+00009c50: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00009c60: 2020 534b 5920 3d20 666c 6f61 7428 6865    SKY = float(he
+00009c70: 6164 5b27 4849 4552 4152 4348 204d 4152  ad['HIERARCH MAR
+00009c80: 2051 4320 4e43 4d49 4450 5427 5d29 0a0a   QC NCMIDPT'])..
+00009c90: 2020 2020 2020 2020 5445 5850 4f53 4544          TEXPOSED
+00009ca0: 203d 2066 6c6f 6174 2868 6561 645b 2745   = float(head['E
+00009cb0: 5850 5449 4d45 275d 2920 2f20 4e43 4f4d  XPTIME']) / NCOM
+00009cc0: 4249 4e45 0a0a 2020 2020 2020 2020 5349  BINE..        SI
+00009cd0: 4753 4b59 203d 2066 6c6f 6174 2868 6561  GSKY = float(hea
+00009ce0: 645b 2748 4945 5241 5243 4820 4d41 5220  d['HIERARCH MAR 
+00009cf0: 5143 204e 434e 4f49 5345 275d 2920 2a20  QC NCNOISE']) * 
+00009d00: 5445 5850 4f53 4544 0a0a 2020 2020 2020  TEXPOSED..      
+00009d10: 2020 4550 4552 444e 203d 2066 6c6f 6174    EPERDN = float
+00009d20: 2868 6561 645b 2747 4149 4e27 5d29 202f  (head['GAIN']) /
+00009d30: 2054 4558 504f 5345 440a 0a20 2020 2020   TEXPOSED..     
+00009d40: 2020 2052 444e 4f49 5345 203d 2033 2e34     RDNOISE = 3.4
+00009d50: 3320 2a20 6e70 2e73 7172 7428 4e43 4f4d  3 * np.sqrt(NCOM
+00009d60: 4249 4e45 290a 0a20 2020 2020 2020 2054  BINE)..        T
+00009d70: 4f50 203d 2066 6c6f 6174 2868 6561 645b  OP = float(head[
+00009d80: 2753 4154 5552 4154 4527 5d29 202a 2054  'SATURATE']) * T
+00009d90: 4558 504f 5345 440a 0a20 2020 200a 2020  EXPOSED..    .  
+00009da0: 2020 5343 414c 4541 5052 4144 4955 5320    SCALEAPRADIUS 
+00009db0: 3d20 6e70 2e61 726f 756e 6428 2861 7065  = np.around((ape
+00009dc0: 7263 6f72 725f 6d61 785f 6170 6572 7475  rcorr_max_apertu
+00009dd0: 7265 2f32 2920 2f20 4657 484d 2c33 290a  re/2) / FWHM,3).
+00009de0: 0a20 2020 2023 2047 656e 6572 6174 696e  .    # Generatin
+00009df0: 6720 636f 6e66 6967 2066 696c 650a 2020  g config file.  
+00009e00: 2020 636f 6e66 6967 203d 2028 6622 4657    config = (f"FW
+00009e10: 484d 203d 2020 2020 207b 4657 484d 7d5c  HM =     {FWHM}\
+00009e20: 6e22 0a20 2020 2020 2020 2020 2020 2020  n".             
+00009e30: 2066 2253 4b59 203d 2020 2020 2020 7b53   f"SKY =      {S
+00009e40: 4b59 7d5c 6e22 0a20 2020 2020 2020 2020  KY}\n".         
+00009e50: 2020 2020 2066 2253 4947 534b 5920 3d20       f"SIGSKY = 
+00009e60: 2020 7b53 4947 534b 597d 5c6e 220a 2020    {SIGSKY}\n".  
+00009e70: 2020 2020 2020 2020 2020 2020 6622 4550              f"EP
+00009e80: 4552 444e 203d 2020 207b 4550 4552 444e  ERDN =   {EPERDN
+00009e90: 7d5c 6e22 0a20 2020 2020 2020 2020 2020  }\n".           
+00009ea0: 2020 2066 2252 444e 4f49 5345 203d 2020     f"RDNOISE =  
+00009eb0: 7b52 444e 4f49 5345 7d5c 6e22 0a20 2020  {RDNOISE}\n".   
+00009ec0: 2020 2020 2020 2020 2020 2066 2254 4f50             f"TOP
+00009ed0: 203d 2020 2020 2020 7b54 4f50 7d5c 6e22   =      {TOP}\n"
+00009ee0: 0a20 2020 2020 2020 2020 2020 2020 2066  .              f
+00009ef0: 2254 4558 504f 5345 4420 3d20 7b54 4558  "TEXPOSED = {TEX
+00009f00: 504f 5345 447d 5c6e 220a 2020 2020 2020  POSED}\n".      
+00009f10: 2020 2020 2020 2020 6622 494d 4147 455f          f"IMAGE_
+00009f20: 494e 203d 2027 7b69 6d61 6765 5f6e 616d  IN = '{image_nam
+00009f30: 657d 275c 6e22 0a20 2020 2020 2020 2020  e}'\n".         
+00009f40: 2020 2020 2066 224f 424a 4543 5453 5f4f       f"OBJECTS_O
+00009f50: 5554 203d 2027 7b6f 626a 6563 7473 5f6e  UT = '{objects_n
+00009f60: 616d 657d 275c 6e22 0a20 2020 2020 2020  ame}'\n".       
+00009f70: 2020 2020 2020 2022 5041 5241 4d53 5f44         "PARAMS_D
+00009f80: 4546 4155 4c54 203d 2070 6172 616d 6465  EFAULT = paramde
+00009f90: 6661 756c 7422 290a 0a20 2020 2023 2053  fault")..    # S
+00009fa0: 6176 696e 6720 636f 6e66 6967 2066 696c  aving config fil
+00009fb0: 650a 2020 2020 7769 7468 206f 7065 6e28  e.    with open(
+00009fc0: 636f 6e66 6967 5f66 696c 652c 2022 7722  config_file, "w"
+00009fd0: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+00009fe0: 662e 7772 6974 6528 636f 6e66 6967 290a  f.write(config).
+00009ff0: 0a64 6566 2070 7366 5f66 6c61 6773 7461  .def psf_flagsta
+0000a000: 7228 6669 746d 6167 2c20 6669 7473 6b79  r(fitmag, fitsky
+0000a010: 2c20 6572 725f 6669 746d 6167 2c20 6d61  , err_fitmag, ma
+0000a020: 785f 6572 7220 3d20 302e 3032 2c20 7570  x_err = 0.02, up
+0000a030: 7065 725f 6c69 6d69 7420 3d20 302e 3529  per_limit = 0.5)
+0000a040: 3a0a 2020 2020 2222 220a 2020 2020 4372  :.    """.    Cr
+0000a050: 6561 7465 2061 2073 7461 7220 666c 6167  eate a star flag
+0000a060: 2028 3120 636c 6173 7369 6669 6564 2061   (1 classified a
+0000a070: 7320 7374 6172 2c20 3020 6e6f 7420 636c  s star, 0 not cl
+0000a080: 6173 7369 6669 6564 2920 666f 7220 7468  assified) for th
+0000a090: 6520 646f 7068 6f74 0a20 2020 206f 7574  e dophot.    out
+0000a0a0: 7075 7420 6361 7461 6c6f 6720 7573 696e  put catalog usin
+0000a0b0: 6720 7468 6520 636f 6c75 6d6e 7320 6669  g the columns fi
+0000a0c0: 746d 6167 2c20 6669 7473 6b79 2061 6e64  tmag, fitsky and
+0000a0d0: 2065 7272 5f66 6974 6d61 672e 0a0a 2020   err_fitmag...  
+0000a0e0: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+0000a0f0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+0000a100: 6669 746d 6167 203a 206e 702e 6172 7261  fitmag : np.arra
+0000a110: 790a 2020 2020 2020 2020 646f 7068 6f74  y.        dophot
+0000a120: 2063 6174 616c 6f67 2066 6974 6d61 6720   catalog fitmag 
+0000a130: 636f 6c75 6d6e 0a20 2020 2066 6974 736b  column.    fitsk
+0000a140: 7920 3a20 6e70 2e61 7272 6179 0a20 2020  y : np.array.   
+0000a150: 2020 2020 2064 6f70 686f 7420 6361 7461       dophot cata
+0000a160: 6c6f 6720 6669 7473 6b79 2063 6f6c 756d  log fitsky colum
+0000a170: 6e0a 2020 2020 6572 725f 6669 746d 6167  n.    err_fitmag
+0000a180: 203a 206e 702e 6172 7261 790a 2020 2020   : np.array.    
+0000a190: 2020 2020 646f 7068 6f74 2063 6174 616c      dophot catal
+0000a1a0: 6f67 2065 7272 5f66 6974 6d61 6720 636f  og err_fitmag co
+0000a1b0: 6c75 6d6e 0a20 2020 206d 6178 5f65 7272  lumn.    max_err
+0000a1c0: 203a 2066 6c6f 6174 0a20 2020 2020 2020   : float.       
+0000a1d0: 206d 6178 2076 616c 7565 206f 6620 6572   max value of er
+0000a1e0: 725f 6669 746d 6167 2073 656c 6563 7465  r_fitmag selecte
+0000a1f0: 6420 666f 7220 6c69 6e65 6172 2072 6567  d for linear reg
+0000a200: 7265 7373 696f 6e0a 2020 2020 7570 7065  ression.    uppe
+0000a210: 725f 6c69 6d69 7420 3a20 666c 6f61 740a  r_limit : float.
+0000a220: 2020 2020 2020 2020 7661 6c75 6520 6162          value ab
+0000a230: 6f76 6520 6c69 6e65 6172 2072 6567 7265  ove linear regre
+0000a240: 7373 696f 6e20 6c69 6d69 7469 6e67 2074  ssion limiting t
+0000a250: 6865 2073 7461 7220 636c 6173 7369 6669  he star classifi
+0000a260: 6361 7469 6f6e 0a0a 2020 2020 5265 7475  cation..    Retu
+0000a270: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+0000a280: 2020 2020 6e70 2e61 7272 6179 0a20 2020      np.array.   
+0000a290: 2020 2020 2073 7461 7266 6c61 6720 6172       starflag ar
+0000a2a0: 7261 7920 2831 2063 6c61 7373 6966 6965  ray (1 classifie
+0000a2b0: 6420 6173 2073 7461 722c 2030 206e 6f74  d as star, 0 not
+0000a2c0: 2063 6c61 7373 6966 6965 6429 0a20 2020   classified).   
+0000a2d0: 2022 2222 0a0a 2020 2020 6e72 6f77 7320   """..    nrows 
+0000a2e0: 3d20 6c65 6e28 6669 746d 6167 290a 0a20  = len(fitmag).. 
+0000a2f0: 2020 2023 2043 7265 6174 6520 666c 6167     # Create flag
+0000a300: 5f73 7461 7220 6172 7261 790a 2020 2020  _star array.    
+0000a310: 666c 6167 7374 6172 203d 206e 702e 7a65  flagstar = np.ze
+0000a320: 726f 7328 6e72 6f77 7329 0a0a 2020 2020  ros(nrows)..    
+0000a330: 2320 7365 6c65 6374 2070 6f69 6e74 7320  # select points 
+0000a340: 666f 7220 6669 740a 2020 2020 6630 203d  for fit.    f0 =
+0000a350: 2066 6974 736b 7920 3e20 300a 2020 2020   fitsky > 0.    
+0000a360: 6665 7272 203d 2065 7272 5f66 6974 6d61  ferr = err_fitma
+0000a370: 6720 3c20 6d61 785f 6572 720a 0a20 2020  g < max_err..   
+0000a380: 2023 2046 6978 2077 6865 6e20 6e6f 2070   # Fix when no p
+0000a390: 6f69 6e74 7320 6172 6520 7365 6c65 6374  oints are select
+0000a3a0: 6564 2077 6974 6869 6e20 7468 6973 2065  ed within this e
+0000a3b0: 7272 6f72 0a20 2020 204e 706f 696e 7473  rror.    Npoints
+0000a3c0: 203d 206c 656e 2866 6974 736b 795b 6630   = len(fitsky[f0
+0000a3d0: 2026 2066 6572 725d 290a 2020 2020 6966   & ferr]).    if
+0000a3e0: 204e 706f 696e 7473 203c 2033 303a 0a20   Npoints < 30:. 
+0000a3f0: 2020 2020 2020 206d 7367 203d 2028 6622         msg = (f"
+0000a400: 5365 6c65 6374 6564 206f 6e6c 7920 7b4e  Selected only {N
+0000a410: 706f 696e 7473 7d20 706f 696e 7473 2077  points} points w
+0000a420: 6974 6820 6572 725f 6669 746d 6167 203c  ith err_fitmag <
+0000a430: 207b 6d61 785f 6572 727d 2e20 220a 2020   {max_err}. ".  
+0000a440: 2020 2020 2020 2020 2020 2020 6622 5573              f"Us
+0000a450: 696e 6720 6d61 675f 6572 7220 3d20 7b31  ing mag_err = {1
+0000a460: 2e35 2a6d 6178 5f65 7272 7d20 696e 7374  .5*max_err} inst
+0000a470: 6561 642e 2229 0a20 2020 2020 2020 2077  ead.").        w
+0000a480: 6172 6e69 6e67 732e 7761 726e 286d 7367  arnings.warn(msg
+0000a490: 290a 0a20 2020 2020 2020 206d 6178 5f65  )..        max_e
+0000a4a0: 7272 203d 2031 2e35 2a6d 6178 5f65 7272  rr = 1.5*max_err
+0000a4b0: 0a20 2020 2020 2020 2066 6572 7220 3d20  .        ferr = 
+0000a4c0: 6572 725f 6669 746d 6167 203c 206d 6178  err_fitmag < max
+0000a4d0: 5f65 7272 0a0a 2020 2020 2320 4765 6e65  _err..    # Gene
+0000a4e0: 7261 7465 2078 2061 6e64 2079 0a20 2020  rate x and y.   
+0000a4f0: 2079 203d 206e 702e 6c6f 6731 3028 6669   y = np.log10(fi
+0000a500: 7473 6b79 5b66 3020 2620 6665 7272 5d29  tsky[f0 & ferr])
+0000a510: 0a20 2020 2078 203d 2066 6974 6d61 675b  .    x = fitmag[
+0000a520: 6630 2026 2066 6572 725d 0a0a 2020 2020  f0 & ferr]..    
+0000a530: 2320 4c69 6e65 6172 2066 6974 3a20 6c6f  # Linear fit: lo
+0000a540: 6731 3028 6669 7473 6b79 2920 3d20 6120  g10(fitsky) = a 
+0000a550: 2a20 6669 746d 6167 202b 2062 0a20 2020  * fitmag + b.   
+0000a560: 2061 2c20 6220 3d20 6e70 2e70 6f6c 7966   a, b = np.polyf
+0000a570: 6974 2878 2c20 792c 2031 290a 0a20 2020  it(x, y, 1)..   
+0000a580: 2023 2053 7461 7220 636c 6173 7369 6669   # Star classifi
+0000a590: 6361 7469 6f6e 0a20 2020 2073 656c 6563  cation.    selec
+0000a5a0: 7469 6f6e 203d 206e 702e 6c6f 6731 3028  tion = np.log10(
+0000a5b0: 6669 7473 6b79 5b66 305d 2920 3c20 2875  fitsky[f0]) < (u
+0000a5c0: 7070 6572 5f6c 696d 6974 202b 2061 2a66  pper_limit + a*f
+0000a5d0: 6974 6d61 675b 6630 5d20 2b20 6229 0a0a  itmag[f0] + b)..
+0000a5e0: 2020 2020 666c 6167 7374 6172 5b66 305d      flagstar[f0]
+0000a5f0: 203d 2073 656c 6563 7469 6f6e 2e61 7374   = selection.ast
+0000a600: 7970 6528 696e 7429 0a0a 2020 2020 2320  ype(int)..    # 
+0000a610: 416c 7365 2073 6574 2070 6f69 6e74 7320  Alse set points 
+0000a620: 7769 7468 2066 6974 736b 7920 3c20 3020  with fitsky < 0 
+0000a630: 6173 2073 7461 7273 0a20 2020 2066 6c61  as stars.    fla
+0000a640: 6773 7461 725b 7e66 305d 203d 2031 0a0a  gstar[~f0] = 1..
+0000a650: 2020 2020 7265 7475 726e 2066 6c61 6773      return flags
+0000a660: 7461 722e 6173 7479 7065 2869 6e74 290a  tar.astype(int).
+0000a670: 0a0a 6465 6620 666f 726d 6174 5f64 6f70  ..def format_dop
+0000a680: 686f 745f 6361 7461 6c6f 6728 6361 7461  hot_catalog(cata
+0000a690: 6c6f 675f 696e 2c20 6361 7461 6c6f 675f  log_in, catalog_
+0000a6a0: 6f75 742c 2069 6d61 6765 2c20 6669 6c74  out, image, filt
+0000a6b0: 203d 2027 6e61 6e27 2c0a 2020 2020 2020   = 'nan',.      
+0000a6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a6d0: 2020 2020 6669 656c 6420 3d20 274e 6f46      field = 'NoF
+0000a6e0: 6965 6c64 4e61 6d65 272c 2064 726e 616d  ieldName', drnam
+0000a6f0: 6520 3d20 274e 6f44 526e 616d 6527 293a  e = 'NoDRname'):
+0000a700: 0a20 2020 2022 2222 0a20 2020 2046 6f72  .    """.    For
+0000a710: 6d61 7473 2064 6f70 686f 7420 6f75 7470  mats dophot outp
+0000a720: 7574 2063 6174 616c 6f67 2069 6e74 6f20  ut catalog into 
+0000a730: 616e 2061 7363 6969 2074 6162 6c65 2c20  an ascii table, 
+0000a740: 6164 6469 6e67 2052 412c 2044 4543 2063  adding RA, DEC c
+0000a750: 6f6c 756d 6e73 0a20 2020 2061 6e64 2061  olumns.    and a
+0000a760: 6c73 6f20 636c 6173 7369 6669 6e67 2073  lso classifing s
+0000a770: 7461 7273 2028 636f 6c75 6d6e 2053 5441  tars (column STA
+0000a780: 525f 464c 4147 203d 2031 290a 0a20 2020  R_FLAG = 1)..   
+0000a790: 2049 7427 7320 616c 736f 206e 6563 6573   It's also neces
+0000a7a0: 7361 7279 2074 6f20 696e 7075 7420 7468  sary to input th
+0000a7b0: 6520 6c6f 6361 7469 6f6e 206f 6620 7468  e location of th
+0000a7c0: 6520 6669 656c 6427 7320 2e66 7a0a 2020  e field's .fz.  
+0000a7d0: 2020 696d 6167 652e 2054 6865 2057 4353    image. The WCS
+0000a7e0: 2064 6174 6120 6672 6f6d 2074 6865 2068   data from the h
+0000a7f0: 6561 6465 7220 6973 2075 7365 6420 746f  eader is used to
+0000a800: 2063 6f6e 7665 7274 2078 2c20 7920 636f   convert x, y co
+0000a810: 6f72 6469 6e61 7465 7320 746f 0a20 2020  ordinates to.   
+0000a820: 2052 4120 616e 6420 4445 432e 0a0a 2020   RA and DEC...  
+0000a830: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+0000a840: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+0000a850: 6361 7461 6c6f 675f 696e 203a 2073 7472  catalog_in : str
+0000a860: 0a20 2020 2020 2020 204c 6f63 6174 696f  .        Locatio
+0000a870: 6e20 6f66 2064 6f70 686f 7420 2e73 756d  n of dophot .sum
+0000a880: 2063 6174 616c 6f67 0a20 2020 2063 6174   catalog.    cat
+0000a890: 616c 6f67 5f6f 7574 203a 2073 7472 0a20  alog_out : str. 
+0000a8a0: 2020 2020 2020 2044 6573 6972 6564 206c         Desired l
+0000a8b0: 6f63 6174 696f 6e20 6f66 2074 6865 2066  ocation of the f
+0000a8c0: 6f72 6d61 7465 6420 6361 7461 6c6f 670a  ormated catalog.
+0000a8d0: 2020 2020 696d 6167 6520 3a20 7374 720a      image : str.
+0000a8e0: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
+0000a8f0: 206f 6620 532d 504c 5553 2066 6965 6c64   of S-PLUS field
+0000a900: 2069 6d61 6765 0a20 2020 2066 696c 7420   image.    filt 
+0000a910: 3a20 7374 720a 2020 2020 2020 2020 4e61  : str.        Na
+0000a920: 6d65 206f 6620 7468 6520 6669 6c74 6572  me of the filter
+0000a930: 0a20 2020 2066 6965 6c64 203a 2073 7472  .    field : str
+0000a940: 0a20 2020 2020 2020 204e 616d 6520 6f66  .        Name of
+0000a950: 2074 6865 2066 6965 6c64 2074 6f20 6265   the field to be
+0000a960: 2061 6464 6564 2074 6f20 7468 6520 6669   added to the fi
+0000a970: 6c74 6572 5f49 440a 2020 2020 6472 6e61  lter_ID.    drna
+0000a980: 6d65 203a 2073 7472 0a20 2020 2020 2020  me : str.       
+0000a990: 2044 6174 6120 7265 6c65 6173 6520 6465   Data release de
+0000a9a0: 7369 676e 6174 696f 6e20 746f 2062 6520  signation to be 
+0000a9b0: 6164 6465 6420 746f 2074 6865 2066 696c  added to the fil
+0000a9c0: 7465 725f 4944 0a20 2020 2073 6578 6d6f  ter_ID.    sexmo
+0000a9d0: 6465 203a 2073 7472 0a20 2020 2020 2020  de : str.       
+0000a9e0: 2064 7561 6c2f 7369 6e67 6c65 2053 4578   dual/single SEx
+0000a9f0: 7472 6163 746f 7220 6d6f 6465 2074 6f20  tractor mode to 
+0000aa00: 6265 2061 6464 6564 2074 6f20 7468 6520  be added to the 
+0000aa10: 6669 6c74 6572 5f49 440a 0a20 2020 2052  filter_ID..    R
+0000aa20: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
+0000aa30: 2d2d 0a20 2020 2053 6176 6573 2066 6f72  --.    Saves for
+0000aa40: 6d61 7465 6420 6361 7461 6c6f 6720 746f  mated catalog to
+0000aa50: 2074 6865 2070 6172 616d 3a63 6174 616c   the param:catal
+0000aa60: 6f67 5f6f 7574 206c 6f63 6174 696f 6e0a  og_out location.
+0000aa70: 2020 2020 2222 220a 0a20 2020 2064 6f70      """..    dop
+0000aa80: 686f 745f 636f 6c75 6d6e 5f6e 616d 6573  hot_column_names
+0000aa90: 203d 205b 2253 7461 725f 6e75 6d62 6572   = ["Star_number
+0000aaa0: 222c 2022 7870 6f73 222c 2022 7970 6f73  ", "xpos", "ypos
+0000aab0: 222c 2022 6669 746d 6167 222c 0a20 2020  ", "fitmag",.   
+0000aac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aad0: 2020 2020 2020 2020 2265 7272 5f66 6974          "err_fit
+0000aae0: 6d61 6722 2c20 2266 6974 736b 7922 2c20  mag", "fitsky", 
+0000aaf0: 226f 626a 7479 7065 222c 2022 6368 6922  "objtype", "chi"
+0000ab00: 2c20 2261 7063 6f72 7222 5d0a 0a20 2020  , "apcorr"]..   
+0000ab10: 2064 6f70 686f 745f 6461 7461 5f74 7970   dophot_data_typ
+0000ab20: 6573 203d 207b 2753 7461 725f 6e75 6d62  es = {'Star_numb
+0000ab30: 6572 273a 2069 6e74 2c20 2778 706f 7327  er': int, 'xpos'
+0000ab40: 3a20 666c 6f61 742c 2027 7970 6f73 273a  : float, 'ypos':
+0000ab50: 2066 6c6f 6174 2c0a 2020 2020 2020 2020   float,.        
+0000ab60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab70: 2027 6669 746d 6167 273a 2066 6c6f 6174   'fitmag': float
+0000ab80: 2c20 2765 7272 5f66 6974 6d61 6727 3a20  , 'err_fitmag': 
+0000ab90: 666c 6f61 742c 2027 6669 7473 6b79 273a  float, 'fitsky':
+0000aba0: 2066 6c6f 6174 2c0a 2020 2020 2020 2020   float,.        
+0000abb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000abc0: 2027 6f62 6a74 7970 6527 3a20 696e 742c   'objtype': int,
+0000abd0: 2027 6368 6927 3a20 666c 6f61 742c 2027   'chi': float, '
+0000abe0: 6170 636f 7272 273a 2066 6c6f 6174 7d0a  apcorr': float}.
+0000abf0: 0a20 2020 2063 6174 5f64 6174 6120 3d20  .    cat_data = 
+0000ac00: 7064 2e72 6561 645f 6373 7628 6361 7461  pd.read_csv(cata
+0000ac10: 6c6f 675f 696e 2c0a 2020 2020 2020 2020  log_in,.        
+0000ac20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac30: 2020 2073 6b69 7072 6f77 7320 3d20 332c     skiprows = 3,
+0000ac40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ac50: 2020 2020 2020 2020 2020 2020 6465 6c69              deli
+0000ac60: 6d5f 7768 6974 6573 7061 6365 203d 2054  m_whitespace = T
+0000ac70: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
 0000ac80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ac90: 2020 2020 2020 2020 6465 6c69 6d5f 7768          delim_wh
-0000aca0: 6974 6573 7061 6365 203d 2054 7275 652c  itespace = True,
-0000acb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000acc0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-0000acd0: 7320 3d20 646f 7068 6f74 5f63 6f6c 756d  s = dophot_colum
-0000ace0: 6e5f 6e61 6d65 732c 0a20 2020 2020 2020  n_names,.       
-0000acf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ad00: 2020 2020 6474 7970 6520 3d20 646f 7068      dtype = doph
-0000ad10: 6f74 5f64 6174 615f 7479 7065 7329 0a0a  ot_data_types)..
-0000ad20: 2020 2020 2320 4372 6561 7465 2066 696c      # Create fil
-0000ad30: 7465 7220 4944 0a20 2020 2023 2041 7373  ter ID.    # Ass
-0000ad40: 6967 6e20 6669 6c74 6572 2049 4473 0a20  ign filter IDs. 
-0000ad50: 2020 2064 6f70 686f 745f 6669 6c74 6572     dophot_filter
-0000ad60: 5f6e 756d 6265 7220 3d20 6361 745f 6461  _number = cat_da
-0000ad70: 7461 2e6c 6f63 5b3a 2c27 5374 6172 5f6e  ta.loc[:,'Star_n
-0000ad80: 756d 6265 7227 5d2e 7661 6c75 6573 0a0a  umber'].values..
-0000ad90: 2020 2020 6669 6c74 5f73 7461 6e64 6172      filt_standar
-0000ada0: 6420 3d20 7472 616e 736c 6174 655f 6669  d = translate_fi
-0000adb0: 6c74 6572 5f73 7461 6e64 6172 6428 6669  lter_standard(fi
-0000adc0: 6c74 290a 2020 2020 6669 6c74 6572 5f49  lt).    filter_I
-0000add0: 4420 3d20 5b66 277b 6472 6e61 6d65 7d5f  D = [f'{drname}_
-0000ade0: 7b66 6965 6c64 7d5f 7073 665f 7b66 696c  {field}_psf_{fil
-0000adf0: 745f 7374 616e 6461 7264 7d5f 7b69 3a30  t_standard}_{i:0
-0000ae00: 3764 7d27 0a20 2020 2020 2020 2020 2020  7d}'.           
-0000ae10: 2020 2020 2020 666f 7220 6920 696e 2064        for i in d
-0000ae20: 6f70 686f 745f 6669 6c74 6572 5f6e 756d  ophot_filter_num
-0000ae30: 6265 725d 0a0a 2020 2020 6361 745f 6461  ber]..    cat_da
-0000ae40: 7461 5b66 277b 6669 6c74 5f73 7461 6e64  ta[f'{filt_stand
-0000ae50: 6172 647d 5f49 445f 7073 6627 5d20 3d20  ard}_ID_psf'] = 
-0000ae60: 6669 6c74 6572 5f49 440a 0a20 2020 2023  filter_ID..    #
-0000ae70: 2049 6e63 6c75 6465 2052 4120 616e 6420   Include RA and 
-0000ae80: 4445 430a 2020 2020 7820 3d20 6361 745f  DEC.    x = cat_
-0000ae90: 6461 7461 2e6c 6f63 5b3a 2c20 2778 706f  data.loc[:, 'xpo
-0000aea0: 7327 5d2e 6172 7261 790a 2020 2020 7920  s'].array.    y 
-0000aeb0: 3d20 6361 745f 6461 7461 2e6c 6f63 5b3a  = cat_data.loc[:
-0000aec0: 2c20 2779 706f 7327 5d2e 6172 7261 790a  , 'ypos'].array.
-0000aed0: 0a20 2020 2023 2045 7874 7261 6374 2066  .    # Extract f
-0000aee0: 6965 6c64 2057 4353 2066 726f 6d20 696d  ield WCS from im
-0000aef0: 6167 6520 6865 6164 6572 0a20 2020 2068  age header.    h
-0000af00: 6561 6420 3d20 6669 7473 2e6f 7065 6e28  ead = fits.open(
-0000af10: 696d 6167 6529 5b31 5d2e 6865 6164 6572  image)[1].header
-0000af20: 0a20 2020 2063 6f6f 7264 5f77 6373 203d  .    coord_wcs =
-0000af30: 2057 4353 2868 6561 6429 0a0a 2020 2020   WCS(head)..    
-0000af40: 736b 7963 6f6f 7264 7320 3d20 7069 7865  skycoords = pixe
-0000af50: 6c5f 746f 5f73 6b79 636f 6f72 6428 782c  l_to_skycoord(x,
-0000af60: 2079 2c20 636f 6f72 645f 7763 732c 206f   y, coord_wcs, o
-0000af70: 7269 6769 6e3d 3129 0a0a 2020 2020 2320  rigin=1)..    # 
-0000af80: 4765 7420 7261 2061 6e64 2064 6563 2069  Get ra and dec i
-0000af90: 6e20 6465 6772 6565 730a 2020 2020 7261  n degrees.    ra
-0000afa0: 203d 206e 702e 6172 7261 7928 736b 7963   = np.array(skyc
-0000afb0: 6f6f 7264 732e 7261 290a 2020 2020 6465  oords.ra).    de
-0000afc0: 6320 3d20 6e70 2e61 7272 6179 2873 6b79  c = np.array(sky
-0000afd0: 636f 6f72 6473 2e64 6563 290a 0a20 2020  coords.dec)..   
-0000afe0: 2066 696c 745f 7374 616e 6461 7264 203d   filt_standard =
-0000aff0: 2074 7261 6e73 6c61 7465 5f66 696c 7465   translate_filte
-0000b000: 725f 7374 616e 6461 7264 2866 696c 7429  r_standard(filt)
-0000b010: 0a20 2020 2063 6174 5f64 6174 615b 6627  .    cat_data[f'
-0000b020: 5241 5f7b 6669 6c74 5f73 7461 6e64 6172  RA_{filt_standar
-0000b030: 647d 275d 203d 2072 610a 2020 2020 6361  d}'] = ra.    ca
-0000b040: 745f 6461 7461 5b66 2744 4543 5f7b 6669  t_data[f'DEC_{fi
-0000b050: 6c74 5f73 7461 6e64 6172 647d 275d 203d  lt_standard}'] =
-0000b060: 2064 6563 0a0a 2020 2020 666c 6167 7374   dec..    flagst
-0000b070: 6172 203d 2070 7366 5f66 6c61 6773 7461  ar = psf_flagsta
-0000b080: 7228 6669 746d 6167 203d 2063 6174 5f64  r(fitmag = cat_d
-0000b090: 6174 612e 6c6f 635b 3a2c 2766 6974 6d61  ata.loc[:,'fitma
-0000b0a0: 6727 5d2e 7661 6c75 6573 2c0a 2020 2020  g'].values,.    
-0000b0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b0c0: 2020 2020 2020 2020 6669 7473 6b79 203d          fitsky =
-0000b0d0: 2063 6174 5f64 6174 612e 6c6f 635b 3a2c   cat_data.loc[:,
-0000b0e0: 2766 6974 736b 7927 5d2e 7661 6c75 6573  'fitsky'].values
-0000b0f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000b100: 2020 2020 2020 2020 2020 2020 2020 6572                er
-0000b110: 725f 6669 746d 6167 203d 2063 6174 5f64  r_fitmag = cat_d
-0000b120: 6174 612e 6c6f 635b 3a2c 2027 6572 725f  ata.loc[:, 'err_
-0000b130: 6669 746d 6167 275d 2e76 616c 7565 7329  fitmag'].values)
-0000b140: 0a0a 2020 2020 6361 745f 6461 7461 5b27  ..    cat_data['
-0000b150: 464c 4147 5f53 5441 5227 5d20 3d20 666c  FLAG_STAR'] = fl
-0000b160: 6167 7374 6172 0a0a 2020 2020 7769 7468  agstar..    with
-0000b170: 206f 7065 6e28 6361 7461 6c6f 675f 6f75   open(catalog_ou
-0000b180: 742c 2027 7727 2920 6173 2066 3a0a 2020  t, 'w') as f:.  
-0000b190: 2020 2020 2020 662e 7772 6974 6528 2223        f.write("#
-0000b1a0: 2022 290a 2020 2020 2020 2020 6361 745f   ").        cat_
-0000b1b0: 6461 7461 2e74 6f5f 6373 7628 662c 2069  data.to_csv(f, i
-0000b1c0: 6e64 6578 203d 2046 616c 7365 2c20 7365  ndex = False, se
-0000b1d0: 7020 3d20 2220 2229 0a0a 0a64 6566 2070  p = " ")...def p
-0000b1e0: 6c6f 745f 646f 7068 6f74 5f64 6961 676e  lot_dophot_diagn
-0000b1f0: 6f73 7469 6328 6361 7461 6c6f 672c 2073  ostic(catalog, s
-0000b200: 6176 655f 6669 6c65 2c20 6669 6c74 2c20  ave_file, filt, 
-0000b210: 6d61 675f 6375 7420 3d20 2838 2c20 3232  mag_cut = (8, 22
-0000b220: 2929 3a0a 2020 2020 2222 220a 2020 2020  )):.    """.    
-0000b230: 4d61 6b65 7320 6469 6167 6e6f 7374 6963  Makes diagnostic
-0000b240: 2070 6c6f 7473 206f 6620 7468 6520 7068   plots of the ph
-0000b250: 6f74 6f6d 6574 7279 2069 6e20 6120 6769  otometry in a gi
-0000b260: 7665 6e20 444f 5048 4f54 206f 7574 7075  ven DOPHOT outpu
-0000b270: 740a 0a20 2020 2050 6172 616d 6574 6572  t..    Parameter
-0000b280: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-0000b290: 0a20 2020 2063 6174 616c 6f67 203a 2073  .    catalog : s
-0000b2a0: 7472 0a20 2020 2020 2020 204c 6f63 6174  tr.        Locat
-0000b2b0: 696f 6e20 6f66 2053 4578 7472 6163 746f  ion of SExtracto
-0000b2c0: 7220 6f75 7470 7574 2063 6174 616c 6f67  r output catalog
-0000b2d0: 0a20 2020 2073 6176 655f 6669 6c65 203a  .    save_file :
-0000b2e0: 2073 7472 0a20 2020 2020 2020 204c 6f63   str.        Loc
-0000b2f0: 6174 696f 6e20 746f 2073 6176 6520 706c  ation to save pl
-0000b300: 6f74 730a 2020 2020 6669 6c74 203a 2073  ots.    filt : s
-0000b310: 7472 0a20 2020 2020 2020 204e 616d 6520  tr.        Name 
-0000b320: 6f66 2074 6865 2070 686f 746f 6d65 7472  of the photometr
-0000b330: 6963 2066 696c 7465 720a 2020 2020 6d61  ic filter.    ma
-0000b340: 675f 6375 7420 3a20 6c69 7374 0a20 2020  g_cut : list.   
-0000b350: 2020 2020 204c 696d 6974 696e 6720 6d61       Limiting ma
-0000b360: 676e 6974 7564 6573 2028 6d69 6e2c 206d  gnitudes (min, m
-0000b370: 6178 290a 0a20 2020 2052 6574 7572 6e73  ax)..    Returns
-0000b380: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-0000b390: 2053 6176 6573 2064 6961 676e 6f73 7469   Saves diagnosti
-0000b3a0: 6320 706c 6f74 730a 2020 2020 2222 220a  c plots.    """.
-0000b3b0: 0a20 2020 2070 7366 6361 7420 3d20 6c6f  .    psfcat = lo
-0000b3c0: 6164 5f64 6174 6128 6361 7461 6c6f 6729  ad_data(catalog)
-0000b3d0: 0a0a 2020 2020 6669 672c 2061 7873 203d  ..    fig, axs =
-0000b3e0: 2070 6c74 2e73 7562 706c 6f74 7328 322c   plt.subplots(2,
-0000b3f0: 2066 6967 7369 7a65 203d 205b 352c 3130   figsize = [5,10
-0000b400: 5d29 0a0a 2020 2020 2323 2323 2323 2323  ])..    ########
-0000b410: 2323 2323 230a 2020 2020 2320 506c 6f74  #####.    # Plot
-0000b420: 2066 6974 736b 790a 0a20 2020 2023 2050   fitsky..    # P
-0000b430: 6c6f 7420 616c 6c20 706f 696e 7473 0a20  lot all points. 
-0000b440: 2020 2061 7873 5b30 5d2e 7363 6174 7465     axs[0].scatte
-0000b450: 7228 7073 6663 6174 5b27 6669 746d 6167  r(psfcat['fitmag
-0000b460: 275d 2c20 7073 6663 6174 5b27 6669 7473  '], psfcat['fits
-0000b470: 6b79 275d 2c0a 2020 2020 2020 2020 2020  ky'],.          
-0000b480: 2020 2020 2020 2020 2063 3d22 2341 4141           c="#AAA
-0000b490: 4141 4122 2c20 733d 3130 2c20 616c 7068  AAA", s=10, alph
-0000b4a0: 613d 302e 3129 0a0a 2020 2020 2320 506c  a=0.1)..    # Pl
-0000b4b0: 6f74 2073 656c 6563 7469 6f6e 0a20 2020  ot selection.   
-0000b4c0: 2066 203d 2070 7366 6361 745b 2746 4c41   f = psfcat['FLA
-0000b4d0: 475f 5354 4152 275d 203d 3d20 310a 2020  G_STAR'] == 1.  
-0000b4e0: 2020 6178 735b 305d 2e73 6361 7474 6572    axs[0].scatter
-0000b4f0: 2870 7366 6361 745b 2766 6974 6d61 6727  (psfcat['fitmag'
-0000b500: 5d5b 665d 2c20 7073 6663 6174 5b27 6669  ][f], psfcat['fi
-0000b510: 7473 6b79 275d 5b66 5d2c 0a20 2020 2020  tsky'][f],.     
-0000b520: 2020 2020 2020 2020 2020 2020 2020 633d                c=
-0000b530: 2223 3232 3636 4646 222c 2073 3d31 302c  "#2266FF", s=10,
-0000b540: 2061 6c70 6861 3d30 2e33 2c0a 2020 2020   alpha=0.3,.    
-0000b550: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0000b560: 6162 656c 3d66 2246 4c41 475f 5354 4152  abel=f"FLAG_STAR
-0000b570: 203d 2031 2229 0a0a 2020 2020 2320 506c   = 1")..    # Pl
-0000b580: 6f74 2067 7269 6420 6c69 6e65 730a 2020  ot grid lines.  
-0000b590: 2020 6178 735b 305d 2e68 6c69 6e65 7328    axs[0].hlines(
-0000b5a0: 6e70 2e61 7261 6e67 6528 302c 2031 3030  np.arange(0, 100
-0000b5b0: 3030 2c20 3130 3029 2c20 6d61 675f 6375  00, 100), mag_cu
-0000b5c0: 745b 305d 2c20 6d61 675f 6375 745b 315d  t[0], mag_cut[1]
-0000b5d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000b5e0: 2020 2020 636f 6c6f 7273 3d22 2345 4545      colors="#EEE
-0000b5f0: 4545 4522 2c20 7a6f 7264 6572 3d2d 3129  EEE", zorder=-1)
-0000b600: 0a0a 2020 2020 6178 735b 305d 2e6c 6567  ..    axs[0].leg
-0000b610: 656e 6428 6c6f 633d 3129 0a20 2020 2061  end(loc=1).    a
-0000b620: 7873 5b30 5d2e 7365 745f 786c 696d 286d  xs[0].set_xlim(m
-0000b630: 6167 5f63 7574 290a 2020 2020 6178 735b  ag_cut).    axs[
-0000b640: 305d 2e73 6574 5f79 6c69 6d28 5b2d 3530  0].set_ylim([-50
-0000b650: 2c20 3530 305d 290a 2020 2020 6178 735b  , 500]).    axs[
-0000b660: 305d 2e73 6574 5f79 6c61 6265 6c28 2766  0].set_ylabel('f
-0000b670: 6974 736b 7927 290a 2020 2020 6178 735b  itsky').    axs[
-0000b680: 305d 2e6d 696e 6f72 7469 636b 735f 6f6e  0].minorticks_on
-0000b690: 2829 0a0a 2020 2020 2323 2323 2323 2323  ()..    ########
-0000b6a0: 2323 2323 230a 2020 2020 2320 506c 6f74  #####.    # Plot
-0000b6b0: 2066 6974 6d61 670a 0a20 2020 2023 2050   fitmag..    # P
-0000b6c0: 6c6f 7420 616c 6c20 706f 696e 7473 0a20  lot all points. 
-0000b6d0: 2020 2061 7873 5b31 5d2e 7363 6174 7465     axs[1].scatte
-0000b6e0: 7228 7073 6663 6174 5b27 6669 746d 6167  r(psfcat['fitmag
-0000b6f0: 275d 2c20 7073 6663 6174 5b27 6572 725f  '], psfcat['err_
-0000b700: 6669 746d 6167 275d 2c0a 2020 2020 2020  fitmag'],.      
-0000b710: 2020 2020 2020 2020 2020 2020 2063 3d22               c="
-0000b720: 2341 4141 4141 4122 2c20 733d 3130 2c20  #AAAAAA", s=10, 
-0000b730: 616c 7068 613d 302e 3129 0a0a 2020 2020  alpha=0.1)..    
-0000b740: 2320 506c 6f74 2073 656c 6563 7469 6f6e  # Plot selection
-0000b750: 0a20 2020 2066 203d 2070 7366 6361 745b  .    f = psfcat[
-0000b760: 2746 4c41 475f 5354 4152 275d 203d 3d20  'FLAG_STAR'] == 
-0000b770: 310a 2020 2020 6178 735b 315d 2e73 6361  1.    axs[1].sca
-0000b780: 7474 6572 2870 7366 6361 745b 2766 6974  tter(psfcat['fit
-0000b790: 6d61 6727 5d5b 665d 2c20 7073 6663 6174  mag'][f], psfcat
-0000b7a0: 5b27 6572 725f 6669 746d 6167 275d 5b66  ['err_fitmag'][f
-0000b7b0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0000b7c0: 2020 2020 2020 633d 2223 3232 3636 4646        c="#2266FF
-0000b7d0: 222c 2073 3d31 302c 2061 6c70 6861 3d30  ", s=10, alpha=0
-0000b7e0: 2e33 2c0a 2020 2020 2020 2020 2020 2020  .3,.            
-0000b7f0: 2020 2020 2020 206c 6162 656c 3d66 2265         label=f"e
-0000b800: 7272 5f66 6974 6d61 6720 3c20 302e 3032  rr_fitmag < 0.02
-0000b810: 2229 0a0a 2020 2020 2320 506c 6f74 2063  ")..    # Plot c
-0000b820: 7574 206c 696e 650a 2020 2020 6178 735b  ut line.    axs[
-0000b830: 315d 2e68 6c69 6e65 7328 302e 3032 2c20  1].hlines(0.02, 
-0000b840: 6d61 675f 6375 745b 305d 2c20 6d61 675f  mag_cut[0], mag_
-0000b850: 6375 745b 315d 2c0a 2020 2020 2020 2020  cut[1],.        
-0000b860: 2020 2020 2020 2020 2020 636f 6c6f 7273            colors
-0000b870: 3d22 2332 3236 3646 4622 2c20 7a6f 7264  ="#2266FF", zord
-0000b880: 6572 3d31 290a 0a20 2020 2023 2050 6c6f  er=1)..    # Plo
-0000b890: 7420 6772 6964 206c 696e 6573 0a20 2020  t grid lines.   
-0000b8a0: 2061 7873 5b31 5d2e 686c 696e 6573 286e   axs[1].hlines(n
-0000b8b0: 702e 6172 616e 6765 2830 2c20 302e 322c  p.arange(0, 0.2,
-0000b8c0: 2030 2e30 3229 2c20 6d61 675f 6375 745b   0.02), mag_cut[
-0000b8d0: 305d 2c20 6d61 675f 6375 745b 315d 2c0a  0], mag_cut[1],.
-0000b8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b8f0: 2020 636f 6c6f 7273 3d22 2345 4545 4545    colors="#EEEEE
-0000b900: 4522 2c20 7a6f 7264 6572 3d2d 3129 0a0a  E", zorder=-1)..
-0000b910: 2020 2020 6178 735b 315d 2e73 6574 5f78      axs[1].set_x
-0000b920: 6c69 6d28 6d61 675f 6375 7429 0a20 2020  lim(mag_cut).   
-0000b930: 2061 7873 5b31 5d2e 7365 745f 796c 696d   axs[1].set_ylim
-0000b940: 285b 302c 2030 2e32 5d29 0a20 2020 2061  ([0, 0.2]).    a
-0000b950: 7873 5b31 5d2e 7365 745f 796c 6162 656c  xs[1].set_ylabel
-0000b960: 2827 6572 725f 6669 746d 6167 2729 0a20  ('err_fitmag'). 
-0000b970: 2020 2061 7873 5b31 5d2e 6d69 6e6f 7274     axs[1].minort
-0000b980: 6963 6b73 5f6f 6e28 290a 0a20 2020 2061  icks_on()..    a
-0000b990: 7873 5b31 5d2e 7365 745f 786c 6162 656c  xs[1].set_xlabel
-0000b9a0: 2866 227b 6669 6c74 7d5f 6669 746d 6167  (f"{filt}_fitmag
-0000b9b0: 205b 696e 7374 5d22 290a 0a20 2020 2070   [inst]")..    p
-0000b9c0: 6c74 2e73 7562 706c 6f74 735f 6164 6a75  lt.subplots_adju
-0000b9d0: 7374 286c 6566 743d 302e 3134 2c20 7269  st(left=0.14, ri
-0000b9e0: 6768 743d 302e 3938 2c20 746f 703d 302e  ght=0.98, top=0.
-0000b9f0: 3938 2c20 626f 7474 6f6d 3d30 2e30 362c  98, bottom=0.06,
-0000ba00: 2068 7370 6163 653d 302e 3129 0a0a 2020   hspace=0.1)..  
-0000ba10: 2020 706c 742e 7361 7665 6669 6728 7361    plt.savefig(sa
-0000ba20: 7665 5f66 696c 6529 0a20 2020 2070 6c74  ve_file).    plt
-0000ba30: 2e63 6c6f 7365 2866 6967 290a 0a23 2323  .close(fig)..###
-0000ba40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000ba50: 2323 2323 2323 2323 2323 2323 0a23 2043  ############.# C
-0000ba60: 6f72 7265 6374 696f 6e20 7879 0a0a 0a64  orrection xy...d
-0000ba70: 6566 2069 6e74 6572 7365 6374 696f 6e5f  ef intersection_
-0000ba80: 326c 696e 6573 2878 312c 2079 312c 2078  2lines(x1, y1, x
-0000ba90: 322c 2079 322c 2078 332c 2079 332c 2078  2, y2, x3, y3, x
-0000baa0: 342c 2079 3429 3a0a 0a20 2020 2022 2222  4, y4):..    """
-0000bab0: 0a20 2020 2052 6574 7572 6e73 2074 6865  .    Returns the
-0000bac0: 2069 6e74 6572 7365 6374 696f 6e20 6f66   intersection of
-0000bad0: 206c 696e 6520 4c31 2064 6566 696e 6564   line L1 defined
-0000bae0: 2062 7920 706f 696e 7473 2028 7831 2c79   by points (x1,y
-0000baf0: 3129 2c20 2878 322c 7932 292c 2061 6e64  1), (x2,y2), and
-0000bb00: 0a20 2020 206c 696e 6520 4c32 2064 6566  .    line L2 def
-0000bb10: 696e 6564 2062 7920 706f 696e 7473 2028  ined by points (
-0000bb20: 7833 2c79 3329 2c20 2878 342c 7934 290a  x3,y3), (x4,y4).
-0000bb30: 0a20 2020 2073 6565 2068 7474 7073 3a2f  .    see https:/
-0000bb40: 2f65 6e2e 7769 6b69 7065 6469 612e 6f72  /en.wikipedia.or
-0000bb50: 672f 7769 6b69 2f4c 696e 6525 4532 2538  g/wiki/Line%E2%8
-0000bb60: 3025 3933 6c69 6e65 5f69 6e74 6572 7365  0%93line_interse
-0000bb70: 6374 696f 6e0a 2020 2020 2222 220a 0a20  ction.    """.. 
-0000bb80: 2020 2044 203d 2028 7831 2d78 3229 2a28     D = (x1-x2)*(
-0000bb90: 7933 2d79 3429 202d 2028 7931 2d79 3229  y3-y4) - (y1-y2)
-0000bba0: 2a28 7833 2d78 3429 0a0a 2020 2020 7820  *(x3-x4)..    x 
-0000bbb0: 3d20 2820 2878 312a 7932 202d 2079 312a  = ( (x1*y2 - y1*
-0000bbc0: 7832 292a 2878 332d 7834 2920 2d20 2878  x2)*(x3-x4) - (x
-0000bbd0: 312d 7832 292a 2878 332a 7934 2d79 332a  1-x2)*(x3*y4-y3*
-0000bbe0: 7834 2920 2920 2f20 440a 0a20 2020 2079  x4) ) / D..    y
-0000bbf0: 203d 2028 2028 7831 2a79 3220 2d20 7931   = ( (x1*y2 - y1
-0000bc00: 2a78 3229 2a28 7933 2d79 3429 202d 2028  *x2)*(y3-y4) - (
-0000bc10: 7931 2d79 3229 2a28 7833 2a79 342d 7933  y1-y2)*(x3*y4-y3
-0000bc20: 2a78 3429 2029 202f 2044 0a0a 2020 2020  *x4) ) / D..    
-0000bc30: 7265 7475 726e 206e 702e 6172 7261 7928  return np.array(
-0000bc40: 5b78 2c20 795d 290a 0a0a 6465 6620 616c  [x, y])...def al
-0000bc50: 6967 6e5f 7370 6c75 735f 7879 2878 2c20  ign_splus_xy(x, 
-0000bc60: 792c 2063 656e 7465 7220 3d20 4e6f 6e65  y, center = None
-0000bc70: 2c20 6d61 7267 696e 203d 2031 3029 3a0a  , margin = 10):.
-0000bc80: 2020 2020 2222 220a 2020 2020 416c 6967      """.    Alig
-0000bc90: 6e73 2053 2d50 4c55 5320 582c 5920 636f  ns S-PLUS X,Y co
-0000bca0: 6f72 6469 6e61 7465 7320 6279 206d 6f76  ordinates by mov
-0000bcb0: 696e 6720 6f72 6967 696e 2074 6f20 626f  ing origin to bo
-0000bcc0: 7474 6f6d 206c 6566 7420 7665 7274 6963  ttom left vertic
-0000bcd0: 6520 616e 640a 2020 2020 726f 7461 7469  e and.    rotati
-0000bce0: 6e67 2074 6f20 6669 7420 7820 616e 6420  ng to fit x and 
-0000bcf0: 7920 6469 7265 6374 696f 6e73 0a0a 2020  y directions..  
-0000bd00: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-0000bd10: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-0000bd20: 7820 3a20 6172 7261 790a 2020 2020 2020  x : array.      
-0000bd30: 2020 6172 7261 7920 6f66 2058 5f49 4d41    array of X_IMA
-0000bd40: 4745 2076 616c 7565 730a 2020 2020 7920  GE values.    y 
-0000bd50: 3a20 6172 7261 790a 2020 2020 2020 2020  : array.        
-0000bd60: 6172 7261 7920 6f66 2059 5f49 4d41 4745  array of Y_IMAGE
-0000bd70: 2076 616c 7565 730a 2020 2020 6365 6e74   values.    cent
-0000bd80: 6572 203a 206c 6973 740a 2020 2020 2020  er : list.      
-0000bd90: 2020 6365 6e74 6572 2076 616c 7565 2069    center value i
-0000bda0: 6e20 7468 6520 666f 726d 6174 205b 7863  n the format [xc
-0000bdb0: 656e 7465 722c 2079 6365 6e74 6572 5d2e  enter, ycenter].
-0000bdc0: 2049 6620 4e6f 6e65 2c20 6365 6e74 6572   If None, center
-0000bdd0: 2069 730a 2020 2020 2020 2020 6361 6c63   is.        calc
-0000bde0: 756c 6174 6564 2066 726f 6d20 7468 6520  ulated from the 
-0000bdf0: 6176 6572 6167 6520 7820 616e 6420 7920  average x and y 
-0000be00: 7661 6c75 6573 0a20 2020 206d 6172 6769  values.    margi
-0000be10: 6e20 3a20 696e 740a 2020 2020 2020 2020  n : int.        
-0000be20: 6d61 7267 696e 2c20 696e 2070 6978 656c  margin, in pixel
-0000be30: 732c 2061 6464 6564 2074 6f20 7468 6520  s, added to the 
-0000be40: 6f72 6967 696e 0a0a 2020 2020 5265 7475  origin..    Retu
-0000be50: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-0000be60: 2020 2020 6172 7261 790a 2020 2020 2020      array.      
-0000be70: 2020 6172 7261 7920 6f66 2073 7175 6172    array of squar
-0000be80: 6520 7665 7274 6963 6573 2069 6e20 7468  e vertices in th
-0000be90: 6520 666f 726d 6174 3a0a 2020 2020 2020  e format:.      
-0000bea0: 2020 205b 5b78 5f62 6f74 746f 6d6c 6566     [[x_bottomlef
-0000beb0: 742c 2020 795f 626f 7474 6f6d 6c65 6674  t,  y_bottomleft
-0000bec0: 5d2c 0a20 2020 2020 2020 2020 205b 785f  ],.          [x_
-0000bed0: 626f 7474 6f6d 7269 6768 742c 2079 5f62  bottomright, y_b
-0000bee0: 6f74 746f 6d72 6967 6874 5d2c 0a20 2020  ottomright],.   
-0000bef0: 2020 2020 2020 205b 785f 746f 7072 6967         [x_toprig
-0000bf00: 6874 2c20 2020 2079 5f74 6f70 7269 6768  ht,    y_toprigh
-0000bf10: 745d 2c0a 2020 2020 2020 2020 2020 5b78  t],.          [x
-0000bf20: 5f74 6f70 6c65 6674 2c20 2020 2020 795f  _topleft,     y_
-0000bf30: 746f 706c 6566 745d 5d0a 0a20 2020 2022  topleft]]..    "
-0000bf40: 2222 0a20 2020 2023 2043 656e 7465 7220  "".    # Center 
-0000bf50: 636f 6f72 6469 6e61 7465 730a 2020 2020  coordinates.    
-0000bf60: 6966 2063 656e 7465 7220 6973 204e 6f6e  if center is Non
-0000bf70: 653a 0a20 2020 2020 2020 2078 3020 3d20  e:.        x0 = 
-0000bf80: 6e70 2e6e 616e 6d65 616e 2878 290a 2020  np.nanmean(x).  
-0000bf90: 2020 2020 2020 7930 203d 206e 702e 6e61        y0 = np.na
-0000bfa0: 6e6d 6561 6e28 7929 0a20 2020 2065 6c73  nmean(y).    els
-0000bfb0: 653a 0a20 2020 2020 2020 2078 3020 3d20  e:.        x0 = 
-0000bfc0: 6365 6e74 6572 5b30 5d0a 2020 2020 2020  center[0].      
-0000bfd0: 2020 7930 203d 2063 656e 7465 725b 315d    y0 = center[1]
-0000bfe0: 0a0a 2020 2020 2320 4465 6669 6e69 6e67  ..    # Defining
-0000bff0: 2071 7561 6472 616e 7473 3a20 2020 5134   quadrants:   Q4
-0000c000: 207c 2051 330a 2020 2020 2320 2020 2020   | Q3.    #     
-0000c010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c020: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 2320    -------.    # 
-0000c030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c040: 2020 2020 2020 5131 207c 2051 320a 0a20        Q1 | Q2.. 
-0000c050: 2020 2051 3120 3d20 2878 203c 2078 3029     Q1 = (x < x0)
-0000c060: 2026 2028 7920 3c20 7930 290a 2020 2020   & (y < y0).    
-0000c070: 5132 203d 2028 7820 3e20 7830 2920 2620  Q2 = (x > x0) & 
-0000c080: 2879 203c 2079 3029 0a20 2020 2051 3320  (y < y0).    Q3 
-0000c090: 3d20 2878 203e 2078 3029 2026 2028 7920  = (x > x0) & (y 
-0000c0a0: 3e20 7930 290a 2020 2020 5134 203d 2028  > y0).    Q4 = (
-0000c0b0: 7820 3c20 7830 2920 2620 2879 203e 2079  x < x0) & (y > y
-0000c0c0: 3029 0a0a 2020 2020 2320 4669 6e64 696e  0)..    # Findin
-0000c0d0: 6720 706f 696e 7473 2069 6e20 6c65 6674  g points in left
-0000c0e0: 2061 6e64 2072 6967 6874 2073 6964 6573   and right sides
-0000c0f0: 2061 6e64 2062 6f74 746f 6d0a 0a20 2020   and bottom..   
-0000c100: 2078 316c 203d 2078 5b51 315d 5b20 785b   x1l = x[Q1][ x[
-0000c110: 5131 5d20 3d3d 206e 702e 6e61 6e6d 696e  Q1] == np.nanmin
-0000c120: 2878 5b51 315d 2920 5d5b 305d 2020 2320  (x[Q1]) ][0]  # 
-0000c130: 7820 6f66 206c 6566 7420 6d6f 7374 2070  x of left most p
-0000c140: 6f69 6e74 2069 6e20 5131 0a20 2020 2079  oint in Q1.    y
-0000c150: 316c 203d 2079 5b51 315d 5b20 785b 5131  1l = y[Q1][ x[Q1
-0000c160: 5d20 3d3d 206e 702e 6e61 6e6d 696e 2878  ] == np.nanmin(x
-0000c170: 5b51 315d 2920 5d5b 305d 2020 2320 7920  [Q1]) ][0]  # y 
-0000c180: 6f66 206c 6566 7420 6d6f 7374 2070 6f69  of left most poi
-0000c190: 6e74 2069 6e20 5131 0a0a 2020 2020 7831  nt in Q1..    x1
-0000c1a0: 6220 3d20 785b 5131 5d5b 2079 5b51 315d  b = x[Q1][ y[Q1]
-0000c1b0: 203d 3d20 6e70 2e6e 616e 6d69 6e28 795b   == np.nanmin(y[
-0000c1c0: 5131 5d29 205d 5b30 5d0a 2020 2020 7931  Q1]) ][0].    y1
-0000c1d0: 6220 3d20 795b 5131 5d5b 2079 5b51 315d  b = y[Q1][ y[Q1]
-0000c1e0: 203d 3d20 6e70 2e6e 616e 6d69 6e28 795b   == np.nanmin(y[
-0000c1f0: 5131 5d29 205d 5b30 5d0a 0a20 2020 2078  Q1]) ][0]..    x
-0000c200: 3272 203d 2078 5b51 325d 5b20 785b 5132  2r = x[Q2][ x[Q2
-0000c210: 5d20 3d3d 206e 702e 6e61 6e6d 6178 2878  ] == np.nanmax(x
-0000c220: 5b51 325d 2920 5d5b 305d 0a20 2020 2079  [Q2]) ][0].    y
-0000c230: 3272 203d 2079 5b51 325d 5b20 785b 5132  2r = y[Q2][ x[Q2
-0000c240: 5d20 3d3d 206e 702e 6e61 6e6d 6178 2878  ] == np.nanmax(x
-0000c250: 5b51 325d 2920 5d5b 305d 0a0a 2020 2020  [Q2]) ][0]..    
-0000c260: 7832 6220 3d20 785b 5132 5d5b 2079 5b51  x2b = x[Q2][ y[Q
-0000c270: 325d 203d 3d20 6e70 2e6e 616e 6d69 6e28  2] == np.nanmin(
-0000c280: 795b 5132 5d29 205d 5b30 5d0a 2020 2020  y[Q2]) ][0].    
-0000c290: 7932 6220 3d20 795b 5132 5d5b 2079 5b51  y2b = y[Q2][ y[Q
-0000c2a0: 325d 203d 3d20 6e70 2e6e 616e 6d69 6e28  2] == np.nanmin(
-0000c2b0: 795b 5132 5d29 205d 5b30 5d0a 0a20 2020  y[Q2]) ][0]..   
-0000c2c0: 2078 3372 203d 2078 5b51 335d 5b20 785b   x3r = x[Q3][ x[
-0000c2d0: 5133 5d20 3d3d 206e 702e 6e61 6e6d 6178  Q3] == np.nanmax
-0000c2e0: 2878 5b51 335d 2920 5d5b 305d 0a20 2020  (x[Q3]) ][0].   
-0000c2f0: 2079 3372 203d 2079 5b51 335d 5b20 785b   y3r = y[Q3][ x[
-0000c300: 5133 5d20 3d3d 206e 702e 6e61 6e6d 6178  Q3] == np.nanmax
-0000c310: 2878 5b51 335d 2920 5d5b 305d 0a0a 2020  (x[Q3]) ][0]..  
-0000c320: 2020 7834 6c20 3d20 785b 5134 5d5b 2078    x4l = x[Q4][ x
-0000c330: 5b51 345d 203d 3d20 6e70 2e6e 616e 6d69  [Q4] == np.nanmi
-0000c340: 6e28 785b 5134 5d29 205d 5b30 5d0a 2020  n(x[Q4]) ][0].  
-0000c350: 2020 7934 6c20 3d20 795b 5134 5d5b 2078    y4l = y[Q4][ x
-0000c360: 5b51 345d 203d 3d20 6e70 2e6e 616e 6d69  [Q4] == np.nanmi
-0000c370: 6e28 785b 5134 5d29 205d 5b30 5d0a 0a20  n(x[Q4]) ][0].. 
-0000c380: 2020 2023 2062 6f74 746f 6d2d 6c65 6674     # bottom-left
-0000c390: 2076 6572 7469 6365 0a20 2020 2076 626c   vertice.    vbl
-0000c3a0: 203d 2069 6e74 6572 7365 6374 696f 6e5f   = intersection_
-0000c3b0: 326c 696e 6573 2878 313d 7831 622c 2079  2lines(x1=x1b, y
-0000c3c0: 313d 7931 622c 2078 323d 7832 622c 2079  1=y1b, x2=x2b, y
-0000c3d0: 323d 7932 622c 0a20 2020 2020 2020 2020  2=y2b,.         
-0000c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c3f0: 2020 2020 2078 333d 7831 6c2c 2079 333d       x3=x1l, y3=
-0000c400: 7931 6c2c 2078 343d 7834 6c2c 2079 343d  y1l, x4=x4l, y4=
-0000c410: 7934 6c29 0a0a 2020 2020 2320 626f 7474  y4l)..    # bott
-0000c420: 6f6d 2d72 6967 6874 2076 6572 7469 6365  om-right vertice
-0000c430: 0a20 2020 2076 6272 203d 2069 6e74 6572  .    vbr = inter
-0000c440: 7365 6374 696f 6e5f 326c 696e 6573 2878  section_2lines(x
-0000c450: 313d 7831 622c 2079 313d 7931 622c 2078  1=x1b, y1=y1b, x
-0000c460: 323d 7832 622c 2079 323d 7932 622c 0a20  2=x2b, y2=y2b,. 
-0000c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c480: 2020 2020 2020 2020 2020 2020 2078 333d               x3=
-0000c490: 7833 722c 2079 333d 7933 722c 2078 343d  x3r, y3=y3r, x4=
-0000c4a0: 7832 722c 2079 343d 7932 7229 0a0a 2020  x2r, y4=y2r)..  
-0000c4b0: 2020 2320 426f 7474 6f6d 2076 6563 746f    # Bottom vecto
-0000c4c0: 720a 2020 2020 7662 203d 2076 6272 202d  r.    vb = vbr -
-0000c4d0: 2076 626c 0a0a 2020 2020 2320 556e 6974   vbl..    # Unit
-0000c4e0: 2076 6563 746f 720a 2020 2020 756e 6974   vector.    unit
-0000c4f0: 5f76 6220 3d20 7662 202f 206e 702e 7371  _vb = vb / np.sq
-0000c500: 7274 286e 702e 7375 6d28 2876 622a 2a32  rt(np.sum((vb**2
-0000c510: 2929 290a 0a20 2020 2023 2041 6e67 6c65  )))..    # Angle
-0000c520: 0a20 2020 2064 6f74 5f70 726f 6475 6374  .    dot_product
-0000c530: 203d 206e 702e 646f 7428 756e 6974 5f76   = np.dot(unit_v
-0000c540: 622c 206e 702e 6172 7261 7928 5b31 2c20  b, np.array([1, 
-0000c550: 305d 2929 0a20 2020 2061 6e67 6c65 203d  0])).    angle =
-0000c560: 206e 702e 6172 6363 6f73 2864 6f74 5f70   np.arccos(dot_p
-0000c570: 726f 6475 6374 290a 0a20 2020 2023 204d  roduct)..    # M
-0000c580: 6f76 6520 6f72 6967 696e 2074 6f20 626f  ove origin to bo
-0000c590: 7474 6f6d 206c 6566 7420 7665 7274 6963  ttom left vertic
-0000c5a0: 650a 2020 2020 785f 7465 6d70 203d 2078  e.    x_temp = x
-0000c5b0: 202d 2076 626c 5b30 5d20 2d20 6d61 7267   - vbl[0] - marg
-0000c5c0: 696e 0a20 2020 2079 5f74 656d 7020 3d20  in.    y_temp = 
-0000c5d0: 7920 2d20 7662 6c5b 315d 202d 206d 6172  y - vbl[1] - mar
-0000c5e0: 6769 6e0a 0a20 2020 2023 2052 6f74 6174  gin..    # Rotat
-0000c5f0: 6520 746f 2061 6c69 676e 0a20 2020 2078  e to align.    x
-0000c600: 5f61 6c69 676e 203d 2078 5f74 656d 7020  _align = x_temp 
-0000c610: 2a20 6e70 2e63 6f73 2861 6e67 6c65 2920  * np.cos(angle) 
-0000c620: 2d20 795f 7465 6d70 202a 206e 702e 7369  - y_temp * np.si
-0000c630: 6e28 616e 676c 6529 0a20 2020 2079 5f61  n(angle).    y_a
-0000c640: 6c69 676e 203d 2078 5f74 656d 7020 2a20  lign = x_temp * 
-0000c650: 6e70 2e73 696e 2861 6e67 6c65 2920 2b20  np.sin(angle) + 
-0000c660: 795f 7465 6d70 202a 206e 702e 636f 7328  y_temp * np.cos(
-0000c670: 616e 676c 6529 0a0a 2020 2020 7265 7475  angle)..    retu
-0000c680: 726e 2078 5f61 6c69 676e 2c20 795f 616c  rn x_align, y_al
-0000c690: 6967 6e0a 0a0a 6465 6620 6669 785f 7879  ign...def fix_xy
-0000c6a0: 5f72 6f74 6174 696f 6e28 6361 7461 6c6f  _rotation(catalo
-0000c6b0: 672c 2073 6176 655f 6669 6c65 2c20 7863  g, save_file, xc
-0000c6c0: 6f6c 203d 2027 585f 494d 4147 4527 2c20  ol = 'X_IMAGE', 
-0000c6d0: 7963 6f6c 203d 2027 595f 494d 4147 4527  ycol = 'Y_IMAGE'
-0000c6e0: 293a 0a0a 2020 2020 6361 7420 3d20 6669  ):..    cat = fi
-0000c6f0: 7473 2e6f 7065 6e28 6361 7461 6c6f 6729  ts.open(catalog)
-0000c700: 0a20 2020 2063 6174 5f64 6174 6120 3d20  .    cat_data = 
-0000c710: 6361 745b 315d 2e64 6174 610a 0a20 2020  cat[1].data..   
-0000c720: 2078 203d 2063 6174 5f64 6174 612e 636f   x = cat_data.co
-0000c730: 6c75 6d6e 735b 7863 6f6c 5d2e 6172 7261  lumns[xcol].arra
-0000c740: 790a 2020 2020 7920 3d20 6361 745f 6461  y.    y = cat_da
-0000c750: 7461 2e63 6f6c 756d 6e73 5b79 636f 6c5d  ta.columns[ycol]
-0000c760: 2e61 7272 6179 0a0a 2020 2020 2320 4e6f  .array..    # No
-0000c770: 726d 616c 697a 6520 5820 616e 6420 590a  rmalize X and Y.
-0000c780: 2020 2020 785f 616c 6967 6e2c 2079 5f61      x_align, y_a
-0000c790: 6c69 676e 203d 2061 6c69 676e 5f73 706c  lign = align_spl
-0000c7a0: 7573 5f78 7928 782c 2079 290a 0a20 2020  us_xy(x, y)..   
-0000c7b0: 2023 2043 7265 6174 6520 6e65 7720 6669   # Create new fi
-0000c7c0: 7473 2063 6174 616c 6f67 2077 6974 6820  ts catalog with 
-0000c7d0: 6e65 7720 636f 6c75 6d6e 730a 2020 2020  new columns.    
-0000c7e0: 636f 7272 5f64 6174 6120 3d20 6361 745f  corr_data = cat_
-0000c7f0: 6461 7461 2e63 6f6c 756d 6e73 0a0a 2020  data.columns..  
-0000c800: 2020 636f 7272 5f64 6174 6120 2b3d 2066    corr_data += f
-0000c810: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
-0000c820: 2758 5f41 4c49 474e 272c 0a20 2020 2020  'X_ALIGN',.     
-0000c830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c840: 2020 2020 2020 2020 666f 726d 6174 3d27          format='
-0000c850: 3145 272c 0a20 2020 2020 2020 2020 2020  1E',.           
-0000c860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c870: 2020 6172 7261 793d 785f 616c 6967 6e29    array=x_align)
-0000c880: 0a0a 2020 2020 636f 7272 5f64 6174 6120  ..    corr_data 
-0000c890: 2b3d 2066 6974 732e 436f 6c75 6d6e 286e  += fits.Column(n
-0000c8a0: 616d 653d 2759 5f41 4c49 474e 272c 0a20  ame='Y_ALIGN',. 
-0000c8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c8c0: 2020 2020 2020 2020 2020 2020 666f 726d              form
-0000c8d0: 6174 3d27 3145 272c 0a20 2020 2020 2020  at='1E',.       
-0000c8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c8f0: 2020 2020 2020 6172 7261 793d 795f 616c        array=y_al
-0000c900: 6967 6e29 0a0a 2020 2020 2320 5361 7665  ign)..    # Save
-0000c910: 2063 6f72 7265 6374 6564 2064 6174 6120   corrected data 
-0000c920: 746f 2073 6176 655f 6669 6c65 2066 6974  to save_file fit
-0000c930: 7320 6361 7461 6c6f 670a 2020 2020 6864  s catalog.    hd
-0000c940: 7520 3d20 6669 7473 2e42 696e 5461 626c  u = fits.BinTabl
-0000c950: 6548 4455 2e66 726f 6d5f 636f 6c75 6d6e  eHDU.from_column
-0000c960: 7328 636f 7272 5f64 6174 6129 0a20 2020  s(corr_data).   
-0000c970: 2068 6475 2e77 7269 7465 746f 2873 6176   hdu.writeto(sav
-0000c980: 655f 6669 6c65 290a 0a0a 6465 6620 6170  e_file)...def ap
-0000c990: 706c 795f 7879 5f63 6f72 7265 6374 696f  ply_xy_correctio
-0000c9a0: 6e28 6361 7461 6c6f 672c 2073 6176 655f  n(catalog, save_
-0000c9b0: 6669 6c65 2c20 6d61 705f 6669 6c65 2c20  file, map_file, 
-0000c9c0: 7862 696e 732c 2079 6269 6e73 293a 0a20  xbins, ybins):. 
-0000c9d0: 2020 2022 2222 0a20 2020 2041 7070 6c69     """.    Appli
-0000c9e0: 6573 2058 5920 636f 7272 6563 7469 6f6e  es XY correction
-0000c9f0: 7320 746f 2074 6865 2053 2d50 4c55 5320  s to the S-PLUS 
-0000ca00: 7068 6f74 6f6d 6574 7279 2063 6174 616c  photometry catal
-0000ca10: 6f67 732e 0a0a 2020 2020 436f 7272 6563  ogs...    Correc
-0000ca20: 7469 6f6e 2061 7265 2061 7070 6c69 6564  tion are applied
-0000ca30: 2074 6f20 616c 6c20 6669 7865 6420 6170   to all fixed ap
-0000ca40: 6572 7475 7265 2c20 6175 746f 2c20 7065  erture, auto, pe
-0000ca50: 7472 6f20 616e 6420 6973 6f20 6d61 676e  tro and iso magn
-0000ca60: 6974 7564 6573 0a20 2020 2061 6e64 2066  itudes.    and f
-0000ca70: 6c75 7865 7320 2869 6620 7072 6573 656e  luxes (if presen
-0000ca80: 7420 696e 2074 6865 2063 6174 616c 6f67  t in the catalog
-0000ca90: 7329 2e0a 0a20 2020 2054 776f 2061 6464  s)...    Two add
-0000caa0: 6974 696f 6e61 6c20 636f 6c75 6d6e 7320  itional columns 
-0000cab0: 6172 6520 6372 6561 7465 643a 2058 5f41  are created: X_A
-0000cac0: 4c49 474e 2061 6e64 2059 5f41 4c49 474e  LIGN and Y_ALIGN
-0000cad0: 2c20 636f 7272 6573 706f 6e64 696e 6720  , corresponding 
-0000cae0: 746f 0a20 2020 206e 6f72 6d61 6c69 7a65  to.    normalize
-0000caf0: 6420 585f 494d 4147 4520 616e 6420 595f  d X_IMAGE and Y_
-0000cb00: 494d 4147 4520 706f 7369 7469 6f6e 7320  IMAGE positions 
-0000cb10: 286f 7269 6769 6e20 6d6f 7665 6420 746f  (origin moved to
-0000cb20: 2062 6f74 746f 6d20 6c65 6674 0a20 2020   bottom left.   
-0000cb30: 2063 6f72 6e65 722c 2061 6e64 2063 6f6f   corner, and coo
-0000cb40: 7264 696e 6174 6573 2072 6f74 6174 6520  rdinates rotate 
-0000cb50: 746f 206d 6174 6368 2058 2061 6e64 2059  to match X and Y
-0000cb60: 2061 7869 7329 2e0a 0a20 2020 2050 6172   axis)...    Par
-0000cb70: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-0000cb80: 2d2d 2d2d 2d2d 0a20 2020 2063 6174 616c  ------.    catal
-0000cb90: 6f67 203a 2073 7472 0a20 2020 2020 2020  og : str.       
-0000cba0: 204c 6f63 6174 696f 6e20 746f 2074 6865   Location to the
-0000cbb0: 2053 4578 7472 6163 746f 7220 7068 6f74   SExtractor phot
-0000cbc0: 6f6d 6574 7279 206f 7574 7075 7420 6361  ometry output ca
-0000cbd0: 7461 6c6f 670a 0a20 2020 2073 6176 655f  talog..    save_
-0000cbe0: 6669 6c65 203a 2073 7472 0a20 2020 2020  file : str.     
-0000cbf0: 2020 2044 6573 6972 6564 206c 6f63 6174     Desired locat
-0000cc00: 696f 6e20 746f 2073 6176 6520 7468 6520  ion to save the 
-0000cc10: 5859 2063 6f72 7265 6374 6564 2063 6174  XY corrected cat
-0000cc20: 616c 6f67 0a0a 2020 2020 6d61 705f 6669  alog..    map_fi
-0000cc30: 6c65 203a 2073 7472 0a20 2020 2020 2020  le : str.       
-0000cc40: 204c 6f63 6174 696f 6e20 6f66 2074 6865   Location of the
-0000cc50: 2078 7920 636f 7272 6563 7469 6f6e 206d   xy correction m
-0000cc60: 6170 2028 6d75 7374 2062 6520 6e75 6d70  ap (must be nump
-0000cc70: 7920 6e70 7920 6669 6c65 290a 0a20 2020  y npy file)..   
-0000cc80: 2078 6269 6e73 203a 206c 6973 740a 2020   xbins : list.  
-0000cc90: 2020 2020 2020 7862 696e 7320 6f66 2074        xbins of t
-0000cca0: 6865 2063 6f72 7265 6374 696f 6e20 6d61  he correction ma
-0000ccb0: 7020 2873 7461 7274 2c20 656e 642c 204e  p (start, end, N
-0000ccc0: 6269 6e73 2920 5b69 6e20 7069 7865 6c73  bins) [in pixels
-0000ccd0: 5d0a 0a20 2020 2079 6269 6e73 203a 206c  ]..    ybins : l
-0000cce0: 6973 740a 2020 2020 2020 2020 7962 696e  ist.        ybin
-0000ccf0: 7320 6f66 2074 6865 2063 6f72 7265 6374  s of the correct
-0000cd00: 696f 6e20 6d61 7020 2873 7461 7274 2c20  ion map (start, 
-0000cd10: 656e 642c 204e 6269 6e73 2920 5b69 6e20  end, Nbins) [in 
-0000cd20: 7069 7865 6c73 5d0a 0a20 2020 2052 6574  pixels]..    Ret
-0000cd30: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
-0000cd40: 0a20 2020 2053 6176 6573 2058 5920 636f  .    Saves XY co
-0000cd50: 7272 6563 7465 6420 6361 7461 6c6f 6720  rrected catalog 
-0000cd60: 696e 2074 6865 2064 6573 6972 6564 206c  in the desired l
-0000cd70: 6f63 6174 696f 6e20 2870 6172 616d 3a73  ocation (param:s
-0000cd80: 6176 655f 6669 6c65 290a 2020 2020 2222  ave_file).    ""
-0000cd90: 220a 0a20 2020 2063 6174 203d 2066 6974  "..    cat = fit
-0000cda0: 732e 6f70 656e 2863 6174 616c 6f67 290a  s.open(catalog).
-0000cdb0: 2020 2020 6361 745f 6461 7461 203d 2063      cat_data = c
-0000cdc0: 6174 5b31 5d2e 6461 7461 0a0a 2020 2020  at[1].data..    
-0000cdd0: 7820 3d20 6361 745f 6461 7461 2e63 6f6c  x = cat_data.col
-0000cde0: 756d 6e73 5b27 585f 494d 4147 4527 5d2e  umns['X_IMAGE'].
-0000cdf0: 6172 7261 790a 2020 2020 7920 3d20 6361  array.    y = ca
-0000ce00: 745f 6461 7461 2e63 6f6c 756d 6e73 5b27  t_data.columns['
-0000ce10: 595f 494d 4147 4527 5d2e 6172 7261 790a  Y_IMAGE'].array.
-0000ce20: 0a20 2020 2023 204e 6f72 6d61 6c69 7a65  .    # Normalize
-0000ce30: 2058 2061 6e64 2059 0a20 2020 2078 5f61   X and Y.    x_a
-0000ce40: 6c69 676e 2c20 795f 616c 6967 6e20 3d20  lign, y_align = 
-0000ce50: 616c 6967 6e5f 7370 6c75 735f 7879 2878  align_splus_xy(x
-0000ce60: 2c20 7929 0a0a 2020 2020 2320 4372 6561  , y)..    # Crea
-0000ce70: 7465 206e 6577 2066 6974 7320 6361 7461  te new fits cata
-0000ce80: 6c6f 6720 7769 7468 206e 6577 2063 6f6c  log with new col
-0000ce90: 756d 6e73 0a20 2020 2063 6f72 725f 6461  umns.    corr_da
-0000cea0: 7461 203d 2063 6174 5f64 6174 612e 636f  ta = cat_data.co
-0000ceb0: 6c75 6d6e 730a 0a20 2020 2063 6f72 725f  lumns..    corr_
-0000cec0: 6461 7461 202b 3d20 6669 7473 2e43 6f6c  data += fits.Col
-0000ced0: 756d 6e28 6e61 6d65 3d27 585f 414c 4947  umn(name='X_ALIG
-0000cee0: 4e27 2c0a 2020 2020 2020 2020 2020 2020  N',.            
-0000cef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf00: 2066 6f72 6d61 743d 2731 4527 2c0a 2020   format='1E',.  
-0000cf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf20: 2020 2020 2020 2020 2020 2061 7272 6179             array
-0000cf30: 3d78 5f61 6c69 676e 290a 0a20 2020 2063  =x_align)..    c
-0000cf40: 6f72 725f 6461 7461 202b 3d20 6669 7473  orr_data += fits
-0000cf50: 2e43 6f6c 756d 6e28 6e61 6d65 3d27 595f  .Column(name='Y_
-0000cf60: 414c 4947 4e27 2c0a 2020 2020 2020 2020  ALIGN',.        
-0000cf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cf80: 2020 2020 2066 6f72 6d61 743d 2731 4527       format='1E'
-0000cf90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000cfa0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000cfb0: 7272 6179 3d79 5f61 6c69 676e 290a 0a20  rray=y_align).. 
-0000cfc0: 2020 2023 2050 7265 7061 7265 2062 696e     # Prepare bin
-0000cfd0: 730a 2020 2020 7862 696e 735f 6772 6964  s.    xbins_grid
-0000cfe0: 203d 206e 702e 6c69 6e73 7061 6365 2878   = np.linspace(x
-0000cff0: 6269 6e73 5b30 5d2c 2078 6269 6e73 5b31  bins[0], xbins[1
-0000d000: 5d2c 2069 6e74 2878 6269 6e73 5b32 5d29  ], int(xbins[2])
-0000d010: 202b 2031 290a 2020 2020 7962 696e 735f   + 1).    ybins_
-0000d020: 6772 6964 203d 206e 702e 6c69 6e73 7061  grid = np.linspa
-0000d030: 6365 2879 6269 6e73 5b30 5d2c 2079 6269  ce(ybins[0], ybi
-0000d040: 6e73 5b31 5d2c 2069 6e74 2879 6269 6e73  ns[1], int(ybins
-0000d050: 5b32 5d29 202b 2031 290a 0a20 2020 2078  [2]) + 1)..    x
-0000d060: 6269 6e73 5f69 6420 3d20 6e70 2e61 7272  bins_id = np.arr
-0000d070: 6179 2872 616e 6765 2869 6e74 2878 6269  ay(range(int(xbi
-0000d080: 6e73 5b32 5d29 202b 2031 2929 0a20 2020  ns[2]) + 1)).   
-0000d090: 2079 6269 6e73 5f69 6420 3d20 6e70 2e61   ybins_id = np.a
-0000d0a0: 7272 6179 2872 616e 6765 2869 6e74 2879  rray(range(int(y
-0000d0b0: 6269 6e73 5b32 5d29 202b 2031 2929 0a0a  bins[2]) + 1))..
-0000d0c0: 2020 2020 2320 4c6f 6164 2063 6f72 7265      # Load corre
-0000d0d0: 6374 696f 6e73 0a20 2020 2063 6f72 7265  ctions.    corre
-0000d0e0: 6374 696f 6e73 203d 206e 702e 6c6f 6164  ctions = np.load
-0000d0f0: 286d 6170 5f66 696c 6529 0a0a 2020 2020  (map_file)..    
-0000d100: 2320 4170 706c 7920 636f 7272 6563 7469  # Apply correcti
-0000d110: 6f6e 730a 2020 2020 666f 7220 6b20 696e  ons.    for k in
-0000d120: 2072 616e 6765 286c 656e 2863 6174 5f64   range(len(cat_d
-0000d130: 6174 6129 293a 0a20 2020 2020 2020 2078  ata)):.        x
-0000d140: 5f73 6f75 7263 6520 3d20 785f 616c 6967  _source = x_alig
-0000d150: 6e5b 6b5d 0a20 2020 2020 2020 2079 5f73  n[k].        y_s
-0000d160: 6f75 7263 6520 3d20 795f 616c 6967 6e5b  ource = y_align[
-0000d170: 6b5d 0a0a 2020 2020 2020 2020 2320 4765  k]..        # Ge
-0000d180: 7420 6465 6c74 6120 6d61 6720 2869 6620  t delta mag (if 
-0000d190: 6769 7665 6e20 6f6e 2074 6865 2063 6f72  given on the cor
-0000d1a0: 7265 6374 696f 6e20 6d61 7020 666f 7220  rection map for 
-0000d1b0: 7468 6973 2070 6f73 6974 696f 6e29 0a20  this position). 
-0000d1c0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0000d1d0: 2020 2020 2020 2020 2320 4669 6e64 2069          # Find i
-0000d1e0: 6473 206f 6620 7468 6520 6269 6e20 7468  ds of the bin th
-0000d1f0: 6174 2063 6f6e 7461 696e 7320 7468 6520  at contains the 
-0000d200: 736f 7572 6365 0a20 2020 2020 2020 2020  source.         
-0000d210: 2020 2062 696e 5f73 6f75 7263 655f 6920     bin_source_i 
-0000d220: 3d20 7862 696e 735f 6964 5b78 6269 6e73  = xbins_id[xbins
-0000d230: 5f67 7269 6420 3c3d 2078 5f73 6f75 7263  _grid <= x_sourc
-0000d240: 655d 5b2d 315d 0a20 2020 2020 2020 2020  e][-1].         
-0000d250: 2020 2062 696e 5f73 6f75 7263 655f 6a20     bin_source_j 
-0000d260: 3d20 7962 696e 735f 6964 5b79 6269 6e73  = ybins_id[ybins
-0000d270: 5f67 7269 6420 3c3d 2079 5f73 6f75 7263  _grid <= y_sourc
-0000d280: 655d 5b2d 315d 0a0a 2020 2020 2020 2020  e][-1]..        
-0000d290: 2020 2020 6465 6c74 615f 6d61 6720 3d20      delta_mag = 
-0000d2a0: 636f 7272 6563 7469 6f6e 735b 6269 6e5f  corrections[bin_
-0000d2b0: 736f 7572 6365 5f69 2c20 6269 6e5f 736f  source_i, bin_so
-0000d2c0: 7572 6365 5f6a 5d0a 2020 2020 2020 2020  urce_j].        
-0000d2d0: 2020 2020 6465 6c74 615f 666c 7578 5f66      delta_flux_f
-0000d2e0: 7261 6320 3d20 3130 2e30 202a 2a20 282d  rac = 10.0 ** (-
-0000d2f0: 2864 656c 7461 5f6d 6167 202f 2032 2e35  (delta_mag / 2.5
-0000d300: 2929 0a0a 2020 2020 2020 2020 6578 6365  ))..        exce
-0000d310: 7074 2049 6e64 6578 4572 726f 723a 0a20  pt IndexError:. 
-0000d320: 2020 2020 2020 2020 2020 2064 656c 7461             delta
-0000d330: 5f6d 6167 203d 2030 0a20 2020 2020 2020  _mag = 0.       
-0000d340: 2020 2020 2064 656c 7461 5f66 6c75 785f       delta_flux_
-0000d350: 6672 6163 203d 2031 0a0a 2020 2020 2020  frac = 1..      
-0000d360: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0000d370: 2020 2069 6620 636f 7272 5f64 6174 615b     if corr_data[
-0000d380: 274d 4147 5f41 5554 4f27 5d2e 6172 7261  'MAG_AUTO'].arra
-0000d390: 795b 6b5d 2021 3d20 3939 3a0a 2020 2020  y[k] != 99:.    
-0000d3a0: 2020 2020 2020 2020 2020 2020 636f 7272              corr
-0000d3b0: 5f64 6174 615b 274d 4147 5f41 5554 4f27  _data['MAG_AUTO'
-0000d3c0: 5d2e 6172 7261 795b 6b5d 202b 3d20 6465  ].array[k] += de
-0000d3d0: 6c74 615f 6d61 670a 2020 2020 2020 2020  lta_mag.        
-0000d3e0: 2020 2020 636f 7272 5f64 6174 615b 2746      corr_data['F
-0000d3f0: 4c55 585f 4155 544f 275d 2e61 7272 6179  LUX_AUTO'].array
-0000d400: 5b6b 5d20 2a3d 2064 656c 7461 5f66 6c75  [k] *= delta_flu
-0000d410: 785f 6672 6163 0a20 2020 2020 2020 2065  x_frac.        e
-0000d420: 7863 6570 7420 4b65 7945 7272 6f72 3a0a  xcept KeyError:.
-0000d430: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-0000d440: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
-0000d450: 2020 2020 2020 2020 2020 2069 6620 636f             if co
-0000d460: 7272 5f64 6174 615b 274d 4147 5f49 534f  rr_data['MAG_ISO
-0000d470: 275d 2e61 7272 6179 5b6b 5d20 213d 2039  '].array[k] != 9
-0000d480: 393a 0a20 2020 2020 2020 2020 2020 2020  9:.             
-0000d490: 2020 2063 6f72 725f 6461 7461 5b27 4d41     corr_data['MA
-0000d4a0: 475f 4953 4f27 5d2e 6172 7261 795b 6b5d  G_ISO'].array[k]
-0000d4b0: 202b 3d20 6465 6c74 615f 6d61 670a 2020   += delta_mag.  
-0000d4c0: 2020 2020 2020 2020 2020 636f 7272 5f64            corr_d
-0000d4d0: 6174 615b 2746 4c55 585f 4953 4f27 5d2e  ata['FLUX_ISO'].
-0000d4e0: 6172 7261 795b 6b5d 202a 3d20 6465 6c74  array[k] *= delt
-0000d4f0: 615f 666c 7578 5f66 7261 630a 2020 2020  a_flux_frac.    
-0000d500: 2020 2020 6578 6365 7074 204b 6579 4572      except KeyEr
-0000d510: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-0000d520: 2070 6173 730a 0a20 2020 2020 2020 2074   pass..        t
-0000d530: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000d540: 6966 2063 6f72 725f 6461 7461 5b27 4d41  if corr_data['MA
-0000d550: 475f 5045 5452 4f27 5d2e 6172 7261 795b  G_PETRO'].array[
-0000d560: 6b5d 2021 3d20 3939 3a0a 2020 2020 2020  k] != 99:.      
-0000d570: 2020 2020 2020 2020 2020 636f 7272 5f64            corr_d
-0000d580: 6174 615b 274d 4147 5f50 4554 524f 275d  ata['MAG_PETRO']
-0000d590: 2e61 7272 6179 5b6b 5d20 2b3d 2064 656c  .array[k] += del
-0000d5a0: 7461 5f6d 6167 0a20 2020 2020 2020 2020  ta_mag.         
-0000d5b0: 2020 2063 6f72 725f 6461 7461 5b27 464c     corr_data['FL
-0000d5c0: 5558 5f50 4554 524f 275d 2e61 7272 6179  UX_PETRO'].array
-0000d5d0: 5b6b 5d20 2a3d 2064 656c 7461 5f66 6c75  [k] *= delta_flu
-0000d5e0: 785f 6672 6163 0a20 2020 2020 2020 2065  x_frac.        e
-0000d5f0: 7863 6570 7420 4b65 7945 7272 6f72 3a0a  xcept KeyError:.
-0000d600: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-0000d610: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
-0000d620: 2020 2020 2020 2020 2020 2066 203d 2063             f = c
-0000d630: 6f72 725f 6461 7461 5b27 4d41 475f 4150  orr_data['MAG_AP
-0000d640: 4552 275d 2e61 7272 6179 5b6b 5d20 213d  ER'].array[k] !=
-0000d650: 2039 390a 2020 2020 2020 2020 2020 2020   99.            
-0000d660: 636f 7272 5f64 6174 615b 274d 4147 5f41  corr_data['MAG_A
-0000d670: 5045 5227 5d2e 6172 7261 795b 6b5d 5b66  PER'].array[k][f
-0000d680: 5d20 2b3d 2064 656c 7461 5f6d 6167 0a20  ] += delta_mag. 
-0000d690: 2020 2020 2020 2020 2020 2063 6f72 725f             corr_
-0000d6a0: 6461 7461 5b27 464c 5558 5f41 5045 5227  data['FLUX_APER'
-0000d6b0: 5d2e 6172 7261 795b 6b5d 202a 3d20 6465  ].array[k] *= de
-0000d6c0: 6c74 615f 666c 7578 5f66 7261 630a 2020  lta_flux_frac.  
-0000d6d0: 2020 2020 2020 6578 6365 7074 204b 6579        except Key
-0000d6e0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-0000d6f0: 2020 2070 6173 730a 0a20 2020 2020 2020     pass..       
-0000d700: 2023 7472 793a 0a20 2020 2020 2020 2023   #try:.        #
-0000d710: 2020 2020 6620 3d20 636f 7272 5f64 6174      f = corr_dat
-0000d720: 615b 274d 4147 5f41 5045 5227 5d2e 6172  a['MAG_APER'].ar
-0000d730: 7261 795b 6b5d 2021 3d20 3939 0a20 2020  ray[k] != 99.   
+0000ac90: 6e61 6d65 7320 3d20 646f 7068 6f74 5f63  names = dophot_c
+0000aca0: 6f6c 756d 6e5f 6e61 6d65 732c 0a20 2020  olumn_names,.   
+0000acb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000acc0: 2020 2020 2020 2020 6474 7970 6520 3d20          dtype = 
+0000acd0: 646f 7068 6f74 5f64 6174 615f 7479 7065  dophot_data_type
+0000ace0: 7329 0a0a 2020 2020 2320 4372 6561 7465  s)..    # Create
+0000acf0: 2066 696c 7465 7220 4944 0a20 2020 2023   filter ID.    #
+0000ad00: 2041 7373 6967 6e20 6669 6c74 6572 2049   Assign filter I
+0000ad10: 4473 0a20 2020 2064 6f70 686f 745f 6669  Ds.    dophot_fi
+0000ad20: 6c74 6572 5f6e 756d 6265 7220 3d20 6361  lter_number = ca
+0000ad30: 745f 6461 7461 2e6c 6f63 5b3a 2c27 5374  t_data.loc[:,'St
+0000ad40: 6172 5f6e 756d 6265 7227 5d2e 7661 6c75  ar_number'].valu
+0000ad50: 6573 0a0a 2020 2020 6669 6c74 5f73 7461  es..    filt_sta
+0000ad60: 6e64 6172 6420 3d20 7472 616e 736c 6174  ndard = translat
+0000ad70: 655f 6669 6c74 6572 5f73 7461 6e64 6172  e_filter_standar
+0000ad80: 6428 6669 6c74 290a 2020 2020 6669 6c74  d(filt).    filt
+0000ad90: 6572 5f49 4420 3d20 5b66 277b 6472 6e61  er_ID = [f'{drna
+0000ada0: 6d65 7d5f 7b66 6965 6c64 7d5f 7073 665f  me}_{field}_psf_
+0000adb0: 7b66 696c 745f 7374 616e 6461 7264 7d5f  {filt_standard}_
+0000adc0: 7b69 3a30 3764 7d27 0a20 2020 2020 2020  {i:07d}'.       
+0000add0: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+0000ade0: 696e 2064 6f70 686f 745f 6669 6c74 6572  in dophot_filter
+0000adf0: 5f6e 756d 6265 725d 0a0a 2020 2020 6361  _number]..    ca
+0000ae00: 745f 6461 7461 5b66 277b 6669 6c74 5f73  t_data[f'{filt_s
+0000ae10: 7461 6e64 6172 647d 5f49 445f 7073 6627  tandard}_ID_psf'
+0000ae20: 5d20 3d20 6669 6c74 6572 5f49 440a 0a20  ] = filter_ID.. 
+0000ae30: 2020 2023 2049 6e63 6c75 6465 2052 4120     # Include RA 
+0000ae40: 616e 6420 4445 430a 2020 2020 7820 3d20  and DEC.    x = 
+0000ae50: 6361 745f 6461 7461 2e6c 6f63 5b3a 2c20  cat_data.loc[:, 
+0000ae60: 2778 706f 7327 5d2e 6172 7261 790a 2020  'xpos'].array.  
+0000ae70: 2020 7920 3d20 6361 745f 6461 7461 2e6c    y = cat_data.l
+0000ae80: 6f63 5b3a 2c20 2779 706f 7327 5d2e 6172  oc[:, 'ypos'].ar
+0000ae90: 7261 790a 0a20 2020 2023 2045 7874 7261  ray..    # Extra
+0000aea0: 6374 2066 6965 6c64 2057 4353 2066 726f  ct field WCS fro
+0000aeb0: 6d20 696d 6167 6520 6865 6164 6572 0a20  m image header. 
+0000aec0: 2020 2068 6561 6420 3d20 6669 7473 2e6f     head = fits.o
+0000aed0: 7065 6e28 696d 6167 6529 5b31 5d2e 6865  pen(image)[1].he
+0000aee0: 6164 6572 0a20 2020 2063 6f6f 7264 5f77  ader.    coord_w
+0000aef0: 6373 203d 2057 4353 2868 6561 6429 0a0a  cs = WCS(head)..
+0000af00: 2020 2020 736b 7963 6f6f 7264 7320 3d20      skycoords = 
+0000af10: 7069 7865 6c5f 746f 5f73 6b79 636f 6f72  pixel_to_skycoor
+0000af20: 6428 782c 2079 2c20 636f 6f72 645f 7763  d(x, y, coord_wc
+0000af30: 732c 206f 7269 6769 6e3d 3129 0a0a 2020  s, origin=1)..  
+0000af40: 2020 2320 4765 7420 7261 2061 6e64 2064    # Get ra and d
+0000af50: 6563 2069 6e20 6465 6772 6565 730a 2020  ec in degrees.  
+0000af60: 2020 7261 203d 206e 702e 6172 7261 7928    ra = np.array(
+0000af70: 736b 7963 6f6f 7264 732e 7261 290a 2020  skycoords.ra).  
+0000af80: 2020 6465 6320 3d20 6e70 2e61 7272 6179    dec = np.array
+0000af90: 2873 6b79 636f 6f72 6473 2e64 6563 290a  (skycoords.dec).
+0000afa0: 0a20 2020 2066 696c 745f 7374 616e 6461  .    filt_standa
+0000afb0: 7264 203d 2074 7261 6e73 6c61 7465 5f66  rd = translate_f
+0000afc0: 696c 7465 725f 7374 616e 6461 7264 2866  ilter_standard(f
+0000afd0: 696c 7429 0a20 2020 2063 6174 5f64 6174  ilt).    cat_dat
+0000afe0: 615b 6627 5241 5f7b 6669 6c74 5f73 7461  a[f'RA_{filt_sta
+0000aff0: 6e64 6172 647d 275d 203d 2072 610a 2020  ndard}'] = ra.  
+0000b000: 2020 6361 745f 6461 7461 5b66 2744 4543    cat_data[f'DEC
+0000b010: 5f7b 6669 6c74 5f73 7461 6e64 6172 647d  _{filt_standard}
+0000b020: 275d 203d 2064 6563 0a0a 2020 2020 666c  '] = dec..    fl
+0000b030: 6167 7374 6172 203d 2070 7366 5f66 6c61  agstar = psf_fla
+0000b040: 6773 7461 7228 6669 746d 6167 203d 2063  gstar(fitmag = c
+0000b050: 6174 5f64 6174 612e 6c6f 635b 3a2c 2766  at_data.loc[:,'f
+0000b060: 6974 6d61 6727 5d2e 7661 6c75 6573 2c0a  itmag'].values,.
+0000b070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b080: 2020 2020 2020 2020 2020 2020 6669 7473              fits
+0000b090: 6b79 203d 2063 6174 5f64 6174 612e 6c6f  ky = cat_data.lo
+0000b0a0: 635b 3a2c 2766 6974 736b 7927 5d2e 7661  c[:,'fitsky'].va
+0000b0b0: 6c75 6573 2c0a 2020 2020 2020 2020 2020  lues,.          
+0000b0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b0d0: 2020 6572 725f 6669 746d 6167 203d 2063    err_fitmag = c
+0000b0e0: 6174 5f64 6174 612e 6c6f 635b 3a2c 2027  at_data.loc[:, '
+0000b0f0: 6572 725f 6669 746d 6167 275d 2e76 616c  err_fitmag'].val
+0000b100: 7565 7329 0a0a 2020 2020 6361 745f 6461  ues)..    cat_da
+0000b110: 7461 5b27 464c 4147 5f53 5441 5227 5d20  ta['FLAG_STAR'] 
+0000b120: 3d20 666c 6167 7374 6172 0a0a 2020 2020  = flagstar..    
+0000b130: 7769 7468 206f 7065 6e28 6361 7461 6c6f  with open(catalo
+0000b140: 675f 6f75 742c 2027 7727 2920 6173 2066  g_out, 'w') as f
+0000b150: 3a0a 2020 2020 2020 2020 662e 7772 6974  :.        f.writ
+0000b160: 6528 2223 2022 290a 2020 2020 2020 2020  e("# ").        
+0000b170: 6361 745f 6461 7461 2e74 6f5f 6373 7628  cat_data.to_csv(
+0000b180: 662c 2069 6e64 6578 203d 2046 616c 7365  f, index = False
+0000b190: 2c20 7365 7020 3d20 2220 2229 0a0a 0a64  , sep = " ")...d
+0000b1a0: 6566 2070 6c6f 745f 646f 7068 6f74 5f64  ef plot_dophot_d
+0000b1b0: 6961 676e 6f73 7469 6328 6361 7461 6c6f  iagnostic(catalo
+0000b1c0: 672c 2073 6176 655f 6669 6c65 2c20 6669  g, save_file, fi
+0000b1d0: 6c74 2c20 6d61 675f 6375 7420 3d20 2838  lt, mag_cut = (8
+0000b1e0: 2c20 3232 2929 3a0a 2020 2020 2222 220a  , 22)):.    """.
+0000b1f0: 2020 2020 4d61 6b65 7320 6469 6167 6e6f      Makes diagno
+0000b200: 7374 6963 2070 6c6f 7473 206f 6620 7468  stic plots of th
+0000b210: 6520 7068 6f74 6f6d 6574 7279 2069 6e20  e photometry in 
+0000b220: 6120 6769 7665 6e20 444f 5048 4f54 206f  a given DOPHOT o
+0000b230: 7574 7075 740a 0a20 2020 2050 6172 616d  utput..    Param
+0000b240: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
+0000b250: 2d2d 2d2d 0a20 2020 2063 6174 616c 6f67  ----.    catalog
+0000b260: 203a 2073 7472 0a20 2020 2020 2020 204c   : str.        L
+0000b270: 6f63 6174 696f 6e20 6f66 2053 4578 7472  ocation of SExtr
+0000b280: 6163 746f 7220 6f75 7470 7574 2063 6174  actor output cat
+0000b290: 616c 6f67 0a20 2020 2073 6176 655f 6669  alog.    save_fi
+0000b2a0: 6c65 203a 2073 7472 0a20 2020 2020 2020  le : str.       
+0000b2b0: 204c 6f63 6174 696f 6e20 746f 2073 6176   Location to sav
+0000b2c0: 6520 706c 6f74 730a 2020 2020 6669 6c74  e plots.    filt
+0000b2d0: 203a 2073 7472 0a20 2020 2020 2020 204e   : str.        N
+0000b2e0: 616d 6520 6f66 2074 6865 2070 686f 746f  ame of the photo
+0000b2f0: 6d65 7472 6963 2066 696c 7465 720a 2020  metric filter.  
+0000b300: 2020 6d61 675f 6375 7420 3a20 6c69 7374    mag_cut : list
+0000b310: 0a20 2020 2020 2020 204c 696d 6974 696e  .        Limitin
+0000b320: 6720 6d61 676e 6974 7564 6573 2028 6d69  g magnitudes (mi
+0000b330: 6e2c 206d 6178 290a 0a20 2020 2052 6574  n, max)..    Ret
+0000b340: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+0000b350: 0a20 2020 2053 6176 6573 2064 6961 676e  .    Saves diagn
+0000b360: 6f73 7469 6320 706c 6f74 730a 2020 2020  ostic plots.    
+0000b370: 2222 220a 0a20 2020 2070 7366 6361 7420  """..    psfcat 
+0000b380: 3d20 6c6f 6164 5f64 6174 6128 6361 7461  = load_data(cata
+0000b390: 6c6f 6729 0a0a 2020 2020 6669 672c 2061  log)..    fig, a
+0000b3a0: 7873 203d 2070 6c74 2e73 7562 706c 6f74  xs = plt.subplot
+0000b3b0: 7328 322c 2066 6967 7369 7a65 203d 205b  s(2, figsize = [
+0000b3c0: 352c 3130 5d29 0a0a 2020 2020 2323 2323  5,10])..    ####
+0000b3d0: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
+0000b3e0: 506c 6f74 2066 6974 736b 790a 0a20 2020  Plot fitsky..   
+0000b3f0: 2023 2050 6c6f 7420 616c 6c20 706f 696e   # Plot all poin
+0000b400: 7473 0a20 2020 2061 7873 5b30 5d2e 7363  ts.    axs[0].sc
+0000b410: 6174 7465 7228 7073 6663 6174 5b27 6669  atter(psfcat['fi
+0000b420: 746d 6167 275d 2c20 7073 6663 6174 5b27  tmag'], psfcat['
+0000b430: 6669 7473 6b79 275d 2c0a 2020 2020 2020  fitsky'],.      
+0000b440: 2020 2020 2020 2020 2020 2020 2063 3d22               c="
+0000b450: 2341 4141 4141 4122 2c20 733d 3130 2c20  #AAAAAA", s=10, 
+0000b460: 616c 7068 613d 302e 3129 0a0a 2020 2020  alpha=0.1)..    
+0000b470: 2320 506c 6f74 2073 656c 6563 7469 6f6e  # Plot selection
+0000b480: 0a20 2020 2066 203d 2070 7366 6361 745b  .    f = psfcat[
+0000b490: 2746 4c41 475f 5354 4152 275d 203d 3d20  'FLAG_STAR'] == 
+0000b4a0: 310a 2020 2020 6178 735b 305d 2e73 6361  1.    axs[0].sca
+0000b4b0: 7474 6572 2870 7366 6361 745b 2766 6974  tter(psfcat['fit
+0000b4c0: 6d61 6727 5d5b 665d 2c20 7073 6663 6174  mag'][f], psfcat
+0000b4d0: 5b27 6669 7473 6b79 275d 5b66 5d2c 0a20  ['fitsky'][f],. 
+0000b4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b4f0: 2020 633d 2223 3232 3636 4646 222c 2073    c="#2266FF", s
+0000b500: 3d31 302c 2061 6c70 6861 3d30 2e33 2c0a  =10, alpha=0.3,.
+0000b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b520: 2020 206c 6162 656c 3d66 2246 4c41 475f     label=f"FLAG_
+0000b530: 5354 4152 203d 2031 2229 0a0a 2020 2020  STAR = 1")..    
+0000b540: 2320 506c 6f74 2067 7269 6420 6c69 6e65  # Plot grid line
+0000b550: 730a 2020 2020 6178 735b 305d 2e68 6c69  s.    axs[0].hli
+0000b560: 6e65 7328 6e70 2e61 7261 6e67 6528 302c  nes(np.arange(0,
+0000b570: 2031 3030 3030 2c20 3130 3029 2c20 6d61   10000, 100), ma
+0000b580: 675f 6375 745b 305d 2c20 6d61 675f 6375  g_cut[0], mag_cu
+0000b590: 745b 315d 2c0a 2020 2020 2020 2020 2020  t[1],.          
+0000b5a0: 2020 2020 2020 2020 636f 6c6f 7273 3d22          colors="
+0000b5b0: 2345 4545 4545 4522 2c20 7a6f 7264 6572  #EEEEEE", zorder
+0000b5c0: 3d2d 3129 0a0a 2020 2020 6178 735b 305d  =-1)..    axs[0]
+0000b5d0: 2e6c 6567 656e 6428 6c6f 633d 3129 0a20  .legend(loc=1). 
+0000b5e0: 2020 2061 7873 5b30 5d2e 7365 745f 786c     axs[0].set_xl
+0000b5f0: 696d 286d 6167 5f63 7574 290a 2020 2020  im(mag_cut).    
+0000b600: 6178 735b 305d 2e73 6574 5f79 6c69 6d28  axs[0].set_ylim(
+0000b610: 5b2d 3530 2c20 3530 305d 290a 2020 2020  [-50, 500]).    
+0000b620: 6178 735b 305d 2e73 6574 5f79 6c61 6265  axs[0].set_ylabe
+0000b630: 6c28 2766 6974 736b 7927 290a 2020 2020  l('fitsky').    
+0000b640: 6178 735b 305d 2e6d 696e 6f72 7469 636b  axs[0].minortick
+0000b650: 735f 6f6e 2829 0a0a 2020 2020 2323 2323  s_on()..    ####
+0000b660: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
+0000b670: 506c 6f74 2066 6974 6d61 670a 0a20 2020  Plot fitmag..   
+0000b680: 2023 2050 6c6f 7420 616c 6c20 706f 696e   # Plot all poin
+0000b690: 7473 0a20 2020 2061 7873 5b31 5d2e 7363  ts.    axs[1].sc
+0000b6a0: 6174 7465 7228 7073 6663 6174 5b27 6669  atter(psfcat['fi
+0000b6b0: 746d 6167 275d 2c20 7073 6663 6174 5b27  tmag'], psfcat['
+0000b6c0: 6572 725f 6669 746d 6167 275d 2c0a 2020  err_fitmag'],.  
+0000b6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b6e0: 2063 3d22 2341 4141 4141 4122 2c20 733d   c="#AAAAAA", s=
+0000b6f0: 3130 2c20 616c 7068 613d 302e 3129 0a0a  10, alpha=0.1)..
+0000b700: 2020 2020 2320 506c 6f74 2073 656c 6563      # Plot selec
+0000b710: 7469 6f6e 0a20 2020 2066 203d 2070 7366  tion.    f = psf
+0000b720: 6361 745b 2746 4c41 475f 5354 4152 275d  cat['FLAG_STAR']
+0000b730: 203d 3d20 310a 2020 2020 6178 735b 315d   == 1.    axs[1]
+0000b740: 2e73 6361 7474 6572 2870 7366 6361 745b  .scatter(psfcat[
+0000b750: 2766 6974 6d61 6727 5d5b 665d 2c20 7073  'fitmag'][f], ps
+0000b760: 6663 6174 5b27 6572 725f 6669 746d 6167  fcat['err_fitmag
+0000b770: 275d 5b66 5d2c 0a20 2020 2020 2020 2020  '][f],.         
+0000b780: 2020 2020 2020 2020 2020 633d 2223 3232            c="#22
+0000b790: 3636 4646 222c 2073 3d31 302c 2061 6c70  66FF", s=10, alp
+0000b7a0: 6861 3d30 2e33 2c0a 2020 2020 2020 2020  ha=0.3,.        
+0000b7b0: 2020 2020 2020 2020 2020 206c 6162 656c             label
+0000b7c0: 3d66 2265 7272 5f66 6974 6d61 6720 3c20  =f"err_fitmag < 
+0000b7d0: 302e 3032 2229 0a0a 2020 2020 2320 506c  0.02")..    # Pl
+0000b7e0: 6f74 2063 7574 206c 696e 650a 2020 2020  ot cut line.    
+0000b7f0: 6178 735b 315d 2e68 6c69 6e65 7328 302e  axs[1].hlines(0.
+0000b800: 3032 2c20 6d61 675f 6375 745b 305d 2c20  02, mag_cut[0], 
+0000b810: 6d61 675f 6375 745b 315d 2c0a 2020 2020  mag_cut[1],.    
+0000b820: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0000b830: 6c6f 7273 3d22 2332 3236 3646 4622 2c20  lors="#2266FF", 
+0000b840: 7a6f 7264 6572 3d31 290a 0a20 2020 2023  zorder=1)..    #
+0000b850: 2050 6c6f 7420 6772 6964 206c 696e 6573   Plot grid lines
+0000b860: 0a20 2020 2061 7873 5b31 5d2e 686c 696e  .    axs[1].hlin
+0000b870: 6573 286e 702e 6172 616e 6765 2830 2c20  es(np.arange(0, 
+0000b880: 302e 322c 2030 2e30 3229 2c20 6d61 675f  0.2, 0.02), mag_
+0000b890: 6375 745b 305d 2c20 6d61 675f 6375 745b  cut[0], mag_cut[
+0000b8a0: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+0000b8b0: 2020 2020 2020 636f 6c6f 7273 3d22 2345        colors="#E
+0000b8c0: 4545 4545 4522 2c20 7a6f 7264 6572 3d2d  EEEEE", zorder=-
+0000b8d0: 3129 0a0a 2020 2020 6178 735b 315d 2e73  1)..    axs[1].s
+0000b8e0: 6574 5f78 6c69 6d28 6d61 675f 6375 7429  et_xlim(mag_cut)
+0000b8f0: 0a20 2020 2061 7873 5b31 5d2e 7365 745f  .    axs[1].set_
+0000b900: 796c 696d 285b 302c 2030 2e32 5d29 0a20  ylim([0, 0.2]). 
+0000b910: 2020 2061 7873 5b31 5d2e 7365 745f 796c     axs[1].set_yl
+0000b920: 6162 656c 2827 6572 725f 6669 746d 6167  abel('err_fitmag
+0000b930: 2729 0a20 2020 2061 7873 5b31 5d2e 6d69  ').    axs[1].mi
+0000b940: 6e6f 7274 6963 6b73 5f6f 6e28 290a 0a20  norticks_on().. 
+0000b950: 2020 2061 7873 5b31 5d2e 7365 745f 786c     axs[1].set_xl
+0000b960: 6162 656c 2866 227b 6669 6c74 7d5f 6669  abel(f"{filt}_fi
+0000b970: 746d 6167 205b 696e 7374 5d22 290a 0a20  tmag [inst]").. 
+0000b980: 2020 2070 6c74 2e73 7562 706c 6f74 735f     plt.subplots_
+0000b990: 6164 6a75 7374 286c 6566 743d 302e 3134  adjust(left=0.14
+0000b9a0: 2c20 7269 6768 743d 302e 3938 2c20 746f  , right=0.98, to
+0000b9b0: 703d 302e 3938 2c20 626f 7474 6f6d 3d30  p=0.98, bottom=0
+0000b9c0: 2e30 362c 2068 7370 6163 653d 302e 3129  .06, hspace=0.1)
+0000b9d0: 0a0a 2020 2020 706c 742e 7361 7665 6669  ..    plt.savefi
+0000b9e0: 6728 7361 7665 5f66 696c 6529 0a20 2020  g(save_file).   
+0000b9f0: 2070 6c74 2e63 6c6f 7365 2866 6967 290a   plt.close(fig).
+0000ba00: 0a23 2323 2323 2323 2323 2323 2323 2323  .###############
+0000ba10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ba20: 0a23 2043 6f72 7265 6374 696f 6e20 7879  .# Correction xy
+0000ba30: 0a0a 0a64 6566 2069 6e74 6572 7365 6374  ...def intersect
+0000ba40: 696f 6e5f 326c 696e 6573 2878 312c 2079  ion_2lines(x1, y
+0000ba50: 312c 2078 322c 2079 322c 2078 332c 2079  1, x2, y2, x3, y
+0000ba60: 332c 2078 342c 2079 3429 3a0a 0a20 2020  3, x4, y4):..   
+0000ba70: 2022 2222 0a20 2020 2052 6574 7572 6e73   """.    Returns
+0000ba80: 2074 6865 2069 6e74 6572 7365 6374 696f   the intersectio
+0000ba90: 6e20 6f66 206c 696e 6520 4c31 2064 6566  n of line L1 def
+0000baa0: 696e 6564 2062 7920 706f 696e 7473 2028  ined by points (
+0000bab0: 7831 2c79 3129 2c20 2878 322c 7932 292c  x1,y1), (x2,y2),
+0000bac0: 2061 6e64 0a20 2020 206c 696e 6520 4c32   and.    line L2
+0000bad0: 2064 6566 696e 6564 2062 7920 706f 696e   defined by poin
+0000bae0: 7473 2028 7833 2c79 3329 2c20 2878 342c  ts (x3,y3), (x4,
+0000baf0: 7934 290a 0a20 2020 2073 6565 2068 7474  y4)..    see htt
+0000bb00: 7073 3a2f 2f65 6e2e 7769 6b69 7065 6469  ps://en.wikipedi
+0000bb10: 612e 6f72 672f 7769 6b69 2f4c 696e 6525  a.org/wiki/Line%
+0000bb20: 4532 2538 3025 3933 6c69 6e65 5f69 6e74  E2%80%93line_int
+0000bb30: 6572 7365 6374 696f 6e0a 2020 2020 2222  ersection.    ""
+0000bb40: 220a 0a20 2020 2044 203d 2028 7831 2d78  "..    D = (x1-x
+0000bb50: 3229 2a28 7933 2d79 3429 202d 2028 7931  2)*(y3-y4) - (y1
+0000bb60: 2d79 3229 2a28 7833 2d78 3429 0a0a 2020  -y2)*(x3-x4)..  
+0000bb70: 2020 7820 3d20 2820 2878 312a 7932 202d    x = ( (x1*y2 -
+0000bb80: 2079 312a 7832 292a 2878 332d 7834 2920   y1*x2)*(x3-x4) 
+0000bb90: 2d20 2878 312d 7832 292a 2878 332a 7934  - (x1-x2)*(x3*y4
+0000bba0: 2d79 332a 7834 2920 2920 2f20 440a 0a20  -y3*x4) ) / D.. 
+0000bbb0: 2020 2079 203d 2028 2028 7831 2a79 3220     y = ( (x1*y2 
+0000bbc0: 2d20 7931 2a78 3229 2a28 7933 2d79 3429  - y1*x2)*(y3-y4)
+0000bbd0: 202d 2028 7931 2d79 3229 2a28 7833 2a79   - (y1-y2)*(x3*y
+0000bbe0: 342d 7933 2a78 3429 2029 202f 2044 0a0a  4-y3*x4) ) / D..
+0000bbf0: 2020 2020 7265 7475 726e 206e 702e 6172      return np.ar
+0000bc00: 7261 7928 5b78 2c20 795d 290a 0a0a 6465  ray([x, y])...de
+0000bc10: 6620 616c 6967 6e5f 7370 6c75 735f 7879  f align_splus_xy
+0000bc20: 2878 2c20 792c 2063 656e 7465 7220 3d20  (x, y, center = 
+0000bc30: 4e6f 6e65 2c20 6d61 7267 696e 203d 2031  None, margin = 1
+0000bc40: 3029 3a0a 2020 2020 2222 220a 2020 2020  0):.    """.    
+0000bc50: 416c 6967 6e73 2053 2d50 4c55 5320 582c  Aligns S-PLUS X,
+0000bc60: 5920 636f 6f72 6469 6e61 7465 7320 6279  Y coordinates by
+0000bc70: 206d 6f76 696e 6720 6f72 6967 696e 2074   moving origin t
+0000bc80: 6f20 626f 7474 6f6d 206c 6566 7420 7665  o bottom left ve
+0000bc90: 7274 6963 6520 616e 640a 2020 2020 726f  rtice and.    ro
+0000bca0: 7461 7469 6e67 2074 6f20 6669 7420 7820  tating to fit x 
+0000bcb0: 616e 6420 7920 6469 7265 6374 696f 6e73  and y directions
+0000bcc0: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+0000bcd0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+0000bce0: 2020 2020 7820 3a20 6172 7261 790a 2020      x : array.  
+0000bcf0: 2020 2020 2020 6172 7261 7920 6f66 2058        array of X
+0000bd00: 5f49 4d41 4745 2076 616c 7565 730a 2020  _IMAGE values.  
+0000bd10: 2020 7920 3a20 6172 7261 790a 2020 2020    y : array.    
+0000bd20: 2020 2020 6172 7261 7920 6f66 2059 5f49      array of Y_I
+0000bd30: 4d41 4745 2076 616c 7565 730a 2020 2020  MAGE values.    
+0000bd40: 6365 6e74 6572 203a 206c 6973 740a 2020  center : list.  
+0000bd50: 2020 2020 2020 6365 6e74 6572 2076 616c        center val
+0000bd60: 7565 2069 6e20 7468 6520 666f 726d 6174  ue in the format
+0000bd70: 205b 7863 656e 7465 722c 2079 6365 6e74   [xcenter, ycent
+0000bd80: 6572 5d2e 2049 6620 4e6f 6e65 2c20 6365  er]. If None, ce
+0000bd90: 6e74 6572 2069 730a 2020 2020 2020 2020  nter is.        
+0000bda0: 6361 6c63 756c 6174 6564 2066 726f 6d20  calculated from 
+0000bdb0: 7468 6520 6176 6572 6167 6520 7820 616e  the average x an
+0000bdc0: 6420 7920 7661 6c75 6573 0a20 2020 206d  d y values.    m
+0000bdd0: 6172 6769 6e20 3a20 696e 740a 2020 2020  argin : int.    
+0000bde0: 2020 2020 6d61 7267 696e 2c20 696e 2070      margin, in p
+0000bdf0: 6978 656c 732c 2061 6464 6564 2074 6f20  ixels, added to 
+0000be00: 7468 6520 6f72 6967 696e 0a0a 2020 2020  the origin..    
+0000be10: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+0000be20: 2d2d 2d0a 2020 2020 6172 7261 790a 2020  ---.    array.  
+0000be30: 2020 2020 2020 6172 7261 7920 6f66 2073        array of s
+0000be40: 7175 6172 6520 7665 7274 6963 6573 2069  quare vertices i
+0000be50: 6e20 7468 6520 666f 726d 6174 3a0a 2020  n the format:.  
+0000be60: 2020 2020 2020 205b 5b78 5f62 6f74 746f         [[x_botto
+0000be70: 6d6c 6566 742c 2020 795f 626f 7474 6f6d  mleft,  y_bottom
+0000be80: 6c65 6674 5d2c 0a20 2020 2020 2020 2020  left],.         
+0000be90: 205b 785f 626f 7474 6f6d 7269 6768 742c   [x_bottomright,
+0000bea0: 2079 5f62 6f74 746f 6d72 6967 6874 5d2c   y_bottomright],
+0000beb0: 0a20 2020 2020 2020 2020 205b 785f 746f  .          [x_to
+0000bec0: 7072 6967 6874 2c20 2020 2079 5f74 6f70  pright,    y_top
+0000bed0: 7269 6768 745d 2c0a 2020 2020 2020 2020  right],.        
+0000bee0: 2020 5b78 5f74 6f70 6c65 6674 2c20 2020    [x_topleft,   
+0000bef0: 2020 795f 746f 706c 6566 745d 5d0a 0a20    y_topleft]].. 
+0000bf00: 2020 2022 2222 0a20 2020 2023 2043 656e     """.    # Cen
+0000bf10: 7465 7220 636f 6f72 6469 6e61 7465 730a  ter coordinates.
+0000bf20: 2020 2020 6966 2063 656e 7465 7220 6973      if center is
+0000bf30: 204e 6f6e 653a 0a20 2020 2020 2020 2078   None:.        x
+0000bf40: 3020 3d20 6e70 2e6e 616e 6d65 616e 2878  0 = np.nanmean(x
+0000bf50: 290a 2020 2020 2020 2020 7930 203d 206e  ).        y0 = n
+0000bf60: 702e 6e61 6e6d 6561 6e28 7929 0a20 2020  p.nanmean(y).   
+0000bf70: 2065 6c73 653a 0a20 2020 2020 2020 2078   else:.        x
+0000bf80: 3020 3d20 6365 6e74 6572 5b30 5d0a 2020  0 = center[0].  
+0000bf90: 2020 2020 2020 7930 203d 2063 656e 7465        y0 = cente
+0000bfa0: 725b 315d 0a0a 2020 2020 2320 4465 6669  r[1]..    # Defi
+0000bfb0: 6e69 6e67 2071 7561 6472 616e 7473 3a20  ning quadrants: 
+0000bfc0: 2020 5134 207c 2051 330a 2020 2020 2320    Q4 | Q3.    # 
+0000bfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bfe0: 2020 2020 2020 2d2d 2d2d 2d2d 2d0a 2020        -------.  
+0000bff0: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+0000c000: 2020 2020 2020 2020 2020 5131 207c 2051            Q1 | Q
+0000c010: 320a 0a20 2020 2051 3120 3d20 2878 203c  2..    Q1 = (x <
+0000c020: 2078 3029 2026 2028 7920 3c20 7930 290a   x0) & (y < y0).
+0000c030: 2020 2020 5132 203d 2028 7820 3e20 7830      Q2 = (x > x0
+0000c040: 2920 2620 2879 203c 2079 3029 0a20 2020  ) & (y < y0).   
+0000c050: 2051 3320 3d20 2878 203e 2078 3029 2026   Q3 = (x > x0) &
+0000c060: 2028 7920 3e20 7930 290a 2020 2020 5134   (y > y0).    Q4
+0000c070: 203d 2028 7820 3c20 7830 2920 2620 2879   = (x < x0) & (y
+0000c080: 203e 2079 3029 0a0a 2020 2020 2320 4669   > y0)..    # Fi
+0000c090: 6e64 696e 6720 706f 696e 7473 2069 6e20  nding points in 
+0000c0a0: 6c65 6674 2061 6e64 2072 6967 6874 2073  left and right s
+0000c0b0: 6964 6573 2061 6e64 2062 6f74 746f 6d0a  ides and bottom.
+0000c0c0: 0a20 2020 2078 316c 203d 2078 5b51 315d  .    x1l = x[Q1]
+0000c0d0: 5b20 785b 5131 5d20 3d3d 206e 702e 6e61  [ x[Q1] == np.na
+0000c0e0: 6e6d 696e 2878 5b51 315d 2920 5d5b 305d  nmin(x[Q1]) ][0]
+0000c0f0: 2020 2320 7820 6f66 206c 6566 7420 6d6f    # x of left mo
+0000c100: 7374 2070 6f69 6e74 2069 6e20 5131 0a20  st point in Q1. 
+0000c110: 2020 2079 316c 203d 2079 5b51 315d 5b20     y1l = y[Q1][ 
+0000c120: 785b 5131 5d20 3d3d 206e 702e 6e61 6e6d  x[Q1] == np.nanm
+0000c130: 696e 2878 5b51 315d 2920 5d5b 305d 2020  in(x[Q1]) ][0]  
+0000c140: 2320 7920 6f66 206c 6566 7420 6d6f 7374  # y of left most
+0000c150: 2070 6f69 6e74 2069 6e20 5131 0a0a 2020   point in Q1..  
+0000c160: 2020 7831 6220 3d20 785b 5131 5d5b 2079    x1b = x[Q1][ y
+0000c170: 5b51 315d 203d 3d20 6e70 2e6e 616e 6d69  [Q1] == np.nanmi
+0000c180: 6e28 795b 5131 5d29 205d 5b30 5d0a 2020  n(y[Q1]) ][0].  
+0000c190: 2020 7931 6220 3d20 795b 5131 5d5b 2079    y1b = y[Q1][ y
+0000c1a0: 5b51 315d 203d 3d20 6e70 2e6e 616e 6d69  [Q1] == np.nanmi
+0000c1b0: 6e28 795b 5131 5d29 205d 5b30 5d0a 0a20  n(y[Q1]) ][0].. 
+0000c1c0: 2020 2078 3272 203d 2078 5b51 325d 5b20     x2r = x[Q2][ 
+0000c1d0: 785b 5132 5d20 3d3d 206e 702e 6e61 6e6d  x[Q2] == np.nanm
+0000c1e0: 6178 2878 5b51 325d 2920 5d5b 305d 0a20  ax(x[Q2]) ][0]. 
+0000c1f0: 2020 2079 3272 203d 2079 5b51 325d 5b20     y2r = y[Q2][ 
+0000c200: 785b 5132 5d20 3d3d 206e 702e 6e61 6e6d  x[Q2] == np.nanm
+0000c210: 6178 2878 5b51 325d 2920 5d5b 305d 0a0a  ax(x[Q2]) ][0]..
+0000c220: 2020 2020 7832 6220 3d20 785b 5132 5d5b      x2b = x[Q2][
+0000c230: 2079 5b51 325d 203d 3d20 6e70 2e6e 616e   y[Q2] == np.nan
+0000c240: 6d69 6e28 795b 5132 5d29 205d 5b30 5d0a  min(y[Q2]) ][0].
+0000c250: 2020 2020 7932 6220 3d20 795b 5132 5d5b      y2b = y[Q2][
+0000c260: 2079 5b51 325d 203d 3d20 6e70 2e6e 616e   y[Q2] == np.nan
+0000c270: 6d69 6e28 795b 5132 5d29 205d 5b30 5d0a  min(y[Q2]) ][0].
+0000c280: 0a20 2020 2078 3372 203d 2078 5b51 335d  .    x3r = x[Q3]
+0000c290: 5b20 785b 5133 5d20 3d3d 206e 702e 6e61  [ x[Q3] == np.na
+0000c2a0: 6e6d 6178 2878 5b51 335d 2920 5d5b 305d  nmax(x[Q3]) ][0]
+0000c2b0: 0a20 2020 2079 3372 203d 2079 5b51 335d  .    y3r = y[Q3]
+0000c2c0: 5b20 785b 5133 5d20 3d3d 206e 702e 6e61  [ x[Q3] == np.na
+0000c2d0: 6e6d 6178 2878 5b51 335d 2920 5d5b 305d  nmax(x[Q3]) ][0]
+0000c2e0: 0a0a 2020 2020 7834 6c20 3d20 785b 5134  ..    x4l = x[Q4
+0000c2f0: 5d5b 2078 5b51 345d 203d 3d20 6e70 2e6e  ][ x[Q4] == np.n
+0000c300: 616e 6d69 6e28 785b 5134 5d29 205d 5b30  anmin(x[Q4]) ][0
+0000c310: 5d0a 2020 2020 7934 6c20 3d20 795b 5134  ].    y4l = y[Q4
+0000c320: 5d5b 2078 5b51 345d 203d 3d20 6e70 2e6e  ][ x[Q4] == np.n
+0000c330: 616e 6d69 6e28 785b 5134 5d29 205d 5b30  anmin(x[Q4]) ][0
+0000c340: 5d0a 0a20 2020 2023 2062 6f74 746f 6d2d  ]..    # bottom-
+0000c350: 6c65 6674 2076 6572 7469 6365 0a20 2020  left vertice.   
+0000c360: 2076 626c 203d 2069 6e74 6572 7365 6374   vbl = intersect
+0000c370: 696f 6e5f 326c 696e 6573 2878 313d 7831  ion_2lines(x1=x1
+0000c380: 622c 2079 313d 7931 622c 2078 323d 7832  b, y1=y1b, x2=x2
+0000c390: 622c 2079 323d 7932 622c 0a20 2020 2020  b, y2=y2b,.     
+0000c3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3b0: 2020 2020 2020 2020 2078 333d 7831 6c2c           x3=x1l,
+0000c3c0: 2079 333d 7931 6c2c 2078 343d 7834 6c2c   y3=y1l, x4=x4l,
+0000c3d0: 2079 343d 7934 6c29 0a0a 2020 2020 2320   y4=y4l)..    # 
+0000c3e0: 626f 7474 6f6d 2d72 6967 6874 2076 6572  bottom-right ver
+0000c3f0: 7469 6365 0a20 2020 2076 6272 203d 2069  tice.    vbr = i
+0000c400: 6e74 6572 7365 6374 696f 6e5f 326c 696e  ntersection_2lin
+0000c410: 6573 2878 313d 7831 622c 2079 313d 7931  es(x1=x1b, y1=y1
+0000c420: 622c 2078 323d 7832 622c 2079 323d 7932  b, x2=x2b, y2=y2
+0000c430: 622c 0a20 2020 2020 2020 2020 2020 2020  b,.             
+0000c440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c450: 2078 333d 7833 722c 2079 333d 7933 722c   x3=x3r, y3=y3r,
+0000c460: 2078 343d 7832 722c 2079 343d 7932 7229   x4=x2r, y4=y2r)
+0000c470: 0a0a 2020 2020 2320 426f 7474 6f6d 2076  ..    # Bottom v
+0000c480: 6563 746f 720a 2020 2020 7662 203d 2076  ector.    vb = v
+0000c490: 6272 202d 2076 626c 0a0a 2020 2020 2320  br - vbl..    # 
+0000c4a0: 556e 6974 2076 6563 746f 720a 2020 2020  Unit vector.    
+0000c4b0: 756e 6974 5f76 6220 3d20 7662 202f 206e  unit_vb = vb / n
+0000c4c0: 702e 7371 7274 286e 702e 7375 6d28 2876  p.sqrt(np.sum((v
+0000c4d0: 622a 2a32 2929 290a 0a20 2020 2023 2041  b**2)))..    # A
+0000c4e0: 6e67 6c65 0a20 2020 2064 6f74 5f70 726f  ngle.    dot_pro
+0000c4f0: 6475 6374 203d 206e 702e 646f 7428 756e  duct = np.dot(un
+0000c500: 6974 5f76 622c 206e 702e 6172 7261 7928  it_vb, np.array(
+0000c510: 5b31 2c20 305d 2929 0a20 2020 2061 6e67  [1, 0])).    ang
+0000c520: 6c65 203d 206e 702e 6172 6363 6f73 2864  le = np.arccos(d
+0000c530: 6f74 5f70 726f 6475 6374 290a 0a20 2020  ot_product)..   
+0000c540: 2023 204d 6f76 6520 6f72 6967 696e 2074   # Move origin t
+0000c550: 6f20 626f 7474 6f6d 206c 6566 7420 7665  o bottom left ve
+0000c560: 7274 6963 650a 2020 2020 785f 7465 6d70  rtice.    x_temp
+0000c570: 203d 2078 202d 2076 626c 5b30 5d20 2d20   = x - vbl[0] - 
+0000c580: 6d61 7267 696e 0a20 2020 2079 5f74 656d  margin.    y_tem
+0000c590: 7020 3d20 7920 2d20 7662 6c5b 315d 202d  p = y - vbl[1] -
+0000c5a0: 206d 6172 6769 6e0a 0a20 2020 2023 2052   margin..    # R
+0000c5b0: 6f74 6174 6520 746f 2061 6c69 676e 0a20  otate to align. 
+0000c5c0: 2020 2078 5f61 6c69 676e 203d 2078 5f74     x_align = x_t
+0000c5d0: 656d 7020 2a20 6e70 2e63 6f73 2861 6e67  emp * np.cos(ang
+0000c5e0: 6c65 2920 2d20 795f 7465 6d70 202a 206e  le) - y_temp * n
+0000c5f0: 702e 7369 6e28 616e 676c 6529 0a20 2020  p.sin(angle).   
+0000c600: 2079 5f61 6c69 676e 203d 2078 5f74 656d   y_align = x_tem
+0000c610: 7020 2a20 6e70 2e73 696e 2861 6e67 6c65  p * np.sin(angle
+0000c620: 2920 2b20 795f 7465 6d70 202a 206e 702e  ) + y_temp * np.
+0000c630: 636f 7328 616e 676c 6529 0a0a 2020 2020  cos(angle)..    
+0000c640: 7265 7475 726e 2078 5f61 6c69 676e 2c20  return x_align, 
+0000c650: 795f 616c 6967 6e0a 0a0a 6465 6620 6669  y_align...def fi
+0000c660: 785f 7879 5f72 6f74 6174 696f 6e28 6361  x_xy_rotation(ca
+0000c670: 7461 6c6f 672c 2073 6176 655f 6669 6c65  talog, save_file
+0000c680: 2c20 7863 6f6c 203d 2027 585f 494d 4147  , xcol = 'X_IMAG
+0000c690: 4527 2c20 7963 6f6c 203d 2027 595f 494d  E', ycol = 'Y_IM
+0000c6a0: 4147 4527 293a 0a0a 2020 2020 6361 7420  AGE'):..    cat 
+0000c6b0: 3d20 6669 7473 2e6f 7065 6e28 6361 7461  = fits.open(cata
+0000c6c0: 6c6f 6729 0a20 2020 2063 6174 5f64 6174  log).    cat_dat
+0000c6d0: 6120 3d20 6361 745b 315d 2e64 6174 610a  a = cat[1].data.
+0000c6e0: 0a20 2020 2078 203d 2063 6174 5f64 6174  .    x = cat_dat
+0000c6f0: 612e 636f 6c75 6d6e 735b 7863 6f6c 5d2e  a.columns[xcol].
+0000c700: 6172 7261 790a 2020 2020 7920 3d20 6361  array.    y = ca
+0000c710: 745f 6461 7461 2e63 6f6c 756d 6e73 5b79  t_data.columns[y
+0000c720: 636f 6c5d 2e61 7272 6179 0a0a 2020 2020  col].array..    
+0000c730: 2320 4e6f 726d 616c 697a 6520 5820 616e  # Normalize X an
+0000c740: 6420 590a 2020 2020 785f 616c 6967 6e2c  d Y.    x_align,
+0000c750: 2079 5f61 6c69 676e 203d 2061 6c69 676e   y_align = align
+0000c760: 5f73 706c 7573 5f78 7928 782c 2079 290a  _splus_xy(x, y).
+0000c770: 0a20 2020 2023 2043 7265 6174 6520 6e65  .    # Create ne
+0000c780: 7720 6669 7473 2063 6174 616c 6f67 2077  w fits catalog w
+0000c790: 6974 6820 6e65 7720 636f 6c75 6d6e 730a  ith new columns.
+0000c7a0: 2020 2020 636f 7272 5f64 6174 6120 3d20      corr_data = 
+0000c7b0: 6361 745f 6461 7461 2e63 6f6c 756d 6e73  cat_data.columns
+0000c7c0: 0a0a 2020 2020 636f 7272 5f64 6174 6120  ..    corr_data 
+0000c7d0: 2b3d 2066 6974 732e 436f 6c75 6d6e 286e  += fits.Column(n
+0000c7e0: 616d 653d 2758 5f41 4c49 474e 272c 0a20  ame='X_ALIGN',. 
+0000c7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c800: 2020 2020 2020 2020 2020 2020 666f 726d              form
+0000c810: 6174 3d27 3145 272c 0a20 2020 2020 2020  at='1E',.       
+0000c820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c830: 2020 2020 2020 6172 7261 793d 785f 616c        array=x_al
+0000c840: 6967 6e29 0a0a 2020 2020 636f 7272 5f64  ign)..    corr_d
+0000c850: 6174 6120 2b3d 2066 6974 732e 436f 6c75  ata += fits.Colu
+0000c860: 6d6e 286e 616d 653d 2759 5f41 4c49 474e  mn(name='Y_ALIGN
+0000c870: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0000c880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c890: 666f 726d 6174 3d27 3145 272c 0a20 2020  format='1E',.   
+0000c8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c8b0: 2020 2020 2020 2020 2020 6172 7261 793d            array=
+0000c8c0: 795f 616c 6967 6e29 0a0a 2020 2020 2320  y_align)..    # 
+0000c8d0: 5361 7665 2063 6f72 7265 6374 6564 2064  Save corrected d
+0000c8e0: 6174 6120 746f 2073 6176 655f 6669 6c65  ata to save_file
+0000c8f0: 2066 6974 7320 6361 7461 6c6f 670a 2020   fits catalog.  
+0000c900: 2020 6864 7520 3d20 6669 7473 2e42 696e    hdu = fits.Bin
+0000c910: 5461 626c 6548 4455 2e66 726f 6d5f 636f  TableHDU.from_co
+0000c920: 6c75 6d6e 7328 636f 7272 5f64 6174 6129  lumns(corr_data)
+0000c930: 0a20 2020 2068 6475 2e77 7269 7465 746f  .    hdu.writeto
+0000c940: 2873 6176 655f 6669 6c65 290a 0a0a 6465  (save_file)...de
+0000c950: 6620 6170 706c 795f 7879 5f63 6f72 7265  f apply_xy_corre
+0000c960: 6374 696f 6e28 6361 7461 6c6f 672c 2073  ction(catalog, s
+0000c970: 6176 655f 6669 6c65 2c20 6d61 705f 6669  ave_file, map_fi
+0000c980: 6c65 2c20 7862 696e 732c 2079 6269 6e73  le, xbins, ybins
+0000c990: 293a 0a20 2020 2022 2222 0a20 2020 2041  ):.    """.    A
+0000c9a0: 7070 6c69 6573 2058 5920 636f 7272 6563  pplies XY correc
+0000c9b0: 7469 6f6e 7320 746f 2074 6865 2053 2d50  tions to the S-P
+0000c9c0: 4c55 5320 7068 6f74 6f6d 6574 7279 2063  LUS photometry c
+0000c9d0: 6174 616c 6f67 732e 0a0a 2020 2020 436f  atalogs...    Co
+0000c9e0: 7272 6563 7469 6f6e 2061 7265 2061 7070  rrection are app
+0000c9f0: 6c69 6564 2074 6f20 616c 6c20 6669 7865  lied to all fixe
+0000ca00: 6420 6170 6572 7475 7265 2c20 6175 746f  d aperture, auto
+0000ca10: 2c20 7065 7472 6f20 616e 6420 6973 6f20  , petro and iso 
+0000ca20: 6d61 676e 6974 7564 6573 0a20 2020 2061  magnitudes.    a
+0000ca30: 6e64 2066 6c75 7865 7320 2869 6620 7072  nd fluxes (if pr
+0000ca40: 6573 656e 7420 696e 2074 6865 2063 6174  esent in the cat
+0000ca50: 616c 6f67 7329 2e0a 0a20 2020 2054 776f  alogs)...    Two
+0000ca60: 2061 6464 6974 696f 6e61 6c20 636f 6c75   additional colu
+0000ca70: 6d6e 7320 6172 6520 6372 6561 7465 643a  mns are created:
+0000ca80: 2058 5f41 4c49 474e 2061 6e64 2059 5f41   X_ALIGN and Y_A
+0000ca90: 4c49 474e 2c20 636f 7272 6573 706f 6e64  LIGN, correspond
+0000caa0: 696e 6720 746f 0a20 2020 206e 6f72 6d61  ing to.    norma
+0000cab0: 6c69 7a65 6420 585f 494d 4147 4520 616e  lized X_IMAGE an
+0000cac0: 6420 595f 494d 4147 4520 706f 7369 7469  d Y_IMAGE positi
+0000cad0: 6f6e 7320 286f 7269 6769 6e20 6d6f 7665  ons (origin move
+0000cae0: 6420 746f 2062 6f74 746f 6d20 6c65 6674  d to bottom left
+0000caf0: 0a20 2020 2063 6f72 6e65 722c 2061 6e64  .    corner, and
+0000cb00: 2063 6f6f 7264 696e 6174 6573 2072 6f74   coordinates rot
+0000cb10: 6174 6520 746f 206d 6174 6368 2058 2061  ate to match X a
+0000cb20: 6e64 2059 2061 7869 7329 2e0a 0a20 2020  nd Y axis)...   
+0000cb30: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+0000cb40: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063  ----------.    c
+0000cb50: 6174 616c 6f67 203a 2073 7472 0a20 2020  atalog : str.   
+0000cb60: 2020 2020 204c 6f63 6174 696f 6e20 746f       Location to
+0000cb70: 2074 6865 2053 4578 7472 6163 746f 7220   the SExtractor 
+0000cb80: 7068 6f74 6f6d 6574 7279 206f 7574 7075  photometry outpu
+0000cb90: 7420 6361 7461 6c6f 670a 0a20 2020 2073  t catalog..    s
+0000cba0: 6176 655f 6669 6c65 203a 2073 7472 0a20  ave_file : str. 
+0000cbb0: 2020 2020 2020 2044 6573 6972 6564 206c         Desired l
+0000cbc0: 6f63 6174 696f 6e20 746f 2073 6176 6520  ocation to save 
+0000cbd0: 7468 6520 5859 2063 6f72 7265 6374 6564  the XY corrected
+0000cbe0: 2063 6174 616c 6f67 0a0a 2020 2020 6d61   catalog..    ma
+0000cbf0: 705f 6669 6c65 203a 2073 7472 0a20 2020  p_file : str.   
+0000cc00: 2020 2020 204c 6f63 6174 696f 6e20 6f66       Location of
+0000cc10: 2074 6865 2078 7920 636f 7272 6563 7469   the xy correcti
+0000cc20: 6f6e 206d 6170 2028 6d75 7374 2062 6520  on map (must be 
+0000cc30: 6e75 6d70 7920 6e70 7920 6669 6c65 290a  numpy npy file).
+0000cc40: 0a20 2020 2078 6269 6e73 203a 206c 6973  .    xbins : lis
+0000cc50: 740a 2020 2020 2020 2020 7862 696e 7320  t.        xbins 
+0000cc60: 6f66 2074 6865 2063 6f72 7265 6374 696f  of the correctio
+0000cc70: 6e20 6d61 7020 2873 7461 7274 2c20 656e  n map (start, en
+0000cc80: 642c 204e 6269 6e73 2920 5b69 6e20 7069  d, Nbins) [in pi
+0000cc90: 7865 6c73 5d0a 0a20 2020 2079 6269 6e73  xels]..    ybins
+0000cca0: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
+0000ccb0: 7962 696e 7320 6f66 2074 6865 2063 6f72  ybins of the cor
+0000ccc0: 7265 6374 696f 6e20 6d61 7020 2873 7461  rection map (sta
+0000ccd0: 7274 2c20 656e 642c 204e 6269 6e73 2920  rt, end, Nbins) 
+0000cce0: 5b69 6e20 7069 7865 6c73 5d0a 0a20 2020  [in pixels]..   
+0000ccf0: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
+0000cd00: 2d2d 2d2d 0a20 2020 2053 6176 6573 2058  ----.    Saves X
+0000cd10: 5920 636f 7272 6563 7465 6420 6361 7461  Y corrected cata
+0000cd20: 6c6f 6720 696e 2074 6865 2064 6573 6972  log in the desir
+0000cd30: 6564 206c 6f63 6174 696f 6e20 2870 6172  ed location (par
+0000cd40: 616d 3a73 6176 655f 6669 6c65 290a 2020  am:save_file).  
+0000cd50: 2020 2222 220a 0a20 2020 2063 6174 203d    """..    cat =
+0000cd60: 2066 6974 732e 6f70 656e 2863 6174 616c   fits.open(catal
+0000cd70: 6f67 290a 2020 2020 6361 745f 6461 7461  og).    cat_data
+0000cd80: 203d 2063 6174 5b31 5d2e 6461 7461 0a0a   = cat[1].data..
+0000cd90: 2020 2020 7820 3d20 6361 745f 6461 7461      x = cat_data
+0000cda0: 2e63 6f6c 756d 6e73 5b27 585f 494d 4147  .columns['X_IMAG
+0000cdb0: 4527 5d2e 6172 7261 790a 2020 2020 7920  E'].array.    y 
+0000cdc0: 3d20 6361 745f 6461 7461 2e63 6f6c 756d  = cat_data.colum
+0000cdd0: 6e73 5b27 595f 494d 4147 4527 5d2e 6172  ns['Y_IMAGE'].ar
+0000cde0: 7261 790a 0a20 2020 2023 204e 6f72 6d61  ray..    # Norma
+0000cdf0: 6c69 7a65 2058 2061 6e64 2059 0a20 2020  lize X and Y.   
+0000ce00: 2078 5f61 6c69 676e 2c20 795f 616c 6967   x_align, y_alig
+0000ce10: 6e20 3d20 616c 6967 6e5f 7370 6c75 735f  n = align_splus_
+0000ce20: 7879 2878 2c20 7929 0a0a 2020 2020 2320  xy(x, y)..    # 
+0000ce30: 4372 6561 7465 206e 6577 2066 6974 7320  Create new fits 
+0000ce40: 6361 7461 6c6f 6720 7769 7468 206e 6577  catalog with new
+0000ce50: 2063 6f6c 756d 6e73 0a20 2020 2063 6f72   columns.    cor
+0000ce60: 725f 6461 7461 203d 2063 6174 5f64 6174  r_data = cat_dat
+0000ce70: 612e 636f 6c75 6d6e 730a 0a20 2020 2063  a.columns..    c
+0000ce80: 6f72 725f 6461 7461 202b 3d20 6669 7473  orr_data += fits
+0000ce90: 2e43 6f6c 756d 6e28 6e61 6d65 3d27 585f  .Column(name='X_
+0000cea0: 414c 4947 4e27 2c0a 2020 2020 2020 2020  ALIGN',.        
+0000ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cec0: 2020 2020 2066 6f72 6d61 743d 2731 4527       format='1E'
+0000ced0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000cee0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000cef0: 7272 6179 3d78 5f61 6c69 676e 290a 0a20  rray=x_align).. 
+0000cf00: 2020 2063 6f72 725f 6461 7461 202b 3d20     corr_data += 
+0000cf10: 6669 7473 2e43 6f6c 756d 6e28 6e61 6d65  fits.Column(name
+0000cf20: 3d27 595f 414c 4947 4e27 2c0a 2020 2020  ='Y_ALIGN',.    
+0000cf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cf40: 2020 2020 2020 2020 2066 6f72 6d61 743d           format=
+0000cf50: 2731 4527 2c0a 2020 2020 2020 2020 2020  '1E',.          
+0000cf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cf70: 2020 2061 7272 6179 3d79 5f61 6c69 676e     array=y_align
+0000cf80: 290a 0a20 2020 2023 2050 7265 7061 7265  )..    # Prepare
+0000cf90: 2062 696e 730a 2020 2020 7862 696e 735f   bins.    xbins_
+0000cfa0: 6772 6964 203d 206e 702e 6c69 6e73 7061  grid = np.linspa
+0000cfb0: 6365 2878 6269 6e73 5b30 5d2c 2078 6269  ce(xbins[0], xbi
+0000cfc0: 6e73 5b31 5d2c 2069 6e74 2878 6269 6e73  ns[1], int(xbins
+0000cfd0: 5b32 5d29 202b 2031 290a 2020 2020 7962  [2]) + 1).    yb
+0000cfe0: 696e 735f 6772 6964 203d 206e 702e 6c69  ins_grid = np.li
+0000cff0: 6e73 7061 6365 2879 6269 6e73 5b30 5d2c  nspace(ybins[0],
+0000d000: 2079 6269 6e73 5b31 5d2c 2069 6e74 2879   ybins[1], int(y
+0000d010: 6269 6e73 5b32 5d29 202b 2031 290a 0a20  bins[2]) + 1).. 
+0000d020: 2020 2078 6269 6e73 5f69 6420 3d20 6e70     xbins_id = np
+0000d030: 2e61 7272 6179 2872 616e 6765 2869 6e74  .array(range(int
+0000d040: 2878 6269 6e73 5b32 5d29 202b 2031 2929  (xbins[2]) + 1))
+0000d050: 0a20 2020 2079 6269 6e73 5f69 6420 3d20  .    ybins_id = 
+0000d060: 6e70 2e61 7272 6179 2872 616e 6765 2869  np.array(range(i
+0000d070: 6e74 2879 6269 6e73 5b32 5d29 202b 2031  nt(ybins[2]) + 1
+0000d080: 2929 0a0a 2020 2020 2320 4c6f 6164 2063  ))..    # Load c
+0000d090: 6f72 7265 6374 696f 6e73 0a20 2020 2063  orrections.    c
+0000d0a0: 6f72 7265 6374 696f 6e73 203d 206e 702e  orrections = np.
+0000d0b0: 6c6f 6164 286d 6170 5f66 696c 6529 0a0a  load(map_file)..
+0000d0c0: 2020 2020 2320 4170 706c 7920 636f 7272      # Apply corr
+0000d0d0: 6563 7469 6f6e 730a 2020 2020 666f 7220  ections.    for 
+0000d0e0: 6b20 696e 2072 616e 6765 286c 656e 2863  k in range(len(c
+0000d0f0: 6174 5f64 6174 6129 293a 0a20 2020 2020  at_data)):.     
+0000d100: 2020 2078 5f73 6f75 7263 6520 3d20 785f     x_source = x_
+0000d110: 616c 6967 6e5b 6b5d 0a20 2020 2020 2020  align[k].       
+0000d120: 2079 5f73 6f75 7263 6520 3d20 795f 616c   y_source = y_al
+0000d130: 6967 6e5b 6b5d 0a0a 2020 2020 2020 2020  ign[k]..        
+0000d140: 2320 4765 7420 6465 6c74 6120 6d61 6720  # Get delta mag 
+0000d150: 2869 6620 6769 7665 6e20 6f6e 2074 6865  (if given on the
+0000d160: 2063 6f72 7265 6374 696f 6e20 6d61 7020   correction map 
+0000d170: 666f 7220 7468 6973 2070 6f73 6974 696f  for this positio
+0000d180: 6e29 0a20 2020 2020 2020 2074 7279 3a0a  n).        try:.
+0000d190: 2020 2020 2020 2020 2020 2020 2320 4669              # Fi
+0000d1a0: 6e64 2069 6473 206f 6620 7468 6520 6269  nd ids of the bi
+0000d1b0: 6e20 7468 6174 2063 6f6e 7461 696e 7320  n that contains 
+0000d1c0: 7468 6520 736f 7572 6365 0a20 2020 2020  the source.     
+0000d1d0: 2020 2020 2020 2062 696e 5f73 6f75 7263         bin_sourc
+0000d1e0: 655f 6920 3d20 7862 696e 735f 6964 5b78  e_i = xbins_id[x
+0000d1f0: 6269 6e73 5f67 7269 6420 3c3d 2078 5f73  bins_grid <= x_s
+0000d200: 6f75 7263 655d 5b2d 315d 0a20 2020 2020  ource][-1].     
+0000d210: 2020 2020 2020 2062 696e 5f73 6f75 7263         bin_sourc
+0000d220: 655f 6a20 3d20 7962 696e 735f 6964 5b79  e_j = ybins_id[y
+0000d230: 6269 6e73 5f67 7269 6420 3c3d 2079 5f73  bins_grid <= y_s
+0000d240: 6f75 7263 655d 5b2d 315d 0a0a 2020 2020  ource][-1]..    
+0000d250: 2020 2020 2020 2020 6465 6c74 615f 6d61          delta_ma
+0000d260: 6720 3d20 636f 7272 6563 7469 6f6e 735b  g = corrections[
+0000d270: 6269 6e5f 736f 7572 6365 5f69 2c20 6269  bin_source_i, bi
+0000d280: 6e5f 736f 7572 6365 5f6a 5d0a 2020 2020  n_source_j].    
+0000d290: 2020 2020 2020 2020 6465 6c74 615f 666c          delta_fl
+0000d2a0: 7578 5f66 7261 6320 3d20 3130 2e30 202a  ux_frac = 10.0 *
+0000d2b0: 2a20 282d 2864 656c 7461 5f6d 6167 202f  * (-(delta_mag /
+0000d2c0: 2032 2e35 2929 0a0a 2020 2020 2020 2020   2.5))..        
+0000d2d0: 6578 6365 7074 2049 6e64 6578 4572 726f  except IndexErro
+0000d2e0: 723a 0a20 2020 2020 2020 2020 2020 2064  r:.            d
+0000d2f0: 656c 7461 5f6d 6167 203d 2030 0a20 2020  elta_mag = 0.   
+0000d300: 2020 2020 2020 2020 2064 656c 7461 5f66           delta_f
+0000d310: 6c75 785f 6672 6163 203d 2031 0a0a 2020  lux_frac = 1..  
+0000d320: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0000d330: 2020 2020 2020 2069 6620 636f 7272 5f64         if corr_d
+0000d340: 6174 615b 274d 4147 5f41 5554 4f27 5d2e  ata['MAG_AUTO'].
+0000d350: 6172 7261 795b 6b5d 2021 3d20 3939 3a0a  array[k] != 99:.
+0000d360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d370: 636f 7272 5f64 6174 615b 274d 4147 5f41  corr_data['MAG_A
+0000d380: 5554 4f27 5d2e 6172 7261 795b 6b5d 202b  UTO'].array[k] +
+0000d390: 3d20 6465 6c74 615f 6d61 670a 2020 2020  = delta_mag.    
+0000d3a0: 2020 2020 2020 2020 636f 7272 5f64 6174          corr_dat
+0000d3b0: 615b 2746 4c55 585f 4155 544f 275d 2e61  a['FLUX_AUTO'].a
+0000d3c0: 7272 6179 5b6b 5d20 2a3d 2064 656c 7461  rray[k] *= delta
+0000d3d0: 5f66 6c75 785f 6672 6163 0a20 2020 2020  _flux_frac.     
+0000d3e0: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
+0000d3f0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+0000d400: 7061 7373 0a0a 2020 2020 2020 2020 7472  pass..        tr
+0000d410: 793a 0a20 2020 2020 2020 2020 2020 2069  y:.            i
+0000d420: 6620 636f 7272 5f64 6174 615b 274d 4147  f corr_data['MAG
+0000d430: 5f49 534f 275d 2e61 7272 6179 5b6b 5d20  _ISO'].array[k] 
+0000d440: 213d 2039 393a 0a20 2020 2020 2020 2020  != 99:.         
+0000d450: 2020 2020 2020 2063 6f72 725f 6461 7461         corr_data
+0000d460: 5b27 4d41 475f 4953 4f27 5d2e 6172 7261  ['MAG_ISO'].arra
+0000d470: 795b 6b5d 202b 3d20 6465 6c74 615f 6d61  y[k] += delta_ma
+0000d480: 670a 2020 2020 2020 2020 2020 2020 636f  g.            co
+0000d490: 7272 5f64 6174 615b 2746 4c55 585f 4953  rr_data['FLUX_IS
+0000d4a0: 4f27 5d2e 6172 7261 795b 6b5d 202a 3d20  O'].array[k] *= 
+0000d4b0: 6465 6c74 615f 666c 7578 5f66 7261 630a  delta_flux_frac.
+0000d4c0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+0000d4d0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+0000d4e0: 2020 2020 2070 6173 730a 0a20 2020 2020       pass..     
+0000d4f0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000d500: 2020 2020 6966 2063 6f72 725f 6461 7461      if corr_data
+0000d510: 5b27 4d41 475f 5045 5452 4f27 5d2e 6172  ['MAG_PETRO'].ar
+0000d520: 7261 795b 6b5d 2021 3d20 3939 3a0a 2020  ray[k] != 99:.  
+0000d530: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0000d540: 7272 5f64 6174 615b 274d 4147 5f50 4554  rr_data['MAG_PET
+0000d550: 524f 275d 2e61 7272 6179 5b6b 5d20 2b3d  RO'].array[k] +=
+0000d560: 2064 656c 7461 5f6d 6167 0a20 2020 2020   delta_mag.     
+0000d570: 2020 2020 2020 2063 6f72 725f 6461 7461         corr_data
+0000d580: 5b27 464c 5558 5f50 4554 524f 275d 2e61  ['FLUX_PETRO'].a
+0000d590: 7272 6179 5b6b 5d20 2a3d 2064 656c 7461  rray[k] *= delta
+0000d5a0: 5f66 6c75 785f 6672 6163 0a20 2020 2020  _flux_frac.     
+0000d5b0: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
+0000d5c0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+0000d5d0: 7061 7373 0a0a 2020 2020 2020 2020 7472  pass..        tr
+0000d5e0: 793a 0a20 2020 2020 2020 2020 2020 2066  y:.            f
+0000d5f0: 203d 2063 6f72 725f 6461 7461 5b27 4d41   = corr_data['MA
+0000d600: 475f 4150 4552 275d 2e61 7272 6179 5b6b  G_APER'].array[k
+0000d610: 5d20 213d 2039 390a 2020 2020 2020 2020  ] != 99.        
+0000d620: 2020 2020 636f 7272 5f64 6174 615b 274d      corr_data['M
+0000d630: 4147 5f41 5045 5227 5d2e 6172 7261 795b  AG_APER'].array[
+0000d640: 6b5d 5b66 5d20 2b3d 2064 656c 7461 5f6d  k][f] += delta_m
+0000d650: 6167 0a20 2020 2020 2020 2020 2020 2063  ag.            c
+0000d660: 6f72 725f 6461 7461 5b27 464c 5558 5f41  orr_data['FLUX_A
+0000d670: 5045 5227 5d2e 6172 7261 795b 6b5d 202a  PER'].array[k] *
+0000d680: 3d20 6465 6c74 615f 666c 7578 5f66 7261  = delta_flux_fra
+0000d690: 630a 2020 2020 2020 2020 6578 6365 7074  c.        except
+0000d6a0: 204b 6579 4572 726f 723a 0a20 2020 2020   KeyError:.     
+0000d6b0: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+0000d6c0: 2020 2020 2023 7472 793a 0a20 2020 2020       #try:.     
+0000d6d0: 2020 2023 2020 2020 6620 3d20 636f 7272     #    f = corr
+0000d6e0: 5f64 6174 615b 274d 4147 5f41 5045 5227  _data['MAG_APER'
+0000d6f0: 5d2e 6172 7261 795b 6b5d 2021 3d20 3939  ].array[k] != 99
+0000d700: 0a20 2020 2020 2020 2023 2020 2020 636f  .        #    co
+0000d710: 7272 5f64 6174 615b 274d 4147 5f41 5045  rr_data['MAG_APE
+0000d720: 5227 5d2e 6172 7261 795b 6b5d 5b66 5d20  R'].array[k][f] 
+0000d730: 2b3d 2064 656c 7461 5f6d 6167 0a20 2020  += delta_mag.   
 0000d740: 2020 2020 2023 2020 2020 636f 7272 5f64       #    corr_d
-0000d750: 6174 615b 274d 4147 5f41 5045 5227 5d2e  ata['MAG_APER'].
-0000d760: 6172 7261 795b 6b5d 5b66 5d20 2b3d 2064  array[k][f] += d
-0000d770: 656c 7461 5f6d 6167 0a20 2020 2020 2020  elta_mag.       
-0000d780: 2023 2020 2020 636f 7272 5f64 6174 615b   #    corr_data[
-0000d790: 2746 4c55 585f 4150 4552 275d 2e61 7272  'FLUX_APER'].arr
-0000d7a0: 6179 5b6b 5d20 2a3d 2064 656c 7461 5f66  ay[k] *= delta_f
-0000d7b0: 6c75 785f 6672 6163 0a20 2020 2020 2020  lux_frac.       
-0000d7c0: 2023 6578 6365 7074 204b 6579 4572 726f   #except KeyErro
-0000d7d0: 723a 0a20 2020 2020 2020 2023 2020 2020  r:.        #    
-0000d7e0: 7061 7373 0a0a 2020 2020 2020 2020 7472  pass..        tr
-0000d7f0: 793a 0a20 2020 2020 2020 2020 2020 2069  y:.            i
-0000d800: 6620 636f 7272 5f64 6174 615b 274d 555f  f corr_data['MU_
-0000d810: 4d41 5827 5d2e 6172 7261 795b 6b5d 2021  MAX'].array[k] !
-0000d820: 3d20 3939 3a0a 2020 2020 2020 2020 2020  = 99:.          
-0000d830: 2020 2020 2020 636f 7272 5f64 6174 615b        corr_data[
-0000d840: 274d 555f 4d41 5827 5d2e 6172 7261 795b  'MU_MAX'].array[
-0000d850: 6b5d 202b 3d20 6465 6c74 615f 6d61 670a  k] += delta_mag.
-0000d860: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-0000d870: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
-0000d880: 2020 2020 2070 6173 730a 0a20 2020 2020       pass..     
-0000d890: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0000d8a0: 2020 2020 6966 2063 6f72 725f 6461 7461      if corr_data
-0000d8b0: 5b27 4d55 5f54 4852 4553 484f 4c44 275d  ['MU_THRESHOLD']
-0000d8c0: 2e61 7272 6179 5b6b 5d20 213d 2039 393a  .array[k] != 99:
-0000d8d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d8e0: 2063 6f72 725f 6461 7461 5b27 4d55 5f54   corr_data['MU_T
-0000d8f0: 4852 4553 484f 4c44 275d 2e61 7272 6179  HRESHOLD'].array
-0000d900: 5b6b 5d20 2b3d 2064 656c 7461 5f6d 6167  [k] += delta_mag
-0000d910: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0000d920: 4b65 7945 7272 6f72 3a0a 2020 2020 2020  KeyError:.      
-0000d930: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
-0000d940: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0000d950: 2020 2020 2063 6f72 725f 6461 7461 5b27       corr_data['
-0000d960: 4241 434b 4752 4f55 4e44 275d 2e61 7272  BACKGROUND'].arr
-0000d970: 6179 5b6b 5d20 2a3d 2064 656c 7461 5f66  ay[k] *= delta_f
-0000d980: 6c75 785f 6672 6163 0a20 2020 2020 2020  lux_frac.       
-0000d990: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
-0000d9a0: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
-0000d9b0: 7373 0a0a 2020 2020 2020 2020 7472 793a  ss..        try:
-0000d9c0: 0a20 2020 2020 2020 2020 2020 2063 6f72  .            cor
-0000d9d0: 725f 6461 7461 5b27 5448 5245 5348 4f4c  r_data['THRESHOL
-0000d9e0: 4427 5d2e 6172 7261 795b 6b5d 202a 3d20  D'].array[k] *= 
-0000d9f0: 6465 6c74 615f 666c 7578 5f66 7261 630a  delta_flux_frac.
-0000da00: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-0000da10: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
-0000da20: 2020 2020 2070 6173 730a 0a20 2020 2023       pass..    #
-0000da30: 2053 6176 6520 636f 7272 6563 7465 6420   Save corrected 
-0000da40: 6461 7461 2074 6f20 7361 7665 5f66 696c  data to save_fil
-0000da50: 6520 6669 7473 2063 6174 616c 6f67 0a20  e fits catalog. 
-0000da60: 2020 2068 6475 203d 2066 6974 732e 4269     hdu = fits.Bi
-0000da70: 6e54 6162 6c65 4844 552e 6672 6f6d 5f63  nTableHDU.from_c
-0000da80: 6f6c 756d 6e73 2863 6f72 725f 6461 7461  olumns(corr_data
-0000da90: 290a 2020 2020 6864 752e 7772 6974 6574  ).    hdu.writet
-0000daa0: 6f28 7361 7665 5f66 696c 6529 0a0a 0a64  o(save_file)...d
-0000dab0: 6566 2061 7070 6c79 5f78 795f 636f 7272  ef apply_xy_corr
-0000dac0: 6563 7469 6f6e 5f70 7366 2863 6174 616c  ection_psf(catal
-0000dad0: 6f67 2c20 7361 7665 5f66 696c 652c 206d  og, save_file, m
-0000dae0: 6170 5f66 696c 652c 2078 6269 6e73 2c20  ap_file, xbins, 
-0000daf0: 7962 696e 7329 3a0a 2020 2020 2222 220a  ybins):.    """.
-0000db00: 2020 2020 4170 706c 6965 7320 5859 2063      Applies XY c
-0000db10: 6f72 7265 6374 696f 6e73 2074 6f20 7468  orrections to th
-0000db20: 6520 532d 504c 5553 2070 7366 2070 686f  e S-PLUS psf pho
-0000db30: 746f 6d65 7472 7920 6361 7461 6c6f 6773  tometry catalogs
-0000db40: 2e0a 0a20 2020 2054 776f 2061 6464 6974  ...    Two addit
-0000db50: 696f 6e61 6c20 636f 6c75 6d6e 7320 6172  ional columns ar
-0000db60: 6520 6372 6561 7465 643a 2058 5f41 4c49  e created: X_ALI
-0000db70: 474e 2061 6e64 2059 5f41 4c49 474e 2c20  GN and Y_ALIGN, 
-0000db80: 636f 7272 6573 706f 6e64 696e 6720 746f  corresponding to
-0000db90: 0a20 2020 206e 6f72 6d61 6c69 7a65 6420  .    normalized 
-0000dba0: 585f 494d 4147 4520 616e 6420 595f 494d  X_IMAGE and Y_IM
-0000dbb0: 4147 4520 706f 7369 7469 6f6e 7320 286f  AGE positions (o
-0000dbc0: 7269 6769 6e20 6d6f 7665 6420 746f 2062  rigin moved to b
-0000dbd0: 6f74 746f 6d20 6c65 6674 0a20 2020 2063  ottom left.    c
-0000dbe0: 6f72 6e65 722c 2061 6e64 2063 6f6f 7264  orner, and coord
-0000dbf0: 696e 6174 6573 2072 6f74 6174 6520 746f  inates rotate to
-0000dc00: 206d 6174 6368 2058 2061 6e64 2059 2061   match X and Y a
-0000dc10: 7869 7329 2e0a 0a20 2020 2050 6172 616d  xis)...    Param
-0000dc20: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
-0000dc30: 2d2d 2d2d 0a20 2020 2063 6174 616c 6f67  ----.    catalog
-0000dc40: 203a 2073 7472 0a20 2020 2020 2020 204c   : str.        L
-0000dc50: 6f63 6174 696f 6e20 746f 2074 6865 2053  ocation to the S
-0000dc60: 4578 7472 6163 746f 7220 7068 6f74 6f6d  Extractor photom
-0000dc70: 6574 7279 206f 7574 7075 7420 6361 7461  etry output cata
-0000dc80: 6c6f 670a 0a20 2020 2073 6176 655f 6669  log..    save_fi
-0000dc90: 6c65 203a 2073 7472 0a20 2020 2020 2020  le : str.       
-0000dca0: 2044 6573 6972 6564 206c 6f63 6174 696f   Desired locatio
-0000dcb0: 6e20 746f 2073 6176 6520 7468 6520 5859  n to save the XY
-0000dcc0: 2063 6f72 7265 6374 6564 2063 6174 616c   corrected catal
-0000dcd0: 6f67 0a0a 2020 2020 6d61 705f 6669 6c65  og..    map_file
-0000dce0: 203a 2073 7472 0a20 2020 2020 2020 204c   : str.        L
-0000dcf0: 6f63 6174 696f 6e20 6f66 2074 6865 2078  ocation of the x
-0000dd00: 7920 636f 7272 6563 7469 6f6e 206d 6170  y correction map
-0000dd10: 2028 6d75 7374 2062 6520 6e75 6d70 7920   (must be numpy 
-0000dd20: 6e70 7920 6669 6c65 290a 0a20 2020 2078  npy file)..    x
-0000dd30: 6269 6e73 203a 206c 6973 740a 2020 2020  bins : list.    
-0000dd40: 2020 2020 7862 696e 7320 6f66 2074 6865      xbins of the
-0000dd50: 2063 6f72 7265 6374 696f 6e20 6d61 7020   correction map 
-0000dd60: 2873 7461 7274 2c20 656e 642c 204e 6269  (start, end, Nbi
-0000dd70: 6e73 2920 5b69 6e20 7069 7865 6c73 5d0a  ns) [in pixels].
-0000dd80: 0a20 2020 2079 6269 6e73 203a 206c 6973  .    ybins : lis
-0000dd90: 740a 2020 2020 2020 2020 7962 696e 7320  t.        ybins 
-0000dda0: 6f66 2074 6865 2063 6f72 7265 6374 696f  of the correctio
-0000ddb0: 6e20 6d61 7020 2873 7461 7274 2c20 656e  n map (start, en
-0000ddc0: 642c 204e 6269 6e73 2920 5b69 6e20 7069  d, Nbins) [in pi
-0000ddd0: 7865 6c73 5d0a 0a20 2020 2052 6574 7572  xels]..    Retur
-0000dde0: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-0000ddf0: 2020 2053 6176 6573 2058 5920 636f 7272     Saves XY corr
-0000de00: 6563 7465 6420 6361 7461 6c6f 6720 696e  ected catalog in
-0000de10: 2074 6865 2064 6573 6972 6564 206c 6f63   the desired loc
-0000de20: 6174 696f 6e20 2870 6172 616d 3a73 6176  ation (param:sav
-0000de30: 655f 6669 6c65 290a 2020 2020 2222 220a  e_file).    """.
-0000de40: 0a0a 2020 2020 2320 4c6f 6164 2066 696c  ..    # Load fil
-0000de50: 7465 7220 6361 7461 6c6f 6775 650a 2020  ter catalogue.  
-0000de60: 2020 6361 745f 6461 7461 203d 206c 6f61    cat_data = loa
-0000de70: 645f 6461 7461 2863 6174 616c 6f67 290a  d_data(catalog).
-0000de80: 0a20 2020 2078 203d 2063 6174 5f64 6174  .    x = cat_dat
-0000de90: 612e 6c6f 635b 3a2c 2778 706f 7327 5d2e  a.loc[:,'xpos'].
-0000dea0: 7661 6c75 6573 0a20 2020 2079 203d 2063  values.    y = c
-0000deb0: 6174 5f64 6174 612e 6c6f 635b 3a2c 2779  at_data.loc[:,'y
-0000dec0: 706f 7327 5d2e 7661 6c75 6573 0a0a 2020  pos'].values..  
-0000ded0: 2020 2320 4e6f 726d 616c 697a 6520 5820    # Normalize X 
-0000dee0: 616e 6420 590a 2020 2020 785f 616c 6967  and Y.    x_alig
-0000def0: 6e2c 2079 5f61 6c69 676e 203d 2061 6c69  n, y_align = ali
-0000df00: 676e 5f73 706c 7573 5f78 7928 782c 2079  gn_splus_xy(x, y
-0000df10: 290a 0a20 2020 2023 2043 7265 6174 6520  )..    # Create 
-0000df20: 6e65 7720 6669 7473 2063 6174 616c 6f67  new fits catalog
-0000df30: 2077 6974 6820 6e65 7720 636f 6c75 6d6e   with new column
-0000df40: 730a 2020 2020 636f 7272 5f64 6174 6120  s.    corr_data 
-0000df50: 3d20 6361 745f 6461 7461 0a0a 2020 2020  = cat_data..    
-0000df60: 636f 7272 5f64 6174 615b 2758 5f41 4c49  corr_data['X_ALI
-0000df70: 474e 275d 203d 2078 5f61 6c69 676e 0a20  GN'] = x_align. 
-0000df80: 2020 2063 6f72 725f 6461 7461 5b27 595f     corr_data['Y_
-0000df90: 414c 4947 4e27 5d20 3d20 795f 616c 6967  ALIGN'] = y_alig
-0000dfa0: 6e0a 0a20 2020 2023 2050 7265 7061 7265  n..    # Prepare
-0000dfb0: 2062 696e 730a 2020 2020 7862 696e 735f   bins.    xbins_
-0000dfc0: 6772 6964 203d 206e 702e 6c69 6e73 7061  grid = np.linspa
-0000dfd0: 6365 2878 6269 6e73 5b30 5d2c 2078 6269  ce(xbins[0], xbi
-0000dfe0: 6e73 5b31 5d2c 2069 6e74 2878 6269 6e73  ns[1], int(xbins
-0000dff0: 5b32 5d29 202b 2031 290a 2020 2020 7962  [2]) + 1).    yb
-0000e000: 696e 735f 6772 6964 203d 206e 702e 6c69  ins_grid = np.li
-0000e010: 6e73 7061 6365 2879 6269 6e73 5b30 5d2c  nspace(ybins[0],
-0000e020: 2079 6269 6e73 5b31 5d2c 2069 6e74 2879   ybins[1], int(y
-0000e030: 6269 6e73 5b32 5d29 202b 2031 290a 0a20  bins[2]) + 1).. 
-0000e040: 2020 2078 6269 6e73 5f69 6420 3d20 6e70     xbins_id = np
-0000e050: 2e61 7272 6179 2872 616e 6765 2869 6e74  .array(range(int
-0000e060: 2878 6269 6e73 5b32 5d29 202b 2031 2929  (xbins[2]) + 1))
-0000e070: 0a20 2020 2079 6269 6e73 5f69 6420 3d20  .    ybins_id = 
-0000e080: 6e70 2e61 7272 6179 2872 616e 6765 2869  np.array(range(i
-0000e090: 6e74 2879 6269 6e73 5b32 5d29 202b 2031  nt(ybins[2]) + 1
-0000e0a0: 2929 0a0a 2020 2020 2320 4c6f 6164 2063  ))..    # Load c
-0000e0b0: 6f72 7265 6374 696f 6e73 0a20 2020 2063  orrections.    c
-0000e0c0: 6f72 7265 6374 696f 6e73 203d 206e 702e  orrections = np.
-0000e0d0: 6c6f 6164 286d 6170 5f66 696c 6529 0a0a  load(map_file)..
-0000e0e0: 2020 2020 2320 4170 706c 7920 636f 7272      # Apply corr
-0000e0f0: 6563 7469 6f6e 730a 2020 2020 666f 7220  ections.    for 
-0000e100: 6b20 696e 2072 616e 6765 286c 656e 2863  k in range(len(c
-0000e110: 6174 5f64 6174 6129 293a 0a20 2020 2020  at_data)):.     
-0000e120: 2020 2078 5f73 6f75 7263 6520 3d20 785f     x_source = x_
-0000e130: 616c 6967 6e5b 6b5d 0a20 2020 2020 2020  align[k].       
-0000e140: 2079 5f73 6f75 7263 6520 3d20 795f 616c   y_source = y_al
-0000e150: 6967 6e5b 6b5d 0a0a 2020 2020 2020 2020  ign[k]..        
-0000e160: 2320 4765 7420 6465 6c74 6120 6d61 6720  # Get delta mag 
-0000e170: 2869 6620 6769 7665 6e20 6f6e 2074 6865  (if given on the
-0000e180: 2063 6f72 7265 6374 696f 6e20 6d61 7020   correction map 
-0000e190: 666f 7220 7468 6973 2070 6f73 6974 696f  for this positio
-0000e1a0: 6e29 0a20 2020 2020 2020 2074 7279 3a0a  n).        try:.
-0000e1b0: 2020 2020 2020 2020 2020 2020 2320 4669              # Fi
-0000e1c0: 6e64 2069 6473 206f 6620 7468 6520 6269  nd ids of the bi
-0000e1d0: 6e20 7468 6174 2063 6f6e 7461 696e 7320  n that contains 
-0000e1e0: 7468 6520 736f 7572 6365 0a20 2020 2020  the source.     
-0000e1f0: 2020 2020 2020 2062 696e 5f73 6f75 7263         bin_sourc
-0000e200: 655f 6920 3d20 7862 696e 735f 6964 5b78  e_i = xbins_id[x
-0000e210: 6269 6e73 5f67 7269 6420 3c3d 2078 5f73  bins_grid <= x_s
-0000e220: 6f75 7263 655d 5b2d 315d 0a20 2020 2020  ource][-1].     
-0000e230: 2020 2020 2020 2062 696e 5f73 6f75 7263         bin_sourc
-0000e240: 655f 6a20 3d20 7962 696e 735f 6964 5b79  e_j = ybins_id[y
-0000e250: 6269 6e73 5f67 7269 6420 3c3d 2079 5f73  bins_grid <= y_s
-0000e260: 6f75 7263 655d 5b2d 315d 0a0a 2020 2020  ource][-1]..    
-0000e270: 2020 2020 2020 2020 6465 6c74 615f 6d61          delta_ma
-0000e280: 6720 3d20 636f 7272 6563 7469 6f6e 735b  g = corrections[
-0000e290: 6269 6e5f 736f 7572 6365 5f69 2c20 6269  bin_source_i, bi
-0000e2a0: 6e5f 736f 7572 6365 5f6a 5d0a 0a20 2020  n_source_j]..   
-0000e2b0: 2020 2020 2065 7863 6570 7420 496e 6465       except Inde
-0000e2c0: 7845 7272 6f72 3a0a 2020 2020 2020 2020  xError:.        
-0000e2d0: 2020 2020 6465 6c74 615f 6d61 6720 3d20      delta_mag = 
-0000e2e0: 300a 0a20 2020 2020 2020 2074 7279 3a0a  0..        try:.
-0000e2f0: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-0000e300: 6f72 725f 6461 7461 2e6c 6f63 5b3a 2c27  orr_data.loc[:,'
-0000e310: 6669 746d 6167 275d 2e76 616c 7565 735b  fitmag'].values[
-0000e320: 6b5d 2021 3d20 3939 3a0a 2020 2020 2020  k] != 99:.      
-0000e330: 2020 2020 2020 2020 2020 636f 7272 5f64            corr_d
-0000e340: 6174 612e 6c6f 635b 3a2c 2766 6974 6d61  ata.loc[:,'fitma
-0000e350: 6727 5d2e 7661 6c75 6573 5b6b 5d20 2b3d  g'].values[k] +=
-0000e360: 2064 656c 7461 5f6d 6167 0a20 2020 2020   delta_mag.     
-0000e370: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
-0000e380: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-0000e390: 7061 7373 0a0a 2020 2020 2320 5361 7665  pass..    # Save
-0000e3a0: 2063 6f72 7265 6374 6564 2064 6174 6120   corrected data 
-0000e3b0: 746f 2073 6176 655f 6669 6c65 2066 6974  to save_file fit
-0000e3c0: 7320 6361 7461 6c6f 670a 2020 2020 7769  s catalog.    wi
-0000e3d0: 7468 206f 7065 6e28 7361 7665 5f66 696c  th open(save_fil
-0000e3e0: 652c 2027 7727 2920 6173 2066 3a0a 2020  e, 'w') as f:.  
-0000e3f0: 2020 2020 2020 662e 7772 6974 6528 2223        f.write("#
-0000e400: 2022 290a 2020 2020 2020 2020 636f 7272   ").        corr
-0000e410: 5f64 6174 612e 746f 5f63 7376 2866 2c20  _data.to_csv(f, 
-0000e420: 696e 6465 7820 3d20 4661 6c73 652c 2073  index = False, s
-0000e430: 6570 203d 2022 2022 290a 0a0a 6465 6620  ep = " ")...def 
-0000e440: 6765 745f 7879 5f63 6f72 7265 6374 696f  get_xy_correctio
-0000e450: 6e5f 6772 6964 2864 6174 615f 6669 6c65  n_grid(data_file
-0000e460: 2c20 7361 7665 5f66 696c 652c 206d 6167  , save_file, mag
-0000e470: 2c20 6d61 675f 7265 662c 2078 6269 6e73  , mag_ref, xbins
-0000e480: 2c20 7962 696e 7329 3a0a 0a20 2020 2078  , ybins):..    x
-0000e490: 4e62 696e 7320 3d20 7862 696e 735b 325d  Nbins = xbins[2]
-0000e4a0: 0a20 2020 2079 4e62 696e 7320 3d20 7962  .    yNbins = yb
-0000e4b0: 696e 735b 325d 0a0a 2020 2020 2320 4765  ins[2]..    # Ge
-0000e4c0: 7420 7661 6c75 6573 206f 6620 6269 6e73  t values of bins
-0000e4d0: 206c 696d 6974 7320 616e 6420 6365 6e74   limits and cent
-0000e4e0: 6572 730a 0a20 2020 2078 6269 6e73 203d  ers..    xbins =
-0000e4f0: 206e 702e 6c69 6e73 7061 6365 2878 6269   np.linspace(xbi
-0000e500: 6e73 5b30 5d2c 2078 6269 6e73 5b31 5d2c  ns[0], xbins[1],
-0000e510: 2078 6269 6e73 5b32 5d2b 3129 0a20 2020   xbins[2]+1).   
-0000e520: 2079 6269 6e73 203d 206e 702e 6c69 6e73   ybins = np.lins
-0000e530: 7061 6365 2879 6269 6e73 5b30 5d2c 2079  pace(ybins[0], y
-0000e540: 6269 6e73 5b31 5d2c 2079 6269 6e73 5b32  bins[1], ybins[2
-0000e550: 5d2b 3129 0a0a 2020 2020 2320 6765 6e65  ]+1)..    # gene
-0000e560: 7261 7465 2074 6865 206d 6573 680a 0a20  rate the mesh.. 
-0000e570: 2020 2078 782c 2079 7920 3d20 6e70 2e6d     xx, yy = np.m
-0000e580: 6573 6867 7269 6428 7862 696e 732c 2079  eshgrid(xbins, y
-0000e590: 6269 6e73 2c20 7370 6172 7365 3d54 7275  bins, sparse=Tru
-0000e5a0: 6529 0a0a 2020 2020 636f 7272 6563 7469  e)..    correcti
-0000e5b0: 6f6e 7320 3d20 302a 7878 202b 2030 2a79  ons = 0*xx + 0*y
-0000e5c0: 790a 2020 2020 636f 7272 6563 7469 6f6e  y.    correction
-0000e5d0: 735f 7374 6420 3d20 6e70 2e6e 616e 2a78  s_std = np.nan*x
-0000e5e0: 7820 2b20 6e70 2e6e 616e 2a79 790a 0a20  x + np.nan*yy.. 
-0000e5f0: 2020 2023 204c 6f61 6420 6461 7461 0a20     # Load data. 
-0000e600: 2020 2064 6174 6120 3d20 6c6f 6164 5f64     data = load_d
-0000e610: 6174 6128 6461 7461 5f66 696c 6529 0a0a  ata(data_file)..
-0000e620: 2020 2020 5820 3d20 6461 7461 2e6c 6f63      X = data.loc
-0000e630: 5b3a 2c27 585f 414c 4947 4e27 5d2e 7661  [:,'X_ALIGN'].va
-0000e640: 6c75 6573 0a20 2020 2059 203d 2064 6174  lues.    Y = dat
-0000e650: 612e 6c6f 635b 3a2c 2759 5f41 4c49 474e  a.loc[:,'Y_ALIGN
-0000e660: 275d 2e76 616c 7565 730a 0a20 2020 2044  '].values..    D
-0000e670: 5a50 203d 2064 6174 612e 6c6f 635b 3a2c  ZP = data.loc[:,
-0000e680: 6d61 675f 7265 665d 2e76 616c 7565 7320  mag_ref].values 
-0000e690: 2d20 6461 7461 2e6c 6f63 5b3a 2c6d 6167  - data.loc[:,mag
-0000e6a0: 5d2e 7661 6c75 6573 0a0a 2020 2020 6d61  ].values..    ma
-0000e6b0: 675f 6375 7420 3d20 2864 6174 612e 6c6f  g_cut = (data.lo
-0000e6c0: 635b 3a2c 206d 6167 5d2e 7661 6c75 6573  c[:, mag].values
-0000e6d0: 203e 2031 3429 2026 2028 6461 7461 2e6c   > 14) & (data.l
-0000e6e0: 6f63 5b3a 2c20 6d61 675d 2e76 616c 7565  oc[:, mag].value
-0000e6f0: 7320 3c3d 2031 372e 3529 0a20 2020 2072  s <= 17.5).    r
-0000e700: 656d 6f76 655f 776f 7273 745f 6361 7365  emove_worst_case
-0000e710: 7320 3d20 6e70 2e61 6273 2844 5a50 2920  s = np.abs(DZP) 
-0000e720: 3c20 302e 320a 0a20 2020 2023 2046 696c  < 0.2..    # Fil
-0000e730: 6c20 6172 7261 7920 6f66 2063 6f72 7265  l array of corre
-0000e740: 6374 696f 6e73 0a20 2020 204e 5f64 6174  ctions.    N_dat
-0000e750: 6120 3d20 6c65 6e28 445a 505b 6d61 675f  a = len(DZP[mag_
-0000e760: 6375 7420 2620 7265 6d6f 7665 5f77 6f72  cut & remove_wor
-0000e770: 7374 5f63 6173 6573 5d29 0a20 2020 206d  st_cases]).    m
-0000e780: 696e 5f4e 5f64 6174 6120 3d20 302e 3035  in_N_data = 0.05
-0000e790: 2a4e 5f64 6174 612f 2878 4e62 696e 732a  *N_data/(xNbins*
-0000e7a0: 794e 6269 6e73 290a 0a20 2020 2066 6f72  yNbins)..    for
-0000e7b0: 2069 2069 6e20 7261 6e67 6528 784e 6269   i in range(xNbi
-0000e7c0: 6e73 293a 0a20 2020 2020 2020 2078 7365  ns):.        xse
-0000e7d0: 6c65 6374 203d 2028 5820 3e3d 2078 6269  lect = (X >= xbi
-0000e7e0: 6e73 5b69 5d29 2026 2028 5820 3c20 7862  ns[i]) & (X < xb
-0000e7f0: 696e 735b 692b 315d 290a 0a20 2020 2020  ins[i+1])..     
-0000e800: 2020 2066 6f72 206a 2069 6e20 7261 6e67     for j in rang
-0000e810: 6528 794e 6269 6e73 293a 0a20 2020 2020  e(yNbins):.     
-0000e820: 2020 2020 2020 2079 7365 6c65 6374 203d         yselect =
-0000e830: 2028 5920 3e3d 2079 6269 6e73 5b6a 5d29   (Y >= ybins[j])
-0000e840: 2026 2028 5920 3c20 7962 696e 735b 6a2b   & (Y < ybins[j+
-0000e850: 315d 290a 0a20 2020 2020 2020 2020 2020  1])..           
-0000e860: 2044 5a50 5f73 656c 6563 7420 3d20 445a   DZP_select = DZ
-0000e870: 505b 7873 656c 6563 7420 2620 7973 656c  P[xselect & ysel
-0000e880: 6563 7420 2620 6d61 675f 6375 7420 2620  ect & mag_cut & 
-0000e890: 7265 6d6f 7665 5f77 6f72 7374 5f63 6173  remove_worst_cas
-0000e8a0: 6573 5d0a 0a20 2020 2020 2020 2020 2020  es]..           
-0000e8b0: 2069 6620 6c65 6e28 445a 505f 7365 6c65   if len(DZP_sele
-0000e8c0: 6374 2920 3e20 6d69 6e5f 4e5f 6461 7461  ct) > min_N_data
-0000e8d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000e8e0: 2020 636f 7272 6563 7469 6f6e 735b 692c    corrections[i,
-0000e8f0: 6a5d 203d 206e 702e 6d65 616e 2844 5a50  j] = np.mean(DZP
-0000e900: 5f73 656c 6563 7429 0a0a 2020 2020 2020  _select)..      
-0000e910: 2020 2020 2020 636f 7272 6563 7469 6f6e        correction
-0000e920: 735f 7374 645b 692c 6a5d 203d 206e 702e  s_std[i,j] = np.
-0000e930: 7374 6428 445a 505f 7365 6c65 6374 290a  std(DZP_select).
-0000e940: 0a20 2020 2063 6f72 7265 6374 696f 6e73  .    corrections
-0000e950: 203d 2067 6175 7373 6961 6e5f 6669 6c74   = gaussian_filt
-0000e960: 6572 2863 6f72 7265 6374 696f 6e73 2c20  er(corrections, 
-0000e970: 7369 676d 613d 3129 0a0a 2020 2020 2320  sigma=1)..    # 
-0000e980: 5363 616c 6520 6f66 6673 6574 2062 7920  Scale offset by 
-0000e990: 6d65 616e 2076 616c 7565 2028 6f66 6673  mean value (offs
-0000e9a0: 6574 7320 6172 6520 6465 616c 7420 7769  ets are dealt wi
-0000e9b0: 7468 2069 6e20 616e 6f74 6865 7220 7374  th in another st
-0000e9c0: 6570 2023 2323 2323 2323 2323 0a20 2020  ep #########.   
-0000e9d0: 2063 6f72 7265 6374 696f 6e73 203d 2063   corrections = c
-0000e9e0: 6f72 7265 6374 696f 6e73 202d 206e 702e  orrections - np.
-0000e9f0: 6e61 6e6d 6561 6e28 445a 505b 6d61 675f  nanmean(DZP[mag_
-0000ea00: 6375 7420 2620 7265 6d6f 7665 5f77 6f72  cut & remove_wor
-0000ea10: 7374 5f63 6173 6573 5d29 0a0a 2020 2020  st_cases])..    
-0000ea20: 2320 5265 6d6f 7665 206e 616e 2076 616c  # Remove nan val
-0000ea30: 7565 730a 2020 2020 636f 7272 6563 7469  ues.    correcti
-0000ea40: 6f6e 735b 6e70 2e69 736e 616e 2863 6f72  ons[np.isnan(cor
-0000ea50: 7265 6374 696f 6e73 295d 203d 2030 0a0a  rections)] = 0..
-0000ea60: 2020 2020 6e70 2e73 6176 6528 7361 7665      np.save(save
-0000ea70: 5f66 696c 652c 2063 6f72 7265 6374 696f  _file, correctio
-0000ea80: 6e73 290a 0a0a 6465 6620 706c 6f74 5f78  ns)...def plot_x
-0000ea90: 795f 636f 7272 6563 7469 6f6e 5f67 7269  y_correction_gri
-0000eaa0: 6428 6772 6964 5f66 696c 652c 2073 6176  d(grid_file, sav
-0000eab0: 655f 6669 6c65 2c20 6d61 672c 2078 6269  e_file, mag, xbi
-0000eac0: 6e73 2c20 7962 696e 732c 0a20 2020 2020  ns, ybins,.     
-0000ead0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000eae0: 2020 2020 2020 2063 6d61 7020 3d20 4e6f         cmap = No
-0000eaf0: 6e65 2c20 636c 696d 203d 205b 2d30 2e30  ne, clim = [-0.0
-0000eb00: 352c 2030 2e30 355d 293a 0a0a 2020 2020  5, 0.05]):..    
-0000eb10: 2320 4765 7420 7661 6c75 6573 206f 6620  # Get values of 
-0000eb20: 6269 6e73 206c 696d 6974 7320 616e 6420  bins limits and 
-0000eb30: 6365 6e74 6572 730a 0a20 2020 2078 6269  centers..    xbi
-0000eb40: 6e73 5f67 7269 6420 3d20 6e70 2e6c 696e  ns_grid = np.lin
-0000eb50: 7370 6163 6528 7862 696e 735b 305d 2c20  space(xbins[0], 
-0000eb60: 7862 696e 735b 315d 2c20 7862 696e 735b  xbins[1], xbins[
-0000eb70: 325d 202b 2031 290a 2020 2020 7962 696e  2] + 1).    ybin
-0000eb80: 735f 6772 6964 203d 206e 702e 6c69 6e73  s_grid = np.lins
-0000eb90: 7061 6365 2879 6269 6e73 5b30 5d2c 2079  pace(ybins[0], y
-0000eba0: 6269 6e73 5b31 5d2c 2079 6269 6e73 5b32  bins[1], ybins[2
-0000ebb0: 5d20 2b20 3129 0a0a 2020 2020 2320 6765  ] + 1)..    # ge
-0000ebc0: 6e65 7261 7465 2074 6865 206d 6573 680a  nerate the mesh.
-0000ebd0: 0a20 2020 2078 782c 2079 7920 3d20 6e70  .    xx, yy = np
-0000ebe0: 2e6d 6573 6867 7269 6428 7862 696e 735f  .meshgrid(xbins_
-0000ebf0: 6772 6964 2c20 7962 696e 735f 6772 6964  grid, ybins_grid
-0000ec00: 2c20 7370 6172 7365 3d54 7275 6529 0a0a  , sparse=True)..
-0000ec10: 2020 2020 636f 7272 6563 7469 6f6e 7320      corrections 
-0000ec20: 3d20 6e70 2e6c 6f61 6428 6772 6964 5f66  = np.load(grid_f
-0000ec30: 696c 6529 0a0a 2020 2020 706c 742e 6669  ile)..    plt.fi
-0000ec40: 6775 7265 2866 6967 7369 7a65 3d28 382c  gure(figsize=(8,
-0000ec50: 2036 2e34 2929 0a0a 2020 2020 766d 696e   6.4))..    vmin
-0000ec60: 203d 2063 6c69 6d5b 305d 0a20 2020 2076   = clim[0].    v
-0000ec70: 6d61 7820 3d20 636c 696d 5b31 5d0a 0a20  max = clim[1].. 
-0000ec80: 2020 2069 6620 636d 6170 2069 7320 4e6f     if cmap is No
-0000ec90: 6e65 3a0a 2020 2020 2020 2020 636d 6170  ne:.        cmap
-0000eca0: 203d 2070 6c74 2e67 6574 5f63 6d61 7028   = plt.get_cmap(
-0000ecb0: 2273 6569 736d 6963 5f72 2229 0a0a 2020  "seismic_r")..  
-0000ecc0: 2020 636d 203d 2070 6c74 2e70 636f 6c6f    cm = plt.pcolo
-0000ecd0: 7228 7878 2c20 7979 2c20 636f 7272 6563  r(xx, yy, correc
-0000ece0: 7469 6f6e 732e 542c 2076 6d69 6e3d 766d  tions.T, vmin=vm
-0000ecf0: 696e 2c20 766d 6178 3d76 6d61 782c 2063  in, vmax=vmax, c
-0000ed00: 6d61 703d 636d 6170 290a 2020 2020 6362  map=cmap).    cb
-0000ed10: 6172 203d 2070 6c74 2e63 6f6c 6f72 6261  ar = plt.colorba
-0000ed20: 7228 636d 290a 2020 2020 6362 6172 2e73  r(cm).    cbar.s
-0000ed30: 6574 5f6c 6162 656c 2822 6f66 6673 6574  et_label("offset
-0000ed40: 2229 0a0a 2020 2020 706c 742e 766c 696e  ")..    plt.vlin
-0000ed50: 6573 2878 6269 6e73 5f67 7269 642c 2078  es(xbins_grid, x
-0000ed60: 6269 6e73 5b30 5d2c 2078 6269 6e73 5b31  bins[0], xbins[1
-0000ed70: 5d2c 206c 696e 6577 6964 7468 3d30 2e35  ], linewidth=0.5
-0000ed80: 2c20 616c 7068 613d 302e 3429 0a20 2020  , alpha=0.4).   
-0000ed90: 2070 6c74 2e68 6c69 6e65 7328 7962 696e   plt.hlines(ybin
-0000eda0: 735f 6772 6964 2c20 7962 696e 735b 305d  s_grid, ybins[0]
-0000edb0: 2c20 7962 696e 735b 315d 2c20 6c69 6e65  , ybins[1], line
-0000edc0: 7769 6474 683d 302e 352c 2061 6c70 6861  width=0.5, alpha
-0000edd0: 3d30 2e34 290a 0a20 2020 2070 6c74 2e67  =0.4)..    plt.g
-0000ede0: 6361 2829 2e73 6574 5f74 6974 6c65 2822  ca().set_title("
-0000edf0: 2573 206f 6666 7365 7473 2220 2520 6d61  %s offsets" % ma
-0000ee00: 6729 0a20 2020 2070 6c74 2e67 6361 2829  g).    plt.gca()
-0000ee10: 2e73 6574 5f78 6c61 6265 6c28 2258 5f41  .set_xlabel("X_A
-0000ee20: 4c49 474e 2229 0a20 2020 2070 6c74 2e67  LIGN").    plt.g
-0000ee30: 6361 2829 2e73 6574 5f79 6c61 6265 6c28  ca().set_ylabel(
-0000ee40: 2259 5f41 4c49 474e 2229 0a20 2020 2070  "Y_ALIGN").    p
-0000ee50: 6c74 2e67 6361 2829 2e73 6574 5f78 6c69  lt.gca().set_xli
-0000ee60: 6d28 2878 6269 6e73 5b30 5d2c 2078 6269  m((xbins[0], xbi
-0000ee70: 6e73 5b31 5d29 290a 2020 2020 706c 742e  ns[1])).    plt.
-0000ee80: 6763 6128 292e 7365 745f 796c 696d 2828  gca().set_ylim((
-0000ee90: 7962 696e 735b 305d 2c20 7962 696e 735b  ybins[0], ybins[
-0000eea0: 315d 2929 0a20 2020 2070 6c74 2e73 7562  1])).    plt.sub
-0000eeb0: 706c 6f74 735f 6164 6a75 7374 2874 6f70  plots_adjust(top
-0000eec0: 3d30 2e39 352c 2062 6f74 746f 6d3d 302e  =0.95, bottom=0.
-0000eed0: 3038 2c20 6c65 6674 3d30 2e31 312c 2072  08, left=0.11, r
-0000eee0: 6967 6874 3d30 2e39 3829 0a0a 2020 2020  ight=0.98)..    
-0000eef0: 706c 742e 7361 7665 6669 6728 7361 7665  plt.savefig(save
-0000ef00: 5f66 696c 6529 0a20 2020 2070 6c74 2e63  _file).    plt.c
-0000ef10: 6c66 2829 0a20 2020 2070 6c74 2e63 6c6f  lf().    plt.clo
-0000ef20: 7365 2829 0a0a 0a23 2323 2323 2323 2323  se()...#########
-0000ef30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000ef40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000ef50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000ef60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000ef70: 2323 2323 2323 230a 2320 4173 7369 676e  #######.# Assign
-0000ef80: 2064 6574 6563 7469 6f6e 2049 4473 0a0a   detection IDs..
-0000ef90: 6465 6620 6173 7369 676e 5f73 696e 676c  def assign_singl
-0000efa0: 655f 6d6f 6465 5f66 696c 7465 725f 6964  e_mode_filter_id
-0000efb0: 2863 6174 616c 6f67 2c0a 2020 2020 2020  (catalog,.      
-0000efc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000efd0: 2020 2020 2020 2020 2020 2066 696c 742c             filt,
-0000efe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f000: 2020 7361 7665 5f66 696c 652c 0a20 2020    save_file,.   
+0000d750: 6174 615b 2746 4c55 585f 4150 4552 275d  ata['FLUX_APER']
+0000d760: 2e61 7272 6179 5b6b 5d20 2a3d 2064 656c  .array[k] *= del
+0000d770: 7461 5f66 6c75 785f 6672 6163 0a20 2020  ta_flux_frac.   
+0000d780: 2020 2020 2023 6578 6365 7074 204b 6579       #except Key
+0000d790: 4572 726f 723a 0a20 2020 2020 2020 2023  Error:.        #
+0000d7a0: 2020 2020 7061 7373 0a0a 2020 2020 2020      pass..      
+0000d7b0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0000d7c0: 2020 2069 6620 636f 7272 5f64 6174 615b     if corr_data[
+0000d7d0: 274d 555f 4d41 5827 5d2e 6172 7261 795b  'MU_MAX'].array[
+0000d7e0: 6b5d 2021 3d20 3939 3a0a 2020 2020 2020  k] != 99:.      
+0000d7f0: 2020 2020 2020 2020 2020 636f 7272 5f64            corr_d
+0000d800: 6174 615b 274d 555f 4d41 5827 5d2e 6172  ata['MU_MAX'].ar
+0000d810: 7261 795b 6b5d 202b 3d20 6465 6c74 615f  ray[k] += delta_
+0000d820: 6d61 670a 2020 2020 2020 2020 6578 6365  mag.        exce
+0000d830: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
+0000d840: 2020 2020 2020 2020 2070 6173 730a 0a20           pass.. 
+0000d850: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0000d860: 2020 2020 2020 2020 6966 2063 6f72 725f          if corr_
+0000d870: 6461 7461 5b27 4d55 5f54 4852 4553 484f  data['MU_THRESHO
+0000d880: 4c44 275d 2e61 7272 6179 5b6b 5d20 213d  LD'].array[k] !=
+0000d890: 2039 393a 0a20 2020 2020 2020 2020 2020   99:.           
+0000d8a0: 2020 2020 2063 6f72 725f 6461 7461 5b27       corr_data['
+0000d8b0: 4d55 5f54 4852 4553 484f 4c44 275d 2e61  MU_THRESHOLD'].a
+0000d8c0: 7272 6179 5b6b 5d20 2b3d 2064 656c 7461  rray[k] += delta
+0000d8d0: 5f6d 6167 0a20 2020 2020 2020 2065 7863  _mag.        exc
+0000d8e0: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
+0000d8f0: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
+0000d900: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0000d910: 2020 2020 2020 2020 2063 6f72 725f 6461           corr_da
+0000d920: 7461 5b27 4241 434b 4752 4f55 4e44 275d  ta['BACKGROUND']
+0000d930: 2e61 7272 6179 5b6b 5d20 2a3d 2064 656c  .array[k] *= del
+0000d940: 7461 5f66 6c75 785f 6672 6163 0a20 2020  ta_flux_frac.   
+0000d950: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
+0000d960: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+0000d970: 2020 7061 7373 0a0a 2020 2020 2020 2020    pass..        
+0000d980: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000d990: 2063 6f72 725f 6461 7461 5b27 5448 5245   corr_data['THRE
+0000d9a0: 5348 4f4c 4427 5d2e 6172 7261 795b 6b5d  SHOLD'].array[k]
+0000d9b0: 202a 3d20 6465 6c74 615f 666c 7578 5f66   *= delta_flux_f
+0000d9c0: 7261 630a 2020 2020 2020 2020 6578 6365  rac.        exce
+0000d9d0: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
+0000d9e0: 2020 2020 2020 2020 2070 6173 730a 0a20           pass.. 
+0000d9f0: 2020 2023 2053 6176 6520 636f 7272 6563     # Save correc
+0000da00: 7465 6420 6461 7461 2074 6f20 7361 7665  ted data to save
+0000da10: 5f66 696c 6520 6669 7473 2063 6174 616c  _file fits catal
+0000da20: 6f67 0a20 2020 2068 6475 203d 2066 6974  og.    hdu = fit
+0000da30: 732e 4269 6e54 6162 6c65 4844 552e 6672  s.BinTableHDU.fr
+0000da40: 6f6d 5f63 6f6c 756d 6e73 2863 6f72 725f  om_columns(corr_
+0000da50: 6461 7461 290a 2020 2020 6864 752e 7772  data).    hdu.wr
+0000da60: 6974 6574 6f28 7361 7665 5f66 696c 6529  iteto(save_file)
+0000da70: 0a0a 0a64 6566 2061 7070 6c79 5f78 795f  ...def apply_xy_
+0000da80: 636f 7272 6563 7469 6f6e 5f70 7366 2863  correction_psf(c
+0000da90: 6174 616c 6f67 2c20 7361 7665 5f66 696c  atalog, save_fil
+0000daa0: 652c 206d 6170 5f66 696c 652c 2078 6269  e, map_file, xbi
+0000dab0: 6e73 2c20 7962 696e 7329 3a0a 2020 2020  ns, ybins):.    
+0000dac0: 2222 220a 2020 2020 4170 706c 6965 7320  """.    Applies 
+0000dad0: 5859 2063 6f72 7265 6374 696f 6e73 2074  XY corrections t
+0000dae0: 6f20 7468 6520 532d 504c 5553 2070 7366  o the S-PLUS psf
+0000daf0: 2070 686f 746f 6d65 7472 7920 6361 7461   photometry cata
+0000db00: 6c6f 6773 2e0a 0a20 2020 2054 776f 2061  logs...    Two a
+0000db10: 6464 6974 696f 6e61 6c20 636f 6c75 6d6e  dditional column
+0000db20: 7320 6172 6520 6372 6561 7465 643a 2058  s are created: X
+0000db30: 5f41 4c49 474e 2061 6e64 2059 5f41 4c49  _ALIGN and Y_ALI
+0000db40: 474e 2c20 636f 7272 6573 706f 6e64 696e  GN, correspondin
+0000db50: 6720 746f 0a20 2020 206e 6f72 6d61 6c69  g to.    normali
+0000db60: 7a65 6420 585f 494d 4147 4520 616e 6420  zed X_IMAGE and 
+0000db70: 595f 494d 4147 4520 706f 7369 7469 6f6e  Y_IMAGE position
+0000db80: 7320 286f 7269 6769 6e20 6d6f 7665 6420  s (origin moved 
+0000db90: 746f 2062 6f74 746f 6d20 6c65 6674 0a20  to bottom left. 
+0000dba0: 2020 2063 6f72 6e65 722c 2061 6e64 2063     corner, and c
+0000dbb0: 6f6f 7264 696e 6174 6573 2072 6f74 6174  oordinates rotat
+0000dbc0: 6520 746f 206d 6174 6368 2058 2061 6e64  e to match X and
+0000dbd0: 2059 2061 7869 7329 2e0a 0a20 2020 2050   Y axis)...    P
+0000dbe0: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+0000dbf0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 6174  --------.    cat
+0000dc00: 616c 6f67 203a 2073 7472 0a20 2020 2020  alog : str.     
+0000dc10: 2020 204c 6f63 6174 696f 6e20 746f 2074     Location to t
+0000dc20: 6865 2053 4578 7472 6163 746f 7220 7068  he SExtractor ph
+0000dc30: 6f74 6f6d 6574 7279 206f 7574 7075 7420  otometry output 
+0000dc40: 6361 7461 6c6f 670a 0a20 2020 2073 6176  catalog..    sav
+0000dc50: 655f 6669 6c65 203a 2073 7472 0a20 2020  e_file : str.   
+0000dc60: 2020 2020 2044 6573 6972 6564 206c 6f63       Desired loc
+0000dc70: 6174 696f 6e20 746f 2073 6176 6520 7468  ation to save th
+0000dc80: 6520 5859 2063 6f72 7265 6374 6564 2063  e XY corrected c
+0000dc90: 6174 616c 6f67 0a0a 2020 2020 6d61 705f  atalog..    map_
+0000dca0: 6669 6c65 203a 2073 7472 0a20 2020 2020  file : str.     
+0000dcb0: 2020 204c 6f63 6174 696f 6e20 6f66 2074     Location of t
+0000dcc0: 6865 2078 7920 636f 7272 6563 7469 6f6e  he xy correction
+0000dcd0: 206d 6170 2028 6d75 7374 2062 6520 6e75   map (must be nu
+0000dce0: 6d70 7920 6e70 7920 6669 6c65 290a 0a20  mpy npy file).. 
+0000dcf0: 2020 2078 6269 6e73 203a 206c 6973 740a     xbins : list.
+0000dd00: 2020 2020 2020 2020 7862 696e 7320 6f66          xbins of
+0000dd10: 2074 6865 2063 6f72 7265 6374 696f 6e20   the correction 
+0000dd20: 6d61 7020 2873 7461 7274 2c20 656e 642c  map (start, end,
+0000dd30: 204e 6269 6e73 2920 5b69 6e20 7069 7865   Nbins) [in pixe
+0000dd40: 6c73 5d0a 0a20 2020 2079 6269 6e73 203a  ls]..    ybins :
+0000dd50: 206c 6973 740a 2020 2020 2020 2020 7962   list.        yb
+0000dd60: 696e 7320 6f66 2074 6865 2063 6f72 7265  ins of the corre
+0000dd70: 6374 696f 6e20 6d61 7020 2873 7461 7274  ction map (start
+0000dd80: 2c20 656e 642c 204e 6269 6e73 2920 5b69  , end, Nbins) [i
+0000dd90: 6e20 7069 7865 6c73 5d0a 0a20 2020 2052  n pixels]..    R
+0000dda0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
+0000ddb0: 2d2d 0a20 2020 2053 6176 6573 2058 5920  --.    Saves XY 
+0000ddc0: 636f 7272 6563 7465 6420 6361 7461 6c6f  corrected catalo
+0000ddd0: 6720 696e 2074 6865 2064 6573 6972 6564  g in the desired
+0000dde0: 206c 6f63 6174 696f 6e20 2870 6172 616d   location (param
+0000ddf0: 3a73 6176 655f 6669 6c65 290a 2020 2020  :save_file).    
+0000de00: 2222 220a 0a0a 2020 2020 2320 4c6f 6164  """...    # Load
+0000de10: 2066 696c 7465 7220 6361 7461 6c6f 6775   filter catalogu
+0000de20: 650a 2020 2020 6361 745f 6461 7461 203d  e.    cat_data =
+0000de30: 206c 6f61 645f 6461 7461 2863 6174 616c   load_data(catal
+0000de40: 6f67 290a 0a20 2020 2078 203d 2063 6174  og)..    x = cat
+0000de50: 5f64 6174 612e 6c6f 635b 3a2c 2778 706f  _data.loc[:,'xpo
+0000de60: 7327 5d2e 7661 6c75 6573 0a20 2020 2079  s'].values.    y
+0000de70: 203d 2063 6174 5f64 6174 612e 6c6f 635b   = cat_data.loc[
+0000de80: 3a2c 2779 706f 7327 5d2e 7661 6c75 6573  :,'ypos'].values
+0000de90: 0a0a 2020 2020 2320 4e6f 726d 616c 697a  ..    # Normaliz
+0000dea0: 6520 5820 616e 6420 590a 2020 2020 785f  e X and Y.    x_
+0000deb0: 616c 6967 6e2c 2079 5f61 6c69 676e 203d  align, y_align =
+0000dec0: 2061 6c69 676e 5f73 706c 7573 5f78 7928   align_splus_xy(
+0000ded0: 782c 2079 290a 0a20 2020 2023 2043 7265  x, y)..    # Cre
+0000dee0: 6174 6520 6e65 7720 6669 7473 2063 6174  ate new fits cat
+0000def0: 616c 6f67 2077 6974 6820 6e65 7720 636f  alog with new co
+0000df00: 6c75 6d6e 730a 2020 2020 636f 7272 5f64  lumns.    corr_d
+0000df10: 6174 6120 3d20 6361 745f 6461 7461 0a0a  ata = cat_data..
+0000df20: 2020 2020 636f 7272 5f64 6174 615b 2758      corr_data['X
+0000df30: 5f41 4c49 474e 275d 203d 2078 5f61 6c69  _ALIGN'] = x_ali
+0000df40: 676e 0a20 2020 2063 6f72 725f 6461 7461  gn.    corr_data
+0000df50: 5b27 595f 414c 4947 4e27 5d20 3d20 795f  ['Y_ALIGN'] = y_
+0000df60: 616c 6967 6e0a 0a20 2020 2023 2050 7265  align..    # Pre
+0000df70: 7061 7265 2062 696e 730a 2020 2020 7862  pare bins.    xb
+0000df80: 696e 735f 6772 6964 203d 206e 702e 6c69  ins_grid = np.li
+0000df90: 6e73 7061 6365 2878 6269 6e73 5b30 5d2c  nspace(xbins[0],
+0000dfa0: 2078 6269 6e73 5b31 5d2c 2069 6e74 2878   xbins[1], int(x
+0000dfb0: 6269 6e73 5b32 5d29 202b 2031 290a 2020  bins[2]) + 1).  
+0000dfc0: 2020 7962 696e 735f 6772 6964 203d 206e    ybins_grid = n
+0000dfd0: 702e 6c69 6e73 7061 6365 2879 6269 6e73  p.linspace(ybins
+0000dfe0: 5b30 5d2c 2079 6269 6e73 5b31 5d2c 2069  [0], ybins[1], i
+0000dff0: 6e74 2879 6269 6e73 5b32 5d29 202b 2031  nt(ybins[2]) + 1
+0000e000: 290a 0a20 2020 2078 6269 6e73 5f69 6420  )..    xbins_id 
+0000e010: 3d20 6e70 2e61 7272 6179 2872 616e 6765  = np.array(range
+0000e020: 2869 6e74 2878 6269 6e73 5b32 5d29 202b  (int(xbins[2]) +
+0000e030: 2031 2929 0a20 2020 2079 6269 6e73 5f69   1)).    ybins_i
+0000e040: 6420 3d20 6e70 2e61 7272 6179 2872 616e  d = np.array(ran
+0000e050: 6765 2869 6e74 2879 6269 6e73 5b32 5d29  ge(int(ybins[2])
+0000e060: 202b 2031 2929 0a0a 2020 2020 2320 4c6f   + 1))..    # Lo
+0000e070: 6164 2063 6f72 7265 6374 696f 6e73 0a20  ad corrections. 
+0000e080: 2020 2063 6f72 7265 6374 696f 6e73 203d     corrections =
+0000e090: 206e 702e 6c6f 6164 286d 6170 5f66 696c   np.load(map_fil
+0000e0a0: 6529 0a0a 2020 2020 2320 4170 706c 7920  e)..    # Apply 
+0000e0b0: 636f 7272 6563 7469 6f6e 730a 2020 2020  corrections.    
+0000e0c0: 666f 7220 6b20 696e 2072 616e 6765 286c  for k in range(l
+0000e0d0: 656e 2863 6174 5f64 6174 6129 293a 0a20  en(cat_data)):. 
+0000e0e0: 2020 2020 2020 2078 5f73 6f75 7263 6520         x_source 
+0000e0f0: 3d20 785f 616c 6967 6e5b 6b5d 0a20 2020  = x_align[k].   
+0000e100: 2020 2020 2079 5f73 6f75 7263 6520 3d20       y_source = 
+0000e110: 795f 616c 6967 6e5b 6b5d 0a0a 2020 2020  y_align[k]..    
+0000e120: 2020 2020 2320 4765 7420 6465 6c74 6120      # Get delta 
+0000e130: 6d61 6720 2869 6620 6769 7665 6e20 6f6e  mag (if given on
+0000e140: 2074 6865 2063 6f72 7265 6374 696f 6e20   the correction 
+0000e150: 6d61 7020 666f 7220 7468 6973 2070 6f73  map for this pos
+0000e160: 6974 696f 6e29 0a20 2020 2020 2020 2074  ition).        t
+0000e170: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000e180: 2320 4669 6e64 2069 6473 206f 6620 7468  # Find ids of th
+0000e190: 6520 6269 6e20 7468 6174 2063 6f6e 7461  e bin that conta
+0000e1a0: 696e 7320 7468 6520 736f 7572 6365 0a20  ins the source. 
+0000e1b0: 2020 2020 2020 2020 2020 2062 696e 5f73             bin_s
+0000e1c0: 6f75 7263 655f 6920 3d20 7862 696e 735f  ource_i = xbins_
+0000e1d0: 6964 5b78 6269 6e73 5f67 7269 6420 3c3d  id[xbins_grid <=
+0000e1e0: 2078 5f73 6f75 7263 655d 5b2d 315d 0a20   x_source][-1]. 
+0000e1f0: 2020 2020 2020 2020 2020 2062 696e 5f73             bin_s
+0000e200: 6f75 7263 655f 6a20 3d20 7962 696e 735f  ource_j = ybins_
+0000e210: 6964 5b79 6269 6e73 5f67 7269 6420 3c3d  id[ybins_grid <=
+0000e220: 2079 5f73 6f75 7263 655d 5b2d 315d 0a0a   y_source][-1]..
+0000e230: 2020 2020 2020 2020 2020 2020 6465 6c74              delt
+0000e240: 615f 6d61 6720 3d20 636f 7272 6563 7469  a_mag = correcti
+0000e250: 6f6e 735b 6269 6e5f 736f 7572 6365 5f69  ons[bin_source_i
+0000e260: 2c20 6269 6e5f 736f 7572 6365 5f6a 5d0a  , bin_source_j].
+0000e270: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0000e280: 496e 6465 7845 7272 6f72 3a0a 2020 2020  IndexError:.    
+0000e290: 2020 2020 2020 2020 6465 6c74 615f 6d61          delta_ma
+0000e2a0: 6720 3d20 300a 0a20 2020 2020 2020 2074  g = 0..        t
+0000e2b0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000e2c0: 6966 2063 6f72 725f 6461 7461 2e6c 6f63  if corr_data.loc
+0000e2d0: 5b3a 2c27 6669 746d 6167 275d 2e76 616c  [:,'fitmag'].val
+0000e2e0: 7565 735b 6b5d 2021 3d20 3939 3a0a 2020  ues[k] != 99:.  
+0000e2f0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0000e300: 7272 5f64 6174 612e 6c6f 635b 3a2c 2766  rr_data.loc[:,'f
+0000e310: 6974 6d61 6727 5d2e 7661 6c75 6573 5b6b  itmag'].values[k
+0000e320: 5d20 2b3d 2064 656c 7461 5f6d 6167 0a20  ] += delta_mag. 
+0000e330: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
+0000e340: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
+0000e350: 2020 2020 7061 7373 0a0a 2020 2020 2320      pass..    # 
+0000e360: 5361 7665 2063 6f72 7265 6374 6564 2064  Save corrected d
+0000e370: 6174 6120 746f 2073 6176 655f 6669 6c65  ata to save_file
+0000e380: 2066 6974 7320 6361 7461 6c6f 670a 2020   fits catalog.  
+0000e390: 2020 7769 7468 206f 7065 6e28 7361 7665    with open(save
+0000e3a0: 5f66 696c 652c 2027 7727 2920 6173 2066  _file, 'w') as f
+0000e3b0: 3a0a 2020 2020 2020 2020 662e 7772 6974  :.        f.writ
+0000e3c0: 6528 2223 2022 290a 2020 2020 2020 2020  e("# ").        
+0000e3d0: 636f 7272 5f64 6174 612e 746f 5f63 7376  corr_data.to_csv
+0000e3e0: 2866 2c20 696e 6465 7820 3d20 4661 6c73  (f, index = Fals
+0000e3f0: 652c 2073 6570 203d 2022 2022 290a 0a0a  e, sep = " ")...
+0000e400: 6465 6620 6765 745f 7879 5f63 6f72 7265  def get_xy_corre
+0000e410: 6374 696f 6e5f 6772 6964 2864 6174 615f  ction_grid(data_
+0000e420: 6669 6c65 2c20 7361 7665 5f66 696c 652c  file, save_file,
+0000e430: 206d 6167 2c20 6d61 675f 7265 662c 2078   mag, mag_ref, x
+0000e440: 6269 6e73 2c20 7962 696e 7329 3a0a 0a20  bins, ybins):.. 
+0000e450: 2020 2078 4e62 696e 7320 3d20 7862 696e     xNbins = xbin
+0000e460: 735b 325d 0a20 2020 2079 4e62 696e 7320  s[2].    yNbins 
+0000e470: 3d20 7962 696e 735b 325d 0a0a 2020 2020  = ybins[2]..    
+0000e480: 2320 4765 7420 7661 6c75 6573 206f 6620  # Get values of 
+0000e490: 6269 6e73 206c 696d 6974 7320 616e 6420  bins limits and 
+0000e4a0: 6365 6e74 6572 730a 0a20 2020 2078 6269  centers..    xbi
+0000e4b0: 6e73 203d 206e 702e 6c69 6e73 7061 6365  ns = np.linspace
+0000e4c0: 2878 6269 6e73 5b30 5d2c 2078 6269 6e73  (xbins[0], xbins
+0000e4d0: 5b31 5d2c 2078 6269 6e73 5b32 5d2b 3129  [1], xbins[2]+1)
+0000e4e0: 0a20 2020 2079 6269 6e73 203d 206e 702e  .    ybins = np.
+0000e4f0: 6c69 6e73 7061 6365 2879 6269 6e73 5b30  linspace(ybins[0
+0000e500: 5d2c 2079 6269 6e73 5b31 5d2c 2079 6269  ], ybins[1], ybi
+0000e510: 6e73 5b32 5d2b 3129 0a0a 2020 2020 2320  ns[2]+1)..    # 
+0000e520: 6765 6e65 7261 7465 2074 6865 206d 6573  generate the mes
+0000e530: 680a 0a20 2020 2078 782c 2079 7920 3d20  h..    xx, yy = 
+0000e540: 6e70 2e6d 6573 6867 7269 6428 7862 696e  np.meshgrid(xbin
+0000e550: 732c 2079 6269 6e73 2c20 7370 6172 7365  s, ybins, sparse
+0000e560: 3d54 7275 6529 0a0a 2020 2020 636f 7272  =True)..    corr
+0000e570: 6563 7469 6f6e 7320 3d20 302a 7878 202b  ections = 0*xx +
+0000e580: 2030 2a79 790a 2020 2020 636f 7272 6563   0*yy.    correc
+0000e590: 7469 6f6e 735f 7374 6420 3d20 6e70 2e6e  tions_std = np.n
+0000e5a0: 616e 2a78 7820 2b20 6e70 2e6e 616e 2a79  an*xx + np.nan*y
+0000e5b0: 790a 0a20 2020 2023 204c 6f61 6420 6461  y..    # Load da
+0000e5c0: 7461 0a20 2020 2064 6174 6120 3d20 6c6f  ta.    data = lo
+0000e5d0: 6164 5f64 6174 6128 6461 7461 5f66 696c  ad_data(data_fil
+0000e5e0: 6529 0a0a 2020 2020 5820 3d20 6461 7461  e)..    X = data
+0000e5f0: 2e6c 6f63 5b3a 2c27 585f 414c 4947 4e27  .loc[:,'X_ALIGN'
+0000e600: 5d2e 7661 6c75 6573 0a20 2020 2059 203d  ].values.    Y =
+0000e610: 2064 6174 612e 6c6f 635b 3a2c 2759 5f41   data.loc[:,'Y_A
+0000e620: 4c49 474e 275d 2e76 616c 7565 730a 0a20  LIGN'].values.. 
+0000e630: 2020 2044 5a50 203d 2064 6174 612e 6c6f     DZP = data.lo
+0000e640: 635b 3a2c 6d61 675f 7265 665d 2e76 616c  c[:,mag_ref].val
+0000e650: 7565 7320 2d20 6461 7461 2e6c 6f63 5b3a  ues - data.loc[:
+0000e660: 2c6d 6167 5d2e 7661 6c75 6573 0a0a 2020  ,mag].values..  
+0000e670: 2020 6d61 675f 6375 7420 3d20 2864 6174    mag_cut = (dat
+0000e680: 612e 6c6f 635b 3a2c 206d 6167 5d2e 7661  a.loc[:, mag].va
+0000e690: 6c75 6573 203e 2031 3429 2026 2028 6461  lues > 14) & (da
+0000e6a0: 7461 2e6c 6f63 5b3a 2c20 6d61 675d 2e76  ta.loc[:, mag].v
+0000e6b0: 616c 7565 7320 3c3d 2031 372e 3529 0a20  alues <= 17.5). 
+0000e6c0: 2020 2072 656d 6f76 655f 776f 7273 745f     remove_worst_
+0000e6d0: 6361 7365 7320 3d20 6e70 2e61 6273 2844  cases = np.abs(D
+0000e6e0: 5a50 2920 3c20 302e 320a 0a20 2020 2023  ZP) < 0.2..    #
+0000e6f0: 2046 696c 6c20 6172 7261 7920 6f66 2063   Fill array of c
+0000e700: 6f72 7265 6374 696f 6e73 0a20 2020 204e  orrections.    N
+0000e710: 5f64 6174 6120 3d20 6c65 6e28 445a 505b  _data = len(DZP[
+0000e720: 6d61 675f 6375 7420 2620 7265 6d6f 7665  mag_cut & remove
+0000e730: 5f77 6f72 7374 5f63 6173 6573 5d29 0a20  _worst_cases]). 
+0000e740: 2020 206d 696e 5f4e 5f64 6174 6120 3d20     min_N_data = 
+0000e750: 302e 3035 2a4e 5f64 6174 612f 2878 4e62  0.05*N_data/(xNb
+0000e760: 696e 732a 794e 6269 6e73 290a 0a20 2020  ins*yNbins)..   
+0000e770: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+0000e780: 784e 6269 6e73 293a 0a20 2020 2020 2020  xNbins):.       
+0000e790: 2078 7365 6c65 6374 203d 2028 5820 3e3d   xselect = (X >=
+0000e7a0: 2078 6269 6e73 5b69 5d29 2026 2028 5820   xbins[i]) & (X 
+0000e7b0: 3c20 7862 696e 735b 692b 315d 290a 0a20  < xbins[i+1]).. 
+0000e7c0: 2020 2020 2020 2066 6f72 206a 2069 6e20         for j in 
+0000e7d0: 7261 6e67 6528 794e 6269 6e73 293a 0a20  range(yNbins):. 
+0000e7e0: 2020 2020 2020 2020 2020 2079 7365 6c65             ysele
+0000e7f0: 6374 203d 2028 5920 3e3d 2079 6269 6e73  ct = (Y >= ybins
+0000e800: 5b6a 5d29 2026 2028 5920 3c20 7962 696e  [j]) & (Y < ybin
+0000e810: 735b 6a2b 315d 290a 0a20 2020 2020 2020  s[j+1])..       
+0000e820: 2020 2020 2044 5a50 5f73 656c 6563 7420       DZP_select 
+0000e830: 3d20 445a 505b 7873 656c 6563 7420 2620  = DZP[xselect & 
+0000e840: 7973 656c 6563 7420 2620 6d61 675f 6375  yselect & mag_cu
+0000e850: 7420 2620 7265 6d6f 7665 5f77 6f72 7374  t & remove_worst
+0000e860: 5f63 6173 6573 5d0a 0a20 2020 2020 2020  _cases]..       
+0000e870: 2020 2020 2069 6620 6c65 6e28 445a 505f       if len(DZP_
+0000e880: 7365 6c65 6374 2920 3e20 6d69 6e5f 4e5f  select) > min_N_
+0000e890: 6461 7461 3a0a 2020 2020 2020 2020 2020  data:.          
+0000e8a0: 2020 2020 2020 636f 7272 6563 7469 6f6e        correction
+0000e8b0: 735b 692c 6a5d 203d 206e 702e 6d65 616e  s[i,j] = np.mean
+0000e8c0: 2844 5a50 5f73 656c 6563 7429 0a0a 2020  (DZP_select)..  
+0000e8d0: 2020 2020 2020 2020 2020 636f 7272 6563            correc
+0000e8e0: 7469 6f6e 735f 7374 645b 692c 6a5d 203d  tions_std[i,j] =
+0000e8f0: 206e 702e 7374 6428 445a 505f 7365 6c65   np.std(DZP_sele
+0000e900: 6374 290a 0a20 2020 2063 6f72 7265 6374  ct)..    correct
+0000e910: 696f 6e73 203d 2067 6175 7373 6961 6e5f  ions = gaussian_
+0000e920: 6669 6c74 6572 2863 6f72 7265 6374 696f  filter(correctio
+0000e930: 6e73 2c20 7369 676d 613d 3129 0a0a 2020  ns, sigma=1)..  
+0000e940: 2020 2320 5363 616c 6520 6f66 6673 6574    # Scale offset
+0000e950: 2062 7920 6d65 616e 2076 616c 7565 2028   by mean value (
+0000e960: 6f66 6673 6574 7320 6172 6520 6465 616c  offsets are deal
+0000e970: 7420 7769 7468 2069 6e20 616e 6f74 6865  t with in anothe
+0000e980: 7220 7374 6570 2023 2323 2323 2323 2323  r step #########
+0000e990: 0a20 2020 2063 6f72 7265 6374 696f 6e73  .    corrections
+0000e9a0: 203d 2063 6f72 7265 6374 696f 6e73 202d   = corrections -
+0000e9b0: 206e 702e 6e61 6e6d 6561 6e28 445a 505b   np.nanmean(DZP[
+0000e9c0: 6d61 675f 6375 7420 2620 7265 6d6f 7665  mag_cut & remove
+0000e9d0: 5f77 6f72 7374 5f63 6173 6573 5d29 0a0a  _worst_cases])..
+0000e9e0: 2020 2020 2320 5265 6d6f 7665 206e 616e      # Remove nan
+0000e9f0: 2076 616c 7565 730a 2020 2020 636f 7272   values.    corr
+0000ea00: 6563 7469 6f6e 735b 6e70 2e69 736e 616e  ections[np.isnan
+0000ea10: 2863 6f72 7265 6374 696f 6e73 295d 203d  (corrections)] =
+0000ea20: 2030 0a0a 2020 2020 6e70 2e73 6176 6528   0..    np.save(
+0000ea30: 7361 7665 5f66 696c 652c 2063 6f72 7265  save_file, corre
+0000ea40: 6374 696f 6e73 290a 0a0a 6465 6620 706c  ctions)...def pl
+0000ea50: 6f74 5f78 795f 636f 7272 6563 7469 6f6e  ot_xy_correction
+0000ea60: 5f67 7269 6428 6772 6964 5f66 696c 652c  _grid(grid_file,
+0000ea70: 2073 6176 655f 6669 6c65 2c20 6d61 672c   save_file, mag,
+0000ea80: 2078 6269 6e73 2c20 7962 696e 732c 0a20   xbins, ybins,. 
+0000ea90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eaa0: 2020 2020 2020 2020 2020 2063 6d61 7020             cmap 
+0000eab0: 3d20 4e6f 6e65 2c20 636c 696d 203d 205b  = None, clim = [
+0000eac0: 2d30 2e30 352c 2030 2e30 355d 293a 0a0a  -0.05, 0.05]):..
+0000ead0: 2020 2020 2320 4765 7420 7661 6c75 6573      # Get values
+0000eae0: 206f 6620 6269 6e73 206c 696d 6974 7320   of bins limits 
+0000eaf0: 616e 6420 6365 6e74 6572 730a 0a20 2020  and centers..   
+0000eb00: 2078 6269 6e73 5f67 7269 6420 3d20 6e70   xbins_grid = np
+0000eb10: 2e6c 696e 7370 6163 6528 7862 696e 735b  .linspace(xbins[
+0000eb20: 305d 2c20 7862 696e 735b 315d 2c20 7862  0], xbins[1], xb
+0000eb30: 696e 735b 325d 202b 2031 290a 2020 2020  ins[2] + 1).    
+0000eb40: 7962 696e 735f 6772 6964 203d 206e 702e  ybins_grid = np.
+0000eb50: 6c69 6e73 7061 6365 2879 6269 6e73 5b30  linspace(ybins[0
+0000eb60: 5d2c 2079 6269 6e73 5b31 5d2c 2079 6269  ], ybins[1], ybi
+0000eb70: 6e73 5b32 5d20 2b20 3129 0a0a 2020 2020  ns[2] + 1)..    
+0000eb80: 2320 6765 6e65 7261 7465 2074 6865 206d  # generate the m
+0000eb90: 6573 680a 0a20 2020 2078 782c 2079 7920  esh..    xx, yy 
+0000eba0: 3d20 6e70 2e6d 6573 6867 7269 6428 7862  = np.meshgrid(xb
+0000ebb0: 696e 735f 6772 6964 2c20 7962 696e 735f  ins_grid, ybins_
+0000ebc0: 6772 6964 2c20 7370 6172 7365 3d54 7275  grid, sparse=Tru
+0000ebd0: 6529 0a0a 2020 2020 636f 7272 6563 7469  e)..    correcti
+0000ebe0: 6f6e 7320 3d20 6e70 2e6c 6f61 6428 6772  ons = np.load(gr
+0000ebf0: 6964 5f66 696c 6529 0a0a 2020 2020 706c  id_file)..    pl
+0000ec00: 742e 6669 6775 7265 2866 6967 7369 7a65  t.figure(figsize
+0000ec10: 3d28 382c 2036 2e34 2929 0a0a 2020 2020  =(8, 6.4))..    
+0000ec20: 766d 696e 203d 2063 6c69 6d5b 305d 0a20  vmin = clim[0]. 
+0000ec30: 2020 2076 6d61 7820 3d20 636c 696d 5b31     vmax = clim[1
+0000ec40: 5d0a 0a20 2020 2069 6620 636d 6170 2069  ]..    if cmap i
+0000ec50: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000ec60: 636d 6170 203d 2070 6c74 2e67 6574 5f63  cmap = plt.get_c
+0000ec70: 6d61 7028 2273 6569 736d 6963 5f72 2229  map("seismic_r")
+0000ec80: 0a0a 2020 2020 636d 203d 2070 6c74 2e70  ..    cm = plt.p
+0000ec90: 636f 6c6f 7228 7878 2c20 7979 2c20 636f  color(xx, yy, co
+0000eca0: 7272 6563 7469 6f6e 732e 542c 2076 6d69  rrections.T, vmi
+0000ecb0: 6e3d 766d 696e 2c20 766d 6178 3d76 6d61  n=vmin, vmax=vma
+0000ecc0: 782c 2063 6d61 703d 636d 6170 290a 2020  x, cmap=cmap).  
+0000ecd0: 2020 6362 6172 203d 2070 6c74 2e63 6f6c    cbar = plt.col
+0000ece0: 6f72 6261 7228 636d 290a 2020 2020 6362  orbar(cm).    cb
+0000ecf0: 6172 2e73 6574 5f6c 6162 656c 2822 6f66  ar.set_label("of
+0000ed00: 6673 6574 2229 0a0a 2020 2020 706c 742e  fset")..    plt.
+0000ed10: 766c 696e 6573 2878 6269 6e73 5f67 7269  vlines(xbins_gri
+0000ed20: 642c 2078 6269 6e73 5b30 5d2c 2078 6269  d, xbins[0], xbi
+0000ed30: 6e73 5b31 5d2c 206c 696e 6577 6964 7468  ns[1], linewidth
+0000ed40: 3d30 2e35 2c20 616c 7068 613d 302e 3429  =0.5, alpha=0.4)
+0000ed50: 0a20 2020 2070 6c74 2e68 6c69 6e65 7328  .    plt.hlines(
+0000ed60: 7962 696e 735f 6772 6964 2c20 7962 696e  ybins_grid, ybin
+0000ed70: 735b 305d 2c20 7962 696e 735b 315d 2c20  s[0], ybins[1], 
+0000ed80: 6c69 6e65 7769 6474 683d 302e 352c 2061  linewidth=0.5, a
+0000ed90: 6c70 6861 3d30 2e34 290a 0a20 2020 2070  lpha=0.4)..    p
+0000eda0: 6c74 2e67 6361 2829 2e73 6574 5f74 6974  lt.gca().set_tit
+0000edb0: 6c65 2822 2573 206f 6666 7365 7473 2220  le("%s offsets" 
+0000edc0: 2520 6d61 6729 0a20 2020 2070 6c74 2e67  % mag).    plt.g
+0000edd0: 6361 2829 2e73 6574 5f78 6c61 6265 6c28  ca().set_xlabel(
+0000ede0: 2258 5f41 4c49 474e 2229 0a20 2020 2070  "X_ALIGN").    p
+0000edf0: 6c74 2e67 6361 2829 2e73 6574 5f79 6c61  lt.gca().set_yla
+0000ee00: 6265 6c28 2259 5f41 4c49 474e 2229 0a20  bel("Y_ALIGN"). 
+0000ee10: 2020 2070 6c74 2e67 6361 2829 2e73 6574     plt.gca().set
+0000ee20: 5f78 6c69 6d28 2878 6269 6e73 5b30 5d2c  _xlim((xbins[0],
+0000ee30: 2078 6269 6e73 5b31 5d29 290a 2020 2020   xbins[1])).    
+0000ee40: 706c 742e 6763 6128 292e 7365 745f 796c  plt.gca().set_yl
+0000ee50: 696d 2828 7962 696e 735b 305d 2c20 7962  im((ybins[0], yb
+0000ee60: 696e 735b 315d 2929 0a20 2020 2070 6c74  ins[1])).    plt
+0000ee70: 2e73 7562 706c 6f74 735f 6164 6a75 7374  .subplots_adjust
+0000ee80: 2874 6f70 3d30 2e39 352c 2062 6f74 746f  (top=0.95, botto
+0000ee90: 6d3d 302e 3038 2c20 6c65 6674 3d30 2e31  m=0.08, left=0.1
+0000eea0: 312c 2072 6967 6874 3d30 2e39 3829 0a0a  1, right=0.98)..
+0000eeb0: 2020 2020 706c 742e 7361 7665 6669 6728      plt.savefig(
+0000eec0: 7361 7665 5f66 696c 6529 0a20 2020 2070  save_file).    p
+0000eed0: 6c74 2e63 6c66 2829 0a20 2020 2070 6c74  lt.clf().    plt
+0000eee0: 2e63 6c6f 7365 2829 0a0a 0a23 2323 2323  .close()...#####
+0000eef0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ef00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ef10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ef20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ef30: 2323 2323 2323 2323 2323 230a 2320 4173  ###########.# As
+0000ef40: 7369 676e 2064 6574 6563 7469 6f6e 2049  sign detection I
+0000ef50: 4473 0a0a 6465 6620 6173 7369 676e 5f73  Ds..def assign_s
+0000ef60: 696e 676c 655f 6d6f 6465 5f66 696c 7465  ingle_mode_filte
+0000ef70: 725f 6964 2863 6174 616c 6f67 2c0a 2020  r_id(catalog,.  
+0000ef80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000efa0: 696c 742c 0a20 2020 2020 2020 2020 2020  ilt,.           
+0000efb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000efc0: 2020 2020 2020 7361 7665 5f66 696c 652c        save_file,
+0000efd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000efe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eff0: 2020 6669 656c 6420 3d20 274e 6f46 6965    field = 'NoFie
+0000f000: 6c64 4e61 6d65 272c 0a20 2020 2020 2020  ldName',.       
 0000f010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f020: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-0000f030: 656c 6420 3d20 274e 6f46 6965 6c64 4e61  eld = 'NoFieldNa
-0000f040: 6d65 272c 0a20 2020 2020 2020 2020 2020  me',.           
-0000f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f060: 2020 2020 2020 6472 6e61 6d65 203d 2027        drname = '
-0000f070: 4e6f 4452 6e61 6d65 2729 3a0a 0a20 2020  NoDRname'):..   
-0000f080: 2022 2222 0a20 2020 2041 7373 6967 6e73   """.    Assigns
-0000f090: 2064 6574 6563 7469 6f6e 2049 4420 746f   detection ID to
-0000f0a0: 2053 4578 7472 6163 746f 7220 7068 6f74   SExtractor phot
-0000f0b0: 6f6d 6574 7279 2028 696e 2073 696e 676c  ometry (in singl
-0000f0c0: 6520 6d6f 6465 292e 0a0a 2020 2020 5061  e mode)...    Pa
-0000f0d0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-0000f0e0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6361 7461  -------.    cata
-0000f0f0: 6c6f 6720 3a20 7374 720a 2020 2020 2020  log : str.      
-0000f100: 2020 4c6f 6361 7469 6f6e 206f 6620 5345    Location of SE
-0000f110: 7874 7261 6374 6f72 2070 686f 746f 6d65  xtractor photome
-0000f120: 7472 7920 6361 7461 6c6f 670a 2020 2020  try catalog.    
-0000f130: 6669 6c74 203a 2073 7472 0a20 2020 2020  filt : str.     
-0000f140: 2020 204e 616d 6520 6f66 2074 6865 2066     Name of the f
-0000f150: 696c 7465 720a 2020 2020 7361 7665 5f66  ilter.    save_f
-0000f160: 696c 6520 3a20 7374 720a 2020 2020 2020  ile : str.      
-0000f170: 2020 4465 7369 7265 6420 6c6f 6361 7469    Desired locati
-0000f180: 6f6e 2074 6f20 7361 7665 206e 6577 2063  on to save new c
-0000f190: 6174 616c 6f67 0a20 2020 2066 6965 6c64  atalog.    field
-0000f1a0: 203a 2073 7472 0a20 2020 2020 2020 204e   : str.        N
-0000f1b0: 616d 6520 6f66 2074 6865 2066 6965 6c64  ame of the field
-0000f1c0: 2074 6f20 6265 2061 6464 6564 2074 6f20   to be added to 
-0000f1d0: 7468 6520 6669 6c74 6572 5f49 440a 2020  the filter_ID.  
-0000f1e0: 2020 6472 6e61 6d65 203a 2073 7472 0a20    drname : str. 
-0000f1f0: 2020 2020 2020 2044 6174 6120 7265 6c65         Data rele
-0000f200: 6173 6520 6465 7369 676e 6174 696f 6e20  ase designation 
-0000f210: 746f 2062 6520 6164 6465 6420 746f 2074  to be added to t
-0000f220: 6865 2066 696c 7465 725f 4944 0a0a 2020  he filter_ID..  
-0000f230: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
-0000f240: 2d2d 2d2d 2d0a 2020 2020 5361 7665 7320  -----.    Saves 
-0000f250: 6e65 7720 6361 7461 6c6f 6720 7769 7468  new catalog with
-0000f260: 2066 696c 7465 725f 4944 0a0a 2020 2020   filter_ID..    
-0000f270: 2222 220a 0a20 2020 2023 2052 6561 6420  """..    # Read 
-0000f280: 6361 7461 6c6f 670a 2020 2020 6361 7420  catalog.    cat 
-0000f290: 3d20 6669 7473 2e6f 7065 6e28 6361 7461  = fits.open(cata
-0000f2a0: 6c6f 6729 0a20 2020 2063 6174 5f64 6174  log).    cat_dat
-0000f2b0: 6120 3d20 6361 745b 315d 2e64 6174 610a  a = cat[1].data.
-0000f2c0: 0a20 2020 2023 2043 7265 6174 6520 6e65  .    # Create ne
-0000f2d0: 7720 6669 7473 2063 6174 616c 6f67 2077  w fits catalog w
-0000f2e0: 6974 6820 6e65 7720 636f 6c75 6d6e 730a  ith new columns.
-0000f2f0: 2020 2020 6e65 775f 6461 7461 203d 205b      new_data = [
-0000f300: 5d0a 0a20 2020 2066 696c 745f 7374 616e  ]..    filt_stan
-0000f310: 6461 7264 203d 2074 7261 6e73 6c61 7465  dard = translate
-0000f320: 5f66 696c 7465 725f 7374 616e 6461 7264  _filter_standard
-0000f330: 2866 696c 7429 0a0a 2020 2020 666f 7220  (filt)..    for 
-0000f340: 636f 6c20 696e 2063 6174 5f64 6174 612e  col in cat_data.
-0000f350: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
-0000f360: 206e 6577 5f64 6174 612e 6170 7065 6e64   new_data.append
-0000f370: 2863 6f6c 290a 0a20 2020 206e 6577 5f64  (col)..    new_d
-0000f380: 6174 612e 6170 7065 6e64 2866 6974 732e  ata.append(fits.
-0000f390: 436f 6c75 6d6e 286e 616d 653d 6622 5241  Column(name=f"RA
-0000f3a0: 5f7b 6669 6c74 5f73 7461 6e64 6172 647d  _{filt_standard}
-0000f3b0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0000f3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f3d0: 2020 2066 6f72 6d61 743d 2731 4527 2c0a     format='1E',.
-0000f3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f400: 6172 7261 793d 6361 745f 6461 7461 2e63  array=cat_data.c
-0000f410: 6f6c 756d 6e73 5b22 414c 5048 415f 4a32  olumns["ALPHA_J2
-0000f420: 3030 3022 5d2e 6172 7261 7929 290a 0a20  000"].array)).. 
-0000f430: 2020 206e 6577 5f64 6174 612e 6170 7065     new_data.appe
-0000f440: 6e64 2866 6974 732e 436f 6c75 6d6e 286e  nd(fits.Column(n
-0000f450: 616d 653d 6622 4445 435f 7b66 696c 745f  ame=f"DEC_{filt_
-0000f460: 7374 616e 6461 7264 7d22 2c0a 2020 2020  standard}",.    
-0000f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f480: 2020 2020 2020 2020 2020 2020 666f 726d              form
-0000f490: 6174 3d27 3145 272c 0a20 2020 2020 2020  at='1E',.       
-0000f4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f4b0: 2020 2020 2020 2020 2061 7272 6179 3d63           array=c
-0000f4c0: 6174 5f64 6174 612e 636f 6c75 6d6e 735b  at_data.columns[
-0000f4d0: 2244 454c 5441 5f4a 3230 3030 225d 2e61  "DELTA_J2000"].a
-0000f4e0: 7272 6179 2929 0a0a 2020 2020 2320 4173  rray))..    # As
-0000f4f0: 7369 676e 2066 696c 7465 7220 4944 730a  sign filter IDs.
-0000f500: 2020 2020 7365 785f 6669 6c74 6572 5f6e      sex_filter_n
-0000f510: 756d 6265 7220 3d20 6361 745f 6461 7461  umber = cat_data
-0000f520: 2e63 6f6c 756d 6e73 5b27 4e55 4d42 4552  .columns['NUMBER
-0000f530: 275d 2e61 7272 6179 0a0a 2020 2020 6669  '].array..    fi
-0000f540: 6c74 5f73 7461 6e64 6172 6420 3d20 7472  lt_standard = tr
-0000f550: 616e 736c 6174 655f 6669 6c74 6572 5f73  anslate_filter_s
-0000f560: 7461 6e64 6172 6428 6669 6c74 290a 2020  tandard(filt).  
-0000f570: 2020 6669 6c74 6572 5f49 4420 3d20 5b66    filter_ID = [f
-0000f580: 277b 6472 6e61 6d65 7d5f 7b66 6965 6c64  '{drname}_{field
-0000f590: 7d5f 7369 6e67 6c65 5f7b 6669 6c74 5f73  }_single_{filt_s
-0000f5a0: 7461 6e64 6172 647d 5f7b 693a 3037 647d  tandard}_{i:07d}
-0000f5b0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0000f5c0: 2020 2066 6f72 2069 2069 6e20 7365 785f     for i in sex_
-0000f5d0: 6669 6c74 6572 5f6e 756d 6265 725d 0a0a  filter_number]..
-0000f5e0: 2020 2020 6e65 775f 6461 7461 2e61 7070      new_data.app
-0000f5f0: 656e 6428 6669 7473 2e43 6f6c 756d 6e28  end(fits.Column(
-0000f600: 6e61 6d65 3d66 277b 6669 6c74 5f73 7461  name=f'{filt_sta
-0000f610: 6e64 6172 647d 5f49 445f 7369 6e67 6c65  ndard}_ID_single
-0000f620: 2020 2020 272c 0a20 2020 2020 2020 2020      ',.         
-0000f630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f640: 2020 2020 2020 2066 6f72 6d61 743d 2735         format='5
-0000f650: 3041 272c 0a20 2020 2020 2020 2020 2020  0A',.           
-0000f660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f670: 2020 2020 2061 7272 6179 3d66 696c 7465       array=filte
-0000f680: 725f 4944 2929 0a0a 2020 2020 2320 5361  r_ID))..    # Sa
-0000f690: 7665 2063 6f72 7265 6374 6564 2064 6174  ve corrected dat
-0000f6a0: 6120 746f 2073 6176 655f 6669 6c65 2066  a to save_file f
-0000f6b0: 6974 7320 6361 7461 6c6f 670a 2020 2020  its catalog.    
-0000f6c0: 6864 7520 3d20 6669 7473 2e42 696e 5461  hdu = fits.BinTa
-0000f6d0: 626c 6548 4455 2e66 726f 6d5f 636f 6c75  bleHDU.from_colu
-0000f6e0: 6d6e 7328 6e65 775f 6461 7461 290a 2020  mns(new_data).  
-0000f6f0: 2020 6864 752e 7772 6974 6574 6f28 7361    hdu.writeto(sa
-0000f700: 7665 5f66 696c 6529 0a0a 0a64 6566 2065  ve_file)...def e
-0000f710: 7874 7261 6374 5f66 696c 745f 6964 5f73  xtract_filt_id_s
-0000f720: 696e 676c 6528 6361 7461 6c6f 672c 0a20  ingle(catalog,. 
-0000f730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f740: 2020 2020 2020 2020 2020 6669 6c74 2c0a            filt,.
-0000f750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f760: 2020 2020 2020 2020 2020 2073 6176 655f             save_
-0000f770: 6669 6c65 293a 0a0a 2020 2020 2222 220a  file):..    """.
-0000f780: 2020 2020 4578 7472 6163 7473 2066 696c      Extracts fil
-0000f790: 7465 725f 4944 2c20 5241 2c20 4445 4320  ter_ID, RA, DEC 
-0000f7a0: 6672 6f6d 2066 696c 7465 7220 4944 2063  from filter ID c
-0000f7b0: 6174 616c 6f67 2028 696e 2073 696e 676c  atalog (in singl
-0000f7c0: 6520 6d6f 6465 292e 0a0a 2020 2020 5061  e mode)...    Pa
-0000f7d0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-0000f7e0: 2d2d 2d2d 2d2d 2d0a 2020 2020 6361 7461  -------.    cata
-0000f7f0: 6c6f 6720 3a20 7374 720a 2020 2020 2020  log : str.      
-0000f800: 2020 4c6f 6361 7469 6f6e 206f 6620 5345    Location of SE
-0000f810: 7874 7261 6374 6f72 2070 686f 746f 6d65  xtractor photome
-0000f820: 7472 7920 6361 7461 6c6f 670a 2020 2020  try catalog.    
-0000f830: 6669 6c74 203a 2073 7472 0a20 2020 2020  filt : str.     
-0000f840: 2020 204e 616d 6520 6f66 2074 6865 2066     Name of the f
-0000f850: 696c 7465 720a 2020 2020 7361 7665 5f66  ilter.    save_f
-0000f860: 696c 6520 3a20 7374 720a 2020 2020 2020  ile : str.      
-0000f870: 2020 4465 7369 7265 6420 6c6f 6361 7469    Desired locati
-0000f880: 6f6e 2074 6f20 7361 7665 206e 6577 2063  on to save new c
-0000f890: 6174 616c 6f67 0a0a 2020 2020 5265 7475  atalog..    Retu
-0000f8a0: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-0000f8b0: 2020 2020 5361 7665 7320 6e65 7720 6361      Saves new ca
-0000f8c0: 7461 6c6f 6720 7769 7468 2066 696c 7465  talog with filte
-0000f8d0: 725f 4944 0a0a 2020 2020 2222 220a 0a20  r_ID..    """.. 
-0000f8e0: 2020 2023 2052 6561 6420 6361 7461 6c6f     # Read catalo
-0000f8f0: 670a 2020 2020 6361 7420 3d20 6669 7473  g.    cat = fits
-0000f900: 2e6f 7065 6e28 6361 7461 6c6f 6729 0a20  .open(catalog). 
-0000f910: 2020 2063 6174 5f64 6174 6120 3d20 6361     cat_data = ca
-0000f920: 745b 315d 2e64 6174 610a 0a20 2020 2023  t[1].data..    #
-0000f930: 2043 7265 6174 6520 6e65 7720 6669 7473   Create new fits
-0000f940: 2063 6174 616c 6f67 2077 6974 6820 6e65   catalog with ne
-0000f950: 7720 636f 6c75 6d6e 730a 2020 2020 6e65  w columns.    ne
-0000f960: 775f 6461 7461 203d 205b 5d0a 0a20 2020  w_data = []..   
-0000f970: 2066 696c 745f 7374 616e 6461 7264 203d   filt_standard =
-0000f980: 2074 7261 6e73 6c61 7465 5f66 696c 7465   translate_filte
-0000f990: 725f 7374 616e 6461 7264 2866 696c 7429  r_standard(filt)
-0000f9a0: 0a0a 2020 2020 666f 7220 636f 6c20 696e  ..    for col in
-0000f9b0: 2063 6174 5f64 6174 612e 636f 6c75 6d6e   cat_data.column
-0000f9c0: 733a 0a20 2020 2020 2020 2069 6620 636f  s:.        if co
-0000f9d0: 6c2e 6e61 6d65 2069 6e20 5b66 2252 415f  l.name in [f"RA_
-0000f9e0: 7b66 696c 745f 7374 616e 6461 7264 7d22  {filt_standard}"
-0000f9f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000fa00: 2020 2020 2020 2020 2020 6622 4445 435f            f"DEC_
-0000fa10: 7b66 696c 745f 7374 616e 6461 7264 7d22  {filt_standard}"
-0000fa20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000fa30: 2020 2020 2020 2020 2020 6627 7b66 696c            f'{fil
-0000fa40: 745f 7374 616e 6461 7264 7d5f 4944 5f53  t_standard}_ID_S
-0000fa50: 494e 474c 4527 5d3a 0a0a 2020 2020 2020  INGLE']:..      
-0000fa60: 2020 2020 2020 6e65 775f 6461 7461 2e61        new_data.a
-0000fa70: 7070 656e 6428 636f 6c29 0a0a 2020 2020  ppend(col)..    
-0000fa80: 2320 5361 7665 2063 6f72 7265 6374 6564  # Save corrected
-0000fa90: 2064 6174 6120 746f 2073 6176 655f 6669   data to save_fi
-0000faa0: 6c65 2066 6974 7320 6361 7461 6c6f 670a  le fits catalog.
-0000fab0: 2020 2020 6864 7520 3d20 6669 7473 2e42      hdu = fits.B
-0000fac0: 696e 5461 626c 6548 4455 2e66 726f 6d5f  inTableHDU.from_
-0000fad0: 636f 6c75 6d6e 7328 6e65 775f 6461 7461  columns(new_data
-0000fae0: 290a 2020 2020 6864 752e 7772 6974 6574  ).    hdu.writet
-0000faf0: 6f28 7361 7665 5f66 696c 6529 0a0a 0a64  o(save_file)...d
-0000fb00: 6566 2065 7874 7261 6374 5f66 696c 745f  ef extract_filt_
-0000fb10: 6964 5f70 7366 2863 6174 616c 6f67 2c0a  id_psf(catalog,.
-0000fb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb30: 2020 2020 2020 2020 6669 6c74 2c0a 2020          filt,.  
-0000fb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb50: 2020 2020 2020 7361 7665 5f66 696c 6529        save_file)
-0000fb60: 3a0a 0a20 2020 2022 2222 0a20 2020 2045  :..    """.    E
-0000fb70: 7874 7261 6374 7320 6669 6c74 6572 5f49  xtracts filter_I
-0000fb80: 442c 2052 412c 2044 4543 2066 726f 6d20  D, RA, DEC from 
-0000fb90: 6669 6c74 6572 2049 4420 6361 7461 6c6f  filter ID catalo
-0000fba0: 6720 2869 6e20 5053 4620 6d6f 6465 292e  g (in PSF mode).
-0000fbb0: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
-0000fbc0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-0000fbd0: 2020 2020 6361 7461 6c6f 6720 3a20 7374      catalog : st
-0000fbe0: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
-0000fbf0: 6f6e 206f 6620 5345 7874 7261 6374 6f72  on of SExtractor
-0000fc00: 2070 686f 746f 6d65 7472 7920 6361 7461   photometry cata
-0000fc10: 6c6f 670a 2020 2020 6669 6c74 203a 2073  log.    filt : s
-0000fc20: 7472 0a20 2020 2020 2020 204e 616d 6520  tr.        Name 
-0000fc30: 6f66 2074 6865 2066 696c 7465 720a 2020  of the filter.  
-0000fc40: 2020 7361 7665 5f66 696c 6520 3a20 7374    save_file : st
-0000fc50: 720a 2020 2020 2020 2020 4465 7369 7265  r.        Desire
-0000fc60: 6420 6c6f 6361 7469 6f6e 2074 6f20 7361  d location to sa
-0000fc70: 7665 206e 6577 2063 6174 616c 6f67 0a0a  ve new catalog..
-0000fc80: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-0000fc90: 2d2d 2d2d 2d2d 2d0a 2020 2020 5361 7665  -------.    Save
-0000fca0: 7320 6e65 7720 6361 7461 6c6f 6720 7769  s new catalog wi
-0000fcb0: 7468 2066 696c 7465 725f 4944 0a0a 2020  th filter_ID..  
-0000fcc0: 2020 2222 220a 0a20 2020 2023 2052 6561    """..    # Rea
-0000fcd0: 6420 6361 7461 6c6f 670a 2020 2020 6361  d catalog.    ca
-0000fce0: 7420 3d20 6c6f 6164 5f64 6174 6128 6361  t = load_data(ca
-0000fcf0: 7461 6c6f 6729 0a0a 2020 2020 2320 4372  talog)..    # Cr
-0000fd00: 6561 7465 206e 6577 2066 6974 7320 6361  eate new fits ca
-0000fd10: 7461 6c6f 6720 7769 7468 206e 6577 2063  talog with new c
-0000fd20: 6f6c 756d 6e73 0a20 2020 206e 6577 5f64  olumns.    new_d
-0000fd30: 6174 6120 3d20 5b5d 0a0a 2020 2020 6669  ata = []..    fi
-0000fd40: 6c74 5f73 7461 6e64 6172 6420 3d20 7472  lt_standard = tr
-0000fd50: 616e 736c 6174 655f 6669 6c74 6572 5f73  anslate_filter_s
-0000fd60: 7461 6e64 6172 6428 6669 6c74 290a 0a20  tandard(filt).. 
-0000fd70: 2020 2066 696c 745f 4944 203d 2063 6174     filt_ID = cat
-0000fd80: 2e6c 6f63 5b3a 2c66 227b 6669 6c74 5f73  .loc[:,f"{filt_s
-0000fd90: 7461 6e64 6172 647d 5f49 445f 7073 6622  tandard}_ID_psf"
-0000fda0: 5d2e 7661 6c75 6573 0a20 2020 206e 6577  ].values.    new
-0000fdb0: 5f64 6174 612e 6170 7065 6e64 2866 6974  _data.append(fit
-0000fdc0: 732e 436f 6c75 6d6e 286e 616d 653d 6622  s.Column(name=f"
-0000fdd0: 7b66 696c 745f 7374 616e 6461 7264 7d5f  {filt_standard}_
-0000fde0: 4944 5f70 7366 222c 0a20 2020 2020 2020  ID_psf",.       
-0000fdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe00: 2020 2020 2020 2020 2066 6f72 6d61 743d           format=
-0000fe10: 2735 3041 272c 0a20 2020 2020 2020 2020  '50A',.         
-0000fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe30: 2020 2020 2020 2061 7272 6179 3d66 696c         array=fil
-0000fe40: 745f 4944 2929 0a0a 2020 2020 5241 203d  t_ID))..    RA =
-0000fe50: 2063 6174 2e6c 6f63 5b3a 2c66 2252 415f   cat.loc[:,f"RA_
-0000fe60: 7b66 696c 745f 7374 616e 6461 7264 7d22  {filt_standard}"
-0000fe70: 5d2e 7661 6c75 6573 0a20 2020 206e 6577  ].values.    new
-0000fe80: 5f64 6174 612e 6170 7065 6e64 2866 6974  _data.append(fit
-0000fe90: 732e 436f 6c75 6d6e 286e 616d 653d 6622  s.Column(name=f"
-0000fea0: 5241 5f7b 6669 6c74 5f73 7461 6e64 6172  RA_{filt_standar
-0000feb0: 647d 222c 0a20 2020 2020 2020 2020 2020  d}",.           
-0000fec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fed0: 2020 2020 2066 6f72 6d61 743d 2731 4527       format='1E'
-0000fee0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000fef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff00: 2020 6172 7261 793d 5241 2929 0a0a 2020    array=RA))..  
-0000ff10: 2020 4445 4320 3d20 6361 742e 6c6f 635b    DEC = cat.loc[
-0000ff20: 3a2c 6622 4445 435f 7b66 696c 745f 7374  :,f"DEC_{filt_st
-0000ff30: 616e 6461 7264 7d22 5d2e 7661 6c75 6573  andard}"].values
-0000ff40: 0a20 2020 206e 6577 5f64 6174 612e 6170  .    new_data.ap
-0000ff50: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
-0000ff60: 286e 616d 653d 6622 4445 435f 7b66 696c  (name=f"DEC_{fil
-0000ff70: 745f 7374 616e 6461 7264 7d22 2c0a 2020  t_standard}",.  
-0000ff80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff90: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0000ffa0: 726d 6174 3d27 3145 272c 0a20 2020 2020  rmat='1E',.     
-0000ffb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ffc0: 2020 2020 2020 2020 2020 2061 7272 6179             array
-0000ffd0: 3d44 4543 2929 0a0a 2020 2020 2320 5361  =DEC))..    # Sa
-0000ffe0: 7665 2063 6f72 7265 6374 6564 2064 6174  ve corrected dat
-0000fff0: 6120 746f 2073 6176 655f 6669 6c65 2066  a to save_file f
-00010000: 6974 7320 6361 7461 6c6f 670a 2020 2020  its catalog.    
-00010010: 6864 7520 3d20 6669 7473 2e42 696e 5461  hdu = fits.BinTa
-00010020: 626c 6548 4455 2e66 726f 6d5f 636f 6c75  bleHDU.from_colu
-00010030: 6d6e 7328 6e65 775f 6461 7461 290a 2020  mns(new_data).  
-00010040: 2020 6864 752e 7772 6974 6574 6f28 7361    hdu.writeto(sa
-00010050: 7665 5f66 696c 6529 0a0a 0a64 6566 2067  ve_file)...def g
-00010060: 656e 6572 6174 655f 7068 6f74 5f69 6428  enerate_phot_id(
-00010070: 6361 7461 6c6f 672c 0a20 2020 2020 2020  catalog,.       
-00010080: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00010090: 6176 655f 6669 6c65 2c0a 2020 2020 2020  ave_file,.      
-000100a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000100b0: 6669 6c74 6572 732c 0a20 2020 2020 2020  filters,.       
-000100c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000100d0: 6965 6c64 203d 2027 4e6f 4669 656c 644e  ield = 'NoFieldN
-000100e0: 616d 6527 2c0a 2020 2020 2020 2020 2020  ame',.          
-000100f0: 2020 2020 2020 2020 2020 2020 6472 6e61              drna
-00010100: 6d65 203d 2027 4e6f 4452 6e61 6d65 272c  me = 'NoDRname',
-00010110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010120: 2020 2020 2020 206d 6f64 6520 3d20 276e         mode = 'n
-00010130: 6f4d 6f64 6527 293a 0a0a 2020 2020 2222  oMode'):..    ""
-00010140: 220a 2020 2020 4765 6e65 7261 7465 204d  ".    Generate M
-00010150: 4f44 4520 4944 2053 494e 474c 452f 5053  ODE ID SINGLE/PS
-00010160: 4620 7068 6f74 6f6d 6574 7269 6573 0a0a  F photometries..
-00010170: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-00010180: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-00010190: 2020 6361 7461 6c6f 6720 3a20 7374 720a    catalog : str.
-000101a0: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
-000101b0: 206f 6620 5345 7874 7261 6374 6f72 2070   of SExtractor p
-000101c0: 686f 746f 6d65 7472 7920 6361 7461 6c6f  hotometry catalo
-000101d0: 670a 2020 2020 7361 7665 5f66 696c 6520  g.    save_file 
-000101e0: 3a20 7374 720a 2020 2020 2020 2020 4465  : str.        De
-000101f0: 7369 7265 6420 6c6f 6361 7469 6f6e 2074  sired location t
-00010200: 6f20 7361 7665 206e 6577 2063 6174 616c  o save new catal
-00010210: 6f67 0a20 2020 2066 696c 7465 7273 203a  og.    filters :
-00010220: 2073 7472 0a20 2020 2020 2020 204c 6973   str.        Lis
-00010230: 7420 6f66 2053 2d50 4c55 5320 6669 6c74  t of S-PLUS filt
-00010240: 6572 730a 2020 2020 6669 656c 6420 3a20  ers.    field : 
-00010250: 7374 720a 2020 2020 2020 2020 4e61 6d65  str.        Name
-00010260: 206f 6620 7468 6520 6669 656c 6420 746f   of the field to
-00010270: 2062 6520 6164 6465 6420 746f 2074 6865   be added to the
-00010280: 2066 696c 7465 725f 4944 0a20 2020 2064   filter_ID.    d
-00010290: 726e 616d 6520 3a20 7374 720a 2020 2020  rname : str.    
-000102a0: 2020 2020 4461 7461 2072 656c 6561 7365      Data release
-000102b0: 2064 6573 6967 6e61 7469 6f6e 2074 6f20   designation to 
-000102c0: 6265 2061 6464 6564 2074 6f20 7468 6520  be added to the 
-000102d0: 6669 6c74 6572 5f49 440a 0a20 2020 2052  filter_ID..    R
-000102e0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-000102f0: 2d2d 0a20 2020 2053 6176 6573 206e 6577  --.    Saves new
-00010300: 2063 6174 616c 6f67 2077 6974 6820 6669   catalog with fi
-00010310: 656c 645f 4944 2c20 5241 5f66 6965 6c64  eld_ID, RA_field
-00010320: 5f49 442c 2044 4543 5f66 6965 6c64 5f49  _ID, DEC_field_I
-00010330: 440a 0a20 2020 2022 2222 0a0a 2020 2020  D..    """..    
-00010340: 2320 5265 6164 2063 6174 616c 6f67 0a20  # Read catalog. 
-00010350: 2020 2063 6174 203d 2066 6974 732e 6f70     cat = fits.op
-00010360: 656e 2863 6174 616c 6f67 290a 2020 2020  en(catalog).    
-00010370: 6361 745f 6461 7461 203d 2063 6174 5b31  cat_data = cat[1
-00010380: 5d2e 6461 7461 0a0a 2020 2020 2320 4372  ].data..    # Cr
-00010390: 6561 7465 206e 6577 2066 6974 7320 6361  eate new fits ca
-000103a0: 7461 6c6f 6720 7769 7468 206e 6577 2063  talog with new c
-000103b0: 6f6c 756d 6e73 0a20 2020 206e 6577 5f64  olumns.    new_d
-000103c0: 6174 6120 3d20 5b5d 0a0a 2020 2020 6e6c  ata = []..    nl
-000103d0: 696e 6573 203d 206c 656e 2863 6174 5f64  ines = len(cat_d
-000103e0: 6174 6129 0a0a 2020 2020 5048 4f54 5f49  ata)..    PHOT_I
-000103f0: 4420 3d20 5b66 277b 6472 6e61 6d65 7d5f  D = [f'{drname}_
-00010400: 7b66 6965 6c64 7d5f 7b6d 6f64 657d 5f7b  {field}_{mode}_{
-00010410: 693a 3037 647d 270a 2020 2020 2020 2020  i:07d}'.        
-00010420: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00010430: 6920 696e 2072 616e 6765 2831 2c6e 6c69  i in range(1,nli
-00010440: 6e65 732b 3129 5d0a 0a20 2020 2050 484f  nes+1)]..    PHO
-00010450: 545f 4944 5f52 4120 3d20 6e70 2e66 756c  T_ID_RA = np.ful
-00010460: 6c28 6e6c 696e 6573 2c20 6e70 2e6e 616e  l(nlines, np.nan
-00010470: 290a 2020 2020 5048 4f54 5f49 445f 4445  ).    PHOT_ID_DE
-00010480: 4320 3d20 6e70 2e66 756c 6c28 6e6c 696e  C = np.full(nlin
-00010490: 6573 2c20 6e70 2e6e 616e 290a 0a20 2020  es, np.nan)..   
-000104a0: 2023 2066 696c 6c20 5241 2c20 4445 4320   # fill RA, DEC 
-000104b0: 6672 6f6d 2072 6564 2074 6f20 626c 7565  from red to blue
-000104c0: 0a20 2020 2066 6f72 2066 696c 7420 696e  .    for filt in
-000104d0: 2066 696c 7465 7273 3a0a 2020 2020 2020   filters:.      
-000104e0: 2020 6669 6c74 5f73 7461 6e64 6172 6420    filt_standard 
-000104f0: 3d20 7472 616e 736c 6174 655f 6669 6c74  = translate_filt
-00010500: 6572 5f73 7461 6e64 6172 6428 6669 6c74  er_standard(filt
-00010510: 290a 2020 2020 2020 2020 6620 3d20 6e70  ).        f = np
-00010520: 2e69 736e 616e 2850 484f 545f 4944 5f52  .isnan(PHOT_ID_R
-00010530: 4129 0a0a 2020 2020 2020 2020 7261 5f66  A)..        ra_f
-00010540: 696c 7420 3d20 6361 745f 6461 7461 2e63  ilt = cat_data.c
-00010550: 6f6c 756d 6e73 5b66 2752 415f 7b66 696c  olumns[f'RA_{fil
-00010560: 745f 7374 616e 6461 7264 7d27 5d2e 6172  t_standard}'].ar
-00010570: 7261 790a 2020 2020 2020 2020 6465 635f  ray.        dec_
-00010580: 6669 6c74 203d 2063 6174 5f64 6174 612e  filt = cat_data.
-00010590: 636f 6c75 6d6e 735b 6627 4445 435f 7b66  columns[f'DEC_{f
-000105a0: 696c 745f 7374 616e 6461 7264 7d27 5d2e  ilt_standard}'].
-000105b0: 6172 7261 790a 0a20 2020 2020 2020 2050  array..        P
-000105c0: 484f 545f 4944 5f52 415b 665d 203d 2072  HOT_ID_RA[f] = r
-000105d0: 615f 6669 6c74 5b66 5d0a 2020 2020 2020  a_filt[f].      
-000105e0: 2020 5048 4f54 5f49 445f 4445 435b 665d    PHOT_ID_DEC[f]
-000105f0: 203d 2064 6563 5f66 696c 745b 665d 0a0a   = dec_filt[f]..
-00010600: 2020 2020 6e65 775f 6461 7461 2e61 7070      new_data.app
-00010610: 656e 6428 6669 7473 2e43 6f6c 756d 6e28  end(fits.Column(
-00010620: 6e61 6d65 3d66 2750 484f 545f 4944 5f7b  name=f'PHOT_ID_{
-00010630: 6d6f 6465 7d27 2c0a 2020 2020 2020 2020  mode}',.        
-00010640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010650: 2020 2020 2020 2020 666f 726d 6174 3d27          format='
-00010660: 3530 4127 2c0a 2020 2020 2020 2020 2020  50A',.          
-00010670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010680: 2020 2020 2020 6172 7261 793d 5048 4f54        array=PHOT
-00010690: 5f49 4429 290a 0a20 2020 206e 6577 5f64  _ID))..    new_d
-000106a0: 6174 612e 6170 7065 6e64 2866 6974 732e  ata.append(fits.
-000106b0: 436f 6c75 6d6e 286e 616d 653d 6627 5048  Column(name=f'PH
-000106c0: 4f54 5f49 445f 5241 5f7b 6d6f 6465 7d27  OT_ID_RA_{mode}'
-000106d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000106e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000106f0: 2020 666f 726d 6174 3d27 3145 272c 0a20    format='1E',. 
-00010700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010710: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00010720: 7272 6179 3d50 484f 545f 4944 5f52 4129  rray=PHOT_ID_RA)
-00010730: 290a 0a20 2020 206e 6577 5f64 6174 612e  )..    new_data.
-00010740: 6170 7065 6e64 2866 6974 732e 436f 6c75  append(fits.Colu
-00010750: 6d6e 286e 616d 653d 6627 5048 4f54 5f49  mn(name=f'PHOT_I
-00010760: 445f 4445 435f 7b6d 6f64 657d 272c 0a20  D_DEC_{mode}',. 
+0000f020: 2020 2020 2020 2020 2020 6472 6e61 6d65            drname
+0000f030: 203d 2027 4e6f 4452 6e61 6d65 2729 3a0a   = 'NoDRname'):.
+0000f040: 0a20 2020 2022 2222 0a20 2020 2041 7373  .    """.    Ass
+0000f050: 6967 6e73 2064 6574 6563 7469 6f6e 2049  igns detection I
+0000f060: 4420 746f 2053 4578 7472 6163 746f 7220  D to SExtractor 
+0000f070: 7068 6f74 6f6d 6574 7279 2028 696e 2073  photometry (in s
+0000f080: 696e 676c 6520 6d6f 6465 292e 0a0a 2020  ingle mode)...  
+0000f090: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+0000f0a0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+0000f0b0: 6361 7461 6c6f 6720 3a20 7374 720a 2020  catalog : str.  
+0000f0c0: 2020 2020 2020 4c6f 6361 7469 6f6e 206f        Location o
+0000f0d0: 6620 5345 7874 7261 6374 6f72 2070 686f  f SExtractor pho
+0000f0e0: 746f 6d65 7472 7920 6361 7461 6c6f 670a  tometry catalog.
+0000f0f0: 2020 2020 6669 6c74 203a 2073 7472 0a20      filt : str. 
+0000f100: 2020 2020 2020 204e 616d 6520 6f66 2074         Name of t
+0000f110: 6865 2066 696c 7465 720a 2020 2020 7361  he filter.    sa
+0000f120: 7665 5f66 696c 6520 3a20 7374 720a 2020  ve_file : str.  
+0000f130: 2020 2020 2020 4465 7369 7265 6420 6c6f        Desired lo
+0000f140: 6361 7469 6f6e 2074 6f20 7361 7665 206e  cation to save n
+0000f150: 6577 2063 6174 616c 6f67 0a20 2020 2066  ew catalog.    f
+0000f160: 6965 6c64 203a 2073 7472 0a20 2020 2020  ield : str.     
+0000f170: 2020 204e 616d 6520 6f66 2074 6865 2066     Name of the f
+0000f180: 6965 6c64 2074 6f20 6265 2061 6464 6564  ield to be added
+0000f190: 2074 6f20 7468 6520 6669 6c74 6572 5f49   to the filter_I
+0000f1a0: 440a 2020 2020 6472 6e61 6d65 203a 2073  D.    drname : s
+0000f1b0: 7472 0a20 2020 2020 2020 2044 6174 6120  tr.        Data 
+0000f1c0: 7265 6c65 6173 6520 6465 7369 676e 6174  release designat
+0000f1d0: 696f 6e20 746f 2062 6520 6164 6465 6420  ion to be added 
+0000f1e0: 746f 2074 6865 2066 696c 7465 725f 4944  to the filter_ID
+0000f1f0: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
+0000f200: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 5361    -------.    Sa
+0000f210: 7665 7320 6e65 7720 6361 7461 6c6f 6720  ves new catalog 
+0000f220: 7769 7468 2066 696c 7465 725f 4944 0a0a  with filter_ID..
+0000f230: 2020 2020 2222 220a 0a20 2020 2023 2052      """..    # R
+0000f240: 6561 6420 6361 7461 6c6f 670a 2020 2020  ead catalog.    
+0000f250: 6361 7420 3d20 6669 7473 2e6f 7065 6e28  cat = fits.open(
+0000f260: 6361 7461 6c6f 6729 0a20 2020 2063 6174  catalog).    cat
+0000f270: 5f64 6174 6120 3d20 6361 745b 315d 2e64  _data = cat[1].d
+0000f280: 6174 610a 0a20 2020 2023 2043 7265 6174  ata..    # Creat
+0000f290: 6520 6e65 7720 6669 7473 2063 6174 616c  e new fits catal
+0000f2a0: 6f67 2077 6974 6820 6e65 7720 636f 6c75  og with new colu
+0000f2b0: 6d6e 730a 2020 2020 6e65 775f 6461 7461  mns.    new_data
+0000f2c0: 203d 205b 5d0a 0a20 2020 2066 696c 745f   = []..    filt_
+0000f2d0: 7374 616e 6461 7264 203d 2074 7261 6e73  standard = trans
+0000f2e0: 6c61 7465 5f66 696c 7465 725f 7374 616e  late_filter_stan
+0000f2f0: 6461 7264 2866 696c 7429 0a0a 2020 2020  dard(filt)..    
+0000f300: 666f 7220 636f 6c20 696e 2063 6174 5f64  for col in cat_d
+0000f310: 6174 612e 636f 6c75 6d6e 733a 0a20 2020  ata.columns:.   
+0000f320: 2020 2020 206e 6577 5f64 6174 612e 6170       new_data.ap
+0000f330: 7065 6e64 2863 6f6c 290a 0a20 2020 206e  pend(col)..    n
+0000f340: 6577 5f64 6174 612e 6170 7065 6e64 2866  ew_data.append(f
+0000f350: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
+0000f360: 6622 5241 5f7b 6669 6c74 5f73 7461 6e64  f"RA_{filt_stand
+0000f370: 6172 647d 222c 0a20 2020 2020 2020 2020  ard}",.         
+0000f380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f390: 2020 2020 2020 2066 6f72 6d61 743d 2731         format='1
+0000f3a0: 4527 2c0a 2020 2020 2020 2020 2020 2020  E',.            
+0000f3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f3c0: 2020 2020 6172 7261 793d 6361 745f 6461      array=cat_da
+0000f3d0: 7461 2e63 6f6c 756d 6e73 5b22 414c 5048  ta.columns["ALPH
+0000f3e0: 415f 4a32 3030 3022 5d2e 6172 7261 7929  A_J2000"].array)
+0000f3f0: 290a 0a20 2020 206e 6577 5f64 6174 612e  )..    new_data.
+0000f400: 6170 7065 6e64 2866 6974 732e 436f 6c75  append(fits.Colu
+0000f410: 6d6e 286e 616d 653d 6622 4445 435f 7b66  mn(name=f"DEC_{f
+0000f420: 696c 745f 7374 616e 6461 7264 7d22 2c0a  ilt_standard}",.
+0000f430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f450: 666f 726d 6174 3d27 3145 272c 0a20 2020  format='1E',.   
+0000f460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f470: 2020 2020 2020 2020 2020 2020 2061 7272               arr
+0000f480: 6179 3d63 6174 5f64 6174 612e 636f 6c75  ay=cat_data.colu
+0000f490: 6d6e 735b 2244 454c 5441 5f4a 3230 3030  mns["DELTA_J2000
+0000f4a0: 225d 2e61 7272 6179 2929 0a0a 2020 2020  "].array))..    
+0000f4b0: 2320 4173 7369 676e 2066 696c 7465 7220  # Assign filter 
+0000f4c0: 4944 730a 2020 2020 7365 785f 6669 6c74  IDs.    sex_filt
+0000f4d0: 6572 5f6e 756d 6265 7220 3d20 6361 745f  er_number = cat_
+0000f4e0: 6461 7461 2e63 6f6c 756d 6e73 5b27 4e55  data.columns['NU
+0000f4f0: 4d42 4552 275d 2e61 7272 6179 0a0a 2020  MBER'].array..  
+0000f500: 2020 6669 6c74 5f73 7461 6e64 6172 6420    filt_standard 
+0000f510: 3d20 7472 616e 736c 6174 655f 6669 6c74  = translate_filt
+0000f520: 6572 5f73 7461 6e64 6172 6428 6669 6c74  er_standard(filt
+0000f530: 290a 2020 2020 6669 6c74 6572 5f49 4420  ).    filter_ID 
+0000f540: 3d20 5b66 277b 6472 6e61 6d65 7d5f 7b66  = [f'{drname}_{f
+0000f550: 6965 6c64 7d5f 7369 6e67 6c65 5f7b 6669  ield}_single_{fi
+0000f560: 6c74 5f73 7461 6e64 6172 647d 5f7b 693a  lt_standard}_{i:
+0000f570: 3037 647d 270a 2020 2020 2020 2020 2020  07d}'.          
+0000f580: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+0000f590: 7365 785f 6669 6c74 6572 5f6e 756d 6265  sex_filter_numbe
+0000f5a0: 725d 0a0a 2020 2020 6e65 775f 6461 7461  r]..    new_data
+0000f5b0: 2e61 7070 656e 6428 6669 7473 2e43 6f6c  .append(fits.Col
+0000f5c0: 756d 6e28 6e61 6d65 3d66 277b 6669 6c74  umn(name=f'{filt
+0000f5d0: 5f73 7461 6e64 6172 647d 5f49 445f 7369  _standard}_ID_si
+0000f5e0: 6e67 6c65 2020 2020 272c 0a20 2020 2020  ngle    ',.     
+0000f5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f600: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+0000f610: 743d 2735 3041 272c 0a20 2020 2020 2020  t='50A',.       
+0000f620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f630: 2020 2020 2020 2020 2061 7272 6179 3d66           array=f
+0000f640: 696c 7465 725f 4944 2929 0a0a 2020 2020  ilter_ID))..    
+0000f650: 2320 5361 7665 2063 6f72 7265 6374 6564  # Save corrected
+0000f660: 2064 6174 6120 746f 2073 6176 655f 6669   data to save_fi
+0000f670: 6c65 2066 6974 7320 6361 7461 6c6f 670a  le fits catalog.
+0000f680: 2020 2020 6864 7520 3d20 6669 7473 2e42      hdu = fits.B
+0000f690: 696e 5461 626c 6548 4455 2e66 726f 6d5f  inTableHDU.from_
+0000f6a0: 636f 6c75 6d6e 7328 6e65 775f 6461 7461  columns(new_data
+0000f6b0: 290a 2020 2020 6864 752e 7772 6974 6574  ).    hdu.writet
+0000f6c0: 6f28 7361 7665 5f66 696c 6529 0a0a 0a64  o(save_file)...d
+0000f6d0: 6566 2065 7874 7261 6374 5f66 696c 745f  ef extract_filt_
+0000f6e0: 6964 5f73 696e 676c 6528 6361 7461 6c6f  id_single(catalo
+0000f6f0: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
+0000f700: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+0000f710: 6c74 2c0a 2020 2020 2020 2020 2020 2020  lt,.            
+0000f720: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000f730: 6176 655f 6669 6c65 293a 0a0a 2020 2020  ave_file):..    
+0000f740: 2222 220a 2020 2020 4578 7472 6163 7473  """.    Extracts
+0000f750: 2066 696c 7465 725f 4944 2c20 5241 2c20   filter_ID, RA, 
+0000f760: 4445 4320 6672 6f6d 2066 696c 7465 7220  DEC from filter 
+0000f770: 4944 2063 6174 616c 6f67 2028 696e 2073  ID catalog (in s
+0000f780: 696e 676c 6520 6d6f 6465 292e 0a0a 2020  ingle mode)...  
+0000f790: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+0000f7a0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+0000f7b0: 6361 7461 6c6f 6720 3a20 7374 720a 2020  catalog : str.  
+0000f7c0: 2020 2020 2020 4c6f 6361 7469 6f6e 206f        Location o
+0000f7d0: 6620 5345 7874 7261 6374 6f72 2070 686f  f SExtractor pho
+0000f7e0: 746f 6d65 7472 7920 6361 7461 6c6f 670a  tometry catalog.
+0000f7f0: 2020 2020 6669 6c74 203a 2073 7472 0a20      filt : str. 
+0000f800: 2020 2020 2020 204e 616d 6520 6f66 2074         Name of t
+0000f810: 6865 2066 696c 7465 720a 2020 2020 7361  he filter.    sa
+0000f820: 7665 5f66 696c 6520 3a20 7374 720a 2020  ve_file : str.  
+0000f830: 2020 2020 2020 4465 7369 7265 6420 6c6f        Desired lo
+0000f840: 6361 7469 6f6e 2074 6f20 7361 7665 206e  cation to save n
+0000f850: 6577 2063 6174 616c 6f67 0a0a 2020 2020  ew catalog..    
+0000f860: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+0000f870: 2d2d 2d0a 2020 2020 5361 7665 7320 6e65  ---.    Saves ne
+0000f880: 7720 6361 7461 6c6f 6720 7769 7468 2066  w catalog with f
+0000f890: 696c 7465 725f 4944 0a0a 2020 2020 2222  ilter_ID..    ""
+0000f8a0: 220a 0a20 2020 2023 2052 6561 6420 6361  "..    # Read ca
+0000f8b0: 7461 6c6f 670a 2020 2020 6361 7420 3d20  talog.    cat = 
+0000f8c0: 6669 7473 2e6f 7065 6e28 6361 7461 6c6f  fits.open(catalo
+0000f8d0: 6729 0a20 2020 2063 6174 5f64 6174 6120  g).    cat_data 
+0000f8e0: 3d20 6361 745b 315d 2e64 6174 610a 0a20  = cat[1].data.. 
+0000f8f0: 2020 2023 2043 7265 6174 6520 6e65 7720     # Create new 
+0000f900: 6669 7473 2063 6174 616c 6f67 2077 6974  fits catalog wit
+0000f910: 6820 6e65 7720 636f 6c75 6d6e 730a 2020  h new columns.  
+0000f920: 2020 6e65 775f 6461 7461 203d 205b 5d0a    new_data = [].
+0000f930: 0a20 2020 2066 696c 745f 7374 616e 6461  .    filt_standa
+0000f940: 7264 203d 2074 7261 6e73 6c61 7465 5f66  rd = translate_f
+0000f950: 696c 7465 725f 7374 616e 6461 7264 2866  ilter_standard(f
+0000f960: 696c 7429 0a0a 2020 2020 666f 7220 636f  ilt)..    for co
+0000f970: 6c20 696e 2063 6174 5f64 6174 612e 636f  l in cat_data.co
+0000f980: 6c75 6d6e 733a 0a20 2020 2020 2020 2069  lumns:.        i
+0000f990: 6620 636f 6c2e 6e61 6d65 2069 6e20 5b66  f col.name in [f
+0000f9a0: 2252 415f 7b66 696c 745f 7374 616e 6461  "RA_{filt_standa
+0000f9b0: 7264 7d22 2c0a 2020 2020 2020 2020 2020  rd}",.          
+0000f9c0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0000f9d0: 4445 435f 7b66 696c 745f 7374 616e 6461  DEC_{filt_standa
+0000f9e0: 7264 7d22 2c0a 2020 2020 2020 2020 2020  rd}",.          
+0000f9f0: 2020 2020 2020 2020 2020 2020 2020 6627                f'
+0000fa00: 7b66 696c 745f 7374 616e 6461 7264 7d5f  {filt_standard}_
+0000fa10: 4944 5f53 494e 474c 4527 5d3a 0a0a 2020  ID_SINGLE']:..  
+0000fa20: 2020 2020 2020 2020 2020 6e65 775f 6461            new_da
+0000fa30: 7461 2e61 7070 656e 6428 636f 6c29 0a0a  ta.append(col)..
+0000fa40: 2020 2020 2320 5361 7665 2063 6f72 7265      # Save corre
+0000fa50: 6374 6564 2064 6174 6120 746f 2073 6176  cted data to sav
+0000fa60: 655f 6669 6c65 2066 6974 7320 6361 7461  e_file fits cata
+0000fa70: 6c6f 670a 2020 2020 6864 7520 3d20 6669  log.    hdu = fi
+0000fa80: 7473 2e42 696e 5461 626c 6548 4455 2e66  ts.BinTableHDU.f
+0000fa90: 726f 6d5f 636f 6c75 6d6e 7328 6e65 775f  rom_columns(new_
+0000faa0: 6461 7461 290a 2020 2020 6864 752e 7772  data).    hdu.wr
+0000fab0: 6974 6574 6f28 7361 7665 5f66 696c 6529  iteto(save_file)
+0000fac0: 0a0a 0a64 6566 2065 7874 7261 6374 5f66  ...def extract_f
+0000fad0: 696c 745f 6964 5f70 7366 2863 6174 616c  ilt_id_psf(catal
+0000fae0: 6f67 2c0a 2020 2020 2020 2020 2020 2020  og,.            
+0000faf0: 2020 2020 2020 2020 2020 2020 6669 6c74              filt
+0000fb00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000fb10: 2020 2020 2020 2020 2020 7361 7665 5f66            save_f
+0000fb20: 696c 6529 3a0a 0a20 2020 2022 2222 0a20  ile):..    """. 
+0000fb30: 2020 2045 7874 7261 6374 7320 6669 6c74     Extracts filt
+0000fb40: 6572 5f49 442c 2052 412c 2044 4543 2066  er_ID, RA, DEC f
+0000fb50: 726f 6d20 6669 6c74 6572 2049 4420 6361  rom filter ID ca
+0000fb60: 7461 6c6f 6720 2869 6e20 5053 4620 6d6f  talog (in PSF mo
+0000fb70: 6465 292e 0a0a 2020 2020 5061 7261 6d65  de)...    Parame
+0000fb80: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+0000fb90: 2d2d 2d0a 2020 2020 6361 7461 6c6f 6720  ---.    catalog 
+0000fba0: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
+0000fbb0: 6361 7469 6f6e 206f 6620 5345 7874 7261  cation of SExtra
+0000fbc0: 6374 6f72 2070 686f 746f 6d65 7472 7920  ctor photometry 
+0000fbd0: 6361 7461 6c6f 670a 2020 2020 6669 6c74  catalog.    filt
+0000fbe0: 203a 2073 7472 0a20 2020 2020 2020 204e   : str.        N
+0000fbf0: 616d 6520 6f66 2074 6865 2066 696c 7465  ame of the filte
+0000fc00: 720a 2020 2020 7361 7665 5f66 696c 6520  r.    save_file 
+0000fc10: 3a20 7374 720a 2020 2020 2020 2020 4465  : str.        De
+0000fc20: 7369 7265 6420 6c6f 6361 7469 6f6e 2074  sired location t
+0000fc30: 6f20 7361 7665 206e 6577 2063 6174 616c  o save new catal
+0000fc40: 6f67 0a0a 2020 2020 5265 7475 726e 730a  og..    Returns.
+0000fc50: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+0000fc60: 5361 7665 7320 6e65 7720 6361 7461 6c6f  Saves new catalo
+0000fc70: 6720 7769 7468 2066 696c 7465 725f 4944  g with filter_ID
+0000fc80: 0a0a 2020 2020 2222 220a 0a20 2020 2023  ..    """..    #
+0000fc90: 2052 6561 6420 6361 7461 6c6f 670a 2020   Read catalog.  
+0000fca0: 2020 6361 7420 3d20 6c6f 6164 5f64 6174    cat = load_dat
+0000fcb0: 6128 6361 7461 6c6f 6729 0a0a 2020 2020  a(catalog)..    
+0000fcc0: 2320 4372 6561 7465 206e 6577 2066 6974  # Create new fit
+0000fcd0: 7320 6361 7461 6c6f 6720 7769 7468 206e  s catalog with n
+0000fce0: 6577 2063 6f6c 756d 6e73 0a20 2020 206e  ew columns.    n
+0000fcf0: 6577 5f64 6174 6120 3d20 5b5d 0a0a 2020  ew_data = []..  
+0000fd00: 2020 6669 6c74 5f73 7461 6e64 6172 6420    filt_standard 
+0000fd10: 3d20 7472 616e 736c 6174 655f 6669 6c74  = translate_filt
+0000fd20: 6572 5f73 7461 6e64 6172 6428 6669 6c74  er_standard(filt
+0000fd30: 290a 0a20 2020 2066 696c 745f 4944 203d  )..    filt_ID =
+0000fd40: 2063 6174 2e6c 6f63 5b3a 2c66 227b 6669   cat.loc[:,f"{fi
+0000fd50: 6c74 5f73 7461 6e64 6172 647d 5f49 445f  lt_standard}_ID_
+0000fd60: 7073 6622 5d2e 7661 6c75 6573 0a20 2020  psf"].values.   
+0000fd70: 206e 6577 5f64 6174 612e 6170 7065 6e64   new_data.append
+0000fd80: 2866 6974 732e 436f 6c75 6d6e 286e 616d  (fits.Column(nam
+0000fd90: 653d 6622 7b66 696c 745f 7374 616e 6461  e=f"{filt_standa
+0000fda0: 7264 7d5f 4944 5f70 7366 222c 0a20 2020  rd}_ID_psf",.   
+0000fdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fdc0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0000fdd0: 6d61 743d 2735 3041 272c 0a20 2020 2020  mat='50A',.     
+0000fde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fdf0: 2020 2020 2020 2020 2020 2061 7272 6179             array
+0000fe00: 3d66 696c 745f 4944 2929 0a0a 2020 2020  =filt_ID))..    
+0000fe10: 5241 203d 2063 6174 2e6c 6f63 5b3a 2c66  RA = cat.loc[:,f
+0000fe20: 2252 415f 7b66 696c 745f 7374 616e 6461  "RA_{filt_standa
+0000fe30: 7264 7d22 5d2e 7661 6c75 6573 0a20 2020  rd}"].values.   
+0000fe40: 206e 6577 5f64 6174 612e 6170 7065 6e64   new_data.append
+0000fe50: 2866 6974 732e 436f 6c75 6d6e 286e 616d  (fits.Column(nam
+0000fe60: 653d 6622 5241 5f7b 6669 6c74 5f73 7461  e=f"RA_{filt_sta
+0000fe70: 6e64 6172 647d 222c 0a20 2020 2020 2020  ndard}",.       
+0000fe80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fe90: 2020 2020 2020 2020 2066 6f72 6d61 743d           format=
+0000fea0: 2731 4527 2c0a 2020 2020 2020 2020 2020  '1E',.          
+0000feb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fec0: 2020 2020 2020 6172 7261 793d 5241 2929        array=RA))
+0000fed0: 0a0a 2020 2020 4445 4320 3d20 6361 742e  ..    DEC = cat.
+0000fee0: 6c6f 635b 3a2c 6622 4445 435f 7b66 696c  loc[:,f"DEC_{fil
+0000fef0: 745f 7374 616e 6461 7264 7d22 5d2e 7661  t_standard}"].va
+0000ff00: 6c75 6573 0a20 2020 206e 6577 5f64 6174  lues.    new_dat
+0000ff10: 612e 6170 7065 6e64 2866 6974 732e 436f  a.append(fits.Co
+0000ff20: 6c75 6d6e 286e 616d 653d 6622 4445 435f  lumn(name=f"DEC_
+0000ff30: 7b66 696c 745f 7374 616e 6461 7264 7d22  {filt_standard}"
+0000ff40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000ff50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ff60: 2020 666f 726d 6174 3d27 3145 272c 0a20    format='1E',. 
+0000ff70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ff80: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000ff90: 7272 6179 3d44 4543 2929 0a0a 2020 2020  rray=DEC))..    
+0000ffa0: 2320 5361 7665 2063 6f72 7265 6374 6564  # Save corrected
+0000ffb0: 2064 6174 6120 746f 2073 6176 655f 6669   data to save_fi
+0000ffc0: 6c65 2066 6974 7320 6361 7461 6c6f 670a  le fits catalog.
+0000ffd0: 2020 2020 6864 7520 3d20 6669 7473 2e42      hdu = fits.B
+0000ffe0: 696e 5461 626c 6548 4455 2e66 726f 6d5f  inTableHDU.from_
+0000fff0: 636f 6c75 6d6e 7328 6e65 775f 6461 7461  columns(new_data
+00010000: 290a 2020 2020 6864 752e 7772 6974 6574  ).    hdu.writet
+00010010: 6f28 7361 7665 5f66 696c 6529 0a0a 0a64  o(save_file)...d
+00010020: 6566 2067 656e 6572 6174 655f 7068 6f74  ef generate_phot
+00010030: 5f69 6428 6361 7461 6c6f 672c 0a20 2020  _id(catalog,.   
+00010040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010050: 2020 2073 6176 655f 6669 6c65 2c0a 2020     save_file,.  
+00010060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010070: 2020 2020 6669 6c74 6572 732c 0a20 2020      filters,.   
+00010080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010090: 2020 2066 6965 6c64 203d 2027 4e6f 4669     field = 'NoFi
+000100a0: 656c 644e 616d 6527 2c0a 2020 2020 2020  eldName',.      
+000100b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000100c0: 6472 6e61 6d65 203d 2027 4e6f 4452 6e61  drname = 'NoDRna
+000100d0: 6d65 272c 0a20 2020 2020 2020 2020 2020  me',.           
+000100e0: 2020 2020 2020 2020 2020 206d 6f64 6520             mode 
+000100f0: 3d20 276e 6f4d 6f64 6527 293a 0a0a 2020  = 'noMode'):..  
+00010100: 2020 2222 220a 2020 2020 4765 6e65 7261    """.    Genera
+00010110: 7465 204d 4f44 4520 4944 2053 494e 474c  te MODE ID SINGL
+00010120: 452f 5053 4620 7068 6f74 6f6d 6574 7269  E/PSF photometri
+00010130: 6573 0a0a 2020 2020 5061 7261 6d65 7465  es..    Paramete
+00010140: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+00010150: 2d0a 2020 2020 6361 7461 6c6f 6720 3a20  -.    catalog : 
+00010160: 7374 720a 2020 2020 2020 2020 4c6f 6361  str.        Loca
+00010170: 7469 6f6e 206f 6620 5345 7874 7261 6374  tion of SExtract
+00010180: 6f72 2070 686f 746f 6d65 7472 7920 6361  or photometry ca
+00010190: 7461 6c6f 670a 2020 2020 7361 7665 5f66  talog.    save_f
+000101a0: 696c 6520 3a20 7374 720a 2020 2020 2020  ile : str.      
+000101b0: 2020 4465 7369 7265 6420 6c6f 6361 7469    Desired locati
+000101c0: 6f6e 2074 6f20 7361 7665 206e 6577 2063  on to save new c
+000101d0: 6174 616c 6f67 0a20 2020 2066 696c 7465  atalog.    filte
+000101e0: 7273 203a 2073 7472 0a20 2020 2020 2020  rs : str.       
+000101f0: 204c 6973 7420 6f66 2053 2d50 4c55 5320   List of S-PLUS 
+00010200: 6669 6c74 6572 730a 2020 2020 6669 656c  filters.    fiel
+00010210: 6420 3a20 7374 720a 2020 2020 2020 2020  d : str.        
+00010220: 4e61 6d65 206f 6620 7468 6520 6669 656c  Name of the fiel
+00010230: 6420 746f 2062 6520 6164 6465 6420 746f  d to be added to
+00010240: 2074 6865 2066 696c 7465 725f 4944 0a20   the filter_ID. 
+00010250: 2020 2064 726e 616d 6520 3a20 7374 720a     drname : str.
+00010260: 2020 2020 2020 2020 4461 7461 2072 656c          Data rel
+00010270: 6561 7365 2064 6573 6967 6e61 7469 6f6e  ease designation
+00010280: 2074 6f20 6265 2061 6464 6564 2074 6f20   to be added to 
+00010290: 7468 6520 6669 6c74 6572 5f49 440a 0a20  the filter_ID.. 
+000102a0: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
+000102b0: 2d2d 2d2d 2d2d 0a20 2020 2053 6176 6573  ------.    Saves
+000102c0: 206e 6577 2063 6174 616c 6f67 2077 6974   new catalog wit
+000102d0: 6820 6669 656c 645f 4944 2c20 5241 5f66  h field_ID, RA_f
+000102e0: 6965 6c64 5f49 442c 2044 4543 5f66 6965  ield_ID, DEC_fie
+000102f0: 6c64 5f49 440a 0a20 2020 2022 2222 0a0a  ld_ID..    """..
+00010300: 2020 2020 2320 5265 6164 2063 6174 616c      # Read catal
+00010310: 6f67 0a20 2020 2063 6174 203d 2066 6974  og.    cat = fit
+00010320: 732e 6f70 656e 2863 6174 616c 6f67 290a  s.open(catalog).
+00010330: 2020 2020 6361 745f 6461 7461 203d 2063      cat_data = c
+00010340: 6174 5b31 5d2e 6461 7461 0a0a 2020 2020  at[1].data..    
+00010350: 2320 4372 6561 7465 206e 6577 2066 6974  # Create new fit
+00010360: 7320 6361 7461 6c6f 6720 7769 7468 206e  s catalog with n
+00010370: 6577 2063 6f6c 756d 6e73 0a20 2020 206e  ew columns.    n
+00010380: 6577 5f64 6174 6120 3d20 5b5d 0a0a 2020  ew_data = []..  
+00010390: 2020 6e6c 696e 6573 203d 206c 656e 2863    nlines = len(c
+000103a0: 6174 5f64 6174 6129 0a0a 2020 2020 5048  at_data)..    PH
+000103b0: 4f54 5f49 4420 3d20 5b66 277b 6472 6e61  OT_ID = [f'{drna
+000103c0: 6d65 7d5f 7b66 6965 6c64 7d5f 7b6d 6f64  me}_{field}_{mod
+000103d0: 657d 5f7b 693a 3037 647d 270a 2020 2020  e}_{i:07d}'.    
+000103e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000103f0: 666f 7220 6920 696e 2072 616e 6765 2831  for i in range(1
+00010400: 2c6e 6c69 6e65 732b 3129 5d0a 0a20 2020  ,nlines+1)]..   
+00010410: 2050 484f 545f 4944 5f52 4120 3d20 6e70   PHOT_ID_RA = np
+00010420: 2e66 756c 6c28 6e6c 696e 6573 2c20 6e70  .full(nlines, np
+00010430: 2e6e 616e 290a 2020 2020 5048 4f54 5f49  .nan).    PHOT_I
+00010440: 445f 4445 4320 3d20 6e70 2e66 756c 6c28  D_DEC = np.full(
+00010450: 6e6c 696e 6573 2c20 6e70 2e6e 616e 290a  nlines, np.nan).
+00010460: 0a20 2020 2023 2066 696c 6c20 5241 2c20  .    # fill RA, 
+00010470: 4445 4320 6672 6f6d 2072 6564 2074 6f20  DEC from red to 
+00010480: 626c 7565 0a20 2020 2066 6f72 2066 696c  blue.    for fil
+00010490: 7420 696e 2066 696c 7465 7273 3a0a 2020  t in filters:.  
+000104a0: 2020 2020 2020 6669 6c74 5f73 7461 6e64        filt_stand
+000104b0: 6172 6420 3d20 7472 616e 736c 6174 655f  ard = translate_
+000104c0: 6669 6c74 6572 5f73 7461 6e64 6172 6428  filter_standard(
+000104d0: 6669 6c74 290a 2020 2020 2020 2020 6620  filt).        f 
+000104e0: 3d20 6e70 2e69 736e 616e 2850 484f 545f  = np.isnan(PHOT_
+000104f0: 4944 5f52 4129 0a0a 2020 2020 2020 2020  ID_RA)..        
+00010500: 7261 5f66 696c 7420 3d20 6361 745f 6461  ra_filt = cat_da
+00010510: 7461 2e63 6f6c 756d 6e73 5b66 2752 415f  ta.columns[f'RA_
+00010520: 7b66 696c 745f 7374 616e 6461 7264 7d27  {filt_standard}'
+00010530: 5d2e 6172 7261 790a 2020 2020 2020 2020  ].array.        
+00010540: 6465 635f 6669 6c74 203d 2063 6174 5f64  dec_filt = cat_d
+00010550: 6174 612e 636f 6c75 6d6e 735b 6627 4445  ata.columns[f'DE
+00010560: 435f 7b66 696c 745f 7374 616e 6461 7264  C_{filt_standard
+00010570: 7d27 5d2e 6172 7261 790a 0a20 2020 2020  }'].array..     
+00010580: 2020 2050 484f 545f 4944 5f52 415b 665d     PHOT_ID_RA[f]
+00010590: 203d 2072 615f 6669 6c74 5b66 5d0a 2020   = ra_filt[f].  
+000105a0: 2020 2020 2020 5048 4f54 5f49 445f 4445        PHOT_ID_DE
+000105b0: 435b 665d 203d 2064 6563 5f66 696c 745b  C[f] = dec_filt[
+000105c0: 665d 0a0a 2020 2020 6e65 775f 6461 7461  f]..    new_data
+000105d0: 2e61 7070 656e 6428 6669 7473 2e43 6f6c  .append(fits.Col
+000105e0: 756d 6e28 6e61 6d65 3d66 2750 484f 545f  umn(name=f'PHOT_
+000105f0: 4944 5f7b 6d6f 6465 7d27 2c0a 2020 2020  ID_{mode}',.    
+00010600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010610: 2020 2020 2020 2020 2020 2020 666f 726d              form
+00010620: 6174 3d27 3530 4127 2c0a 2020 2020 2020  at='50A',.      
+00010630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010640: 2020 2020 2020 2020 2020 6172 7261 793d            array=
+00010650: 5048 4f54 5f49 4429 290a 0a20 2020 206e  PHOT_ID))..    n
+00010660: 6577 5f64 6174 612e 6170 7065 6e64 2866  ew_data.append(f
+00010670: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
+00010680: 6627 5048 4f54 5f49 445f 5241 5f7b 6d6f  f'PHOT_ID_RA_{mo
+00010690: 6465 7d27 2c0a 2020 2020 2020 2020 2020  de}',.          
+000106a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000106b0: 2020 2020 2020 666f 726d 6174 3d27 3145        format='1E
+000106c0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000106d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000106e0: 2020 2061 7272 6179 3d50 484f 545f 4944     array=PHOT_ID
+000106f0: 5f52 4129 290a 0a20 2020 206e 6577 5f64  _RA))..    new_d
+00010700: 6174 612e 6170 7065 6e64 2866 6974 732e  ata.append(fits.
+00010710: 436f 6c75 6d6e 286e 616d 653d 6627 5048  Column(name=f'PH
+00010720: 4f54 5f49 445f 4445 435f 7b6d 6f64 657d  OT_ID_DEC_{mode}
+00010730: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00010740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010750: 2020 2066 6f72 6d61 743d 2731 4527 2c0a     format='1E',.
+00010760: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00010770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010780: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00010790: 6f72 6d61 743d 2731 4527 2c0a 2020 2020  ormat='1E',.    
-000107a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000107b0: 2020 2020 2020 2020 2020 2020 6172 7261              arra
-000107c0: 793d 5048 4f54 5f49 445f 4445 4329 290a  y=PHOT_ID_DEC)).
-000107d0: 0a20 2020 2023 2053 6176 6520 636f 7272  .    # Save corr
-000107e0: 6563 7465 6420 6461 7461 2074 6f20 7361  ected data to sa
-000107f0: 7665 5f66 696c 6520 6669 7473 2063 6174  ve_file fits cat
-00010800: 616c 6f67 0a20 2020 2068 6475 203d 2066  alog.    hdu = f
-00010810: 6974 732e 4269 6e54 6162 6c65 4844 552e  its.BinTableHDU.
-00010820: 6672 6f6d 5f63 6f6c 756d 6e73 286e 6577  from_columns(new
-00010830: 5f64 6174 6129 0a20 2020 2068 6475 2e77  _data).    hdu.w
-00010840: 7269 7465 746f 2873 6176 655f 6669 6c65  riteto(save_file
-00010850: 290a 0a0a 6465 6620 6765 6e65 7261 7465  )...def generate
-00010860: 5f66 6965 6c64 5f69 6428 6361 7461 6c6f  _field_id(catalo
-00010870: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
-00010880: 2020 2020 2020 2020 2073 6176 655f 6669           save_fi
-00010890: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
-000108a0: 2020 2020 2020 2020 2020 6669 656c 6420            field 
-000108b0: 3d20 274e 6f46 6965 6c64 4e61 6d65 272c  = 'NoFieldName',
-000108c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000108d0: 2020 2020 2020 2064 726e 616d 6520 3d20         drname = 
-000108e0: 274e 6f44 526e 616d 6527 2c0a 2020 2020  'NoDRname',.    
-000108f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010900: 2020 6d6f 6465 7320 3d20 5b22 6475 616c    modes = ["dual
-00010910: 222c 2022 7073 6622 2c20 2273 696e 676c  ", "psf", "singl
-00010920: 6522 5d29 3a0a 0a20 2020 2022 2222 0a20  e"]):..    """. 
-00010930: 2020 2047 656e 6572 6174 6520 4649 454c     Generate FIEL
-00010940: 4420 4944 2053 494e 474c 452f 5053 4620  D ID SINGLE/PSF 
-00010950: 7068 6f74 6f6d 6574 7269 6573 0a0a 2020  photometries..  
-00010960: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-00010970: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-00010980: 6361 7461 6c6f 6720 3a20 7374 720a 2020  catalog : str.  
-00010990: 2020 2020 2020 4c6f 6361 7469 6f6e 206f        Location o
-000109a0: 6620 5345 7874 7261 6374 6f72 2070 686f  f SExtractor pho
-000109b0: 746f 6d65 7472 7920 6361 7461 6c6f 670a  tometry catalog.
-000109c0: 2020 2020 7361 7665 5f66 696c 6520 3a20      save_file : 
-000109d0: 7374 720a 2020 2020 2020 2020 4465 7369  str.        Desi
-000109e0: 7265 6420 6c6f 6361 7469 6f6e 2074 6f20  red location to 
-000109f0: 7361 7665 206e 6577 2063 6174 616c 6f67  save new catalog
-00010a00: 0a20 2020 2066 6965 6c64 203a 2073 7472  .    field : str
-00010a10: 0a20 2020 2020 2020 204e 616d 6520 6f66  .        Name of
-00010a20: 2074 6865 2066 6965 6c64 2074 6f20 6265   the field to be
-00010a30: 2061 6464 6564 2074 6f20 7468 6520 6669   added to the fi
-00010a40: 6c74 6572 5f49 440a 2020 2020 6472 6e61  lter_ID.    drna
-00010a50: 6d65 203a 2073 7472 0a20 2020 2020 2020  me : str.       
-00010a60: 2044 6174 6120 7265 6c65 6173 6520 6465   Data release de
-00010a70: 7369 676e 6174 696f 6e20 746f 2062 6520  signation to be 
-00010a80: 6164 6465 6420 746f 2074 6865 2066 696c  added to the fil
-00010a90: 7465 725f 4944 0a0a 2020 2020 5265 7475  ter_ID..    Retu
-00010aa0: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00010ab0: 2020 2020 5361 7665 7320 6e65 7720 6361      Saves new ca
-00010ac0: 7461 6c6f 6720 7769 7468 2066 6965 6c64  talog with field
-00010ad0: 5f49 442c 2052 415f 6669 656c 645f 4944  _ID, RA_field_ID
-00010ae0: 2c20 4445 435f 6669 656c 645f 4944 0a0a  , DEC_field_ID..
-00010af0: 2020 2020 2222 220a 0a20 2020 2023 2052      """..    # R
-00010b00: 6561 6420 6361 7461 6c6f 670a 2020 2020  ead catalog.    
-00010b10: 6361 7420 3d20 6669 7473 2e6f 7065 6e28  cat = fits.open(
-00010b20: 6361 7461 6c6f 6729 0a20 2020 2063 6174  catalog).    cat
-00010b30: 5f64 6174 6120 3d20 6361 745b 315d 2e64  _data = cat[1].d
-00010b40: 6174 610a 0a20 2020 2023 2043 7265 6174  ata..    # Creat
-00010b50: 6520 6e65 7720 6669 7473 2063 6174 616c  e new fits catal
-00010b60: 6f67 2077 6974 6820 6e65 7720 636f 6c75  og with new colu
-00010b70: 6d6e 730a 2020 2020 6e65 775f 6461 7461  mns.    new_data
-00010b80: 203d 205b 5d0a 0a20 2020 206e 6c69 6e65   = []..    nline
-00010b90: 7320 3d20 6c65 6e28 6361 745f 6461 7461  s = len(cat_data
-00010ba0: 290a 0a20 2020 2046 4945 4c44 5f49 4420  )..    FIELD_ID 
-00010bb0: 3d20 5b66 277b 6472 6e61 6d65 7d5f 7b66  = [f'{drname}_{f
-00010bc0: 6965 6c64 7d5f 7b69 3a30 3764 7d27 0a20  ield}_{i:07d}'. 
-00010bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010be0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-00010bf0: 6528 312c 6e6c 696e 6573 2b31 295d 0a0a  e(1,nlines+1)]..
-00010c00: 2020 2020 4649 454c 445f 4944 5f52 4120      FIELD_ID_RA 
-00010c10: 3d20 6e70 2e66 756c 6c28 6e6c 696e 6573  = np.full(nlines
-00010c20: 2c20 6e70 2e6e 616e 290a 2020 2020 4649  , np.nan).    FI
-00010c30: 454c 445f 4944 5f44 4543 203d 206e 702e  ELD_ID_DEC = np.
-00010c40: 6675 6c6c 286e 6c69 6e65 732c 206e 702e  full(nlines, np.
-00010c50: 6e61 6e29 0a0a 2020 2020 2320 6669 6c6c  nan)..    # fill
-00010c60: 2052 412c 2044 4543 2066 6f6c 6c6f 7769   RA, DEC followi
-00010c70: 6e67 206d 6f64 6520 6f72 6465 7220 7072  ng mode order pr
-00010c80: 696f 7269 7479 0a20 2020 2066 6f72 206d  iority.    for m
-00010c90: 6f64 6520 696e 206d 6f64 6573 3a0a 2020  ode in modes:.  
-00010ca0: 2020 2020 2020 6620 3d20 6e70 2e69 736e        f = np.isn
-00010cb0: 616e 2846 4945 4c44 5f49 445f 5241 290a  an(FIELD_ID_RA).
-00010cc0: 0a20 2020 2020 2020 2072 615f 6d6f 6465  .        ra_mode
-00010cd0: 203d 2063 6174 5f64 6174 612e 636f 6c75   = cat_data.colu
-00010ce0: 6d6e 735b 6627 5048 4f54 5f49 445f 5241  mns[f'PHOT_ID_RA
-00010cf0: 5f7b 6d6f 6465 7d27 5d2e 6172 7261 790a  _{mode}'].array.
-00010d00: 2020 2020 2020 2020 6465 635f 6d6f 6465          dec_mode
-00010d10: 203d 2063 6174 5f64 6174 612e 636f 6c75   = cat_data.colu
-00010d20: 6d6e 735b 6627 5048 4f54 5f49 445f 4445  mns[f'PHOT_ID_DE
-00010d30: 435f 7b6d 6f64 657d 275d 2e61 7272 6179  C_{mode}'].array
-00010d40: 0a0a 2020 2020 2020 2020 4649 454c 445f  ..        FIELD_
-00010d50: 4944 5f52 415b 665d 203d 2072 615f 6d6f  ID_RA[f] = ra_mo
-00010d60: 6465 5b66 5d0a 2020 2020 2020 2020 4649  de[f].        FI
-00010d70: 454c 445f 4944 5f44 4543 5b66 5d20 3d20  ELD_ID_DEC[f] = 
-00010d80: 6465 635f 6d6f 6465 5b66 5d0a 0a20 2020  dec_mode[f]..   
-00010d90: 206e 6577 5f64 6174 612e 6170 7065 6e64   new_data.append
-00010da0: 2866 6974 732e 436f 6c75 6d6e 286e 616d  (fits.Column(nam
-00010db0: 653d 6627 4649 454c 445f 4944 272c 0a20  e=f'FIELD_ID',. 
+00010780: 6172 7261 793d 5048 4f54 5f49 445f 4445  array=PHOT_ID_DE
+00010790: 4329 290a 0a20 2020 2023 2053 6176 6520  C))..    # Save 
+000107a0: 636f 7272 6563 7465 6420 6461 7461 2074  corrected data t
+000107b0: 6f20 7361 7665 5f66 696c 6520 6669 7473  o save_file fits
+000107c0: 2063 6174 616c 6f67 0a20 2020 2068 6475   catalog.    hdu
+000107d0: 203d 2066 6974 732e 4269 6e54 6162 6c65   = fits.BinTable
+000107e0: 4844 552e 6672 6f6d 5f63 6f6c 756d 6e73  HDU.from_columns
+000107f0: 286e 6577 5f64 6174 6129 0a20 2020 2068  (new_data).    h
+00010800: 6475 2e77 7269 7465 746f 2873 6176 655f  du.writeto(save_
+00010810: 6669 6c65 290a 0a0a 6465 6620 6765 6e65  file)...def gene
+00010820: 7261 7465 5f66 6965 6c64 5f69 6428 6361  rate_field_id(ca
+00010830: 7461 6c6f 672c 0a20 2020 2020 2020 2020  talog,.         
+00010840: 2020 2020 2020 2020 2020 2020 2073 6176               sav
+00010850: 655f 6669 6c65 2c0a 2020 2020 2020 2020  e_file,.        
+00010860: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+00010870: 656c 6420 3d20 274e 6f46 6965 6c64 4e61  eld = 'NoFieldNa
+00010880: 6d65 272c 0a20 2020 2020 2020 2020 2020  me',.           
+00010890: 2020 2020 2020 2020 2020 2064 726e 616d             drnam
+000108a0: 6520 3d20 274e 6f44 526e 616d 6527 2c0a  e = 'NoDRname',.
+000108b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000108c0: 2020 2020 2020 6d6f 6465 7320 3d20 5b22        modes = ["
+000108d0: 6475 616c 222c 2022 7073 6622 2c20 2273  dual", "psf", "s
+000108e0: 696e 676c 6522 5d29 3a0a 0a20 2020 2022  ingle"]):..    "
+000108f0: 2222 0a20 2020 2047 656e 6572 6174 6520  "".    Generate 
+00010900: 4649 454c 4420 4944 2053 494e 474c 452f  FIELD ID SINGLE/
+00010910: 5053 4620 7068 6f74 6f6d 6574 7269 6573  PSF photometries
+00010920: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00010930: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+00010940: 2020 2020 6361 7461 6c6f 6720 3a20 7374      catalog : st
+00010950: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
+00010960: 6f6e 206f 6620 5345 7874 7261 6374 6f72  on of SExtractor
+00010970: 2070 686f 746f 6d65 7472 7920 6361 7461   photometry cata
+00010980: 6c6f 670a 2020 2020 7361 7665 5f66 696c  log.    save_fil
+00010990: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
+000109a0: 4465 7369 7265 6420 6c6f 6361 7469 6f6e  Desired location
+000109b0: 2074 6f20 7361 7665 206e 6577 2063 6174   to save new cat
+000109c0: 616c 6f67 0a20 2020 2066 6965 6c64 203a  alog.    field :
+000109d0: 2073 7472 0a20 2020 2020 2020 204e 616d   str.        Nam
+000109e0: 6520 6f66 2074 6865 2066 6965 6c64 2074  e of the field t
+000109f0: 6f20 6265 2061 6464 6564 2074 6f20 7468  o be added to th
+00010a00: 6520 6669 6c74 6572 5f49 440a 2020 2020  e filter_ID.    
+00010a10: 6472 6e61 6d65 203a 2073 7472 0a20 2020  drname : str.   
+00010a20: 2020 2020 2044 6174 6120 7265 6c65 6173       Data releas
+00010a30: 6520 6465 7369 676e 6174 696f 6e20 746f  e designation to
+00010a40: 2062 6520 6164 6465 6420 746f 2074 6865   be added to the
+00010a50: 2066 696c 7465 725f 4944 0a0a 2020 2020   filter_ID..    
+00010a60: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+00010a70: 2d2d 2d0a 2020 2020 5361 7665 7320 6e65  ---.    Saves ne
+00010a80: 7720 6361 7461 6c6f 6720 7769 7468 2066  w catalog with f
+00010a90: 6965 6c64 5f49 442c 2052 415f 6669 656c  ield_ID, RA_fiel
+00010aa0: 645f 4944 2c20 4445 435f 6669 656c 645f  d_ID, DEC_field_
+00010ab0: 4944 0a0a 2020 2020 2222 220a 0a20 2020  ID..    """..   
+00010ac0: 2023 2052 6561 6420 6361 7461 6c6f 670a   # Read catalog.
+00010ad0: 2020 2020 6361 7420 3d20 6669 7473 2e6f      cat = fits.o
+00010ae0: 7065 6e28 6361 7461 6c6f 6729 0a20 2020  pen(catalog).   
+00010af0: 2063 6174 5f64 6174 6120 3d20 6361 745b   cat_data = cat[
+00010b00: 315d 2e64 6174 610a 0a20 2020 2023 2043  1].data..    # C
+00010b10: 7265 6174 6520 6e65 7720 6669 7473 2063  reate new fits c
+00010b20: 6174 616c 6f67 2077 6974 6820 6e65 7720  atalog with new 
+00010b30: 636f 6c75 6d6e 730a 2020 2020 6e65 775f  columns.    new_
+00010b40: 6461 7461 203d 205b 5d0a 0a20 2020 206e  data = []..    n
+00010b50: 6c69 6e65 7320 3d20 6c65 6e28 6361 745f  lines = len(cat_
+00010b60: 6461 7461 290a 0a20 2020 2046 4945 4c44  data)..    FIELD
+00010b70: 5f49 4420 3d20 5b66 277b 6472 6e61 6d65  _ID = [f'{drname
+00010b80: 7d5f 7b66 6965 6c64 7d5f 7b69 3a30 3764  }_{field}_{i:07d
+00010b90: 7d27 0a20 2020 2020 2020 2020 2020 2020  }'.             
+00010ba0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+00010bb0: 7261 6e67 6528 312c 6e6c 696e 6573 2b31  range(1,nlines+1
+00010bc0: 295d 0a0a 2020 2020 4649 454c 445f 4944  )]..    FIELD_ID
+00010bd0: 5f52 4120 3d20 6e70 2e66 756c 6c28 6e6c  _RA = np.full(nl
+00010be0: 696e 6573 2c20 6e70 2e6e 616e 290a 2020  ines, np.nan).  
+00010bf0: 2020 4649 454c 445f 4944 5f44 4543 203d    FIELD_ID_DEC =
+00010c00: 206e 702e 6675 6c6c 286e 6c69 6e65 732c   np.full(nlines,
+00010c10: 206e 702e 6e61 6e29 0a0a 2020 2020 2320   np.nan)..    # 
+00010c20: 6669 6c6c 2052 412c 2044 4543 2066 6f6c  fill RA, DEC fol
+00010c30: 6c6f 7769 6e67 206d 6f64 6520 6f72 6465  lowing mode orde
+00010c40: 7220 7072 696f 7269 7479 0a20 2020 2066  r priority.    f
+00010c50: 6f72 206d 6f64 6520 696e 206d 6f64 6573  or mode in modes
+00010c60: 3a0a 2020 2020 2020 2020 6620 3d20 6e70  :.        f = np
+00010c70: 2e69 736e 616e 2846 4945 4c44 5f49 445f  .isnan(FIELD_ID_
+00010c80: 5241 290a 0a20 2020 2020 2020 2072 615f  RA)..        ra_
+00010c90: 6d6f 6465 203d 2063 6174 5f64 6174 612e  mode = cat_data.
+00010ca0: 636f 6c75 6d6e 735b 6627 5048 4f54 5f49  columns[f'PHOT_I
+00010cb0: 445f 5241 5f7b 6d6f 6465 7d27 5d2e 6172  D_RA_{mode}'].ar
+00010cc0: 7261 790a 2020 2020 2020 2020 6465 635f  ray.        dec_
+00010cd0: 6d6f 6465 203d 2063 6174 5f64 6174 612e  mode = cat_data.
+00010ce0: 636f 6c75 6d6e 735b 6627 5048 4f54 5f49  columns[f'PHOT_I
+00010cf0: 445f 4445 435f 7b6d 6f64 657d 275d 2e61  D_DEC_{mode}'].a
+00010d00: 7272 6179 0a0a 2020 2020 2020 2020 4649  rray..        FI
+00010d10: 454c 445f 4944 5f52 415b 665d 203d 2072  ELD_ID_RA[f] = r
+00010d20: 615f 6d6f 6465 5b66 5d0a 2020 2020 2020  a_mode[f].      
+00010d30: 2020 4649 454c 445f 4944 5f44 4543 5b66    FIELD_ID_DEC[f
+00010d40: 5d20 3d20 6465 635f 6d6f 6465 5b66 5d0a  ] = dec_mode[f].
+00010d50: 0a20 2020 206e 6577 5f64 6174 612e 6170  .    new_data.ap
+00010d60: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
+00010d70: 286e 616d 653d 6627 4649 454c 445f 4944  (name=f'FIELD_ID
+00010d80: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00010d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010da0: 2020 2066 6f72 6d61 743d 2735 3041 272c     format='50A',
+00010db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00010dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010dd0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00010de0: 6f72 6d61 743d 2735 3041 272c 0a20 2020  ormat='50A',.   
-00010df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e00: 2020 2020 2020 2020 2020 2020 2061 7272               arr
-00010e10: 6179 3d46 4945 4c44 5f49 4429 290a 0a20  ay=FIELD_ID)).. 
-00010e20: 2020 206e 6577 5f64 6174 612e 6170 7065     new_data.appe
-00010e30: 6e64 2866 6974 732e 436f 6c75 6d6e 286e  nd(fits.Column(n
-00010e40: 616d 653d 6627 4649 454c 445f 4944 5f52  ame=f'FIELD_ID_R
-00010e50: 4127 2c0a 2020 2020 2020 2020 2020 2020  A',.            
-00010e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e70: 2020 2020 666f 726d 6174 3d27 3145 272c      format='1E',
-00010e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ea0: 2061 7272 6179 3d46 4945 4c44 5f49 445f   array=FIELD_ID_
-00010eb0: 5241 2929 0a0a 2020 2020 6e65 775f 6461  RA))..    new_da
-00010ec0: 7461 2e61 7070 656e 6428 6669 7473 2e43  ta.append(fits.C
-00010ed0: 6f6c 756d 6e28 6e61 6d65 3d66 2746 4945  olumn(name=f'FIE
-00010ee0: 4c44 5f49 445f 4445 4327 2c0a 2020 2020  LD_ID_DEC',.    
-00010ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f00: 2020 2020 2020 2020 2020 2020 666f 726d              form
-00010f10: 6174 3d27 3145 272c 0a20 2020 2020 2020  at='1E',.       
-00010f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f30: 2020 2020 2020 2020 2061 7272 6179 3d46           array=F
-00010f40: 4945 4c44 5f49 445f 4445 4329 290a 0a20  IELD_ID_DEC)).. 
-00010f50: 2020 2066 6f72 206d 6f64 6520 696e 206d     for mode in m
-00010f60: 6f64 6573 3a0a 2020 2020 2020 2020 6e65  odes:.        ne
-00010f70: 775f 6461 7461 2e61 7070 656e 6428 6361  w_data.append(ca
-00010f80: 745f 6461 7461 2e63 6f6c 756d 6e73 5b66  t_data.columns[f
-00010f90: 2750 484f 545f 4944 5f7b 6d6f 6465 7d27  'PHOT_ID_{mode}'
-00010fa0: 5d29 0a20 2020 2020 2020 206e 6577 5f64  ]).        new_d
-00010fb0: 6174 612e 6170 7065 6e64 2863 6174 5f64  ata.append(cat_d
-00010fc0: 6174 612e 636f 6c75 6d6e 735b 6627 5048  ata.columns[f'PH
-00010fd0: 4f54 5f49 445f 5241 5f7b 6d6f 6465 7d27  OT_ID_RA_{mode}'
-00010fe0: 5d29 0a20 2020 2020 2020 206e 6577 5f64  ]).        new_d
-00010ff0: 6174 612e 6170 7065 6e64 2863 6174 5f64  ata.append(cat_d
-00011000: 6174 612e 636f 6c75 6d6e 735b 6627 5048  ata.columns[f'PH
-00011010: 4f54 5f49 445f 4445 435f 7b6d 6f64 657d  OT_ID_DEC_{mode}
-00011020: 275d 290a 0a20 2020 2023 2053 6176 6520  '])..    # Save 
-00011030: 636f 7272 6563 7465 6420 6461 7461 2074  corrected data t
-00011040: 6f20 7361 7665 5f66 696c 6520 6669 7473  o save_file fits
-00011050: 2063 6174 616c 6f67 0a20 2020 2068 6475   catalog.    hdu
-00011060: 203d 2066 6974 732e 4269 6e54 6162 6c65   = fits.BinTable
-00011070: 4844 552e 6672 6f6d 5f63 6f6c 756d 6e73  HDU.from_columns
-00011080: 286e 6577 5f64 6174 6129 0a20 2020 2068  (new_data).    h
-00011090: 6475 2e77 7269 7465 746f 2873 6176 655f  du.writeto(save_
-000110a0: 6669 6c65 290a 0a64 6566 2067 656e 6572  file)..def gener
-000110b0: 6174 655f 6475 616c 5f6d 6f64 655f 7068  ate_dual_mode_ph
-000110c0: 6f74 5f69 6428 6361 7461 6c6f 672c 0a20  ot_id(catalog,. 
-000110d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110e0: 2020 2020 2020 2020 2020 2020 2020 7361                sa
-000110f0: 7665 5f66 696c 652c 0a20 2020 2020 2020  ve_file,.       
+00010dd0: 2061 7272 6179 3d46 4945 4c44 5f49 4429   array=FIELD_ID)
+00010de0: 290a 0a20 2020 206e 6577 5f64 6174 612e  )..    new_data.
+00010df0: 6170 7065 6e64 2866 6974 732e 436f 6c75  append(fits.Colu
+00010e00: 6d6e 286e 616d 653d 6627 4649 454c 445f  mn(name=f'FIELD_
+00010e10: 4944 5f52 4127 2c0a 2020 2020 2020 2020  ID_RA',.        
+00010e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e30: 2020 2020 2020 2020 666f 726d 6174 3d27          format='
+00010e40: 3145 272c 0a20 2020 2020 2020 2020 2020  1E',.           
+00010e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e60: 2020 2020 2061 7272 6179 3d46 4945 4c44       array=FIELD
+00010e70: 5f49 445f 5241 2929 0a0a 2020 2020 6e65  _ID_RA))..    ne
+00010e80: 775f 6461 7461 2e61 7070 656e 6428 6669  w_data.append(fi
+00010e90: 7473 2e43 6f6c 756d 6e28 6e61 6d65 3d66  ts.Column(name=f
+00010ea0: 2746 4945 4c44 5f49 445f 4445 4327 2c0a  'FIELD_ID_DEC',.
+00010eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ed0: 666f 726d 6174 3d27 3145 272c 0a20 2020  format='1E',.   
+00010ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ef0: 2020 2020 2020 2020 2020 2020 2061 7272               arr
+00010f00: 6179 3d46 4945 4c44 5f49 445f 4445 4329  ay=FIELD_ID_DEC)
+00010f10: 290a 0a20 2020 2066 6f72 206d 6f64 6520  )..    for mode 
+00010f20: 696e 206d 6f64 6573 3a0a 2020 2020 2020  in modes:.      
+00010f30: 2020 6e65 775f 6461 7461 2e61 7070 656e    new_data.appen
+00010f40: 6428 6361 745f 6461 7461 2e63 6f6c 756d  d(cat_data.colum
+00010f50: 6e73 5b66 2750 484f 545f 4944 5f7b 6d6f  ns[f'PHOT_ID_{mo
+00010f60: 6465 7d27 5d29 0a20 2020 2020 2020 206e  de}']).        n
+00010f70: 6577 5f64 6174 612e 6170 7065 6e64 2863  ew_data.append(c
+00010f80: 6174 5f64 6174 612e 636f 6c75 6d6e 735b  at_data.columns[
+00010f90: 6627 5048 4f54 5f49 445f 5241 5f7b 6d6f  f'PHOT_ID_RA_{mo
+00010fa0: 6465 7d27 5d29 0a20 2020 2020 2020 206e  de}']).        n
+00010fb0: 6577 5f64 6174 612e 6170 7065 6e64 2863  ew_data.append(c
+00010fc0: 6174 5f64 6174 612e 636f 6c75 6d6e 735b  at_data.columns[
+00010fd0: 6627 5048 4f54 5f49 445f 4445 435f 7b6d  f'PHOT_ID_DEC_{m
+00010fe0: 6f64 657d 275d 290a 0a20 2020 2023 2053  ode}'])..    # S
+00010ff0: 6176 6520 636f 7272 6563 7465 6420 6461  ave corrected da
+00011000: 7461 2074 6f20 7361 7665 5f66 696c 6520  ta to save_file 
+00011010: 6669 7473 2063 6174 616c 6f67 0a20 2020  fits catalog.   
+00011020: 2068 6475 203d 2066 6974 732e 4269 6e54   hdu = fits.BinT
+00011030: 6162 6c65 4844 552e 6672 6f6d 5f63 6f6c  ableHDU.from_col
+00011040: 756d 6e73 286e 6577 5f64 6174 6129 0a20  umns(new_data). 
+00011050: 2020 2068 6475 2e77 7269 7465 746f 2873     hdu.writeto(s
+00011060: 6176 655f 6669 6c65 290a 0a64 6566 2067  ave_file)..def g
+00011070: 656e 6572 6174 655f 6475 616c 5f6d 6f64  enerate_dual_mod
+00011080: 655f 7068 6f74 5f69 6428 6361 7461 6c6f  e_phot_id(catalo
+00011090: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
+000110a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110b0: 2020 7361 7665 5f66 696c 652c 0a20 2020    save_file,.   
+000110c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110d0: 2020 2020 2020 2020 2020 2020 6669 656c              fiel
+000110e0: 6420 3d20 274e 6f46 6965 6c64 4e61 6d65  d = 'NoFieldName
+000110f0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
 00011100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011110: 2020 2020 2020 2020 6669 656c 6420 3d20          field = 
-00011120: 274e 6f46 6965 6c64 4e61 6d65 272c 0a20  'NoFieldName',. 
-00011130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011140: 2020 2020 2020 2020 2020 2020 2020 6472                dr
-00011150: 6e61 6d65 203d 2027 4e6f 4452 6e61 6d65  name = 'NoDRname
-00011160: 2729 3a0a 0a20 2020 2022 2222 0a20 2020  '):..    """.   
-00011170: 2041 7373 6967 6e73 2064 6574 6563 7469   Assigns detecti
-00011180: 6f6e 2049 4420 746f 2053 4578 7472 6163  on ID to SExtrac
-00011190: 746f 7220 7068 6f74 6f6d 6574 7279 2028  tor photometry (
-000111a0: 696e 2073 696e 676c 6520 6d6f 6465 292e  in single mode).
-000111b0: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
-000111c0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-000111d0: 2020 2020 6361 7461 6c6f 6720 3a20 7374      catalog : st
-000111e0: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
-000111f0: 6f6e 206f 6620 5345 7874 7261 6374 6f72  on of SExtractor
-00011200: 2070 686f 746f 6d65 7472 7920 6361 7461   photometry cata
-00011210: 6c6f 670a 2020 2020 7361 7665 5f66 696c  log.    save_fil
-00011220: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
-00011230: 4465 7369 7265 6420 6c6f 6361 7469 6f6e  Desired location
-00011240: 2074 6f20 7361 7665 206e 6577 2063 6174   to save new cat
-00011250: 616c 6f67 0a20 2020 2066 6965 6c64 203a  alog.    field :
-00011260: 2073 7472 0a20 2020 2020 2020 204e 616d   str.        Nam
-00011270: 6520 6f66 2074 6865 2066 6965 6c64 2074  e of the field t
-00011280: 6f20 6265 2061 6464 6564 2074 6f20 7468  o be added to th
-00011290: 6520 6669 6c74 6572 5f49 440a 2020 2020  e filter_ID.    
-000112a0: 6472 6e61 6d65 203a 2073 7472 0a20 2020  drname : str.   
-000112b0: 2020 2020 2044 6174 6120 7265 6c65 6173       Data releas
-000112c0: 6520 6465 7369 676e 6174 696f 6e20 746f  e designation to
-000112d0: 2062 6520 6164 6465 6420 746f 2074 6865   be added to the
-000112e0: 2066 696c 7465 725f 4944 0a0a 2020 2020   filter_ID..    
-000112f0: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
-00011300: 2d2d 2d0a 2020 2020 5361 7665 7320 6e65  ---.    Saves ne
-00011310: 7720 6361 7461 6c6f 6720 7769 7468 2066  w catalog with f
-00011320: 696c 7465 725f 4944 0a0a 2020 2020 2222  ilter_ID..    ""
-00011330: 220a 0a20 2020 2023 2052 6561 6420 6361  "..    # Read ca
-00011340: 7461 6c6f 670a 2020 2020 6361 7420 3d20  talog.    cat = 
-00011350: 6669 7473 2e6f 7065 6e28 6361 7461 6c6f  fits.open(catalo
-00011360: 6729 0a20 2020 2063 6174 5f64 6174 6120  g).    cat_data 
-00011370: 3d20 6361 745b 315d 2e64 6174 610a 0a20  = cat[1].data.. 
-00011380: 2020 2023 2043 7265 6174 6520 6e65 7720     # Create new 
-00011390: 6669 7473 2063 6174 616c 6f67 2077 6974  fits catalog wit
-000113a0: 6820 6e65 7720 636f 6c75 6d6e 730a 2020  h new columns.  
-000113b0: 2020 6e65 775f 6461 7461 203d 205b 5d0a    new_data = [].
-000113c0: 0a20 2020 2063 6f6c 5f52 4120 3d20 6361  .    col_RA = ca
-000113d0: 745f 6461 7461 2e63 6f6c 756d 6e73 5b22  t_data.columns["
-000113e0: 414c 5048 415f 4a32 3030 3022 5d0a 2020  ALPHA_J2000"].  
-000113f0: 2020 636f 6c5f 5241 2e6e 616d 6520 3d20    col_RA.name = 
-00011400: 2250 484f 545f 4944 5f52 415f 6475 616c  "PHOT_ID_RA_dual
-00011410: 220a 0a20 2020 2063 6f6c 5f44 4543 203d  "..    col_DEC =
-00011420: 2063 6174 5f64 6174 612e 636f 6c75 6d6e   cat_data.column
-00011430: 735b 2244 454c 5441 5f4a 3230 3030 225d  s["DELTA_J2000"]
-00011440: 0a20 2020 2063 6f6c 5f44 4543 2e6e 616d  .    col_DEC.nam
-00011450: 6520 3d20 2250 484f 545f 4944 5f44 4543  e = "PHOT_ID_DEC
-00011460: 5f64 7561 6c22 0a0a 2020 2020 6e65 775f  _dual"..    new_
-00011470: 6461 7461 2e61 7070 656e 6428 636f 6c5f  data.append(col_
-00011480: 5241 290a 2020 2020 6e65 775f 6461 7461  RA).    new_data
-00011490: 2e61 7070 656e 6428 636f 6c5f 4445 4329  .append(col_DEC)
-000114a0: 0a0a 2020 2020 2320 4173 7369 676e 2066  ..    # Assign f
-000114b0: 696c 7465 7220 4944 730a 2020 2020 7365  ilter IDs.    se
-000114c0: 785f 6669 6c74 6572 5f6e 756d 6265 7220  x_filter_number 
-000114d0: 3d20 6361 745f 6461 7461 2e63 6f6c 756d  = cat_data.colum
-000114e0: 6e73 5b27 4e55 4d42 4552 275d 2e61 7272  ns['NUMBER'].arr
-000114f0: 6179 0a0a 2020 2020 5048 4f54 5f49 4420  ay..    PHOT_ID 
-00011500: 3d20 5b66 277b 6472 6e61 6d65 7d5f 7b66  = [f'{drname}_{f
-00011510: 6965 6c64 7d5f 6475 616c 5f7b 693a 3037  ield}_dual_{i:07
-00011520: 647d 270a 2020 2020 2020 2020 2020 2020  d}'.            
-00011530: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
-00011540: 2073 6578 5f66 696c 7465 725f 6e75 6d62   sex_filter_numb
-00011550: 6572 5d0a 0a20 2020 206e 6577 5f64 6174  er]..    new_dat
-00011560: 612e 6170 7065 6e64 2866 6974 732e 436f  a.append(fits.Co
-00011570: 6c75 6d6e 286e 616d 653d 6627 5048 4f54  lumn(name=f'PHOT
-00011580: 5f49 445f 6475 616c 272c 0a20 2020 2020  _ID_dual',.     
-00011590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115a0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
-000115b0: 743d 2735 3041 272c 0a20 2020 2020 2020  t='50A',.       
-000115c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115d0: 2020 2020 2020 2020 2061 7272 6179 3d50           array=P
-000115e0: 484f 545f 4944 2929 0a0a 2020 2020 2320  HOT_ID))..    # 
-000115f0: 5361 7665 2063 6f72 7265 6374 6564 2064  Save corrected d
-00011600: 6174 6120 746f 2073 6176 655f 6669 6c65  ata to save_file
-00011610: 2066 6974 7320 6361 7461 6c6f 670a 2020   fits catalog.  
-00011620: 2020 6864 7520 3d20 6669 7473 2e42 696e    hdu = fits.Bin
-00011630: 5461 626c 6548 4455 2e66 726f 6d5f 636f  TableHDU.from_co
-00011640: 6c75 6d6e 7328 6e65 775f 6461 7461 290a  lumns(new_data).
-00011650: 2020 2020 6864 752e 7772 6974 6574 6f28      hdu.writeto(
-00011660: 7361 7665 5f66 696c 6529 0a0a 2323 2323  save_file)..####
+00011110: 2020 6472 6e61 6d65 203d 2027 4e6f 4452    drname = 'NoDR
+00011120: 6e61 6d65 2729 3a0a 0a20 2020 2022 2222  name'):..    """
+00011130: 0a20 2020 2041 7373 6967 6e73 2064 6574  .    Assigns det
+00011140: 6563 7469 6f6e 2049 4420 746f 2053 4578  ection ID to SEx
+00011150: 7472 6163 746f 7220 7068 6f74 6f6d 6574  tractor photomet
+00011160: 7279 2028 696e 2073 696e 676c 6520 6d6f  ry (in single mo
+00011170: 6465 292e 0a0a 2020 2020 5061 7261 6d65  de)...    Parame
+00011180: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+00011190: 2d2d 2d0a 2020 2020 6361 7461 6c6f 6720  ---.    catalog 
+000111a0: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
+000111b0: 6361 7469 6f6e 206f 6620 5345 7874 7261  cation of SExtra
+000111c0: 6374 6f72 2070 686f 746f 6d65 7472 7920  ctor photometry 
+000111d0: 6361 7461 6c6f 670a 2020 2020 7361 7665  catalog.    save
+000111e0: 5f66 696c 6520 3a20 7374 720a 2020 2020  _file : str.    
+000111f0: 2020 2020 4465 7369 7265 6420 6c6f 6361      Desired loca
+00011200: 7469 6f6e 2074 6f20 7361 7665 206e 6577  tion to save new
+00011210: 2063 6174 616c 6f67 0a20 2020 2066 6965   catalog.    fie
+00011220: 6c64 203a 2073 7472 0a20 2020 2020 2020  ld : str.       
+00011230: 204e 616d 6520 6f66 2074 6865 2066 6965   Name of the fie
+00011240: 6c64 2074 6f20 6265 2061 6464 6564 2074  ld to be added t
+00011250: 6f20 7468 6520 6669 6c74 6572 5f49 440a  o the filter_ID.
+00011260: 2020 2020 6472 6e61 6d65 203a 2073 7472      drname : str
+00011270: 0a20 2020 2020 2020 2044 6174 6120 7265  .        Data re
+00011280: 6c65 6173 6520 6465 7369 676e 6174 696f  lease designatio
+00011290: 6e20 746f 2062 6520 6164 6465 6420 746f  n to be added to
+000112a0: 2074 6865 2066 696c 7465 725f 4944 0a0a   the filter_ID..
+000112b0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+000112c0: 2d2d 2d2d 2d2d 2d0a 2020 2020 5361 7665  -------.    Save
+000112d0: 7320 6e65 7720 6361 7461 6c6f 6720 7769  s new catalog wi
+000112e0: 7468 2066 696c 7465 725f 4944 0a0a 2020  th filter_ID..  
+000112f0: 2020 2222 220a 0a20 2020 2023 2052 6561    """..    # Rea
+00011300: 6420 6361 7461 6c6f 670a 2020 2020 6361  d catalog.    ca
+00011310: 7420 3d20 6669 7473 2e6f 7065 6e28 6361  t = fits.open(ca
+00011320: 7461 6c6f 6729 0a20 2020 2063 6174 5f64  talog).    cat_d
+00011330: 6174 6120 3d20 6361 745b 315d 2e64 6174  ata = cat[1].dat
+00011340: 610a 0a20 2020 2023 2043 7265 6174 6520  a..    # Create 
+00011350: 6e65 7720 6669 7473 2063 6174 616c 6f67  new fits catalog
+00011360: 2077 6974 6820 6e65 7720 636f 6c75 6d6e   with new column
+00011370: 730a 2020 2020 6e65 775f 6461 7461 203d  s.    new_data =
+00011380: 205b 5d0a 0a20 2020 2063 6f6c 5f52 4120   []..    col_RA 
+00011390: 3d20 6361 745f 6461 7461 2e63 6f6c 756d  = cat_data.colum
+000113a0: 6e73 5b22 414c 5048 415f 4a32 3030 3022  ns["ALPHA_J2000"
+000113b0: 5d0a 2020 2020 636f 6c5f 5241 2e6e 616d  ].    col_RA.nam
+000113c0: 6520 3d20 2250 484f 545f 4944 5f52 415f  e = "PHOT_ID_RA_
+000113d0: 6475 616c 220a 0a20 2020 2063 6f6c 5f44  dual"..    col_D
+000113e0: 4543 203d 2063 6174 5f64 6174 612e 636f  EC = cat_data.co
+000113f0: 6c75 6d6e 735b 2244 454c 5441 5f4a 3230  lumns["DELTA_J20
+00011400: 3030 225d 0a20 2020 2063 6f6c 5f44 4543  00"].    col_DEC
+00011410: 2e6e 616d 6520 3d20 2250 484f 545f 4944  .name = "PHOT_ID
+00011420: 5f44 4543 5f64 7561 6c22 0a0a 2020 2020  _DEC_dual"..    
+00011430: 6e65 775f 6461 7461 2e61 7070 656e 6428  new_data.append(
+00011440: 636f 6c5f 5241 290a 2020 2020 6e65 775f  col_RA).    new_
+00011450: 6461 7461 2e61 7070 656e 6428 636f 6c5f  data.append(col_
+00011460: 4445 4329 0a0a 2020 2020 2320 4173 7369  DEC)..    # Assi
+00011470: 676e 2066 696c 7465 7220 4944 730a 2020  gn filter IDs.  
+00011480: 2020 7365 785f 6669 6c74 6572 5f6e 756d    sex_filter_num
+00011490: 6265 7220 3d20 6361 745f 6461 7461 2e63  ber = cat_data.c
+000114a0: 6f6c 756d 6e73 5b27 4e55 4d42 4552 275d  olumns['NUMBER']
+000114b0: 2e61 7272 6179 0a0a 2020 2020 5048 4f54  .array..    PHOT
+000114c0: 5f49 4420 3d20 5b66 277b 6472 6e61 6d65  _ID = [f'{drname
+000114d0: 7d5f 7b66 6965 6c64 7d5f 6475 616c 5f7b  }_{field}_dual_{
+000114e0: 693a 3037 647d 270a 2020 2020 2020 2020  i:07d}'.        
+000114f0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00011500: 6920 696e 2073 6578 5f66 696c 7465 725f  i in sex_filter_
+00011510: 6e75 6d62 6572 5d0a 0a20 2020 206e 6577  number]..    new
+00011520: 5f64 6174 612e 6170 7065 6e64 2866 6974  _data.append(fit
+00011530: 732e 436f 6c75 6d6e 286e 616d 653d 6627  s.Column(name=f'
+00011540: 5048 4f54 5f49 445f 6475 616c 272c 0a20  PHOT_ID_dual',. 
+00011550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011560: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00011570: 6f72 6d61 743d 2735 3041 272c 0a20 2020  ormat='50A',.   
+00011580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011590: 2020 2020 2020 2020 2020 2020 2061 7272               arr
+000115a0: 6179 3d50 484f 545f 4944 2929 0a0a 2020  ay=PHOT_ID))..  
+000115b0: 2020 2320 5361 7665 2063 6f72 7265 6374    # Save correct
+000115c0: 6564 2064 6174 6120 746f 2073 6176 655f  ed data to save_
+000115d0: 6669 6c65 2066 6974 7320 6361 7461 6c6f  file fits catalo
+000115e0: 670a 2020 2020 6864 7520 3d20 6669 7473  g.    hdu = fits
+000115f0: 2e42 696e 5461 626c 6548 4455 2e66 726f  .BinTableHDU.fro
+00011600: 6d5f 636f 6c75 6d6e 7328 6e65 775f 6461  m_columns(new_da
+00011610: 7461 290a 2020 2020 6864 752e 7772 6974  ta).    hdu.writ
+00011620: 6574 6f28 7361 7665 5f66 696c 6529 0a0a  eto(save_file)..
+00011630: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00011640: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00011650: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00011660: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00011670: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011680: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011690: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000116a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000116b0: 2323 2323 2323 2323 2323 2323 0a23 2041  ############.# A
-000116c0: 7065 7274 7572 6520 636f 7272 6563 7469  perture correcti
-000116d0: 6f6e 0a0a 2320 4170 6572 7475 7265 2050  on..# Aperture P
-000116e0: 686f 746f 6d65 7472 7920 4675 6e63 7469  hotometry Functi
-000116f0: 6f6e 7320 666f 7220 7468 6520 532d 504c  ons for the S-PL
-00011700: 5553 2043 6f6c 6c61 626f 7261 7469 6f6e  US Collaboration
-00011710: 0a23 2041 7574 686f 723a 2041 6e64 72c3  .# Author: Andr.
-00011720: a920 5a61 6d6f 7261 6e6f 2056 6974 6f72  . Zamorano Vitor
-00011730: 656c 6c69 202d 2061 6e64 7265 7a76 6974  elli - andrezvit
-00011740: 6f72 656c 6c69 4067 6d61 696c 2e63 6f6d  orelli@gmail.com
-00011750: 0a23 2032 3032 302d 3037 2d30 370a 2320  .# 2020-07-07.# 
-00011760: 2222 220a 230a 2320 4564 6974 696f 6e73  """.#.# Editions
-00011770: 3a20 4665 6c69 7065 2041 6c6d 6569 6461  : Felipe Almeida
-00011780: 2d46 6572 6e61 6e64 6573 202d 2066 656c  -Fernandes - fel
-00011790: 6970 6566 6572 3432 4067 6d61 696c 2e63  ipefer42@gmail.c
-000117a0: 6f6d 0a23 2032 3032 312d 3035 2d32 360a  om.# 2021-05-26.
-000117b0: 2320 5f5f 6c69 6365 6e73 655f 5f20 3d20  # __license__ = 
-000117c0: 2247 504c 220a 2320 5f5f 7665 7273 696f  "GPL".# __versio
-000117d0: 6e5f 5f20 3d20 2230 2e31 220a 0a64 6566  n__ = "0.1"..def
-000117e0: 2067 6574 5f61 7065 7274 7572 6573 5f66   get_apertures_f
-000117f0: 726f 6d5f 7365 7863 6f6e 6628 7365 7863  rom_sexconf(sexc
-00011800: 6f6e 6629 3a0a 2020 2020 2222 220a 2020  onf):.    """.  
-00011810: 2020 5265 6164 7320 7468 6520 5048 4f54    Reads the PHOT
-00011820: 5f41 5045 5254 5552 4553 2070 6172 616d  _APERTURES param
-00011830: 6574 6572 2069 6e20 7468 6520 7365 7863  eter in the sexc
-00011840: 6f6e 6620 6669 6c65 0a0a 2020 2020 5061  onf file..    Pa
-00011850: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-00011860: 2d2d 2d2d 2d2d 2d0a 2020 2020 7365 7863  -------.    sexc
-00011870: 6f6e 6620 3a20 7374 720a 2020 2020 2020  onf : str.      
-00011880: 2020 4c6f 6361 7469 6f6e 206f 6620 7365    Location of se
-00011890: 7863 6f6e 6620 6669 6c65 0a0a 2020 2020  xconf file..    
-000118a0: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
-000118b0: 2d2d 2d0a 2020 2020 6e70 2e6e 6461 7272  ---.    np.ndarr
-000118c0: 6179 0a20 2020 2020 2020 206c 6973 7420  ay.        list 
-000118d0: 6f66 2061 7065 7274 7572 6573 0a20 2020  of apertures.   
-000118e0: 2022 2222 0a0a 2020 2020 7769 7468 206f   """..    with o
-000118f0: 7065 6e28 7365 7863 6f6e 6629 2061 7320  pen(sexconf) as 
-00011900: 663a 0a20 2020 2020 2020 206c 696e 6573  f:.        lines
-00011910: 203d 2066 2e72 6561 646c 696e 6573 2829   = f.readlines()
-00011920: 0a0a 2020 2020 666f 7220 6c69 6e65 2069  ..    for line i
-00011930: 6e20 6c69 6e65 733a 0a20 2020 2020 2020  n lines:.       
-00011940: 2023 2072 656d 6f76 6520 636f 6d6d 656e   # remove commen
-00011950: 7420 6672 6f6d 206c 696e 650a 2020 2020  t from line.    
-00011960: 2020 2020 6c69 6e65 203d 206c 696e 652e      line = line.
-00011970: 7370 6c69 7428 2223 2229 5b30 5d0a 0a20  split("#")[0].. 
-00011980: 2020 2020 2020 2023 2047 6574 2070 6172         # Get par
-00011990: 616d 206e 616d 650a 2020 2020 2020 2020  am name.        
-000119a0: 7061 7261 6d20 3d20 6c69 6e65 2e73 706c  param = line.spl
-000119b0: 6974 2829 5b30 5d0a 0a20 2020 2020 2020  it()[0]..       
-000119c0: 2023 2049 6620 7061 7261 6d20 6973 2022   # If param is "
-000119d0: 5048 4f54 5f41 5045 5254 5552 4553 222c  PHOT_APERTURES",
-000119e0: 2072 6574 7572 6e20 6c69 7374 206f 6620   return list of 
-000119f0: 7661 6c75 6573 0a20 2020 2020 2020 2069  values.        i
-00011a00: 6620 7061 7261 6d20 3d3d 2022 5048 4f54  f param == "PHOT
-00011a10: 5f41 5045 5254 5552 4553 223a 0a20 2020  _APERTURES":.   
-00011a20: 2020 2020 2020 2020 2076 616c 7565 203d           value =
-00011a30: 2022 222e 6a6f 696e 286c 696e 652e 7370   "".join(line.sp
-00011a40: 6c69 7428 295b 313a 5d29 0a20 2020 2020  lit()[1:]).     
-00011a50: 2020 2020 2020 2076 616c 7565 203d 206e         value = n
-00011a60: 702e 6172 7261 7928 7661 6c75 652e 7370  p.array(value.sp
-00011a70: 6c69 7428 222c 2229 2c20 6474 7970 6520  lit(","), dtype 
-00011a80: 3d20 666c 6f61 7429 0a0a 2020 2020 2020  = float)..      
-00011a90: 2020 2020 2020 7265 7475 726e 2076 616c        return val
-00011aa0: 7565 0a0a 2020 2020 2320 4966 2070 6172  ue..    # If par
-00011ab0: 616d 2022 5048 4f54 5f41 5045 5254 5552  am "PHOT_APERTUR
-00011ac0: 4553 2220 6973 206e 6f74 2066 6f75 6e64  ES" is not found
-00011ad0: 0a20 2020 2072 6574 7572 6e20 4e6f 6e65  .    return None
-00011ae0: 0a0a 0a64 6566 206f 6274 6169 6e5f 6170  ...def obtain_ap
-00011af0: 6572 7475 7265 5f63 6f72 7265 6374 696f  erture_correctio
-00011b00: 6e28 6361 7461 6c6f 672c 2066 696c 742c  n(catalog, filt,
-00011b10: 2073 6578 636f 6e66 2c20 7361 7665 5f66   sexconf, save_f
-00011b20: 696c 652c 2061 7065 7274 7572 652c 0a20  ile, aperture,. 
-00011b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011b40: 2020 2020 2020 2020 2020 2020 2020 7332                s2
-00011b50: 6e63 7574 2c20 7374 6172 6375 742c 206d  ncut, starcut, m
-00011b60: 6178 5f61 7065 7274 7572 6520 3d20 3732  ax_aperture = 72
-00011b70: 2e37 3237 3237 2c0a 2020 2020 2020 2020  .72727,.        
-00011b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011b90: 2020 2020 2020 206d 6167 5f70 6172 7469         mag_parti
-00011ba0: 7469 6f6e 203d 2032 2c20 636f 6e76 6572  tion = 2, conver
-00011bb0: 6765 6e63 655f 736c 6f70 6520 3d20 3165  gence_slope = 1e
-00011bc0: 2d32 2c0a 2020 2020 2020 2020 2020 2020  -2,.            
-00011bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011be0: 2020 2063 6865 636b 5f63 6f6e 7665 7267     check_converg
-00011bf0: 656e 6365 203d 2054 7275 652c 2076 6572  ence = True, ver
-00011c00: 626f 7365 203d 2046 616c 7365 293a 0a20  bose = False):. 
-00011c10: 2020 2022 2222 0a20 2020 2043 616c 6375     """.    Calcu
-00011c20: 6c61 7465 7320 7468 6520 6170 6572 7475  lates the apertu
-00011c30: 7265 2063 6f72 7265 6374 696f 6e20 6672  re correction fr
-00011c40: 6f6d 2061 2063 6572 7461 696e 2022 6170  om a certain "ap
-00011c50: 6572 7475 7265 2220 746f 2074 6865 2061  erture" to the a
-00011c60: 6e6f 7468 6572 0a20 2020 2061 7065 7274  nother.    apert
-00011c70: 7572 6520 226d 6178 5f61 7065 7274 7572  ure "max_apertur
-00011c80: 6522 2028 7768 6963 6820 6d75 7374 2062  e" (which must b
-00011c90: 6520 6269 6720 656e 6f75 6768 7420 746f  e big enought to
-00011ca0: 2072 6570 7265 7365 6e74 2074 6865 0a20   represent the. 
-00011cb0: 2020 2074 6f74 616c 2065 6d69 7373 696f     total emissio
-00011cc0: 6e20 6f66 2074 6865 2073 6f75 7263 6529  n of the source)
-00011cd0: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
-00011ce0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-00011cf0: 2020 2020 6361 7461 6c6f 6720 3a20 7374      catalog : st
-00011d00: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
-00011d10: 6f6e 206f 6620 5345 7874 7261 6374 6f72  on of SExtractor
-00011d20: 206f 7574 7075 7420 6361 7461 6c6f 6720   output catalog 
-00011d30: 7769 7468 2074 6865 206d 6561 7375 7265  with the measure
-00011d40: 6420 6669 7865 6420 6170 6572 7475 7265  d fixed aperture
-00011d50: 730a 2020 2020 6669 6c74 203a 2073 7472  s.    filt : str
-00011d60: 0a20 2020 2020 2020 204e 616d 6520 6f66  .        Name of
-00011d70: 2074 6865 2066 696c 7465 720a 2020 2020   the filter.    
-00011d80: 7365 7863 6f6e 6620 3a20 7374 720a 2020  sexconf : str.  
-00011d90: 2020 2020 2020 4c6f 6361 7469 6f6e 206f        Location o
-00011da0: 6620 7365 7863 6f6e 6669 6720 6669 6c65  f sexconfig file
-00011db0: 2066 6f72 2074 6869 7320 6669 6c74 6572   for this filter
-00011dc0: 2773 2070 686f 746f 6d65 7472 790a 2020  's photometry.  
-00011dd0: 2020 7361 7665 5f66 696c 6520 3a20 7374    save_file : st
-00011de0: 720a 2020 2020 2020 2020 4465 7369 7265  r.        Desire
-00011df0: 6420 6c6f 6361 7469 6f6e 2074 6f20 7361  d location to sa
-00011e00: 7665 2063 616c 6375 6c61 7465 6420 6170  ve calculated ap
-00011e10: 6572 7475 7265 2063 6f72 7265 6374 696f  erture correctio
-00011e20: 6e73 0a20 2020 2061 7065 7274 7572 6520  ns.    aperture 
-00011e30: 3a20 666c 6f61 740a 2020 2020 2020 2020  : float.        
-00011e40: 4261 7365 2061 7065 7274 7572 6520 7768  Base aperture wh
-00011e50: 6963 6820 7769 6c6c 2068 6176 6520 7468  ich will have th
-00011e60: 6520 636f 7272 6563 7469 6f6e 2065 7374  e correction est
-00011e70: 696d 6174 6564 2c20 696e 2070 6978 656c  imated, in pixel
-00011e80: 730a 2020 2020 7332 6e63 7574 203a 206c  s.    s2ncut : l
-00011e90: 6973 740a 2020 2020 2020 2020 4d69 6e20  ist.        Min 
-00011ea0: 616e 6420 6d61 7820 7661 6c75 6573 206f  and max values o
-00011eb0: 6620 7369 676e 616c 2d74 6f2d 6e6f 6973  f signal-to-nois
-00011ec0: 6520 746f 2063 6f6e 7369 6465 720a 2020  e to consider.  
-00011ed0: 2020 7374 6172 6375 7420 3a20 666c 6f61    starcut : floa
-00011ee0: 740a 2020 2020 2020 2020 4d69 6e20 7661  t.        Min va
-00011ef0: 6c75 6520 6f66 2053 4578 7472 6163 746f  lue of SExtracto
-00011f00: 7220 434c 4153 535f 5354 4152 2074 6f20  r CLASS_STAR to 
-00011f10: 636f 6e73 6964 6572 0a20 2020 206d 6178  consider.    max
-00011f20: 5f61 7065 7274 7572 6520 3a20 7374 720a  _aperture : str.
-00011f30: 2020 2020 2020 2020 5468 6520 6d61 7869          The maxi
-00011f40: 6d75 6d20 6170 6572 7475 7265 2069 6e20  mum aperture in 
-00011f50: 7069 7865 6c73 0a20 2020 206d 6167 5f70  pixels.    mag_p
-00011f60: 6172 7469 7469 6f6e 203a 2066 6c6f 6174  artition : float
-00011f70: 0a20 2020 2020 2020 206f 7574 206f 6620  .        out of 
-00011f80: 7468 6520 7374 6172 7320 7365 6c65 6374  the stars select
-00011f90: 6564 2077 6974 6820 6372 6974 6572 6961  ed with criteria
-00011fa0: 2061 626f 7665 2c20 6765 7420 7468 6520   above, get the 
-00011fb0: 312f 6d61 675f 7061 7274 6974 696f 6e0a  1/mag_partition.
-00011fc0: 2020 2020 2020 2020 7361 6d70 6c65 2077          sample w
-00011fd0: 6974 6820 6c6f 7765 7220 6d61 676e 6974  ith lower magnit
-00011fe0: 7564 6573 0a20 2020 2063 6f6e 7665 7267  udes.    converg
-00011ff0: 656e 6365 5f73 6c6f 7065 203a 2073 7472  ence_slope : str
-00012000: 0a20 2020 2020 2020 2074 6865 2073 6c6f  .        the slo
-00012010: 7065 206f 6620 7468 6520 6772 6f77 7468  pe of the growth
-00012020: 2063 7572 7665 2061 7420 7468 6520 6d61   curve at the ma
-00012030: 7869 6d75 6d20 6170 6572 7475 7265 0a20  ximum aperture. 
-00012040: 2020 2063 6865 636b 5f63 6f6e 7665 7267     check_converg
-00012050: 656e 6365 203a 2062 6f6f 6c0a 2020 2020  ence : bool.    
-00012060: 2020 2020 7573 6520 736c 6f70 6520 746f      use slope to
-00012070: 2065 7661 6c75 6174 6520 7468 6520 636f   evaluate the co
-00012080: 6e66 6964 656e 6365 2069 6e20 7468 6520  nfidence in the 
-00012090: 636f 7272 6563 7469 6f6e 0a20 2020 2076  correction.    v
-000120a0: 6572 626f 7365 203a 2062 6f6f 6c0a 2020  erbose : bool.  
-000120b0: 2020 2020 2020 7072 696e 7420 6465 7461        print deta
-000120c0: 696c 7320 6f66 2074 6865 2070 726f 6365  ils of the proce
-000120d0: 7373 0a0a 2020 2020 5265 7475 726e 730a  ss..    Returns.
-000120e0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-000120f0: 5361 7665 7320 6573 7469 6d61 7465 6420  Saves estimated 
-00012100: 6170 6572 7475 7265 2063 6f72 7265 6374  aperture correct
-00012110: 696f 6e20 616e 6420 626f 756e 6473 2069  ion and bounds i
-00012120: 6e20 3320 636f 6c75 6d6e 7320 746f 2073  n 3 columns to s
-00012130: 6176 655f 6669 6c65 2c0a 2020 2020 6964  ave_file,.    id
-00012140: 656e 7469 6669 6564 2062 7920 6669 6c74  entified by filt
-00012150: 6572 7320 6279 206c 696e 650a 2020 2020  ers by line.    
-00012160: 2222 220a 0a20 2020 2073 6578 7472 6163  """..    sextrac
-00012170: 746f 725f 7461 626c 6520 3d20 5461 626c  tor_table = Tabl
-00012180: 652e 7265 6164 2863 6174 616c 6f67 290a  e.read(catalog).
-00012190: 0a20 2020 2069 6620 7665 7262 6f73 653a  .    if verbose:
-000121a0: 0a20 2020 2020 2020 2063 6174 616c 6f67  .        catalog
-000121b0: 5f6e 616d 6520 3d20 6f73 2e70 6174 682e  _name = os.path.
-000121c0: 7370 6c69 7428 6361 7461 6c6f 6729 5b31  split(catalog)[1
-000121d0: 5d0a 2020 2020 2020 2020 7072 696e 7428  ].        print(
-000121e0: 6622 4669 6c74 6572 207b 6669 6c74 7d22  f"Filter {filt}"
-000121f0: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
-00012200: 6622 4361 6c63 756c 6174 696e 6720 6170  f"Calculating ap
-00012210: 6572 7475 7265 2063 6f72 7265 6374 696f  erture correctio
-00012220: 6e20 6672 6f6d 2074 6162 6c65 207b 6361  n from table {ca
-00012230: 7461 6c6f 675f 6e61 6d65 7d22 290a 2020  talog_name}").  
-00012240: 2020 2020 2020 7072 696e 7428 6622 546f        print(f"To
-00012250: 7461 6c20 6f62 6a65 6374 733a 207b 6c65  tal objects: {le
-00012260: 6e28 7365 7874 7261 6374 6f72 5f74 6162  n(sextractor_tab
-00012270: 6c65 297d 5c6e 2229 0a0a 2020 2020 2320  le)}\n")..    # 
-00012280: 4765 7420 6170 6572 7475 7265 206c 6973  Get aperture lis
-00012290: 740a 2020 2020 6170 6572 7475 7265 735f  t.    apertures_
-000122a0: 6c69 7374 203d 2067 6574 5f61 7065 7274  list = get_apert
-000122b0: 7572 6573 5f66 726f 6d5f 7365 7863 6f6e  ures_from_sexcon
-000122c0: 6628 7365 7863 6f6e 6629 2020 2320 7479  f(sexconf)  # ty
-000122d0: 7065 3a20 6e70 2e6e 6461 7272 6179 0a0a  pe: np.ndarray..
-000122e0: 2020 2020 6966 2061 7065 7274 7572 6573      if apertures
-000122f0: 5f6c 6973 7420 6973 204e 6f6e 653a 0a20  _list is None:. 
-00012300: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00012310: 7565 4572 726f 7228 6622 436f 756c 6420  ueError(f"Could 
-00012320: 6e6f 7420 6669 6e64 2070 6172 616d 2050  not find param P
-00012330: 484f 545f 4150 4552 5455 5245 5320 696e  HOT_APERTURES in
-00012340: 207b 7365 7863 6f6e 667d 2e22 290a 0a20   {sexconf}.").. 
-00012350: 2020 2023 2047 6574 2062 6173 6520 6170     # Get base ap
-00012360: 6572 7475 7265 2049 4420 2861 6c6c 6f77  erture ID (allow
-00012370: 696e 6720 6120 726f 756e 6469 6e67 2065  ing a rounding e
-00012380: 7272 6f72 2075 7020 746f 2074 6865 2074  rror up to the t
-00012390: 6869 7264 2064 6563 696d 616c 290a 2020  hird decimal).  
-000123a0: 2020 726f 756e 645f 6c69 7374 203d 206e    round_list = n
-000123b0: 702e 6172 6f75 6e64 2861 7065 7274 7572  p.around(apertur
-000123c0: 6573 5f6c 6973 742c 2033 290a 2020 2020  es_list, 3).    
-000123d0: 726f 756e 645f 6170 6572 203d 206e 702e  round_aper = np.
-000123e0: 6172 6f75 6e64 2861 7065 7274 7572 652c  around(aperture,
-000123f0: 2033 290a 2020 2020 6170 6572 7475 7265   3).    aperture
-00012400: 5f69 6420 3d20 6e70 2e77 6865 7265 2872  _id = np.where(r
-00012410: 6f75 6e64 5f6c 6973 7420 3d3d 2072 6f75  ound_list == rou
-00012420: 6e64 5f61 7065 7229 5b30 5d5b 305d 0a0a  nd_aper)[0][0]..
-00012430: 2020 2020 2320 4170 706c 7920 7365 6c65      # Apply sele
-00012440: 6374 696f 6e20 6372 6974 6572 6961 0a20  ction criteria. 
-00012450: 2020 2073 656c 6563 742c 206d 6564 6961     select, media
-00012460: 6e46 5748 4d20 3d20 7374 6172 5f73 656c  nFWHM = star_sel
-00012470: 6563 746f 7228 6361 7461 6c6f 6720 3d20  ector(catalog = 
-00012480: 7365 7874 7261 6374 6f72 5f74 6162 6c65  sextractor_table
-00012490: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00011680: 0a23 2041 7065 7274 7572 6520 636f 7272  .# Aperture corr
+00011690: 6563 7469 6f6e 0a0a 2320 4170 6572 7475  ection..# Apertu
+000116a0: 7265 2050 686f 746f 6d65 7472 7920 4675  re Photometry Fu
+000116b0: 6e63 7469 6f6e 7320 666f 7220 7468 6520  nctions for the 
+000116c0: 532d 504c 5553 2043 6f6c 6c61 626f 7261  S-PLUS Collabora
+000116d0: 7469 6f6e 0a23 2041 7574 686f 723a 2041  tion.# Author: A
+000116e0: 6e64 72c3 a920 5a61 6d6f 7261 6e6f 2056  ndr.. Zamorano V
+000116f0: 6974 6f72 656c 6c69 202d 2061 6e64 7265  itorelli - andre
+00011700: 7a76 6974 6f72 656c 6c69 4067 6d61 696c  zvitorelli@gmail
+00011710: 2e63 6f6d 0a23 2032 3032 302d 3037 2d30  .com.# 2020-07-0
+00011720: 370a 2320 2222 220a 230a 2320 4564 6974  7.# """.#.# Edit
+00011730: 696f 6e73 3a20 4665 6c69 7065 2041 6c6d  ions: Felipe Alm
+00011740: 6569 6461 2d46 6572 6e61 6e64 6573 202d  eida-Fernandes -
+00011750: 2066 656c 6970 6566 6572 3432 4067 6d61   felipefer42@gma
+00011760: 696c 2e63 6f6d 0a23 2032 3032 312d 3035  il.com.# 2021-05
+00011770: 2d32 360a 2320 5f5f 6c69 6365 6e73 655f  -26.# __license_
+00011780: 5f20 3d20 2247 504c 220a 2320 5f5f 7665  _ = "GPL".# __ve
+00011790: 7273 696f 6e5f 5f20 3d20 2230 2e31 220a  rsion__ = "0.1".
+000117a0: 0a64 6566 2067 6574 5f61 7065 7274 7572  .def get_apertur
+000117b0: 6573 5f66 726f 6d5f 7365 7863 6f6e 6628  es_from_sexconf(
+000117c0: 7365 7863 6f6e 6629 3a0a 2020 2020 2222  sexconf):.    ""
+000117d0: 220a 2020 2020 5265 6164 7320 7468 6520  ".    Reads the 
+000117e0: 5048 4f54 5f41 5045 5254 5552 4553 2070  PHOT_APERTURES p
+000117f0: 6172 616d 6574 6572 2069 6e20 7468 6520  arameter in the 
+00011800: 7365 7863 6f6e 6620 6669 6c65 0a0a 2020  sexconf file..  
+00011810: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00011820: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00011830: 7365 7863 6f6e 6620 3a20 7374 720a 2020  sexconf : str.  
+00011840: 2020 2020 2020 4c6f 6361 7469 6f6e 206f        Location o
+00011850: 6620 7365 7863 6f6e 6620 6669 6c65 0a0a  f sexconf file..
+00011860: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00011870: 2d2d 2d2d 2d2d 2d0a 2020 2020 6e70 2e6e  -------.    np.n
+00011880: 6461 7272 6179 0a20 2020 2020 2020 206c  darray.        l
+00011890: 6973 7420 6f66 2061 7065 7274 7572 6573  ist of apertures
+000118a0: 0a20 2020 2022 2222 0a0a 2020 2020 7769  .    """..    wi
+000118b0: 7468 206f 7065 6e28 7365 7863 6f6e 6629  th open(sexconf)
+000118c0: 2061 7320 663a 0a20 2020 2020 2020 206c   as f:.        l
+000118d0: 696e 6573 203d 2066 2e72 6561 646c 696e  ines = f.readlin
+000118e0: 6573 2829 0a0a 2020 2020 666f 7220 6c69  es()..    for li
+000118f0: 6e65 2069 6e20 6c69 6e65 733a 0a20 2020  ne in lines:.   
+00011900: 2020 2020 2023 2072 656d 6f76 6520 636f       # remove co
+00011910: 6d6d 656e 7420 6672 6f6d 206c 696e 650a  mment from line.
+00011920: 2020 2020 2020 2020 6c69 6e65 203d 206c          line = l
+00011930: 696e 652e 7370 6c69 7428 2223 2229 5b30  ine.split("#")[0
+00011940: 5d0a 0a20 2020 2020 2020 2023 2047 6574  ]..        # Get
+00011950: 2070 6172 616d 206e 616d 650a 2020 2020   param name.    
+00011960: 2020 2020 7061 7261 6d20 3d20 6c69 6e65      param = line
+00011970: 2e73 706c 6974 2829 5b30 5d0a 0a20 2020  .split()[0]..   
+00011980: 2020 2020 2023 2049 6620 7061 7261 6d20       # If param 
+00011990: 6973 2022 5048 4f54 5f41 5045 5254 5552  is "PHOT_APERTUR
+000119a0: 4553 222c 2072 6574 7572 6e20 6c69 7374  ES", return list
+000119b0: 206f 6620 7661 6c75 6573 0a20 2020 2020   of values.     
+000119c0: 2020 2069 6620 7061 7261 6d20 3d3d 2022     if param == "
+000119d0: 5048 4f54 5f41 5045 5254 5552 4553 223a  PHOT_APERTURES":
+000119e0: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
+000119f0: 7565 203d 2022 222e 6a6f 696e 286c 696e  ue = "".join(lin
+00011a00: 652e 7370 6c69 7428 295b 313a 5d29 0a20  e.split()[1:]). 
+00011a10: 2020 2020 2020 2020 2020 2076 616c 7565             value
+00011a20: 203d 206e 702e 6172 7261 7928 7661 6c75   = np.array(valu
+00011a30: 652e 7370 6c69 7428 222c 2229 2c20 6474  e.split(","), dt
+00011a40: 7970 6520 3d20 666c 6f61 7429 0a0a 2020  ype = float)..  
+00011a50: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00011a60: 2076 616c 7565 0a0a 2020 2020 2320 4966   value..    # If
+00011a70: 2070 6172 616d 2022 5048 4f54 5f41 5045   param "PHOT_APE
+00011a80: 5254 5552 4553 2220 6973 206e 6f74 2066  RTURES" is not f
+00011a90: 6f75 6e64 0a20 2020 2072 6574 7572 6e20  ound.    return 
+00011aa0: 4e6f 6e65 0a0a 0a64 6566 206f 6274 6169  None...def obtai
+00011ab0: 6e5f 6170 6572 7475 7265 5f63 6f72 7265  n_aperture_corre
+00011ac0: 6374 696f 6e28 6361 7461 6c6f 672c 2066  ction(catalog, f
+00011ad0: 696c 742c 2073 6578 636f 6e66 2c20 7361  ilt, sexconf, sa
+00011ae0: 7665 5f66 696c 652c 2061 7065 7274 7572  ve_file, apertur
+00011af0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00011b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b10: 2020 7332 6e63 7574 2c20 7374 6172 6375    s2ncut, starcu
+00011b20: 742c 206d 6178 5f61 7065 7274 7572 6520  t, max_aperture 
+00011b30: 3d20 3732 2e37 3237 3237 2c0a 2020 2020  = 72.72727,.    
+00011b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b50: 2020 2020 2020 2020 2020 206d 6167 5f70             mag_p
+00011b60: 6172 7469 7469 6f6e 203d 2032 2c20 636f  artition = 2, co
+00011b70: 6e76 6572 6765 6e63 655f 736c 6f70 6520  nvergence_slope 
+00011b80: 3d20 3165 2d32 2c0a 2020 2020 2020 2020  = 1e-2,.        
+00011b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ba0: 2020 2020 2020 2063 6865 636b 5f63 6f6e         check_con
+00011bb0: 7665 7267 656e 6365 203d 2054 7275 652c  vergence = True,
+00011bc0: 2076 6572 626f 7365 203d 2046 616c 7365   verbose = False
+00011bd0: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
+00011be0: 616c 6375 6c61 7465 7320 7468 6520 6170  alculates the ap
+00011bf0: 6572 7475 7265 2063 6f72 7265 6374 696f  erture correctio
+00011c00: 6e20 6672 6f6d 2061 2063 6572 7461 696e  n from a certain
+00011c10: 2022 6170 6572 7475 7265 2220 746f 2074   "aperture" to t
+00011c20: 6865 2061 6e6f 7468 6572 0a20 2020 2061  he another.    a
+00011c30: 7065 7274 7572 6520 226d 6178 5f61 7065  perture "max_ape
+00011c40: 7274 7572 6522 2028 7768 6963 6820 6d75  rture" (which mu
+00011c50: 7374 2062 6520 6269 6720 656e 6f75 6768  st be big enough
+00011c60: 7420 746f 2072 6570 7265 7365 6e74 2074  t to represent t
+00011c70: 6865 0a20 2020 2074 6f74 616c 2065 6d69  he.    total emi
+00011c80: 7373 696f 6e20 6f66 2074 6865 2073 6f75  ssion of the sou
+00011c90: 7263 6529 0a0a 2020 2020 5061 7261 6d65  rce)..    Parame
+00011ca0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+00011cb0: 2d2d 2d0a 2020 2020 6361 7461 6c6f 6720  ---.    catalog 
+00011cc0: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
+00011cd0: 6361 7469 6f6e 206f 6620 5345 7874 7261  cation of SExtra
+00011ce0: 6374 6f72 206f 7574 7075 7420 6361 7461  ctor output cata
+00011cf0: 6c6f 6720 7769 7468 2074 6865 206d 6561  log with the mea
+00011d00: 7375 7265 6420 6669 7865 6420 6170 6572  sured fixed aper
+00011d10: 7475 7265 730a 2020 2020 6669 6c74 203a  tures.    filt :
+00011d20: 2073 7472 0a20 2020 2020 2020 204e 616d   str.        Nam
+00011d30: 6520 6f66 2074 6865 2066 696c 7465 720a  e of the filter.
+00011d40: 2020 2020 7365 7863 6f6e 6620 3a20 7374      sexconf : st
+00011d50: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
+00011d60: 6f6e 206f 6620 7365 7863 6f6e 6669 6720  on of sexconfig 
+00011d70: 6669 6c65 2066 6f72 2074 6869 7320 6669  file for this fi
+00011d80: 6c74 6572 2773 2070 686f 746f 6d65 7472  lter's photometr
+00011d90: 790a 2020 2020 7361 7665 5f66 696c 6520  y.    save_file 
+00011da0: 3a20 7374 720a 2020 2020 2020 2020 4465  : str.        De
+00011db0: 7369 7265 6420 6c6f 6361 7469 6f6e 2074  sired location t
+00011dc0: 6f20 7361 7665 2063 616c 6375 6c61 7465  o save calculate
+00011dd0: 6420 6170 6572 7475 7265 2063 6f72 7265  d aperture corre
+00011de0: 6374 696f 6e73 0a20 2020 2061 7065 7274  ctions.    apert
+00011df0: 7572 6520 3a20 666c 6f61 740a 2020 2020  ure : float.    
+00011e00: 2020 2020 4261 7365 2061 7065 7274 7572      Base apertur
+00011e10: 6520 7768 6963 6820 7769 6c6c 2068 6176  e which will hav
+00011e20: 6520 7468 6520 636f 7272 6563 7469 6f6e  e the correction
+00011e30: 2065 7374 696d 6174 6564 2c20 696e 2070   estimated, in p
+00011e40: 6978 656c 730a 2020 2020 7332 6e63 7574  ixels.    s2ncut
+00011e50: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
+00011e60: 4d69 6e20 616e 6420 6d61 7820 7661 6c75  Min and max valu
+00011e70: 6573 206f 6620 7369 676e 616c 2d74 6f2d  es of signal-to-
+00011e80: 6e6f 6973 6520 746f 2063 6f6e 7369 6465  noise to conside
+00011e90: 720a 2020 2020 7374 6172 6375 7420 3a20  r.    starcut : 
+00011ea0: 666c 6f61 740a 2020 2020 2020 2020 4d69  float.        Mi
+00011eb0: 6e20 7661 6c75 6520 6f66 2053 4578 7472  n value of SExtr
+00011ec0: 6163 746f 7220 434c 4153 535f 5354 4152  actor CLASS_STAR
+00011ed0: 2074 6f20 636f 6e73 6964 6572 0a20 2020   to consider.   
+00011ee0: 206d 6178 5f61 7065 7274 7572 6520 3a20   max_aperture : 
+00011ef0: 7374 720a 2020 2020 2020 2020 5468 6520  str.        The 
+00011f00: 6d61 7869 6d75 6d20 6170 6572 7475 7265  maximum aperture
+00011f10: 2069 6e20 7069 7865 6c73 0a20 2020 206d   in pixels.    m
+00011f20: 6167 5f70 6172 7469 7469 6f6e 203a 2066  ag_partition : f
+00011f30: 6c6f 6174 0a20 2020 2020 2020 206f 7574  loat.        out
+00011f40: 206f 6620 7468 6520 7374 6172 7320 7365   of the stars se
+00011f50: 6c65 6374 6564 2077 6974 6820 6372 6974  lected with crit
+00011f60: 6572 6961 2061 626f 7665 2c20 6765 7420  eria above, get 
+00011f70: 7468 6520 312f 6d61 675f 7061 7274 6974  the 1/mag_partit
+00011f80: 696f 6e0a 2020 2020 2020 2020 7361 6d70  ion.        samp
+00011f90: 6c65 2077 6974 6820 6c6f 7765 7220 6d61  le with lower ma
+00011fa0: 676e 6974 7564 6573 0a20 2020 2063 6f6e  gnitudes.    con
+00011fb0: 7665 7267 656e 6365 5f73 6c6f 7065 203a  vergence_slope :
+00011fc0: 2073 7472 0a20 2020 2020 2020 2074 6865   str.        the
+00011fd0: 2073 6c6f 7065 206f 6620 7468 6520 6772   slope of the gr
+00011fe0: 6f77 7468 2063 7572 7665 2061 7420 7468  owth curve at th
+00011ff0: 6520 6d61 7869 6d75 6d20 6170 6572 7475  e maximum apertu
+00012000: 7265 0a20 2020 2063 6865 636b 5f63 6f6e  re.    check_con
+00012010: 7665 7267 656e 6365 203a 2062 6f6f 6c0a  vergence : bool.
+00012020: 2020 2020 2020 2020 7573 6520 736c 6f70          use slop
+00012030: 6520 746f 2065 7661 6c75 6174 6520 7468  e to evaluate th
+00012040: 6520 636f 6e66 6964 656e 6365 2069 6e20  e confidence in 
+00012050: 7468 6520 636f 7272 6563 7469 6f6e 0a20  the correction. 
+00012060: 2020 2076 6572 626f 7365 203a 2062 6f6f     verbose : boo
+00012070: 6c0a 2020 2020 2020 2020 7072 696e 7420  l.        print 
+00012080: 6465 7461 696c 7320 6f66 2074 6865 2070  details of the p
+00012090: 726f 6365 7373 0a0a 2020 2020 5265 7475  rocess..    Retu
+000120a0: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+000120b0: 2020 2020 5361 7665 7320 6573 7469 6d61      Saves estima
+000120c0: 7465 6420 6170 6572 7475 7265 2063 6f72  ted aperture cor
+000120d0: 7265 6374 696f 6e20 616e 6420 626f 756e  rection and boun
+000120e0: 6473 2069 6e20 3320 636f 6c75 6d6e 7320  ds in 3 columns 
+000120f0: 746f 2073 6176 655f 6669 6c65 2c0a 2020  to save_file,.  
+00012100: 2020 6964 656e 7469 6669 6564 2062 7920    identified by 
+00012110: 6669 6c74 6572 7320 6279 206c 696e 650a  filters by line.
+00012120: 2020 2020 2222 220a 0a20 2020 2073 6578      """..    sex
+00012130: 7472 6163 746f 725f 7461 626c 6520 3d20  tractor_table = 
+00012140: 5461 626c 652e 7265 6164 2863 6174 616c  Table.read(catal
+00012150: 6f67 290a 0a20 2020 2069 6620 7665 7262  og)..    if verb
+00012160: 6f73 653a 0a20 2020 2020 2020 2063 6174  ose:.        cat
+00012170: 616c 6f67 5f6e 616d 6520 3d20 6f73 2e70  alog_name = os.p
+00012180: 6174 682e 7370 6c69 7428 6361 7461 6c6f  ath.split(catalo
+00012190: 6729 5b31 5d0a 2020 2020 2020 2020 7072  g)[1].        pr
+000121a0: 696e 7428 6622 4669 6c74 6572 207b 6669  int(f"Filter {fi
+000121b0: 6c74 7d22 290a 2020 2020 2020 2020 7072  lt}").        pr
+000121c0: 696e 7428 6622 4361 6c63 756c 6174 696e  int(f"Calculatin
+000121d0: 6720 6170 6572 7475 7265 2063 6f72 7265  g aperture corre
+000121e0: 6374 696f 6e20 6672 6f6d 2074 6162 6c65  ction from table
+000121f0: 207b 6361 7461 6c6f 675f 6e61 6d65 7d22   {catalog_name}"
+00012200: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
+00012210: 6622 546f 7461 6c20 6f62 6a65 6374 733a  f"Total objects:
+00012220: 207b 6c65 6e28 7365 7874 7261 6374 6f72   {len(sextractor
+00012230: 5f74 6162 6c65 297d 5c6e 2229 0a0a 2020  _table)}\n")..  
+00012240: 2020 2320 4765 7420 6170 6572 7475 7265    # Get aperture
+00012250: 206c 6973 740a 2020 2020 6170 6572 7475   list.    apertu
+00012260: 7265 735f 6c69 7374 203d 2067 6574 5f61  res_list = get_a
+00012270: 7065 7274 7572 6573 5f66 726f 6d5f 7365  pertures_from_se
+00012280: 7863 6f6e 6628 7365 7863 6f6e 6629 2020  xconf(sexconf)  
+00012290: 2320 7479 7065 3a20 6e70 2e6e 6461 7272  # type: np.ndarr
+000122a0: 6179 0a0a 2020 2020 6966 2061 7065 7274  ay..    if apert
+000122b0: 7572 6573 5f6c 6973 7420 6973 204e 6f6e  ures_list is Non
+000122c0: 653a 0a20 2020 2020 2020 2072 6169 7365  e:.        raise
+000122d0: 2056 616c 7565 4572 726f 7228 6622 436f   ValueError(f"Co
+000122e0: 756c 6420 6e6f 7420 6669 6e64 2070 6172  uld not find par
+000122f0: 616d 2050 484f 545f 4150 4552 5455 5245  am PHOT_APERTURE
+00012300: 5320 696e 207b 7365 7863 6f6e 667d 2e22  S in {sexconf}."
+00012310: 290a 0a20 2020 2023 2047 6574 2062 6173  )..    # Get bas
+00012320: 6520 6170 6572 7475 7265 2049 4420 2861  e aperture ID (a
+00012330: 6c6c 6f77 696e 6720 6120 726f 756e 6469  llowing a roundi
+00012340: 6e67 2065 7272 6f72 2075 7020 746f 2074  ng error up to t
+00012350: 6865 2074 6869 7264 2064 6563 696d 616c  he third decimal
+00012360: 290a 2020 2020 726f 756e 645f 6c69 7374  ).    round_list
+00012370: 203d 206e 702e 6172 6f75 6e64 2861 7065   = np.around(ape
+00012380: 7274 7572 6573 5f6c 6973 742c 2033 290a  rtures_list, 3).
+00012390: 2020 2020 726f 756e 645f 6170 6572 203d      round_aper =
+000123a0: 206e 702e 6172 6f75 6e64 2861 7065 7274   np.around(apert
+000123b0: 7572 652c 2033 290a 2020 2020 6170 6572  ure, 3).    aper
+000123c0: 7475 7265 5f69 6420 3d20 6e70 2e77 6865  ture_id = np.whe
+000123d0: 7265 2872 6f75 6e64 5f6c 6973 7420 3d3d  re(round_list ==
+000123e0: 2072 6f75 6e64 5f61 7065 7229 5b30 5d5b   round_aper)[0][
+000123f0: 305d 0a0a 2020 2020 2320 4170 706c 7920  0]..    # Apply 
+00012400: 7365 6c65 6374 696f 6e20 6372 6974 6572  selection criter
+00012410: 6961 0a20 2020 2073 656c 6563 742c 206d  ia.    select, m
+00012420: 6564 6961 6e46 5748 4d20 3d20 7374 6172  edianFWHM = star
+00012430: 5f73 656c 6563 746f 7228 6361 7461 6c6f  _selector(catalo
+00012440: 6720 3d20 7365 7874 7261 6374 6f72 5f74  g = sextractor_t
+00012450: 6162 6c65 2c0a 2020 2020 2020 2020 2020  able,.          
+00012460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012470: 2020 2020 2020 2020 2020 2020 2073 326e               s2n
+00012480: 6375 7420 2020 2020 2020 203d 2073 326e  cut        = s2n
+00012490: 6375 742c 0a20 2020 2020 2020 2020 2020  cut,.           
 000124a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000124b0: 2020 2020 2020 2020 2073 326e 6375 7420           s2ncut 
-000124c0: 2020 2020 2020 203d 2073 326e 6375 742c         = s2ncut,
-000124d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000124b0: 2020 2020 2020 2020 2020 2020 7374 6172              star
+000124c0: 6375 7420 2020 2020 2020 3d20 7374 6172  cut       = star
+000124d0: 6375 742c 0a20 2020 2020 2020 2020 2020  cut,.           
 000124e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000124f0: 2020 2020 2020 2020 7374 6172 6375 7420          starcut 
-00012500: 2020 2020 2020 3d20 7374 6172 6375 742c        = starcut,
-00012510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000124f0: 2020 2020 2020 2020 2020 2020 6d61 675f              mag_
+00012500: 7061 7274 6974 696f 6e20 3d20 6d61 675f  partition = mag_
+00012510: 7061 7274 6974 696f 6e2c 0a20 2020 2020  partition,.     
 00012520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012530: 2020 2020 2020 2020 6d61 675f 7061 7274          mag_part
-00012540: 6974 696f 6e20 3d20 6d61 675f 7061 7274  ition = mag_part
-00012550: 6974 696f 6e2c 0a20 2020 2020 2020 2020  ition,.         
-00012560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012570: 2020 2020 2020 2020 2020 2020 2020 7665                ve
-00012580: 7262 6f73 6520 2020 2020 2020 3d20 7665  rbose       = ve
-00012590: 7262 6f73 6529 0a0a 2020 2020 6d61 676e  rbose)..    magn
-000125a0: 6974 7564 655f 636f 7272 5f6c 6973 7420  itude_corr_list 
-000125b0: 3d20 5b5d 0a20 2020 2023 2069 6e64 6976  = [].    # indiv
-000125c0: 6964 7561 6c20 6170 6572 7475 7265 2063  idual aperture c
-000125d0: 6f72 7265 6374 696f 6e73 0a20 2020 2066  orrections.    f
-000125e0: 6f72 2073 7461 7220 696e 2073 656c 6563  or star in selec
-000125f0: 743a 0a20 2020 2020 2020 206d 6167 7320  t:.        mags 
-00012600: 3d20 7374 6172 5b27 4d41 475f 4150 4552  = star['MAG_APER
-00012610: 275d 202d 2073 7461 725b 274d 4147 5f41  '] - star['MAG_A
-00012620: 5045 5227 5d5b 6170 6572 7475 7265 5f69  PER'][aperture_i
-00012630: 645d 0a20 2020 2020 2020 206d 6167 6e69  d].        magni
-00012640: 7475 6465 5f63 6f72 725f 6c69 7374 2e61  tude_corr_list.a
-00012650: 7070 656e 6428 6d61 6773 290a 0a20 2020  ppend(mags)..   
-00012660: 206d 696e 636f 7272 2c20 6d65 6469 616e   mincorr, median
-00012670: 636f 7272 2c20 6d61 7863 6f72 7220 3d20  corr, maxcorr = 
-00012680: 6e70 2e70 6572 6365 6e74 696c 6528 6d61  np.percentile(ma
-00012690: 676e 6974 7564 655f 636f 7272 5f6c 6973  gnitude_corr_lis
-000126a0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-000126b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126d0: 2020 2020 5b31 362c 2035 302c 2038 345d      [16, 50, 84]
-000126e0: 2c20 6178 6973 3d30 290a 0a20 2020 2063  , axis=0)..    c
-000126f0: 6f72 7265 6374 696f 6e20 3d20 6e70 2e6e  orrection = np.n
-00012700: 616e 0a20 2020 2063 6f72 7265 6374 696f  an.    correctio
-00012710: 6e5f 6c6f 7720 3d20 6e70 2e6e 616e 0a20  n_low = np.nan. 
-00012720: 2020 2063 6f72 7265 6374 696f 6e5f 7570     correction_up
-00012730: 203d 206e 702e 6e61 6e0a 2020 2020 6669   = np.nan.    fi
-00012740: 6e61 6c5f 7261 6469 7573 203d 206e 702e  nal_radius = np.
-00012750: 6e61 6e0a 2020 2020 736c 6f70 6520 3d20  nan.    slope = 
-00012760: 6e70 2e6e 616e 0a0a 2020 2020 666f 7220  np.nan..    for 
-00012770: 6920 696e 2072 616e 6765 286c 656e 2861  i in range(len(a
-00012780: 7065 7274 7572 6573 5f6c 6973 7429 293a  pertures_list)):
-00012790: 0a20 2020 2020 2020 2069 6620 7665 7262  .        if verb
-000127a0: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-000127b0: 2053 4e52 203d 206e 702e 7371 7274 286d   SNR = np.sqrt(m
-000127c0: 6564 6961 6e63 6f72 725b 695d 202a 2a20  ediancorr[i] ** 
-000127d0: 3220 2f20 286d 6178 636f 7272 5b69 5d20  2 / (maxcorr[i] 
-000127e0: 2d20 6d69 6e63 6f72 725b 695d 2920 2a2a  - mincorr[i]) **
-000127f0: 2032 290a 0a20 2020 2020 2020 2020 2020   2)..           
-00012800: 206d 7367 2020 3d20 2252 6164 6975 733a   msg  = "Radius:
-00012810: 207b 3a2e 3266 7d20 7369 6e67 6c65 2061   {:.2f} single a
-00012820: 7065 722e 2022 2e66 6f72 6d61 7428 6170  per. ".format(ap
-00012830: 6572 7475 7265 735f 6c69 7374 5b69 5d29  ertures_list[i])
-00012840: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
-00012850: 202b 3d20 2263 6f72 7265 6374 696f 6e3a   += "correction:
-00012860: 207b 3a2e 3466 7d20 222e 666f 726d 6174   {:.4f} ".format
-00012870: 286d 6564 6961 6e63 6f72 725b 695d 290a  (mediancorr[i]).
-00012880: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
-00012890: 2b3d 2022 5b7b 3a2e 3466 7d20 2d20 7b3a  += "[{:.4f} - {:
-000128a0: 2e34 667d 5d28 434c 3638 2920 222e 666f  .4f}](CL68) ".fo
-000128b0: 726d 6174 286d 696e 636f 7272 5b69 5d2c  rmat(mincorr[i],
-000128c0: 206d 6178 636f 7272 5b69 5d29 0a20 2020   maxcorr[i]).   
-000128d0: 2020 2020 2020 2020 206d 7367 202b 3d20           msg += 
-000128e0: 2253 4e52 3a20 7b7d 222e 666f 726d 6174  "SNR: {}".format
-000128f0: 2853 4e52 290a 0a20 2020 2020 2020 2020  (SNR)..         
-00012900: 2020 2070 7269 6e74 286d 7367 290a 0a20     print(msg).. 
-00012910: 2020 2020 2020 2069 6620 6170 6572 7475         if apertu
-00012920: 7265 735f 6c69 7374 5b69 5d20 3c3d 206d  res_list[i] <= m
-00012930: 6178 5f61 7065 7274 7572 653a 0a0a 2020  ax_aperture:..  
-00012940: 2020 2020 2020 2020 2020 636f 7272 6563            correc
-00012950: 7469 6f6e 2020 2020 203d 206d 6564 6961  tion     = media
-00012960: 6e63 6f72 725b 695d 0a20 2020 2020 2020  ncorr[i].       
-00012970: 2020 2020 2063 6f72 7265 6374 696f 6e5f       correction_
-00012980: 6c6f 7720 3d20 6d69 6e63 6f72 725b 695d  low = mincorr[i]
-00012990: 0a20 2020 2020 2020 2020 2020 2063 6f72  .            cor
-000129a0: 7265 6374 696f 6e5f 7570 2020 3d20 6d61  rection_up  = ma
-000129b0: 7863 6f72 725b 695d 0a20 2020 2020 2020  xcorr[i].       
-000129c0: 2020 2020 2066 696e 616c 5f72 6164 6975       final_radiu
-000129d0: 7320 2020 3d20 6170 6572 7475 7265 735f  s   = apertures_
-000129e0: 6c69 7374 5b69 5d0a 0a20 2020 2020 2020  list[i]..       
-000129f0: 2020 2020 2023 2043 6865 636b 2063 6f6e       # Check con
-00012a00: 7665 7267 656e 6365 0a20 2020 2020 2020  vergence.       
-00012a10: 2020 2020 206a 203d 206c 656e 2861 7065       j = len(ape
-00012a20: 7274 7572 6573 5f6c 6973 7429 202d 2069  rtures_list) - i
-00012a30: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00012a40: 6368 6563 6b5f 636f 6e76 6572 6765 6e63  check_convergenc
-00012a50: 6520 616e 6420 6920 3e20 323a 0a20 2020  e and i > 2:.   
-00012a60: 2020 2020 2020 2020 2020 2020 2073 6c6f               slo
-00012a70: 7065 5f72 6164 6969 203d 2061 7065 7274  pe_radii = apert
-00012a80: 7572 6573 5f6c 6973 745b 2d28 6a20 2b20  ures_list[-(j + 
-00012a90: 3329 3a2d 6a5d 0a20 2020 2020 2020 2020  3):-j].         
-00012aa0: 2020 2020 2020 2073 6c6f 7065 5f63 6f72         slope_cor
-00012ab0: 7273 203d 206d 6564 6961 6e63 6f72 725b  rs = mediancorr[
-00012ac0: 2d28 6a20 2b20 3329 3a2d 6a5d 0a20 2020  -(j + 3):-j].   
-00012ad0: 2020 2020 2020 2020 2020 2020 2073 6c6f               slo
-00012ae0: 7065 203d 206c 696e 7265 6772 6573 7328  pe = linregress(
-00012af0: 736c 6f70 655f 7261 6469 692c 2073 6c6f  slope_radii, slo
-00012b00: 7065 5f63 6f72 7273 295b 305d 0a0a 2020  pe_corrs)[0]..  
-00012b10: 2020 6966 2076 6572 626f 7365 3a0a 2020    if verbose:.  
-00012b20: 2020 2020 2020 7072 696e 7428 2866 226c        print((f"l
-00012b30: 6f77 2d6d 6564 6961 6e2d 6869 6768 3a20  ow-median-high: 
-00012b40: 5b7b 636f 7272 6563 7469 6f6e 5f6c 6f77  [{correction_low
-00012b50: 3a2e 3466 7d20 220a 2020 2020 2020 2020  :.4f} ".        
-00012b60: 2020 2020 2020 2066 227b 636f 7272 6563         f"{correc
-00012b70: 7469 6f6e 3a2e 3466 7d20 7b63 6f72 7265  tion:.4f} {corre
-00012b80: 6374 696f 6e5f 7570 3a2e 3466 7d5d 2229  ction_up:.4f}]")
-00012b90: 290a 0a20 2020 2020 2020 2070 7269 6e74  )..        print
-00012ba0: 2866 274e 6561 7265 7374 2061 7065 7274  (f'Nearest apert
-00012bb0: 7572 653a 207b 6669 6e61 6c5f 7261 6469  ure: {final_radi
-00012bc0: 7573 7d27 290a 0a20 2020 2020 2020 2069  us}')..        i
-00012bd0: 6620 6368 6563 6b5f 636f 6e76 6572 6765  f check_converge
-00012be0: 6e63 653a 0a20 2020 2020 2020 2020 2020  nce:.           
-00012bf0: 2070 7269 6e74 2866 2753 6c6f 7065 206f   print(f'Slope o
-00012c00: 6620 6c61 7374 2033 2061 7065 7274 7572  f last 3 apertur
-00012c10: 6573 3a20 7b73 6c6f 7065 3a2e 3265 7d5c  es: {slope:.2e}\
-00012c20: 6e27 290a 0a20 2020 2063 6f6e 7665 7267  n')..    converg
-00012c30: 656e 6365 203d 204e 6f6e 650a 0a20 2020  ence = None..   
-00012c40: 2069 6620 6368 6563 6b5f 636f 6e76 6572   if check_conver
-00012c50: 6765 6e63 653a 0a20 2020 2020 2020 2069  gence:.        i
-00012c60: 6620 6162 7328 736c 6f70 6529 203e 2063  f abs(slope) > c
-00012c70: 6f6e 7665 7267 656e 6365 5f73 6c6f 7065  onvergence_slope
-00012c80: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
-00012c90: 6e76 6572 6765 6e63 6520 3d20 224e 6f74  nvergence = "Not
-00012ca0: 5f63 6f6e 7665 7267 6564 220a 2020 2020  _converged".    
-00012cb0: 2020 2020 2020 2020 7072 696e 7428 2866          print((f
-00012cc0: 2757 6172 6e69 6e67 3a20 6170 6572 7475  'Warning: apertu
-00012cd0: 7265 2063 6f72 7265 6374 696f 6e20 6973  re correction is
-00012ce0: 206e 6f74 2073 7461 626c 6520 6174 2074   not stable at t
-00012cf0: 6865 2073 656c 6563 7465 6427 0a20 2020  he selected'.   
-00012d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d10: 6627 2061 7065 7274 7572 6520 666f 7220  f' aperture for 
-00012d20: 6669 6c74 6572 207b 6669 6c74 7d2e 2053  filter {filt}. S
-00012d30: 6c6f 7065 3a20 7b73 6c6f 7065 3a2e 3265  lope: {slope:.2e
-00012d40: 7d27 2929 0a20 2020 2020 2020 2065 6c73  }')).        els
-00012d50: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
-00012d60: 6f6e 7665 7267 656e 6365 203d 2022 436f  onvergence = "Co
-00012d70: 6e76 6572 6765 6422 0a0a 2020 2020 2320  nverged"..    # 
-00012d80: 5772 6974 6520 746f 2066 696c 650a 2020  Write to file.  
-00012d90: 2020 7769 7468 206f 7065 6e28 7361 7665    with open(save
-00012da0: 5f66 696c 652c 2027 6127 2920 6173 2066  _file, 'a') as f
-00012db0: 3a0a 2020 2020 2020 2020 662e 7772 6974  :.        f.writ
-00012dc0: 6528 6627 5350 4c55 535f 7b66 696c 747d  e(f'SPLUS_{filt}
-00012dd0: 207b 636f 7272 6563 7469 6f6e 7d20 7b63   {correction} {c
-00012de0: 6f72 7265 6374 696f 6e5f 6c6f 777d 207b  orrection_low} {
-00012df0: 636f 7272 6563 7469 6f6e 5f75 707d 2729  correction_up}')
-00012e00: 0a0a 2020 2020 2020 2020 6966 2063 6865  ..        if che
-00012e10: 636b 5f63 6f6e 7665 7267 656e 6365 3a0a  ck_convergence:.
-00012e20: 2020 2020 2020 2020 2020 2020 662e 7772              f.wr
-00012e30: 6974 6528 6627 207b 636f 6e76 6572 6765  ite(f' {converge
-00012e40: 6e63 657d 2729 0a0a 2020 2020 2020 2020  nce}')..        
-00012e50: 662e 7772 6974 6528 275c 6e27 290a 0a20  f.write('\n').. 
-00012e60: 2020 2064 656c 2073 656c 6563 740a 0a0a     del select...
-00012e70: 6465 6620 7374 6172 5f73 656c 6563 746f  def star_selecto
-00012e80: 7228 6361 7461 6c6f 672c 2073 326e 6375  r(catalog, s2ncu
-00012e90: 7420 3d20 2833 302c 2031 3030 3029 2c20  t = (30, 1000), 
-00012ea0: 7374 6172 6375 7420 3d20 302e 392c 0a20  starcut = 0.9,. 
-00012eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ec0: 206d 6167 5f70 6172 7469 7469 6f6e 203d   mag_partition =
-00012ed0: 2032 2c20 7665 7262 6f73 6520 3d20 4661   2, verbose = Fa
-00012ee0: 6c73 6529 3a0a 2020 2020 2222 220a 2020  lse):.    """.  
-00012ef0: 2020 5365 6c65 6374 7320 7468 6520 7374    Selects the st
-00012f00: 6172 7320 666f 7220 7468 6520 6170 6572  ars for the aper
-00012f10: 7475 7265 2063 6f72 7265 6374 696f 6e0a  ture correction.
-00012f20: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
-00012f30: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-00012f40: 2020 2063 6174 616c 6f67 203a 2061 7374     catalog : ast
-00012f50: 726f 7079 2054 6162 6c65 0a20 2020 2020  ropy Table.     
-00012f60: 2020 204c 6f61 6465 6420 6669 7473 2063     Loaded fits c
-00012f70: 6174 616c 6f67 2061 7320 616e 2061 7374  atalog as an ast
-00012f80: 726f 7079 2074 6162 6c65 0a20 2020 2073  ropy table.    s
-00012f90: 326e 6375 7420 3a20 6c69 7374 0a20 2020  2ncut : list.   
-00012fa0: 2020 2020 204d 696e 2061 6e64 206d 6178       Min and max
-00012fb0: 2076 616c 7565 7320 6f66 2073 6967 6e61   values of signa
-00012fc0: 6c2d 746f 2d6e 6f69 7365 2074 6f20 636f  l-to-noise to co
-00012fd0: 6e73 6964 6572 0a20 2020 2073 7461 7263  nsider.    starc
-00012fe0: 7574 203a 2066 6c6f 6174 0a20 2020 2020  ut : float.     
-00012ff0: 2020 204d 696e 2076 616c 7565 206f 6620     Min value of 
-00013000: 5345 7874 7261 6374 6f72 2043 4c41 5353  SExtractor CLASS
-00013010: 5f53 5441 5220 746f 2063 6f6e 7369 6465  _STAR to conside
-00013020: 720a 2020 2020 6d61 675f 7061 7274 6974  r.    mag_partit
-00013030: 696f 6e20 3a20 666c 6f61 740a 2020 2020  ion : float.    
-00013040: 2020 2020 6f75 7420 6f66 2074 6865 2073      out of the s
-00013050: 7461 7273 2073 656c 6563 7465 6420 7769  tars selected wi
-00013060: 7468 2063 7269 7465 7269 6120 6162 6f76  th criteria abov
-00013070: 652c 2067 6574 2074 6865 2031 2f6d 6167  e, get the 1/mag
-00013080: 5f70 6172 7469 7469 6f6e 0a20 2020 2020  _partition.     
-00013090: 2020 2073 616d 706c 6520 7769 7468 206c     sample with l
-000130a0: 6f77 6572 206d 6167 6e69 7475 6465 730a  ower magnitudes.
-000130b0: 2020 2020 7665 7262 6f73 6520 3a20 626f      verbose : bo
-000130c0: 6f6c 0a20 2020 2020 2020 2070 7269 6e74  ol.        print
-000130d0: 2064 6574 6169 6c73 206f 6620 7468 6520   details of the 
-000130e0: 7072 6f63 6573 730a 0a20 2020 2052 6574  process..    Ret
-000130f0: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
-00013100: 0a20 2020 2061 7374 726f 7079 2054 6162  .    astropy Tab
-00013110: 6c65 0a20 2020 2020 2020 2053 656c 6563  le.        Selec
-00013120: 7465 6420 7374 6172 7320 6461 7461 0a20  ted stars data. 
-00013130: 2020 2022 2222 0a0a 2020 2020 2320 4361     """..    # Ca
-00013140: 6c63 756c 6174 6520 7468 6520 7332 6e0a  lculate the s2n.
-00013150: 2020 2020 7332 6e20 3d20 6361 7461 6c6f      s2n = catalo
-00013160: 675b 2746 4c55 585f 4155 544f 275d 202f  g['FLUX_AUTO'] /
-00013170: 2063 6174 616c 6f67 5b27 464c 5558 4552   catalog['FLUXER
-00013180: 525f 4155 544f 275d 0a0a 2020 2020 2320  R_AUTO']..    # 
-00013190: 4170 706c 7920 7365 6c65 6374 696f 6e20  Apply selection 
-000131a0: 636f 6e64 6974 696f 6e73 0a20 2020 2063  conditions.    c
-000131b0: 6f6e 6469 7469 6f6e 7320 3d20 2828 6361  onditions = ((ca
-000131c0: 7461 6c6f 675b 2743 4c41 5353 5f53 5441  talog['CLASS_STA
-000131d0: 5227 5d20 3e20 7374 6172 6375 7429 2026  R'] > starcut) &
-000131e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000131f0: 2020 2028 7332 6e20 3e20 7332 6e63 7574     (s2n > s2ncut
-00013200: 5b30 5d29 2026 0a20 2020 2020 2020 2020  [0]) &.         
-00013210: 2020 2020 2020 2020 2028 7332 6e20 3c20           (s2n < 
-00013220: 7332 6e63 7574 5b31 5d29 2026 0a20 2020  s2ncut[1]) &.   
-00013230: 2020 2020 2020 2020 2020 2020 2020 2028                 (
-00013240: 6361 7461 6c6f 675b 2746 4c41 4753 275d  catalog['FLAGS']
-00013250: 203d 3d20 3029 290a 0a20 2020 2073 656c   == 0))..    sel
-00013260: 6563 7420 3d20 6361 7461 6c6f 675b 636f  ect = catalog[co
-00013270: 6e64 6974 696f 6e73 5d0a 0a20 2020 2069  nditions]..    i
-00013280: 6620 7665 7262 6f73 653a 0a20 2020 2020  f verbose:.     
-00013290: 2020 2070 7269 6e74 2866 2253 656c 6563     print(f"Selec
-000132a0: 7465 6420 7374 6172 733a 207b 6c65 6e28  ted stars: {len(
-000132b0: 7365 6c65 6374 297d 2229 0a0a 2020 2020  select)}")..    
-000132c0: 2320 5365 6c65 6374 2077 656c 6c20 6265  # Select well be
-000132d0: 6861 7665 6420 4657 484d 0a20 2020 2069  haved FWHM.    i
-000132e0: 6e66 6572 696f 722c 206d 6564 6961 6e46  nferior, medianF
-000132f0: 5748 4d2c 2073 7570 6572 696f 7220 3d20  WHM, superior = 
-00013300: 6e70 2e70 6572 6365 6e74 696c 6528 7365  np.percentile(se
-00013310: 6c65 6374 5b27 4657 484d 5f57 4f52 4c44  lect['FWHM_WORLD
-00013320: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-00013330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013350: 2020 2020 2020 205b 3136 2c20 3530 2c20         [16, 50, 
-00013360: 3834 5d29 0a0a 2020 2020 636f 6e64 6974  84])..    condit
-00013370: 696f 6e73 3220 3d20 2828 7365 6c65 6374  ions2 = ((select
-00013380: 5b27 4657 484d 5f57 4f52 4c44 275d 203e  ['FWHM_WORLD'] >
-00013390: 2069 6e66 6572 696f 7229 2026 0a20 2020   inferior) &.   
-000133a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000133b0: 2873 656c 6563 745b 2746 5748 4d5f 574f  (select['FWHM_WO
-000133c0: 524c 4427 5d20 3c20 7375 7065 7269 6f72  RLD'] < superior
-000133d0: 2929 0a0a 2020 2020 7365 6c65 6374 203d  ))..    select =
-000133e0: 2073 656c 6563 745b 636f 6e64 6974 696f   select[conditio
-000133f0: 6e73 325d 0a0a 2020 2020 6966 2076 6572  ns2]..    if ver
-00013400: 626f 7365 3a0a 2020 2020 2020 2020 7072  bose:.        pr
-00013410: 696e 7428 6622 4d65 6469 616e 2046 5748  int(f"Median FWH
-00013420: 4d20 666f 7220 6669 656c 643a 207b 6d65  M for field: {me
-00013430: 6469 616e 4657 484d 3a2e 3466 7d22 290a  dianFWHM:.4f}").
-00013440: 2020 2020 2020 2020 7072 696e 7428 6622          print(f"
-00013450: 4166 7465 7220 4657 484d 2063 7574 3a20  After FWHM cut: 
-00013460: 7b6c 656e 2873 656c 6563 7429 7d22 290a  {len(select)}").
-00013470: 0a20 2020 2023 2042 7269 6768 7465 7374  .    # Brightest
-00013480: 206f 6620 7468 6520 6265 7374 3a0a 2020   of the best:.  
-00013490: 2020 7365 6c65 6374 2e73 6f72 7428 274d    select.sort('M
-000134a0: 4147 5f41 5554 4f27 290a 2020 2020 7365  AG_AUTO').    se
-000134b0: 6c65 6374 203d 2073 656c 6563 745b 303a  lect = select[0:
-000134c0: 696e 7428 6c65 6e28 7365 6c65 6374 2920  int(len(select) 
-000134d0: 2f20 6d61 675f 7061 7274 6974 696f 6e29  / mag_partition)
-000134e0: 5d0a 0a20 2020 2069 6620 7665 7262 6f73  ]..    if verbos
-000134f0: 653a 0a20 2020 2020 2020 2070 7269 6e74  e:.        print
-00013500: 2866 2241 6674 6572 2062 7269 6768 7465  (f"After brighte
-00013510: 7374 2031 2f7b 6d61 675f 7061 7274 6974  st 1/{mag_partit
-00013520: 696f 6e7d 2063 7574 3a20 7b6c 656e 2873  ion} cut: {len(s
-00013530: 656c 6563 7429 7d5c 6e22 290a 0a20 2020  elect)}\n")..   
-00013540: 2072 6574 7572 6e20 7365 6c65 6374 2c20   return select, 
-00013550: 6d65 6469 616e 4657 484d 0a0a 0a64 6566  medianFWHM...def
-00013560: 2067 726f 7774 685f 6375 7276 6528 6361   growth_curve(ca
-00013570: 7461 6c6f 672c 2073 326e 6375 7420 3d20  talog, s2ncut = 
-00013580: 2833 302c 2031 3030 3029 2c20 7374 6172  (30, 1000), star
-00013590: 6375 7420 3d20 302e 392c 0a20 2020 2020  cut = 0.9,.     
-000135a0: 2020 2020 2020 2020 2020 2020 6d61 675f              mag_
-000135b0: 7061 7274 6974 696f 6e3d 322c 2076 6572  partition=2, ver
-000135c0: 626f 7365 203d 2046 616c 7365 293a 0a20  bose = False):. 
-000135d0: 2020 2022 2222 0a20 2020 2043 616c 6375     """.    Calcu
-000135e0: 6c61 7465 7320 7468 6520 6772 6f77 7468  lates the growth
-000135f0: 2063 7572 7665 2028 6d61 676e 6974 7564   curve (magnitud
-00013600: 6520 696e 2072 6164 6975 7320 4b2b 3120  e in radius K+1 
-00013610: 2d20 6d61 676e 6974 7564 6520 696e 0a20  - magnitude in. 
-00013620: 2020 2072 6164 6975 7320 4b29 2066 6f72     radius K) for
-00013630: 2061 2066 696c 7465 7220 696e 2061 2066   a filter in a f
-00013640: 6965 6c64 2066 726f 6d20 6120 7365 7874  ield from a sext
-00013650: 7261 6374 6f72 2063 6174 616c 6f67 7565  ractor catalogue
-00013660: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
-00013670: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-00013680: 2020 2020 6361 7461 6c6f 6720 3a20 6173      catalog : as
-00013690: 7472 6f70 7920 5461 626c 650a 2020 2020  tropy Table.    
-000136a0: 2020 2020 4c6f 6164 6564 2066 6974 7320      Loaded fits 
-000136b0: 6361 7461 6c6f 6720 6173 2061 6e20 6173  catalog as an as
-000136c0: 7472 6f70 7920 7461 626c 650a 2020 2020  tropy table.    
-000136d0: 7332 6e63 7574 203a 206c 6973 740a 2020  s2ncut : list.  
-000136e0: 2020 2020 2020 4d69 6e20 616e 6420 6d61        Min and ma
-000136f0: 7820 7661 6c75 6573 206f 6620 7369 676e  x values of sign
-00013700: 616c 2d74 6f2d 6e6f 6973 6520 746f 2063  al-to-noise to c
-00013710: 6f6e 7369 6465 720a 2020 2020 7374 6172  onsider.    star
-00013720: 6375 7420 3a20 666c 6f61 740a 2020 2020  cut : float.    
-00013730: 2020 2020 4d69 6e20 7661 6c75 6520 6f66      Min value of
-00013740: 2053 4578 7472 6163 746f 7220 434c 4153   SExtractor CLAS
-00013750: 535f 5354 4152 2074 6f20 636f 6e73 6964  S_STAR to consid
-00013760: 6572 0a20 2020 206d 6167 5f70 6172 7469  er.    mag_parti
-00013770: 7469 6f6e 203a 2066 6c6f 6174 0a20 2020  tion : float.   
-00013780: 2020 2020 206f 7574 206f 6620 7468 6520       out of the 
-00013790: 7374 6172 7320 7365 6c65 6374 6564 2077  stars selected w
-000137a0: 6974 6820 6372 6974 6572 6961 2061 626f  ith criteria abo
-000137b0: 7665 2c20 6765 7420 7468 6520 312f 6d61  ve, get the 1/ma
-000137c0: 675f 7061 7274 6974 696f 6e0a 2020 2020  g_partition.    
-000137d0: 2020 2020 7361 6d70 6c65 2077 6974 6820      sample with 
-000137e0: 6c6f 7765 7220 6d61 676e 6974 7564 6573  lower magnitudes
-000137f0: 0a20 2020 2076 6572 626f 7365 203a 2062  .    verbose : b
-00013800: 6f6f 6c0a 2020 2020 2020 2020 7072 696e  ool.        prin
-00013810: 7420 6465 7461 696c 7320 6f66 2074 6865  t details of the
-00013820: 2070 726f 6365 7373 0a0a 2020 2020 5265   process..    Re
-00013830: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00013840: 2d0a 2020 2020 6e70 2e6e 6461 7272 6179  -.    np.ndarray
-00013850: 0a20 2020 2020 2020 206e 756d 7079 2061  .        numpy a
-00013860: 7272 6179 206f 6620 7368 6170 6520 2835  rray of shape (5
-00013870: 2c20 6c65 6e28 6170 6572 7475 7265 5f72  , len(aperture_r
-00013880: 6164 6969 292d 3129 2063 6f6e 7461 696e  adii)-1) contain
-00013890: 696e 672c 2069 6e20 6f72 6465 723a 0a20  ing, in order:. 
-000138a0: 2020 2020 2020 2020 2020 206c 6f77 6572             lower
-000138b0: 2062 6f75 6e64 206f 6620 7468 6520 3935   bound of the 95
-000138c0: 2520 636f 6e66 6964 656e 6365 2072 6567  % confidence reg
-000138d0: 696f 6e20 6f66 2074 6865 2067 726f 7774  ion of the growt
-000138e0: 6820 6375 7276 650a 2020 2020 2020 2020  h curve.        
-000138f0: 2020 2020 6c6f 7765 7220 626f 756e 6420      lower bound 
-00013900: 6f66 2074 6865 2036 3825 2063 6f6e 6669  of the 68% confi
-00013910: 6465 6e63 6520 7265 6769 6f6e 206f 6620  dence region of 
-00013920: 7468 6520 6772 6f77 7468 2063 7572 7665  the growth curve
-00013930: 0a20 2020 2020 2020 2020 2020 206d 6564  .            med
-00013940: 6961 6e20 6f66 2074 6865 2067 726f 7774  ian of the growt
-00013950: 6820 6375 7276 650a 2020 2020 2020 2020  h curve.        
-00013960: 2020 2020 6869 6768 6572 2062 6f75 6e64      higher bound
-00013970: 206f 6620 7468 6520 3638 2520 636f 6e66   of the 68% conf
-00013980: 6964 656e 6365 2072 6567 696f 6e20 6f66  idence region of
-00013990: 2074 6865 2067 726f 7774 6820 6375 7276   the growth curv
-000139a0: 650a 2020 2020 2020 2020 2020 2020 6869  e.            hi
-000139b0: 6768 6572 2062 6f75 6e64 206f 6620 7468  gher bound of th
-000139c0: 6520 3935 2520 636f 6e66 6964 656e 6365  e 95% confidence
-000139d0: 2072 6567 696f 6e20 6f66 2074 6865 2067   region of the g
-000139e0: 726f 7774 6820 6375 7276 650a 2020 2020  rowth curve.    
-000139f0: 666c 6f61 740a 2020 2020 2020 2020 6d65  float.        me
-00013a00: 6469 616e 2046 5748 4d20 6f66 2073 7461  dian FWHM of sta
-00013a10: 7273 0a20 2020 2069 6e74 0a20 2020 2020  rs.    int.     
-00013a20: 2020 206e 756d 6265 7220 6f66 2073 656c     number of sel
-00013a30: 6563 7465 6420 7374 6172 730a 2020 2020  ected stars.    
-00013a40: 2222 220a 0a20 2020 2073 6578 7472 6163  """..    sextrac
-00013a50: 746f 725f 7461 626c 6520 3d20 5461 626c  tor_table = Tabl
-00013a60: 652e 7265 6164 2863 6174 616c 6f67 290a  e.read(catalog).
-00013a70: 0a20 2020 2073 656c 6563 742c 206d 6564  .    select, med
-00013a80: 6961 6e46 5748 4d20 3d20 7374 6172 5f73  ianFWHM = star_s
-00013a90: 656c 6563 746f 7228 6361 7461 6c6f 6720  elector(catalog 
-00013aa0: 3d20 7365 7874 7261 6374 6f72 5f74 6162  = sextractor_tab
-00013ab0: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
+00012530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012540: 2020 7665 7262 6f73 6520 2020 2020 2020    verbose       
+00012550: 3d20 7665 7262 6f73 6529 0a0a 2020 2020  = verbose)..    
+00012560: 6d61 676e 6974 7564 655f 636f 7272 5f6c  magnitude_corr_l
+00012570: 6973 7420 3d20 5b5d 0a20 2020 2023 2069  ist = [].    # i
+00012580: 6e64 6976 6964 7561 6c20 6170 6572 7475  ndividual apertu
+00012590: 7265 2063 6f72 7265 6374 696f 6e73 0a20  re corrections. 
+000125a0: 2020 2066 6f72 2073 7461 7220 696e 2073     for star in s
+000125b0: 656c 6563 743a 0a20 2020 2020 2020 206d  elect:.        m
+000125c0: 6167 7320 3d20 7374 6172 5b27 4d41 475f  ags = star['MAG_
+000125d0: 4150 4552 275d 202d 2073 7461 725b 274d  APER'] - star['M
+000125e0: 4147 5f41 5045 5227 5d5b 6170 6572 7475  AG_APER'][apertu
+000125f0: 7265 5f69 645d 0a20 2020 2020 2020 206d  re_id].        m
+00012600: 6167 6e69 7475 6465 5f63 6f72 725f 6c69  agnitude_corr_li
+00012610: 7374 2e61 7070 656e 6428 6d61 6773 290a  st.append(mags).
+00012620: 0a20 2020 206d 696e 636f 7272 2c20 6d65  .    mincorr, me
+00012630: 6469 616e 636f 7272 2c20 6d61 7863 6f72  diancorr, maxcor
+00012640: 7220 3d20 6e70 2e70 6572 6365 6e74 696c  r = np.percentil
+00012650: 6528 6d61 676e 6974 7564 655f 636f 7272  e(magnitude_corr
+00012660: 5f6c 6973 742c 0a20 2020 2020 2020 2020  _list,.         
+00012670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012690: 2020 2020 2020 2020 5b31 362c 2035 302c          [16, 50,
+000126a0: 2038 345d 2c20 6178 6973 3d30 290a 0a20   84], axis=0).. 
+000126b0: 2020 2063 6f72 7265 6374 696f 6e20 3d20     correction = 
+000126c0: 6e70 2e6e 616e 0a20 2020 2063 6f72 7265  np.nan.    corre
+000126d0: 6374 696f 6e5f 6c6f 7720 3d20 6e70 2e6e  ction_low = np.n
+000126e0: 616e 0a20 2020 2063 6f72 7265 6374 696f  an.    correctio
+000126f0: 6e5f 7570 203d 206e 702e 6e61 6e0a 2020  n_up = np.nan.  
+00012700: 2020 6669 6e61 6c5f 7261 6469 7573 203d    final_radius =
+00012710: 206e 702e 6e61 6e0a 2020 2020 736c 6f70   np.nan.    slop
+00012720: 6520 3d20 6e70 2e6e 616e 0a0a 2020 2020  e = np.nan..    
+00012730: 666f 7220 6920 696e 2072 616e 6765 286c  for i in range(l
+00012740: 656e 2861 7065 7274 7572 6573 5f6c 6973  en(apertures_lis
+00012750: 7429 293a 0a20 2020 2020 2020 2069 6620  t)):.        if 
+00012760: 7665 7262 6f73 653a 0a20 2020 2020 2020  verbose:.       
+00012770: 2020 2020 2053 4e52 203d 206e 702e 7371       SNR = np.sq
+00012780: 7274 286d 6564 6961 6e63 6f72 725b 695d  rt(mediancorr[i]
+00012790: 202a 2a20 3220 2f20 286d 6178 636f 7272   ** 2 / (maxcorr
+000127a0: 5b69 5d20 2d20 6d69 6e63 6f72 725b 695d  [i] - mincorr[i]
+000127b0: 2920 2a2a 2032 290a 0a20 2020 2020 2020  ) ** 2)..       
+000127c0: 2020 2020 206d 7367 2020 3d20 2252 6164       msg  = "Rad
+000127d0: 6975 733a 207b 3a2e 3266 7d20 7369 6e67  ius: {:.2f} sing
+000127e0: 6c65 2061 7065 722e 2022 2e66 6f72 6d61  le aper. ".forma
+000127f0: 7428 6170 6572 7475 7265 735f 6c69 7374  t(apertures_list
+00012800: 5b69 5d29 0a20 2020 2020 2020 2020 2020  [i]).           
+00012810: 206d 7367 202b 3d20 2263 6f72 7265 6374   msg += "correct
+00012820: 696f 6e3a 207b 3a2e 3466 7d20 222e 666f  ion: {:.4f} ".fo
+00012830: 726d 6174 286d 6564 6961 6e63 6f72 725b  rmat(mediancorr[
+00012840: 695d 290a 2020 2020 2020 2020 2020 2020  i]).            
+00012850: 6d73 6720 2b3d 2022 5b7b 3a2e 3466 7d20  msg += "[{:.4f} 
+00012860: 2d20 7b3a 2e34 667d 5d28 434c 3638 2920  - {:.4f}](CL68) 
+00012870: 222e 666f 726d 6174 286d 696e 636f 7272  ".format(mincorr
+00012880: 5b69 5d2c 206d 6178 636f 7272 5b69 5d29  [i], maxcorr[i])
+00012890: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
+000128a0: 202b 3d20 2253 4e52 3a20 7b7d 222e 666f   += "SNR: {}".fo
+000128b0: 726d 6174 2853 4e52 290a 0a20 2020 2020  rmat(SNR)..     
+000128c0: 2020 2020 2020 2070 7269 6e74 286d 7367         print(msg
+000128d0: 290a 0a20 2020 2020 2020 2069 6620 6170  )..        if ap
+000128e0: 6572 7475 7265 735f 6c69 7374 5b69 5d20  ertures_list[i] 
+000128f0: 3c3d 206d 6178 5f61 7065 7274 7572 653a  <= max_aperture:
+00012900: 0a0a 2020 2020 2020 2020 2020 2020 636f  ..            co
+00012910: 7272 6563 7469 6f6e 2020 2020 203d 206d  rrection     = m
+00012920: 6564 6961 6e63 6f72 725b 695d 0a20 2020  ediancorr[i].   
+00012930: 2020 2020 2020 2020 2063 6f72 7265 6374           correct
+00012940: 696f 6e5f 6c6f 7720 3d20 6d69 6e63 6f72  ion_low = mincor
+00012950: 725b 695d 0a20 2020 2020 2020 2020 2020  r[i].           
+00012960: 2063 6f72 7265 6374 696f 6e5f 7570 2020   correction_up  
+00012970: 3d20 6d61 7863 6f72 725b 695d 0a20 2020  = maxcorr[i].   
+00012980: 2020 2020 2020 2020 2066 696e 616c 5f72           final_r
+00012990: 6164 6975 7320 2020 3d20 6170 6572 7475  adius   = apertu
+000129a0: 7265 735f 6c69 7374 5b69 5d0a 0a20 2020  res_list[i]..   
+000129b0: 2020 2020 2020 2020 2023 2043 6865 636b           # Check
+000129c0: 2063 6f6e 7665 7267 656e 6365 0a20 2020   convergence.   
+000129d0: 2020 2020 2020 2020 206a 203d 206c 656e           j = len
+000129e0: 2861 7065 7274 7572 6573 5f6c 6973 7429  (apertures_list)
+000129f0: 202d 2069 0a20 2020 2020 2020 2020 2020   - i.           
+00012a00: 2069 6620 6368 6563 6b5f 636f 6e76 6572   if check_conver
+00012a10: 6765 6e63 6520 616e 6420 6920 3e20 323a  gence and i > 2:
+00012a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012a30: 2073 6c6f 7065 5f72 6164 6969 203d 2061   slope_radii = a
+00012a40: 7065 7274 7572 6573 5f6c 6973 745b 2d28  pertures_list[-(
+00012a50: 6a20 2b20 3329 3a2d 6a5d 0a20 2020 2020  j + 3):-j].     
+00012a60: 2020 2020 2020 2020 2020 2073 6c6f 7065             slope
+00012a70: 5f63 6f72 7273 203d 206d 6564 6961 6e63  _corrs = medianc
+00012a80: 6f72 725b 2d28 6a20 2b20 3329 3a2d 6a5d  orr[-(j + 3):-j]
+00012a90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012aa0: 2073 6c6f 7065 203d 206c 696e 7265 6772   slope = linregr
+00012ab0: 6573 7328 736c 6f70 655f 7261 6469 692c  ess(slope_radii,
+00012ac0: 2073 6c6f 7065 5f63 6f72 7273 295b 305d   slope_corrs)[0]
+00012ad0: 0a0a 2020 2020 6966 2076 6572 626f 7365  ..    if verbose
+00012ae0: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
+00012af0: 2866 226c 6f77 2d6d 6564 6961 6e2d 6869  (f"low-median-hi
+00012b00: 6768 3a20 5b7b 636f 7272 6563 7469 6f6e  gh: [{correction
+00012b10: 5f6c 6f77 3a2e 3466 7d20 220a 2020 2020  _low:.4f} ".    
+00012b20: 2020 2020 2020 2020 2020 2066 227b 636f             f"{co
+00012b30: 7272 6563 7469 6f6e 3a2e 3466 7d20 7b63  rrection:.4f} {c
+00012b40: 6f72 7265 6374 696f 6e5f 7570 3a2e 3466  orrection_up:.4f
+00012b50: 7d5d 2229 290a 0a20 2020 2020 2020 2070  }]"))..        p
+00012b60: 7269 6e74 2866 274e 6561 7265 7374 2061  rint(f'Nearest a
+00012b70: 7065 7274 7572 653a 207b 6669 6e61 6c5f  perture: {final_
+00012b80: 7261 6469 7573 7d27 290a 0a20 2020 2020  radius}')..     
+00012b90: 2020 2069 6620 6368 6563 6b5f 636f 6e76     if check_conv
+00012ba0: 6572 6765 6e63 653a 0a20 2020 2020 2020  ergence:.       
+00012bb0: 2020 2020 2070 7269 6e74 2866 2753 6c6f       print(f'Slo
+00012bc0: 7065 206f 6620 6c61 7374 2033 2061 7065  pe of last 3 ape
+00012bd0: 7274 7572 6573 3a20 7b73 6c6f 7065 3a2e  rtures: {slope:.
+00012be0: 3265 7d5c 6e27 290a 0a20 2020 2063 6f6e  2e}\n')..    con
+00012bf0: 7665 7267 656e 6365 203d 204e 6f6e 650a  vergence = None.
+00012c00: 0a20 2020 2069 6620 6368 6563 6b5f 636f  .    if check_co
+00012c10: 6e76 6572 6765 6e63 653a 0a20 2020 2020  nvergence:.     
+00012c20: 2020 2069 6620 6162 7328 736c 6f70 6529     if abs(slope)
+00012c30: 203e 2063 6f6e 7665 7267 656e 6365 5f73   > convergence_s
+00012c40: 6c6f 7065 3a0a 2020 2020 2020 2020 2020  lope:.          
+00012c50: 2020 636f 6e76 6572 6765 6e63 6520 3d20    convergence = 
+00012c60: 224e 6f74 5f63 6f6e 7665 7267 6564 220a  "Not_converged".
+00012c70: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00012c80: 7428 2866 2757 6172 6e69 6e67 3a20 6170  t((f'Warning: ap
+00012c90: 6572 7475 7265 2063 6f72 7265 6374 696f  erture correctio
+00012ca0: 6e20 6973 206e 6f74 2073 7461 626c 6520  n is not stable 
+00012cb0: 6174 2074 6865 2073 656c 6563 7465 6427  at the selected'
+00012cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012cd0: 2020 2020 6627 2061 7065 7274 7572 6520      f' aperture 
+00012ce0: 666f 7220 6669 6c74 6572 207b 6669 6c74  for filter {filt
+00012cf0: 7d2e 2053 6c6f 7065 3a20 7b73 6c6f 7065  }. Slope: {slope
+00012d00: 3a2e 3265 7d27 2929 0a20 2020 2020 2020  :.2e}')).       
+00012d10: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00012d20: 2020 2063 6f6e 7665 7267 656e 6365 203d     convergence =
+00012d30: 2022 436f 6e76 6572 6765 6422 0a0a 2020   "Converged"..  
+00012d40: 2020 2320 5772 6974 6520 746f 2066 696c    # Write to fil
+00012d50: 650a 2020 2020 7769 7468 206f 7065 6e28  e.    with open(
+00012d60: 7361 7665 5f66 696c 652c 2027 6127 2920  save_file, 'a') 
+00012d70: 6173 2066 3a0a 2020 2020 2020 2020 662e  as f:.        f.
+00012d80: 7772 6974 6528 6627 5350 4c55 535f 7b66  write(f'SPLUS_{f
+00012d90: 696c 747d 207b 636f 7272 6563 7469 6f6e  ilt} {correction
+00012da0: 7d20 7b63 6f72 7265 6374 696f 6e5f 6c6f  } {correction_lo
+00012db0: 777d 207b 636f 7272 6563 7469 6f6e 5f75  w} {correction_u
+00012dc0: 707d 2729 0a0a 2020 2020 2020 2020 6966  p}')..        if
+00012dd0: 2063 6865 636b 5f63 6f6e 7665 7267 656e   check_convergen
+00012de0: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
+00012df0: 662e 7772 6974 6528 6627 207b 636f 6e76  f.write(f' {conv
+00012e00: 6572 6765 6e63 657d 2729 0a0a 2020 2020  ergence}')..    
+00012e10: 2020 2020 662e 7772 6974 6528 275c 6e27      f.write('\n'
+00012e20: 290a 0a20 2020 2064 656c 2073 656c 6563  )..    del selec
+00012e30: 740a 0a0a 6465 6620 7374 6172 5f73 656c  t...def star_sel
+00012e40: 6563 746f 7228 6361 7461 6c6f 672c 2073  ector(catalog, s
+00012e50: 326e 6375 7420 3d20 2833 302c 2031 3030  2ncut = (30, 100
+00012e60: 3029 2c20 7374 6172 6375 7420 3d20 302e  0), starcut = 0.
+00012e70: 392c 0a20 2020 2020 2020 2020 2020 2020  9,.             
+00012e80: 2020 2020 206d 6167 5f70 6172 7469 7469       mag_partiti
+00012e90: 6f6e 203d 2032 2c20 7665 7262 6f73 6520  on = 2, verbose 
+00012ea0: 3d20 4661 6c73 6529 3a0a 2020 2020 2222  = False):.    ""
+00012eb0: 220a 2020 2020 5365 6c65 6374 7320 7468  ".    Selects th
+00012ec0: 6520 7374 6172 7320 666f 7220 7468 6520  e stars for the 
+00012ed0: 6170 6572 7475 7265 2063 6f72 7265 6374  aperture correct
+00012ee0: 696f 6e0a 0a20 2020 2050 6172 616d 6574  ion..    Paramet
+00012ef0: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
+00012f00: 2d2d 0a20 2020 2063 6174 616c 6f67 203a  --.    catalog :
+00012f10: 2061 7374 726f 7079 2054 6162 6c65 0a20   astropy Table. 
+00012f20: 2020 2020 2020 204c 6f61 6465 6420 6669         Loaded fi
+00012f30: 7473 2063 6174 616c 6f67 2061 7320 616e  ts catalog as an
+00012f40: 2061 7374 726f 7079 2074 6162 6c65 0a20   astropy table. 
+00012f50: 2020 2073 326e 6375 7420 3a20 6c69 7374     s2ncut : list
+00012f60: 0a20 2020 2020 2020 204d 696e 2061 6e64  .        Min and
+00012f70: 206d 6178 2076 616c 7565 7320 6f66 2073   max values of s
+00012f80: 6967 6e61 6c2d 746f 2d6e 6f69 7365 2074  ignal-to-noise t
+00012f90: 6f20 636f 6e73 6964 6572 0a20 2020 2073  o consider.    s
+00012fa0: 7461 7263 7574 203a 2066 6c6f 6174 0a20  tarcut : float. 
+00012fb0: 2020 2020 2020 204d 696e 2076 616c 7565         Min value
+00012fc0: 206f 6620 5345 7874 7261 6374 6f72 2043   of SExtractor C
+00012fd0: 4c41 5353 5f53 5441 5220 746f 2063 6f6e  LASS_STAR to con
+00012fe0: 7369 6465 720a 2020 2020 6d61 675f 7061  sider.    mag_pa
+00012ff0: 7274 6974 696f 6e20 3a20 666c 6f61 740a  rtition : float.
+00013000: 2020 2020 2020 2020 6f75 7420 6f66 2074          out of t
+00013010: 6865 2073 7461 7273 2073 656c 6563 7465  he stars selecte
+00013020: 6420 7769 7468 2063 7269 7465 7269 6120  d with criteria 
+00013030: 6162 6f76 652c 2067 6574 2074 6865 2031  above, get the 1
+00013040: 2f6d 6167 5f70 6172 7469 7469 6f6e 0a20  /mag_partition. 
+00013050: 2020 2020 2020 2073 616d 706c 6520 7769         sample wi
+00013060: 7468 206c 6f77 6572 206d 6167 6e69 7475  th lower magnitu
+00013070: 6465 730a 2020 2020 7665 7262 6f73 6520  des.    verbose 
+00013080: 3a20 626f 6f6c 0a20 2020 2020 2020 2070  : bool.        p
+00013090: 7269 6e74 2064 6574 6169 6c73 206f 6620  rint details of 
+000130a0: 7468 6520 7072 6f63 6573 730a 0a20 2020  the process..   
+000130b0: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
+000130c0: 2d2d 2d2d 0a20 2020 2061 7374 726f 7079  ----.    astropy
+000130d0: 2054 6162 6c65 0a20 2020 2020 2020 2053   Table.        S
+000130e0: 656c 6563 7465 6420 7374 6172 7320 6461  elected stars da
+000130f0: 7461 0a20 2020 2022 2222 0a0a 2020 2020  ta.    """..    
+00013100: 2320 4361 6c63 756c 6174 6520 7468 6520  # Calculate the 
+00013110: 7332 6e0a 2020 2020 7332 6e20 3d20 6361  s2n.    s2n = ca
+00013120: 7461 6c6f 675b 2746 4c55 585f 4155 544f  talog['FLUX_AUTO
+00013130: 275d 202f 2063 6174 616c 6f67 5b27 464c  '] / catalog['FL
+00013140: 5558 4552 525f 4155 544f 275d 0a0a 2020  UXERR_AUTO']..  
+00013150: 2020 2320 4170 706c 7920 7365 6c65 6374    # Apply select
+00013160: 696f 6e20 636f 6e64 6974 696f 6e73 0a20  ion conditions. 
+00013170: 2020 2063 6f6e 6469 7469 6f6e 7320 3d20     conditions = 
+00013180: 2828 6361 7461 6c6f 675b 2743 4c41 5353  ((catalog['CLASS
+00013190: 5f53 5441 5227 5d20 3e20 7374 6172 6375  _STAR'] > starcu
+000131a0: 7429 2026 0a20 2020 2020 2020 2020 2020  t) &.           
+000131b0: 2020 2020 2020 2028 7332 6e20 3e20 7332         (s2n > s2
+000131c0: 6e63 7574 5b30 5d29 2026 0a20 2020 2020  ncut[0]) &.     
+000131d0: 2020 2020 2020 2020 2020 2020 2028 7332               (s2
+000131e0: 6e20 3c20 7332 6e63 7574 5b31 5d29 2026  n < s2ncut[1]) &
+000131f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013200: 2020 2028 6361 7461 6c6f 675b 2746 4c41     (catalog['FLA
+00013210: 4753 275d 203d 3d20 3029 290a 0a20 2020  GS'] == 0))..   
+00013220: 2073 656c 6563 7420 3d20 6361 7461 6c6f   select = catalo
+00013230: 675b 636f 6e64 6974 696f 6e73 5d0a 0a20  g[conditions].. 
+00013240: 2020 2069 6620 7665 7262 6f73 653a 0a20     if verbose:. 
+00013250: 2020 2020 2020 2070 7269 6e74 2866 2253         print(f"S
+00013260: 656c 6563 7465 6420 7374 6172 733a 207b  elected stars: {
+00013270: 6c65 6e28 7365 6c65 6374 297d 2229 0a0a  len(select)}")..
+00013280: 2020 2020 2320 5365 6c65 6374 2077 656c      # Select wel
+00013290: 6c20 6265 6861 7665 6420 4657 484d 0a20  l behaved FWHM. 
+000132a0: 2020 2069 6e66 6572 696f 722c 206d 6564     inferior, med
+000132b0: 6961 6e46 5748 4d2c 2073 7570 6572 696f  ianFWHM, superio
+000132c0: 7220 3d20 6e70 2e70 6572 6365 6e74 696c  r = np.percentil
+000132d0: 6528 7365 6c65 6374 5b27 4657 484d 5f57  e(select['FWHM_W
+000132e0: 4f52 4c44 275d 2c0a 2020 2020 2020 2020  ORLD'],.        
+000132f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013310: 2020 2020 2020 2020 2020 205b 3136 2c20             [16, 
+00013320: 3530 2c20 3834 5d29 0a0a 2020 2020 636f  50, 84])..    co
+00013330: 6e64 6974 696f 6e73 3220 3d20 2828 7365  nditions2 = ((se
+00013340: 6c65 6374 5b27 4657 484d 5f57 4f52 4c44  lect['FWHM_WORLD
+00013350: 275d 203e 2069 6e66 6572 696f 7229 2026  '] > inferior) &
+00013360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013370: 2020 2020 2873 656c 6563 745b 2746 5748      (select['FWH
+00013380: 4d5f 574f 524c 4427 5d20 3c20 7375 7065  M_WORLD'] < supe
+00013390: 7269 6f72 2929 0a0a 2020 2020 7365 6c65  rior))..    sele
+000133a0: 6374 203d 2073 656c 6563 745b 636f 6e64  ct = select[cond
+000133b0: 6974 696f 6e73 325d 0a0a 2020 2020 6966  itions2]..    if
+000133c0: 2076 6572 626f 7365 3a0a 2020 2020 2020   verbose:.      
+000133d0: 2020 7072 696e 7428 6622 4d65 6469 616e    print(f"Median
+000133e0: 2046 5748 4d20 666f 7220 6669 656c 643a   FWHM for field:
+000133f0: 207b 6d65 6469 616e 4657 484d 3a2e 3466   {medianFWHM:.4f
+00013400: 7d22 290a 2020 2020 2020 2020 7072 696e  }").        prin
+00013410: 7428 6622 4166 7465 7220 4657 484d 2063  t(f"After FWHM c
+00013420: 7574 3a20 7b6c 656e 2873 656c 6563 7429  ut: {len(select)
+00013430: 7d22 290a 0a20 2020 2023 2042 7269 6768  }")..    # Brigh
+00013440: 7465 7374 206f 6620 7468 6520 6265 7374  test of the best
+00013450: 3a0a 2020 2020 7365 6c65 6374 2e73 6f72  :.    select.sor
+00013460: 7428 274d 4147 5f41 5554 4f27 290a 2020  t('MAG_AUTO').  
+00013470: 2020 7365 6c65 6374 203d 2073 656c 6563    select = selec
+00013480: 745b 303a 696e 7428 6c65 6e28 7365 6c65  t[0:int(len(sele
+00013490: 6374 2920 2f20 6d61 675f 7061 7274 6974  ct) / mag_partit
+000134a0: 696f 6e29 5d0a 0a20 2020 2069 6620 7665  ion)]..    if ve
+000134b0: 7262 6f73 653a 0a20 2020 2020 2020 2070  rbose:.        p
+000134c0: 7269 6e74 2866 2241 6674 6572 2062 7269  rint(f"After bri
+000134d0: 6768 7465 7374 2031 2f7b 6d61 675f 7061  ghtest 1/{mag_pa
+000134e0: 7274 6974 696f 6e7d 2063 7574 3a20 7b6c  rtition} cut: {l
+000134f0: 656e 2873 656c 6563 7429 7d5c 6e22 290a  en(select)}\n").
+00013500: 0a20 2020 2072 6574 7572 6e20 7365 6c65  .    return sele
+00013510: 6374 2c20 6d65 6469 616e 4657 484d 0a0a  ct, medianFWHM..
+00013520: 0a64 6566 2067 726f 7774 685f 6375 7276  .def growth_curv
+00013530: 6528 6361 7461 6c6f 672c 2073 326e 6375  e(catalog, s2ncu
+00013540: 7420 3d20 2833 302c 2031 3030 3029 2c20  t = (30, 1000), 
+00013550: 7374 6172 6375 7420 3d20 302e 392c 0a20  starcut = 0.9,. 
+00013560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013570: 6d61 675f 7061 7274 6974 696f 6e3d 322c  mag_partition=2,
+00013580: 2076 6572 626f 7365 203d 2046 616c 7365   verbose = False
+00013590: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
+000135a0: 616c 6375 6c61 7465 7320 7468 6520 6772  alculates the gr
+000135b0: 6f77 7468 2063 7572 7665 2028 6d61 676e  owth curve (magn
+000135c0: 6974 7564 6520 696e 2072 6164 6975 7320  itude in radius 
+000135d0: 4b2b 3120 2d20 6d61 676e 6974 7564 6520  K+1 - magnitude 
+000135e0: 696e 0a20 2020 2072 6164 6975 7320 4b29  in.    radius K)
+000135f0: 2066 6f72 2061 2066 696c 7465 7220 696e   for a filter in
+00013600: 2061 2066 6965 6c64 2066 726f 6d20 6120   a field from a 
+00013610: 7365 7874 7261 6374 6f72 2063 6174 616c  sextractor catal
+00013620: 6f67 7565 0a0a 2020 2020 5061 7261 6d65  ogue..    Parame
+00013630: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+00013640: 2d2d 2d0a 2020 2020 6361 7461 6c6f 6720  ---.    catalog 
+00013650: 3a20 6173 7472 6f70 7920 5461 626c 650a  : astropy Table.
+00013660: 2020 2020 2020 2020 4c6f 6164 6564 2066          Loaded f
+00013670: 6974 7320 6361 7461 6c6f 6720 6173 2061  its catalog as a
+00013680: 6e20 6173 7472 6f70 7920 7461 626c 650a  n astropy table.
+00013690: 2020 2020 7332 6e63 7574 203a 206c 6973      s2ncut : lis
+000136a0: 740a 2020 2020 2020 2020 4d69 6e20 616e  t.        Min an
+000136b0: 6420 6d61 7820 7661 6c75 6573 206f 6620  d max values of 
+000136c0: 7369 676e 616c 2d74 6f2d 6e6f 6973 6520  signal-to-noise 
+000136d0: 746f 2063 6f6e 7369 6465 720a 2020 2020  to consider.    
+000136e0: 7374 6172 6375 7420 3a20 666c 6f61 740a  starcut : float.
+000136f0: 2020 2020 2020 2020 4d69 6e20 7661 6c75          Min valu
+00013700: 6520 6f66 2053 4578 7472 6163 746f 7220  e of SExtractor 
+00013710: 434c 4153 535f 5354 4152 2074 6f20 636f  CLASS_STAR to co
+00013720: 6e73 6964 6572 0a20 2020 206d 6167 5f70  nsider.    mag_p
+00013730: 6172 7469 7469 6f6e 203a 2066 6c6f 6174  artition : float
+00013740: 0a20 2020 2020 2020 206f 7574 206f 6620  .        out of 
+00013750: 7468 6520 7374 6172 7320 7365 6c65 6374  the stars select
+00013760: 6564 2077 6974 6820 6372 6974 6572 6961  ed with criteria
+00013770: 2061 626f 7665 2c20 6765 7420 7468 6520   above, get the 
+00013780: 312f 6d61 675f 7061 7274 6974 696f 6e0a  1/mag_partition.
+00013790: 2020 2020 2020 2020 7361 6d70 6c65 2077          sample w
+000137a0: 6974 6820 6c6f 7765 7220 6d61 676e 6974  ith lower magnit
+000137b0: 7564 6573 0a20 2020 2076 6572 626f 7365  udes.    verbose
+000137c0: 203a 2062 6f6f 6c0a 2020 2020 2020 2020   : bool.        
+000137d0: 7072 696e 7420 6465 7461 696c 7320 6f66  print details of
+000137e0: 2074 6865 2070 726f 6365 7373 0a0a 2020   the process..  
+000137f0: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+00013800: 2d2d 2d2d 2d0a 2020 2020 6e70 2e6e 6461  -----.    np.nda
+00013810: 7272 6179 0a20 2020 2020 2020 206e 756d  rray.        num
+00013820: 7079 2061 7272 6179 206f 6620 7368 6170  py array of shap
+00013830: 6520 2835 2c20 6c65 6e28 6170 6572 7475  e (5, len(apertu
+00013840: 7265 5f72 6164 6969 292d 3129 2063 6f6e  re_radii)-1) con
+00013850: 7461 696e 696e 672c 2069 6e20 6f72 6465  taining, in orde
+00013860: 723a 0a20 2020 2020 2020 2020 2020 206c  r:.            l
+00013870: 6f77 6572 2062 6f75 6e64 206f 6620 7468  ower bound of th
+00013880: 6520 3935 2520 636f 6e66 6964 656e 6365  e 95% confidence
+00013890: 2072 6567 696f 6e20 6f66 2074 6865 2067   region of the g
+000138a0: 726f 7774 6820 6375 7276 650a 2020 2020  rowth curve.    
+000138b0: 2020 2020 2020 2020 6c6f 7765 7220 626f          lower bo
+000138c0: 756e 6420 6f66 2074 6865 2036 3825 2063  und of the 68% c
+000138d0: 6f6e 6669 6465 6e63 6520 7265 6769 6f6e  onfidence region
+000138e0: 206f 6620 7468 6520 6772 6f77 7468 2063   of the growth c
+000138f0: 7572 7665 0a20 2020 2020 2020 2020 2020  urve.           
+00013900: 206d 6564 6961 6e20 6f66 2074 6865 2067   median of the g
+00013910: 726f 7774 6820 6375 7276 650a 2020 2020  rowth curve.    
+00013920: 2020 2020 2020 2020 6869 6768 6572 2062          higher b
+00013930: 6f75 6e64 206f 6620 7468 6520 3638 2520  ound of the 68% 
+00013940: 636f 6e66 6964 656e 6365 2072 6567 696f  confidence regio
+00013950: 6e20 6f66 2074 6865 2067 726f 7774 6820  n of the growth 
+00013960: 6375 7276 650a 2020 2020 2020 2020 2020  curve.          
+00013970: 2020 6869 6768 6572 2062 6f75 6e64 206f    higher bound o
+00013980: 6620 7468 6520 3935 2520 636f 6e66 6964  f the 95% confid
+00013990: 656e 6365 2072 6567 696f 6e20 6f66 2074  ence region of t
+000139a0: 6865 2067 726f 7774 6820 6375 7276 650a  he growth curve.
+000139b0: 2020 2020 666c 6f61 740a 2020 2020 2020      float.      
+000139c0: 2020 6d65 6469 616e 2046 5748 4d20 6f66    median FWHM of
+000139d0: 2073 7461 7273 0a20 2020 2069 6e74 0a20   stars.    int. 
+000139e0: 2020 2020 2020 206e 756d 6265 7220 6f66         number of
+000139f0: 2073 656c 6563 7465 6420 7374 6172 730a   selected stars.
+00013a00: 2020 2020 2222 220a 0a20 2020 2073 6578      """..    sex
+00013a10: 7472 6163 746f 725f 7461 626c 6520 3d20  tractor_table = 
+00013a20: 5461 626c 652e 7265 6164 2863 6174 616c  Table.read(catal
+00013a30: 6f67 290a 0a20 2020 2073 656c 6563 742c  og)..    select,
+00013a40: 206d 6564 6961 6e46 5748 4d20 3d20 7374   medianFWHM = st
+00013a50: 6172 5f73 656c 6563 746f 7228 6361 7461  ar_selector(cata
+00013a60: 6c6f 6720 3d20 7365 7874 7261 6374 6f72  log = sextractor
+00013a70: 5f74 6162 6c65 2c0a 2020 2020 2020 2020  _table,.        
+00013a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a90: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00013aa0: 326e 6375 7420 2020 2020 2020 203d 2073  2ncut        = s
+00013ab0: 326e 6375 742c 0a20 2020 2020 2020 2020  2ncut,.         
 00013ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ad0: 2020 2020 2020 2020 2020 2073 326e 6375             s2ncu
-00013ae0: 7420 2020 2020 2020 203d 2073 326e 6375  t        = s2ncu
-00013af0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00013ad0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+00013ae0: 6172 6375 7420 2020 2020 2020 3d20 7374  arcut       = st
+00013af0: 6172 6375 742c 0a20 2020 2020 2020 2020  arcut,.         
 00013b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b10: 2020 2020 2020 2020 2020 7374 6172 6375            starcu
-00013b20: 7420 2020 2020 2020 3d20 7374 6172 6375  t       = starcu
-00013b30: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00013b10: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00013b20: 675f 7061 7274 6974 696f 6e20 3d20 6d61  g_partition = ma
+00013b30: 675f 7061 7274 6974 696f 6e2c 0a20 2020  g_partition,.   
 00013b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b50: 2020 2020 2020 2020 2020 6d61 675f 7061            mag_pa
-00013b60: 7274 6974 696f 6e20 3d20 6d61 675f 7061  rtition = mag_pa
-00013b70: 7274 6974 696f 6e2c 0a20 2020 2020 2020  rtition,.       
-00013b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ba0: 7665 7262 6f73 6520 2020 2020 2020 3d20  verbose       = 
-00013bb0: 7665 7262 6f73 6529 0a0a 2020 2020 6d6c  verbose)..    ml
-00013bc0: 6973 7420 3d20 5b5d 0a20 2020 2066 6f72  ist = [].    for
-00013bd0: 2073 7461 7220 696e 2073 656c 6563 743a   star in select:
-00013be0: 0a20 2020 2020 2020 206d 6167 7320 3d20  .        mags = 
-00013bf0: 6e70 2e64 6966 6628 7374 6172 5b27 4d41  np.diff(star['MA
-00013c00: 475f 4150 4552 275d 290a 2020 2020 2020  G_APER']).      
-00013c10: 2020 6d6c 6973 742e 6170 7065 6e64 286d    mlist.append(m
-00013c20: 6167 7329 0a0a 2020 2020 7065 7263 656e  ags)..    percen
-00013c30: 7469 6c65 203d 206e 702e 7065 7263 656e  tile = np.percen
-00013c40: 7469 6c65 286d 6c69 7374 2c20 5b32 2e35  tile(mlist, [2.5
-00013c50: 2c20 3136 2c20 3530 2c20 3834 2c20 3937  , 16, 50, 84, 97
-00013c60: 2e35 5d2c 2061 7869 733d 3029 0a20 2020  .5], axis=0).   
-00013c70: 206d 696e 6d61 6732 2c20 6d69 6e6d 6167   minmag2, minmag
-00013c80: 2c20 6d65 6469 616e 6d61 672c 206d 6178  , medianmag, max
-00013c90: 6d61 672c 206d 6178 6d61 6732 203d 2070  mag, maxmag2 = p
-00013ca0: 6572 6365 6e74 696c 650a 0a20 2020 2072  ercentile..    r
-00013cb0: 6573 756c 7420 3d20 6e70 2e61 7272 6179  esult = np.array
-00013cc0: 285b 6d69 6e6d 6167 322c 206d 696e 6d61  ([minmag2, minma
-00013cd0: 672c 206d 6564 6961 6e6d 6167 2c20 6d61  g, medianmag, ma
-00013ce0: 786d 6167 2c20 6d61 786d 6167 325d 290a  xmag, maxmag2]).
-00013cf0: 0a20 2020 2072 6574 7572 6e20 7265 7375  .    return resu
-00013d00: 6c74 2c20 6d65 6469 616e 4657 484d 2c20  lt, medianFWHM, 
-00013d10: 6c65 6e28 7365 6c65 6374 290a 0a0a 6465  len(select)...de
-00013d20: 6620 6772 6f77 7468 5f63 7572 7665 5f70  f growth_curve_p
-00013d30: 6c6f 7474 6572 2863 6174 616c 6f67 2c20  lotter(catalog, 
-00013d40: 6669 6c74 2c20 7365 7863 6f6e 662c 2073  filt, sexconf, s
-00013d50: 6176 655f 6669 6c65 2c20 6170 6572 7475  ave_file, apertu
-00013d60: 7265 2c0a 2020 2020 2020 2020 2020 2020  re,.            
-00013d70: 2020 2020 2020 2020 2020 2020 206d 6178               max
-00013d80: 5f61 7065 7274 7572 6520 3d20 3732 2e37  _aperture = 72.7
-00013d90: 3237 3237 2c20 7374 6172 6375 743d 2e39  2727, starcut=.9
-00013da0: 2c20 7332 6e63 7574 3d28 3330 2c20 3130  , s2ncut=(30, 10
-00013db0: 3030 292c 0a20 2020 2020 2020 2020 2020  00),.           
-00013dc0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00013dd0: 675f 7061 7274 6974 696f 6e3d 322c 2076  g_partition=2, v
-00013de0: 6572 626f 7365 203d 2046 616c 7365 293a  erbose = False):
-00013df0: 0a20 2020 2022 2222 0a20 2020 2047 656e  .    """.    Gen
-00013e00: 6572 6174 6573 2061 6e64 2070 6c6f 7473  erates and plots
-00013e10: 2074 6865 2066 6965 6c64 2773 2067 726f   the field's gro
-00013e20: 7774 6820 6375 7276 6520 666f 7220 6120  wth curve for a 
-00013e30: 6769 7665 6e20 6669 6c74 6572 0a0a 2020  given filter..  
-00013e40: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-00013e50: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-00013e60: 6361 7461 6c6f 6720 3a20 7374 720a 2020  catalog : str.  
-00013e70: 2020 2020 2020 4c6f 6361 7469 6f6e 206f        Location o
-00013e80: 6620 5345 7874 7261 6374 6f72 206f 7574  f SExtractor out
-00013e90: 7075 7420 6361 7461 6c6f 6720 7769 7468  put catalog with
-00013ea0: 2074 6865 206d 6561 7375 7265 6420 6669   the measured fi
-00013eb0: 7865 6420 6170 6572 7475 7265 730a 2020  xed apertures.  
-00013ec0: 2020 6669 6c74 203a 2073 7472 0a20 2020    filt : str.   
-00013ed0: 2020 2020 204e 616d 6520 6f66 2074 6865       Name of the
-00013ee0: 2066 696c 7465 720a 2020 2020 7365 7863   filter.    sexc
-00013ef0: 6f6e 6620 3a20 7374 720a 2020 2020 2020  onf : str.      
-00013f00: 2020 4c6f 6361 7469 6f6e 206f 6620 7365    Location of se
-00013f10: 7863 6f6e 6669 6720 6669 6c65 2066 6f72  xconfig file for
-00013f20: 2074 6869 7320 6669 6c74 6572 2773 2070   this filter's p
-00013f30: 686f 746f 6d65 7472 790a 2020 2020 7361  hotometry.    sa
-00013f40: 7665 5f66 696c 6520 3a20 7374 720a 2020  ve_file : str.  
-00013f50: 2020 2020 2020 4465 7369 7265 6420 6c6f        Desired lo
-00013f60: 6361 7469 6f6e 2074 6f20 7361 7665 2074  cation to save t
-00013f70: 6865 2070 6c6f 7420 6f66 2074 6865 2067  he plot of the g
-00013f80: 726f 7774 6820 6375 7276 650a 2020 2020  rowth curve.    
-00013f90: 6170 6572 7475 7265 203a 2066 6c6f 6174  aperture : float
-00013fa0: 0a20 2020 2020 2020 2042 6173 6520 6170  .        Base ap
-00013fb0: 6572 7475 7265 2064 6961 6d65 7465 7220  erture diameter 
-00013fc0: 2870 6978 656c 7329 2077 6869 6368 2077  (pixels) which w
-00013fd0: 696c 6c20 6861 7665 2074 6865 2063 6f72  ill have the cor
-00013fe0: 7265 6374 696f 6e20 6573 7469 6d61 7465  rection estimate
-00013ff0: 640a 2020 2020 6d61 785f 6170 6572 7475  d.    max_apertu
-00014000: 7265 203a 2073 7472 0a20 2020 2020 2020  re : str.       
-00014010: 2054 6865 206d 6178 696d 756d 2061 7065   The maximum ape
-00014020: 7274 7572 6520 6469 616d 6574 6572 2069  rture diameter i
-00014030: 6e20 7069 7865 6c73 0a20 2020 2073 326e  n pixels.    s2n
-00014040: 6375 7420 3a20 6c69 7374 0a20 2020 2020  cut : list.     
-00014050: 2020 204d 696e 2061 6e64 206d 6178 2076     Min and max v
-00014060: 616c 7565 7320 6f66 2073 6967 6e61 6c2d  alues of signal-
-00014070: 746f 2d6e 6f69 7365 2074 6f20 636f 6e73  to-noise to cons
-00014080: 6964 6572 0a20 2020 2073 7461 7263 7574  ider.    starcut
-00014090: 203a 2066 6c6f 6174 0a20 2020 2020 2020   : float.       
-000140a0: 204d 696e 2076 616c 7565 206f 6620 5345   Min value of SE
-000140b0: 7874 7261 6374 6f72 2043 4c41 5353 5f53  xtractor CLASS_S
-000140c0: 5441 5220 746f 2063 6f6e 7369 6465 720a  TAR to consider.
-000140d0: 2020 2020 6d61 675f 7061 7274 6974 696f      mag_partitio
-000140e0: 6e20 3a20 666c 6f61 740a 2020 2020 2020  n : float.      
-000140f0: 2020 6f75 7420 6f66 2074 6865 2073 7461    out of the sta
-00014100: 7273 2073 656c 6563 7465 6420 7769 7468  rs selected with
-00014110: 2063 7269 7465 7269 6120 6162 6f76 652c   criteria above,
-00014120: 2067 6574 2074 6865 2031 2f6d 6167 5f70   get the 1/mag_p
-00014130: 6172 7469 7469 6f6e 0a20 2020 2020 2020  artition.       
-00014140: 2073 616d 706c 6520 7769 7468 206c 6f77   sample with low
-00014150: 6572 206d 6167 6e69 7475 6465 730a 2020  er magnitudes.  
-00014160: 2020 7665 7262 6f73 6520 3a20 626f 6f6c    verbose : bool
-00014170: 0a20 2020 2020 2020 2070 7269 6e74 2064  .        print d
-00014180: 6574 6169 6c73 206f 6620 7468 6520 7072  etails of the pr
-00014190: 6f63 6573 730a 0a0a 2020 2020 5265 7475  ocess...    Retu
-000141a0: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-000141b0: 2020 2020 5361 7665 7320 706c 6f74 206f      Saves plot o
-000141c0: 6620 7468 6520 6772 6f77 7468 2063 7572  f the growth cur
-000141d0: 7665 0a20 2020 2022 2222 0a0a 2020 2020  ve.    """..    
-000141e0: 2320 4765 7420 6170 6572 7475 7265 206c  # Get aperture l
-000141f0: 6973 740a 2020 2020 2320 4469 616d 6574  ist.    # Diamet
-00014200: 6572 7320 2869 6e20 7069 7865 6c73 290a  ers (in pixels).
-00014210: 2020 2020 6170 6572 7475 7265 735f 6c69      apertures_li
-00014220: 7374 203d 2067 6574 5f61 7065 7274 7572  st = get_apertur
-00014230: 6573 5f66 726f 6d5f 7365 7863 6f6e 6628  es_from_sexconf(
-00014240: 7365 7863 6f6e 6629 2020 2320 7479 7065  sexconf)  # type
-00014250: 3a20 6e70 2e6e 6461 7272 6179 0a0a 2020  : np.ndarray..  
-00014260: 2020 6966 2061 7065 7274 7572 6573 5f6c    if apertures_l
-00014270: 6973 7420 6973 204e 6f6e 653a 0a20 2020  ist is None:.   
-00014280: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00014290: 4572 726f 7228 6622 436f 756c 6420 6e6f  Error(f"Could no
-000142a0: 7420 6669 6e64 2070 6172 616d 2050 484f  t find param PHO
-000142b0: 545f 4150 4552 5455 5245 5320 696e 207b  T_APERTURES in {
-000142c0: 7365 7863 6f6e 667d 2e22 290a 0a20 2020  sexconf}.")..   
-000142d0: 2072 6573 756c 742c 206d 6564 6961 6e46   result, medianF
-000142e0: 5748 4d2c 2073 7461 7263 6f75 6e74 203d  WHM, starcount =
-000142f0: 2067 726f 7774 685f 6375 7276 6528 6361   growth_curve(ca
-00014300: 7461 6c6f 6720 3d20 6361 7461 6c6f 672c  talog = catalog,
-00014310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013b60: 2020 2020 7665 7262 6f73 6520 2020 2020      verbose     
+00013b70: 2020 3d20 7665 7262 6f73 6529 0a0a 2020    = verbose)..  
+00013b80: 2020 6d6c 6973 7420 3d20 5b5d 0a20 2020    mlist = [].   
+00013b90: 2066 6f72 2073 7461 7220 696e 2073 656c   for star in sel
+00013ba0: 6563 743a 0a20 2020 2020 2020 206d 6167  ect:.        mag
+00013bb0: 7320 3d20 6e70 2e64 6966 6628 7374 6172  s = np.diff(star
+00013bc0: 5b27 4d41 475f 4150 4552 275d 290a 2020  ['MAG_APER']).  
+00013bd0: 2020 2020 2020 6d6c 6973 742e 6170 7065        mlist.appe
+00013be0: 6e64 286d 6167 7329 0a0a 2020 2020 7065  nd(mags)..    pe
+00013bf0: 7263 656e 7469 6c65 203d 206e 702e 7065  rcentile = np.pe
+00013c00: 7263 656e 7469 6c65 286d 6c69 7374 2c20  rcentile(mlist, 
+00013c10: 5b32 2e35 2c20 3136 2c20 3530 2c20 3834  [2.5, 16, 50, 84
+00013c20: 2c20 3937 2e35 5d2c 2061 7869 733d 3029  , 97.5], axis=0)
+00013c30: 0a20 2020 206d 696e 6d61 6732 2c20 6d69  .    minmag2, mi
+00013c40: 6e6d 6167 2c20 6d65 6469 616e 6d61 672c  nmag, medianmag,
+00013c50: 206d 6178 6d61 672c 206d 6178 6d61 6732   maxmag, maxmag2
+00013c60: 203d 2070 6572 6365 6e74 696c 650a 0a20   = percentile.. 
+00013c70: 2020 2072 6573 756c 7420 3d20 6e70 2e61     result = np.a
+00013c80: 7272 6179 285b 6d69 6e6d 6167 322c 206d  rray([minmag2, m
+00013c90: 696e 6d61 672c 206d 6564 6961 6e6d 6167  inmag, medianmag
+00013ca0: 2c20 6d61 786d 6167 2c20 6d61 786d 6167  , maxmag, maxmag
+00013cb0: 325d 290a 0a20 2020 2072 6574 7572 6e20  2])..    return 
+00013cc0: 7265 7375 6c74 2c20 6d65 6469 616e 4657  result, medianFW
+00013cd0: 484d 2c20 6c65 6e28 7365 6c65 6374 290a  HM, len(select).
+00013ce0: 0a0a 6465 6620 6772 6f77 7468 5f63 7572  ..def growth_cur
+00013cf0: 7665 5f70 6c6f 7474 6572 2863 6174 616c  ve_plotter(catal
+00013d00: 6f67 2c20 6669 6c74 2c20 7365 7863 6f6e  og, filt, sexcon
+00013d10: 662c 2073 6176 655f 6669 6c65 2c20 6170  f, save_file, ap
+00013d20: 6572 7475 7265 2c0a 2020 2020 2020 2020  erture,.        
+00013d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013d40: 206d 6178 5f61 7065 7274 7572 6520 3d20   max_aperture = 
+00013d50: 3732 2e37 3237 3237 2c20 7374 6172 6375  72.72727, starcu
+00013d60: 743d 2e39 2c20 7332 6e63 7574 3d28 3330  t=.9, s2ncut=(30
+00013d70: 2c20 3130 3030 292c 0a20 2020 2020 2020  , 1000),.       
+00013d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013d90: 2020 6d61 675f 7061 7274 6974 696f 6e3d    mag_partition=
+00013da0: 322c 2076 6572 626f 7365 203d 2046 616c  2, verbose = Fal
+00013db0: 7365 293a 0a20 2020 2022 2222 0a20 2020  se):.    """.   
+00013dc0: 2047 656e 6572 6174 6573 2061 6e64 2070   Generates and p
+00013dd0: 6c6f 7473 2074 6865 2066 6965 6c64 2773  lots the field's
+00013de0: 2067 726f 7774 6820 6375 7276 6520 666f   growth curve fo
+00013df0: 7220 6120 6769 7665 6e20 6669 6c74 6572  r a given filter
+00013e00: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00013e10: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+00013e20: 2020 2020 6361 7461 6c6f 6720 3a20 7374      catalog : st
+00013e30: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
+00013e40: 6f6e 206f 6620 5345 7874 7261 6374 6f72  on of SExtractor
+00013e50: 206f 7574 7075 7420 6361 7461 6c6f 6720   output catalog 
+00013e60: 7769 7468 2074 6865 206d 6561 7375 7265  with the measure
+00013e70: 6420 6669 7865 6420 6170 6572 7475 7265  d fixed aperture
+00013e80: 730a 2020 2020 6669 6c74 203a 2073 7472  s.    filt : str
+00013e90: 0a20 2020 2020 2020 204e 616d 6520 6f66  .        Name of
+00013ea0: 2074 6865 2066 696c 7465 720a 2020 2020   the filter.    
+00013eb0: 7365 7863 6f6e 6620 3a20 7374 720a 2020  sexconf : str.  
+00013ec0: 2020 2020 2020 4c6f 6361 7469 6f6e 206f        Location o
+00013ed0: 6620 7365 7863 6f6e 6669 6720 6669 6c65  f sexconfig file
+00013ee0: 2066 6f72 2074 6869 7320 6669 6c74 6572   for this filter
+00013ef0: 2773 2070 686f 746f 6d65 7472 790a 2020  's photometry.  
+00013f00: 2020 7361 7665 5f66 696c 6520 3a20 7374    save_file : st
+00013f10: 720a 2020 2020 2020 2020 4465 7369 7265  r.        Desire
+00013f20: 6420 6c6f 6361 7469 6f6e 2074 6f20 7361  d location to sa
+00013f30: 7665 2074 6865 2070 6c6f 7420 6f66 2074  ve the plot of t
+00013f40: 6865 2067 726f 7774 6820 6375 7276 650a  he growth curve.
+00013f50: 2020 2020 6170 6572 7475 7265 203a 2066      aperture : f
+00013f60: 6c6f 6174 0a20 2020 2020 2020 2042 6173  loat.        Bas
+00013f70: 6520 6170 6572 7475 7265 2064 6961 6d65  e aperture diame
+00013f80: 7465 7220 2870 6978 656c 7329 2077 6869  ter (pixels) whi
+00013f90: 6368 2077 696c 6c20 6861 7665 2074 6865  ch will have the
+00013fa0: 2063 6f72 7265 6374 696f 6e20 6573 7469   correction esti
+00013fb0: 6d61 7465 640a 2020 2020 6d61 785f 6170  mated.    max_ap
+00013fc0: 6572 7475 7265 203a 2073 7472 0a20 2020  erture : str.   
+00013fd0: 2020 2020 2054 6865 206d 6178 696d 756d       The maximum
+00013fe0: 2061 7065 7274 7572 6520 6469 616d 6574   aperture diamet
+00013ff0: 6572 2069 6e20 7069 7865 6c73 0a20 2020  er in pixels.   
+00014000: 2073 326e 6375 7420 3a20 6c69 7374 0a20   s2ncut : list. 
+00014010: 2020 2020 2020 204d 696e 2061 6e64 206d         Min and m
+00014020: 6178 2076 616c 7565 7320 6f66 2073 6967  ax values of sig
+00014030: 6e61 6c2d 746f 2d6e 6f69 7365 2074 6f20  nal-to-noise to 
+00014040: 636f 6e73 6964 6572 0a20 2020 2073 7461  consider.    sta
+00014050: 7263 7574 203a 2066 6c6f 6174 0a20 2020  rcut : float.   
+00014060: 2020 2020 204d 696e 2076 616c 7565 206f       Min value o
+00014070: 6620 5345 7874 7261 6374 6f72 2043 4c41  f SExtractor CLA
+00014080: 5353 5f53 5441 5220 746f 2063 6f6e 7369  SS_STAR to consi
+00014090: 6465 720a 2020 2020 6d61 675f 7061 7274  der.    mag_part
+000140a0: 6974 696f 6e20 3a20 666c 6f61 740a 2020  ition : float.  
+000140b0: 2020 2020 2020 6f75 7420 6f66 2074 6865        out of the
+000140c0: 2073 7461 7273 2073 656c 6563 7465 6420   stars selected 
+000140d0: 7769 7468 2063 7269 7465 7269 6120 6162  with criteria ab
+000140e0: 6f76 652c 2067 6574 2074 6865 2031 2f6d  ove, get the 1/m
+000140f0: 6167 5f70 6172 7469 7469 6f6e 0a20 2020  ag_partition.   
+00014100: 2020 2020 2073 616d 706c 6520 7769 7468       sample with
+00014110: 206c 6f77 6572 206d 6167 6e69 7475 6465   lower magnitude
+00014120: 730a 2020 2020 7665 7262 6f73 6520 3a20  s.    verbose : 
+00014130: 626f 6f6c 0a20 2020 2020 2020 2070 7269  bool.        pri
+00014140: 6e74 2064 6574 6169 6c73 206f 6620 7468  nt details of th
+00014150: 6520 7072 6f63 6573 730a 0a0a 2020 2020  e process...    
+00014160: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+00014170: 2d2d 2d0a 2020 2020 5361 7665 7320 706c  ---.    Saves pl
+00014180: 6f74 206f 6620 7468 6520 6772 6f77 7468  ot of the growth
+00014190: 2063 7572 7665 0a20 2020 2022 2222 0a0a   curve.    """..
+000141a0: 2020 2020 2320 4765 7420 6170 6572 7475      # Get apertu
+000141b0: 7265 206c 6973 740a 2020 2020 2320 4469  re list.    # Di
+000141c0: 616d 6574 6572 7320 2869 6e20 7069 7865  ameters (in pixe
+000141d0: 6c73 290a 2020 2020 6170 6572 7475 7265  ls).    aperture
+000141e0: 735f 6c69 7374 203d 2067 6574 5f61 7065  s_list = get_ape
+000141f0: 7274 7572 6573 5f66 726f 6d5f 7365 7863  rtures_from_sexc
+00014200: 6f6e 6628 7365 7863 6f6e 6629 2020 2320  onf(sexconf)  # 
+00014210: 7479 7065 3a20 6e70 2e6e 6461 7272 6179  type: np.ndarray
+00014220: 0a0a 2020 2020 6966 2061 7065 7274 7572  ..    if apertur
+00014230: 6573 5f6c 6973 7420 6973 204e 6f6e 653a  es_list is None:
+00014240: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
+00014250: 616c 7565 4572 726f 7228 6622 436f 756c  alueError(f"Coul
+00014260: 6420 6e6f 7420 6669 6e64 2070 6172 616d  d not find param
+00014270: 2050 484f 545f 4150 4552 5455 5245 5320   PHOT_APERTURES 
+00014280: 696e 207b 7365 7863 6f6e 667d 2e22 290a  in {sexconf}.").
+00014290: 0a20 2020 2072 6573 756c 742c 206d 6564  .    result, med
+000142a0: 6961 6e46 5748 4d2c 2073 7461 7263 6f75  ianFWHM, starcou
+000142b0: 6e74 203d 2067 726f 7774 685f 6375 7276  nt = growth_curv
+000142c0: 6528 6361 7461 6c6f 6720 3d20 6361 7461  e(catalog = cata
+000142d0: 6c6f 672c 0a20 2020 2020 2020 2020 2020  log,.           
+000142e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014300: 2020 2020 2020 7332 6e63 7574 2020 3d20        s2ncut  = 
+00014310: 7332 6e63 7574 2c0a 2020 2020 2020 2020  s2ncut,.        
 00014320: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00014330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014340: 2020 7332 6e63 7574 2020 3d20 7332 6e63    s2ncut  = s2nc
-00014350: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+00014340: 2020 2020 2020 2020 2073 7461 7263 7574           starcut
+00014350: 203d 2073 7461 7263 7574 2c0a 2020 2020   = starcut,.    
 00014360: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00014370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014380: 2020 2020 2073 7461 7263 7574 203d 2073       starcut = s
-00014390: 7461 7263 7574 2c0a 2020 2020 2020 2020  tarcut,.        
-000143a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014380: 2020 2020 2020 2020 2020 2020 206d 6167               mag
+00014390: 5f70 6172 7469 7469 6f6e 203d 206d 6167  _partition = mag
+000143a0: 5f70 6172 7469 7469 6f6e 2c0a 2020 2020  _partition,.    
 000143b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000143c0: 2020 2020 2020 2020 206d 6167 5f70 6172           mag_par
-000143d0: 7469 7469 6f6e 203d 206d 6167 5f70 6172  tition = mag_par
-000143e0: 7469 7469 6f6e 2c0a 2020 2020 2020 2020  tition,.        
-000143f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014410: 2020 2020 2020 2020 2076 6572 626f 7365           verbose
-00014420: 203d 2076 6572 626f 7365 290a 0a20 2020   = verbose)..   
-00014430: 206d 696e 6d61 6732 2c20 6d69 6e6d 6167   minmag2, minmag
-00014440: 2c20 6d65 6469 616e 6d61 672c 206d 6178  , medianmag, max
-00014450: 6d61 672c 206d 6178 6d61 6732 203d 205b  mag, maxmag2 = [
-00014460: 7820 666f 7220 7820 696e 2072 6573 756c  x for x in resul
-00014470: 745d 0a0a 2020 2020 6469 616d 6574 6572  t]..    diameter
-00014480: 203d 205b 2861 202b 2062 2920 2f20 3220   = [(a + b) / 2 
-00014490: 666f 7220 612c 2062 2069 6e20 7a69 7028  for a, b in zip(
-000144a0: 6170 6572 7475 7265 735f 6c69 7374 5b3a  apertures_list[:
-000144b0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000144c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000144d0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000144e0: 7065 7274 7572 6573 5f6c 6973 745b 313a  pertures_list[1:
-000144f0: 5d29 5d0a 0a20 2020 2023 2050 6c6f 7420  ])]..    # Plot 
-00014500: 6772 6f77 7468 2063 7572 7665 0a20 2020  growth curve.   
-00014510: 2070 6c74 2e66 6967 7572 6528 6669 6773   plt.figure(figs
-00014520: 697a 653d 2835 2c20 3429 290a 0a20 2020  ize=(5, 4))..   
-00014530: 206d 6178 7920 3d20 302e 310a 2020 2020   maxy = 0.1.    
-00014540: 6d69 6e79 203d 202d 302e 350a 0a20 2020  miny = -0.5..   
-00014550: 2023 206d 6564 6961 6e73 0a20 2020 2070   # medians.    p
-00014560: 6c74 2e70 6c6f 7428 6469 616d 6574 6572  lt.plot(diameter
-00014570: 2c20 6d65 6469 616e 6d61 672c 2063 6f6c  , medianmag, col
-00014580: 6f72 3d27 7265 6427 290a 0a20 2020 2023  or='red')..    #
-00014590: 2043 4c36 3820 2620 434c 3935 0a20 2020   CL68 & CL95.   
-000145a0: 2070 6c74 2e66 696c 6c5f 6265 7477 6565   plt.fill_betwee
-000145b0: 6e28 6469 616d 6574 6572 2c20 6d69 6e6d  n(diameter, minm
-000145c0: 6167 2c20 6d61 786d 6167 2c20 636f 6c6f  ag, maxmag, colo
-000145d0: 723d 276f 7261 6e67 6527 2c20 616c 7068  r='orange', alph
-000145e0: 613d 302e 3729 0a20 2020 2070 6c74 2e66  a=0.7).    plt.f
-000145f0: 696c 6c5f 6265 7477 6565 6e28 6469 616d  ill_between(diam
-00014600: 6574 6572 2c20 6d69 6e6d 6167 322c 206d  eter, minmag2, m
-00014610: 6178 6d61 6732 2c20 636f 6c6f 723d 276f  axmag2, color='o
-00014620: 7261 6e67 6527 2c20 616c 7068 613d 302e  range', alpha=0.
-00014630: 3329 0a0a 2020 2020 2320 706c 6f74 206d  3)..    # plot m
-00014640: 6564 6961 6e20 4657 484d 0a20 2020 2070  edian FWHM.    p
-00014650: 6c74 2e70 6c6f 7428 5b6d 6564 6961 6e46  lt.plot([medianF
-00014660: 5748 4d2c 206d 6564 6961 6e46 5748 4d5d  WHM, medianFWHM]
-00014670: 2c20 5b6d 696e 792c 206d 6178 795d 2c20  , [miny, maxy], 
-00014680: 636f 6c6f 723d 2764 6172 6b73 6c61 7465  color='darkslate
-00014690: 6772 6179 272c 0a20 2020 2020 2020 2020  gray',.         
-000146a0: 2020 2020 6c61 6265 6c3d 274d 6564 6961      label='Media
-000146b0: 6e20 4657 484d 2729 0a0a 2020 2020 2320  n FWHM')..    # 
-000146c0: 706c 6f74 2061 7065 7274 7572 650a 2020  plot aperture.  
-000146d0: 2020 706c 742e 706c 6f74 285b 6d61 785f    plt.plot([max_
-000146e0: 6170 6572 7475 7265 2c20 6d61 785f 6170  aperture, max_ap
-000146f0: 6572 7475 7265 5d2c 205b 6d69 6e79 2c20  erture], [miny, 
-00014700: 6d61 7879 5d2c 2027 2d27 2c20 636f 6c6f  maxy], '-', colo
-00014710: 723d 2770 7572 706c 6527 2c0a 2020 2020  r='purple',.    
-00014720: 2020 2020 2020 2020 206c 6162 656c 3d22           label="
-00014730: 7b7d 2070 6978 222e 666f 726d 6174 286d  {} pix".format(m
-00014740: 6178 5f61 7065 7274 7572 6529 290a 0a20  ax_aperture)).. 
-00014750: 2020 2023 2062 6173 6520 6170 6572 7475     # base apertu
-00014760: 7265 0a20 2020 2070 6c74 2e70 6c6f 7428  re.    plt.plot(
-00014770: 5b61 7065 7274 7572 652c 2061 7065 7274  [aperture, apert
-00014780: 7572 655d 2c20 5b6d 696e 792c 206d 6178  ure], [miny, max
-00014790: 795d 2c20 272d 272c 2063 6f6c 6f72 3d27  y], '-', color='
-000147a0: 626c 7565 272c 0a20 2020 2020 2020 2020  blue',.         
-000147b0: 2020 2020 6c61 6265 6c3d 6627 7b61 7065      label=f'{ape
-000147c0: 7274 7572 653a 2e33 667d 2d64 6961 6d65  rture:.3f}-diame
-000147d0: 7465 7227 290a 0a20 2020 2023 2072 6567  ter')..    # reg
-000147e0: 696f 6e20 6172 6f75 6e64 207a 6572 6f0a  ion around zero.
-000147f0: 2020 2020 706c 742e 706c 6f74 285b 302c      plt.plot([0,
-00014800: 206d 6178 2864 6961 6d65 7465 7229 5d2c   max(diameter)],
-00014810: 205b 302c 2030 5d2c 2063 6f6c 6f72 3d27   [0, 0], color='
-00014820: 626c 7565 2729 0a20 2020 2070 6c74 2e66  blue').    plt.f
-00014830: 696c 6c5f 6265 7477 6565 6e28 5b30 2c20  ill_between([0, 
-00014840: 6d61 7828 6469 616d 6574 6572 295d 2c20  max(diameter)], 
-00014850: 5b2d 3165 2d32 2c20 2d31 652d 325d 2c20  [-1e-2, -1e-2], 
-00014860: 5b31 652d 322c 2031 652d 325d 2c0a 2020  [1e-2, 1e-2],.  
-00014870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014880: 2020 2063 6f6c 6f72 3d27 626c 7565 272c     color='blue',
-00014890: 2061 6c70 6861 3d30 2e33 290a 0a20 2020   alpha=0.3)..   
-000148a0: 2023 2050 6c6f 7420 7061 7261 6d65 7465   # Plot paramete
-000148b0: 7273 0a20 2020 2070 6c74 2e79 6c69 6d28  rs.    plt.ylim(
-000148c0: 6d69 6e79 2c20 6d61 7879 290a 2020 2020  miny, maxy).    
-000148d0: 706c 742e 786c 696d 2830 2c20 6d61 7828  plt.xlim(0, max(
-000148e0: 6469 616d 6574 6572 2929 0a0a 2020 2020  diameter))..    
-000148f0: 2320 4c61 6265 6c73 0a20 2020 2070 6c74  # Labels.    plt
-00014900: 2e6c 6567 656e 6428 290a 2020 2020 706c  .legend().    pl
-00014910: 742e 786c 6162 656c 2822 4170 6572 7475  t.xlabel("Apertu
-00014920: 7265 2044 6961 6d65 7465 7220 2870 6978  re Diameter (pix
-00014930: 2922 290a 2020 2020 706c 742e 796c 6162  )").    plt.ylab
-00014940: 656c 2822 246d 5f7b 6b2b 317d 202d 206d  el("$m_{k+1} - m
-00014950: 5f7b 6b7d 2422 290a 2020 2020 706c 742e  _{k}$").    plt.
-00014960: 7469 746c 6528 6622 4d61 676e 6974 7564  title(f"Magnitud
-00014970: 6520 6772 6f77 7468 2063 7572 7665 2069  e growth curve i
-00014980: 6e20 7b66 696c 747d 2c20 7b73 7461 7263  n {filt}, {starc
-00014990: 6f75 6e74 7d20 7374 6172 7322 290a 2020  ount} stars").  
-000149a0: 2020 706c 742e 7361 7665 6669 6728 7361    plt.savefig(sa
-000149b0: 7665 5f66 696c 652c 2062 626f 785f 696e  ve_file, bbox_in
-000149c0: 6368 6573 3d27 7469 6768 7427 290a 2020  ches='tight').  
-000149d0: 2020 706c 742e 636c 6f73 6528 290a 0a0a    plt.close()...
-000149e0: 6465 6620 6170 706c 795f 6170 6572 7475  def apply_apertu
-000149f0: 7265 5f63 6f72 7265 6374 696f 6e28 6361  re_correction(ca
-00014a00: 7461 6c6f 672c 0a20 2020 2020 2020 2020  talog,.         
-00014a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a20: 2020 2020 2066 696c 742c 0a20 2020 2020       filt,.     
-00014a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a40: 2020 2020 2020 2020 2073 6578 636f 6e66           sexconf
-00014a50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00014a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a70: 6170 6572 7475 7265 2c0a 2020 2020 2020  aperture,.      
-00014a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a90: 2020 2020 2020 2020 6170 6572 636f 7272          apercorr
-00014aa0: 5f66 696c 652c 0a20 2020 2020 2020 2020  _file,.         
-00014ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ac0: 2020 2020 2073 6176 655f 6669 6c65 2c0a       save_file,.
+000143c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000143d0: 2020 2020 2020 2020 2020 2020 2076 6572               ver
+000143e0: 626f 7365 203d 2076 6572 626f 7365 290a  bose = verbose).
+000143f0: 0a20 2020 206d 696e 6d61 6732 2c20 6d69  .    minmag2, mi
+00014400: 6e6d 6167 2c20 6d65 6469 616e 6d61 672c  nmag, medianmag,
+00014410: 206d 6178 6d61 672c 206d 6178 6d61 6732   maxmag, maxmag2
+00014420: 203d 205b 7820 666f 7220 7820 696e 2072   = [x for x in r
+00014430: 6573 756c 745d 0a0a 2020 2020 6469 616d  esult]..    diam
+00014440: 6574 6572 203d 205b 2861 202b 2062 2920  eter = [(a + b) 
+00014450: 2f20 3220 666f 7220 612c 2062 2069 6e20  / 2 for a, b in 
+00014460: 7a69 7028 6170 6572 7475 7265 735f 6c69  zip(apertures_li
+00014470: 7374 5b3a 5d2c 0a20 2020 2020 2020 2020  st[:],.         
+00014480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000144a0: 2020 2061 7065 7274 7572 6573 5f6c 6973     apertures_lis
+000144b0: 745b 313a 5d29 5d0a 0a20 2020 2023 2050  t[1:])]..    # P
+000144c0: 6c6f 7420 6772 6f77 7468 2063 7572 7665  lot growth curve
+000144d0: 0a20 2020 2070 6c74 2e66 6967 7572 6528  .    plt.figure(
+000144e0: 6669 6773 697a 653d 2835 2c20 3429 290a  figsize=(5, 4)).
+000144f0: 0a20 2020 206d 6178 7920 3d20 302e 310a  .    maxy = 0.1.
+00014500: 2020 2020 6d69 6e79 203d 202d 302e 350a      miny = -0.5.
+00014510: 0a20 2020 2023 206d 6564 6961 6e73 0a20  .    # medians. 
+00014520: 2020 2070 6c74 2e70 6c6f 7428 6469 616d     plt.plot(diam
+00014530: 6574 6572 2c20 6d65 6469 616e 6d61 672c  eter, medianmag,
+00014540: 2063 6f6c 6f72 3d27 7265 6427 290a 0a20   color='red').. 
+00014550: 2020 2023 2043 4c36 3820 2620 434c 3935     # CL68 & CL95
+00014560: 0a20 2020 2070 6c74 2e66 696c 6c5f 6265  .    plt.fill_be
+00014570: 7477 6565 6e28 6469 616d 6574 6572 2c20  tween(diameter, 
+00014580: 6d69 6e6d 6167 2c20 6d61 786d 6167 2c20  minmag, maxmag, 
+00014590: 636f 6c6f 723d 276f 7261 6e67 6527 2c20  color='orange', 
+000145a0: 616c 7068 613d 302e 3729 0a20 2020 2070  alpha=0.7).    p
+000145b0: 6c74 2e66 696c 6c5f 6265 7477 6565 6e28  lt.fill_between(
+000145c0: 6469 616d 6574 6572 2c20 6d69 6e6d 6167  diameter, minmag
+000145d0: 322c 206d 6178 6d61 6732 2c20 636f 6c6f  2, maxmag2, colo
+000145e0: 723d 276f 7261 6e67 6527 2c20 616c 7068  r='orange', alph
+000145f0: 613d 302e 3329 0a0a 2020 2020 2320 706c  a=0.3)..    # pl
+00014600: 6f74 206d 6564 6961 6e20 4657 484d 0a20  ot median FWHM. 
+00014610: 2020 2070 6c74 2e70 6c6f 7428 5b6d 6564     plt.plot([med
+00014620: 6961 6e46 5748 4d2c 206d 6564 6961 6e46  ianFWHM, medianF
+00014630: 5748 4d5d 2c20 5b6d 696e 792c 206d 6178  WHM], [miny, max
+00014640: 795d 2c20 636f 6c6f 723d 2764 6172 6b73  y], color='darks
+00014650: 6c61 7465 6772 6179 272c 0a20 2020 2020  lategray',.     
+00014660: 2020 2020 2020 2020 6c61 6265 6c3d 274d          label='M
+00014670: 6564 6961 6e20 4657 484d 2729 0a0a 2020  edian FWHM')..  
+00014680: 2020 2320 706c 6f74 2061 7065 7274 7572    # plot apertur
+00014690: 650a 2020 2020 706c 742e 706c 6f74 285b  e.    plt.plot([
+000146a0: 6d61 785f 6170 6572 7475 7265 2c20 6d61  max_aperture, ma
+000146b0: 785f 6170 6572 7475 7265 5d2c 205b 6d69  x_aperture], [mi
+000146c0: 6e79 2c20 6d61 7879 5d2c 2027 2d27 2c20  ny, maxy], '-', 
+000146d0: 636f 6c6f 723d 2770 7572 706c 6527 2c0a  color='purple',.
+000146e0: 2020 2020 2020 2020 2020 2020 206c 6162               lab
+000146f0: 656c 3d22 7b7d 2070 6978 222e 666f 726d  el="{} pix".form
+00014700: 6174 286d 6178 5f61 7065 7274 7572 6529  at(max_aperture)
+00014710: 290a 0a20 2020 2023 2062 6173 6520 6170  )..    # base ap
+00014720: 6572 7475 7265 0a20 2020 2070 6c74 2e70  erture.    plt.p
+00014730: 6c6f 7428 5b61 7065 7274 7572 652c 2061  lot([aperture, a
+00014740: 7065 7274 7572 655d 2c20 5b6d 696e 792c  perture], [miny,
+00014750: 206d 6178 795d 2c20 272d 272c 2063 6f6c   maxy], '-', col
+00014760: 6f72 3d27 626c 7565 272c 0a20 2020 2020  or='blue',.     
+00014770: 2020 2020 2020 2020 6c61 6265 6c3d 6627          label=f'
+00014780: 7b61 7065 7274 7572 653a 2e33 667d 2d64  {aperture:.3f}-d
+00014790: 6961 6d65 7465 7227 290a 0a20 2020 2023  iameter')..    #
+000147a0: 2072 6567 696f 6e20 6172 6f75 6e64 207a   region around z
+000147b0: 6572 6f0a 2020 2020 706c 742e 706c 6f74  ero.    plt.plot
+000147c0: 285b 302c 206d 6178 2864 6961 6d65 7465  ([0, max(diamete
+000147d0: 7229 5d2c 205b 302c 2030 5d2c 2063 6f6c  r)], [0, 0], col
+000147e0: 6f72 3d27 626c 7565 2729 0a20 2020 2070  or='blue').    p
+000147f0: 6c74 2e66 696c 6c5f 6265 7477 6565 6e28  lt.fill_between(
+00014800: 5b30 2c20 6d61 7828 6469 616d 6574 6572  [0, max(diameter
+00014810: 295d 2c20 5b2d 3165 2d32 2c20 2d31 652d  )], [-1e-2, -1e-
+00014820: 325d 2c20 5b31 652d 322c 2031 652d 325d  2], [1e-2, 1e-2]
+00014830: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00014840: 2020 2020 2020 2063 6f6c 6f72 3d27 626c         color='bl
+00014850: 7565 272c 2061 6c70 6861 3d30 2e33 290a  ue', alpha=0.3).
+00014860: 0a20 2020 2023 2050 6c6f 7420 7061 7261  .    # Plot para
+00014870: 6d65 7465 7273 0a20 2020 2070 6c74 2e79  meters.    plt.y
+00014880: 6c69 6d28 6d69 6e79 2c20 6d61 7879 290a  lim(miny, maxy).
+00014890: 2020 2020 706c 742e 786c 696d 2830 2c20      plt.xlim(0, 
+000148a0: 6d61 7828 6469 616d 6574 6572 2929 0a0a  max(diameter))..
+000148b0: 2020 2020 2320 4c61 6265 6c73 0a20 2020      # Labels.   
+000148c0: 2070 6c74 2e6c 6567 656e 6428 290a 2020   plt.legend().  
+000148d0: 2020 706c 742e 786c 6162 656c 2822 4170    plt.xlabel("Ap
+000148e0: 6572 7475 7265 2044 6961 6d65 7465 7220  erture Diameter 
+000148f0: 2870 6978 2922 290a 2020 2020 706c 742e  (pix)").    plt.
+00014900: 796c 6162 656c 2822 246d 5f7b 6b2b 317d  ylabel("$m_{k+1}
+00014910: 202d 206d 5f7b 6b7d 2422 290a 2020 2020   - m_{k}$").    
+00014920: 706c 742e 7469 746c 6528 6622 4d61 676e  plt.title(f"Magn
+00014930: 6974 7564 6520 6772 6f77 7468 2063 7572  itude growth cur
+00014940: 7665 2069 6e20 7b66 696c 747d 2c20 7b73  ve in {filt}, {s
+00014950: 7461 7263 6f75 6e74 7d20 7374 6172 7322  tarcount} stars"
+00014960: 290a 2020 2020 706c 742e 7361 7665 6669  ).    plt.savefi
+00014970: 6728 7361 7665 5f66 696c 652c 2062 626f  g(save_file, bbo
+00014980: 785f 696e 6368 6573 3d27 7469 6768 7427  x_inches='tight'
+00014990: 290a 2020 2020 706c 742e 636c 6f73 6528  ).    plt.close(
+000149a0: 290a 0a0a 6465 6620 6170 706c 795f 6170  )...def apply_ap
+000149b0: 6572 7475 7265 5f63 6f72 7265 6374 696f  erture_correctio
+000149c0: 6e28 6361 7461 6c6f 672c 0a20 2020 2020  n(catalog,.     
+000149d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000149e0: 2020 2020 2020 2020 2066 696c 742c 0a20           filt,. 
+000149f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a00: 2020 2020 2020 2020 2020 2020 2073 6578               sex
+00014a10: 636f 6e66 2c0a 2020 2020 2020 2020 2020  conf,.          
+00014a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a30: 2020 2020 6170 6572 7475 7265 2c0a 2020      aperture,.  
+00014a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a50: 2020 2020 2020 2020 2020 2020 6170 6572              aper
+00014a60: 636f 7272 5f66 696c 652c 0a20 2020 2020  corr_file,.     
+00014a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a80: 2020 2020 2020 2020 2073 6176 655f 6669           save_fi
+00014a90: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
+00014aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014ab0: 2020 6669 656c 6420 3d20 274e 6f46 6965    field = 'NoFie
+00014ac0: 6c64 4e61 6d65 272c 0a20 2020 2020 2020  ldName',.       
 00014ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ae0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-00014af0: 656c 6420 3d20 274e 6f46 6965 6c64 4e61  eld = 'NoFieldNa
-00014b00: 6d65 272c 0a20 2020 2020 2020 2020 2020  me',.           
-00014b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b20: 2020 2073 6578 6d6f 6465 203d 2027 4e6f     sexmode = 'No
-00014b30: 5365 784d 6f64 6527 2c0a 2020 2020 2020  SexMode',.      
-00014b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b50: 2020 2020 2020 2020 6472 6e61 6d65 203d          drname =
-00014b60: 2027 4e6f 4452 6e61 6d65 2729 3a0a 0a20   'NoDRname'):.. 
-00014b70: 2020 2022 2222 0a20 2020 2041 7070 6c69     """.    Appli
-00014b80: 6573 2061 7065 7274 7572 6520 636f 7272  es aperture corr
-00014b90: 6563 7469 6f6e 2074 6f20 5345 7874 7261  ection to SExtra
-00014ba0: 6374 6f72 2070 686f 746f 6d65 7472 792e  ctor photometry.
-00014bb0: 0a20 2020 2054 6869 7320 6675 6e63 7469  .    This functi
-00014bc0: 6f6e 2072 656d 6f76 6573 2074 6865 2041  on removes the A
-00014bd0: 5045 5220 636f 6c75 6d6e 2066 726f 6d20  PER column from 
-00014be0: 5345 7874 7261 6374 6f72 2063 6174 616c  SExtractor catal
-00014bf0: 6f67 7320 616e 6420 6164 6473 2074 6865  ogs and adds the
-00014c00: 0a20 2020 2050 5374 6f74 616c 2063 6f6c  .    PStotal col
-00014c10: 756d 6e20 616e 6420 6f74 6865 7220 6465  umn and other de
-00014c20: 7369 7265 6420 6170 6572 7475 7265 7320  sired apertures 
-00014c30: 6465 6669 6e65 6420 696e 2061 7065 725f  defined in aper_
-00014c40: 6e61 6d65 7320 616e 640a 2020 2020 6170  names and.    ap
-00014c50: 6572 5f69 6473 0a0a 2020 2020 5061 7261  er_ids..    Para
-00014c60: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-00014c70: 2d2d 2d2d 2d0a 2020 2020 6361 7461 6c6f  -----.    catalo
-00014c80: 6720 3a20 7374 720a 2020 2020 2020 2020  g : str.        
-00014c90: 4c6f 6361 7469 6f6e 206f 6620 5345 7874  Location of SExt
-00014ca0: 7261 6374 6f72 2070 686f 746f 6d65 7472  ractor photometr
-00014cb0: 7920 6361 7461 6c6f 670a 2020 2020 6669  y catalog.    fi
-00014cc0: 6c74 203a 2073 7472 0a20 2020 2020 2020  lt : str.       
-00014cd0: 204e 616d 6520 6f66 2074 6865 2066 696c   Name of the fil
-00014ce0: 7465 720a 2020 2020 7365 7863 6f6e 6620  ter.    sexconf 
-00014cf0: 3a20 7374 720a 2020 2020 2020 2020 5345  : str.        SE
-00014d00: 7874 7261 6374 6f72 2063 6f6e 6669 6775  xtractor configu
-00014d10: 7261 7469 6f6e 2066 696c 6520 666f 7220  ration file for 
-00014d20: 7468 6973 2066 696c 7465 7220 7068 6f74  this filter phot
-00014d30: 6f6d 6574 7279 0a20 2020 2061 7065 7274  ometry.    apert
-00014d40: 7572 6520 3a20 666c 6f61 740a 2020 2020  ure : float.    
-00014d50: 2020 2020 4261 7365 2061 7065 7274 7572      Base apertur
-00014d60: 6520 746f 2061 7070 6c79 2061 7065 7274  e to apply apert
-00014d70: 7572 6520 636f 7272 6563 7469 6f6e 0a20  ure correction. 
-00014d80: 2020 2061 7065 7263 6f72 725f 6669 6c65     apercorr_file
-00014d90: 203a 2073 7472 0a20 2020 2020 2020 204c   : str.        L
-00014da0: 6f63 6174 696f 6e20 6f66 2074 6865 2061  ocation of the a
-00014db0: 7065 7274 7572 6520 636f 7272 6563 7469  perture correcti
-00014dc0: 6f6e 2066 696c 650a 2020 2020 7361 7665  on file.    save
-00014dd0: 5f66 696c 6520 3a20 7374 720a 2020 2020  _file : str.    
-00014de0: 2020 2020 4465 7369 7265 6420 6c6f 6361      Desired loca
-00014df0: 7469 6f6e 2074 6f20 7361 7665 206e 6577  tion to save new
-00014e00: 2063 6174 616c 6f67 0a20 2020 2066 6965   catalog.    fie
-00014e10: 6c64 203a 2073 7472 0a20 2020 2020 2020  ld : str.       
-00014e20: 204e 616d 6520 6f66 2074 6865 2066 6965   Name of the fie
-00014e30: 6c64 2074 6f20 6265 2061 6464 6564 2074  ld to be added t
-00014e40: 6f20 7468 6520 6669 6c74 6572 5f49 440a  o the filter_ID.
-00014e50: 2020 2020 6472 6e61 6d65 203a 2073 7472      drname : str
-00014e60: 0a20 2020 2020 2020 2044 6174 6120 7265  .        Data re
-00014e70: 6c65 6173 6520 6465 7369 676e 6174 696f  lease designatio
-00014e80: 6e20 746f 2062 6520 6164 6465 6420 746f  n to be added to
-00014e90: 2074 6865 2066 696c 7465 725f 4944 0a20   the filter_ID. 
-00014ea0: 2020 2073 6578 6d6f 6465 203a 2073 7472     sexmode : str
-00014eb0: 0a20 2020 2020 2020 2064 7561 6c2f 7369  .        dual/si
-00014ec0: 6e67 6c65 2053 4578 7472 6163 746f 7220  ngle SExtractor 
-00014ed0: 6d6f 6465 2074 6f20 6265 2061 6464 6564  mode to be added
-00014ee0: 2074 6f20 7468 6520 6669 6c74 6572 5f49   to the filter_I
-00014ef0: 440a 0a20 2020 2052 6574 7572 6e73 0a20  D..    Returns. 
-00014f00: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2053     -------.    S
-00014f10: 6176 6573 206e 6577 2063 6174 616c 6f67  aves new catalog
-00014f20: 2077 6974 6820 6170 6572 7475 7265 2063   with aperture c
-00014f30: 6f72 7265 6374 6564 2061 7065 7274 7572  orrected apertur
-00014f40: 6573 2028 5053 746f 7461 6c29 0a0a 2020  es (PStotal)..  
-00014f50: 2020 2222 220a 0a20 2020 2023 2052 6561    """..    # Rea
-00014f60: 6420 6361 7461 6c6f 670a 2020 2020 6361  d catalog.    ca
-00014f70: 7420 3d20 6669 7473 2e6f 7065 6e28 6361  t = fits.open(ca
-00014f80: 7461 6c6f 6729 0a20 2020 2063 6174 5f64  talog).    cat_d
-00014f90: 6174 6120 3d20 6361 745b 315d 2e64 6174  ata = cat[1].dat
-00014fa0: 610a 0a20 2020 2023 2052 6561 6420 6170  a..    # Read ap
-00014fb0: 6572 2063 6f72 7265 6374 696f 6e0a 2020  er correction.  
-00014fc0: 2020 6170 6572 5f63 6f72 725f 6469 6374    aper_corr_dict
-00014fd0: 203d 207a 705f 7265 6164 2861 7065 7263   = zp_read(aperc
-00014fe0: 6f72 725f 6669 6c65 290a 0a20 2020 2023  orr_file)..    #
-00014ff0: 2043 7265 6174 6520 6e65 7720 6669 7473   Create new fits
-00015000: 2063 6174 616c 6f67 2077 6974 6820 6e65   catalog with ne
-00015010: 7720 636f 6c75 6d6e 730a 2020 2020 6e65  w columns.    ne
-00015020: 775f 6461 7461 203d 205b 5d0a 0a20 2020  w_data = []..   
-00015030: 2066 6f72 2063 6f6c 2069 6e20 6361 745f   for col in cat_
-00015040: 6461 7461 2e63 6f6c 756d 6e73 3a0a 2020  data.columns:.  
-00015050: 2020 2020 2020 6e65 775f 6461 7461 2e61        new_data.a
-00015060: 7070 656e 6428 636f 6c29 0a0a 2020 2020  ppend(col)..    
-00015070: 2320 4765 7420 6170 6572 7475 7265 206c  # Get aperture l
-00015080: 6973 740a 2020 2020 6170 6572 7475 7265  ist.    aperture
-00015090: 735f 6c69 7374 203d 2067 6574 5f61 7065  s_list = get_ape
-000150a0: 7274 7572 6573 5f66 726f 6d5f 7365 7863  rtures_from_sexc
-000150b0: 6f6e 6628 7365 7863 6f6e 6629 2020 2320  onf(sexconf)  # 
-000150c0: 7479 7065 3a20 6e70 2e6e 6461 7272 6179  type: np.ndarray
-000150d0: 0a0a 2020 2020 6966 2061 7065 7274 7572  ..    if apertur
-000150e0: 6573 5f6c 6973 7420 6973 204e 6f6e 653a  es_list is None:
-000150f0: 0a20 2020 2020 2020 2072 6169 7365 2056  .        raise V
-00015100: 616c 7565 4572 726f 7228 6622 436f 756c  alueError(f"Coul
-00015110: 6420 6e6f 7420 6669 6e64 2070 6172 616d  d not find param
-00015120: 2050 484f 545f 4150 4552 5455 5245 5320   PHOT_APERTURES 
-00015130: 696e 207b 7365 7863 6f6e 667d 2e22 290a  in {sexconf}.").
-00015140: 0a20 2020 2023 2047 6574 2062 6173 6520  .    # Get base 
-00015150: 6170 6572 7475 7265 2049 4420 2861 6c6c  aperture ID (all
-00015160: 6f77 696e 6720 6120 726f 756e 6469 6e67  owing a rounding
-00015170: 2065 7272 6f72 2075 7020 746f 2074 6865   error up to the
-00015180: 2074 6869 7264 2064 6563 696d 616c 290a   third decimal).
-00015190: 2020 2020 726f 756e 645f 6c69 7374 203d      round_list =
-000151a0: 206e 702e 6172 6f75 6e64 2861 7065 7274   np.around(apert
-000151b0: 7572 6573 5f6c 6973 742c 2033 290a 2020  ures_list, 3).  
-000151c0: 2020 726f 756e 645f 6170 6572 203d 206e    round_aper = n
-000151d0: 702e 6172 6f75 6e64 2861 7065 7274 7572  p.around(apertur
-000151e0: 652c 2033 290a 2020 2020 6170 6572 5f69  e, 3).    aper_i
-000151f0: 6420 2020 203d 206e 702e 7768 6572 6528  d    = np.where(
-00015200: 726f 756e 645f 6c69 7374 203d 3d20 726f  round_list == ro
-00015210: 756e 645f 6170 6572 295b 305d 5b30 5d0a  und_aper)[0][0].
-00015220: 0a20 2020 2023 2041 7070 6c79 2061 7065  .    # Apply ape
-00015230: 7274 7572 6520 636f 7272 6563 7469 6f6e  rture correction
-00015240: 0a20 2020 2061 7065 725f 636f 7272 203d  .    aper_corr =
-00015250: 2061 7065 725f 636f 7272 5f64 6963 745b   aper_corr_dict[
-00015260: 6622 5350 4c55 535f 7b66 696c 747d 225d  f"SPLUS_{filt}"]
-00015270: 0a20 2020 2066 6c75 785f 636f 7272 203d  .    flux_corr =
-00015280: 2031 302a 2a28 2d61 7065 725f 636f 7272   10**(-aper_corr
-00015290: 2f32 2e35 290a 0a20 2020 2063 6f6c 203d  /2.5)..    col =
-000152a0: 2063 6f70 792e 6465 6570 636f 7079 2863   copy.deepcopy(c
-000152b0: 6174 5f64 6174 612e 636f 6c75 6d6e 735b  at_data.columns[
-000152c0: 274d 4147 5f41 5045 5227 5d2e 6172 7261  'MAG_APER'].arra
-000152d0: 795b 3a2c 2061 7065 725f 6964 5d29 0a20  y[:, aper_id]). 
-000152e0: 2020 2066 203d 2063 6f6c 2021 3d20 3939     f = col != 99
-000152f0: 0a20 2020 2063 6f6c 5b66 5d20 3d20 636f  .    col[f] = co
-00015300: 6c5b 665d 202b 2061 7065 725f 636f 7272  l[f] + aper_corr
-00015310: 0a20 2020 206e 6577 5f64 6174 612e 6170  .    new_data.ap
-00015320: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
-00015330: 286e 616d 653d 6627 4d41 475f 5053 746f  (name=f'MAG_PSto
-00015340: 7461 6c27 2c0a 2020 2020 2020 2020 2020  tal',.          
-00015350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015360: 2020 2020 2020 666f 726d 6174 3d27 3145        format='1E
-00015370: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00015380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015390: 2020 2061 7272 6179 3d63 6f6c 2929 0a0a     array=col))..
-000153a0: 2020 2020 636f 6c20 3d20 636f 7079 2e64      col = copy.d
-000153b0: 6565 7063 6f70 7928 6361 745f 6461 7461  eepcopy(cat_data
-000153c0: 2e63 6f6c 756d 6e73 5b27 4d41 4745 5252  .columns['MAGERR
-000153d0: 5f41 5045 5227 5d2e 6172 7261 795b 3a2c  _APER'].array[:,
-000153e0: 2061 7065 725f 6964 5d29 0a20 2020 206e   aper_id]).    n
-000153f0: 6577 5f64 6174 612e 6170 7065 6e64 2866  ew_data.append(f
-00015400: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
-00015410: 6627 4d41 4745 5252 5f50 5374 6f74 616c  f'MAGERR_PStotal
-00015420: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00015430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015440: 2020 2066 6f72 6d61 743d 2731 4527 2c0a     format='1E',.
-00015450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015470: 6172 7261 793d 636f 6c29 290a 0a20 2020  array=col))..   
-00015480: 2063 6f6c 203d 2063 6f70 792e 6465 6570   col = copy.deep
-00015490: 636f 7079 2863 6174 5f64 6174 612e 636f  copy(cat_data.co
-000154a0: 6c75 6d6e 735b 2746 4c55 585f 4150 4552  lumns['FLUX_APER
-000154b0: 275d 2e61 7272 6179 5b3a 2c20 6170 6572  '].array[:, aper
-000154c0: 5f69 645d 202a 2066 6c75 785f 636f 7272  _id] * flux_corr
-000154d0: 290a 2020 2020 6e65 775f 6461 7461 2e61  ).    new_data.a
-000154e0: 7070 656e 6428 6669 7473 2e43 6f6c 756d  ppend(fits.Colum
-000154f0: 6e28 6e61 6d65 3d66 2746 4c55 585f 5053  n(name=f'FLUX_PS
-00015500: 746f 7461 6c27 2c0a 2020 2020 2020 2020  total',.        
-00015510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015520: 2020 2020 2020 2020 666f 726d 6174 3d27          format='
-00015530: 3145 272c 0a20 2020 2020 2020 2020 2020  1E',.           
-00015540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015550: 2020 2020 2061 7272 6179 3d63 6f6c 2929       array=col))
-00015560: 0a0a 2020 2020 636f 6c20 3d20 636f 7079  ..    col = copy
-00015570: 2e64 6565 7063 6f70 7928 6361 745f 6461  .deepcopy(cat_da
-00015580: 7461 2e63 6f6c 756d 6e73 5b27 464c 5558  ta.columns['FLUX
-00015590: 4552 525f 4150 4552 275d 2e61 7272 6179  ERR_APER'].array
-000155a0: 5b3a 2c20 6170 6572 5f69 645d 290a 2020  [:, aper_id]).  
-000155b0: 2020 6e65 775f 6461 7461 2e61 7070 656e    new_data.appen
-000155c0: 6428 6669 7473 2e43 6f6c 756d 6e28 6e61  d(fits.Column(na
-000155d0: 6d65 3d66 2746 4c55 5845 5252 5f50 5374  me=f'FLUXERR_PSt
-000155e0: 6f74 616c 272c 0a20 2020 2020 2020 2020  otal',.         
-000155f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015600: 2020 2020 2020 2066 6f72 6d61 743d 2731         format='1
-00015610: 4527 2c0a 2020 2020 2020 2020 2020 2020  E',.            
-00015620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015630: 2020 2020 6172 7261 793d 636f 6c29 290a      array=col)).
-00015640: 0a20 2020 2023 2053 6176 6520 636f 7272  .    # Save corr
-00015650: 6563 7465 6420 6461 7461 2074 6f20 7361  ected data to sa
-00015660: 7665 5f66 696c 6520 6669 7473 2063 6174  ve_file fits cat
-00015670: 616c 6f67 0a20 2020 2068 6475 203d 2066  alog.    hdu = f
-00015680: 6974 732e 4269 6e54 6162 6c65 4844 552e  its.BinTableHDU.
-00015690: 6672 6f6d 5f63 6f6c 756d 6e73 286e 6577  from_columns(new
-000156a0: 5f64 6174 6129 0a20 2020 2068 6475 2e77  _data).    hdu.w
-000156b0: 7269 7465 746f 2873 6176 655f 6669 6c65  riteto(save_file
-000156c0: 290a 0a0a 2323 2323 2323 2323 2323 2323  )...############
-000156d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000156e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00014ae0: 2020 2020 2020 2073 6578 6d6f 6465 203d         sexmode =
+00014af0: 2027 4e6f 5365 784d 6f64 6527 2c0a 2020   'NoSexMode',.  
+00014b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014b10: 2020 2020 2020 2020 2020 2020 6472 6e61              drna
+00014b20: 6d65 203d 2027 4e6f 4452 6e61 6d65 2729  me = 'NoDRname')
+00014b30: 3a0a 0a20 2020 2022 2222 0a20 2020 2041  :..    """.    A
+00014b40: 7070 6c69 6573 2061 7065 7274 7572 6520  pplies aperture 
+00014b50: 636f 7272 6563 7469 6f6e 2074 6f20 5345  correction to SE
+00014b60: 7874 7261 6374 6f72 2070 686f 746f 6d65  xtractor photome
+00014b70: 7472 792e 0a20 2020 2054 6869 7320 6675  try..    This fu
+00014b80: 6e63 7469 6f6e 2072 656d 6f76 6573 2074  nction removes t
+00014b90: 6865 2041 5045 5220 636f 6c75 6d6e 2066  he APER column f
+00014ba0: 726f 6d20 5345 7874 7261 6374 6f72 2063  rom SExtractor c
+00014bb0: 6174 616c 6f67 7320 616e 6420 6164 6473  atalogs and adds
+00014bc0: 2074 6865 0a20 2020 2050 5374 6f74 616c   the.    PStotal
+00014bd0: 2063 6f6c 756d 6e20 616e 6420 6f74 6865   column and othe
+00014be0: 7220 6465 7369 7265 6420 6170 6572 7475  r desired apertu
+00014bf0: 7265 7320 6465 6669 6e65 6420 696e 2061  res defined in a
+00014c00: 7065 725f 6e61 6d65 7320 616e 640a 2020  per_names and.  
+00014c10: 2020 6170 6572 5f69 6473 0a0a 2020 2020    aper_ids..    
+00014c20: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+00014c30: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6361  ---------.    ca
+00014c40: 7461 6c6f 6720 3a20 7374 720a 2020 2020  talog : str.    
+00014c50: 2020 2020 4c6f 6361 7469 6f6e 206f 6620      Location of 
+00014c60: 5345 7874 7261 6374 6f72 2070 686f 746f  SExtractor photo
+00014c70: 6d65 7472 7920 6361 7461 6c6f 670a 2020  metry catalog.  
+00014c80: 2020 6669 6c74 203a 2073 7472 0a20 2020    filt : str.   
+00014c90: 2020 2020 204e 616d 6520 6f66 2074 6865       Name of the
+00014ca0: 2066 696c 7465 720a 2020 2020 7365 7863   filter.    sexc
+00014cb0: 6f6e 6620 3a20 7374 720a 2020 2020 2020  onf : str.      
+00014cc0: 2020 5345 7874 7261 6374 6f72 2063 6f6e    SExtractor con
+00014cd0: 6669 6775 7261 7469 6f6e 2066 696c 6520  figuration file 
+00014ce0: 666f 7220 7468 6973 2066 696c 7465 7220  for this filter 
+00014cf0: 7068 6f74 6f6d 6574 7279 0a20 2020 2061  photometry.    a
+00014d00: 7065 7274 7572 6520 3a20 666c 6f61 740a  perture : float.
+00014d10: 2020 2020 2020 2020 4261 7365 2061 7065          Base ape
+00014d20: 7274 7572 6520 746f 2061 7070 6c79 2061  rture to apply a
+00014d30: 7065 7274 7572 6520 636f 7272 6563 7469  perture correcti
+00014d40: 6f6e 0a20 2020 2061 7065 7263 6f72 725f  on.    apercorr_
+00014d50: 6669 6c65 203a 2073 7472 0a20 2020 2020  file : str.     
+00014d60: 2020 204c 6f63 6174 696f 6e20 6f66 2074     Location of t
+00014d70: 6865 2061 7065 7274 7572 6520 636f 7272  he aperture corr
+00014d80: 6563 7469 6f6e 2066 696c 650a 2020 2020  ection file.    
+00014d90: 7361 7665 5f66 696c 6520 3a20 7374 720a  save_file : str.
+00014da0: 2020 2020 2020 2020 4465 7369 7265 6420          Desired 
+00014db0: 6c6f 6361 7469 6f6e 2074 6f20 7361 7665  location to save
+00014dc0: 206e 6577 2063 6174 616c 6f67 0a20 2020   new catalog.   
+00014dd0: 2066 6965 6c64 203a 2073 7472 0a20 2020   field : str.   
+00014de0: 2020 2020 204e 616d 6520 6f66 2074 6865       Name of the
+00014df0: 2066 6965 6c64 2074 6f20 6265 2061 6464   field to be add
+00014e00: 6564 2074 6f20 7468 6520 6669 6c74 6572  ed to the filter
+00014e10: 5f49 440a 2020 2020 6472 6e61 6d65 203a  _ID.    drname :
+00014e20: 2073 7472 0a20 2020 2020 2020 2044 6174   str.        Dat
+00014e30: 6120 7265 6c65 6173 6520 6465 7369 676e  a release design
+00014e40: 6174 696f 6e20 746f 2062 6520 6164 6465  ation to be adde
+00014e50: 6420 746f 2074 6865 2066 696c 7465 725f  d to the filter_
+00014e60: 4944 0a20 2020 2073 6578 6d6f 6465 203a  ID.    sexmode :
+00014e70: 2073 7472 0a20 2020 2020 2020 2064 7561   str.        dua
+00014e80: 6c2f 7369 6e67 6c65 2053 4578 7472 6163  l/single SExtrac
+00014e90: 746f 7220 6d6f 6465 2074 6f20 6265 2061  tor mode to be a
+00014ea0: 6464 6564 2074 6f20 7468 6520 6669 6c74  dded to the filt
+00014eb0: 6572 5f49 440a 0a20 2020 2052 6574 7572  er_ID..    Retur
+00014ec0: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
+00014ed0: 2020 2053 6176 6573 206e 6577 2063 6174     Saves new cat
+00014ee0: 616c 6f67 2077 6974 6820 6170 6572 7475  alog with apertu
+00014ef0: 7265 2063 6f72 7265 6374 6564 2061 7065  re corrected ape
+00014f00: 7274 7572 6573 2028 5053 746f 7461 6c29  rtures (PStotal)
+00014f10: 0a0a 2020 2020 2222 220a 0a20 2020 2023  ..    """..    #
+00014f20: 2052 6561 6420 6361 7461 6c6f 670a 2020   Read catalog.  
+00014f30: 2020 6361 7420 3d20 6669 7473 2e6f 7065    cat = fits.ope
+00014f40: 6e28 6361 7461 6c6f 6729 0a20 2020 2063  n(catalog).    c
+00014f50: 6174 5f64 6174 6120 3d20 6361 745b 315d  at_data = cat[1]
+00014f60: 2e64 6174 610a 0a20 2020 2023 2052 6561  .data..    # Rea
+00014f70: 6420 6170 6572 2063 6f72 7265 6374 696f  d aper correctio
+00014f80: 6e0a 2020 2020 6170 6572 5f63 6f72 725f  n.    aper_corr_
+00014f90: 6469 6374 203d 207a 705f 7265 6164 2861  dict = zp_read(a
+00014fa0: 7065 7263 6f72 725f 6669 6c65 290a 0a20  percorr_file).. 
+00014fb0: 2020 2023 2043 7265 6174 6520 6e65 7720     # Create new 
+00014fc0: 6669 7473 2063 6174 616c 6f67 2077 6974  fits catalog wit
+00014fd0: 6820 6e65 7720 636f 6c75 6d6e 730a 2020  h new columns.  
+00014fe0: 2020 6e65 775f 6461 7461 203d 205b 5d0a    new_data = [].
+00014ff0: 0a20 2020 2066 6f72 2063 6f6c 2069 6e20  .    for col in 
+00015000: 6361 745f 6461 7461 2e63 6f6c 756d 6e73  cat_data.columns
+00015010: 3a0a 2020 2020 2020 2020 6e65 775f 6461  :.        new_da
+00015020: 7461 2e61 7070 656e 6428 636f 6c29 0a0a  ta.append(col)..
+00015030: 2020 2020 2320 4765 7420 6170 6572 7475      # Get apertu
+00015040: 7265 206c 6973 740a 2020 2020 6170 6572  re list.    aper
+00015050: 7475 7265 735f 6c69 7374 203d 2067 6574  tures_list = get
+00015060: 5f61 7065 7274 7572 6573 5f66 726f 6d5f  _apertures_from_
+00015070: 7365 7863 6f6e 6628 7365 7863 6f6e 6629  sexconf(sexconf)
+00015080: 2020 2320 7479 7065 3a20 6e70 2e6e 6461    # type: np.nda
+00015090: 7272 6179 0a0a 2020 2020 6966 2061 7065  rray..    if ape
+000150a0: 7274 7572 6573 5f6c 6973 7420 6973 204e  rtures_list is N
+000150b0: 6f6e 653a 0a20 2020 2020 2020 2072 6169  one:.        rai
+000150c0: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
+000150d0: 436f 756c 6420 6e6f 7420 6669 6e64 2070  Could not find p
+000150e0: 6172 616d 2050 484f 545f 4150 4552 5455  aram PHOT_APERTU
+000150f0: 5245 5320 696e 207b 7365 7863 6f6e 667d  RES in {sexconf}
+00015100: 2e22 290a 0a20 2020 2023 2047 6574 2062  .")..    # Get b
+00015110: 6173 6520 6170 6572 7475 7265 2049 4420  ase aperture ID 
+00015120: 2861 6c6c 6f77 696e 6720 6120 726f 756e  (allowing a roun
+00015130: 6469 6e67 2065 7272 6f72 2075 7020 746f  ding error up to
+00015140: 2074 6865 2074 6869 7264 2064 6563 696d   the third decim
+00015150: 616c 290a 2020 2020 726f 756e 645f 6c69  al).    round_li
+00015160: 7374 203d 206e 702e 6172 6f75 6e64 2861  st = np.around(a
+00015170: 7065 7274 7572 6573 5f6c 6973 742c 2033  pertures_list, 3
+00015180: 290a 2020 2020 726f 756e 645f 6170 6572  ).    round_aper
+00015190: 203d 206e 702e 6172 6f75 6e64 2861 7065   = np.around(ape
+000151a0: 7274 7572 652c 2033 290a 2020 2020 6170  rture, 3).    ap
+000151b0: 6572 5f69 6420 2020 203d 206e 702e 7768  er_id    = np.wh
+000151c0: 6572 6528 726f 756e 645f 6c69 7374 203d  ere(round_list =
+000151d0: 3d20 726f 756e 645f 6170 6572 295b 305d  = round_aper)[0]
+000151e0: 5b30 5d0a 0a20 2020 2023 2041 7070 6c79  [0]..    # Apply
+000151f0: 2061 7065 7274 7572 6520 636f 7272 6563   aperture correc
+00015200: 7469 6f6e 0a20 2020 2061 7065 725f 636f  tion.    aper_co
+00015210: 7272 203d 2061 7065 725f 636f 7272 5f64  rr = aper_corr_d
+00015220: 6963 745b 6622 5350 4c55 535f 7b66 696c  ict[f"SPLUS_{fil
+00015230: 747d 225d 0a20 2020 2066 6c75 785f 636f  t}"].    flux_co
+00015240: 7272 203d 2031 302a 2a28 2d61 7065 725f  rr = 10**(-aper_
+00015250: 636f 7272 2f32 2e35 290a 0a20 2020 2063  corr/2.5)..    c
+00015260: 6f6c 203d 2063 6f70 792e 6465 6570 636f  ol = copy.deepco
+00015270: 7079 2863 6174 5f64 6174 612e 636f 6c75  py(cat_data.colu
+00015280: 6d6e 735b 274d 4147 5f41 5045 5227 5d2e  mns['MAG_APER'].
+00015290: 6172 7261 795b 3a2c 2061 7065 725f 6964  array[:, aper_id
+000152a0: 5d29 0a20 2020 2066 203d 2063 6f6c 2021  ]).    f = col !
+000152b0: 3d20 3939 0a20 2020 2063 6f6c 5b66 5d20  = 99.    col[f] 
+000152c0: 3d20 636f 6c5b 665d 202b 2061 7065 725f  = col[f] + aper_
+000152d0: 636f 7272 0a20 2020 206e 6577 5f64 6174  corr.    new_dat
+000152e0: 612e 6170 7065 6e64 2866 6974 732e 436f  a.append(fits.Co
+000152f0: 6c75 6d6e 286e 616d 653d 6627 4d41 475f  lumn(name=f'MAG_
+00015300: 5053 746f 7461 6c27 2c0a 2020 2020 2020  PStotal',.      
+00015310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015320: 2020 2020 2020 2020 2020 666f 726d 6174            format
+00015330: 3d27 3145 272c 0a20 2020 2020 2020 2020  ='1E',.         
+00015340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015350: 2020 2020 2020 2061 7272 6179 3d63 6f6c         array=col
+00015360: 2929 0a0a 2020 2020 636f 6c20 3d20 636f  ))..    col = co
+00015370: 7079 2e64 6565 7063 6f70 7928 6361 745f  py.deepcopy(cat_
+00015380: 6461 7461 2e63 6f6c 756d 6e73 5b27 4d41  data.columns['MA
+00015390: 4745 5252 5f41 5045 5227 5d2e 6172 7261  GERR_APER'].arra
+000153a0: 795b 3a2c 2061 7065 725f 6964 5d29 0a20  y[:, aper_id]). 
+000153b0: 2020 206e 6577 5f64 6174 612e 6170 7065     new_data.appe
+000153c0: 6e64 2866 6974 732e 436f 6c75 6d6e 286e  nd(fits.Column(n
+000153d0: 616d 653d 6627 4d41 4745 5252 5f50 5374  ame=f'MAGERR_PSt
+000153e0: 6f74 616c 272c 0a20 2020 2020 2020 2020  otal',.         
+000153f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015400: 2020 2020 2020 2066 6f72 6d61 743d 2731         format='1
+00015410: 4527 2c0a 2020 2020 2020 2020 2020 2020  E',.            
+00015420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015430: 2020 2020 6172 7261 793d 636f 6c29 290a      array=col)).
+00015440: 0a20 2020 2063 6f6c 203d 2063 6f70 792e  .    col = copy.
+00015450: 6465 6570 636f 7079 2863 6174 5f64 6174  deepcopy(cat_dat
+00015460: 612e 636f 6c75 6d6e 735b 2746 4c55 585f  a.columns['FLUX_
+00015470: 4150 4552 275d 2e61 7272 6179 5b3a 2c20  APER'].array[:, 
+00015480: 6170 6572 5f69 645d 202a 2066 6c75 785f  aper_id] * flux_
+00015490: 636f 7272 290a 2020 2020 6e65 775f 6461  corr).    new_da
+000154a0: 7461 2e61 7070 656e 6428 6669 7473 2e43  ta.append(fits.C
+000154b0: 6f6c 756d 6e28 6e61 6d65 3d66 2746 4c55  olumn(name=f'FLU
+000154c0: 585f 5053 746f 7461 6c27 2c0a 2020 2020  X_PStotal',.    
+000154d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000154e0: 2020 2020 2020 2020 2020 2020 666f 726d              form
+000154f0: 6174 3d27 3145 272c 0a20 2020 2020 2020  at='1E',.       
+00015500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015510: 2020 2020 2020 2020 2061 7272 6179 3d63           array=c
+00015520: 6f6c 2929 0a0a 2020 2020 636f 6c20 3d20  ol))..    col = 
+00015530: 636f 7079 2e64 6565 7063 6f70 7928 6361  copy.deepcopy(ca
+00015540: 745f 6461 7461 2e63 6f6c 756d 6e73 5b27  t_data.columns['
+00015550: 464c 5558 4552 525f 4150 4552 275d 2e61  FLUXERR_APER'].a
+00015560: 7272 6179 5b3a 2c20 6170 6572 5f69 645d  rray[:, aper_id]
+00015570: 290a 2020 2020 6e65 775f 6461 7461 2e61  ).    new_data.a
+00015580: 7070 656e 6428 6669 7473 2e43 6f6c 756d  ppend(fits.Colum
+00015590: 6e28 6e61 6d65 3d66 2746 4c55 5845 5252  n(name=f'FLUXERR
+000155a0: 5f50 5374 6f74 616c 272c 0a20 2020 2020  _PStotal',.     
+000155b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000155c0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+000155d0: 743d 2731 4527 2c0a 2020 2020 2020 2020  t='1E',.        
+000155e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000155f0: 2020 2020 2020 2020 6172 7261 793d 636f          array=co
+00015600: 6c29 290a 0a20 2020 2023 2053 6176 6520  l))..    # Save 
+00015610: 636f 7272 6563 7465 6420 6461 7461 2074  corrected data t
+00015620: 6f20 7361 7665 5f66 696c 6520 6669 7473  o save_file fits
+00015630: 2063 6174 616c 6f67 0a20 2020 2068 6475   catalog.    hdu
+00015640: 203d 2066 6974 732e 4269 6e54 6162 6c65   = fits.BinTable
+00015650: 4844 552e 6672 6f6d 5f63 6f6c 756d 6e73  HDU.from_columns
+00015660: 286e 6577 5f64 6174 6129 0a20 2020 2068  (new_data).    h
+00015670: 6475 2e77 7269 7465 746f 2873 6176 655f  du.writeto(save_
+00015680: 6669 6c65 290a 0a0a 2323 2323 2323 2323  file)...########
+00015690: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000156a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000156b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000156c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000156d0: 2323 2323 2323 2323 0a23 204d 6173 7465  ########.# Maste
+000156e0: 7220 7068 6f74 6f6d 6574 7279 0a0a 2323  r photometry..##
 000156f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00015700: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00015710: 2323 2323 0a23 204d 6173 7465 7220 7068  ####.# Master ph
-00015720: 6f74 6f6d 6574 7279 0a0a 2323 2323 2323  otometry..######
-00015730: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00015740: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00015750: 2323 2323 2323 230a 2320 4578 7472 6163  #######.# Extrac
-00015760: 7420 7068 6f74 6f6d 6574 7279 2066 726f  t photometry fro
-00015770: 6d20 5345 7874 7261 6374 6f72 2063 6174  m SExtractor cat
-00015780: 616c 6f67 730a 0a64 6566 2065 7874 7261  alogs..def extra
-00015790: 6374 5f73 6578 5f70 686f 746f 6d65 7472  ct_sex_photometr
-000157a0: 7928 6361 7461 6c6f 672c 2073 6176 655f  y(catalog, save_
-000157b0: 6669 6c65 2c20 6669 6c74 293a 0a20 2020  file, filt):.   
-000157c0: 2022 2222 0a20 2020 204c 6f61 6473 2061   """.    Loads a
-000157d0: 2053 4578 7472 6163 746f 7220 6361 7461   SExtractor cata
-000157e0: 6c6f 6720 616e 6420 6578 7472 6163 7473  log and extracts
-000157f0: 206f 6e6c 7920 7468 6520 5053 746f 7461   only the PStota
-00015800: 6c20 7068 6f74 6f6d 6574 7279 2c0a 2020  l photometry,.  
-00015810: 2020 7265 6e61 6d69 6e67 2074 6865 2063    renaming the c
-00015820: 6f6c 756d 6e73 2074 6f20 7468 6520 666f  olumns to the fo
-00015830: 726d 6174 2075 7365 6420 6279 2074 6865  rmat used by the
-00015840: 2070 6970 656c 696e 650a 0a20 2020 2050   pipeline..    P
-00015850: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-00015860: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 6174  --------.    cat
-00015870: 616c 6f67 203a 2073 7472 0a20 2020 2020  alog : str.     
-00015880: 2020 204c 6f63 6174 696f 6e20 6f66 2053     Location of S
-00015890: 4578 7472 6163 746f 7220 6f75 7470 7574  Extractor output
-000158a0: 2066 6974 7320 6361 7461 6c6f 670a 2020   fits catalog.  
-000158b0: 2020 7361 7665 5f66 696c 6520 3a20 7374    save_file : st
-000158c0: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
-000158d0: 6f6e 2074 6f20 7361 7665 2063 6174 616c  on to save catal
-000158e0: 6f67 2077 6974 6820 7068 6f74 6f6d 6574  og with photomet
-000158f0: 7279 206f 6e6c 790a 2020 2020 6669 6c74  ry only.    filt
-00015900: 203a 2073 7472 0a20 2020 2020 2020 204e   : str.        N
-00015910: 616d 6520 6f66 2074 6865 2063 6174 616c  ame of the catal
-00015920: 6f67 2773 2066 696c 7465 720a 0a20 2020  og's filter..   
-00015930: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
-00015940: 2d2d 2d2d 0a20 2020 2053 6176 6573 2066  ----.    Saves f
-00015950: 696c 6520 7769 7468 206f 6e6c 7920 7468  ile with only th
-00015960: 6520 7068 6f74 6f6d 6574 7279 0a0a 2020  e photometry..  
-00015970: 2020 2222 220a 0a20 2020 2066 696c 745f    """..    filt_
-00015980: 7374 616e 6461 7264 203d 2074 7261 6e73  standard = trans
-00015990: 6c61 7465 5f66 696c 7465 725f 7374 616e  late_filter_stan
-000159a0: 6461 7264 2866 696c 7429 0a0a 2020 2020  dard(filt)..    
-000159b0: 7068 6f74 6f6d 6574 7279 5f64 6174 6120  photometry_data 
-000159c0: 3d20 5b5d 0a0a 2020 2020 2320 4c6f 6164  = []..    # Load
-000159d0: 2064 6174 6120 6672 6f6d 2066 696c 7465   data from filte
-000159e0: 7220 6361 7461 6c6f 670a 2020 2020 6361  r catalog.    ca
-000159f0: 7420 2020 2020 203d 2066 6974 732e 6f70  t      = fits.op
-00015a00: 656e 2863 6174 616c 6f67 290a 2020 2020  en(catalog).    
-00015a10: 6361 745f 6461 7461 203d 2063 6174 5b31  cat_data = cat[1
-00015a20: 5d2e 6461 7461 0a0a 2020 2020 7068 6f74  ].data..    phot
-00015a30: 6f6d 6574 7279 5f64 6174 612e 6170 7065  ometry_data.appe
-00015a40: 6e64 2863 6174 5f64 6174 612e 636f 6c75  nd(cat_data.colu
-00015a50: 6d6e 735b 274e 554d 4245 5227 5d29 0a20  mns['NUMBER']). 
-00015a60: 2020 2070 686f 746f 6d65 7472 795f 6461     photometry_da
-00015a70: 7461 5b2d 315d 2e6e 616d 6520 3d20 6627  ta[-1].name = f'
-00015a80: 7b66 696c 747d 5f53 4578 4e75 6d62 6572  {filt}_SExNumber
-00015a90: 270a 0a20 2020 2070 686f 746f 6d65 7472  '..    photometr
-00015aa0: 795f 6461 7461 2e61 7070 656e 6428 6361  y_data.append(ca
-00015ab0: 745f 6461 7461 2e63 6f6c 756d 6e73 5b27  t_data.columns['
-00015ac0: 414c 5048 415f 4a32 3030 3027 5d29 0a20  ALPHA_J2000']). 
-00015ad0: 2020 2070 686f 746f 6d65 7472 795f 6461     photometry_da
-00015ae0: 7461 5b2d 315d 2e6e 616d 6520 3d20 2752  ta[-1].name = 'R
-00015af0: 4127 0a0a 2020 2020 7068 6f74 6f6d 6574  A'..    photomet
-00015b00: 7279 5f64 6174 612e 6170 7065 6e64 2863  ry_data.append(c
-00015b10: 6174 5f64 6174 612e 636f 6c75 6d6e 735b  at_data.columns[
-00015b20: 2744 454c 5441 5f4a 3230 3030 275d 290a  'DELTA_J2000']).
-00015b30: 2020 2020 7068 6f74 6f6d 6574 7279 5f64      photometry_d
-00015b40: 6174 615b 2d31 5d2e 6e61 6d65 203d 2027  ata[-1].name = '
-00015b50: 4445 4327 0a0a 2020 2020 7068 6f74 6f6d  DEC'..    photom
-00015b60: 6574 7279 5f64 6174 612e 6170 7065 6e64  etry_data.append
-00015b70: 2863 6174 5f64 6174 612e 636f 6c75 6d6e  (cat_data.column
-00015b80: 735b 2758 5f49 4d41 4745 275d 290a 2020  s['X_IMAGE']).  
-00015b90: 2020 7068 6f74 6f6d 6574 7279 5f64 6174    photometry_dat
-00015ba0: 615b 2d31 5d2e 6e61 6d65 203d 2027 5827  a[-1].name = 'X'
-00015bb0: 0a0a 2020 2020 7068 6f74 6f6d 6574 7279  ..    photometry
-00015bc0: 5f64 6174 612e 6170 7065 6e64 2863 6174  _data.append(cat
-00015bd0: 5f64 6174 612e 636f 6c75 6d6e 735b 2759  _data.columns['Y
-00015be0: 5f49 4d41 4745 275d 290a 2020 2020 7068  _IMAGE']).    ph
-00015bf0: 6f74 6f6d 6574 7279 5f64 6174 615b 2d31  otometry_data[-1
-00015c00: 5d2e 6e61 6d65 203d 2027 5927 0a0a 2020  ].name = 'Y'..  
+00015710: 2323 2323 2323 2323 2323 230a 2320 4578  ###########.# Ex
+00015720: 7472 6163 7420 7068 6f74 6f6d 6574 7279  tract photometry
+00015730: 2066 726f 6d20 5345 7874 7261 6374 6f72   from SExtractor
+00015740: 2063 6174 616c 6f67 730a 0a64 6566 2065   catalogs..def e
+00015750: 7874 7261 6374 5f73 6578 5f70 686f 746f  xtract_sex_photo
+00015760: 6d65 7472 7928 6361 7461 6c6f 672c 2073  metry(catalog, s
+00015770: 6176 655f 6669 6c65 2c20 6669 6c74 293a  ave_file, filt):
+00015780: 0a20 2020 2022 2222 0a20 2020 204c 6f61  .    """.    Loa
+00015790: 6473 2061 2053 4578 7472 6163 746f 7220  ds a SExtractor 
+000157a0: 6361 7461 6c6f 6720 616e 6420 6578 7472  catalog and extr
+000157b0: 6163 7473 206f 6e6c 7920 7468 6520 5053  acts only the PS
+000157c0: 746f 7461 6c20 7068 6f74 6f6d 6574 7279  total photometry
+000157d0: 2c0a 2020 2020 7265 6e61 6d69 6e67 2074  ,.    renaming t
+000157e0: 6865 2063 6f6c 756d 6e73 2074 6f20 7468  he columns to th
+000157f0: 6520 666f 726d 6174 2075 7365 6420 6279  e format used by
+00015800: 2074 6865 2070 6970 656c 696e 650a 0a20   the pipeline.. 
+00015810: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+00015820: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+00015830: 2063 6174 616c 6f67 203a 2073 7472 0a20   catalog : str. 
+00015840: 2020 2020 2020 204c 6f63 6174 696f 6e20         Location 
+00015850: 6f66 2053 4578 7472 6163 746f 7220 6f75  of SExtractor ou
+00015860: 7470 7574 2066 6974 7320 6361 7461 6c6f  tput fits catalo
+00015870: 670a 2020 2020 7361 7665 5f66 696c 6520  g.    save_file 
+00015880: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
+00015890: 6361 7469 6f6e 2074 6f20 7361 7665 2063  cation to save c
+000158a0: 6174 616c 6f67 2077 6974 6820 7068 6f74  atalog with phot
+000158b0: 6f6d 6574 7279 206f 6e6c 790a 2020 2020  ometry only.    
+000158c0: 6669 6c74 203a 2073 7472 0a20 2020 2020  filt : str.     
+000158d0: 2020 204e 616d 6520 6f66 2074 6865 2063     Name of the c
+000158e0: 6174 616c 6f67 2773 2066 696c 7465 720a  atalog's filter.
+000158f0: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
+00015900: 202d 2d2d 2d2d 2d2d 0a20 2020 2053 6176   -------.    Sav
+00015910: 6573 2066 696c 6520 7769 7468 206f 6e6c  es file with onl
+00015920: 7920 7468 6520 7068 6f74 6f6d 6574 7279  y the photometry
+00015930: 0a0a 2020 2020 2222 220a 0a20 2020 2066  ..    """..    f
+00015940: 696c 745f 7374 616e 6461 7264 203d 2074  ilt_standard = t
+00015950: 7261 6e73 6c61 7465 5f66 696c 7465 725f  ranslate_filter_
+00015960: 7374 616e 6461 7264 2866 696c 7429 0a0a  standard(filt)..
+00015970: 2020 2020 7068 6f74 6f6d 6574 7279 5f64      photometry_d
+00015980: 6174 6120 3d20 5b5d 0a0a 2020 2020 2320  ata = []..    # 
+00015990: 4c6f 6164 2064 6174 6120 6672 6f6d 2066  Load data from f
+000159a0: 696c 7465 7220 6361 7461 6c6f 670a 2020  ilter catalog.  
+000159b0: 2020 6361 7420 2020 2020 203d 2066 6974    cat      = fit
+000159c0: 732e 6f70 656e 2863 6174 616c 6f67 290a  s.open(catalog).
+000159d0: 2020 2020 6361 745f 6461 7461 203d 2063      cat_data = c
+000159e0: 6174 5b31 5d2e 6461 7461 0a0a 2020 2020  at[1].data..    
+000159f0: 7068 6f74 6f6d 6574 7279 5f64 6174 612e  photometry_data.
+00015a00: 6170 7065 6e64 2863 6174 5f64 6174 612e  append(cat_data.
+00015a10: 636f 6c75 6d6e 735b 274e 554d 4245 5227  columns['NUMBER'
+00015a20: 5d29 0a20 2020 2070 686f 746f 6d65 7472  ]).    photometr
+00015a30: 795f 6461 7461 5b2d 315d 2e6e 616d 6520  y_data[-1].name 
+00015a40: 3d20 6627 7b66 696c 747d 5f53 4578 4e75  = f'{filt}_SExNu
+00015a50: 6d62 6572 270a 0a20 2020 2070 686f 746f  mber'..    photo
+00015a60: 6d65 7472 795f 6461 7461 2e61 7070 656e  metry_data.appen
+00015a70: 6428 6361 745f 6461 7461 2e63 6f6c 756d  d(cat_data.colum
+00015a80: 6e73 5b27 414c 5048 415f 4a32 3030 3027  ns['ALPHA_J2000'
+00015a90: 5d29 0a20 2020 2070 686f 746f 6d65 7472  ]).    photometr
+00015aa0: 795f 6461 7461 5b2d 315d 2e6e 616d 6520  y_data[-1].name 
+00015ab0: 3d20 2752 4127 0a0a 2020 2020 7068 6f74  = 'RA'..    phot
+00015ac0: 6f6d 6574 7279 5f64 6174 612e 6170 7065  ometry_data.appe
+00015ad0: 6e64 2863 6174 5f64 6174 612e 636f 6c75  nd(cat_data.colu
+00015ae0: 6d6e 735b 2744 454c 5441 5f4a 3230 3030  mns['DELTA_J2000
+00015af0: 275d 290a 2020 2020 7068 6f74 6f6d 6574  ']).    photomet
+00015b00: 7279 5f64 6174 615b 2d31 5d2e 6e61 6d65  ry_data[-1].name
+00015b10: 203d 2027 4445 4327 0a0a 2020 2020 7068   = 'DEC'..    ph
+00015b20: 6f74 6f6d 6574 7279 5f64 6174 612e 6170  otometry_data.ap
+00015b30: 7065 6e64 2863 6174 5f64 6174 612e 636f  pend(cat_data.co
+00015b40: 6c75 6d6e 735b 2758 5f49 4d41 4745 275d  lumns['X_IMAGE']
+00015b50: 290a 2020 2020 7068 6f74 6f6d 6574 7279  ).    photometry
+00015b60: 5f64 6174 615b 2d31 5d2e 6e61 6d65 203d  _data[-1].name =
+00015b70: 2027 5827 0a0a 2020 2020 7068 6f74 6f6d   'X'..    photom
+00015b80: 6574 7279 5f64 6174 612e 6170 7065 6e64  etry_data.append
+00015b90: 2863 6174 5f64 6174 612e 636f 6c75 6d6e  (cat_data.column
+00015ba0: 735b 2759 5f49 4d41 4745 275d 290a 2020  s['Y_IMAGE']).  
+00015bb0: 2020 7068 6f74 6f6d 6574 7279 5f64 6174    photometry_dat
+00015bc0: 615b 2d31 5d2e 6e61 6d65 203d 2027 5927  a[-1].name = 'Y'
+00015bd0: 0a0a 2020 2020 7068 6f74 6f6d 6574 7279  ..    photometry
+00015be0: 5f64 6174 612e 6170 7065 6e64 2863 6174  _data.append(cat
+00015bf0: 5f64 6174 612e 636f 6c75 6d6e 735b 274d  _data.columns['M
+00015c00: 4147 5f50 5374 6f74 616c 275d 290a 2020  AG_PStotal']).  
 00015c10: 2020 7068 6f74 6f6d 6574 7279 5f64 6174    photometry_dat
-00015c20: 612e 6170 7065 6e64 2863 6174 5f64 6174  a.append(cat_dat
-00015c30: 612e 636f 6c75 6d6e 735b 274d 4147 5f50  a.columns['MAG_P
-00015c40: 5374 6f74 616c 275d 290a 2020 2020 7068  Stotal']).    ph
-00015c50: 6f74 6f6d 6574 7279 5f64 6174 615b 2d31  otometry_data[-1
-00015c60: 5d2e 6e61 6d65 203d 2066 2753 504c 5553  ].name = f'SPLUS
-00015c70: 5f7b 6669 6c74 7d27 0a0a 2020 2020 7068  _{filt}'..    ph
-00015c80: 6f74 6f6d 6574 7279 5f64 6174 612e 6170  otometry_data.ap
-00015c90: 7065 6e64 2863 6174 5f64 6174 612e 636f  pend(cat_data.co
-00015ca0: 6c75 6d6e 735b 274d 4147 4552 525f 5053  lumns['MAGERR_PS
-00015cb0: 746f 7461 6c27 5d29 0a20 2020 2070 686f  total']).    pho
-00015cc0: 746f 6d65 7472 795f 6461 7461 5b2d 315d  tometry_data[-1]
-00015cd0: 2e6e 616d 6520 3d20 6627 5350 4c55 535f  .name = f'SPLUS_
-00015ce0: 7b66 696c 747d 5f65 7272 270a 0a20 2020  {filt}_err'..   
-00015cf0: 2070 686f 746f 6d65 7472 795f 6461 7461   photometry_data
-00015d00: 2e61 7070 656e 6428 6361 745f 6461 7461  .append(cat_data
-00015d10: 2e63 6f6c 756d 6e73 5b27 434c 4153 535f  .columns['CLASS_
-00015d20: 5354 4152 275d 290a 2020 2020 7068 6f74  STAR']).    phot
-00015d30: 6f6d 6574 7279 5f64 6174 615b 2d31 5d2e  ometry_data[-1].
-00015d40: 6e61 6d65 203d 2066 2743 4c41 5353 5f53  name = f'CLASS_S
-00015d50: 5441 5227 0a0a 2020 2020 2320 4765 6e65  TAR'..    # Gene
-00015d60: 7261 7465 2048 4455 2066 726f 6d20 636f  rate HDU from co
-00015d70: 6c75 6d6e 730a 2020 2020 6864 7520 3d20  lumns.    hdu = 
-00015d80: 6669 7473 2e42 696e 5461 626c 6548 4455  fits.BinTableHDU
-00015d90: 2e66 726f 6d5f 636f 6c75 6d6e 7328 7068  .from_columns(ph
-00015da0: 6f74 6f6d 6574 7279 5f64 6174 6129 0a0a  otometry_data)..
-00015db0: 2020 2020 2320 5361 7665 206d 6173 7465      # Save maste
-00015dc0: 7220 4844 550a 2020 2020 6864 752e 7772  r HDU.    hdu.wr
-00015dd0: 6974 6574 6f28 7361 7665 5f66 696c 6529  iteto(save_file)
-00015de0: 0a20 2020 2070 7269 6e74 2827 4372 6561  .    print('Crea
-00015df0: 7465 6420 6669 6c65 2025 7327 2025 2073  ted file %s' % s
-00015e00: 6176 655f 6669 6c65 290a 0a0a 6465 6620  ave_file)...def 
-00015e10: 6578 7472 6163 745f 7073 665f 7068 6f74  extract_psf_phot
-00015e20: 6f6d 6574 7279 2863 6174 616c 6f67 2c20  ometry(catalog, 
-00015e30: 7361 7665 5f66 696c 652c 2066 696c 7429  save_file, filt)
-00015e40: 3a0a 2020 2020 2222 220a 2020 2020 4c6f  :.    """.    Lo
-00015e50: 6164 7320 6120 444f 5048 4f54 2063 6174  ads a DOPHOT cat
-00015e60: 616c 6f67 2061 6e64 2065 7874 7261 6374  alog and extract
-00015e70: 7320 6f6e 6c79 2074 6865 2070 686f 746f  s only the photo
-00015e80: 6d65 7472 792c 2072 656e 616d 696e 6720  metry, renaming 
-00015e90: 7468 650a 2020 2020 636f 6c75 6d6e 7320  the.    columns 
-00015ea0: 746f 2074 6865 2066 6f72 6d61 7420 7573  to the format us
-00015eb0: 6564 2062 7920 7468 6520 7069 7065 6c69  ed by the pipeli
-00015ec0: 6e65 2e0a 0a20 2020 2050 6172 616d 6574  ne...    Paramet
-00015ed0: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-00015ee0: 2d2d 0a20 2020 2063 6174 616c 6f67 203a  --.    catalog :
-00015ef0: 2073 7472 0a20 2020 2020 2020 204c 6f63   str.        Loc
-00015f00: 6174 696f 6e20 6f66 2064 6f70 686f 7420  ation of dophot 
-00015f10: 6f75 7470 7574 2061 7363 6969 2063 6174  output ascii cat
-00015f20: 616c 6f67 0a20 2020 2073 6176 655f 6669  alog.    save_fi
-00015f30: 6c65 203a 2073 7472 0a20 2020 2020 2020  le : str.       
-00015f40: 204c 6f63 6174 696f 6e20 746f 2073 6176   Location to sav
-00015f50: 6520 6361 7461 6c6f 6720 7769 7468 2070  e catalog with p
-00015f60: 686f 746f 6d65 7472 7920 6f6e 6c79 0a20  hotometry only. 
-00015f70: 2020 2066 696c 7420 3a20 7374 720a 2020     filt : str.  
-00015f80: 2020 2020 2020 4e61 6d65 206f 6620 7468        Name of th
-00015f90: 6520 6361 7461 6c6f 6727 7320 6669 6c74  e catalog's filt
-00015fa0: 6572 0a0a 2020 2020 5265 7475 726e 730a  er..    Returns.
-00015fb0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-00015fc0: 5361 7665 7320 6669 6c65 2077 6974 6820  Saves file with 
-00015fd0: 6f6e 6c79 2074 6865 2070 686f 746f 6d65  only the photome
-00015fe0: 7472 790a 0a20 2020 2022 2222 0a0a 2020  try..    """..  
-00015ff0: 2020 7068 6f74 6f6d 6574 7279 5f64 6174    photometry_dat
-00016000: 6120 3d20 5b5d 0a0a 2020 2020 2320 4c6f  a = []..    # Lo
-00016010: 6164 2064 6174 6120 6672 6f6d 2066 696c  ad data from fil
-00016020: 7465 7220 6361 7461 6c6f 670a 2020 2020  ter catalog.    
-00016030: 6361 745f 6461 7461 203d 2070 642e 7265  cat_data = pd.re
-00016040: 6164 5f63 7376 2863 6174 616c 6f67 2c0a  ad_csv(catalog,.
+00015c20: 615b 2d31 5d2e 6e61 6d65 203d 2066 2753  a[-1].name = f'S
+00015c30: 504c 5553 5f7b 6669 6c74 7d27 0a0a 2020  PLUS_{filt}'..  
+00015c40: 2020 7068 6f74 6f6d 6574 7279 5f64 6174    photometry_dat
+00015c50: 612e 6170 7065 6e64 2863 6174 5f64 6174  a.append(cat_dat
+00015c60: 612e 636f 6c75 6d6e 735b 274d 4147 4552  a.columns['MAGER
+00015c70: 525f 5053 746f 7461 6c27 5d29 0a20 2020  R_PStotal']).   
+00015c80: 2070 686f 746f 6d65 7472 795f 6461 7461   photometry_data
+00015c90: 5b2d 315d 2e6e 616d 6520 3d20 6627 5350  [-1].name = f'SP
+00015ca0: 4c55 535f 7b66 696c 747d 5f65 7272 270a  LUS_{filt}_err'.
+00015cb0: 0a20 2020 2070 686f 746f 6d65 7472 795f  .    photometry_
+00015cc0: 6461 7461 2e61 7070 656e 6428 6361 745f  data.append(cat_
+00015cd0: 6461 7461 2e63 6f6c 756d 6e73 5b27 434c  data.columns['CL
+00015ce0: 4153 535f 5354 4152 275d 290a 2020 2020  ASS_STAR']).    
+00015cf0: 7068 6f74 6f6d 6574 7279 5f64 6174 615b  photometry_data[
+00015d00: 2d31 5d2e 6e61 6d65 203d 2066 2743 4c41  -1].name = f'CLA
+00015d10: 5353 5f53 5441 5227 0a0a 2020 2020 2320  SS_STAR'..    # 
+00015d20: 4765 6e65 7261 7465 2048 4455 2066 726f  Generate HDU fro
+00015d30: 6d20 636f 6c75 6d6e 730a 2020 2020 6864  m columns.    hd
+00015d40: 7520 3d20 6669 7473 2e42 696e 5461 626c  u = fits.BinTabl
+00015d50: 6548 4455 2e66 726f 6d5f 636f 6c75 6d6e  eHDU.from_column
+00015d60: 7328 7068 6f74 6f6d 6574 7279 5f64 6174  s(photometry_dat
+00015d70: 6129 0a0a 2020 2020 2320 5361 7665 206d  a)..    # Save m
+00015d80: 6173 7465 7220 4844 550a 2020 2020 6864  aster HDU.    hd
+00015d90: 752e 7772 6974 6574 6f28 7361 7665 5f66  u.writeto(save_f
+00015da0: 696c 6529 0a20 2020 2070 7269 6e74 2827  ile).    print('
+00015db0: 4372 6561 7465 6420 6669 6c65 2025 7327  Created file %s'
+00015dc0: 2025 2073 6176 655f 6669 6c65 290a 0a0a   % save_file)...
+00015dd0: 6465 6620 6578 7472 6163 745f 7073 665f  def extract_psf_
+00015de0: 7068 6f74 6f6d 6574 7279 2863 6174 616c  photometry(catal
+00015df0: 6f67 2c20 7361 7665 5f66 696c 652c 2066  og, save_file, f
+00015e00: 696c 7429 3a0a 2020 2020 2222 220a 2020  ilt):.    """.  
+00015e10: 2020 4c6f 6164 7320 6120 444f 5048 4f54    Loads a DOPHOT
+00015e20: 2063 6174 616c 6f67 2061 6e64 2065 7874   catalog and ext
+00015e30: 7261 6374 7320 6f6e 6c79 2074 6865 2070  racts only the p
+00015e40: 686f 746f 6d65 7472 792c 2072 656e 616d  hotometry, renam
+00015e50: 696e 6720 7468 650a 2020 2020 636f 6c75  ing the.    colu
+00015e60: 6d6e 7320 746f 2074 6865 2066 6f72 6d61  mns to the forma
+00015e70: 7420 7573 6564 2062 7920 7468 6520 7069  t used by the pi
+00015e80: 7065 6c69 6e65 2e0a 0a20 2020 2050 6172  peline...    Par
+00015e90: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+00015ea0: 2d2d 2d2d 2d2d 0a20 2020 2063 6174 616c  ------.    catal
+00015eb0: 6f67 203a 2073 7472 0a20 2020 2020 2020  og : str.       
+00015ec0: 204c 6f63 6174 696f 6e20 6f66 2064 6f70   Location of dop
+00015ed0: 686f 7420 6f75 7470 7574 2061 7363 6969  hot output ascii
+00015ee0: 2063 6174 616c 6f67 0a20 2020 2073 6176   catalog.    sav
+00015ef0: 655f 6669 6c65 203a 2073 7472 0a20 2020  e_file : str.   
+00015f00: 2020 2020 204c 6f63 6174 696f 6e20 746f       Location to
+00015f10: 2073 6176 6520 6361 7461 6c6f 6720 7769   save catalog wi
+00015f20: 7468 2070 686f 746f 6d65 7472 7920 6f6e  th photometry on
+00015f30: 6c79 0a20 2020 2066 696c 7420 3a20 7374  ly.    filt : st
+00015f40: 720a 2020 2020 2020 2020 4e61 6d65 206f  r.        Name o
+00015f50: 6620 7468 6520 6361 7461 6c6f 6727 7320  f the catalog's 
+00015f60: 6669 6c74 6572 0a0a 2020 2020 5265 7475  filter..    Retu
+00015f70: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+00015f80: 2020 2020 5361 7665 7320 6669 6c65 2077      Saves file w
+00015f90: 6974 6820 6f6e 6c79 2074 6865 2070 686f  ith only the pho
+00015fa0: 746f 6d65 7472 790a 0a20 2020 2022 2222  tometry..    """
+00015fb0: 0a0a 2020 2020 7068 6f74 6f6d 6574 7279  ..    photometry
+00015fc0: 5f64 6174 6120 3d20 5b5d 0a0a 2020 2020  _data = []..    
+00015fd0: 2320 4c6f 6164 2064 6174 6120 6672 6f6d  # Load data from
+00015fe0: 2066 696c 7465 7220 6361 7461 6c6f 670a   filter catalog.
+00015ff0: 2020 2020 6361 745f 6461 7461 203d 2070      cat_data = p
+00016000: 642e 7265 6164 5f63 7376 2863 6174 616c  d.read_csv(catal
+00016010: 6f67 2c0a 2020 2020 2020 2020 2020 2020  og,.            
+00016020: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00016030: 656c 696d 5f77 6869 7465 7370 6163 653d  elim_whitespace=
+00016040: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
 00016050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016060: 2020 2020 2020 2020 2020 2064 656c 696d             delim
-00016070: 5f77 6869 7465 7370 6163 653d 5472 7565  _whitespace=True
-00016080: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00016090: 2020 2020 2020 2020 2020 2020 2065 7363               esc
-000160a0: 6170 6563 6861 7220 3d20 2223 2229 0a0a  apechar = "#")..
-000160b0: 2020 2020 2320 4765 7420 782c 7920 636f      # Get x,y co
-000160c0: 6f72 6469 6e61 7465 730a 2020 2020 7820  ordinates.    x 
-000160d0: 3d20 6361 745f 6461 7461 2e6c 6f63 5b3a  = cat_data.loc[:
-000160e0: 2c20 2778 706f 7327 5d2e 6172 7261 790a  , 'xpos'].array.
-000160f0: 2020 2020 7920 3d20 6361 745f 6461 7461      y = cat_data
-00016100: 2e6c 6f63 5b3a 2c20 2779 706f 7327 5d2e  .loc[:, 'ypos'].
-00016110: 6172 7261 790a 0a20 2020 2023 2047 6574  array..    # Get
-00016120: 2072 612c 6465 6320 636f 6f72 6469 6e61   ra,dec coordina
-00016130: 7465 730a 2020 2020 6669 6c74 5f73 7461  tes.    filt_sta
-00016140: 6e64 6172 6420 3d20 7472 616e 736c 6174  ndard = translat
-00016150: 655f 6669 6c74 6572 5f73 7461 6e64 6172  e_filter_standar
-00016160: 6428 6669 6c74 290a 2020 2020 7261 203d  d(filt).    ra =
-00016170: 2063 6174 5f64 6174 612e 6c6f 635b 3a2c   cat_data.loc[:,
-00016180: 2066 2752 415f 7b66 696c 745f 7374 616e   f'RA_{filt_stan
-00016190: 6461 7264 7d27 5d2e 6172 7261 790a 2020  dard}'].array.  
-000161a0: 2020 6465 6320 3d20 6361 745f 6461 7461    dec = cat_data
-000161b0: 2e6c 6f63 5b3a 2c20 6627 4445 435f 7b66  .loc[:, f'DEC_{f
-000161c0: 696c 745f 7374 616e 6461 7264 7d27 5d2e  ilt_standard}'].
-000161d0: 6172 7261 790a 0a20 2020 2023 2041 6464  array..    # Add
-000161e0: 206e 756d 6265 720a 2020 2020 636f 6c5f   number.    col_
-000161f0: 6172 7261 7920 3d20 6361 745f 6461 7461  array = cat_data
-00016200: 2e6c 6f63 5b3a 2c20 2720 5374 6172 5f6e  .loc[:, ' Star_n
-00016210: 756d 6265 7227 5d2e 6172 7261 790a 2020  umber'].array.  
-00016220: 2020 7068 6f74 6f6d 6574 7279 5f64 6174    photometry_dat
-00016230: 612e 6170 7065 6e64 2866 6974 732e 436f  a.append(fits.Co
-00016240: 6c75 6d6e 286e 616d 653d 6627 7b66 696c  lumn(name=f'{fil
-00016250: 747d 5f44 6f50 484f 544e 756d 6265 7227  t}_DoPHOTNumber'
-00016260: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00016060: 2065 7363 6170 6563 6861 7220 3d20 2223   escapechar = "#
+00016070: 2229 0a0a 2020 2020 2320 4765 7420 782c  ")..    # Get x,
+00016080: 7920 636f 6f72 6469 6e61 7465 730a 2020  y coordinates.  
+00016090: 2020 7820 3d20 6361 745f 6461 7461 2e6c    x = cat_data.l
+000160a0: 6f63 5b3a 2c20 2778 706f 7327 5d2e 6172  oc[:, 'xpos'].ar
+000160b0: 7261 790a 2020 2020 7920 3d20 6361 745f  ray.    y = cat_
+000160c0: 6461 7461 2e6c 6f63 5b3a 2c20 2779 706f  data.loc[:, 'ypo
+000160d0: 7327 5d2e 6172 7261 790a 0a20 2020 2023  s'].array..    #
+000160e0: 2047 6574 2072 612c 6465 6320 636f 6f72   Get ra,dec coor
+000160f0: 6469 6e61 7465 730a 2020 2020 6669 6c74  dinates.    filt
+00016100: 5f73 7461 6e64 6172 6420 3d20 7472 616e  _standard = tran
+00016110: 736c 6174 655f 6669 6c74 6572 5f73 7461  slate_filter_sta
+00016120: 6e64 6172 6428 6669 6c74 290a 2020 2020  ndard(filt).    
+00016130: 7261 203d 2063 6174 5f64 6174 612e 6c6f  ra = cat_data.lo
+00016140: 635b 3a2c 2066 2752 415f 7b66 696c 745f  c[:, f'RA_{filt_
+00016150: 7374 616e 6461 7264 7d27 5d2e 6172 7261  standard}'].arra
+00016160: 790a 2020 2020 6465 6320 3d20 6361 745f  y.    dec = cat_
+00016170: 6461 7461 2e6c 6f63 5b3a 2c20 6627 4445  data.loc[:, f'DE
+00016180: 435f 7b66 696c 745f 7374 616e 6461 7264  C_{filt_standard
+00016190: 7d27 5d2e 6172 7261 790a 0a20 2020 2023  }'].array..    #
+000161a0: 2041 6464 206e 756d 6265 720a 2020 2020   Add number.    
+000161b0: 636f 6c5f 6172 7261 7920 3d20 6361 745f  col_array = cat_
+000161c0: 6461 7461 2e6c 6f63 5b3a 2c20 2720 5374  data.loc[:, ' St
+000161d0: 6172 5f6e 756d 6265 7227 5d2e 6172 7261  ar_number'].arra
+000161e0: 790a 2020 2020 7068 6f74 6f6d 6574 7279  y.    photometry
+000161f0: 5f64 6174 612e 6170 7065 6e64 2866 6974  _data.append(fit
+00016200: 732e 436f 6c75 6d6e 286e 616d 653d 6627  s.Column(name=f'
+00016210: 7b66 696c 747d 5f44 6f50 484f 544e 756d  {filt}_DoPHOTNum
+00016220: 6265 7227 2c0a 2020 2020 2020 2020 2020  ber',.          
+00016230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016240: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00016250: 6d61 743d 2731 4a27 2c0a 2020 2020 2020  mat='1J',.      
+00016260: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00016270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016280: 2020 2020 2020 2020 2066 6f72 6d61 743d           format=
-00016290: 2731 4a27 2c0a 2020 2020 2020 2020 2020  '1J',.          
-000162a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000162b0: 2020 2020 2020 2020 2020 2020 2061 7272               arr
-000162c0: 6179 3d63 6f6c 5f61 7272 6179 2929 0a0a  ay=col_array))..
-000162d0: 2020 2020 2320 4164 6420 5241 0a20 2020      # Add RA.   
-000162e0: 2070 686f 746f 6d65 7472 795f 6461 7461   photometry_data
-000162f0: 2e61 7070 656e 6428 6669 7473 2e43 6f6c  .append(fits.Col
-00016300: 756d 6e28 6e61 6d65 3d66 2752 4127 2c0a  umn(name=f'RA',.
+00016280: 2061 7272 6179 3d63 6f6c 5f61 7272 6179   array=col_array
+00016290: 2929 0a0a 2020 2020 2320 4164 6420 5241  ))..    # Add RA
+000162a0: 0a20 2020 2070 686f 746f 6d65 7472 795f  .    photometry_
+000162b0: 6461 7461 2e61 7070 656e 6428 6669 7473  data.append(fits
+000162c0: 2e43 6f6c 756d 6e28 6e61 6d65 3d66 2752  .Column(name=f'R
+000162d0: 4127 2c0a 2020 2020 2020 2020 2020 2020  A',.            
+000162e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000162f0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+00016300: 743d 2731 4527 2c0a 2020 2020 2020 2020  t='1E',.        
 00016310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016330: 2020 2020 2020 2066 6f72 6d61 743d 2731         format='1
-00016340: 4527 2c0a 2020 2020 2020 2020 2020 2020  E',.            
-00016350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016360: 2020 2020 2020 2020 2020 2061 7272 6179             array
-00016370: 3d72 6129 290a 0a20 2020 2023 2041 6464  =ra))..    # Add
-00016380: 2044 4543 0a20 2020 2070 686f 746f 6d65   DEC.    photome
-00016390: 7472 795f 6461 7461 2e61 7070 656e 6428  try_data.append(
-000163a0: 6669 7473 2e43 6f6c 756d 6e28 6e61 6d65  fits.Column(name
-000163b0: 3d66 2744 4543 272c 0a20 2020 2020 2020  =f'DEC',.       
+00016320: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00016330: 7272 6179 3d72 6129 290a 0a20 2020 2023  rray=ra))..    #
+00016340: 2041 6464 2044 4543 0a20 2020 2070 686f   Add DEC.    pho
+00016350: 746f 6d65 7472 795f 6461 7461 2e61 7070  tometry_data.app
+00016360: 656e 6428 6669 7473 2e43 6f6c 756d 6e28  end(fits.Column(
+00016370: 6e61 6d65 3d66 2744 4543 272c 0a20 2020  name=f'DEC',.   
+00016380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000163a0: 2020 2020 666f 726d 6174 3d27 3145 272c      format='1E',
+000163b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 000163c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163e0: 666f 726d 6174 3d27 3145 272c 0a20 2020  format='1E',.   
-000163f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016410: 2020 2020 6172 7261 793d 6465 6329 290a      array=dec)).
-00016420: 0a20 2020 2023 2041 6464 2078 0a20 2020  .    # Add x.   
-00016430: 2070 686f 746f 6d65 7472 795f 6461 7461   photometry_data
-00016440: 2e61 7070 656e 6428 6669 7473 2e43 6f6c  .append(fits.Col
-00016450: 756d 6e28 6e61 6d65 3d66 2758 272c 0a20  umn(name=f'X',. 
+000163d0: 2020 2020 2020 2020 6172 7261 793d 6465          array=de
+000163e0: 6329 290a 0a20 2020 2023 2041 6464 2078  c))..    # Add x
+000163f0: 0a20 2020 2070 686f 746f 6d65 7472 795f  .    photometry_
+00016400: 6461 7461 2e61 7070 656e 6428 6669 7473  data.append(fits
+00016410: 2e43 6f6c 756d 6e28 6e61 6d65 3d66 2758  .Column(name=f'X
+00016420: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00016430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016440: 2020 2020 2020 2020 2020 666f 726d 6174            format
+00016450: 3d27 3145 272c 0a20 2020 2020 2020 2020  ='1E',.         
 00016460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016480: 2020 2020 2020 666f 726d 6174 3d27 3145        format='1E
-00016490: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000164a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000164b0: 2020 2020 2020 2020 2020 6172 7261 793d            array=
-000164c0: 7829 290a 0a20 2020 2023 2041 6464 2079  x))..    # Add y
-000164d0: 0a20 2020 2070 686f 746f 6d65 7472 795f  .    photometry_
-000164e0: 6461 7461 2e61 7070 656e 6428 6669 7473  data.append(fits
-000164f0: 2e43 6f6c 756d 6e28 6e61 6d65 3d66 2759  .Column(name=f'Y
-00016500: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00016470: 2020 2020 2020 2020 2020 2020 2020 6172                ar
+00016480: 7261 793d 7829 290a 0a20 2020 2023 2041  ray=x))..    # A
+00016490: 6464 2079 0a20 2020 2070 686f 746f 6d65  dd y.    photome
+000164a0: 7472 795f 6461 7461 2e61 7070 656e 6428  try_data.append(
+000164b0: 6669 7473 2e43 6f6c 756d 6e28 6e61 6d65  fits.Column(name
+000164c0: 3d66 2759 272c 0a20 2020 2020 2020 2020  =f'Y',.         
+000164d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000164e0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+000164f0: 726d 6174 3d27 3145 272c 0a20 2020 2020  rmat='1E',.     
+00016500: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00016510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016520: 2020 2020 2020 2020 2020 666f 726d 6174            format
-00016530: 3d27 3145 272c 0a20 2020 2020 2020 2020  ='1E',.         
-00016540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016550: 2020 2020 2020 2020 2020 2020 2020 6172                ar
-00016560: 7261 793d 7929 290a 0a20 2020 2023 2041  ray=y))..    # A
-00016570: 6464 206d 6167 0a20 2020 2063 6f6c 5f61  dd mag.    col_a
-00016580: 7272 6179 203d 2063 6174 5f64 6174 612e  rray = cat_data.
-00016590: 6c6f 635b 3a2c 2027 6669 746d 6167 275d  loc[:, 'fitmag']
-000165a0: 2e61 7272 6179 0a20 2020 2070 686f 746f  .array.    photo
-000165b0: 6d65 7472 795f 6461 7461 2e61 7070 656e  metry_data.appen
-000165c0: 6428 6669 7473 2e43 6f6c 756d 6e28 6e61  d(fits.Column(na
-000165d0: 6d65 3d66 2753 504c 5553 5f7b 6669 6c74  me=f'SPLUS_{filt
-000165e0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+00016520: 2020 6172 7261 793d 7929 290a 0a20 2020    array=y))..   
+00016530: 2023 2041 6464 206d 6167 0a20 2020 2063   # Add mag.    c
+00016540: 6f6c 5f61 7272 6179 203d 2063 6174 5f64  ol_array = cat_d
+00016550: 6174 612e 6c6f 635b 3a2c 2027 6669 746d  ata.loc[:, 'fitm
+00016560: 6167 275d 2e61 7272 6179 0a20 2020 2070  ag'].array.    p
+00016570: 686f 746f 6d65 7472 795f 6461 7461 2e61  hotometry_data.a
+00016580: 7070 656e 6428 6669 7473 2e43 6f6c 756d  ppend(fits.Colum
+00016590: 6e28 6e61 6d65 3d66 2753 504c 5553 5f7b  n(name=f'SPLUS_{
+000165a0: 6669 6c74 7d27 2c0a 2020 2020 2020 2020  filt}',.        
+000165b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000165d0: 6f72 6d61 743d 2731 4527 2c0a 2020 2020  ormat='1E',.    
+000165e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000165f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016600: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
-00016610: 743d 2731 4527 2c0a 2020 2020 2020 2020  t='1E',.        
-00016620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016630: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00016640: 7272 6179 3d63 6f6c 5f61 7272 6179 2929  rray=col_array))
-00016650: 0a0a 2020 2020 2320 4164 6420 6d61 6720  ..    # Add mag 
-00016660: 6572 726f 720a 2020 2020 636f 6c5f 6172  error.    col_ar
-00016670: 7261 7920 3d20 6361 745f 6461 7461 2e6c  ray = cat_data.l
-00016680: 6f63 5b3a 2c20 2765 7272 5f66 6974 6d61  oc[:, 'err_fitma
-00016690: 6727 5d2e 6172 7261 790a 2020 2020 7068  g'].array.    ph
-000166a0: 6f74 6f6d 6574 7279 5f64 6174 612e 6170  otometry_data.ap
-000166b0: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
-000166c0: 286e 616d 653d 6627 5350 4c55 535f 7b66  (name=f'SPLUS_{f
-000166d0: 696c 747d 5f65 7272 272c 0a20 2020 2020  ilt}_err',.     
+00016600: 2020 2061 7272 6179 3d63 6f6c 5f61 7272     array=col_arr
+00016610: 6179 2929 0a0a 2020 2020 2320 4164 6420  ay))..    # Add 
+00016620: 6d61 6720 6572 726f 720a 2020 2020 636f  mag error.    co
+00016630: 6c5f 6172 7261 7920 3d20 6361 745f 6461  l_array = cat_da
+00016640: 7461 2e6c 6f63 5b3a 2c20 2765 7272 5f66  ta.loc[:, 'err_f
+00016650: 6974 6d61 6727 5d2e 6172 7261 790a 2020  itmag'].array.  
+00016660: 2020 7068 6f74 6f6d 6574 7279 5f64 6174    photometry_dat
+00016670: 612e 6170 7065 6e64 2866 6974 732e 436f  a.append(fits.Co
+00016680: 6c75 6d6e 286e 616d 653d 6627 5350 4c55  lumn(name=f'SPLU
+00016690: 535f 7b66 696c 747d 5f65 7272 272c 0a20  S_{filt}_err',. 
+000166a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000166b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000166c0: 2020 2020 2020 666f 726d 6174 3d27 3145        format='1E
+000166d0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
 000166e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000166f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016700: 2020 666f 726d 6174 3d27 3145 272c 0a20    format='1E',. 
-00016710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016730: 2020 2020 2020 6172 7261 793d 636f 6c5f        array=col_
-00016740: 6172 7261 7929 290a 0a20 2020 2023 2041  array))..    # A
-00016750: 6464 2066 6c61 675f 7374 6172 0a20 2020  dd flag_star.   
-00016760: 2063 6f6c 5f61 7272 6179 203d 2063 6174   col_array = cat
-00016770: 5f64 6174 612e 6c6f 635b 3a2c 2027 464c  _data.loc[:, 'FL
-00016780: 4147 5f53 5441 5227 5d2e 6172 7261 790a  AG_STAR'].array.
-00016790: 2020 2020 7068 6f74 6f6d 6574 7279 5f64      photometry_d
-000167a0: 6174 612e 6170 7065 6e64 2866 6974 732e  ata.append(fits.
-000167b0: 436f 6c75 6d6e 286e 616d 653d 6627 434c  Column(name=f'CL
-000167c0: 4153 535f 5354 4152 272c 0a20 2020 2020  ASS_STAR',.     
+000166f0: 2020 2020 2020 2020 2020 6172 7261 793d            array=
+00016700: 636f 6c5f 6172 7261 7929 290a 0a20 2020  col_array))..   
+00016710: 2023 2041 6464 2066 6c61 675f 7374 6172   # Add flag_star
+00016720: 0a20 2020 2063 6f6c 5f61 7272 6179 203d  .    col_array =
+00016730: 2063 6174 5f64 6174 612e 6c6f 635b 3a2c   cat_data.loc[:,
+00016740: 2027 464c 4147 5f53 5441 5227 5d2e 6172   'FLAG_STAR'].ar
+00016750: 7261 790a 2020 2020 7068 6f74 6f6d 6574  ray.    photomet
+00016760: 7279 5f64 6174 612e 6170 7065 6e64 2866  ry_data.append(f
+00016770: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
+00016780: 6627 434c 4153 535f 5354 4152 272c 0a20  f'CLASS_STAR',. 
+00016790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000167a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000167b0: 2020 2020 2020 666f 726d 6174 3d27 3145        format='1E
+000167c0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
 000167d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000167e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000167f0: 2020 666f 726d 6174 3d27 3145 272c 0a20    format='1E',. 
-00016800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016820: 2020 2020 2020 6172 7261 793d 636f 6c5f        array=col_
-00016830: 6172 7261 7929 290a 0a20 2020 2023 2047  array))..    # G
-00016840: 656e 6572 6174 6520 4844 5520 6672 6f6d  enerate HDU from
-00016850: 2063 6f6c 756d 6e73 0a20 2020 2068 6475   columns.    hdu
-00016860: 203d 2066 6974 732e 4269 6e54 6162 6c65   = fits.BinTable
-00016870: 4844 552e 6672 6f6d 5f63 6f6c 756d 6e73  HDU.from_columns
-00016880: 2870 686f 746f 6d65 7472 795f 6461 7461  (photometry_data
-00016890: 290a 0a20 2020 2023 2053 6176 6520 6d61  )..    # Save ma
-000168a0: 7374 6572 2048 4455 0a20 2020 2068 6475  ster HDU.    hdu
-000168b0: 2e77 7269 7465 746f 2873 6176 655f 6669  .writeto(save_fi
-000168c0: 6c65 290a 2020 2020 7072 696e 7428 2743  le).    print('C
-000168d0: 7265 6174 6564 2066 696c 6520 2573 2720  reated file %s' 
-000168e0: 2520 7361 7665 5f66 696c 6529 0a0a 0a64  % save_file)...d
-000168f0: 6566 2066 6f72 6d61 745f 6d61 7374 6572  ef format_master
-00016900: 5f70 686f 746f 6d65 7472 7928 6361 7461  _photometry(cata
-00016910: 6c6f 672c 2073 6176 655f 6669 6c65 2c20  log, save_file, 
-00016920: 6669 6c74 6572 732c 2066 6965 6c64 203d  filters, field =
-00016930: 2027 4e6f 4669 656c 644e 616d 6527 2c0a   'NoFieldName',.
-00016940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016950: 2020 2020 2020 2020 2020 2020 2073 6578               sex
-00016960: 6d6f 6465 203d 2027 4e6f 5365 784d 6f64  mode = 'NoSexMod
-00016970: 6527 2c20 6472 6e61 6d65 203d 2027 4e6f  e', drname = 'No
-00016980: 4452 6e61 6d65 2729 3a0a 0a20 2020 2022  DRname'):..    "
-00016990: 2222 0a20 2020 2052 6561 6473 2074 6865  "".    Reads the
-000169a0: 2070 7265 7669 6f75 736c 7920 6372 6561   previously crea
-000169b0: 7465 6420 6d61 7374 6572 2063 6174 616c  ted master catal
-000169c0: 6f67 2061 6e64 2066 6f72 6d61 7473 2069  og and formats i
-000169d0: 7420 7265 6d6f 7669 6e67 0a20 2020 206d  t removing.    m
-000169e0: 756c 7469 706c 6520 636f 6c75 6d6e 7320  ultiple columns 
-000169f0: 616e 6420 6669 6c6c 696e 6720 6e61 6e20  and filling nan 
-00016a00: 7661 6c75 6573 2077 6974 6820 3939 2e0a  values with 99..
-00016a10: 0a20 2020 2052 412c 2044 4543 2c20 582c  .    RA, DEC, X,
-00016a20: 2059 2063 6f6c 756d 6e73 2061 7265 2073   Y columns are s
-00016a30: 656c 6563 7465 6420 6672 6f6d 2074 6865  elected from the
-00016a40: 2072 6564 6465 7374 2066 696c 7465 7220   reddest filter 
-00016a50: 696e 2077 6869 6368 2074 6865 0a20 2020  in which the.   
-00016a60: 2073 6f75 7263 6520 7761 7320 6465 7465   source was dete
-00016a70: 6374 6564 0a0a 2020 2020 5061 7261 6d65  cted..    Parame
-00016a80: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-00016a90: 2d2d 2d0a 2020 2020 6361 7461 6c6f 6720  ---.    catalog 
-00016aa0: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
-00016ab0: 6361 7469 6f6e 206f 6620 756e 666f 726d  cation of unform
-00016ac0: 6174 6564 206d 6173 7465 7220 7068 6f74  ated master phot
-00016ad0: 6f6d 6574 7279 2066 696c 650a 2020 2020  ometry file.    
-00016ae0: 7361 7665 5f66 696c 6520 3a20 7374 720a  save_file : str.
-00016af0: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
-00016b00: 2074 6f20 7361 7665 2066 6f72 6d61 7465   to save formate
-00016b10: 6420 6d61 7374 6572 2070 686f 746f 6d65  d master photome
-00016b20: 7472 7920 6669 6c65 0a20 2020 2066 696c  try file.    fil
-00016b30: 7465 7273 203a 2073 697a 6564 0a20 2020  ters : sized.   
-00016b40: 2020 2020 204c 6973 7420 6f66 2066 696c       List of fil
-00016b50: 7465 7273 2c20 6672 6f6d 2062 6c75 6573  ters, from blues
-00016b60: 7420 746f 2072 6564 6465 7374 0a20 2020  t to reddest.   
-00016b70: 2066 6965 6c64 203a 2073 7472 0a20 2020   field : str.   
-00016b80: 2020 2020 204e 616d 6520 6f66 2074 6865       Name of the
-00016b90: 2066 6965 6c64 2074 6f20 6265 2061 6464   field to be add
-00016ba0: 6564 2074 6f20 7468 6520 6669 6c74 6572  ed to the filter
-00016bb0: 5f49 440a 2020 2020 6472 6e61 6d65 203a  _ID.    drname :
-00016bc0: 2073 7472 0a20 2020 2020 2020 2044 6174   str.        Dat
-00016bd0: 6120 7265 6c65 6173 6520 6465 7369 676e  a release design
-00016be0: 6174 696f 6e20 746f 2062 6520 6164 6465  ation to be adde
-00016bf0: 6420 746f 2074 6865 2066 696c 7465 725f  d to the filter_
-00016c00: 4944 0a20 2020 2073 6578 6d6f 6465 203a  ID.    sexmode :
-00016c10: 2073 7472 0a20 2020 2020 2020 2064 7561   str.        dua
-00016c20: 6c2f 7369 6e67 6c65 2053 4578 7472 6163  l/single SExtrac
-00016c30: 746f 7220 6d6f 6465 2074 6f20 6265 2061  tor mode to be a
-00016c40: 6464 6564 2074 6f20 7468 6520 6669 6c74  dded to the filt
-00016c50: 6572 5f49 440a 0a20 2020 2052 6574 7572  er_ID..    Retur
-00016c60: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-00016c70: 2020 2053 6176 6573 2066 6f72 6d61 7465     Saves formate
-00016c80: 6420 6d61 7374 6572 2070 686f 746f 6d65  d master photome
-00016c90: 7472 7920 6669 6c65 0a20 2020 2022 2222  try file.    """
-00016ca0: 0a0a 2020 2020 7068 6f74 6f6d 6574 7279  ..    photometry
-00016cb0: 5f64 6174 6120 3d20 5b5d 0a0a 2020 2020  _data = []..    
-00016cc0: 2320 4c6f 6164 2064 6174 6120 6672 6f6d  # Load data from
-00016cd0: 2066 696c 7465 7220 6361 7461 6c6f 670a   filter catalog.
-00016ce0: 2020 2020 6361 7420 2020 2020 203d 2066      cat      = f
-00016cf0: 6974 732e 6f70 656e 2863 6174 616c 6f67  its.open(catalog
-00016d00: 290a 2020 2020 6361 745f 6461 7461 203d  ).    cat_data =
-00016d10: 2063 6174 5b31 5d2e 6461 7461 0a0a 2020   cat[1].data..  
-00016d20: 2020 4e20 3d20 6361 745f 6461 7461 2e73    N = cat_data.s
-00016d30: 6861 7065 5b30 5d0a 0a20 2020 2063 616c  hape[0]..    cal
-00016d40: 6962 5f49 4420 3d20 5b66 2763 616c 6962  ib_ID = [f'calib
-00016d50: 5f7b 6472 6e61 6d65 7d5f 7b66 6965 6c64  _{drname}_{field
-00016d60: 7d5f 7b73 6578 6d6f 6465 7d5f 7b69 3a30  }_{sexmode}_{i:0
-00016d70: 3764 7d27 0a20 2020 2020 2020 2020 2020  7d}'.           
-00016d80: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
-00016d90: 6e67 6528 312c 204e 2b31 295d 0a0a 2020  nge(1, N+1)]..  
-00016da0: 2020 7261 2020 3d20 6e70 2e66 756c 6c28    ra  = np.full(
-00016db0: 4e2c 206e 702e 6e61 6e29 0a20 2020 2064  N, np.nan).    d
-00016dc0: 6563 203d 206e 702e 6675 6c6c 284e 2c20  ec = np.full(N, 
-00016dd0: 6e70 2e6e 616e 290a 0a20 2020 2078 203d  np.nan)..    x =
-00016de0: 206e 702e 6675 6c6c 284e 2c20 6e70 2e6e   np.full(N, np.n
-00016df0: 616e 290a 2020 2020 7920 3d20 6e70 2e66  an).    y = np.f
-00016e00: 756c 6c28 4e2c 206e 702e 6e61 6e29 0a0a  ull(N, np.nan)..
-00016e10: 2020 2020 636c 6173 735f 7374 6172 203d      class_star =
-00016e20: 206e 702e 6675 6c6c 284e 2c20 6e70 2e6e   np.full(N, np.n
-00016e30: 616e 290a 0a20 2020 2023 2041 6464 206e  an)..    # Add n
-00016e40: 6577 206e 756d 6265 7220 636f 6c75 6d6e  ew number column
-00016e50: 2074 6f20 6e65 7720 6669 7473 2063 6174   to new fits cat
-00016e60: 616c 6f67 0a20 2020 2070 686f 746f 6d65  alog.    photome
-00016e70: 7472 795f 6461 7461 2e61 7070 656e 6428  try_data.append(
-00016e80: 6669 7473 2e43 6f6c 756d 6e28 6e61 6d65  fits.Column(name
-00016e90: 2020 203d 2027 6361 6c69 625f 4944 272c     = 'calib_ID',
-00016ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000167e0: 2020 2020 2020 2020 2020 6172 7261 793d            array=
+000167f0: 636f 6c5f 6172 7261 7929 290a 0a20 2020  col_array))..   
+00016800: 2023 2047 656e 6572 6174 6520 4844 5520   # Generate HDU 
+00016810: 6672 6f6d 2063 6f6c 756d 6e73 0a20 2020  from columns.   
+00016820: 2068 6475 203d 2066 6974 732e 4269 6e54   hdu = fits.BinT
+00016830: 6162 6c65 4844 552e 6672 6f6d 5f63 6f6c  ableHDU.from_col
+00016840: 756d 6e73 2870 686f 746f 6d65 7472 795f  umns(photometry_
+00016850: 6461 7461 290a 0a20 2020 2023 2053 6176  data)..    # Sav
+00016860: 6520 6d61 7374 6572 2048 4455 0a20 2020  e master HDU.   
+00016870: 2068 6475 2e77 7269 7465 746f 2873 6176   hdu.writeto(sav
+00016880: 655f 6669 6c65 290a 2020 2020 7072 696e  e_file).    prin
+00016890: 7428 2743 7265 6174 6564 2066 696c 6520  t('Created file 
+000168a0: 2573 2720 2520 7361 7665 5f66 696c 6529  %s' % save_file)
+000168b0: 0a0a 0a64 6566 2066 6f72 6d61 745f 6d61  ...def format_ma
+000168c0: 7374 6572 5f70 686f 746f 6d65 7472 7928  ster_photometry(
+000168d0: 6361 7461 6c6f 672c 2073 6176 655f 6669  catalog, save_fi
+000168e0: 6c65 2c20 6669 6c74 6572 732c 2066 6965  le, filters, fie
+000168f0: 6c64 203d 2027 4e6f 4669 656c 644e 616d  ld = 'NoFieldNam
+00016900: 6527 2c0a 2020 2020 2020 2020 2020 2020  e',.            
+00016910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016920: 2073 6578 6d6f 6465 203d 2027 4e6f 5365   sexmode = 'NoSe
+00016930: 784d 6f64 6527 2c20 6472 6e61 6d65 203d  xMode', drname =
+00016940: 2027 4e6f 4452 6e61 6d65 2729 3a0a 0a20   'NoDRname'):.. 
+00016950: 2020 2022 2222 0a20 2020 2052 6561 6473     """.    Reads
+00016960: 2074 6865 2070 7265 7669 6f75 736c 7920   the previously 
+00016970: 6372 6561 7465 6420 6d61 7374 6572 2063  created master c
+00016980: 6174 616c 6f67 2061 6e64 2066 6f72 6d61  atalog and forma
+00016990: 7473 2069 7420 7265 6d6f 7669 6e67 0a20  ts it removing. 
+000169a0: 2020 206d 756c 7469 706c 6520 636f 6c75     multiple colu
+000169b0: 6d6e 7320 616e 6420 6669 6c6c 696e 6720  mns and filling 
+000169c0: 6e61 6e20 7661 6c75 6573 2077 6974 6820  nan values with 
+000169d0: 3939 2e0a 0a20 2020 2052 412c 2044 4543  99...    RA, DEC
+000169e0: 2c20 582c 2059 2063 6f6c 756d 6e73 2061  , X, Y columns a
+000169f0: 7265 2073 656c 6563 7465 6420 6672 6f6d  re selected from
+00016a00: 2074 6865 2072 6564 6465 7374 2066 696c   the reddest fil
+00016a10: 7465 7220 696e 2077 6869 6368 2074 6865  ter in which the
+00016a20: 0a20 2020 2073 6f75 7263 6520 7761 7320  .    source was 
+00016a30: 6465 7465 6374 6564 0a0a 2020 2020 5061  detected..    Pa
+00016a40: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00016a50: 2d2d 2d2d 2d2d 2d0a 2020 2020 6361 7461  -------.    cata
+00016a60: 6c6f 6720 3a20 7374 720a 2020 2020 2020  log : str.      
+00016a70: 2020 4c6f 6361 7469 6f6e 206f 6620 756e    Location of un
+00016a80: 666f 726d 6174 6564 206d 6173 7465 7220  formated master 
+00016a90: 7068 6f74 6f6d 6574 7279 2066 696c 650a  photometry file.
+00016aa0: 2020 2020 7361 7665 5f66 696c 6520 3a20      save_file : 
+00016ab0: 7374 720a 2020 2020 2020 2020 4c6f 6361  str.        Loca
+00016ac0: 7469 6f6e 2074 6f20 7361 7665 2066 6f72  tion to save for
+00016ad0: 6d61 7465 6420 6d61 7374 6572 2070 686f  mated master pho
+00016ae0: 746f 6d65 7472 7920 6669 6c65 0a20 2020  tometry file.   
+00016af0: 2066 696c 7465 7273 203a 2073 697a 6564   filters : sized
+00016b00: 0a20 2020 2020 2020 204c 6973 7420 6f66  .        List of
+00016b10: 2066 696c 7465 7273 2c20 6672 6f6d 2062   filters, from b
+00016b20: 6c75 6573 7420 746f 2072 6564 6465 7374  luest to reddest
+00016b30: 0a20 2020 2066 6965 6c64 203a 2073 7472  .    field : str
+00016b40: 0a20 2020 2020 2020 204e 616d 6520 6f66  .        Name of
+00016b50: 2074 6865 2066 6965 6c64 2074 6f20 6265   the field to be
+00016b60: 2061 6464 6564 2074 6f20 7468 6520 6669   added to the fi
+00016b70: 6c74 6572 5f49 440a 2020 2020 6472 6e61  lter_ID.    drna
+00016b80: 6d65 203a 2073 7472 0a20 2020 2020 2020  me : str.       
+00016b90: 2044 6174 6120 7265 6c65 6173 6520 6465   Data release de
+00016ba0: 7369 676e 6174 696f 6e20 746f 2062 6520  signation to be 
+00016bb0: 6164 6465 6420 746f 2074 6865 2066 696c  added to the fil
+00016bc0: 7465 725f 4944 0a20 2020 2073 6578 6d6f  ter_ID.    sexmo
+00016bd0: 6465 203a 2073 7472 0a20 2020 2020 2020  de : str.       
+00016be0: 2064 7561 6c2f 7369 6e67 6c65 2053 4578   dual/single SEx
+00016bf0: 7472 6163 746f 7220 6d6f 6465 2074 6f20  tractor mode to 
+00016c00: 6265 2061 6464 6564 2074 6f20 7468 6520  be added to the 
+00016c10: 6669 6c74 6572 5f49 440a 0a20 2020 2052  filter_ID..    R
+00016c20: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
+00016c30: 2d2d 0a20 2020 2053 6176 6573 2066 6f72  --.    Saves for
+00016c40: 6d61 7465 6420 6d61 7374 6572 2070 686f  mated master pho
+00016c50: 746f 6d65 7472 7920 6669 6c65 0a20 2020  tometry file.   
+00016c60: 2022 2222 0a0a 2020 2020 7068 6f74 6f6d   """..    photom
+00016c70: 6574 7279 5f64 6174 6120 3d20 5b5d 0a0a  etry_data = []..
+00016c80: 2020 2020 2320 4c6f 6164 2064 6174 6120      # Load data 
+00016c90: 6672 6f6d 2066 696c 7465 7220 6361 7461  from filter cata
+00016ca0: 6c6f 670a 2020 2020 6361 7420 2020 2020  log.    cat     
+00016cb0: 203d 2066 6974 732e 6f70 656e 2863 6174   = fits.open(cat
+00016cc0: 616c 6f67 290a 2020 2020 6361 745f 6461  alog).    cat_da
+00016cd0: 7461 203d 2063 6174 5b31 5d2e 6461 7461  ta = cat[1].data
+00016ce0: 0a0a 2020 2020 4e20 3d20 6361 745f 6461  ..    N = cat_da
+00016cf0: 7461 2e73 6861 7065 5b30 5d0a 0a20 2020  ta.shape[0]..   
+00016d00: 2063 616c 6962 5f49 4420 3d20 5b66 2763   calib_ID = [f'c
+00016d10: 616c 6962 5f7b 6472 6e61 6d65 7d5f 7b66  alib_{drname}_{f
+00016d20: 6965 6c64 7d5f 7b73 6578 6d6f 6465 7d5f  ield}_{sexmode}_
+00016d30: 7b69 3a30 3764 7d27 0a20 2020 2020 2020  {i:07d}'.       
+00016d40: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
+00016d50: 6e20 7261 6e67 6528 312c 204e 2b31 295d  n range(1, N+1)]
+00016d60: 0a0a 2020 2020 7261 2020 3d20 6e70 2e66  ..    ra  = np.f
+00016d70: 756c 6c28 4e2c 206e 702e 6e61 6e29 0a20  ull(N, np.nan). 
+00016d80: 2020 2064 6563 203d 206e 702e 6675 6c6c     dec = np.full
+00016d90: 284e 2c20 6e70 2e6e 616e 290a 0a20 2020  (N, np.nan)..   
+00016da0: 2078 203d 206e 702e 6675 6c6c 284e 2c20   x = np.full(N, 
+00016db0: 6e70 2e6e 616e 290a 2020 2020 7920 3d20  np.nan).    y = 
+00016dc0: 6e70 2e66 756c 6c28 4e2c 206e 702e 6e61  np.full(N, np.na
+00016dd0: 6e29 0a0a 2020 2020 636c 6173 735f 7374  n)..    class_st
+00016de0: 6172 203d 206e 702e 6675 6c6c 284e 2c20  ar = np.full(N, 
+00016df0: 6e70 2e6e 616e 290a 0a20 2020 2023 2041  np.nan)..    # A
+00016e00: 6464 206e 6577 206e 756d 6265 7220 636f  dd new number co
+00016e10: 6c75 6d6e 2074 6f20 6e65 7720 6669 7473  lumn to new fits
+00016e20: 2063 6174 616c 6f67 0a20 2020 2070 686f   catalog.    pho
+00016e30: 746f 6d65 7472 795f 6461 7461 2e61 7070  tometry_data.app
+00016e40: 656e 6428 6669 7473 2e43 6f6c 756d 6e28  end(fits.Column(
+00016e50: 6e61 6d65 2020 203d 2027 6361 6c69 625f  name   = 'calib_
+00016e60: 4944 272c 0a20 2020 2020 2020 2020 2020  ID',.           
+00016e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e80: 2020 2020 2020 2020 2020 2020 666f 726d              form
+00016e90: 6174 203d 2027 3530 4127 2c0a 2020 2020  at = '50A',.    
+00016ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00016eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ec0: 2020 2020 2020 2020 666f 726d 6174 203d          format =
-00016ed0: 2027 3530 4127 2c0a 2020 2020 2020 2020   '50A',.        
-00016ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ef0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00016f00: 7272 6179 2020 3d20 6361 6c69 625f 4944  rray  = calib_ID
-00016f10: 2929 0a0a 2020 2020 2320 4974 6572 6174  ))..    # Iterat
-00016f20: 6976 656c 7920 6669 6c6c 2063 6f6f 7264  ively fill coord
-00016f30: 7320 616e 6420 636c 6173 735f 7374 6172  s and class_star
-00016f40: 0a20 2020 2066 6f72 2069 2069 6e20 7261  .    for i in ra
-00016f50: 6e67 6528 6c65 6e28 6669 6c74 6572 7329  nge(len(filters)
-00016f60: 2c20 302c 202d 3129 3a0a 2020 2020 2020  , 0, -1):.      
-00016f70: 2020 7261 5f69 203d 2063 6174 5f64 6174    ra_i = cat_dat
-00016f80: 612e 636f 6c75 6d6e 735b 6627 5241 5f7b  a.columns[f'RA_{
-00016f90: 697d 275d 2e61 7272 6179 0a20 2020 2020  i}'].array.     
-00016fa0: 2020 2072 615b 6e70 2e69 736e 616e 2872     ra[np.isnan(r
-00016fb0: 6129 5d20 3d20 7261 5f69 5b6e 702e 6973  a)] = ra_i[np.is
-00016fc0: 6e61 6e28 7261 295d 0a0a 2020 2020 2020  nan(ra)]..      
-00016fd0: 2020 6465 635f 6920 3d20 6361 745f 6461    dec_i = cat_da
-00016fe0: 7461 2e63 6f6c 756d 6e73 5b66 2744 4543  ta.columns[f'DEC
-00016ff0: 5f7b 697d 275d 2e61 7272 6179 0a20 2020  _{i}'].array.   
-00017000: 2020 2020 2064 6563 5b6e 702e 6973 6e61       dec[np.isna
-00017010: 6e28 6465 6329 5d20 3d20 6465 635f 695b  n(dec)] = dec_i[
-00017020: 6e70 2e69 736e 616e 2864 6563 295d 0a0a  np.isnan(dec)]..
-00017030: 2020 2020 2020 2020 785f 6920 3d20 6361          x_i = ca
-00017040: 745f 6461 7461 2e63 6f6c 756d 6e73 5b66  t_data.columns[f
-00017050: 2758 5f7b 697d 275d 2e61 7272 6179 0a20  'X_{i}'].array. 
-00017060: 2020 2020 2020 2078 5b6e 702e 6973 6e61         x[np.isna
-00017070: 6e28 7829 5d20 3d20 785f 695b 6e70 2e69  n(x)] = x_i[np.i
-00017080: 736e 616e 2878 295d 0a0a 2020 2020 2020  snan(x)]..      
-00017090: 2020 795f 6920 3d20 6361 745f 6461 7461    y_i = cat_data
-000170a0: 2e63 6f6c 756d 6e73 5b66 2759 5f7b 697d  .columns[f'Y_{i}
-000170b0: 275d 2e61 7272 6179 0a20 2020 2020 2020  '].array.       
-000170c0: 2079 5b6e 702e 6973 6e61 6e28 7929 5d20   y[np.isnan(y)] 
-000170d0: 3d20 795f 695b 6e70 2e69 736e 616e 2879  = y_i[np.isnan(y
-000170e0: 295d 0a0a 2020 2020 2020 2020 636c 6173  )]..        clas
-000170f0: 735f 7374 6172 5f69 203d 2063 6174 5f64  s_star_i = cat_d
-00017100: 6174 612e 636f 6c75 6d6e 735b 6627 434c  ata.columns[f'CL
-00017110: 4153 535f 5354 4152 5f7b 697d 275d 2e61  ASS_STAR_{i}'].a
-00017120: 7272 6179 0a20 2020 2020 2020 2063 6c61  rray.        cla
-00017130: 7373 5f73 7461 725b 6e70 2e69 736e 616e  ss_star[np.isnan
-00017140: 2863 6c61 7373 5f73 7461 7229 5d20 3d20  (class_star)] = 
-00017150: 636c 6173 735f 7374 6172 5f69 5b6e 702e  class_star_i[np.
-00017160: 6973 6e61 6e28 636c 6173 735f 7374 6172  isnan(class_star
-00017170: 295d 0a0a 2020 2020 2320 4164 6420 746f  )]..    # Add to
-00017180: 206e 6577 2066 6974 7320 6361 7461 6c6f   new fits catalo
-00017190: 670a 2020 2020 7068 6f74 6f6d 6574 7279  g.    photometry
-000171a0: 5f64 6174 612e 6170 7065 6e64 2866 6974  _data.append(fit
-000171b0: 732e 436f 6c75 6d6e 286e 616d 6520 2020  s.Column(name   
-000171c0: 3d20 2752 414a 3230 3030 272c 0a20 2020  = 'RAJ2000',.   
+00016ec0: 2020 2061 7272 6179 2020 3d20 6361 6c69     array  = cali
+00016ed0: 625f 4944 2929 0a0a 2020 2020 2320 4974  b_ID))..    # It
+00016ee0: 6572 6174 6976 656c 7920 6669 6c6c 2063  eratively fill c
+00016ef0: 6f6f 7264 7320 616e 6420 636c 6173 735f  oords and class_
+00016f00: 7374 6172 0a20 2020 2066 6f72 2069 2069  star.    for i i
+00016f10: 6e20 7261 6e67 6528 6c65 6e28 6669 6c74  n range(len(filt
+00016f20: 6572 7329 2c20 302c 202d 3129 3a0a 2020  ers), 0, -1):.  
+00016f30: 2020 2020 2020 7261 5f69 203d 2063 6174        ra_i = cat
+00016f40: 5f64 6174 612e 636f 6c75 6d6e 735b 6627  _data.columns[f'
+00016f50: 5241 5f7b 697d 275d 2e61 7272 6179 0a20  RA_{i}'].array. 
+00016f60: 2020 2020 2020 2072 615b 6e70 2e69 736e         ra[np.isn
+00016f70: 616e 2872 6129 5d20 3d20 7261 5f69 5b6e  an(ra)] = ra_i[n
+00016f80: 702e 6973 6e61 6e28 7261 295d 0a0a 2020  p.isnan(ra)]..  
+00016f90: 2020 2020 2020 6465 635f 6920 3d20 6361        dec_i = ca
+00016fa0: 745f 6461 7461 2e63 6f6c 756d 6e73 5b66  t_data.columns[f
+00016fb0: 2744 4543 5f7b 697d 275d 2e61 7272 6179  'DEC_{i}'].array
+00016fc0: 0a20 2020 2020 2020 2064 6563 5b6e 702e  .        dec[np.
+00016fd0: 6973 6e61 6e28 6465 6329 5d20 3d20 6465  isnan(dec)] = de
+00016fe0: 635f 695b 6e70 2e69 736e 616e 2864 6563  c_i[np.isnan(dec
+00016ff0: 295d 0a0a 2020 2020 2020 2020 785f 6920  )]..        x_i 
+00017000: 3d20 6361 745f 6461 7461 2e63 6f6c 756d  = cat_data.colum
+00017010: 6e73 5b66 2758 5f7b 697d 275d 2e61 7272  ns[f'X_{i}'].arr
+00017020: 6179 0a20 2020 2020 2020 2078 5b6e 702e  ay.        x[np.
+00017030: 6973 6e61 6e28 7829 5d20 3d20 785f 695b  isnan(x)] = x_i[
+00017040: 6e70 2e69 736e 616e 2878 295d 0a0a 2020  np.isnan(x)]..  
+00017050: 2020 2020 2020 795f 6920 3d20 6361 745f        y_i = cat_
+00017060: 6461 7461 2e63 6f6c 756d 6e73 5b66 2759  data.columns[f'Y
+00017070: 5f7b 697d 275d 2e61 7272 6179 0a20 2020  _{i}'].array.   
+00017080: 2020 2020 2079 5b6e 702e 6973 6e61 6e28       y[np.isnan(
+00017090: 7929 5d20 3d20 795f 695b 6e70 2e69 736e  y)] = y_i[np.isn
+000170a0: 616e 2879 295d 0a0a 2020 2020 2020 2020  an(y)]..        
+000170b0: 636c 6173 735f 7374 6172 5f69 203d 2063  class_star_i = c
+000170c0: 6174 5f64 6174 612e 636f 6c75 6d6e 735b  at_data.columns[
+000170d0: 6627 434c 4153 535f 5354 4152 5f7b 697d  f'CLASS_STAR_{i}
+000170e0: 275d 2e61 7272 6179 0a20 2020 2020 2020  '].array.       
+000170f0: 2063 6c61 7373 5f73 7461 725b 6e70 2e69   class_star[np.i
+00017100: 736e 616e 2863 6c61 7373 5f73 7461 7229  snan(class_star)
+00017110: 5d20 3d20 636c 6173 735f 7374 6172 5f69  ] = class_star_i
+00017120: 5b6e 702e 6973 6e61 6e28 636c 6173 735f  [np.isnan(class_
+00017130: 7374 6172 295d 0a0a 2020 2020 2320 4164  star)]..    # Ad
+00017140: 6420 746f 206e 6577 2066 6974 7320 6361  d to new fits ca
+00017150: 7461 6c6f 670a 2020 2020 7068 6f74 6f6d  talog.    photom
+00017160: 6574 7279 5f64 6174 612e 6170 7065 6e64  etry_data.append
+00017170: 2866 6974 732e 436f 6c75 6d6e 286e 616d  (fits.Column(nam
+00017180: 6520 2020 3d20 2752 414a 3230 3030 272c  e   = 'RAJ2000',
+00017190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000171a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000171b0: 2020 2020 2020 2020 666f 726d 6174 203d          format =
+000171c0: 2027 3145 272c 0a20 2020 2020 2020 2020   '1E',.         
 000171d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000171e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000171f0: 2020 2020 666f 726d 6174 203d 2027 3145      format = '1E
-00017200: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00017210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017220: 2020 2020 2020 2020 2020 6172 7261 7920            array 
-00017230: 203d 2072 6129 290a 0a20 2020 2070 686f   = ra))..    pho
-00017240: 746f 6d65 7472 795f 6461 7461 2e61 7070  tometry_data.app
-00017250: 656e 6428 6669 7473 2e43 6f6c 756d 6e28  end(fits.Column(
-00017260: 6e61 6d65 2020 203d 2027 4445 4a32 3030  name   = 'DEJ200
-00017270: 3027 2c0a 2020 2020 2020 2020 2020 2020  0',.            
+000171e0: 2020 2020 2020 2020 2020 2020 2020 6172                ar
+000171f0: 7261 7920 203d 2072 6129 290a 0a20 2020  ray  = ra))..   
+00017200: 2070 686f 746f 6d65 7472 795f 6461 7461   photometry_data
+00017210: 2e61 7070 656e 6428 6669 7473 2e43 6f6c  .append(fits.Col
+00017220: 756d 6e28 6e61 6d65 2020 203d 2027 4445  umn(name   = 'DE
+00017230: 4a32 3030 3027 2c0a 2020 2020 2020 2020  J2000',.        
+00017240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017250: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00017260: 6f72 6d61 7420 3d20 2731 4527 2c0a 2020  ormat = '1E',.  
+00017270: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00017280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017290: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
-000172a0: 7420 3d20 2731 4527 2c0a 2020 2020 2020  t = '1E',.      
-000172b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000172c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000172d0: 2061 7272 6179 2020 3d20 6465 6329 290a   array  = dec)).
-000172e0: 0a20 2020 2070 686f 746f 6d65 7472 795f  .    photometry_
-000172f0: 6461 7461 2e61 7070 656e 6428 6669 7473  data.append(fits
-00017300: 2e43 6f6c 756d 6e28 6e61 6d65 2020 203d  .Column(name   =
-00017310: 2027 5827 2c0a 2020 2020 2020 2020 2020   'X',.          
+00017290: 2020 2020 2061 7272 6179 2020 3d20 6465       array  = de
+000172a0: 6329 290a 0a20 2020 2070 686f 746f 6d65  c))..    photome
+000172b0: 7472 795f 6461 7461 2e61 7070 656e 6428  try_data.append(
+000172c0: 6669 7473 2e43 6f6c 756d 6e28 6e61 6d65  fits.Column(name
+000172d0: 2020 203d 2027 5827 2c0a 2020 2020 2020     = 'X',.      
+000172e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000172f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017300: 2066 6f72 6d61 7420 3d20 2731 4527 2c0a   format = '1E',.
+00017310: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00017320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017330: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00017340: 6d61 7420 3d20 2731 4527 2c0a 2020 2020  mat = '1E',.    
-00017350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017370: 2020 2061 7272 6179 2020 3d20 7829 290a     array  = x)).
-00017380: 0a20 2020 2070 686f 746f 6d65 7472 795f  .    photometry_
-00017390: 6461 7461 2e61 7070 656e 6428 6669 7473  data.append(fits
-000173a0: 2e43 6f6c 756d 6e28 6e61 6d65 2020 203d  .Column(name   =
-000173b0: 2027 5927 2c0a 2020 2020 2020 2020 2020   'Y',.          
+00017330: 2020 2020 2020 2061 7272 6179 2020 3d20         array  = 
+00017340: 7829 290a 0a20 2020 2070 686f 746f 6d65  x))..    photome
+00017350: 7472 795f 6461 7461 2e61 7070 656e 6428  try_data.append(
+00017360: 6669 7473 2e43 6f6c 756d 6e28 6e61 6d65  fits.Column(name
+00017370: 2020 203d 2027 5927 2c0a 2020 2020 2020     = 'Y',.      
+00017380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000173a0: 2066 6f72 6d61 7420 3d20 2731 4527 2c0a   format = '1E',.
+000173b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000173c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000173d0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000173e0: 6d61 7420 3d20 2731 4527 2c0a 2020 2020  mat = '1E',.    
-000173f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017410: 2020 2061 7272 6179 2020 3d20 7929 290a     array  = y)).
-00017420: 0a20 2020 2070 686f 746f 6d65 7472 795f  .    photometry_
-00017430: 6461 7461 2e61 7070 656e 6428 6669 7473  data.append(fits
-00017440: 2e43 6f6c 756d 6e28 6e61 6d65 2020 203d  .Column(name   =
-00017450: 2027 434c 4153 535f 5354 4152 272c 0a20   'CLASS_STAR',. 
+000173d0: 2020 2020 2020 2061 7272 6179 2020 3d20         array  = 
+000173e0: 7929 290a 0a20 2020 2070 686f 746f 6d65  y))..    photome
+000173f0: 7472 795f 6461 7461 2e61 7070 656e 6428  try_data.append(
+00017400: 6669 7473 2e43 6f6c 756d 6e28 6e61 6d65  fits.Column(name
+00017410: 2020 203d 2027 434c 4153 535f 5354 4152     = 'CLASS_STAR
+00017420: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00017430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017440: 2020 2020 2020 2020 2020 666f 726d 6174            format
+00017450: 203d 2027 3145 272c 0a20 2020 2020 2020   = '1E',.       
 00017460: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00017470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017480: 2020 2020 2020 666f 726d 6174 203d 2027        format = '
-00017490: 3145 272c 0a20 2020 2020 2020 2020 2020  1E',.           
-000174a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000174b0: 2020 2020 2020 2020 2020 2020 6172 7261              arra
-000174c0: 7920 203d 2063 6c61 7373 5f73 7461 7229  y  = class_star)
-000174d0: 290a 0a20 2020 2023 204e 6465 7465 6374  )..    # Ndetect
-000174e0: 696f 6e73 0a20 2020 206e 6465 7420 3d20  ions.    ndet = 
-000174f0: 6e70 2e7a 6572 6f73 284e 290a 0a20 2020  np.zeros(N)..   
-00017500: 2023 2041 6464 206d 6167 6e69 7475 6465   # Add magnitude
-00017510: 730a 2020 2020 666f 7220 6920 696e 2072  s.    for i in r
-00017520: 616e 6765 286c 656e 2866 696c 7465 7273  ange(len(filters
-00017530: 2929 3a0a 2020 2020 2020 2020 6669 6c74  )):.        filt
-00017540: 203d 2066 696c 7465 7273 5b69 5d0a 0a20   = filters[i].. 
-00017550: 2020 2020 2020 2023 2041 6464 2074 6f20         # Add to 
-00017560: 6e65 7720 6669 7473 2063 6174 616c 6f67  new fits catalog
-00017570: 0a20 2020 2020 2020 2069 6620 7365 786d  .        if sexm
-00017580: 6f64 6520 696e 205b 2273 696e 676c 6522  ode in ["single"
-00017590: 2c20 2264 7561 6c22 5d3a 0a20 2020 2020  , "dual"]:.     
-000175a0: 2020 2020 2020 2063 6f6c 6e61 6d65 203d         colname =
-000175b0: 2066 277b 6669 6c74 7d5f 5345 784e 756d   f'{filt}_SExNum
-000175c0: 6265 7227 0a20 2020 2020 2020 2020 2020  ber'.           
-000175d0: 2066 696c 7465 725f 4944 203d 2063 6174   filter_ID = cat
-000175e0: 5f64 6174 612e 636f 6c75 6d6e 735b 636f  _data.columns[co
-000175f0: 6c6e 616d 655d 2e61 7272 6179 0a20 2020  lname].array.   
-00017600: 2020 2020 2020 2020 2070 686f 746f 6d65           photome
-00017610: 7472 795f 6461 7461 2e61 7070 656e 6428  try_data.append(
-00017620: 6669 7473 2e43 6f6c 756d 6e28 6e61 6d65  fits.Column(name
-00017630: 3d63 6f6c 6e61 6d65 2c0a 2020 2020 2020  =colname,.      
+00017480: 6172 7261 7920 203d 2063 6c61 7373 5f73  array  = class_s
+00017490: 7461 7229 290a 0a20 2020 2023 204e 6465  tar))..    # Nde
+000174a0: 7465 6374 696f 6e73 0a20 2020 206e 6465  tections.    nde
+000174b0: 7420 3d20 6e70 2e7a 6572 6f73 284e 290a  t = np.zeros(N).
+000174c0: 0a20 2020 2023 2041 6464 206d 6167 6e69  .    # Add magni
+000174d0: 7475 6465 730a 2020 2020 666f 7220 6920  tudes.    for i 
+000174e0: 696e 2072 616e 6765 286c 656e 2866 696c  in range(len(fil
+000174f0: 7465 7273 2929 3a0a 2020 2020 2020 2020  ters)):.        
+00017500: 6669 6c74 203d 2066 696c 7465 7273 5b69  filt = filters[i
+00017510: 5d0a 0a20 2020 2020 2020 2023 2041 6464  ]..        # Add
+00017520: 2074 6f20 6e65 7720 6669 7473 2063 6174   to new fits cat
+00017530: 616c 6f67 0a20 2020 2020 2020 2069 6620  alog.        if 
+00017540: 7365 786d 6f64 6520 696e 205b 2273 696e  sexmode in ["sin
+00017550: 676c 6522 2c20 2264 7561 6c22 5d3a 0a20  gle", "dual"]:. 
+00017560: 2020 2020 2020 2020 2020 2063 6f6c 6e61             colna
+00017570: 6d65 203d 2066 277b 6669 6c74 7d5f 5345  me = f'{filt}_SE
+00017580: 784e 756d 6265 7227 0a20 2020 2020 2020  xNumber'.       
+00017590: 2020 2020 2066 696c 7465 725f 4944 203d       filter_ID =
+000175a0: 2063 6174 5f64 6174 612e 636f 6c75 6d6e   cat_data.column
+000175b0: 735b 636f 6c6e 616d 655d 2e61 7272 6179  s[colname].array
+000175c0: 0a20 2020 2020 2020 2020 2020 2070 686f  .            pho
+000175d0: 746f 6d65 7472 795f 6461 7461 2e61 7070  tometry_data.app
+000175e0: 656e 6428 6669 7473 2e43 6f6c 756d 6e28  end(fits.Column(
+000175f0: 6e61 6d65 3d63 6f6c 6e61 6d65 2c0a 2020  name=colname,.  
+00017600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017620: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00017630: 6d61 743d 2735 3041 272c 0a20 2020 2020  mat='50A',.     
 00017640: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00017650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017660: 2020 2020 2020 2020 2066 6f72 6d61 743d           format=
-00017670: 2735 3041 272c 0a20 2020 2020 2020 2020  '50A',.         
-00017680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000176a0: 2020 2020 2020 6172 7261 793d 6669 6c74        array=filt
-000176b0: 6572 5f49 4429 290a 2020 2020 2020 2020  er_ID)).        
-000176c0: 656c 6966 2073 6578 6d6f 6465 203d 3d20  elif sexmode == 
-000176d0: 2270 7366 223a 0a20 2020 2020 2020 2020  "psf":.         
-000176e0: 2020 2063 6f6c 6e61 6d65 203d 2066 277b     colname = f'{
-000176f0: 6669 6c74 7d5f 446f 5048 4f54 4e75 6d62  filt}_DoPHOTNumb
-00017700: 6572 270a 2020 2020 2020 2020 2020 2020  er'.            
-00017710: 6669 6c74 6572 5f49 4420 3d20 6361 745f  filter_ID = cat_
-00017720: 6461 7461 2e63 6f6c 756d 6e73 5b63 6f6c  data.columns[col
-00017730: 6e61 6d65 5d2e 6172 7261 790a 2020 2020  name].array.    
-00017740: 2020 2020 2020 2020 7068 6f74 6f6d 6574          photomet
-00017750: 7279 5f64 6174 612e 6170 7065 6e64 2866  ry_data.append(f
-00017760: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
-00017770: 636f 6c6e 616d 652c 0a20 2020 2020 2020  colname,.       
+00017660: 2020 2020 2020 2020 2020 6172 7261 793d            array=
+00017670: 6669 6c74 6572 5f49 4429 290a 2020 2020  filter_ID)).    
+00017680: 2020 2020 656c 6966 2073 6578 6d6f 6465      elif sexmode
+00017690: 203d 3d20 2270 7366 223a 0a20 2020 2020   == "psf":.     
+000176a0: 2020 2020 2020 2063 6f6c 6e61 6d65 203d         colname =
+000176b0: 2066 277b 6669 6c74 7d5f 446f 5048 4f54   f'{filt}_DoPHOT
+000176c0: 4e75 6d62 6572 270a 2020 2020 2020 2020  Number'.        
+000176d0: 2020 2020 6669 6c74 6572 5f49 4420 3d20      filter_ID = 
+000176e0: 6361 745f 6461 7461 2e63 6f6c 756d 6e73  cat_data.columns
+000176f0: 5b63 6f6c 6e61 6d65 5d2e 6172 7261 790a  [colname].array.
+00017700: 2020 2020 2020 2020 2020 2020 7068 6f74              phot
+00017710: 6f6d 6574 7279 5f64 6174 612e 6170 7065  ometry_data.appe
+00017720: 6e64 2866 6974 732e 436f 6c75 6d6e 286e  nd(fits.Column(n
+00017730: 616d 653d 636f 6c6e 616d 652c 0a20 2020  ame=colname,.   
+00017740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017760: 2020 2020 2020 2020 2020 2020 666f 726d              form
+00017770: 6174 3d27 3530 4127 2c0a 2020 2020 2020  at='50A',.      
 00017780: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00017790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000177a0: 2020 2020 2020 2020 666f 726d 6174 3d27          format='
-000177b0: 3530 4127 2c0a 2020 2020 2020 2020 2020  50A',.          
-000177c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000177d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000177e0: 2020 2020 2061 7272 6179 3d66 696c 7465       array=filte
-000177f0: 725f 4944 2929 0a0a 2020 2020 2020 2020  r_ID))..        
-00017800: 6d61 6720 2020 2020 3d20 6361 745f 6461  mag     = cat_da
-00017810: 7461 2e63 6f6c 756d 6e73 5b66 2753 504c  ta.columns[f'SPL
-00017820: 5553 5f7b 6669 6c74 7d27 5d2e 6172 7261  US_{filt}'].arra
-00017830: 790a 2020 2020 2020 2020 6d61 675f 6572  y.        mag_er
-00017840: 7220 3d20 6361 745f 6461 7461 2e63 6f6c  r = cat_data.col
-00017850: 756d 6e73 5b66 2753 504c 5553 5f7b 6669  umns[f'SPLUS_{fi
-00017860: 6c74 7d5f 6572 7227 5d2e 6172 7261 790a  lt}_err'].array.
-00017870: 0a20 2020 2020 2020 2023 2041 6464 2064  .        # Add d
-00017880: 6574 6563 7469 6f6e 730a 2020 2020 2020  etections.      
-00017890: 2020 6e64 6574 5b7e 6e70 2e69 736e 616e    ndet[~np.isnan
-000178a0: 286d 6167 295d 202b 3d20 310a 0a20 2020  (mag)] += 1..   
-000178b0: 2020 2020 2023 2046 696c 6c20 6e61 6e20       # Fill nan 
-000178c0: 7661 6c75 6573 0a20 2020 2020 2020 206d  values.        m
-000178d0: 6167 5b6e 702e 6973 6e61 6e28 6d61 6729  ag[np.isnan(mag)
-000178e0: 5d20 3d20 3939 0a20 2020 2020 2020 206d  ] = 99.        m
-000178f0: 6167 5f65 7272 5b6e 702e 6973 6e61 6e28  ag_err[np.isnan(
-00017900: 6d61 675f 6572 7229 5d20 3d20 3939 0a0a  mag_err)] = 99..
-00017910: 2020 2020 2020 2020 2320 4164 6420 746f          # Add to
-00017920: 206e 6577 2066 6974 7320 6361 7461 6c6f   new fits catalo
-00017930: 670a 2020 2020 2020 2020 7068 6f74 6f6d  g.        photom
-00017940: 6574 7279 5f64 6174 612e 6170 7065 6e64  etry_data.append
-00017950: 2866 6974 732e 436f 6c75 6d6e 286e 616d  (fits.Column(nam
-00017960: 653d 6627 5350 4c55 535f 7b66 696c 747d  e=f'SPLUS_{filt}
-00017970: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000177a0: 2020 2020 2020 2020 2061 7272 6179 3d66           array=f
+000177b0: 696c 7465 725f 4944 2929 0a0a 2020 2020  ilter_ID))..    
+000177c0: 2020 2020 6d61 6720 2020 2020 3d20 6361      mag     = ca
+000177d0: 745f 6461 7461 2e63 6f6c 756d 6e73 5b66  t_data.columns[f
+000177e0: 2753 504c 5553 5f7b 6669 6c74 7d27 5d2e  'SPLUS_{filt}'].
+000177f0: 6172 7261 790a 2020 2020 2020 2020 6d61  array.        ma
+00017800: 675f 6572 7220 3d20 6361 745f 6461 7461  g_err = cat_data
+00017810: 2e63 6f6c 756d 6e73 5b66 2753 504c 5553  .columns[f'SPLUS
+00017820: 5f7b 6669 6c74 7d5f 6572 7227 5d2e 6172  _{filt}_err'].ar
+00017830: 7261 790a 0a20 2020 2020 2020 2023 2041  ray..        # A
+00017840: 6464 2064 6574 6563 7469 6f6e 730a 2020  dd detections.  
+00017850: 2020 2020 2020 6e64 6574 5b7e 6e70 2e69        ndet[~np.i
+00017860: 736e 616e 286d 6167 295d 202b 3d20 310a  snan(mag)] += 1.
+00017870: 0a20 2020 2020 2020 2023 2046 696c 6c20  .        # Fill 
+00017880: 6e61 6e20 7661 6c75 6573 0a20 2020 2020  nan values.     
+00017890: 2020 206d 6167 5b6e 702e 6973 6e61 6e28     mag[np.isnan(
+000178a0: 6d61 6729 5d20 3d20 3939 0a20 2020 2020  mag)] = 99.     
+000178b0: 2020 206d 6167 5f65 7272 5b6e 702e 6973     mag_err[np.is
+000178c0: 6e61 6e28 6d61 675f 6572 7229 5d20 3d20  nan(mag_err)] = 
+000178d0: 3939 0a0a 2020 2020 2020 2020 2320 4164  99..        # Ad
+000178e0: 6420 746f 206e 6577 2066 6974 7320 6361  d to new fits ca
+000178f0: 7461 6c6f 670a 2020 2020 2020 2020 7068  talog.        ph
+00017900: 6f74 6f6d 6574 7279 5f64 6174 612e 6170  otometry_data.ap
+00017910: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
+00017920: 286e 616d 653d 6627 5350 4c55 535f 7b66  (name=f'SPLUS_{f
+00017930: 696c 747d 272c 0a20 2020 2020 2020 2020  ilt}',.         
+00017940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017960: 2020 666f 726d 6174 3d27 3145 272c 0a20    format='1E',. 
+00017970: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00017980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017990: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-000179a0: 726d 6174 3d27 3145 272c 0a20 2020 2020  rmat='1E',.     
-000179b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000179c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000179d0: 2020 2020 2020 6172 7261 793d 6d61 6729        array=mag)
-000179e0: 290a 0a20 2020 2020 2020 2070 686f 746f  )..        photo
-000179f0: 6d65 7472 795f 6461 7461 2e61 7070 656e  metry_data.appen
-00017a00: 6428 6669 7473 2e43 6f6c 756d 6e28 6e61  d(fits.Column(na
-00017a10: 6d65 3d66 2753 504c 5553 5f7b 6669 6c74  me=f'SPLUS_{filt
-00017a20: 7d5f 6572 7227 2c0a 2020 2020 2020 2020  }_err',.        
+00017990: 2020 2020 2020 2020 2020 6172 7261 793d            array=
+000179a0: 6d61 6729 290a 0a20 2020 2020 2020 2070  mag))..        p
+000179b0: 686f 746f 6d65 7472 795f 6461 7461 2e61  hotometry_data.a
+000179c0: 7070 656e 6428 6669 7473 2e43 6f6c 756d  ppend(fits.Colum
+000179d0: 6e28 6e61 6d65 3d66 2753 504c 5553 5f7b  n(name=f'SPLUS_{
+000179e0: 6669 6c74 7d5f 6572 7227 2c0a 2020 2020  filt}_err',.    
+000179f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a10: 2020 2020 2020 2066 6f72 6d61 743d 2731         format='1
+00017a20: 4527 2c0a 2020 2020 2020 2020 2020 2020  E',.            
 00017a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a50: 2020 2066 6f72 6d61 743d 2731 4527 2c0a     format='1E',.
-00017a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a80: 2020 2020 2020 2020 2020 2061 7272 6179             array
-00017a90: 3d6d 6167 5f65 7272 2929 0a0a 2020 2020  =mag_err))..    
-00017aa0: 2320 436f 756e 7420 6465 7465 6374 696f  # Count detectio
-00017ab0: 6e73 0a20 2020 2070 686f 746f 6d65 7472  ns.    photometr
-00017ac0: 795f 6461 7461 2e61 7070 656e 6428 6669  y_data.append(fi
-00017ad0: 7473 2e43 6f6c 756d 6e28 6e61 6d65 3d66  ts.Column(name=f
-00017ae0: 274e 4445 5427 2c0a 2020 2020 2020 2020  'NDET',.        
+00017a40: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00017a50: 7272 6179 3d6d 6167 5f65 7272 2929 0a0a  rray=mag_err))..
+00017a60: 2020 2020 2320 436f 756e 7420 6465 7465      # Count dete
+00017a70: 6374 696f 6e73 0a20 2020 2070 686f 746f  ctions.    photo
+00017a80: 6d65 7472 795f 6461 7461 2e61 7070 656e  metry_data.appen
+00017a90: 6428 6669 7473 2e43 6f6c 756d 6e28 6e61  d(fits.Column(na
+00017aa0: 6d65 3d66 274e 4445 5427 2c0a 2020 2020  me=f'NDET',.    
+00017ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ad0: 2020 2066 6f72 6d61 743d 2731 4927 2c0a     format='1I',.
+00017ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00017af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017b00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00017b10: 6f72 6d61 743d 2731 4927 2c0a 2020 2020  ormat='1I',.    
-00017b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017b40: 2020 2061 7272 6179 3d6e 6465 7429 290a     array=ndet)).
-00017b50: 2020 2020 2320 4765 6e65 7261 7465 2048      # Generate H
-00017b60: 4455 2066 726f 6d20 636f 6c75 6d6e 730a  DU from columns.
-00017b70: 2020 2020 6864 7520 3d20 6669 7473 2e42      hdu = fits.B
-00017b80: 696e 5461 626c 6548 4455 2e66 726f 6d5f  inTableHDU.from_
-00017b90: 636f 6c75 6d6e 7328 7068 6f74 6f6d 6574  columns(photomet
-00017ba0: 7279 5f64 6174 6129 0a0a 2020 2020 2320  ry_data)..    # 
-00017bb0: 5361 7665 206d 6173 7465 7220 4844 550a  Save master HDU.
-00017bc0: 2020 2020 6864 752e 7772 6974 6574 6f28      hdu.writeto(
-00017bd0: 7361 7665 5f66 696c 6529 0a20 2020 2070  save_file).    p
-00017be0: 7269 6e74 2827 4372 6561 7465 6420 6669  rint('Created fi
-00017bf0: 6c65 2025 7327 2025 2073 6176 655f 6669  le %s' % save_fi
-00017c00: 6c65 290a 0a0a 2323 2323 2323 2323 2323  le)...##########
-00017c10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00017c20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00017c30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00017c40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00017c50: 2323 2323 2323 0a23 2043 726f 7373 6d61  ######.# Crossma
-00017c60: 7463 680a 0a0a 6465 6620 646f 776e 6c6f  tch...def downlo
-00017c70: 6164 5f76 697a 6965 725f 6361 7461 6c6f  ad_vizier_catalo
-00017c80: 675f 666f 725f 7370 6c75 735f 6669 656c  g_for_splus_fiel
-00017c90: 6428 7669 7a69 6572 5f63 6174 616c 6f67  d(vizier_catalog
-00017ca0: 5f69 642c 2063 6f6c 756d 6e73 2c0a 2020  _id, columns,.  
-00017cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017b00: 2020 2020 2020 2061 7272 6179 3d6e 6465         array=nde
+00017b10: 7429 290a 2020 2020 2320 4765 6e65 7261  t)).    # Genera
+00017b20: 7465 2048 4455 2066 726f 6d20 636f 6c75  te HDU from colu
+00017b30: 6d6e 730a 2020 2020 6864 7520 3d20 6669  mns.    hdu = fi
+00017b40: 7473 2e42 696e 5461 626c 6548 4455 2e66  ts.BinTableHDU.f
+00017b50: 726f 6d5f 636f 6c75 6d6e 7328 7068 6f74  rom_columns(phot
+00017b60: 6f6d 6574 7279 5f64 6174 6129 0a0a 2020  ometry_data)..  
+00017b70: 2020 2320 5361 7665 206d 6173 7465 7220    # Save master 
+00017b80: 4844 550a 2020 2020 6864 752e 7772 6974  HDU.    hdu.writ
+00017b90: 6574 6f28 7361 7665 5f66 696c 6529 0a20  eto(save_file). 
+00017ba0: 2020 2070 7269 6e74 2827 4372 6561 7465     print('Create
+00017bb0: 6420 6669 6c65 2025 7327 2025 2073 6176  d file %s' % sav
+00017bc0: 655f 6669 6c65 290a 0a0a 2323 2323 2323  e_file)...######
+00017bd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00017be0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00017bf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00017c00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00017c10: 2323 2323 2323 2323 2323 0a23 2043 726f  ##########.# Cro
+00017c20: 7373 6d61 7463 680a 0a0a 6465 6620 646f  ssmatch...def do
+00017c30: 776e 6c6f 6164 5f76 697a 6965 725f 6361  wnload_vizier_ca
+00017c40: 7461 6c6f 675f 666f 725f 7370 6c75 735f  talog_for_splus_
+00017c50: 6669 656c 6428 7669 7a69 6572 5f63 6174  field(vizier_cat
+00017c60: 616c 6f67 5f69 642c 2063 6f6c 756d 6e73  alog_id, columns
+00017c70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00017c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c90: 2020 2020 2020 2020 2020 2020 2020 7370                sp
+00017ca0: 6c75 735f 696d 6167 6520 3d20 4e6f 6e65  lus_image = None
+00017cb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00017cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017cd0: 2020 2020 2020 2020 2020 7370 6c75 735f            splus_
-00017ce0: 696d 6167 6520 3d20 4e6f 6e65 2c0a 2020  image = None,.  
-00017cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017cd0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+00017ce0: 656c 6449 445f 6361 7461 6c6f 6720 3d20  eldID_catalog = 
+00017cf0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
 00017d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d10: 2020 2020 2020 2020 2020 6669 656c 6449            fieldI
-00017d20: 445f 6361 7461 6c6f 6720 3d20 4e6f 6e65  D_catalog = None
-00017d30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00017d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017d20: 2020 636f 6c75 6d6e 5f66 696c 7465 7273    column_filters
+00017d30: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
 00017d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d50: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00017d60: 6c75 6d6e 5f66 696c 7465 7273 203d 204e  lumn_filters = N
-00017d70: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
-00017d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017da0: 2070 6978 7363 616c 6520 3d20 302e 3535   pixscale = 0.55
-00017db0: 293a 0a20 2020 2022 2222 0a20 2020 2044  ):.    """.    D
-00017dc0: 6f77 6e6c 6f61 6473 2061 2063 6174 616c  ownloads a catal
-00017dd0: 6f67 2066 726f 6d20 7669 7a69 6572 2069  og from vizier i
-00017de0: 6e20 7468 6520 7265 6769 6f6e 2063 6f76  n the region cov
-00017df0: 6572 6564 2062 7920 616e 2073 706c 7573  ered by an splus
-00017e00: 5f69 6d61 6765 0a0a 2020 2020 5061 7261  _image..    Para
-00017e10: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-00017e20: 2d2d 2d2d 2d0a 2020 2020 7370 6c75 735f  -----.    splus_
-00017e30: 696d 6167 6520 3a20 7374 720a 2020 2020  image : str.    
-00017e40: 2020 2020 4c6f 6361 7469 6f6e 206f 6620      Location of 
-00017e50: 7468 6520 532d 504c 5553 2069 6d61 6765  the S-PLUS image
-00017e60: 202e 667a 2066 696c 650a 2020 2020 7669   .fz file.    vi
-00017e70: 7a69 6572 5f63 6174 616c 6f67 5f69 6420  zier_catalog_id 
-00017e80: 3a20 7374 720a 2020 2020 2020 2020 4944  : str.        ID
-00017e90: 206f 6620 7468 6520 6361 7461 6c6f 6720   of the catalog 
-00017ea0: 696e 2074 6865 2076 697a 6965 7220 6461  in the vizier da
-00017eb0: 7461 6261 7365 0a20 2020 2063 6f6c 756d  tabase.    colum
-00017ec0: 6e73 3a20 6c69 7374 0a20 2020 2020 2020  ns: list.       
-00017ed0: 204c 6973 7420 6f66 2063 6f6c 756d 6e73   List of columns
-00017ee0: 2074 6f20 646f 776e 6c6f 6164 0a20 2020   to download.   
-00017ef0: 2063 6f6c 756d 6e5f 6669 6c74 6572 733a   column_filters:
-00017f00: 2064 6963 7469 6f6e 6172 790a 2020 2020   dictionary.    
-00017f10: 2020 2020 436f 6c75 6d6e 2066 696c 7465      Column filte
-00017f20: 7273 2c20 7365 6520 6173 7472 6f71 7565  rs, see astroque
-00017f30: 7279 2e56 697a 6965 7220 646f 6375 6d65  ry.Vizier docume
-00017f40: 6e74 6174 696f 6e0a 2020 2020 7069 7873  ntation.    pixs
-00017f50: 6361 6c65 203a 2066 6c6f 6174 0a20 2020  cale : float.   
-00017f60: 2020 2020 2050 6978 656c 2073 6361 6c65       Pixel scale
-00017f70: 2069 6e20 6172 6373 6563 2f70 6978 656c   in arcsec/pixel
-00017f80: 2e20 4f6e 6c79 2075 7365 6420 6966 2069  . Only used if i
-00017f90: 6d61 6765 2068 6173 206e 6f20 5049 5853  mage has no PIXS
-00017fa0: 4341 4c45 0a20 2020 2020 2020 2070 6172  CALE.        par
-00017fb0: 616d 6574 6572 2069 6e20 7468 6520 6865  ameter in the he
-00017fc0: 6164 6572 0a0a 2020 2020 5265 7475 726e  ader..    Return
-00017fd0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-00017fe0: 2020 6173 7472 6f70 792e 7461 626c 652e    astropy.table.
-00017ff0: 7461 626c 652e 5461 626c 650a 2020 2020  table.Table.    
-00018000: 2020 2020 4361 7461 6c6f 6720 6f62 7461      Catalog obta
-00018010: 696e 6564 2066 726f 6d20 7468 6520 5649  ined from the VI
-00018020: 5a49 4552 2064 6174 6162 6173 650a 2020  ZIER database.  
-00018030: 2020 2222 220a 0a20 2020 2076 203d 2056    """..    v = V
-00018040: 697a 6965 7228 290a 0a20 2020 2023 2043  izier()..    # C
-00018050: 6861 6e67 6520 726f 7720 6c69 6d69 7420  hange row limit 
-00018060: 746f 2067 6574 2077 686f 6c65 2063 6174  to get whole cat
-00018070: 616c 6f67 0a20 2020 2076 2e52 4f57 5f4c  alog.    v.ROW_L
-00018080: 494d 4954 203d 202d 310a 0a20 2020 2023  IMIT = -1..    #
-00018090: 204c 6973 7420 6f66 2063 6f6c 756d 6e73   List of columns
-000180a0: 2074 6f20 646f 776e 6c6f 6164 0a20 2020   to download.   
-000180b0: 2076 2e63 6f6c 756d 6e73 203d 2063 6f6c   v.columns = col
-000180c0: 756d 6e73 0a0a 2020 2020 7072 696e 7428  umns..    print(
-000180d0: 2276 203d 2056 697a 6965 7228 2922 290a  "v = Vizier()").
-000180e0: 2020 2020 7072 696e 7428 2276 2e52 4f57      print("v.ROW
-000180f0: 5f4c 494d 4954 203d 202d 3122 290a 2020  _LIMIT = -1").  
-00018100: 2020 7072 696e 7428 6622 762e 636f 6c75    print(f"v.colu
-00018110: 6d6e 7320 3d20 7b63 6f6c 756d 6e73 7d22  mns = {columns}"
-00018120: 290a 2020 2020 0a20 2020 2069 6620 636f  ).    .    if co
-00018130: 6c75 6d6e 5f66 696c 7465 7273 2069 7320  lumn_filters is 
-00018140: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00018150: 2020 762e 636f 6c75 6d6e 5f66 696c 7465    v.column_filte
-00018160: 7273 203d 2063 6f6c 756d 6e5f 6669 6c74  rs = column_filt
-00018170: 6572 730a 2020 2020 2020 2020 7072 696e  ers.        prin
-00018180: 7428 6622 762e 636f 6c75 6d6e 5f66 696c  t(f"v.column_fil
-00018190: 7465 7273 203d 207b 636f 6c75 6d6e 5f66  ters = {column_f
-000181a0: 696c 7465 7273 7d22 290a 0a20 2020 2069  ilters}")..    i
-000181b0: 6620 7370 6c75 735f 696d 6167 6520 6973  f splus_image is
-000181c0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-000181d0: 2020 2023 2045 7874 7261 6374 2066 6965     # Extract fie
-000181e0: 6c64 2072 6120 616e 6420 6465 6320 6672  ld ra and dec fr
-000181f0: 6f6d 2069 6d61 6765 2068 6561 6465 720a  om image header.
-00018200: 2020 2020 2020 2020 6865 6164 203d 2066          head = f
-00018210: 6974 732e 6f70 656e 2873 706c 7573 5f69  its.open(splus_i
-00018220: 6d61 6765 295b 315d 2e68 6561 6465 720a  mage)[1].header.
-00018230: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00018240: 2020 2020 2020 2020 2072 6120 3d20 6865           ra = he
-00018250: 6164 5b27 4352 5641 4c31 275d 2020 2023  ad['CRVAL1']   #
-00018260: 2064 6567 7265 6573 0a20 2020 2020 2020   degrees.       
-00018270: 2020 2020 2064 6563 203d 2068 6561 645b       dec = head[
-00018280: 2743 5256 414c 3227 5d20 2023 2064 6567  'CRVAL2']  # deg
-00018290: 7265 6573 0a20 2020 2020 2020 2065 7863  rees.        exc
-000182a0: 6570 7420 5661 6c75 6545 7272 6f72 3a20  ept ValueError: 
-000182b0: 2320 576f 726b 7320 666f 7220 5961 7a61  # Works for Yaza
-000182c0: 6e20 696d 6167 6573 0a20 2020 2020 2020  n images.       
-000182d0: 2020 2020 2072 6120 3d20 6865 6164 5b27       ra = head['
-000182e0: 5241 275d 2020 2320 6465 6772 6565 730a  RA']  # degrees.
-000182f0: 2020 2020 2020 2020 2020 2020 6465 6320              dec 
-00018300: 3d20 6865 6164 5b27 4445 4327 5d20 2023  = head['DEC']  #
-00018310: 2064 6567 7265 6573 0a0a 2020 2020 656c   degrees..    el
-00018320: 7365 3a0a 2020 2020 2020 2020 6361 7420  se:.        cat 
-00018330: 3d20 6669 7473 2e6f 7065 6e28 6669 656c  = fits.open(fiel
-00018340: 6449 445f 6361 7461 6c6f 6729 0a20 2020  dID_catalog).   
-00018350: 2020 2020 2063 6174 203d 2063 6174 5b31       cat = cat[1
-00018360: 5d2e 6461 7461 0a0a 2020 2020 2020 2020  ].data..        
-00018370: 7261 5f61 7272 6179 2020 3d20 6361 742e  ra_array  = cat.
-00018380: 636f 6c75 6d6e 735b 2246 4945 4c44 5f49  columns["FIELD_I
-00018390: 445f 5241 225d 2e61 7272 6179 0a20 2020  D_RA"].array.   
-000183a0: 2020 2020 2064 6563 5f61 7272 6179 203d       dec_array =
-000183b0: 2063 6174 2e63 6f6c 756d 6e73 5b22 4649   cat.columns["FI
-000183c0: 454c 445f 4944 5f44 4543 225d 2e61 7272  ELD_ID_DEC"].arr
-000183d0: 6179 0a0a 2020 2020 2020 2020 2320 4573  ay..        # Es
-000183e0: 7469 6d61 7465 2063 656e 7465 7220 6f66  timate center of
-000183f0: 2074 6865 2066 6965 6c64 0a20 2020 2020   the field.     
-00018400: 2020 2072 6120 3d20 6e70 2e6d 6564 6961     ra = np.media
-00018410: 6e28 7261 5f61 7272 6179 290a 2020 2020  n(ra_array).    
-00018420: 2020 2020 6465 6320 3d20 6e70 2e6d 6564      dec = np.med
-00018430: 6961 6e28 6465 635f 6172 7261 7929 0a0a  ian(dec_array)..
-00018440: 2020 2020 6320 3d20 536b 7943 6f6f 7264      c = SkyCoord
-00018450: 2872 613d 7261 2c20 6465 633d 6465 632c  (ra=ra, dec=dec,
-00018460: 2075 6e69 743d 2875 2e64 6567 2c20 752e   unit=(u.deg, u.
-00018470: 6465 6729 290a 0a20 2020 2074 7279 3a0a  deg))..    try:.
-00018480: 2020 2020 2020 2020 7769 6474 6820 3d20          width = 
-00018490: 6865 6164 5b27 4e41 5849 5331 275d 202a  head['NAXIS1'] *
-000184a0: 2068 6561 645b 2750 4958 5343 414c 4527   head['PIXSCALE'
-000184b0: 5d20 2f20 3336 3030 2e20 2023 2064 6567  ] / 3600.  # deg
-000184c0: 7265 6573 0a20 2020 2020 2020 2068 6569  rees.        hei
-000184d0: 6768 7420 3d20 6865 6164 5b27 4e41 5849  ght = head['NAXI
-000184e0: 5332 275d 202a 2068 6561 645b 2750 4958  S2'] * head['PIX
-000184f0: 5343 414c 4527 5d20 2f20 3336 3030 2e20  SCALE'] / 3600. 
-00018500: 2023 2064 6567 7265 6573 0a0a 2020 2020   # degrees..    
-00018510: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
-00018520: 0a20 2020 2020 2020 2077 6172 6e69 6e67  .        warning
-00018530: 732e 7761 726e 2828 274e 6f20 5049 5853  s.warn(('No PIXS
-00018540: 4341 4c45 2076 616c 7565 2069 6e20 696d  CALE value in im
-00018550: 6167 6520 6865 6164 6572 2e20 5573 696e  age header. Usin
-00018560: 6720 6465 6661 756c 7420 7661 6c75 6520  g default value 
-00018570: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00018580: 2020 2020 2020 2020 6627 6f66 207b 7069          f'of {pi
-00018590: 7873 6361 6c65 7d20 666f 7220 532d 504c  xscale} for S-PL
-000185a0: 5553 2729 290a 0a20 2020 2020 2020 2077  US'))..        w
-000185b0: 6964 7468 203d 2068 6561 645b 274e 4158  idth = head['NAX
-000185c0: 4953 3127 5d20 2a20 7069 7873 6361 6c65  IS1'] * pixscale
-000185d0: 202f 2033 3630 302e 2020 2320 6465 6772   / 3600.  # degr
-000185e0: 6565 730a 2020 2020 2020 2020 6865 6967  ees.        heig
-000185f0: 6874 203d 2068 6561 645b 274e 4158 4953  ht = head['NAXIS
-00018600: 3227 5d20 2a20 7069 7873 6361 6c65 202f  2'] * pixscale /
-00018610: 2033 3630 302e 2020 2320 6465 6772 6565   3600.  # degree
-00018620: 730a 0a20 2020 2065 7863 6570 7420 556e  s..    except Un
-00018630: 626f 756e 644c 6f63 616c 4572 726f 723a  boundLocalError:
-00018640: 0a20 2020 2020 2020 2077 6964 7468 203d  .        width =
-00018650: 2031 3130 3030 202a 2070 6978 7363 616c   11000 * pixscal
-00018660: 6520 2f20 3336 3030 2e20 2320 6465 6772  e / 3600. # degr
-00018670: 6565 730a 2020 2020 2020 2020 6865 6967  ees.        heig
-00018680: 6874 203d 2031 3130 3030 202a 2070 6978  ht = 11000 * pix
-00018690: 7363 616c 6520 2f20 3336 3030 2e20 2320  scale / 3600. # 
-000186a0: 6465 6772 6565 730a 0a20 2020 2023 2052  degrees..    # R
-000186b0: 6574 7269 6576 6520 6361 7461 6c6f 6720  etrieve catalog 
-000186c0: 6461 7461 2069 6e20 7468 6520 6669 656c  data in the fiel
-000186d0: 640a 2020 2020 7072 696e 7428 6622 7365  d.    print(f"se
-000186e0: 6e64 696e 6720 7175 6572 7920 746f 207b  nding query to {
-000186f0: 7669 7a69 6572 5f63 6174 616c 6f67 5f69  vizier_catalog_i
-00018700: 647d 2229 0a20 2020 2070 7269 6e74 2829  d}").    print()
-00018710: 0a20 2020 2070 7269 6e74 2866 2271 7565  .    print(f"que
-00018720: 7279 203d 2076 2e71 7565 7279 5f72 6567  ry = v.query_reg
-00018730: 696f 6e28 7b63 7d2c 2229 0a20 2020 2070  ion({c},").    p
-00018740: 7269 6e74 2866 2277 6964 7468 203d 207b  rint(f"width = {
-00018750: 7769 6474 687d 2a75 2e64 6567 2c22 290a  width}*u.deg,").
-00018760: 2020 2020 7072 696e 7428 6622 6865 6967      print(f"heig
-00018770: 6874 203d 207b 6865 6967 6874 7d2a 752e  ht = {height}*u.
-00018780: 6465 672c 2229 0a20 2020 2070 7269 6e74  deg,").    print
-00018790: 2866 2263 6174 616c 6f67 203d 207b 7669  (f"catalog = {vi
-000187a0: 7a69 6572 5f63 6174 616c 6f67 5f69 647d  zier_catalog_id}
-000187b0: 2922 290a 2020 2020 7072 696e 7428 290a  )").    print().
-000187c0: 0a20 2020 2071 7565 7279 203d 2076 2e71  .    query = v.q
-000187d0: 7565 7279 5f72 6567 696f 6e28 632c 2077  uery_region(c, w
-000187e0: 6964 7468 203d 2077 6964 7468 2a75 2e64  idth = width*u.d
-000187f0: 6567 2c20 6865 6967 6874 203d 2068 6569  eg, height = hei
-00018800: 6768 742a 752e 6465 672c 0a20 2020 2020  ght*u.deg,.     
-00018810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018820: 2020 2020 2020 6361 7461 6c6f 6720 3d20        catalog = 
-00018830: 7669 7a69 6572 5f63 6174 616c 6f67 5f69  vizier_catalog_i
-00018840: 642c 2063 6163 6865 203d 2046 616c 7365  d, cache = False
-00018850: 290a 2020 2020 0a20 2020 2070 7269 6e74  ).    .    print
-00018860: 2866 2263 6174 616c 6f67 203d 2071 7565  (f"catalog = que
-00018870: 7279 5b7b 7669 7a69 6572 5f63 6174 616c  ry[{vizier_catal
-00018880: 6f67 5f69 647d 5d22 290a 2020 2020 6361  og_id}]").    ca
-00018890: 7461 6c6f 6720 3d20 7175 6572 795b 7669  talog = query[vi
-000188a0: 7a69 6572 5f63 6174 616c 6f67 5f69 645d  zier_catalog_id]
-000188b0: 0a0a 2020 2020 7265 7475 726e 2063 6174  ..    return cat
-000188c0: 616c 6f67 0a0a 0a64 6566 2064 6f77 6e6c  alog...def downl
-000188d0: 6f61 645f 6761 6c65 7828 7361 7665 5f66  oad_galex(save_f
-000188e0: 696c 652c 2069 6d61 6765 203d 204e 6f6e  ile, image = Non
-000188f0: 652c 2066 6965 6c64 4944 5f63 6174 616c  e, fieldID_catal
-00018900: 6f67 203d 204e 6f6e 6529 3a0a 2020 2020  og = None):.    
-00018910: 2222 220a 2020 2020 446f 776e 6c6f 6164  """.    Download
-00018920: 7320 7468 6520 4741 4c45 5820 4452 362f  s the GALEX DR6/
-00018930: 3720 6361 7461 6c6f 6720 6672 6f6d 2074  7 catalog from t
-00018940: 6865 2076 697a 6965 7220 6461 7461 6261  he vizier databa
-00018950: 7365 2069 6e20 7468 6520 7265 6769 6f6e  se in the region
-00018960: 0a20 2020 2063 6f76 6572 6564 2062 7920  .    covered by 
-00018970: 616e 2073 706c 7573 2069 6d61 6765 2e20  an splus image. 
-00018980: 4368 616e 6765 7320 636f 6c75 6d6e 206e  Changes column n
-00018990: 616d 6573 2066 6f72 2074 6865 2066 6f72  ames for the for
-000189a0: 6d61 7420 7573 6564 2062 7920 7468 650a  mat used by the.
-000189b0: 2020 2020 7069 7065 6c69 6e65 2c20 6465      pipeline, de
-000189c0: 6c65 7465 7320 756e 6e65 6365 7373 6172  letes unnecessar
-000189d0: 7920 636f 6c75 6d6e 7320 616e 6420 7361  y columns and sa
-000189e0: 7665 7320 7265 7375 6c74 7320 746f 2061  ves results to a
-000189f0: 2066 6974 7320 6669 6c65 0a0a 2020 2020   fits file..    
-00018a00: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-00018a10: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 696d  ---------.    im
-00018a20: 6167 6520 3a20 7374 720a 2020 2020 2020  age : str.      
-00018a30: 2020 4c6f 6361 7469 6f6e 206f 6620 7468    Location of th
-00018a40: 6520 7370 6c75 7320 696d 6167 6520 286d  e splus image (m
-00018a50: 7573 7420 6265 202e 667a 290a 2020 2020  ust be .fz).    
-00018a60: 7361 7665 5f66 696c 6520 3a20 7374 720a  save_file : str.
-00018a70: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
-00018a80: 2074 6f20 7361 7665 2074 6865 2072 6574   to save the ret
-00018a90: 7269 6576 6564 2063 6174 616c 6f67 2028  rieved catalog (
-00018aa0: 6d75 7374 2062 6520 2e66 6974 7329 0a0a  must be .fits)..
-00018ab0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-00018ac0: 2d2d 2d2d 2d2d 2d0a 2020 2020 5361 7665  -------.    Save
-00018ad0: 7320 6361 7461 6c6f 6720 696e 2074 6865  s catalog in the
-00018ae0: 2064 6573 6972 6564 206c 6f63 6174 696f   desired locatio
-00018af0: 6e0a 2020 2020 2222 220a 0a20 2020 2023  n.    """..    #
-00018b00: 2056 697a 6965 7220 5461 626c 650a 2020   Vizier Table.  
-00018b10: 2020 6361 745f 6964 203d 2022 4949 2f33    cat_id = "II/3
-00018b20: 3335 2f67 616c 6578 5f61 6973 220a 0a20  35/galex_ais".. 
-00018b30: 2020 2063 6f6c 756d 6e73 203d 205b 274e     columns = ['N
-00018b40: 616d 6527 2c20 2752 414a 3230 3030 272c  ame', 'RAJ2000',
-00018b50: 2027 4445 4a32 3030 3027 2c20 2746 5556   'DEJ2000', 'FUV
-00018b60: 6d61 6727 2c20 2765 5f46 5556 6d61 6727  mag', 'e_FUVmag'
-00018b70: 2c20 274e 5556 6d61 6727 2c0a 2020 2020  , 'NUVmag',.    
-00018b80: 2020 2020 2020 2020 2020 2027 655f 4e55             'e_NU
-00018b90: 566d 6167 275d 0a0a 2020 2020 2320 446f  Vmag']..    # Do
-00018ba0: 776e 6c6f 6164 2063 6174 616c 6f67 0a20  wnload catalog. 
-00018bb0: 2020 2063 6174 616c 6f67 203d 2064 6f77     catalog = dow
-00018bc0: 6e6c 6f61 645f 7669 7a69 6572 5f63 6174  nload_vizier_cat
-00018bd0: 616c 6f67 5f66 6f72 5f73 706c 7573 5f66  alog_for_splus_f
-00018be0: 6965 6c64 2873 706c 7573 5f69 6d61 6765  ield(splus_image
-00018bf0: 203d 2069 6d61 6765 2c0a 2020 2020 2020   = image,.      
-00018c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017d60: 2020 2020 2070 6978 7363 616c 6520 3d20       pixscale = 
+00017d70: 302e 3535 293a 0a20 2020 2022 2222 0a20  0.55):.    """. 
+00017d80: 2020 2044 6f77 6e6c 6f61 6473 2061 2063     Downloads a c
+00017d90: 6174 616c 6f67 2066 726f 6d20 7669 7a69  atalog from vizi
+00017da0: 6572 2069 6e20 7468 6520 7265 6769 6f6e  er in the region
+00017db0: 2063 6f76 6572 6564 2062 7920 616e 2073   covered by an s
+00017dc0: 706c 7573 5f69 6d61 6765 0a0a 2020 2020  plus_image..    
+00017dd0: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+00017de0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 7370  ---------.    sp
+00017df0: 6c75 735f 696d 6167 6520 3a20 7374 720a  lus_image : str.
+00017e00: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
+00017e10: 206f 6620 7468 6520 532d 504c 5553 2069   of the S-PLUS i
+00017e20: 6d61 6765 202e 667a 2066 696c 650a 2020  mage .fz file.  
+00017e30: 2020 7669 7a69 6572 5f63 6174 616c 6f67    vizier_catalog
+00017e40: 5f69 6420 3a20 7374 720a 2020 2020 2020  _id : str.      
+00017e50: 2020 4944 206f 6620 7468 6520 6361 7461    ID of the cata
+00017e60: 6c6f 6720 696e 2074 6865 2076 697a 6965  log in the vizie
+00017e70: 7220 6461 7461 6261 7365 0a20 2020 2063  r database.    c
+00017e80: 6f6c 756d 6e73 3a20 6c69 7374 0a20 2020  olumns: list.   
+00017e90: 2020 2020 204c 6973 7420 6f66 2063 6f6c       List of col
+00017ea0: 756d 6e73 2074 6f20 646f 776e 6c6f 6164  umns to download
+00017eb0: 0a20 2020 2063 6f6c 756d 6e5f 6669 6c74  .    column_filt
+00017ec0: 6572 733a 2064 6963 7469 6f6e 6172 790a  ers: dictionary.
+00017ed0: 2020 2020 2020 2020 436f 6c75 6d6e 2066          Column f
+00017ee0: 696c 7465 7273 2c20 7365 6520 6173 7472  ilters, see astr
+00017ef0: 6f71 7565 7279 2e56 697a 6965 7220 646f  oquery.Vizier do
+00017f00: 6375 6d65 6e74 6174 696f 6e0a 2020 2020  cumentation.    
+00017f10: 7069 7873 6361 6c65 203a 2066 6c6f 6174  pixscale : float
+00017f20: 0a20 2020 2020 2020 2050 6978 656c 2073  .        Pixel s
+00017f30: 6361 6c65 2069 6e20 6172 6373 6563 2f70  cale in arcsec/p
+00017f40: 6978 656c 2e20 4f6e 6c79 2075 7365 6420  ixel. Only used 
+00017f50: 6966 2069 6d61 6765 2068 6173 206e 6f20  if image has no 
+00017f60: 5049 5853 4341 4c45 0a20 2020 2020 2020  PIXSCALE.       
+00017f70: 2070 6172 616d 6574 6572 2069 6e20 7468   parameter in th
+00017f80: 6520 6865 6164 6572 0a0a 2020 2020 5265  e header..    Re
+00017f90: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+00017fa0: 2d0a 2020 2020 6173 7472 6f70 792e 7461  -.    astropy.ta
+00017fb0: 626c 652e 7461 626c 652e 5461 626c 650a  ble.table.Table.
+00017fc0: 2020 2020 2020 2020 4361 7461 6c6f 6720          Catalog 
+00017fd0: 6f62 7461 696e 6564 2066 726f 6d20 7468  obtained from th
+00017fe0: 6520 5649 5a49 4552 2064 6174 6162 6173  e VIZIER databas
+00017ff0: 650a 2020 2020 2222 220a 0a20 2020 2076  e.    """..    v
+00018000: 203d 2056 697a 6965 7228 290a 0a20 2020   = Vizier()..   
+00018010: 2023 2043 6861 6e67 6520 726f 7720 6c69   # Change row li
+00018020: 6d69 7420 746f 2067 6574 2077 686f 6c65  mit to get whole
+00018030: 2063 6174 616c 6f67 0a20 2020 2076 2e52   catalog.    v.R
+00018040: 4f57 5f4c 494d 4954 203d 202d 310a 0a20  OW_LIMIT = -1.. 
+00018050: 2020 2023 204c 6973 7420 6f66 2063 6f6c     # List of col
+00018060: 756d 6e73 2074 6f20 646f 776e 6c6f 6164  umns to download
+00018070: 0a20 2020 2076 2e63 6f6c 756d 6e73 203d  .    v.columns =
+00018080: 2063 6f6c 756d 6e73 0a0a 2020 2020 7072   columns..    pr
+00018090: 696e 7428 2276 203d 2056 697a 6965 7228  int("v = Vizier(
+000180a0: 2922 290a 2020 2020 7072 696e 7428 2276  )").    print("v
+000180b0: 2e52 4f57 5f4c 494d 4954 203d 202d 3122  .ROW_LIMIT = -1"
+000180c0: 290a 2020 2020 7072 696e 7428 6622 762e  ).    print(f"v.
+000180d0: 636f 6c75 6d6e 7320 3d20 7b63 6f6c 756d  columns = {colum
+000180e0: 6e73 7d22 290a 2020 2020 0a20 2020 2069  ns}").    .    i
+000180f0: 6620 636f 6c75 6d6e 5f66 696c 7465 7273  f column_filters
+00018100: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00018110: 2020 2020 2020 762e 636f 6c75 6d6e 5f66        v.column_f
+00018120: 696c 7465 7273 203d 2063 6f6c 756d 6e5f  ilters = column_
+00018130: 6669 6c74 6572 730a 2020 2020 2020 2020  filters.        
+00018140: 7072 696e 7428 6622 762e 636f 6c75 6d6e  print(f"v.column
+00018150: 5f66 696c 7465 7273 203d 207b 636f 6c75  _filters = {colu
+00018160: 6d6e 5f66 696c 7465 7273 7d22 290a 0a20  mn_filters}").. 
+00018170: 2020 2069 6620 7370 6c75 735f 696d 6167     if splus_imag
+00018180: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
+00018190: 2020 2020 2020 2023 2045 7874 7261 6374         # Extract
+000181a0: 2066 6965 6c64 2072 6120 616e 6420 6465   field ra and de
+000181b0: 6320 6672 6f6d 2069 6d61 6765 2068 6561  c from image hea
+000181c0: 6465 720a 2020 2020 2020 2020 6865 6164  der.        head
+000181d0: 203d 2066 6974 732e 6f70 656e 2873 706c   = fits.open(spl
+000181e0: 7573 5f69 6d61 6765 295b 315d 2e68 6561  us_image)[1].hea
+000181f0: 6465 720a 2020 2020 2020 2020 7472 793a  der.        try:
+00018200: 0a20 2020 2020 2020 2020 2020 2072 6120  .            ra 
+00018210: 3d20 6865 6164 5b27 4352 5641 4c31 275d  = head['CRVAL1']
+00018220: 2020 2023 2064 6567 7265 6573 0a20 2020     # degrees.   
+00018230: 2020 2020 2020 2020 2064 6563 203d 2068           dec = h
+00018240: 6561 645b 2743 5256 414c 3227 5d20 2023  ead['CRVAL2']  #
+00018250: 2064 6567 7265 6573 0a20 2020 2020 2020   degrees.       
+00018260: 2065 7863 6570 7420 5661 6c75 6545 7272   except ValueErr
+00018270: 6f72 3a20 2320 576f 726b 7320 666f 7220  or: # Works for 
+00018280: 5961 7a61 6e20 696d 6167 6573 0a20 2020  Yazan images.   
+00018290: 2020 2020 2020 2020 2072 6120 3d20 6865           ra = he
+000182a0: 6164 5b27 5241 275d 2020 2320 6465 6772  ad['RA']  # degr
+000182b0: 6565 730a 2020 2020 2020 2020 2020 2020  ees.            
+000182c0: 6465 6320 3d20 6865 6164 5b27 4445 4327  dec = head['DEC'
+000182d0: 5d20 2023 2064 6567 7265 6573 0a0a 2020  ]  # degrees..  
+000182e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000182f0: 6361 7420 3d20 6669 7473 2e6f 7065 6e28  cat = fits.open(
+00018300: 6669 656c 6449 445f 6361 7461 6c6f 6729  fieldID_catalog)
+00018310: 0a20 2020 2020 2020 2063 6174 203d 2063  .        cat = c
+00018320: 6174 5b31 5d2e 6461 7461 0a0a 2020 2020  at[1].data..    
+00018330: 2020 2020 7261 5f61 7272 6179 2020 3d20      ra_array  = 
+00018340: 6361 742e 636f 6c75 6d6e 735b 2246 4945  cat.columns["FIE
+00018350: 4c44 5f49 445f 5241 225d 2e61 7272 6179  LD_ID_RA"].array
+00018360: 0a20 2020 2020 2020 2064 6563 5f61 7272  .        dec_arr
+00018370: 6179 203d 2063 6174 2e63 6f6c 756d 6e73  ay = cat.columns
+00018380: 5b22 4649 454c 445f 4944 5f44 4543 225d  ["FIELD_ID_DEC"]
+00018390: 2e61 7272 6179 0a0a 2020 2020 2020 2020  .array..        
+000183a0: 2320 4573 7469 6d61 7465 2063 656e 7465  # Estimate cente
+000183b0: 7220 6f66 2074 6865 2066 6965 6c64 0a20  r of the field. 
+000183c0: 2020 2020 2020 2072 6120 3d20 6e70 2e6d         ra = np.m
+000183d0: 6564 6961 6e28 7261 5f61 7272 6179 290a  edian(ra_array).
+000183e0: 2020 2020 2020 2020 6465 6320 3d20 6e70          dec = np
+000183f0: 2e6d 6564 6961 6e28 6465 635f 6172 7261  .median(dec_arra
+00018400: 7929 0a0a 2020 2020 6320 3d20 536b 7943  y)..    c = SkyC
+00018410: 6f6f 7264 2872 613d 7261 2c20 6465 633d  oord(ra=ra, dec=
+00018420: 6465 632c 2075 6e69 743d 2875 2e64 6567  dec, unit=(u.deg
+00018430: 2c20 752e 6465 6729 290a 0a20 2020 2074  , u.deg))..    t
+00018440: 7279 3a0a 2020 2020 2020 2020 7769 6474  ry:.        widt
+00018450: 6820 3d20 6865 6164 5b27 4e41 5849 5331  h = head['NAXIS1
+00018460: 275d 202a 2068 6561 645b 2750 4958 5343  '] * head['PIXSC
+00018470: 414c 4527 5d20 2f20 3336 3030 2e20 2023  ALE'] / 3600.  #
+00018480: 2064 6567 7265 6573 0a20 2020 2020 2020   degrees.       
+00018490: 2068 6569 6768 7420 3d20 6865 6164 5b27   height = head['
+000184a0: 4e41 5849 5332 275d 202a 2068 6561 645b  NAXIS2'] * head[
+000184b0: 2750 4958 5343 414c 4527 5d20 2f20 3336  'PIXSCALE'] / 36
+000184c0: 3030 2e20 2023 2064 6567 7265 6573 0a0a  00.  # degrees..
+000184d0: 2020 2020 6578 6365 7074 204b 6579 4572      except KeyEr
+000184e0: 726f 723a 0a20 2020 2020 2020 2077 6172  ror:.        war
+000184f0: 6e69 6e67 732e 7761 726e 2828 274e 6f20  nings.warn(('No 
+00018500: 5049 5853 4341 4c45 2076 616c 7565 2069  PIXSCALE value i
+00018510: 6e20 696d 6167 6520 6865 6164 6572 2e20  n image header. 
+00018520: 5573 696e 6720 6465 6661 756c 7420 7661  Using default va
+00018530: 6c75 6520 270a 2020 2020 2020 2020 2020  lue '.          
+00018540: 2020 2020 2020 2020 2020 2020 6627 6f66              f'of
+00018550: 207b 7069 7873 6361 6c65 7d20 666f 7220   {pixscale} for 
+00018560: 532d 504c 5553 2729 290a 0a20 2020 2020  S-PLUS'))..     
+00018570: 2020 2077 6964 7468 203d 2068 6561 645b     width = head[
+00018580: 274e 4158 4953 3127 5d20 2a20 7069 7873  'NAXIS1'] * pixs
+00018590: 6361 6c65 202f 2033 3630 302e 2020 2320  cale / 3600.  # 
+000185a0: 6465 6772 6565 730a 2020 2020 2020 2020  degrees.        
+000185b0: 6865 6967 6874 203d 2068 6561 645b 274e  height = head['N
+000185c0: 4158 4953 3227 5d20 2a20 7069 7873 6361  AXIS2'] * pixsca
+000185d0: 6c65 202f 2033 3630 302e 2020 2320 6465  le / 3600.  # de
+000185e0: 6772 6565 730a 0a20 2020 2065 7863 6570  grees..    excep
+000185f0: 7420 556e 626f 756e 644c 6f63 616c 4572  t UnboundLocalEr
+00018600: 726f 723a 0a20 2020 2020 2020 2077 6964  ror:.        wid
+00018610: 7468 203d 2031 3130 3030 202a 2070 6978  th = 11000 * pix
+00018620: 7363 616c 6520 2f20 3336 3030 2e20 2320  scale / 3600. # 
+00018630: 6465 6772 6565 730a 2020 2020 2020 2020  degrees.        
+00018640: 6865 6967 6874 203d 2031 3130 3030 202a  height = 11000 *
+00018650: 2070 6978 7363 616c 6520 2f20 3336 3030   pixscale / 3600
+00018660: 2e20 2320 6465 6772 6565 730a 0a20 2020  . # degrees..   
+00018670: 2023 2052 6574 7269 6576 6520 6361 7461   # Retrieve cata
+00018680: 6c6f 6720 6461 7461 2069 6e20 7468 6520  log data in the 
+00018690: 6669 656c 640a 2020 2020 7072 696e 7428  field.    print(
+000186a0: 6622 7365 6e64 696e 6720 7175 6572 7920  f"sending query 
+000186b0: 746f 207b 7669 7a69 6572 5f63 6174 616c  to {vizier_catal
+000186c0: 6f67 5f69 647d 2229 0a20 2020 2070 7269  og_id}").    pri
+000186d0: 6e74 2829 0a20 2020 2070 7269 6e74 2866  nt().    print(f
+000186e0: 2271 7565 7279 203d 2076 2e71 7565 7279  "query = v.query
+000186f0: 5f72 6567 696f 6e28 7b63 7d2c 2229 0a20  _region({c},"). 
+00018700: 2020 2070 7269 6e74 2866 2277 6964 7468     print(f"width
+00018710: 203d 207b 7769 6474 687d 2a75 2e64 6567   = {width}*u.deg
+00018720: 2c22 290a 2020 2020 7072 696e 7428 6622  ,").    print(f"
+00018730: 6865 6967 6874 203d 207b 6865 6967 6874  height = {height
+00018740: 7d2a 752e 6465 672c 2229 0a20 2020 2070  }*u.deg,").    p
+00018750: 7269 6e74 2866 2263 6174 616c 6f67 203d  rint(f"catalog =
+00018760: 207b 7669 7a69 6572 5f63 6174 616c 6f67   {vizier_catalog
+00018770: 5f69 647d 2922 290a 2020 2020 7072 696e  _id})").    prin
+00018780: 7428 290a 0a20 2020 2071 7565 7279 203d  t()..    query =
+00018790: 2076 2e71 7565 7279 5f72 6567 696f 6e28   v.query_region(
+000187a0: 632c 2077 6964 7468 203d 2077 6964 7468  c, width = width
+000187b0: 2a75 2e64 6567 2c20 6865 6967 6874 203d  *u.deg, height =
+000187c0: 2068 6569 6768 742a 752e 6465 672c 0a20   height*u.deg,. 
+000187d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187e0: 2020 2020 2020 2020 2020 6361 7461 6c6f            catalo
+000187f0: 6720 3d20 7669 7a69 6572 5f63 6174 616c  g = vizier_catal
+00018800: 6f67 5f69 642c 2063 6163 6865 203d 2046  og_id, cache = F
+00018810: 616c 7365 290a 2020 2020 0a20 2020 2070  alse).    .    p
+00018820: 7269 6e74 2866 2263 6174 616c 6f67 203d  rint(f"catalog =
+00018830: 2071 7565 7279 5b7b 7669 7a69 6572 5f63   query[{vizier_c
+00018840: 6174 616c 6f67 5f69 647d 5d22 290a 2020  atalog_id}]").  
+00018850: 2020 6361 7461 6c6f 6720 3d20 7175 6572    catalog = quer
+00018860: 795b 7669 7a69 6572 5f63 6174 616c 6f67  y[vizier_catalog
+00018870: 5f69 645d 0a0a 2020 2020 7265 7475 726e  _id]..    return
+00018880: 2063 6174 616c 6f67 0a0a 0a64 6566 2064   catalog...def d
+00018890: 6f77 6e6c 6f61 645f 6761 6c65 7828 7361  ownload_galex(sa
+000188a0: 7665 5f66 696c 652c 2069 6d61 6765 203d  ve_file, image =
+000188b0: 204e 6f6e 652c 2066 6965 6c64 4944 5f63   None, fieldID_c
+000188c0: 6174 616c 6f67 203d 204e 6f6e 6529 3a0a  atalog = None):.
+000188d0: 2020 2020 2222 220a 2020 2020 446f 776e      """.    Down
+000188e0: 6c6f 6164 7320 7468 6520 4741 4c45 5820  loads the GALEX 
+000188f0: 4452 362f 3720 6361 7461 6c6f 6720 6672  DR6/7 catalog fr
+00018900: 6f6d 2074 6865 2076 697a 6965 7220 6461  om the vizier da
+00018910: 7461 6261 7365 2069 6e20 7468 6520 7265  tabase in the re
+00018920: 6769 6f6e 0a20 2020 2063 6f76 6572 6564  gion.    covered
+00018930: 2062 7920 616e 2073 706c 7573 2069 6d61   by an splus ima
+00018940: 6765 2e20 4368 616e 6765 7320 636f 6c75  ge. Changes colu
+00018950: 6d6e 206e 616d 6573 2066 6f72 2074 6865  mn names for the
+00018960: 2066 6f72 6d61 7420 7573 6564 2062 7920   format used by 
+00018970: 7468 650a 2020 2020 7069 7065 6c69 6e65  the.    pipeline
+00018980: 2c20 6465 6c65 7465 7320 756e 6e65 6365  , deletes unnece
+00018990: 7373 6172 7920 636f 6c75 6d6e 7320 616e  ssary columns an
+000189a0: 6420 7361 7665 7320 7265 7375 6c74 7320  d saves results 
+000189b0: 746f 2061 2066 6974 7320 6669 6c65 0a0a  to a fits file..
+000189c0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+000189d0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+000189e0: 2020 696d 6167 6520 3a20 7374 720a 2020    image : str.  
+000189f0: 2020 2020 2020 4c6f 6361 7469 6f6e 206f        Location o
+00018a00: 6620 7468 6520 7370 6c75 7320 696d 6167  f the splus imag
+00018a10: 6520 286d 7573 7420 6265 202e 667a 290a  e (must be .fz).
+00018a20: 2020 2020 7361 7665 5f66 696c 6520 3a20      save_file : 
+00018a30: 7374 720a 2020 2020 2020 2020 4c6f 6361  str.        Loca
+00018a40: 7469 6f6e 2074 6f20 7361 7665 2074 6865  tion to save the
+00018a50: 2072 6574 7269 6576 6564 2063 6174 616c   retrieved catal
+00018a60: 6f67 2028 6d75 7374 2062 6520 2e66 6974  og (must be .fit
+00018a70: 7329 0a0a 2020 2020 5265 7475 726e 730a  s)..    Returns.
+00018a80: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+00018a90: 5361 7665 7320 6361 7461 6c6f 6720 696e  Saves catalog in
+00018aa0: 2074 6865 2064 6573 6972 6564 206c 6f63   the desired loc
+00018ab0: 6174 696f 6e0a 2020 2020 2222 220a 0a20  ation.    """.. 
+00018ac0: 2020 2023 2056 697a 6965 7220 5461 626c     # Vizier Tabl
+00018ad0: 650a 2020 2020 6361 745f 6964 203d 2022  e.    cat_id = "
+00018ae0: 4949 2f33 3335 2f67 616c 6578 5f61 6973  II/335/galex_ais
+00018af0: 220a 0a20 2020 2063 6f6c 756d 6e73 203d  "..    columns =
+00018b00: 205b 274e 616d 6527 2c20 2752 414a 3230   ['Name', 'RAJ20
+00018b10: 3030 272c 2027 4445 4a32 3030 3027 2c20  00', 'DEJ2000', 
+00018b20: 2746 5556 6d61 6727 2c20 2765 5f46 5556  'FUVmag', 'e_FUV
+00018b30: 6d61 6727 2c20 274e 5556 6d61 6727 2c0a  mag', 'NUVmag',.
+00018b40: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00018b50: 655f 4e55 566d 6167 275d 0a0a 2020 2020  e_NUVmag']..    
+00018b60: 2320 446f 776e 6c6f 6164 2063 6174 616c  # Download catal
+00018b70: 6f67 0a20 2020 2063 6174 616c 6f67 203d  og.    catalog =
+00018b80: 2064 6f77 6e6c 6f61 645f 7669 7a69 6572   download_vizier
+00018b90: 5f63 6174 616c 6f67 5f66 6f72 5f73 706c  _catalog_for_spl
+00018ba0: 7573 5f66 6965 6c64 2873 706c 7573 5f69  us_field(splus_i
+00018bb0: 6d61 6765 203d 2069 6d61 6765 2c0a 2020  mage = image,.  
+00018bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018be0: 2020 2020 2020 2020 2020 2020 2066 6965               fie
+00018bf0: 6c64 4944 5f63 6174 616c 6f67 3d66 6965  ldID_catalog=fie
+00018c00: 6c64 4944 5f63 6174 616c 6f67 2c0a 2020  ldID_catalog,.  
 00018c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018c20: 2020 2020 2020 2020 2066 6965 6c64 4944           fieldID
-00018c30: 5f63 6174 616c 6f67 3d66 6965 6c64 4944  _catalog=fieldID
-00018c40: 5f63 6174 616c 6f67 2c0a 2020 2020 2020  _catalog,.      
-00018c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c30: 2020 2020 2020 2020 2020 2020 2076 697a               viz
+00018c40: 6965 725f 6361 7461 6c6f 675f 6964 203d  ier_catalog_id =
+00018c50: 2063 6174 5f69 642c 0a20 2020 2020 2020   cat_id,.       
 00018c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018c70: 2020 2020 2020 2020 2076 697a 6965 725f           vizier_
-00018c80: 6361 7461 6c6f 675f 6964 203d 2063 6174  catalog_id = cat
-00018c90: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-00018ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018cc0: 2020 2020 636f 6c75 6d6e 7320 3d20 636f      columns = co
-00018cd0: 6c75 6d6e 7329 0a0a 2020 2020 2320 5265  lumns)..    # Re
-00018ce0: 6e61 6d65 2063 6f6c 756d 6e73 0a20 2020  name columns.   
-00018cf0: 2063 6174 616c 6f67 2e63 6f6c 756d 6e73   catalog.columns
-00018d00: 5b27 4e61 6d65 275d 2e6e 616d 6520 3d20  ['Name'].name = 
-00018d10: 2747 414c 4558 5f49 4427 0a20 2020 2063  'GALEX_ID'.    c
-00018d20: 6174 616c 6f67 2e63 6f6c 756d 6e73 5b27  atalog.columns['
-00018d30: 5241 4a32 3030 3027 5d2e 6e61 6d65 203d  RAJ2000'].name =
-00018d40: 2027 4741 4c45 585f 5241 4a32 3030 3027   'GALEX_RAJ2000'
-00018d50: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
-00018d60: 756d 6e73 5b27 4445 4a32 3030 3027 5d2e  umns['DEJ2000'].
-00018d70: 6e61 6d65 203d 2027 4741 4c45 585f 4445  name = 'GALEX_DE
-00018d80: 4a32 3030 3027 0a20 2020 2063 6174 616c  J2000'.    catal
-00018d90: 6f67 2e63 6f6c 756d 6e73 5b27 4655 566d  og.columns['FUVm
-00018da0: 6167 275d 2e6e 616d 6520 3d20 2747 414c  ag'].name = 'GAL
-00018db0: 4558 5f46 5556 270a 2020 2020 6361 7461  EX_FUV'.    cata
-00018dc0: 6c6f 672e 636f 6c75 6d6e 735b 2765 5f46  log.columns['e_F
-00018dd0: 5556 6d61 6727 5d2e 6e61 6d65 203d 2027  UVmag'].name = '
-00018de0: 4741 4c45 585f 4655 565f 6572 7227 0a20  GALEX_FUV_err'. 
-00018df0: 2020 2063 6174 616c 6f67 2e63 6f6c 756d     catalog.colum
-00018e00: 6e73 5b27 4e55 566d 6167 275d 2e6e 616d  ns['NUVmag'].nam
-00018e10: 6520 3d20 2747 414c 4558 5f4e 5556 270a  e = 'GALEX_NUV'.
-00018e20: 2020 2020 6361 7461 6c6f 672e 636f 6c75      catalog.colu
-00018e30: 6d6e 735b 2765 5f4e 5556 6d61 6727 5d2e  mns['e_NUVmag'].
-00018e40: 6e61 6d65 203d 2027 4741 4c45 585f 4e55  name = 'GALEX_NU
-00018e50: 565f 6572 7227 0a0a 2020 2020 2320 5472  V_err'..    # Tr
-00018e60: 756e 6361 7465 2064 6573 6372 6970 7469  uncate descripti
-00018e70: 6f6e 2028 7573 7561 6c6c 7920 746f 2062  on (usually to b
-00018e80: 6967 2074 6f20 7361 7665 2061 7320 6669  ig to save as fi
-00018e90: 7473 290a 2020 2020 6361 7461 6c6f 672e  ts).    catalog.
-00018ea0: 6d65 7461 5b27 6465 7363 7269 7074 696f  meta['descriptio
-00018eb0: 6e27 5d20 3d20 6361 7461 6c6f 672e 6d65  n'] = catalog.me
-00018ec0: 7461 5b27 6465 7363 7269 7074 696f 6e27  ta['description'
-00018ed0: 5d5b 3a35 355d 0a0a 2020 2020 2320 5361  ][:55]..    # Sa
-00018ee0: 7665 2074 6162 6c65 2061 7320 6669 7473  ve table as fits
-00018ef0: 0a20 2020 2063 6174 616c 6f67 2e77 7269  .    catalog.wri
-00018f00: 7465 2873 6176 655f 6669 6c65 2c20 6f76  te(save_file, ov
-00018f10: 6572 7772 6974 6520 3d20 5472 7565 290a  erwrite = True).
-00018f20: 0a0a 6465 6620 646f 776e 6c6f 6164 5f72  ..def download_r
-00018f30: 6566 6361 7432 2873 6176 655f 6669 6c65  efcat2(save_file
-00018f40: 2c20 696d 6167 6520 3d20 4e6f 6e65 2c20  , image = None, 
-00018f50: 6669 656c 6449 445f 6361 7461 6c6f 6720  fieldID_catalog 
-00018f60: 3d20 4e6f 6e65 293a 0a0a 2020 2020 2222  = None):..    ""
-00018f70: 220a 2020 2020 446f 776e 6c6f 6164 7320  ".    Downloads 
-00018f80: 7468 6520 4154 4c41 5320 5245 4643 4154  the ATLAS REFCAT
-00018f90: 3220 6361 7461 6c6f 6720 6672 6f6d 2074  2 catalog from t
-00018fa0: 6865 2076 697a 6965 7220 6461 7461 6261  he vizier databa
-00018fb0: 7365 2069 6e20 7468 6520 7265 6769 6f6e  se in the region
-00018fc0: 0a20 2020 2063 6f76 6572 6564 2062 7920  .    covered by 
-00018fd0: 616e 2073 706c 7573 2069 6d61 6765 2e20  an splus image. 
-00018fe0: 4368 616e 6765 7320 636f 6c75 6d6e 206e  Changes column n
-00018ff0: 616d 6573 2066 6f72 2074 6865 2066 6f72  ames for the for
-00019000: 6d61 7420 7573 6564 2062 7920 7468 650a  mat used by the.
-00019010: 2020 2020 7069 7065 6c69 6e65 2c20 6465      pipeline, de
-00019020: 6c65 7465 7320 756e 6e65 6365 7373 6172  letes unnecessar
-00019030: 7920 636f 6c75 6d6e 7320 616e 6420 7361  y columns and sa
-00019040: 7665 7320 7265 7375 6c74 7320 746f 2061  ves results to a
-00019050: 2066 6974 7320 6669 6c65 0a0a 2020 2020   fits file..    
-00019060: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-00019070: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 696d  ---------.    im
-00019080: 6167 6520 3a20 7374 720a 2020 2020 2020  age : str.      
-00019090: 2020 4c6f 6361 7469 6f6e 206f 6620 7468    Location of th
-000190a0: 6520 7370 6c75 7320 696d 6167 6520 286d  e splus image (m
-000190b0: 7573 7420 6265 202e 667a 290a 2020 2020  ust be .fz).    
-000190c0: 7361 7665 5f66 696c 6520 3a20 7374 720a  save_file : str.
-000190d0: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
-000190e0: 2074 6f20 7361 7665 2074 6865 2072 6574   to save the ret
-000190f0: 7269 6576 6564 2063 6174 616c 6f67 2028  rieved catalog (
-00019100: 6d75 7374 2062 6520 2e66 6974 7329 0a0a  must be .fits)..
-00019110: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-00019120: 2d2d 2d2d 2d2d 2d0a 2020 2020 5361 7665  -------.    Save
-00019130: 7320 6361 7461 6c6f 6720 696e 2074 6865  s catalog in the
-00019140: 2064 6573 6972 6564 206c 6f63 6174 696f   desired locatio
-00019150: 6e0a 2020 2020 2222 220a 0a20 2020 2023  n.    """..    #
-00019160: 2056 697a 6965 7220 5461 626c 650a 2020   Vizier Table.  
-00019170: 2020 6361 745f 6964 203d 2022 4a2f 4170    cat_id = "J/Ap
-00019180: 4a2f 3836 372f 3130 352f 7265 6663 6174  J/867/105/refcat
-00019190: 3222 0a0a 2020 2020 636f 6c75 6d6e 7320  2"..    columns 
-000191a0: 3d20 5b27 5241 5f49 4352 5327 2c20 2744  = ['RA_ICRS', 'D
-000191b0: 455f 4943 5253 272c 2027 706d 5241 272c  E_ICRS', 'pmRA',
-000191c0: 2027 706d 4445 272c 2027 506c 7827 2c20   'pmDE', 'Plx', 
-000191d0: 2767 6d61 6727 2c0a 2020 2020 2020 2020  'gmag',.        
-000191e0: 2020 2020 2020 2027 655f 676d 6167 272c         'e_gmag',
-000191f0: 2027 726d 6167 272c 2027 655f 726d 6167   'rmag', 'e_rmag
-00019200: 272c 2027 696d 6167 272c 2027 655f 696d  ', 'imag', 'e_im
-00019210: 6167 272c 2027 7a6d 6167 272c 2027 655f  ag', 'zmag', 'e_
-00019220: 7a6d 6167 272c 0a20 2020 2020 2020 2020  zmag',.         
-00019230: 2020 2020 2020 2767 636f 6e74 7269 6227        'gcontrib'
-00019240: 2c20 2772 636f 6e74 7269 6227 2c20 2769  , 'rcontrib', 'i
-00019250: 636f 6e74 7269 6227 2c20 277a 636f 6e74  contrib', 'zcont
-00019260: 7269 6227 2c20 2741 4727 2c20 2741 6727  rib', 'AG', 'Ag'
-00019270: 5d0a 0a20 2020 2063 6f6c 756d 6e5f 6669  ]..    column_fi
-00019280: 6c74 6572 7320 3d20 7b27 506c 7827 3a20  lters = {'Plx': 
-00019290: 273e 3027 7d0a 0a20 2020 2023 2044 6f77  '>0'}..    # Dow
-000192a0: 6e6c 6f61 6420 6361 7461 6c6f 670a 2020  nload catalog.  
-000192b0: 2020 6361 7461 6c6f 6720 3d20 646f 776e    catalog = down
-000192c0: 6c6f 6164 5f76 697a 6965 725f 6361 7461  load_vizier_cata
-000192d0: 6c6f 675f 666f 725f 7370 6c75 735f 6669  log_for_splus_fi
-000192e0: 656c 6428 7370 6c75 735f 696d 6167 6520  eld(splus_image 
-000192f0: 3d20 696d 6167 652c 0a20 2020 2020 2020  = image,.       
-00019300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c80: 2020 2020 2020 2020 636f 6c75 6d6e 7320          columns 
+00018c90: 3d20 636f 6c75 6d6e 7329 0a0a 2020 2020  = columns)..    
+00018ca0: 2320 5265 6e61 6d65 2063 6f6c 756d 6e73  # Rename columns
+00018cb0: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
+00018cc0: 756d 6e73 5b27 4e61 6d65 275d 2e6e 616d  umns['Name'].nam
+00018cd0: 6520 3d20 2747 414c 4558 5f49 4427 0a20  e = 'GALEX_ID'. 
+00018ce0: 2020 2063 6174 616c 6f67 2e63 6f6c 756d     catalog.colum
+00018cf0: 6e73 5b27 5241 4a32 3030 3027 5d2e 6e61  ns['RAJ2000'].na
+00018d00: 6d65 203d 2027 4741 4c45 585f 5241 4a32  me = 'GALEX_RAJ2
+00018d10: 3030 3027 0a20 2020 2063 6174 616c 6f67  000'.    catalog
+00018d20: 2e63 6f6c 756d 6e73 5b27 4445 4a32 3030  .columns['DEJ200
+00018d30: 3027 5d2e 6e61 6d65 203d 2027 4741 4c45  0'].name = 'GALE
+00018d40: 585f 4445 4a32 3030 3027 0a20 2020 2063  X_DEJ2000'.    c
+00018d50: 6174 616c 6f67 2e63 6f6c 756d 6e73 5b27  atalog.columns['
+00018d60: 4655 566d 6167 275d 2e6e 616d 6520 3d20  FUVmag'].name = 
+00018d70: 2747 414c 4558 5f46 5556 270a 2020 2020  'GALEX_FUV'.    
+00018d80: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
+00018d90: 2765 5f46 5556 6d61 6727 5d2e 6e61 6d65  'e_FUVmag'].name
+00018da0: 203d 2027 4741 4c45 585f 4655 565f 6572   = 'GALEX_FUV_er
+00018db0: 7227 0a20 2020 2063 6174 616c 6f67 2e63  r'.    catalog.c
+00018dc0: 6f6c 756d 6e73 5b27 4e55 566d 6167 275d  olumns['NUVmag']
+00018dd0: 2e6e 616d 6520 3d20 2747 414c 4558 5f4e  .name = 'GALEX_N
+00018de0: 5556 270a 2020 2020 6361 7461 6c6f 672e  UV'.    catalog.
+00018df0: 636f 6c75 6d6e 735b 2765 5f4e 5556 6d61  columns['e_NUVma
+00018e00: 6727 5d2e 6e61 6d65 203d 2027 4741 4c45  g'].name = 'GALE
+00018e10: 585f 4e55 565f 6572 7227 0a0a 2020 2020  X_NUV_err'..    
+00018e20: 2320 5472 756e 6361 7465 2064 6573 6372  # Truncate descr
+00018e30: 6970 7469 6f6e 2028 7573 7561 6c6c 7920  iption (usually 
+00018e40: 746f 2062 6967 2074 6f20 7361 7665 2061  to big to save a
+00018e50: 7320 6669 7473 290a 2020 2020 6361 7461  s fits).    cata
+00018e60: 6c6f 672e 6d65 7461 5b27 6465 7363 7269  log.meta['descri
+00018e70: 7074 696f 6e27 5d20 3d20 6361 7461 6c6f  ption'] = catalo
+00018e80: 672e 6d65 7461 5b27 6465 7363 7269 7074  g.meta['descript
+00018e90: 696f 6e27 5d5b 3a35 355d 0a0a 2020 2020  ion'][:55]..    
+00018ea0: 2320 5361 7665 2074 6162 6c65 2061 7320  # Save table as 
+00018eb0: 6669 7473 0a20 2020 2063 6174 616c 6f67  fits.    catalog
+00018ec0: 2e77 7269 7465 2873 6176 655f 6669 6c65  .write(save_file
+00018ed0: 2c20 6f76 6572 7772 6974 6520 3d20 5472  , overwrite = Tr
+00018ee0: 7565 290a 0a0a 6465 6620 646f 776e 6c6f  ue)...def downlo
+00018ef0: 6164 5f72 6566 6361 7432 2873 6176 655f  ad_refcat2(save_
+00018f00: 6669 6c65 2c20 696d 6167 6520 3d20 4e6f  file, image = No
+00018f10: 6e65 2c20 6669 656c 6449 445f 6361 7461  ne, fieldID_cata
+00018f20: 6c6f 6720 3d20 4e6f 6e65 293a 0a0a 2020  log = None):..  
+00018f30: 2020 2222 220a 2020 2020 446f 776e 6c6f    """.    Downlo
+00018f40: 6164 7320 7468 6520 4154 4c41 5320 5245  ads the ATLAS RE
+00018f50: 4643 4154 3220 6361 7461 6c6f 6720 6672  FCAT2 catalog fr
+00018f60: 6f6d 2074 6865 2076 697a 6965 7220 6461  om the vizier da
+00018f70: 7461 6261 7365 2069 6e20 7468 6520 7265  tabase in the re
+00018f80: 6769 6f6e 0a20 2020 2063 6f76 6572 6564  gion.    covered
+00018f90: 2062 7920 616e 2073 706c 7573 2069 6d61   by an splus ima
+00018fa0: 6765 2e20 4368 616e 6765 7320 636f 6c75  ge. Changes colu
+00018fb0: 6d6e 206e 616d 6573 2066 6f72 2074 6865  mn names for the
+00018fc0: 2066 6f72 6d61 7420 7573 6564 2062 7920   format used by 
+00018fd0: 7468 650a 2020 2020 7069 7065 6c69 6e65  the.    pipeline
+00018fe0: 2c20 6465 6c65 7465 7320 756e 6e65 6365  , deletes unnece
+00018ff0: 7373 6172 7920 636f 6c75 6d6e 7320 616e  ssary columns an
+00019000: 6420 7361 7665 7320 7265 7375 6c74 7320  d saves results 
+00019010: 746f 2061 2066 6974 7320 6669 6c65 0a0a  to a fits file..
+00019020: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+00019030: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+00019040: 2020 696d 6167 6520 3a20 7374 720a 2020    image : str.  
+00019050: 2020 2020 2020 4c6f 6361 7469 6f6e 206f        Location o
+00019060: 6620 7468 6520 7370 6c75 7320 696d 6167  f the splus imag
+00019070: 6520 286d 7573 7420 6265 202e 667a 290a  e (must be .fz).
+00019080: 2020 2020 7361 7665 5f66 696c 6520 3a20      save_file : 
+00019090: 7374 720a 2020 2020 2020 2020 4c6f 6361  str.        Loca
+000190a0: 7469 6f6e 2074 6f20 7361 7665 2074 6865  tion to save the
+000190b0: 2072 6574 7269 6576 6564 2063 6174 616c   retrieved catal
+000190c0: 6f67 2028 6d75 7374 2062 6520 2e66 6974  og (must be .fit
+000190d0: 7329 0a0a 2020 2020 5265 7475 726e 730a  s)..    Returns.
+000190e0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+000190f0: 5361 7665 7320 6361 7461 6c6f 6720 696e  Saves catalog in
+00019100: 2074 6865 2064 6573 6972 6564 206c 6f63   the desired loc
+00019110: 6174 696f 6e0a 2020 2020 2222 220a 0a20  ation.    """.. 
+00019120: 2020 2023 2056 697a 6965 7220 5461 626c     # Vizier Tabl
+00019130: 650a 2020 2020 6361 745f 6964 203d 2022  e.    cat_id = "
+00019140: 4a2f 4170 4a2f 3836 372f 3130 352f 7265  J/ApJ/867/105/re
+00019150: 6663 6174 3222 0a0a 2020 2020 636f 6c75  fcat2"..    colu
+00019160: 6d6e 7320 3d20 5b27 5241 5f49 4352 5327  mns = ['RA_ICRS'
+00019170: 2c20 2744 455f 4943 5253 272c 2027 706d  , 'DE_ICRS', 'pm
+00019180: 5241 272c 2027 706d 4445 272c 2027 506c  RA', 'pmDE', 'Pl
+00019190: 7827 2c20 2767 6d61 6727 2c0a 2020 2020  x', 'gmag',.    
+000191a0: 2020 2020 2020 2020 2020 2027 655f 676d             'e_gm
+000191b0: 6167 272c 2027 726d 6167 272c 2027 655f  ag', 'rmag', 'e_
+000191c0: 726d 6167 272c 2027 696d 6167 272c 2027  rmag', 'imag', '
+000191d0: 655f 696d 6167 272c 2027 7a6d 6167 272c  e_imag', 'zmag',
+000191e0: 2027 655f 7a6d 6167 272c 0a20 2020 2020   'e_zmag',.     
+000191f0: 2020 2020 2020 2020 2020 2767 636f 6e74            'gcont
+00019200: 7269 6227 2c20 2772 636f 6e74 7269 6227  rib', 'rcontrib'
+00019210: 2c20 2769 636f 6e74 7269 6227 2c20 277a  , 'icontrib', 'z
+00019220: 636f 6e74 7269 6227 2c20 2741 4727 2c20  contrib', 'AG', 
+00019230: 2741 6727 5d0a 0a20 2020 2063 6f6c 756d  'Ag']..    colum
+00019240: 6e5f 6669 6c74 6572 7320 3d20 7b27 506c  n_filters = {'Pl
+00019250: 7827 3a20 273e 3027 7d0a 0a20 2020 2023  x': '>0'}..    #
+00019260: 2044 6f77 6e6c 6f61 6420 6361 7461 6c6f   Download catalo
+00019270: 670a 2020 2020 6361 7461 6c6f 6720 3d20  g.    catalog = 
+00019280: 646f 776e 6c6f 6164 5f76 697a 6965 725f  download_vizier_
+00019290: 6361 7461 6c6f 675f 666f 725f 7370 6c75  catalog_for_splu
+000192a0: 735f 6669 656c 6428 7370 6c75 735f 696d  s_field(splus_im
+000192b0: 6167 6520 3d20 696d 6167 652c 0a20 2020  age = image,.   
+000192c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000192d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000192e0: 2020 2020 2020 2020 2020 2020 6669 656c              fiel
+000192f0: 6449 445f 6361 7461 6c6f 673d 6669 656c  dID_catalog=fiel
+00019300: 6449 445f 6361 7461 6c6f 672c 0a20 2020  dID_catalog,.   
 00019310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019320: 2020 2020 2020 2020 6669 656c 6449 445f          fieldID_
-00019330: 6361 7461 6c6f 673d 6669 656c 6449 445f  catalog=fieldID_
-00019340: 6361 7461 6c6f 672c 0a20 2020 2020 2020  catalog,.       
-00019350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019330: 2020 2020 2020 2020 2020 2020 7669 7a69              vizi
+00019340: 6572 5f63 6174 616c 6f67 5f69 6420 3d20  er_catalog_id = 
+00019350: 6361 745f 6964 2c0a 2020 2020 2020 2020  cat_id,.        
 00019360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019370: 2020 2020 2020 2020 7669 7a69 6572 5f63          vizier_c
-00019380: 6174 616c 6f67 5f69 6420 3d20 6361 745f  atalog_id = cat_
-00019390: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+00019370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019380: 2020 2020 2020 2063 6f6c 756d 6e73 203d         columns =
+00019390: 2063 6f6c 756d 6e73 2c0a 2020 2020 2020   columns,.      
 000193a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000193b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193c0: 2020 2063 6f6c 756d 6e73 203d 2063 6f6c     columns = col
-000193d0: 756d 6e73 2c0a 2020 2020 2020 2020 2020  umns,.          
-000193e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019400: 2020 2020 2063 6f6c 756d 6e5f 6669 6c74       column_filt
-00019410: 6572 7320 3d20 636f 6c75 6d6e 5f66 696c  ers = column_fil
-00019420: 7465 7273 290a 0a20 2020 2023 2323 2323  ters)..    #####
-00019430: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019440: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019450: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
-00019460: 2043 6f76 6572 7420 636f 6f72 6469 6e61   Covert coordina
-00019470: 7465 7320 6672 6f6d 2045 504f 4348 2032  tes from EPOCH 2
-00019480: 3031 352e 3520 746f 204a 3230 3030 0a20  015.5 to J2000. 
-00019490: 2020 2072 615f 6963 7273 203d 2063 6174     ra_icrs = cat
-000194a0: 616c 6f67 2e63 6f6c 756d 6e73 5b27 5241  alog.columns['RA
-000194b0: 5f49 4352 5327 5d0a 2020 2020 6465 5f69  _ICRS'].    de_i
-000194c0: 6372 7320 3d20 6361 7461 6c6f 672e 636f  crs = catalog.co
-000194d0: 6c75 6d6e 735b 2744 455f 4943 5253 275d  lumns['DE_ICRS']
-000194e0: 0a20 2020 2070 6d72 6120 2020 203d 2063  .    pmra    = c
-000194f0: 6174 616c 6f67 2e63 6f6c 756d 6e73 5b27  atalog.columns['
-00019500: 706d 5241 275d 0a20 2020 2070 6d64 6520  pmRA'].    pmde 
-00019510: 2020 203d 2063 6174 616c 6f67 2e63 6f6c     = catalog.col
-00019520: 756d 6e73 5b27 706d 4445 275d 0a20 2020  umns['pmDE'].   
-00019530: 2070 6c78 2020 2020 203d 206e 702e 6172   plx     = np.ar
-00019540: 7261 7928 6361 7461 6c6f 672e 636f 6c75  ray(catalog.colu
-00019550: 6d6e 735b 2750 6c78 275d 290a 0a20 2020  mns['Plx'])..   
-00019560: 2063 203d 2053 6b79 436f 6f72 6428 7261   c = SkyCoord(ra
-00019570: 3d72 615f 6963 7273 2c20 6465 633d 6465  =ra_icrs, dec=de
-00019580: 5f69 6372 732c 2066 7261 6d65 3d27 6963  _icrs, frame='ic
-00019590: 7273 272c 0a20 2020 2020 2020 2020 2020  rs',.           
-000195a0: 2020 2020 2020 706d 5f72 615f 636f 7364        pm_ra_cosd
-000195b0: 6563 3d20 706d 7261 2c20 706d 5f64 6563  ec= pmra, pm_dec
-000195c0: 203d 2070 6d64 652c 0a20 2020 2020 2020   = pmde,.       
-000195d0: 2020 2020 2020 2020 2020 6469 7374 616e            distan
-000195e0: 6365 203d 2044 6973 7461 6e63 6528 7061  ce = Distance(pa
-000195f0: 7261 6c6c 6178 3d70 6c78 2a75 2e6d 6173  rallax=plx*u.mas
-00019600: 2c20 616c 6c6f 775f 6e65 6761 7469 7665  , allow_negative
-00019610: 3d54 7275 6529 2c0a 2020 2020 2020 2020  =True),.        
-00019620: 2020 2020 2020 2020 206f 6273 7469 6d65           obstime
-00019630: 203d 2054 696d 6528 3230 3135 2e35 2c20   = Time(2015.5, 
-00019640: 666f 726d 6174 3d27 6a79 6561 7227 2929  format='jyear'))
-00019650: 0a0a 2020 2020 2320 436f 6e76 6572 7420  ..    # Convert 
-00019660: 6570 6f63 6820 6672 6f6d 2032 3031 352e  epoch from 2015.
-00019670: 3520 746f 204a 3230 3030 0a20 2020 2063  5 to J2000.    c
-00019680: 5f6a 3230 3030 203d 2063 2e61 7070 6c79  _j2000 = c.apply
-00019690: 5f73 7061 6365 5f6d 6f74 696f 6e28 5469  _space_motion(Ti
-000196a0: 6d65 2832 3030 302e 302c 2066 6f72 6d61  me(2000.0, forma
-000196b0: 743d 276a 7965 6172 2729 290a 0a20 2020  t='jyear'))..   
-000196c0: 2023 2047 6574 2052 4120 616e 6420 4445   # Get RA and DE
-000196d0: 430a 2020 2020 7261 203d 206e 702e 6172  C.    ra = np.ar
-000196e0: 7261 7928 635f 6a32 3030 302e 7261 290a  ray(c_j2000.ra).
-000196f0: 2020 2020 6465 203d 206e 702e 6172 7261      de = np.arra
-00019700: 7928 635f 6a32 3030 302e 6465 6329 0a0a  y(c_j2000.dec)..
-00019710: 2020 2020 2323 2323 2323 2323 2323 2323      ############
-00019720: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019730: 2323 0a20 2020 2023 2041 6464 2052 4120  ##.    # Add RA 
-00019740: 616e 6420 4445 4320 4a32 3030 3020 636f  and DEC J2000 co
-00019750: 6c75 6d6e 730a 2020 2020 6361 7461 6c6f  lumns.    catalo
-00019760: 675b 2752 4546 4341 5432 5f52 414a 3230  g['REFCAT2_RAJ20
-00019770: 3030 275d 203d 2072 610a 2020 2020 6361  00'] = ra.    ca
-00019780: 7461 6c6f 675b 2752 4546 4341 5432 5f44  talog['REFCAT2_D
-00019790: 454a 3230 3030 275d 203d 2064 650a 0a20  EJ2000'] = de.. 
-000197a0: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-000197b0: 2323 230a 2020 2020 2320 5265 6e61 6d65  ###.    # Rename
-000197c0: 2063 6f6c 756d 6e73 0a20 2020 2063 6174   columns.    cat
-000197d0: 616c 6f67 2e63 6f6c 756d 6e73 5b27 676d  alog.columns['gm
-000197e0: 6167 275d 2e6e 616d 6520 3d20 2750 535f  ag'].name = 'PS_
-000197f0: 4727 0a20 2020 2063 6174 616c 6f67 2e63  G'.    catalog.c
-00019800: 6f6c 756d 6e73 5b27 655f 676d 6167 275d  olumns['e_gmag']
-00019810: 2e6e 616d 6520 3d20 2750 535f 475f 6572  .name = 'PS_G_er
-00019820: 7227 0a20 2020 2063 6174 616c 6f67 2e63  r'.    catalog.c
-00019830: 6f6c 756d 6e73 5b27 726d 6167 275d 2e6e  olumns['rmag'].n
-00019840: 616d 6520 3d20 2750 535f 5227 0a20 2020  ame = 'PS_R'.   
-00019850: 2063 6174 616c 6f67 2e63 6f6c 756d 6e73   catalog.columns
-00019860: 5b27 655f 726d 6167 275d 2e6e 616d 6520  ['e_rmag'].name 
-00019870: 3d20 2750 535f 525f 6572 7227 0a20 2020  = 'PS_R_err'.   
-00019880: 2063 6174 616c 6f67 2e63 6f6c 756d 6e73   catalog.columns
-00019890: 5b27 696d 6167 275d 2e6e 616d 6520 3d20  ['imag'].name = 
-000198a0: 2750 535f 4927 0a20 2020 2063 6174 616c  'PS_I'.    catal
-000198b0: 6f67 2e63 6f6c 756d 6e73 5b27 655f 696d  og.columns['e_im
-000198c0: 6167 275d 2e6e 616d 6520 3d20 2750 535f  ag'].name = 'PS_
-000198d0: 495f 6572 7227 0a20 2020 2063 6174 616c  I_err'.    catal
-000198e0: 6f67 2e63 6f6c 756d 6e73 5b27 7a6d 6167  og.columns['zmag
-000198f0: 275d 2e6e 616d 6520 3d20 2750 535f 5a27  '].name = 'PS_Z'
-00019900: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
-00019910: 756d 6e73 5b27 655f 7a6d 6167 275d 2e6e  umns['e_zmag'].n
-00019920: 616d 6520 3d20 2750 535f 5a5f 6572 7227  ame = 'PS_Z_err'
-00019930: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
-00019940: 756d 6e73 5b27 4147 275d 2e6e 616d 6520  umns['AG'].name 
-00019950: 3d20 2741 475f 4761 6961 2720 2320 4720  = 'AG_Gaia' # G 
-00019960: 6261 6e64 2065 7874 696e 6374 696f 6e20  band extinction 
-00019970: 6279 2047 6169 610a 2020 2020 6361 7461  by Gaia.    cata
-00019980: 6c6f 672e 636f 6c75 6d6e 735b 2741 6727  log.columns['Ag'
-00019990: 5d2e 6e61 6d65 203d 2027 4147 5f53 6368  ].name = 'AG_Sch
-000199a0: 6c65 6765 6c27 2023 2047 2062 616e 6420  legel' # G band 
-000199b0: 6578 7469 6e63 7469 6f6e 2062 7920 5363  extinction by Sc
-000199c0: 6865 6c65 6765 6c0a 0a20 2020 2023 2054  helegel..    # T
-000199d0: 7275 6e63 6174 6520 6465 7363 7269 7074  runcate descript
-000199e0: 696f 6e20 2875 7375 616c 6c79 2074 6f20  ion (usually to 
-000199f0: 6269 6720 746f 2073 6176 6520 6173 2066  big to save as f
-00019a00: 6974 7329 0a20 2020 2063 6174 616c 6f67  its).    catalog
-00019a10: 2e6d 6574 615b 2764 6573 6372 6970 7469  .meta['descripti
-00019a20: 6f6e 275d 203d 2063 6174 616c 6f67 2e6d  on'] = catalog.m
-00019a30: 6574 615b 2764 6573 6372 6970 7469 6f6e  eta['description
-00019a40: 275d 5b3a 3535 5d0a 0a20 2020 2023 2323  '][:55]..    ###
-00019a50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019a60: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-00019a70: 2320 5265 6d6f 7665 2075 6e72 656c 6961  # Remove unrelia
-00019a80: 626c 6520 6d61 676e 6974 7564 6573 0a20  ble magnitudes. 
-00019a90: 2020 2023 2028 5053 206d 6167 2065 7374     # (PS mag est
-00019aa0: 696d 6174 6564 2066 726f 6d20 616e 2069  imated from an i
-00019ab0: 6e73 7566 6963 6965 6e74 206e 756d 6265  nsuficient numbe
-00019ac0: 7220 6f66 2072 6566 6572 656e 6365 7329  r of references)
-00019ad0: 0a20 2020 2066 203d 206e 702e 6675 6c6c  .    f = np.full
-00019ae0: 286c 656e 2872 6129 2c20 5472 7565 290a  (len(ra), True).
-00019af0: 2020 2020 666f 7220 6d61 6720 696e 205b      for mag in [
-00019b00: 2767 272c 2027 7227 2c20 2769 272c 2027  'g', 'r', 'i', '
-00019b10: 7a27 5d3a 0a20 2020 2020 2020 2063 6f6e  z']:.        con
-00019b20: 7472 6962 203d 206e 702e 6172 7261 7928  trib = np.array(
-00019b30: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
-00019b40: 6627 7b6d 6167 7d63 6f6e 7472 6962 275d  f'{mag}contrib']
-00019b50: 290a 2020 2020 2020 2020 6620 3d20 6620  ).        f = f 
-00019b60: 2620 2863 6f6e 7472 6962 2021 3d20 2730  & (contrib != '0
-00019b70: 3027 2920 2620 2863 6f6e 7472 6962 2021  0') & (contrib !
-00019b80: 3d20 2730 3127 290a 0a20 2020 2063 6174  = '01')..    cat
-00019b90: 616c 6f67 203d 2063 6174 616c 6f67 5b66  alog = catalog[f
-00019ba0: 5d0a 0a20 2020 2023 2323 2323 2323 2323  ]..    #########
-00019bb0: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-00019bc0: 2320 5361 7665 2074 6162 6c65 2061 7320  # Save table as 
-00019bd0: 6669 7473 0a20 2020 2063 6174 616c 6f67  fits.    catalog
-00019be0: 2e77 7269 7465 2873 6176 655f 6669 6c65  .write(save_file
-00019bf0: 2c20 6f76 6572 7772 6974 6520 3d20 5472  , overwrite = Tr
-00019c00: 7565 290a 0a0a 6465 6620 646f 776e 6c6f  ue)...def downlo
-00019c10: 6164 5f69 7665 7a69 6328 7361 7665 5f66  ad_ivezic(save_f
-00019c20: 696c 652c 2069 6d61 6765 203d 204e 6f6e  ile, image = Non
-00019c30: 652c 2066 6965 6c64 4944 5f63 6174 616c  e, fieldID_catal
-00019c40: 6f67 203d 204e 6f6e 6529 3a0a 2020 2020  og = None):.    
-00019c50: 2222 220a 2020 2020 446f 776e 6c6f 6164  """.    Download
-00019c60: 7320 7468 6520 4976 657a 6963 2063 6174  s the Ivezic cat
-00019c70: 616c 6f67 2066 726f 6d20 7468 6520 7669  alog from the vi
-00019c80: 7a69 6572 2064 6174 6162 6173 6520 696e  zier database in
-00019c90: 2074 6865 2072 6567 696f 6e0a 2020 2020   the region.    
-00019ca0: 636f 7665 7265 6420 6279 2061 6e20 7370  covered by an sp
-00019cb0: 6c75 7320 696d 6167 652e 2043 6861 6e67  lus image. Chang
-00019cc0: 6573 2063 6f6c 756d 6e20 6e61 6d65 7320  es column names 
-00019cd0: 666f 7220 7468 6520 666f 726d 6174 2075  for the format u
-00019ce0: 7365 6420 6279 2074 6865 0a20 2020 2070  sed by the.    p
-00019cf0: 6970 656c 696e 652c 2064 656c 6574 6573  ipeline, deletes
-00019d00: 2075 6e6e 6563 6573 7361 7279 2063 6f6c   unnecessary col
-00019d10: 756d 6e73 2061 6e64 2073 6176 6573 2072  umns and saves r
-00019d20: 6573 756c 7473 2074 6f20 6120 6669 7473  esults to a fits
-00019d30: 2066 696c 650a 0a20 2020 2050 6172 616d   file..    Param
-00019d40: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
-00019d50: 2d2d 2d2d 0a20 2020 2069 6d61 6765 203a  ----.    image :
-00019d60: 2073 7472 0a20 2020 2020 2020 204c 6f63   str.        Loc
-00019d70: 6174 696f 6e20 6f66 2074 6865 2073 706c  ation of the spl
-00019d80: 7573 2069 6d61 6765 2028 6d75 7374 2062  us image (must b
-00019d90: 6520 2e66 7a29 0a20 2020 2073 6176 655f  e .fz).    save_
-00019da0: 6669 6c65 203a 2073 7472 0a20 2020 2020  file : str.     
-00019db0: 2020 204c 6f63 6174 696f 6e20 746f 2073     Location to s
-00019dc0: 6176 6520 7468 6520 7265 7472 6965 7665  ave the retrieve
-00019dd0: 6420 6361 7461 6c6f 6720 286d 7573 7420  d catalog (must 
-00019de0: 6265 202e 6669 7473 290a 0a20 2020 2052  be .fits)..    R
-00019df0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-00019e00: 2d2d 0a20 2020 2053 6176 6573 2063 6174  --.    Saves cat
-00019e10: 616c 6f67 2069 6e20 7468 6520 6465 7369  alog in the desi
-00019e20: 7265 6420 6c6f 6361 7469 6f6e 0a20 2020  red location.   
-00019e30: 2022 2222 0a0a 2020 2020 2320 5669 7a69   """..    # Vizi
-00019e40: 6572 2054 6162 6c65 0a20 2020 2063 6174  er Table.    cat
-00019e50: 5f69 6420 3d20 224a 2f41 4a2f 3133 342f  _id = "J/AJ/134/
-00019e60: 3937 332f 7374 6463 6174 220a 0a20 2020  973/stdcat"..   
-00019e70: 2063 6f6c 756d 6e73 203d 205b 2752 414a   columns = ['RAJ
-00019e80: 3230 3030 272c 2027 4445 4a32 3030 3027  2000', 'DEJ2000'
-00019e90: 2c20 2775 6d61 6727 2c20 2765 5f75 6d61  , 'umag', 'e_uma
-00019ea0: 6727 2c20 2767 6d61 6727 2c20 2765 5f67  g', 'gmag', 'e_g
-00019eb0: 6d61 6727 2c0a 2020 2020 2020 2020 2020  mag',.          
-00019ec0: 2020 2020 2027 726d 6167 272c 2027 655f       'rmag', 'e_
-00019ed0: 726d 6167 272c 2027 696d 6167 272c 2027  rmag', 'imag', '
-00019ee0: 655f 696d 6167 272c 2027 7a6d 6167 272c  e_imag', 'zmag',
-00019ef0: 2027 655f 7a6d 6167 275d 0a0a 2020 2020   'e_zmag']..    
-00019f00: 2320 446f 776e 6c6f 6164 2063 6174 616c  # Download catal
-00019f10: 6f67 0a20 2020 2063 6174 616c 6f67 203d  og.    catalog =
-00019f20: 2064 6f77 6e6c 6f61 645f 7669 7a69 6572   download_vizier
-00019f30: 5f63 6174 616c 6f67 5f66 6f72 5f73 706c  _catalog_for_spl
-00019f40: 7573 5f66 6965 6c64 2873 706c 7573 5f69  us_field(splus_i
-00019f50: 6d61 6765 203d 2069 6d61 6765 2c0a 2020  mage = image,.  
-00019f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019f80: 2020 2020 2020 2020 2020 2020 2066 6965               fie
-00019f90: 6c64 4944 5f63 6174 616c 6f67 3d66 6965  ldID_catalog=fie
-00019fa0: 6c64 4944 5f63 6174 616c 6f67 2c0a 2020  ldID_catalog,.  
-00019fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000193c0: 2020 2020 2020 2020 2063 6f6c 756d 6e5f           column_
+000193d0: 6669 6c74 6572 7320 3d20 636f 6c75 6d6e  filters = column
+000193e0: 5f66 696c 7465 7273 290a 0a20 2020 2023  _filters)..    #
+000193f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00019400: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00019410: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
+00019420: 2020 2023 2043 6f76 6572 7420 636f 6f72     # Covert coor
+00019430: 6469 6e61 7465 7320 6672 6f6d 2045 504f  dinates from EPO
+00019440: 4348 2032 3031 352e 3520 746f 204a 3230  CH 2015.5 to J20
+00019450: 3030 0a20 2020 2072 615f 6963 7273 203d  00.    ra_icrs =
+00019460: 2063 6174 616c 6f67 2e63 6f6c 756d 6e73   catalog.columns
+00019470: 5b27 5241 5f49 4352 5327 5d0a 2020 2020  ['RA_ICRS'].    
+00019480: 6465 5f69 6372 7320 3d20 6361 7461 6c6f  de_icrs = catalo
+00019490: 672e 636f 6c75 6d6e 735b 2744 455f 4943  g.columns['DE_IC
+000194a0: 5253 275d 0a20 2020 2070 6d72 6120 2020  RS'].    pmra   
+000194b0: 203d 2063 6174 616c 6f67 2e63 6f6c 756d   = catalog.colum
+000194c0: 6e73 5b27 706d 5241 275d 0a20 2020 2070  ns['pmRA'].    p
+000194d0: 6d64 6520 2020 203d 2063 6174 616c 6f67  mde    = catalog
+000194e0: 2e63 6f6c 756d 6e73 5b27 706d 4445 275d  .columns['pmDE']
+000194f0: 0a20 2020 2070 6c78 2020 2020 203d 206e  .    plx     = n
+00019500: 702e 6172 7261 7928 6361 7461 6c6f 672e  p.array(catalog.
+00019510: 636f 6c75 6d6e 735b 2750 6c78 275d 290a  columns['Plx']).
+00019520: 0a20 2020 2063 203d 2053 6b79 436f 6f72  .    c = SkyCoor
+00019530: 6428 7261 3d72 615f 6963 7273 2c20 6465  d(ra=ra_icrs, de
+00019540: 633d 6465 5f69 6372 732c 2066 7261 6d65  c=de_icrs, frame
+00019550: 3d27 6963 7273 272c 0a20 2020 2020 2020  ='icrs',.       
+00019560: 2020 2020 2020 2020 2020 706d 5f72 615f            pm_ra_
+00019570: 636f 7364 6563 3d20 706d 7261 2c20 706d  cosdec= pmra, pm
+00019580: 5f64 6563 203d 2070 6d64 652c 0a20 2020  _dec = pmde,.   
+00019590: 2020 2020 2020 2020 2020 2020 2020 6469                di
+000195a0: 7374 616e 6365 203d 2044 6973 7461 6e63  stance = Distanc
+000195b0: 6528 7061 7261 6c6c 6178 3d70 6c78 2a75  e(parallax=plx*u
+000195c0: 2e6d 6173 2c20 616c 6c6f 775f 6e65 6761  .mas, allow_nega
+000195d0: 7469 7665 3d54 7275 6529 2c0a 2020 2020  tive=True),.    
+000195e0: 2020 2020 2020 2020 2020 2020 206f 6273               obs
+000195f0: 7469 6d65 203d 2054 696d 6528 3230 3135  time = Time(2015
+00019600: 2e35 2c20 666f 726d 6174 3d27 6a79 6561  .5, format='jyea
+00019610: 7227 2929 0a0a 2020 2020 2320 436f 6e76  r'))..    # Conv
+00019620: 6572 7420 6570 6f63 6820 6672 6f6d 2032  ert epoch from 2
+00019630: 3031 352e 3520 746f 204a 3230 3030 0a20  015.5 to J2000. 
+00019640: 2020 2063 5f6a 3230 3030 203d 2063 2e61     c_j2000 = c.a
+00019650: 7070 6c79 5f73 7061 6365 5f6d 6f74 696f  pply_space_motio
+00019660: 6e28 5469 6d65 2832 3030 302e 302c 2066  n(Time(2000.0, f
+00019670: 6f72 6d61 743d 276a 7965 6172 2729 290a  ormat='jyear')).
+00019680: 0a20 2020 2023 2047 6574 2052 4120 616e  .    # Get RA an
+00019690: 6420 4445 430a 2020 2020 7261 203d 206e  d DEC.    ra = n
+000196a0: 702e 6172 7261 7928 635f 6a32 3030 302e  p.array(c_j2000.
+000196b0: 7261 290a 2020 2020 6465 203d 206e 702e  ra).    de = np.
+000196c0: 6172 7261 7928 635f 6a32 3030 302e 6465  array(c_j2000.de
+000196d0: 6329 0a0a 2020 2020 2323 2323 2323 2323  c)..    ########
+000196e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000196f0: 2323 2323 2323 0a20 2020 2023 2041 6464  ######.    # Add
+00019700: 2052 4120 616e 6420 4445 4320 4a32 3030   RA and DEC J200
+00019710: 3020 636f 6c75 6d6e 730a 2020 2020 6361  0 columns.    ca
+00019720: 7461 6c6f 675b 2752 4546 4341 5432 5f52  talog['REFCAT2_R
+00019730: 414a 3230 3030 275d 203d 2072 610a 2020  AJ2000'] = ra.  
+00019740: 2020 6361 7461 6c6f 675b 2752 4546 4341    catalog['REFCA
+00019750: 5432 5f44 454a 3230 3030 275d 203d 2064  T2_DEJ2000'] = d
+00019760: 650a 0a20 2020 2023 2323 2323 2323 2323  e..    #########
+00019770: 2323 2323 2323 230a 2020 2020 2320 5265  #######.    # Re
+00019780: 6e61 6d65 2063 6f6c 756d 6e73 0a20 2020  name columns.   
+00019790: 2063 6174 616c 6f67 2e63 6f6c 756d 6e73   catalog.columns
+000197a0: 5b27 676d 6167 275d 2e6e 616d 6520 3d20  ['gmag'].name = 
+000197b0: 2750 535f 4727 0a20 2020 2063 6174 616c  'PS_G'.    catal
+000197c0: 6f67 2e63 6f6c 756d 6e73 5b27 655f 676d  og.columns['e_gm
+000197d0: 6167 275d 2e6e 616d 6520 3d20 2750 535f  ag'].name = 'PS_
+000197e0: 475f 6572 7227 0a20 2020 2063 6174 616c  G_err'.    catal
+000197f0: 6f67 2e63 6f6c 756d 6e73 5b27 726d 6167  og.columns['rmag
+00019800: 275d 2e6e 616d 6520 3d20 2750 535f 5227  '].name = 'PS_R'
+00019810: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
+00019820: 756d 6e73 5b27 655f 726d 6167 275d 2e6e  umns['e_rmag'].n
+00019830: 616d 6520 3d20 2750 535f 525f 6572 7227  ame = 'PS_R_err'
+00019840: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
+00019850: 756d 6e73 5b27 696d 6167 275d 2e6e 616d  umns['imag'].nam
+00019860: 6520 3d20 2750 535f 4927 0a20 2020 2063  e = 'PS_I'.    c
+00019870: 6174 616c 6f67 2e63 6f6c 756d 6e73 5b27  atalog.columns['
+00019880: 655f 696d 6167 275d 2e6e 616d 6520 3d20  e_imag'].name = 
+00019890: 2750 535f 495f 6572 7227 0a20 2020 2063  'PS_I_err'.    c
+000198a0: 6174 616c 6f67 2e63 6f6c 756d 6e73 5b27  atalog.columns['
+000198b0: 7a6d 6167 275d 2e6e 616d 6520 3d20 2750  zmag'].name = 'P
+000198c0: 535f 5a27 0a20 2020 2063 6174 616c 6f67  S_Z'.    catalog
+000198d0: 2e63 6f6c 756d 6e73 5b27 655f 7a6d 6167  .columns['e_zmag
+000198e0: 275d 2e6e 616d 6520 3d20 2750 535f 5a5f  '].name = 'PS_Z_
+000198f0: 6572 7227 0a20 2020 2063 6174 616c 6f67  err'.    catalog
+00019900: 2e63 6f6c 756d 6e73 5b27 4147 275d 2e6e  .columns['AG'].n
+00019910: 616d 6520 3d20 2741 475f 4761 6961 2720  ame = 'AG_Gaia' 
+00019920: 2320 4720 6261 6e64 2065 7874 696e 6374  # G band extinct
+00019930: 696f 6e20 6279 2047 6169 610a 2020 2020  ion by Gaia.    
+00019940: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
+00019950: 2741 6727 5d2e 6e61 6d65 203d 2027 4147  'Ag'].name = 'AG
+00019960: 5f53 6368 6c65 6765 6c27 2023 2047 2062  _Schlegel' # G b
+00019970: 616e 6420 6578 7469 6e63 7469 6f6e 2062  and extinction b
+00019980: 7920 5363 6865 6c65 6765 6c0a 0a20 2020  y Schelegel..   
+00019990: 2023 2054 7275 6e63 6174 6520 6465 7363   # Truncate desc
+000199a0: 7269 7074 696f 6e20 2875 7375 616c 6c79  ription (usually
+000199b0: 2074 6f20 6269 6720 746f 2073 6176 6520   to big to save 
+000199c0: 6173 2066 6974 7329 0a20 2020 2063 6174  as fits).    cat
+000199d0: 616c 6f67 2e6d 6574 615b 2764 6573 6372  alog.meta['descr
+000199e0: 6970 7469 6f6e 275d 203d 2063 6174 616c  iption'] = catal
+000199f0: 6f67 2e6d 6574 615b 2764 6573 6372 6970  og.meta['descrip
+00019a00: 7469 6f6e 275d 5b3a 3535 5d0a 0a20 2020  tion'][:55]..   
+00019a10: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+00019a20: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+00019a30: 2020 2020 2320 5265 6d6f 7665 2075 6e72      # Remove unr
+00019a40: 656c 6961 626c 6520 6d61 676e 6974 7564  eliable magnitud
+00019a50: 6573 0a20 2020 2023 2028 5053 206d 6167  es.    # (PS mag
+00019a60: 2065 7374 696d 6174 6564 2066 726f 6d20   estimated from 
+00019a70: 616e 2069 6e73 7566 6963 6965 6e74 206e  an insuficient n
+00019a80: 756d 6265 7220 6f66 2072 6566 6572 656e  umber of referen
+00019a90: 6365 7329 0a20 2020 2066 203d 206e 702e  ces).    f = np.
+00019aa0: 6675 6c6c 286c 656e 2872 6129 2c20 5472  full(len(ra), Tr
+00019ab0: 7565 290a 2020 2020 666f 7220 6d61 6720  ue).    for mag 
+00019ac0: 696e 205b 2767 272c 2027 7227 2c20 2769  in ['g', 'r', 'i
+00019ad0: 272c 2027 7a27 5d3a 0a20 2020 2020 2020  ', 'z']:.       
+00019ae0: 2063 6f6e 7472 6962 203d 206e 702e 6172   contrib = np.ar
+00019af0: 7261 7928 6361 7461 6c6f 672e 636f 6c75  ray(catalog.colu
+00019b00: 6d6e 735b 6627 7b6d 6167 7d63 6f6e 7472  mns[f'{mag}contr
+00019b10: 6962 275d 290a 2020 2020 2020 2020 6620  ib']).        f 
+00019b20: 3d20 6620 2620 2863 6f6e 7472 6962 2021  = f & (contrib !
+00019b30: 3d20 2730 3027 2920 2620 2863 6f6e 7472  = '00') & (contr
+00019b40: 6962 2021 3d20 2730 3127 290a 0a20 2020  ib != '01')..   
+00019b50: 2063 6174 616c 6f67 203d 2063 6174 616c   catalog = catal
+00019b60: 6f67 5b66 5d0a 0a20 2020 2023 2323 2323  og[f]..    #####
+00019b70: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+00019b80: 2020 2020 2320 5361 7665 2074 6162 6c65      # Save table
+00019b90: 2061 7320 6669 7473 0a20 2020 2063 6174   as fits.    cat
+00019ba0: 616c 6f67 2e77 7269 7465 2873 6176 655f  alog.write(save_
+00019bb0: 6669 6c65 2c20 6f76 6572 7772 6974 6520  file, overwrite 
+00019bc0: 3d20 5472 7565 290a 0a0a 6465 6620 646f  = True)...def do
+00019bd0: 776e 6c6f 6164 5f69 7665 7a69 6328 7361  wnload_ivezic(sa
+00019be0: 7665 5f66 696c 652c 2069 6d61 6765 203d  ve_file, image =
+00019bf0: 204e 6f6e 652c 2066 6965 6c64 4944 5f63   None, fieldID_c
+00019c00: 6174 616c 6f67 203d 204e 6f6e 6529 3a0a  atalog = None):.
+00019c10: 2020 2020 2222 220a 2020 2020 446f 776e      """.    Down
+00019c20: 6c6f 6164 7320 7468 6520 4976 657a 6963  loads the Ivezic
+00019c30: 2063 6174 616c 6f67 2066 726f 6d20 7468   catalog from th
+00019c40: 6520 7669 7a69 6572 2064 6174 6162 6173  e vizier databas
+00019c50: 6520 696e 2074 6865 2072 6567 696f 6e0a  e in the region.
+00019c60: 2020 2020 636f 7665 7265 6420 6279 2061      covered by a
+00019c70: 6e20 7370 6c75 7320 696d 6167 652e 2043  n splus image. C
+00019c80: 6861 6e67 6573 2063 6f6c 756d 6e20 6e61  hanges column na
+00019c90: 6d65 7320 666f 7220 7468 6520 666f 726d  mes for the form
+00019ca0: 6174 2075 7365 6420 6279 2074 6865 0a20  at used by the. 
+00019cb0: 2020 2070 6970 656c 696e 652c 2064 656c     pipeline, del
+00019cc0: 6574 6573 2075 6e6e 6563 6573 7361 7279  etes unnecessary
+00019cd0: 2063 6f6c 756d 6e73 2061 6e64 2073 6176   columns and sav
+00019ce0: 6573 2072 6573 756c 7473 2074 6f20 6120  es results to a 
+00019cf0: 6669 7473 2066 696c 650a 0a20 2020 2050  fits file..    P
+00019d00: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+00019d10: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2069 6d61  --------.    ima
+00019d20: 6765 203a 2073 7472 0a20 2020 2020 2020  ge : str.       
+00019d30: 204c 6f63 6174 696f 6e20 6f66 2074 6865   Location of the
+00019d40: 2073 706c 7573 2069 6d61 6765 2028 6d75   splus image (mu
+00019d50: 7374 2062 6520 2e66 7a29 0a20 2020 2073  st be .fz).    s
+00019d60: 6176 655f 6669 6c65 203a 2073 7472 0a20  ave_file : str. 
+00019d70: 2020 2020 2020 204c 6f63 6174 696f 6e20         Location 
+00019d80: 746f 2073 6176 6520 7468 6520 7265 7472  to save the retr
+00019d90: 6965 7665 6420 6361 7461 6c6f 6720 286d  ieved catalog (m
+00019da0: 7573 7420 6265 202e 6669 7473 290a 0a20  ust be .fits).. 
+00019db0: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
+00019dc0: 2d2d 2d2d 2d2d 0a20 2020 2053 6176 6573  ------.    Saves
+00019dd0: 2063 6174 616c 6f67 2069 6e20 7468 6520   catalog in the 
+00019de0: 6465 7369 7265 6420 6c6f 6361 7469 6f6e  desired location
+00019df0: 0a20 2020 2022 2222 0a0a 2020 2020 2320  .    """..    # 
+00019e00: 5669 7a69 6572 2054 6162 6c65 0a20 2020  Vizier Table.   
+00019e10: 2063 6174 5f69 6420 3d20 224a 2f41 4a2f   cat_id = "J/AJ/
+00019e20: 3133 342f 3937 332f 7374 6463 6174 220a  134/973/stdcat".
+00019e30: 0a20 2020 2063 6f6c 756d 6e73 203d 205b  .    columns = [
+00019e40: 2752 414a 3230 3030 272c 2027 4445 4a32  'RAJ2000', 'DEJ2
+00019e50: 3030 3027 2c20 2775 6d61 6727 2c20 2765  000', 'umag', 'e
+00019e60: 5f75 6d61 6727 2c20 2767 6d61 6727 2c20  _umag', 'gmag', 
+00019e70: 2765 5f67 6d61 6727 2c0a 2020 2020 2020  'e_gmag',.      
+00019e80: 2020 2020 2020 2020 2027 726d 6167 272c           'rmag',
+00019e90: 2027 655f 726d 6167 272c 2027 696d 6167   'e_rmag', 'imag
+00019ea0: 272c 2027 655f 696d 6167 272c 2027 7a6d  ', 'e_imag', 'zm
+00019eb0: 6167 272c 2027 655f 7a6d 6167 275d 0a0a  ag', 'e_zmag']..
+00019ec0: 2020 2020 2320 446f 776e 6c6f 6164 2063      # Download c
+00019ed0: 6174 616c 6f67 0a20 2020 2063 6174 616c  atalog.    catal
+00019ee0: 6f67 203d 2064 6f77 6e6c 6f61 645f 7669  og = download_vi
+00019ef0: 7a69 6572 5f63 6174 616c 6f67 5f66 6f72  zier_catalog_for
+00019f00: 5f73 706c 7573 5f66 6965 6c64 2873 706c  _splus_field(spl
+00019f10: 7573 5f69 6d61 6765 203d 2069 6d61 6765  us_image = image
+00019f20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00019f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f50: 2066 6965 6c64 4944 5f63 6174 616c 6f67   fieldID_catalog
+00019f60: 3d66 6965 6c64 4944 5f63 6174 616c 6f67  =fieldID_catalog
+00019f70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00019f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019fa0: 2076 697a 6965 725f 6361 7461 6c6f 675f   vizier_catalog_
+00019fb0: 6964 203d 2063 6174 5f69 642c 0a20 2020  id = cat_id,.   
 00019fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019fd0: 2020 2020 2020 2020 2020 2020 2076 697a               viz
-00019fe0: 6965 725f 6361 7461 6c6f 675f 6964 203d  ier_catalog_id =
-00019ff0: 2063 6174 5f69 642c 0a20 2020 2020 2020   cat_id,.       
-0001a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a020: 2020 2020 2020 2020 636f 6c75 6d6e 7320          columns 
-0001a030: 3d20 636f 6c75 6d6e 7329 0a0a 2020 2020  = columns)..    
-0001a040: 2320 5265 6e61 6d65 2063 6f6c 756d 6e73  # Rename columns
-0001a050: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
-0001a060: 756d 6e73 5b27 5241 4a32 3030 3027 5d2e  umns['RAJ2000'].
-0001a070: 6e61 6d65 203d 2027 4956 455a 4943 5f52  name = 'IVEZIC_R
-0001a080: 414a 3230 3030 270a 2020 2020 6361 7461  AJ2000'.    cata
-0001a090: 6c6f 672e 636f 6c75 6d6e 735b 2744 454a  log.columns['DEJ
-0001a0a0: 3230 3030 275d 2e6e 616d 6520 3d20 2749  2000'].name = 'I
-0001a0b0: 5645 5a49 435f 4445 4a32 3030 3027 0a0a  VEZIC_DEJ2000'..
-0001a0c0: 2020 2020 6361 7461 6c6f 672e 636f 6c75      catalog.colu
-0001a0d0: 6d6e 735b 2775 6d61 6727 5d2e 6e61 6d65  mns['umag'].name
-0001a0e0: 203d 2027 5344 5353 5f55 270a 2020 2020   = 'SDSS_U'.    
-0001a0f0: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
-0001a100: 2765 5f75 6d61 6727 5d2e 6e61 6d65 203d  'e_umag'].name =
-0001a110: 2027 5344 5353 5f55 5f65 7272 270a 2020   'SDSS_U_err'.  
-0001a120: 2020 6361 7461 6c6f 672e 636f 6c75 6d6e    catalog.column
-0001a130: 735b 2767 6d61 6727 5d2e 6e61 6d65 203d  s['gmag'].name =
-0001a140: 2027 5344 5353 5f47 270a 2020 2020 6361   'SDSS_G'.    ca
-0001a150: 7461 6c6f 672e 636f 6c75 6d6e 735b 2765  talog.columns['e
-0001a160: 5f67 6d61 6727 5d2e 6e61 6d65 203d 2027  _gmag'].name = '
-0001a170: 5344 5353 5f47 5f65 7272 270a 2020 2020  SDSS_G_err'.    
-0001a180: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
-0001a190: 2772 6d61 6727 5d2e 6e61 6d65 203d 2027  'rmag'].name = '
-0001a1a0: 5344 5353 5f52 270a 2020 2020 6361 7461  SDSS_R'.    cata
-0001a1b0: 6c6f 672e 636f 6c75 6d6e 735b 2765 5f72  log.columns['e_r
-0001a1c0: 6d61 6727 5d2e 6e61 6d65 203d 2027 5344  mag'].name = 'SD
-0001a1d0: 5353 5f52 5f65 7272 270a 2020 2020 6361  SS_R_err'.    ca
-0001a1e0: 7461 6c6f 672e 636f 6c75 6d6e 735b 2769  talog.columns['i
-0001a1f0: 6d61 6727 5d2e 6e61 6d65 203d 2027 5344  mag'].name = 'SD
-0001a200: 5353 5f49 270a 2020 2020 6361 7461 6c6f  SS_I'.    catalo
-0001a210: 672e 636f 6c75 6d6e 735b 2765 5f69 6d61  g.columns['e_ima
-0001a220: 6727 5d2e 6e61 6d65 203d 2027 5344 5353  g'].name = 'SDSS
-0001a230: 5f49 5f65 7272 270a 2020 2020 6361 7461  _I_err'.    cata
-0001a240: 6c6f 672e 636f 6c75 6d6e 735b 277a 6d61  log.columns['zma
-0001a250: 6727 5d2e 6e61 6d65 203d 2027 5344 5353  g'].name = 'SDSS
-0001a260: 5f5a 270a 2020 2020 6361 7461 6c6f 672e  _Z'.    catalog.
-0001a270: 636f 6c75 6d6e 735b 2765 5f7a 6d61 6727  columns['e_zmag'
-0001a280: 5d2e 6e61 6d65 203d 2027 5344 5353 5f5a  ].name = 'SDSS_Z
-0001a290: 5f65 7272 270a 0a20 2020 2023 2323 2323  _err'..    #####
-0001a2a0: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-0001a2b0: 2020 2023 2052 656d 6f76 6520 6e61 6e20     # Remove nan 
-0001a2c0: 7661 6c75 6573 0a20 2020 204e 726f 7773  values.    Nrows
-0001a2d0: 203d 206e 702e 6172 7261 7928 6361 7461   = np.array(cata
-0001a2e0: 6c6f 672e 636f 6c75 6d6e 735b 2749 5645  log.columns['IVE
-0001a2f0: 5a49 435f 5241 4a32 3030 3027 5d29 2e73  ZIC_RAJ2000']).s
-0001a300: 6861 7065 5b30 5d0a 2020 2020 6620 3d20  hape[0].    f = 
-0001a310: 6e70 2e66 756c 6c28 4e72 6f77 732c 2054  np.full(Nrows, T
-0001a320: 7275 6529 0a0a 2020 2020 666f 7220 6d61  rue)..    for ma
-0001a330: 6720 696e 205b 2755 272c 2027 4727 2c20  g in ['U', 'G', 
-0001a340: 2752 272c 2027 4927 2c20 275a 275d 3a0a  'R', 'I', 'Z']:.
-0001a350: 2020 2020 2020 2020 6620 3d20 6620 2620          f = f & 
-0001a360: 286e 702e 6172 7261 7928 6361 7461 6c6f  (np.array(catalo
-0001a370: 672e 636f 6c75 6d6e 735b 6627 5344 5353  g.columns[f'SDSS
-0001a380: 5f7b 6d61 677d 275d 2920 3c20 3930 290a  _{mag}']) < 90).
-0001a390: 0a20 2020 2063 6174 616c 6f67 203d 2063  .    catalog = c
-0001a3a0: 6174 616c 6f67 5b66 5d0a 0a20 2020 2023  atalog[f]..    #
-0001a3b0: 2054 7275 6e63 6174 6520 6465 7363 7269   Truncate descri
-0001a3c0: 7074 696f 6e20 2875 7375 616c 6c79 2074  ption (usually t
-0001a3d0: 6f20 6269 6720 746f 2073 6176 6520 6173  o big to save as
-0001a3e0: 2066 6974 7329 0a20 2020 2063 6174 616c   fits).    catal
-0001a3f0: 6f67 2e6d 6574 615b 2764 6573 6372 6970  og.meta['descrip
-0001a400: 7469 6f6e 275d 203d 2063 6174 616c 6f67  tion'] = catalog
-0001a410: 2e6d 6574 615b 2764 6573 6372 6970 7469  .meta['descripti
-0001a420: 6f6e 275d 5b3a 3535 5d0a 0a20 2020 2023  on'][:55]..    #
-0001a430: 2053 6176 6520 7461 626c 6520 6173 2066   Save table as f
-0001a440: 6974 730a 2020 2020 6361 7461 6c6f 672e  its.    catalog.
-0001a450: 7772 6974 6528 7361 7665 5f66 696c 652c  write(save_file,
-0001a460: 206f 7665 7277 7269 7465 203d 2054 7275   overwrite = Tru
-0001a470: 6529 0a0a 0a64 6566 2064 6f77 6e6c 6f61  e)...def downloa
-0001a480: 645f 6976 657a 6963 4142 2873 6176 655f  d_ivezicAB(save_
-0001a490: 6669 6c65 2c20 696d 6167 6520 3d20 4e6f  file, image = No
-0001a4a0: 6e65 2c20 6669 656c 6449 445f 6361 7461  ne, fieldID_cata
-0001a4b0: 6c6f 6720 3d20 4e6f 6e65 293a 0a20 2020  log = None):.   
-0001a4c0: 2022 2222 0a20 2020 2044 6f77 6e6c 6f61   """.    Downloa
-0001a4d0: 6473 2074 6865 2049 7665 7a69 6320 6361  ds the Ivezic ca
-0001a4e0: 7461 6c6f 6720 6672 6f6d 2074 6865 2076  talog from the v
-0001a4f0: 697a 6965 7220 6461 7461 6261 7365 2069  izier database i
-0001a500: 6e20 7468 6520 7265 6769 6f6e 0a20 2020  n the region.   
-0001a510: 2063 6f76 6572 6564 2062 7920 616e 2073   covered by an s
-0001a520: 706c 7573 2069 6d61 6765 2e20 4368 616e  plus image. Chan
-0001a530: 6765 7320 636f 6c75 6d6e 206e 616d 6573  ges column names
-0001a540: 2066 6f72 2074 6865 2066 6f72 6d61 7420   for the format 
-0001a550: 7573 6564 2062 7920 7468 650a 2020 2020  used by the.    
-0001a560: 7069 7065 6c69 6e65 2c20 6465 6c65 7465  pipeline, delete
-0001a570: 7320 756e 6e65 6365 7373 6172 7920 636f  s unnecessary co
-0001a580: 6c75 6d6e 7320 616e 6420 7361 7665 7320  lumns and saves 
-0001a590: 7265 7375 6c74 7320 746f 2061 2066 6974  results to a fit
-0001a5a0: 7320 6669 6c65 0a20 2020 200a 2020 2020  s file.    .    
-0001a5b0: 4166 7465 7220 646f 776e 6c6f 6164 696e  After downloadin
-0001a5c0: 6720 7468 6520 6361 7461 6c6f 6773 2c20  g the catalogs, 
-0001a5d0: 7468 6973 2066 756e 6374 696f 6e20 6170  this function ap
-0001a5e0: 706c 6965 7320 6f66 6673 6574 7320 746f  plies offsets to
-0001a5f0: 2063 6f76 6572 740a 2020 2020 6d61 676e   covert.    magn
-0001a600: 6974 7564 6573 2074 6f20 7468 6520 4142  itudes to the AB
-0001a610: 2073 7973 7465 6d2c 2066 6f6c 6c6f 7769   system, followi
-0001a620: 6e67 2074 6865 2069 6e73 7472 7563 7469  ng the instructi
-0001a630: 6f6e 2069 733a 0a20 2020 200a 2020 2020  on is:.    .    
-0001a640: 6874 7470 733a 2f2f 6c69 7665 2d73 6473  https://live-sds
-0001a650: 7334 6f72 672d 6472 3132 2e70 616e 7468  s4org-dr12.panth
-0001a660: 656f 6e73 6974 652e 696f 2f61 6c67 6f72  eonsite.io/algor
-0001a670: 6974 686d 732f 666c 7578 6361 6c2f 2353  ithms/fluxcal/#S
-0001a680: 4453 5374 6f41 420a 0a20 2020 2062 6173  DSStoAB..    bas
-0001a690: 6963 616c 6c79 3a20 7541 4220 3d20 7553  ically: uAB = uS
-0001a6a0: 4453 5320 2d20 302e 3034 0a20 2020 2020  DSS - 0.04.     
-0001a6b0: 2020 2020 2020 2020 2020 7a41 4220 3d20            zAB = 
-0001a6c0: 7a53 4453 5320 2b20 302e 3032 0a0a 2020  zSDSS + 0.02..  
-0001a6d0: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-0001a6e0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-0001a6f0: 696d 6167 6520 3a20 7374 720a 2020 2020  image : str.    
-0001a700: 2020 2020 4c6f 6361 7469 6f6e 206f 6620      Location of 
-0001a710: 7468 6520 7370 6c75 7320 696d 6167 6520  the splus image 
-0001a720: 286d 7573 7420 6265 202e 667a 290a 2020  (must be .fz).  
-0001a730: 2020 7361 7665 5f66 696c 6520 3a20 7374    save_file : st
-0001a740: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
-0001a750: 6f6e 2074 6f20 7361 7665 2074 6865 2072  on to save the r
-0001a760: 6574 7269 6576 6564 2063 6174 616c 6f67  etrieved catalog
-0001a770: 2028 6d75 7374 2062 6520 2e66 6974 7329   (must be .fits)
-0001a780: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
-0001a790: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 5361    -------.    Sa
-0001a7a0: 7665 7320 6361 7461 6c6f 6720 696e 2074  ves catalog in t
-0001a7b0: 6865 2064 6573 6972 6564 206c 6f63 6174  he desired locat
-0001a7c0: 696f 6e0a 2020 2020 2222 220a 0a20 2020  ion.    """..   
-0001a7d0: 2023 2056 697a 6965 7220 5461 626c 650a   # Vizier Table.
-0001a7e0: 2020 2020 6361 745f 6964 203d 2022 4a2f      cat_id = "J/
-0001a7f0: 414a 2f31 3334 2f39 3733 2f73 7464 6361  AJ/134/973/stdca
-0001a800: 7422 0a0a 2020 2020 636f 6c75 6d6e 7320  t"..    columns 
-0001a810: 3d20 5b27 5241 4a32 3030 3027 2c20 2744  = ['RAJ2000', 'D
-0001a820: 454a 3230 3030 272c 2027 756d 6167 272c  EJ2000', 'umag',
-0001a830: 2027 655f 756d 6167 272c 2027 676d 6167   'e_umag', 'gmag
-0001a840: 272c 2027 655f 676d 6167 272c 0a20 2020  ', 'e_gmag',.   
-0001a850: 2020 2020 2020 2020 2020 2020 2772 6d61              'rma
-0001a860: 6727 2c20 2765 5f72 6d61 6727 2c20 2769  g', 'e_rmag', 'i
-0001a870: 6d61 6727 2c20 2765 5f69 6d61 6727 2c20  mag', 'e_imag', 
-0001a880: 277a 6d61 6727 2c20 2765 5f7a 6d61 6727  'zmag', 'e_zmag'
-0001a890: 5d0a 0a20 2020 2023 2044 6f77 6e6c 6f61  ]..    # Downloa
-0001a8a0: 6420 6361 7461 6c6f 670a 2020 2020 6361  d catalog.    ca
-0001a8b0: 7461 6c6f 6720 3d20 646f 776e 6c6f 6164  talog = download
-0001a8c0: 5f76 697a 6965 725f 6361 7461 6c6f 675f  _vizier_catalog_
-0001a8d0: 666f 725f 7370 6c75 735f 6669 656c 6428  for_splus_field(
-0001a8e0: 7370 6c75 735f 696d 6167 6520 3d20 696d  splus_image = im
-0001a8f0: 6167 652c 0a20 2020 2020 2020 2020 2020  age,.           
-0001a900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019fe0: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
+00019ff0: 6d6e 7320 3d20 636f 6c75 6d6e 7329 0a0a  mns = columns)..
+0001a000: 2020 2020 2320 5265 6e61 6d65 2063 6f6c      # Rename col
+0001a010: 756d 6e73 0a20 2020 2063 6174 616c 6f67  umns.    catalog
+0001a020: 2e63 6f6c 756d 6e73 5b27 5241 4a32 3030  .columns['RAJ200
+0001a030: 3027 5d2e 6e61 6d65 203d 2027 4956 455a  0'].name = 'IVEZ
+0001a040: 4943 5f52 414a 3230 3030 270a 2020 2020  IC_RAJ2000'.    
+0001a050: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
+0001a060: 2744 454a 3230 3030 275d 2e6e 616d 6520  'DEJ2000'].name 
+0001a070: 3d20 2749 5645 5a49 435f 4445 4a32 3030  = 'IVEZIC_DEJ200
+0001a080: 3027 0a0a 2020 2020 6361 7461 6c6f 672e  0'..    catalog.
+0001a090: 636f 6c75 6d6e 735b 2775 6d61 6727 5d2e  columns['umag'].
+0001a0a0: 6e61 6d65 203d 2027 5344 5353 5f55 270a  name = 'SDSS_U'.
+0001a0b0: 2020 2020 6361 7461 6c6f 672e 636f 6c75      catalog.colu
+0001a0c0: 6d6e 735b 2765 5f75 6d61 6727 5d2e 6e61  mns['e_umag'].na
+0001a0d0: 6d65 203d 2027 5344 5353 5f55 5f65 7272  me = 'SDSS_U_err
+0001a0e0: 270a 2020 2020 6361 7461 6c6f 672e 636f  '.    catalog.co
+0001a0f0: 6c75 6d6e 735b 2767 6d61 6727 5d2e 6e61  lumns['gmag'].na
+0001a100: 6d65 203d 2027 5344 5353 5f47 270a 2020  me = 'SDSS_G'.  
+0001a110: 2020 6361 7461 6c6f 672e 636f 6c75 6d6e    catalog.column
+0001a120: 735b 2765 5f67 6d61 6727 5d2e 6e61 6d65  s['e_gmag'].name
+0001a130: 203d 2027 5344 5353 5f47 5f65 7272 270a   = 'SDSS_G_err'.
+0001a140: 2020 2020 6361 7461 6c6f 672e 636f 6c75      catalog.colu
+0001a150: 6d6e 735b 2772 6d61 6727 5d2e 6e61 6d65  mns['rmag'].name
+0001a160: 203d 2027 5344 5353 5f52 270a 2020 2020   = 'SDSS_R'.    
+0001a170: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
+0001a180: 2765 5f72 6d61 6727 5d2e 6e61 6d65 203d  'e_rmag'].name =
+0001a190: 2027 5344 5353 5f52 5f65 7272 270a 2020   'SDSS_R_err'.  
+0001a1a0: 2020 6361 7461 6c6f 672e 636f 6c75 6d6e    catalog.column
+0001a1b0: 735b 2769 6d61 6727 5d2e 6e61 6d65 203d  s['imag'].name =
+0001a1c0: 2027 5344 5353 5f49 270a 2020 2020 6361   'SDSS_I'.    ca
+0001a1d0: 7461 6c6f 672e 636f 6c75 6d6e 735b 2765  talog.columns['e
+0001a1e0: 5f69 6d61 6727 5d2e 6e61 6d65 203d 2027  _imag'].name = '
+0001a1f0: 5344 5353 5f49 5f65 7272 270a 2020 2020  SDSS_I_err'.    
+0001a200: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
+0001a210: 277a 6d61 6727 5d2e 6e61 6d65 203d 2027  'zmag'].name = '
+0001a220: 5344 5353 5f5a 270a 2020 2020 6361 7461  SDSS_Z'.    cata
+0001a230: 6c6f 672e 636f 6c75 6d6e 735b 2765 5f7a  log.columns['e_z
+0001a240: 6d61 6727 5d2e 6e61 6d65 203d 2027 5344  mag'].name = 'SD
+0001a250: 5353 5f5a 5f65 7272 270a 0a20 2020 2023  SS_Z_err'..    #
+0001a260: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001a270: 2323 0a20 2020 2023 2052 656d 6f76 6520  ##.    # Remove 
+0001a280: 6e61 6e20 7661 6c75 6573 0a20 2020 204e  nan values.    N
+0001a290: 726f 7773 203d 206e 702e 6172 7261 7928  rows = np.array(
+0001a2a0: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
+0001a2b0: 2749 5645 5a49 435f 5241 4a32 3030 3027  'IVEZIC_RAJ2000'
+0001a2c0: 5d29 2e73 6861 7065 5b30 5d0a 2020 2020  ]).shape[0].    
+0001a2d0: 6620 3d20 6e70 2e66 756c 6c28 4e72 6f77  f = np.full(Nrow
+0001a2e0: 732c 2054 7275 6529 0a0a 2020 2020 666f  s, True)..    fo
+0001a2f0: 7220 6d61 6720 696e 205b 2755 272c 2027  r mag in ['U', '
+0001a300: 4727 2c20 2752 272c 2027 4927 2c20 275a  G', 'R', 'I', 'Z
+0001a310: 275d 3a0a 2020 2020 2020 2020 6620 3d20  ']:.        f = 
+0001a320: 6620 2620 286e 702e 6172 7261 7928 6361  f & (np.array(ca
+0001a330: 7461 6c6f 672e 636f 6c75 6d6e 735b 6627  talog.columns[f'
+0001a340: 5344 5353 5f7b 6d61 677d 275d 2920 3c20  SDSS_{mag}']) < 
+0001a350: 3930 290a 0a20 2020 2063 6174 616c 6f67  90)..    catalog
+0001a360: 203d 2063 6174 616c 6f67 5b66 5d0a 0a20   = catalog[f].. 
+0001a370: 2020 2023 2054 7275 6e63 6174 6520 6465     # Truncate de
+0001a380: 7363 7269 7074 696f 6e20 2875 7375 616c  scription (usual
+0001a390: 6c79 2074 6f20 6269 6720 746f 2073 6176  ly to big to sav
+0001a3a0: 6520 6173 2066 6974 7329 0a20 2020 2063  e as fits).    c
+0001a3b0: 6174 616c 6f67 2e6d 6574 615b 2764 6573  atalog.meta['des
+0001a3c0: 6372 6970 7469 6f6e 275d 203d 2063 6174  cription'] = cat
+0001a3d0: 616c 6f67 2e6d 6574 615b 2764 6573 6372  alog.meta['descr
+0001a3e0: 6970 7469 6f6e 275d 5b3a 3535 5d0a 0a20  iption'][:55].. 
+0001a3f0: 2020 2023 2053 6176 6520 7461 626c 6520     # Save table 
+0001a400: 6173 2066 6974 730a 2020 2020 6361 7461  as fits.    cata
+0001a410: 6c6f 672e 7772 6974 6528 7361 7665 5f66  log.write(save_f
+0001a420: 696c 652c 206f 7665 7277 7269 7465 203d  ile, overwrite =
+0001a430: 2054 7275 6529 0a0a 0a64 6566 2064 6f77   True)...def dow
+0001a440: 6e6c 6f61 645f 6976 657a 6963 4142 2873  nload_ivezicAB(s
+0001a450: 6176 655f 6669 6c65 2c20 696d 6167 6520  ave_file, image 
+0001a460: 3d20 4e6f 6e65 2c20 6669 656c 6449 445f  = None, fieldID_
+0001a470: 6361 7461 6c6f 6720 3d20 4e6f 6e65 293a  catalog = None):
+0001a480: 0a20 2020 2022 2222 0a20 2020 2044 6f77  .    """.    Dow
+0001a490: 6e6c 6f61 6473 2074 6865 2049 7665 7a69  nloads the Ivezi
+0001a4a0: 6320 6361 7461 6c6f 6720 6672 6f6d 2074  c catalog from t
+0001a4b0: 6865 2076 697a 6965 7220 6461 7461 6261  he vizier databa
+0001a4c0: 7365 2069 6e20 7468 6520 7265 6769 6f6e  se in the region
+0001a4d0: 0a20 2020 2063 6f76 6572 6564 2062 7920  .    covered by 
+0001a4e0: 616e 2073 706c 7573 2069 6d61 6765 2e20  an splus image. 
+0001a4f0: 4368 616e 6765 7320 636f 6c75 6d6e 206e  Changes column n
+0001a500: 616d 6573 2066 6f72 2074 6865 2066 6f72  ames for the for
+0001a510: 6d61 7420 7573 6564 2062 7920 7468 650a  mat used by the.
+0001a520: 2020 2020 7069 7065 6c69 6e65 2c20 6465      pipeline, de
+0001a530: 6c65 7465 7320 756e 6e65 6365 7373 6172  letes unnecessar
+0001a540: 7920 636f 6c75 6d6e 7320 616e 6420 7361  y columns and sa
+0001a550: 7665 7320 7265 7375 6c74 7320 746f 2061  ves results to a
+0001a560: 2066 6974 7320 6669 6c65 0a20 2020 200a   fits file.    .
+0001a570: 2020 2020 4166 7465 7220 646f 776e 6c6f      After downlo
+0001a580: 6164 696e 6720 7468 6520 6361 7461 6c6f  ading the catalo
+0001a590: 6773 2c20 7468 6973 2066 756e 6374 696f  gs, this functio
+0001a5a0: 6e20 6170 706c 6965 7320 6f66 6673 6574  n applies offset
+0001a5b0: 7320 746f 2063 6f76 6572 740a 2020 2020  s to covert.    
+0001a5c0: 6d61 676e 6974 7564 6573 2074 6f20 7468  magnitudes to th
+0001a5d0: 6520 4142 2073 7973 7465 6d2c 2066 6f6c  e AB system, fol
+0001a5e0: 6c6f 7769 6e67 2074 6865 2069 6e73 7472  lowing the instr
+0001a5f0: 7563 7469 6f6e 2069 733a 0a20 2020 200a  uction is:.    .
+0001a600: 2020 2020 6874 7470 733a 2f2f 6c69 7665      https://live
+0001a610: 2d73 6473 7334 6f72 672d 6472 3132 2e70  -sdss4org-dr12.p
+0001a620: 616e 7468 656f 6e73 6974 652e 696f 2f61  antheonsite.io/a
+0001a630: 6c67 6f72 6974 686d 732f 666c 7578 6361  lgorithms/fluxca
+0001a640: 6c2f 2353 4453 5374 6f41 420a 0a20 2020  l/#SDSStoAB..   
+0001a650: 2062 6173 6963 616c 6c79 3a20 7541 4220   basically: uAB 
+0001a660: 3d20 7553 4453 5320 2d20 302e 3034 0a20  = uSDSS - 0.04. 
+0001a670: 2020 2020 2020 2020 2020 2020 2020 7a41                zA
+0001a680: 4220 3d20 7a53 4453 5320 2b20 302e 3032  B = zSDSS + 0.02
+0001a690: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+0001a6a0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+0001a6b0: 2020 2020 696d 6167 6520 3a20 7374 720a      image : str.
+0001a6c0: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
+0001a6d0: 206f 6620 7468 6520 7370 6c75 7320 696d   of the splus im
+0001a6e0: 6167 6520 286d 7573 7420 6265 202e 667a  age (must be .fz
+0001a6f0: 290a 2020 2020 7361 7665 5f66 696c 6520  ).    save_file 
+0001a700: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
+0001a710: 6361 7469 6f6e 2074 6f20 7361 7665 2074  cation to save t
+0001a720: 6865 2072 6574 7269 6576 6564 2063 6174  he retrieved cat
+0001a730: 616c 6f67 2028 6d75 7374 2062 6520 2e66  alog (must be .f
+0001a740: 6974 7329 0a0a 2020 2020 5265 7475 726e  its)..    Return
+0001a750: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
+0001a760: 2020 5361 7665 7320 6361 7461 6c6f 6720    Saves catalog 
+0001a770: 696e 2074 6865 2064 6573 6972 6564 206c  in the desired l
+0001a780: 6f63 6174 696f 6e0a 2020 2020 2222 220a  ocation.    """.
+0001a790: 0a20 2020 2023 2056 697a 6965 7220 5461  .    # Vizier Ta
+0001a7a0: 626c 650a 2020 2020 6361 745f 6964 203d  ble.    cat_id =
+0001a7b0: 2022 4a2f 414a 2f31 3334 2f39 3733 2f73   "J/AJ/134/973/s
+0001a7c0: 7464 6361 7422 0a0a 2020 2020 636f 6c75  tdcat"..    colu
+0001a7d0: 6d6e 7320 3d20 5b27 5241 4a32 3030 3027  mns = ['RAJ2000'
+0001a7e0: 2c20 2744 454a 3230 3030 272c 2027 756d  , 'DEJ2000', 'um
+0001a7f0: 6167 272c 2027 655f 756d 6167 272c 2027  ag', 'e_umag', '
+0001a800: 676d 6167 272c 2027 655f 676d 6167 272c  gmag', 'e_gmag',
+0001a810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a820: 2772 6d61 6727 2c20 2765 5f72 6d61 6727  'rmag', 'e_rmag'
+0001a830: 2c20 2769 6d61 6727 2c20 2765 5f69 6d61  , 'imag', 'e_ima
+0001a840: 6727 2c20 277a 6d61 6727 2c20 2765 5f7a  g', 'zmag', 'e_z
+0001a850: 6d61 6727 5d0a 0a20 2020 2023 2044 6f77  mag']..    # Dow
+0001a860: 6e6c 6f61 6420 6361 7461 6c6f 670a 2020  nload catalog.  
+0001a870: 2020 6361 7461 6c6f 6720 3d20 646f 776e    catalog = down
+0001a880: 6c6f 6164 5f76 697a 6965 725f 6361 7461  load_vizier_cata
+0001a890: 6c6f 675f 666f 725f 7370 6c75 735f 6669  log_for_splus_fi
+0001a8a0: 656c 6428 7370 6c75 735f 696d 6167 6520  eld(splus_image 
+0001a8b0: 3d20 696d 6167 652c 0a20 2020 2020 2020  = image,.       
+0001a8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a8e0: 2020 2020 2020 2020 6669 656c 6449 445f          fieldID_
+0001a8f0: 6361 7461 6c6f 673d 6669 656c 6449 445f  catalog=fieldID_
+0001a900: 6361 7461 6c6f 672c 0a20 2020 2020 2020  catalog,.       
 0001a910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a920: 2020 2020 6669 656c 6449 445f 6361 7461      fieldID_cata
-0001a930: 6c6f 673d 6669 656c 6449 445f 6361 7461  log=fieldID_cata
-0001a940: 6c6f 672c 0a20 2020 2020 2020 2020 2020  log,.           
-0001a950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a930: 2020 2020 2020 2020 7669 7a69 6572 5f63          vizier_c
+0001a940: 6174 616c 6f67 5f69 6420 3d20 6361 745f  atalog_id = cat_
+0001a950: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
 0001a960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a970: 2020 2020 7669 7a69 6572 5f63 6174 616c      vizier_catal
-0001a980: 6f67 5f69 6420 3d20 6361 745f 6964 2c0a  og_id = cat_id,.
-0001a990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a9b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001a9c0: 6f6c 756d 6e73 203d 2063 6f6c 756d 6e73  olumns = columns
-0001a9d0: 290a 0a20 2020 2023 2052 656e 616d 6520  )..    # Rename 
-0001a9e0: 636f 6c75 6d6e 730a 2020 2020 6361 7461  columns.    cata
-0001a9f0: 6c6f 672e 636f 6c75 6d6e 735b 2752 414a  log.columns['RAJ
-0001aa00: 3230 3030 275d 2e6e 616d 6520 3d20 2749  2000'].name = 'I
-0001aa10: 5645 5a49 4341 425f 5241 4a32 3030 3027  VEZICAB_RAJ2000'
-0001aa20: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
-0001aa30: 756d 6e73 5b27 4445 4a32 3030 3027 5d2e  umns['DEJ2000'].
-0001aa40: 6e61 6d65 203d 2027 4956 455a 4943 4142  name = 'IVEZICAB
-0001aa50: 5f44 454a 3230 3030 270a 0a20 2020 2063  _DEJ2000'..    c
-0001aa60: 6174 616c 6f67 2e63 6f6c 756d 6e73 5b27  atalog.columns['
-0001aa70: 756d 6167 275d 2e6e 616d 6520 3d20 2753  umag'].name = 'S
-0001aa80: 4453 535f 5527 0a20 2020 2063 6174 616c  DSS_U'.    catal
-0001aa90: 6f67 2e63 6f6c 756d 6e73 5b27 655f 756d  og.columns['e_um
-0001aaa0: 6167 275d 2e6e 616d 6520 3d20 2753 4453  ag'].name = 'SDS
-0001aab0: 535f 555f 6572 7227 0a20 2020 2063 6174  S_U_err'.    cat
-0001aac0: 616c 6f67 2e63 6f6c 756d 6e73 5b27 676d  alog.columns['gm
-0001aad0: 6167 275d 2e6e 616d 6520 3d20 2753 4453  ag'].name = 'SDS
-0001aae0: 535f 4727 0a20 2020 2063 6174 616c 6f67  S_G'.    catalog
-0001aaf0: 2e63 6f6c 756d 6e73 5b27 655f 676d 6167  .columns['e_gmag
-0001ab00: 275d 2e6e 616d 6520 3d20 2753 4453 535f  '].name = 'SDSS_
-0001ab10: 475f 6572 7227 0a20 2020 2063 6174 616c  G_err'.    catal
-0001ab20: 6f67 2e63 6f6c 756d 6e73 5b27 726d 6167  og.columns['rmag
-0001ab30: 275d 2e6e 616d 6520 3d20 2753 4453 535f  '].name = 'SDSS_
-0001ab40: 5227 0a20 2020 2063 6174 616c 6f67 2e63  R'.    catalog.c
-0001ab50: 6f6c 756d 6e73 5b27 655f 726d 6167 275d  olumns['e_rmag']
-0001ab60: 2e6e 616d 6520 3d20 2753 4453 535f 525f  .name = 'SDSS_R_
-0001ab70: 6572 7227 0a20 2020 2063 6174 616c 6f67  err'.    catalog
-0001ab80: 2e63 6f6c 756d 6e73 5b27 696d 6167 275d  .columns['imag']
-0001ab90: 2e6e 616d 6520 3d20 2753 4453 535f 4927  .name = 'SDSS_I'
-0001aba0: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
-0001abb0: 756d 6e73 5b27 655f 696d 6167 275d 2e6e  umns['e_imag'].n
-0001abc0: 616d 6520 3d20 2753 4453 535f 495f 6572  ame = 'SDSS_I_er
-0001abd0: 7227 0a20 2020 2063 6174 616c 6f67 2e63  r'.    catalog.c
-0001abe0: 6f6c 756d 6e73 5b27 7a6d 6167 275d 2e6e  olumns['zmag'].n
-0001abf0: 616d 6520 3d20 2753 4453 535f 5a27 0a20  ame = 'SDSS_Z'. 
-0001ac00: 2020 2063 6174 616c 6f67 2e63 6f6c 756d     catalog.colum
-0001ac10: 6e73 5b27 655f 7a6d 6167 275d 2e6e 616d  ns['e_zmag'].nam
-0001ac20: 6520 3d20 2753 4453 535f 5a5f 6572 7227  e = 'SDSS_Z_err'
-0001ac30: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
-0001ac40: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
-0001ac50: 5265 6d6f 7665 206e 616e 2076 616c 7565  Remove nan value
-0001ac60: 730a 2020 2020 4e72 6f77 7320 3d20 6e70  s.    Nrows = np
-0001ac70: 2e61 7272 6179 2863 6174 616c 6f67 2e63  .array(catalog.c
-0001ac80: 6f6c 756d 6e73 5b27 4956 455a 4943 4142  olumns['IVEZICAB
-0001ac90: 5f52 414a 3230 3030 275d 292e 7368 6170  _RAJ2000']).shap
-0001aca0: 655b 305d 0a20 2020 2066 203d 206e 702e  e[0].    f = np.
-0001acb0: 6675 6c6c 284e 726f 7773 2c20 5472 7565  full(Nrows, True
-0001acc0: 290a 0a20 2020 2066 6f72 206d 6167 2069  )..    for mag i
-0001acd0: 6e20 5b27 5527 2c20 2747 272c 2027 5227  n ['U', 'G', 'R'
-0001ace0: 2c20 2749 272c 2027 5a27 5d3a 0a20 2020  , 'I', 'Z']:.   
-0001acf0: 2020 2020 2066 203d 2066 2026 2028 6e70       f = f & (np
-0001ad00: 2e61 7272 6179 2863 6174 616c 6f67 2e63  .array(catalog.c
-0001ad10: 6f6c 756d 6e73 5b66 2753 4453 535f 7b6d  olumns[f'SDSS_{m
-0001ad20: 6167 7d27 5d29 203c 2039 3029 0a0a 2020  ag}']) < 90)..  
-0001ad30: 2020 6361 7461 6c6f 6720 3d20 6361 7461    catalog = cata
-0001ad40: 6c6f 675b 665d 0a20 2020 200a 2020 2020  log[f].    .    
-0001ad50: 2320 4170 706c 7920 4142 206d 6167 6e69  # Apply AB magni
-0001ad60: 7475 6465 206f 6666 7365 7473 0a20 2020  tude offsets.   
-0001ad70: 2063 6174 616c 6f67 5b27 5344 5353 5f55   catalog['SDSS_U
-0001ad80: 275d 203d 2063 6174 616c 6f67 5b27 5344  '] = catalog['SD
-0001ad90: 5353 5f55 275d 202d 2030 2e30 340a 2020  SS_U'] - 0.04.  
-0001ada0: 2020 6361 7461 6c6f 675b 2753 4453 535f    catalog['SDSS_
-0001adb0: 5a27 5d20 3d20 6361 7461 6c6f 675b 2753  Z'] = catalog['S
-0001adc0: 4453 535f 5a27 5d20 2b20 302e 3032 0a0a  DSS_Z'] + 0.02..
-0001add0: 2020 2020 2320 5472 756e 6361 7465 2064      # Truncate d
-0001ade0: 6573 6372 6970 7469 6f6e 2028 7573 7561  escription (usua
-0001adf0: 6c6c 7920 746f 2062 6967 2074 6f20 7361  lly to big to sa
-0001ae00: 7665 2061 7320 6669 7473 290a 2020 2020  ve as fits).    
-0001ae10: 6361 7461 6c6f 672e 6d65 7461 5b27 6465  catalog.meta['de
-0001ae20: 7363 7269 7074 696f 6e27 5d20 3d20 6361  scription'] = ca
-0001ae30: 7461 6c6f 672e 6d65 7461 5b27 6465 7363  talog.meta['desc
-0001ae40: 7269 7074 696f 6e27 5d5b 3a35 355d 0a0a  ription'][:55]..
-0001ae50: 2020 2020 2320 5361 7665 2074 6162 6c65      # Save table
-0001ae60: 2061 7320 6669 7473 0a20 2020 2063 6174   as fits.    cat
-0001ae70: 616c 6f67 2e77 7269 7465 2873 6176 655f  alog.write(save_
-0001ae80: 6669 6c65 2c20 6f76 6572 7772 6974 6520  file, overwrite 
-0001ae90: 3d20 5472 7565 290a 0a0a 6465 6620 646f  = True)...def do
-0001aea0: 776e 6c6f 6164 5f69 7665 7a69 6341 4232  wnload_ivezicAB2
-0001aeb0: 2873 6176 655f 6669 6c65 2c20 696d 6167  (save_file, imag
-0001aec0: 6520 3d20 4e6f 6e65 2c20 6669 656c 6449  e = None, fieldI
-0001aed0: 445f 6361 7461 6c6f 6720 3d20 4e6f 6e65  D_catalog = None
-0001aee0: 293a 0a20 2020 2022 2222 0a20 2020 2044  ):.    """.    D
-0001aef0: 6f77 6e6c 6f61 6473 2074 6865 2049 7665  ownloads the Ive
-0001af00: 7a69 6320 6361 7461 6c6f 6720 6672 6f6d  zic catalog from
-0001af10: 2074 6865 2076 697a 6965 7220 6461 7461   the vizier data
-0001af20: 6261 7365 2069 6e20 7468 6520 7265 6769  base in the regi
-0001af30: 6f6e 0a20 2020 2063 6f76 6572 6564 2062  on.    covered b
-0001af40: 7920 616e 2073 706c 7573 2069 6d61 6765  y an splus image
-0001af50: 2e20 4368 616e 6765 7320 636f 6c75 6d6e  . Changes column
-0001af60: 206e 616d 6573 2066 6f72 2074 6865 2066   names for the f
-0001af70: 6f72 6d61 7420 7573 6564 2062 7920 7468  ormat used by th
-0001af80: 650a 2020 2020 7069 7065 6c69 6e65 2c20  e.    pipeline, 
-0001af90: 6465 6c65 7465 7320 756e 6e65 6365 7373  deletes unnecess
-0001afa0: 6172 7920 636f 6c75 6d6e 7320 616e 6420  ary columns and 
-0001afb0: 7361 7665 7320 7265 7375 6c74 7320 746f  saves results to
-0001afc0: 2061 2066 6974 7320 6669 6c65 0a20 2020   a fits file.   
-0001afd0: 200a 2020 2020 4166 7465 7220 646f 776e   .    After down
-0001afe0: 6c6f 6164 696e 6720 7468 6520 6361 7461  loading the cata
-0001aff0: 6c6f 6773 2c20 7468 6973 2066 756e 6374  logs, this funct
-0001b000: 696f 6e20 6170 706c 6965 7320 6f66 6673  ion applies offs
-0001b010: 6574 7320 746f 2063 6f76 6572 740a 2020  ets to covert.  
-0001b020: 2020 6d61 676e 6974 7564 6573 2074 6f20    magnitudes to 
-0001b030: 7468 6520 4142 2073 7973 7465 6d2c 206f  the AB system, o
-0001b040: 6e6c 7920 746f 2074 6865 2075 2d62 616e  nly to the u-ban
-0001b050: 642c 2066 6f6c 6c6f 7769 6e67 2074 6865  d, following the
-0001b060: 2069 6e73 7472 7563 7469 6f6e 2069 733a   instruction is:
-0001b070: 0a20 2020 200a 2020 2020 6874 7470 733a  .    .    https:
-0001b080: 2f2f 6c69 7665 2d73 6473 7334 6f72 672d  //live-sdss4org-
-0001b090: 6472 3132 2e70 616e 7468 656f 6e73 6974  dr12.pantheonsit
-0001b0a0: 652e 696f 2f61 6c67 6f72 6974 686d 732f  e.io/algorithms/
-0001b0b0: 666c 7578 6361 6c2f 2353 4453 5374 6f41  fluxcal/#SDSStoA
-0001b0c0: 420a 0a20 2020 2062 6173 6963 616c 6c79  B..    basically
-0001b0d0: 3a20 7541 4220 3d20 7553 4453 5320 2d20  : uAB = uSDSS - 
-0001b0e0: 302e 3034 0a0a 2020 2020 5061 7261 6d65  0.04..    Parame
-0001b0f0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-0001b100: 2d2d 2d0a 2020 2020 696d 6167 6520 3a20  ---.    image : 
-0001b110: 7374 720a 2020 2020 2020 2020 4c6f 6361  str.        Loca
-0001b120: 7469 6f6e 206f 6620 7468 6520 7370 6c75  tion of the splu
-0001b130: 7320 696d 6167 6520 286d 7573 7420 6265  s image (must be
-0001b140: 202e 667a 290a 2020 2020 7361 7665 5f66   .fz).    save_f
-0001b150: 696c 6520 3a20 7374 720a 2020 2020 2020  ile : str.      
-0001b160: 2020 4c6f 6361 7469 6f6e 2074 6f20 7361    Location to sa
-0001b170: 7665 2074 6865 2072 6574 7269 6576 6564  ve the retrieved
-0001b180: 2063 6174 616c 6f67 2028 6d75 7374 2062   catalog (must b
-0001b190: 6520 2e66 6974 7329 0a0a 2020 2020 5265  e .fits)..    Re
-0001b1a0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-0001b1b0: 2d0a 2020 2020 5361 7665 7320 6361 7461  -.    Saves cata
-0001b1c0: 6c6f 6720 696e 2074 6865 2064 6573 6972  log in the desir
-0001b1d0: 6564 206c 6f63 6174 696f 6e0a 2020 2020  ed location.    
-0001b1e0: 2222 220a 0a20 2020 2023 2056 697a 6965  """..    # Vizie
-0001b1f0: 7220 5461 626c 650a 2020 2020 6361 745f  r Table.    cat_
-0001b200: 6964 203d 2022 4a2f 414a 2f31 3334 2f39  id = "J/AJ/134/9
-0001b210: 3733 2f73 7464 6361 7422 0a0a 2020 2020  73/stdcat"..    
-0001b220: 636f 6c75 6d6e 7320 3d20 5b27 5241 4a32  columns = ['RAJ2
-0001b230: 3030 3027 2c20 2744 454a 3230 3030 272c  000', 'DEJ2000',
-0001b240: 2027 756d 6167 272c 2027 655f 756d 6167   'umag', 'e_umag
-0001b250: 272c 2027 676d 6167 272c 2027 655f 676d  ', 'gmag', 'e_gm
-0001b260: 6167 272c 0a20 2020 2020 2020 2020 2020  ag',.           
-0001b270: 2020 2020 2772 6d61 6727 2c20 2765 5f72      'rmag', 'e_r
-0001b280: 6d61 6727 2c20 2769 6d61 6727 2c20 2765  mag', 'imag', 'e
-0001b290: 5f69 6d61 6727 2c20 277a 6d61 6727 2c20  _imag', 'zmag', 
-0001b2a0: 2765 5f7a 6d61 6727 5d0a 0a20 2020 2023  'e_zmag']..    #
-0001b2b0: 2044 6f77 6e6c 6f61 6420 6361 7461 6c6f   Download catalo
-0001b2c0: 670a 2020 2020 6361 7461 6c6f 6720 3d20  g.    catalog = 
-0001b2d0: 646f 776e 6c6f 6164 5f76 697a 6965 725f  download_vizier_
-0001b2e0: 6361 7461 6c6f 675f 666f 725f 7370 6c75  catalog_for_splu
-0001b2f0: 735f 6669 656c 6428 7370 6c75 735f 696d  s_field(splus_im
-0001b300: 6167 6520 3d20 696d 6167 652c 0a20 2020  age = image,.   
-0001b310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b330: 2020 2020 2020 2020 2020 2020 6669 656c              fiel
-0001b340: 6449 445f 6361 7461 6c6f 673d 6669 656c  dID_catalog=fiel
-0001b350: 6449 445f 6361 7461 6c6f 672c 0a20 2020  dID_catalog,.   
-0001b360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a980: 2020 2063 6f6c 756d 6e73 203d 2063 6f6c     columns = col
+0001a990: 756d 6e73 290a 0a20 2020 2023 2052 656e  umns)..    # Ren
+0001a9a0: 616d 6520 636f 6c75 6d6e 730a 2020 2020  ame columns.    
+0001a9b0: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
+0001a9c0: 2752 414a 3230 3030 275d 2e6e 616d 6520  'RAJ2000'].name 
+0001a9d0: 3d20 2749 5645 5a49 4341 425f 5241 4a32  = 'IVEZICAB_RAJ2
+0001a9e0: 3030 3027 0a20 2020 2063 6174 616c 6f67  000'.    catalog
+0001a9f0: 2e63 6f6c 756d 6e73 5b27 4445 4a32 3030  .columns['DEJ200
+0001aa00: 3027 5d2e 6e61 6d65 203d 2027 4956 455a  0'].name = 'IVEZ
+0001aa10: 4943 4142 5f44 454a 3230 3030 270a 0a20  ICAB_DEJ2000'.. 
+0001aa20: 2020 2063 6174 616c 6f67 2e63 6f6c 756d     catalog.colum
+0001aa30: 6e73 5b27 756d 6167 275d 2e6e 616d 6520  ns['umag'].name 
+0001aa40: 3d20 2753 4453 535f 5527 0a20 2020 2063  = 'SDSS_U'.    c
+0001aa50: 6174 616c 6f67 2e63 6f6c 756d 6e73 5b27  atalog.columns['
+0001aa60: 655f 756d 6167 275d 2e6e 616d 6520 3d20  e_umag'].name = 
+0001aa70: 2753 4453 535f 555f 6572 7227 0a20 2020  'SDSS_U_err'.   
+0001aa80: 2063 6174 616c 6f67 2e63 6f6c 756d 6e73   catalog.columns
+0001aa90: 5b27 676d 6167 275d 2e6e 616d 6520 3d20  ['gmag'].name = 
+0001aaa0: 2753 4453 535f 4727 0a20 2020 2063 6174  'SDSS_G'.    cat
+0001aab0: 616c 6f67 2e63 6f6c 756d 6e73 5b27 655f  alog.columns['e_
+0001aac0: 676d 6167 275d 2e6e 616d 6520 3d20 2753  gmag'].name = 'S
+0001aad0: 4453 535f 475f 6572 7227 0a20 2020 2063  DSS_G_err'.    c
+0001aae0: 6174 616c 6f67 2e63 6f6c 756d 6e73 5b27  atalog.columns['
+0001aaf0: 726d 6167 275d 2e6e 616d 6520 3d20 2753  rmag'].name = 'S
+0001ab00: 4453 535f 5227 0a20 2020 2063 6174 616c  DSS_R'.    catal
+0001ab10: 6f67 2e63 6f6c 756d 6e73 5b27 655f 726d  og.columns['e_rm
+0001ab20: 6167 275d 2e6e 616d 6520 3d20 2753 4453  ag'].name = 'SDS
+0001ab30: 535f 525f 6572 7227 0a20 2020 2063 6174  S_R_err'.    cat
+0001ab40: 616c 6f67 2e63 6f6c 756d 6e73 5b27 696d  alog.columns['im
+0001ab50: 6167 275d 2e6e 616d 6520 3d20 2753 4453  ag'].name = 'SDS
+0001ab60: 535f 4927 0a20 2020 2063 6174 616c 6f67  S_I'.    catalog
+0001ab70: 2e63 6f6c 756d 6e73 5b27 655f 696d 6167  .columns['e_imag
+0001ab80: 275d 2e6e 616d 6520 3d20 2753 4453 535f  '].name = 'SDSS_
+0001ab90: 495f 6572 7227 0a20 2020 2063 6174 616c  I_err'.    catal
+0001aba0: 6f67 2e63 6f6c 756d 6e73 5b27 7a6d 6167  og.columns['zmag
+0001abb0: 275d 2e6e 616d 6520 3d20 2753 4453 535f  '].name = 'SDSS_
+0001abc0: 5a27 0a20 2020 2063 6174 616c 6f67 2e63  Z'.    catalog.c
+0001abd0: 6f6c 756d 6e73 5b27 655f 7a6d 6167 275d  olumns['e_zmag']
+0001abe0: 2e6e 616d 6520 3d20 2753 4453 535f 5a5f  .name = 'SDSS_Z_
+0001abf0: 6572 7227 0a0a 2020 2020 2323 2323 2323  err'..    ######
+0001ac00: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
+0001ac10: 2020 2320 5265 6d6f 7665 206e 616e 2076    # Remove nan v
+0001ac20: 616c 7565 730a 2020 2020 4e72 6f77 7320  alues.    Nrows 
+0001ac30: 3d20 6e70 2e61 7272 6179 2863 6174 616c  = np.array(catal
+0001ac40: 6f67 2e63 6f6c 756d 6e73 5b27 4956 455a  og.columns['IVEZ
+0001ac50: 4943 4142 5f52 414a 3230 3030 275d 292e  ICAB_RAJ2000']).
+0001ac60: 7368 6170 655b 305d 0a20 2020 2066 203d  shape[0].    f =
+0001ac70: 206e 702e 6675 6c6c 284e 726f 7773 2c20   np.full(Nrows, 
+0001ac80: 5472 7565 290a 0a20 2020 2066 6f72 206d  True)..    for m
+0001ac90: 6167 2069 6e20 5b27 5527 2c20 2747 272c  ag in ['U', 'G',
+0001aca0: 2027 5227 2c20 2749 272c 2027 5a27 5d3a   'R', 'I', 'Z']:
+0001acb0: 0a20 2020 2020 2020 2066 203d 2066 2026  .        f = f &
+0001acc0: 2028 6e70 2e61 7272 6179 2863 6174 616c   (np.array(catal
+0001acd0: 6f67 2e63 6f6c 756d 6e73 5b66 2753 4453  og.columns[f'SDS
+0001ace0: 535f 7b6d 6167 7d27 5d29 203c 2039 3029  S_{mag}']) < 90)
+0001acf0: 0a0a 2020 2020 6361 7461 6c6f 6720 3d20  ..    catalog = 
+0001ad00: 6361 7461 6c6f 675b 665d 0a20 2020 200a  catalog[f].    .
+0001ad10: 2020 2020 2320 4170 706c 7920 4142 206d      # Apply AB m
+0001ad20: 6167 6e69 7475 6465 206f 6666 7365 7473  agnitude offsets
+0001ad30: 0a20 2020 2063 6174 616c 6f67 5b27 5344  .    catalog['SD
+0001ad40: 5353 5f55 275d 203d 2063 6174 616c 6f67  SS_U'] = catalog
+0001ad50: 5b27 5344 5353 5f55 275d 202d 2030 2e30  ['SDSS_U'] - 0.0
+0001ad60: 340a 2020 2020 6361 7461 6c6f 675b 2753  4.    catalog['S
+0001ad70: 4453 535f 5a27 5d20 3d20 6361 7461 6c6f  DSS_Z'] = catalo
+0001ad80: 675b 2753 4453 535f 5a27 5d20 2b20 302e  g['SDSS_Z'] + 0.
+0001ad90: 3032 0a0a 2020 2020 2320 5472 756e 6361  02..    # Trunca
+0001ada0: 7465 2064 6573 6372 6970 7469 6f6e 2028  te description (
+0001adb0: 7573 7561 6c6c 7920 746f 2062 6967 2074  usually to big t
+0001adc0: 6f20 7361 7665 2061 7320 6669 7473 290a  o save as fits).
+0001add0: 2020 2020 6361 7461 6c6f 672e 6d65 7461      catalog.meta
+0001ade0: 5b27 6465 7363 7269 7074 696f 6e27 5d20  ['description'] 
+0001adf0: 3d20 6361 7461 6c6f 672e 6d65 7461 5b27  = catalog.meta['
+0001ae00: 6465 7363 7269 7074 696f 6e27 5d5b 3a35  description'][:5
+0001ae10: 355d 0a0a 2020 2020 2320 5361 7665 2074  5]..    # Save t
+0001ae20: 6162 6c65 2061 7320 6669 7473 0a20 2020  able as fits.   
+0001ae30: 2063 6174 616c 6f67 2e77 7269 7465 2873   catalog.write(s
+0001ae40: 6176 655f 6669 6c65 2c20 6f76 6572 7772  ave_file, overwr
+0001ae50: 6974 6520 3d20 5472 7565 290a 0a0a 6465  ite = True)...de
+0001ae60: 6620 646f 776e 6c6f 6164 5f69 7665 7a69  f download_ivezi
+0001ae70: 6341 4232 2873 6176 655f 6669 6c65 2c20  cAB2(save_file, 
+0001ae80: 696d 6167 6520 3d20 4e6f 6e65 2c20 6669  image = None, fi
+0001ae90: 656c 6449 445f 6361 7461 6c6f 6720 3d20  eldID_catalog = 
+0001aea0: 4e6f 6e65 293a 0a20 2020 2022 2222 0a20  None):.    """. 
+0001aeb0: 2020 2044 6f77 6e6c 6f61 6473 2074 6865     Downloads the
+0001aec0: 2049 7665 7a69 6320 6361 7461 6c6f 6720   Ivezic catalog 
+0001aed0: 6672 6f6d 2074 6865 2076 697a 6965 7220  from the vizier 
+0001aee0: 6461 7461 6261 7365 2069 6e20 7468 6520  database in the 
+0001aef0: 7265 6769 6f6e 0a20 2020 2063 6f76 6572  region.    cover
+0001af00: 6564 2062 7920 616e 2073 706c 7573 2069  ed by an splus i
+0001af10: 6d61 6765 2e20 4368 616e 6765 7320 636f  mage. Changes co
+0001af20: 6c75 6d6e 206e 616d 6573 2066 6f72 2074  lumn names for t
+0001af30: 6865 2066 6f72 6d61 7420 7573 6564 2062  he format used b
+0001af40: 7920 7468 650a 2020 2020 7069 7065 6c69  y the.    pipeli
+0001af50: 6e65 2c20 6465 6c65 7465 7320 756e 6e65  ne, deletes unne
+0001af60: 6365 7373 6172 7920 636f 6c75 6d6e 7320  cessary columns 
+0001af70: 616e 6420 7361 7665 7320 7265 7375 6c74  and saves result
+0001af80: 7320 746f 2061 2066 6974 7320 6669 6c65  s to a fits file
+0001af90: 0a20 2020 200a 2020 2020 4166 7465 7220  .    .    After 
+0001afa0: 646f 776e 6c6f 6164 696e 6720 7468 6520  downloading the 
+0001afb0: 6361 7461 6c6f 6773 2c20 7468 6973 2066  catalogs, this f
+0001afc0: 756e 6374 696f 6e20 6170 706c 6965 7320  unction applies 
+0001afd0: 6f66 6673 6574 7320 746f 2063 6f76 6572  offsets to cover
+0001afe0: 740a 2020 2020 6d61 676e 6974 7564 6573  t.    magnitudes
+0001aff0: 2074 6f20 7468 6520 4142 2073 7973 7465   to the AB syste
+0001b000: 6d2c 206f 6e6c 7920 746f 2074 6865 2075  m, only to the u
+0001b010: 2d62 616e 642c 2066 6f6c 6c6f 7769 6e67  -band, following
+0001b020: 2074 6865 2069 6e73 7472 7563 7469 6f6e   the instruction
+0001b030: 2069 733a 0a20 2020 200a 2020 2020 6874   is:.    .    ht
+0001b040: 7470 733a 2f2f 6c69 7665 2d73 6473 7334  tps://live-sdss4
+0001b050: 6f72 672d 6472 3132 2e70 616e 7468 656f  org-dr12.pantheo
+0001b060: 6e73 6974 652e 696f 2f61 6c67 6f72 6974  nsite.io/algorit
+0001b070: 686d 732f 666c 7578 6361 6c2f 2353 4453  hms/fluxcal/#SDS
+0001b080: 5374 6f41 420a 0a20 2020 2062 6173 6963  StoAB..    basic
+0001b090: 616c 6c79 3a20 7541 4220 3d20 7553 4453  ally: uAB = uSDS
+0001b0a0: 5320 2d20 302e 3034 0a0a 2020 2020 5061  S - 0.04..    Pa
+0001b0b0: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+0001b0c0: 2d2d 2d2d 2d2d 2d0a 2020 2020 696d 6167  -------.    imag
+0001b0d0: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
+0001b0e0: 4c6f 6361 7469 6f6e 206f 6620 7468 6520  Location of the 
+0001b0f0: 7370 6c75 7320 696d 6167 6520 286d 7573  splus image (mus
+0001b100: 7420 6265 202e 667a 290a 2020 2020 7361  t be .fz).    sa
+0001b110: 7665 5f66 696c 6520 3a20 7374 720a 2020  ve_file : str.  
+0001b120: 2020 2020 2020 4c6f 6361 7469 6f6e 2074        Location t
+0001b130: 6f20 7361 7665 2074 6865 2072 6574 7269  o save the retri
+0001b140: 6576 6564 2063 6174 616c 6f67 2028 6d75  eved catalog (mu
+0001b150: 7374 2062 6520 2e66 6974 7329 0a0a 2020  st be .fits)..  
+0001b160: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+0001b170: 2d2d 2d2d 2d0a 2020 2020 5361 7665 7320  -----.    Saves 
+0001b180: 6361 7461 6c6f 6720 696e 2074 6865 2064  catalog in the d
+0001b190: 6573 6972 6564 206c 6f63 6174 696f 6e0a  esired location.
+0001b1a0: 2020 2020 2222 220a 0a20 2020 2023 2056      """..    # V
+0001b1b0: 697a 6965 7220 5461 626c 650a 2020 2020  izier Table.    
+0001b1c0: 6361 745f 6964 203d 2022 4a2f 414a 2f31  cat_id = "J/AJ/1
+0001b1d0: 3334 2f39 3733 2f73 7464 6361 7422 0a0a  34/973/stdcat"..
+0001b1e0: 2020 2020 636f 6c75 6d6e 7320 3d20 5b27      columns = ['
+0001b1f0: 5241 4a32 3030 3027 2c20 2744 454a 3230  RAJ2000', 'DEJ20
+0001b200: 3030 272c 2027 756d 6167 272c 2027 655f  00', 'umag', 'e_
+0001b210: 756d 6167 272c 2027 676d 6167 272c 2027  umag', 'gmag', '
+0001b220: 655f 676d 6167 272c 0a20 2020 2020 2020  e_gmag',.       
+0001b230: 2020 2020 2020 2020 2772 6d61 6727 2c20          'rmag', 
+0001b240: 2765 5f72 6d61 6727 2c20 2769 6d61 6727  'e_rmag', 'imag'
+0001b250: 2c20 2765 5f69 6d61 6727 2c20 277a 6d61  , 'e_imag', 'zma
+0001b260: 6727 2c20 2765 5f7a 6d61 6727 5d0a 0a20  g', 'e_zmag'].. 
+0001b270: 2020 2023 2044 6f77 6e6c 6f61 6420 6361     # Download ca
+0001b280: 7461 6c6f 670a 2020 2020 6361 7461 6c6f  talog.    catalo
+0001b290: 6720 3d20 646f 776e 6c6f 6164 5f76 697a  g = download_viz
+0001b2a0: 6965 725f 6361 7461 6c6f 675f 666f 725f  ier_catalog_for_
+0001b2b0: 7370 6c75 735f 6669 656c 6428 7370 6c75  splus_field(splu
+0001b2c0: 735f 696d 6167 6520 3d20 696d 6167 652c  s_image = image,
+0001b2d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b300: 6669 656c 6449 445f 6361 7461 6c6f 673d  fieldID_catalog=
+0001b310: 6669 656c 6449 445f 6361 7461 6c6f 672c  fieldID_catalog,
+0001b320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b350: 7669 7a69 6572 5f63 6174 616c 6f67 5f69  vizier_catalog_i
+0001b360: 6420 3d20 6361 745f 6964 2c0a 2020 2020  d = cat_id,.    
 0001b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b380: 2020 2020 2020 2020 2020 2020 7669 7a69              vizi
-0001b390: 6572 5f63 6174 616c 6f67 5f69 6420 3d20  er_catalog_id = 
-0001b3a0: 6361 745f 6964 2c0a 2020 2020 2020 2020  cat_id,.        
-0001b3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b3d0: 2020 2020 2020 2063 6f6c 756d 6e73 203d         columns =
-0001b3e0: 2063 6f6c 756d 6e73 290a 0a20 2020 2023   columns)..    #
-0001b3f0: 2052 656e 616d 6520 636f 6c75 6d6e 730a   Rename columns.
-0001b400: 2020 2020 6361 7461 6c6f 672e 636f 6c75      catalog.colu
-0001b410: 6d6e 735b 2752 414a 3230 3030 275d 2e6e  mns['RAJ2000'].n
-0001b420: 616d 6520 3d20 2749 5645 5a49 4341 4232  ame = 'IVEZICAB2
-0001b430: 5f52 414a 3230 3030 270a 2020 2020 6361  _RAJ2000'.    ca
-0001b440: 7461 6c6f 672e 636f 6c75 6d6e 735b 2744  talog.columns['D
-0001b450: 454a 3230 3030 275d 2e6e 616d 6520 3d20  EJ2000'].name = 
-0001b460: 2749 5645 5a49 4341 4232 5f44 454a 3230  'IVEZICAB2_DEJ20
-0001b470: 3030 270a 0a20 2020 2063 6174 616c 6f67  00'..    catalog
-0001b480: 2e63 6f6c 756d 6e73 5b27 756d 6167 275d  .columns['umag']
-0001b490: 2e6e 616d 6520 3d20 2753 4453 535f 5527  .name = 'SDSS_U'
-0001b4a0: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
-0001b4b0: 756d 6e73 5b27 655f 756d 6167 275d 2e6e  umns['e_umag'].n
-0001b4c0: 616d 6520 3d20 2753 4453 535f 555f 6572  ame = 'SDSS_U_er
-0001b4d0: 7227 0a20 2020 2063 6174 616c 6f67 2e63  r'.    catalog.c
-0001b4e0: 6f6c 756d 6e73 5b27 676d 6167 275d 2e6e  olumns['gmag'].n
-0001b4f0: 616d 6520 3d20 2753 4453 535f 4727 0a20  ame = 'SDSS_G'. 
-0001b500: 2020 2063 6174 616c 6f67 2e63 6f6c 756d     catalog.colum
-0001b510: 6e73 5b27 655f 676d 6167 275d 2e6e 616d  ns['e_gmag'].nam
-0001b520: 6520 3d20 2753 4453 535f 475f 6572 7227  e = 'SDSS_G_err'
-0001b530: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
-0001b540: 756d 6e73 5b27 726d 6167 275d 2e6e 616d  umns['rmag'].nam
-0001b550: 6520 3d20 2753 4453 535f 5227 0a20 2020  e = 'SDSS_R'.   
-0001b560: 2063 6174 616c 6f67 2e63 6f6c 756d 6e73   catalog.columns
-0001b570: 5b27 655f 726d 6167 275d 2e6e 616d 6520  ['e_rmag'].name 
-0001b580: 3d20 2753 4453 535f 525f 6572 7227 0a20  = 'SDSS_R_err'. 
-0001b590: 2020 2063 6174 616c 6f67 2e63 6f6c 756d     catalog.colum
-0001b5a0: 6e73 5b27 696d 6167 275d 2e6e 616d 6520  ns['imag'].name 
-0001b5b0: 3d20 2753 4453 535f 4927 0a20 2020 2063  = 'SDSS_I'.    c
-0001b5c0: 6174 616c 6f67 2e63 6f6c 756d 6e73 5b27  atalog.columns['
-0001b5d0: 655f 696d 6167 275d 2e6e 616d 6520 3d20  e_imag'].name = 
-0001b5e0: 2753 4453 535f 495f 6572 7227 0a20 2020  'SDSS_I_err'.   
-0001b5f0: 2063 6174 616c 6f67 2e63 6f6c 756d 6e73   catalog.columns
-0001b600: 5b27 7a6d 6167 275d 2e6e 616d 6520 3d20  ['zmag'].name = 
-0001b610: 2753 4453 535f 5a27 0a20 2020 2063 6174  'SDSS_Z'.    cat
-0001b620: 616c 6f67 2e63 6f6c 756d 6e73 5b27 655f  alog.columns['e_
-0001b630: 7a6d 6167 275d 2e6e 616d 6520 3d20 2753  zmag'].name = 'S
-0001b640: 4453 535f 5a5f 6572 7227 0a0a 2020 2020  DSS_Z_err'..    
-0001b650: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001b660: 2323 230a 2020 2020 2320 5265 6d6f 7665  ###.    # Remove
-0001b670: 206e 616e 2076 616c 7565 730a 2020 2020   nan values.    
-0001b680: 4e72 6f77 7320 3d20 6e70 2e61 7272 6179  Nrows = np.array
-0001b690: 2863 6174 616c 6f67 2e63 6f6c 756d 6e73  (catalog.columns
-0001b6a0: 5b27 4956 455a 4943 4142 325f 5241 4a32  ['IVEZICAB2_RAJ2
-0001b6b0: 3030 3027 5d29 2e73 6861 7065 5b30 5d0a  000']).shape[0].
-0001b6c0: 2020 2020 6620 3d20 6e70 2e66 756c 6c28      f = np.full(
-0001b6d0: 4e72 6f77 732c 2054 7275 6529 0a0a 2020  Nrows, True)..  
-0001b6e0: 2020 666f 7220 6d61 6720 696e 205b 2755    for mag in ['U
-0001b6f0: 272c 2027 4727 2c20 2752 272c 2027 4927  ', 'G', 'R', 'I'
-0001b700: 2c20 275a 275d 3a0a 2020 2020 2020 2020  , 'Z']:.        
-0001b710: 6620 3d20 6620 2620 286e 702e 6172 7261  f = f & (np.arra
-0001b720: 7928 6361 7461 6c6f 672e 636f 6c75 6d6e  y(catalog.column
-0001b730: 735b 6627 5344 5353 5f7b 6d61 677d 275d  s[f'SDSS_{mag}']
-0001b740: 2920 3c20 3930 290a 0a20 2020 2063 6174  ) < 90)..    cat
-0001b750: 616c 6f67 203d 2063 6174 616c 6f67 5b66  alog = catalog[f
-0001b760: 5d0a 2020 2020 0a20 2020 2023 2041 7070  ].    .    # App
-0001b770: 6c79 2041 4220 6d61 676e 6974 7564 6520  ly AB magnitude 
-0001b780: 6f66 6673 6574 730a 2020 2020 6361 7461  offsets.    cata
-0001b790: 6c6f 675b 2753 4453 535f 5527 5d20 3d20  log['SDSS_U'] = 
-0001b7a0: 6361 7461 6c6f 675b 2753 4453 535f 5527  catalog['SDSS_U'
-0001b7b0: 5d20 2d20 302e 3034 0a0a 2020 2020 2320  ] - 0.04..    # 
-0001b7c0: 5472 756e 6361 7465 2064 6573 6372 6970  Truncate descrip
-0001b7d0: 7469 6f6e 2028 7573 7561 6c6c 7920 746f  tion (usually to
-0001b7e0: 2062 6967 2074 6f20 7361 7665 2061 7320   big to save as 
-0001b7f0: 6669 7473 290a 2020 2020 6361 7461 6c6f  fits).    catalo
-0001b800: 672e 6d65 7461 5b27 6465 7363 7269 7074  g.meta['descript
-0001b810: 696f 6e27 5d20 3d20 6361 7461 6c6f 672e  ion'] = catalog.
-0001b820: 6d65 7461 5b27 6465 7363 7269 7074 696f  meta['descriptio
-0001b830: 6e27 5d5b 3a35 355d 0a0a 2020 2020 2320  n'][:55]..    # 
-0001b840: 5361 7665 2074 6162 6c65 2061 7320 6669  Save table as fi
-0001b850: 7473 0a20 2020 2063 6174 616c 6f67 2e77  ts.    catalog.w
-0001b860: 7269 7465 2873 6176 655f 6669 6c65 2c20  rite(save_file, 
-0001b870: 6f76 6572 7772 6974 6520 3d20 5472 7565  overwrite = True
-0001b880: 290a 0a0a 6465 6620 646f 776e 6c6f 6164  )...def download
-0001b890: 5f73 6473 7328 7361 7665 5f66 696c 652c  _sdss(save_file,
-0001b8a0: 2069 6d61 6765 203d 204e 6f6e 652c 2066   image = None, f
-0001b8b0: 6965 6c64 4944 5f63 6174 616c 6f67 203d  ieldID_catalog =
-0001b8c0: 204e 6f6e 6529 3a0a 2020 2020 2222 220a   None):.    """.
-0001b8d0: 2020 2020 446f 776e 6c6f 6164 7320 7468      Downloads th
-0001b8e0: 6520 5344 5353 2044 5231 3220 6361 7461  e SDSS DR12 cata
-0001b8f0: 6c6f 6720 6672 6f6d 2074 6865 2076 697a  log from the viz
-0001b900: 6965 7220 6461 7461 6261 7365 2069 6e20  ier database in 
-0001b910: 7468 6520 7265 6769 6f6e 0a20 2020 2063  the region.    c
-0001b920: 6f76 6572 6564 2062 7920 616e 2073 706c  overed by an spl
-0001b930: 7573 2069 6d61 6765 2e20 4368 616e 6765  us image. Change
-0001b940: 7320 636f 6c75 6d6e 206e 616d 6573 2066  s column names f
-0001b950: 6f72 2074 6865 2066 6f72 6d61 7420 7573  or the format us
-0001b960: 6564 2062 7920 7468 650a 2020 2020 7069  ed by the.    pi
-0001b970: 7065 6c69 6e65 2c20 6465 6c65 7465 7320  peline, deletes 
-0001b980: 756e 6e65 6365 7373 6172 7920 636f 6c75  unnecessary colu
-0001b990: 6d6e 7320 616e 6420 7361 7665 7320 7265  mns and saves re
-0001b9a0: 7375 6c74 7320 746f 2061 2066 6974 7320  sults to a fits 
-0001b9b0: 6669 6c65 0a0a 2020 2020 5061 7261 6d65  file..    Parame
-0001b9c0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-0001b9d0: 2d2d 2d0a 2020 2020 696d 6167 6520 3a20  ---.    image : 
-0001b9e0: 7374 720a 2020 2020 2020 2020 4c6f 6361  str.        Loca
-0001b9f0: 7469 6f6e 206f 6620 7468 6520 7370 6c75  tion of the splu
-0001ba00: 7320 696d 6167 6520 286d 7573 7420 6265  s image (must be
-0001ba10: 202e 667a 290a 2020 2020 7361 7665 5f66   .fz).    save_f
-0001ba20: 696c 6520 3a20 7374 720a 2020 2020 2020  ile : str.      
-0001ba30: 2020 4c6f 6361 7469 6f6e 2074 6f20 7361    Location to sa
-0001ba40: 7665 2074 6865 2072 6574 7269 6576 6564  ve the retrieved
-0001ba50: 2063 6174 616c 6f67 2028 6d75 7374 2062   catalog (must b
-0001ba60: 6520 2e66 6974 7329 0a0a 2020 2020 5265  e .fits)..    Re
-0001ba70: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-0001ba80: 2d0a 2020 2020 5361 7665 7320 6361 7461  -.    Saves cata
-0001ba90: 6c6f 6720 696e 2074 6865 2064 6573 6972  log in the desir
-0001baa0: 6564 206c 6f63 6174 696f 6e0a 2020 2020  ed location.    
-0001bab0: 2222 220a 0a20 2020 2023 2056 697a 6965  """..    # Vizie
-0001bac0: 7220 5461 626c 650a 2020 2020 6361 745f  r Table.    cat_
-0001bad0: 6964 203d 2022 562f 3134 372f 7364 7373  id = "V/147/sdss
-0001bae0: 3132 220a 0a20 2020 2063 6f6c 756d 6e73  12"..    columns
-0001baf0: 203d 205b 2752 415f 4943 5253 272c 2027   = ['RA_ICRS', '
-0001bb00: 4445 5f49 4352 5327 2c20 2753 4453 5331  DE_ICRS', 'SDSS1
-0001bb10: 3227 2c20 2775 6d61 6727 2c20 2765 5f75  2', 'umag', 'e_u
-0001bb20: 6d61 6727 2c20 2767 6d61 6727 2c0a 2020  mag', 'gmag',.  
-0001bb30: 2020 2020 2020 2020 2020 2020 2027 655f               'e_
-0001bb40: 676d 6167 272c 2027 726d 6167 272c 2027  gmag', 'rmag', '
-0001bb50: 655f 726d 6167 272c 2027 696d 6167 272c  e_rmag', 'imag',
-0001bb60: 2027 655f 696d 6167 272c 2027 7a6d 6167   'e_imag', 'zmag
-0001bb70: 272c 2027 655f 7a6d 6167 275d 0a0a 2020  ', 'e_zmag']..  
-0001bb80: 2020 636f 6c75 6d6e 5f66 696c 7465 7273    column_filters
-0001bb90: 203d 207b 2763 6c61 7373 273a 2027 3d36   = {'class': '=6
-0001bba0: 272c 2027 756d 6167 273a 2027 3c31 3030  ', 'umag': '<100
-0001bbb0: 272c 2027 676d 6167 273a 2027 3c31 3030  ', 'gmag': '<100
-0001bbc0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0001bbd0: 2020 2020 2020 2020 2027 726d 6167 273a           'rmag':
-0001bbe0: 2027 3c31 3030 272c 2027 696d 6167 273a   '<100', 'imag':
-0001bbf0: 2027 3c31 3030 272c 2027 7a6d 6167 273a   '<100', 'zmag':
-0001bc00: 2027 3c31 3030 277d 0a0a 2020 2020 2320   '<100'}..    # 
-0001bc10: 446f 776e 6c6f 6164 2063 6174 616c 6f67  Download catalog
-0001bc20: 0a20 2020 2063 6174 616c 6f67 203d 2064  .    catalog = d
-0001bc30: 6f77 6e6c 6f61 645f 7669 7a69 6572 5f63  ownload_vizier_c
-0001bc40: 6174 616c 6f67 5f66 6f72 5f73 706c 7573  atalog_for_splus
-0001bc50: 5f66 6965 6c64 2873 706c 7573 5f69 6d61  _field(splus_ima
-0001bc60: 6765 203d 2069 6d61 6765 2c0a 2020 2020  ge = image,.    
-0001bc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b390: 2020 2020 2020 2020 2020 2063 6f6c 756d             colum
+0001b3a0: 6e73 203d 2063 6f6c 756d 6e73 290a 0a20  ns = columns).. 
+0001b3b0: 2020 2023 2052 656e 616d 6520 636f 6c75     # Rename colu
+0001b3c0: 6d6e 730a 2020 2020 6361 7461 6c6f 672e  mns.    catalog.
+0001b3d0: 636f 6c75 6d6e 735b 2752 414a 3230 3030  columns['RAJ2000
+0001b3e0: 275d 2e6e 616d 6520 3d20 2749 5645 5a49  '].name = 'IVEZI
+0001b3f0: 4341 4232 5f52 414a 3230 3030 270a 2020  CAB2_RAJ2000'.  
+0001b400: 2020 6361 7461 6c6f 672e 636f 6c75 6d6e    catalog.column
+0001b410: 735b 2744 454a 3230 3030 275d 2e6e 616d  s['DEJ2000'].nam
+0001b420: 6520 3d20 2749 5645 5a49 4341 4232 5f44  e = 'IVEZICAB2_D
+0001b430: 454a 3230 3030 270a 0a20 2020 2063 6174  EJ2000'..    cat
+0001b440: 616c 6f67 2e63 6f6c 756d 6e73 5b27 756d  alog.columns['um
+0001b450: 6167 275d 2e6e 616d 6520 3d20 2753 4453  ag'].name = 'SDS
+0001b460: 535f 5527 0a20 2020 2063 6174 616c 6f67  S_U'.    catalog
+0001b470: 2e63 6f6c 756d 6e73 5b27 655f 756d 6167  .columns['e_umag
+0001b480: 275d 2e6e 616d 6520 3d20 2753 4453 535f  '].name = 'SDSS_
+0001b490: 555f 6572 7227 0a20 2020 2063 6174 616c  U_err'.    catal
+0001b4a0: 6f67 2e63 6f6c 756d 6e73 5b27 676d 6167  og.columns['gmag
+0001b4b0: 275d 2e6e 616d 6520 3d20 2753 4453 535f  '].name = 'SDSS_
+0001b4c0: 4727 0a20 2020 2063 6174 616c 6f67 2e63  G'.    catalog.c
+0001b4d0: 6f6c 756d 6e73 5b27 655f 676d 6167 275d  olumns['e_gmag']
+0001b4e0: 2e6e 616d 6520 3d20 2753 4453 535f 475f  .name = 'SDSS_G_
+0001b4f0: 6572 7227 0a20 2020 2063 6174 616c 6f67  err'.    catalog
+0001b500: 2e63 6f6c 756d 6e73 5b27 726d 6167 275d  .columns['rmag']
+0001b510: 2e6e 616d 6520 3d20 2753 4453 535f 5227  .name = 'SDSS_R'
+0001b520: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
+0001b530: 756d 6e73 5b27 655f 726d 6167 275d 2e6e  umns['e_rmag'].n
+0001b540: 616d 6520 3d20 2753 4453 535f 525f 6572  ame = 'SDSS_R_er
+0001b550: 7227 0a20 2020 2063 6174 616c 6f67 2e63  r'.    catalog.c
+0001b560: 6f6c 756d 6e73 5b27 696d 6167 275d 2e6e  olumns['imag'].n
+0001b570: 616d 6520 3d20 2753 4453 535f 4927 0a20  ame = 'SDSS_I'. 
+0001b580: 2020 2063 6174 616c 6f67 2e63 6f6c 756d     catalog.colum
+0001b590: 6e73 5b27 655f 696d 6167 275d 2e6e 616d  ns['e_imag'].nam
+0001b5a0: 6520 3d20 2753 4453 535f 495f 6572 7227  e = 'SDSS_I_err'
+0001b5b0: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
+0001b5c0: 756d 6e73 5b27 7a6d 6167 275d 2e6e 616d  umns['zmag'].nam
+0001b5d0: 6520 3d20 2753 4453 535f 5a27 0a20 2020  e = 'SDSS_Z'.   
+0001b5e0: 2063 6174 616c 6f67 2e63 6f6c 756d 6e73   catalog.columns
+0001b5f0: 5b27 655f 7a6d 6167 275d 2e6e 616d 6520  ['e_zmag'].name 
+0001b600: 3d20 2753 4453 535f 5a5f 6572 7227 0a0a  = 'SDSS_Z_err'..
+0001b610: 2020 2020 2323 2323 2323 2323 2323 2323      ############
+0001b620: 2323 2323 2323 230a 2020 2020 2320 5265  #######.    # Re
+0001b630: 6d6f 7665 206e 616e 2076 616c 7565 730a  move nan values.
+0001b640: 2020 2020 4e72 6f77 7320 3d20 6e70 2e61      Nrows = np.a
+0001b650: 7272 6179 2863 6174 616c 6f67 2e63 6f6c  rray(catalog.col
+0001b660: 756d 6e73 5b27 4956 455a 4943 4142 325f  umns['IVEZICAB2_
+0001b670: 5241 4a32 3030 3027 5d29 2e73 6861 7065  RAJ2000']).shape
+0001b680: 5b30 5d0a 2020 2020 6620 3d20 6e70 2e66  [0].    f = np.f
+0001b690: 756c 6c28 4e72 6f77 732c 2054 7275 6529  ull(Nrows, True)
+0001b6a0: 0a0a 2020 2020 666f 7220 6d61 6720 696e  ..    for mag in
+0001b6b0: 205b 2755 272c 2027 4727 2c20 2752 272c   ['U', 'G', 'R',
+0001b6c0: 2027 4927 2c20 275a 275d 3a0a 2020 2020   'I', 'Z']:.    
+0001b6d0: 2020 2020 6620 3d20 6620 2620 286e 702e      f = f & (np.
+0001b6e0: 6172 7261 7928 6361 7461 6c6f 672e 636f  array(catalog.co
+0001b6f0: 6c75 6d6e 735b 6627 5344 5353 5f7b 6d61  lumns[f'SDSS_{ma
+0001b700: 677d 275d 2920 3c20 3930 290a 0a20 2020  g}']) < 90)..   
+0001b710: 2063 6174 616c 6f67 203d 2063 6174 616c   catalog = catal
+0001b720: 6f67 5b66 5d0a 2020 2020 0a20 2020 2023  og[f].    .    #
+0001b730: 2041 7070 6c79 2041 4220 6d61 676e 6974   Apply AB magnit
+0001b740: 7564 6520 6f66 6673 6574 730a 2020 2020  ude offsets.    
+0001b750: 6361 7461 6c6f 675b 2753 4453 535f 5527  catalog['SDSS_U'
+0001b760: 5d20 3d20 6361 7461 6c6f 675b 2753 4453  ] = catalog['SDS
+0001b770: 535f 5527 5d20 2d20 302e 3034 0a0a 2020  S_U'] - 0.04..  
+0001b780: 2020 2320 5472 756e 6361 7465 2064 6573    # Truncate des
+0001b790: 6372 6970 7469 6f6e 2028 7573 7561 6c6c  cription (usuall
+0001b7a0: 7920 746f 2062 6967 2074 6f20 7361 7665  y to big to save
+0001b7b0: 2061 7320 6669 7473 290a 2020 2020 6361   as fits).    ca
+0001b7c0: 7461 6c6f 672e 6d65 7461 5b27 6465 7363  talog.meta['desc
+0001b7d0: 7269 7074 696f 6e27 5d20 3d20 6361 7461  ription'] = cata
+0001b7e0: 6c6f 672e 6d65 7461 5b27 6465 7363 7269  log.meta['descri
+0001b7f0: 7074 696f 6e27 5d5b 3a35 355d 0a0a 2020  ption'][:55]..  
+0001b800: 2020 2320 5361 7665 2074 6162 6c65 2061    # Save table a
+0001b810: 7320 6669 7473 0a20 2020 2063 6174 616c  s fits.    catal
+0001b820: 6f67 2e77 7269 7465 2873 6176 655f 6669  og.write(save_fi
+0001b830: 6c65 2c20 6f76 6572 7772 6974 6520 3d20  le, overwrite = 
+0001b840: 5472 7565 290a 0a0a 6465 6620 646f 776e  True)...def down
+0001b850: 6c6f 6164 5f73 6473 7328 7361 7665 5f66  load_sdss(save_f
+0001b860: 696c 652c 2069 6d61 6765 203d 204e 6f6e  ile, image = Non
+0001b870: 652c 2066 6965 6c64 4944 5f63 6174 616c  e, fieldID_catal
+0001b880: 6f67 203d 204e 6f6e 6529 3a0a 2020 2020  og = None):.    
+0001b890: 2222 220a 2020 2020 446f 776e 6c6f 6164  """.    Download
+0001b8a0: 7320 7468 6520 5344 5353 2044 5231 3220  s the SDSS DR12 
+0001b8b0: 6361 7461 6c6f 6720 6672 6f6d 2074 6865  catalog from the
+0001b8c0: 2076 697a 6965 7220 6461 7461 6261 7365   vizier database
+0001b8d0: 2069 6e20 7468 6520 7265 6769 6f6e 0a20   in the region. 
+0001b8e0: 2020 2063 6f76 6572 6564 2062 7920 616e     covered by an
+0001b8f0: 2073 706c 7573 2069 6d61 6765 2e20 4368   splus image. Ch
+0001b900: 616e 6765 7320 636f 6c75 6d6e 206e 616d  anges column nam
+0001b910: 6573 2066 6f72 2074 6865 2066 6f72 6d61  es for the forma
+0001b920: 7420 7573 6564 2062 7920 7468 650a 2020  t used by the.  
+0001b930: 2020 7069 7065 6c69 6e65 2c20 6465 6c65    pipeline, dele
+0001b940: 7465 7320 756e 6e65 6365 7373 6172 7920  tes unnecessary 
+0001b950: 636f 6c75 6d6e 7320 616e 6420 7361 7665  columns and save
+0001b960: 7320 7265 7375 6c74 7320 746f 2061 2066  s results to a f
+0001b970: 6974 7320 6669 6c65 0a0a 2020 2020 5061  its file..    Pa
+0001b980: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+0001b990: 2d2d 2d2d 2d2d 2d0a 2020 2020 696d 6167  -------.    imag
+0001b9a0: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
+0001b9b0: 4c6f 6361 7469 6f6e 206f 6620 7468 6520  Location of the 
+0001b9c0: 7370 6c75 7320 696d 6167 6520 286d 7573  splus image (mus
+0001b9d0: 7420 6265 202e 667a 290a 2020 2020 7361  t be .fz).    sa
+0001b9e0: 7665 5f66 696c 6520 3a20 7374 720a 2020  ve_file : str.  
+0001b9f0: 2020 2020 2020 4c6f 6361 7469 6f6e 2074        Location t
+0001ba00: 6f20 7361 7665 2074 6865 2072 6574 7269  o save the retri
+0001ba10: 6576 6564 2063 6174 616c 6f67 2028 6d75  eved catalog (mu
+0001ba20: 7374 2062 6520 2e66 6974 7329 0a0a 2020  st be .fits)..  
+0001ba30: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+0001ba40: 2d2d 2d2d 2d0a 2020 2020 5361 7665 7320  -----.    Saves 
+0001ba50: 6361 7461 6c6f 6720 696e 2074 6865 2064  catalog in the d
+0001ba60: 6573 6972 6564 206c 6f63 6174 696f 6e0a  esired location.
+0001ba70: 2020 2020 2222 220a 0a20 2020 2023 2056      """..    # V
+0001ba80: 697a 6965 7220 5461 626c 650a 2020 2020  izier Table.    
+0001ba90: 6361 745f 6964 203d 2022 562f 3134 372f  cat_id = "V/147/
+0001baa0: 7364 7373 3132 220a 0a20 2020 2063 6f6c  sdss12"..    col
+0001bab0: 756d 6e73 203d 205b 2752 415f 4943 5253  umns = ['RA_ICRS
+0001bac0: 272c 2027 4445 5f49 4352 5327 2c20 2753  ', 'DE_ICRS', 'S
+0001bad0: 4453 5331 3227 2c20 2775 6d61 6727 2c20  DSS12', 'umag', 
+0001bae0: 2765 5f75 6d61 6727 2c20 2767 6d61 6727  'e_umag', 'gmag'
+0001baf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001bb00: 2027 655f 676d 6167 272c 2027 726d 6167   'e_gmag', 'rmag
+0001bb10: 272c 2027 655f 726d 6167 272c 2027 696d  ', 'e_rmag', 'im
+0001bb20: 6167 272c 2027 655f 696d 6167 272c 2027  ag', 'e_imag', '
+0001bb30: 7a6d 6167 272c 2027 655f 7a6d 6167 275d  zmag', 'e_zmag']
+0001bb40: 0a0a 2020 2020 636f 6c75 6d6e 5f66 696c  ..    column_fil
+0001bb50: 7465 7273 203d 207b 2763 6c61 7373 273a  ters = {'class':
+0001bb60: 2027 3d36 272c 2027 756d 6167 273a 2027   '=6', 'umag': '
+0001bb70: 3c31 3030 272c 2027 676d 6167 273a 2027  <100', 'gmag': '
+0001bb80: 3c31 3030 272c 0a20 2020 2020 2020 2020  <100',.         
+0001bb90: 2020 2020 2020 2020 2020 2020 2027 726d               'rm
+0001bba0: 6167 273a 2027 3c31 3030 272c 2027 696d  ag': '<100', 'im
+0001bbb0: 6167 273a 2027 3c31 3030 272c 2027 7a6d  ag': '<100', 'zm
+0001bbc0: 6167 273a 2027 3c31 3030 277d 0a0a 2020  ag': '<100'}..  
+0001bbd0: 2020 2320 446f 776e 6c6f 6164 2063 6174    # Download cat
+0001bbe0: 616c 6f67 0a20 2020 2063 6174 616c 6f67  alog.    catalog
+0001bbf0: 203d 2064 6f77 6e6c 6f61 645f 7669 7a69   = download_vizi
+0001bc00: 6572 5f63 6174 616c 6f67 5f66 6f72 5f73  er_catalog_for_s
+0001bc10: 706c 7573 5f66 6965 6c64 2873 706c 7573  plus_field(splus
+0001bc20: 5f69 6d61 6765 203d 2069 6d61 6765 2c0a  _image = image,.
+0001bc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001bc60: 6965 6c64 4944 5f63 6174 616c 6f67 3d66  ieldID_catalog=f
+0001bc70: 6965 6c64 4944 5f63 6174 616c 6f67 2c0a  ieldID_catalog,.
 0001bc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc90: 2020 2020 2020 2020 2020 2066 6965 6c64             field
-0001bca0: 4944 5f63 6174 616c 6f67 3d66 6965 6c64  ID_catalog=field
-0001bcb0: 4944 5f63 6174 616c 6f67 2c0a 2020 2020  ID_catalog,.    
-0001bcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bca0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0001bcb0: 697a 6965 725f 6361 7461 6c6f 675f 6964  izier_catalog_id
+0001bcc0: 203d 2063 6174 5f69 642c 0a20 2020 2020   = cat_id,.     
 0001bcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bce0: 2020 2020 2020 2020 2020 2076 697a 6965             vizie
-0001bcf0: 725f 6361 7461 6c6f 675f 6964 203d 2063  r_catalog_id = c
-0001bd00: 6174 5f69 642c 0a20 2020 2020 2020 2020  at_id,.         
+0001bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bcf0: 2020 2020 2020 2020 2020 636f 6c75 6d6e            column
+0001bd00: 7320 3d20 636f 6c75 6d6e 732c 0a20 2020  s = columns,.   
 0001bd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001bd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bd30: 2020 2020 2020 636f 6c75 6d6e 7320 3d20        columns = 
-0001bd40: 636f 6c75 6d6e 732c 0a20 2020 2020 2020  columns,.       
-0001bd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bd70: 2020 2020 2020 2020 636f 6c75 6d6e 5f66          column_f
-0001bd80: 696c 7465 7273 203d 2063 6f6c 756d 6e5f  ilters = column_
-0001bd90: 6669 6c74 6572 7329 0a0a 2020 2020 2320  filters)..    # 
-0001bda0: 5265 6e61 6d65 2063 6f6c 756d 6e73 0a20  Rename columns. 
-0001bdb0: 2020 2063 6174 616c 6f67 2e63 6f6c 756d     catalog.colum
-0001bdc0: 6e73 5b27 5241 5f49 4352 5327 5d2e 6e61  ns['RA_ICRS'].na
-0001bdd0: 6d65 203d 2027 5344 5353 5f52 414a 3230  me = 'SDSS_RAJ20
-0001bde0: 3030 270a 2020 2020 6361 7461 6c6f 672e  00'.    catalog.
-0001bdf0: 636f 6c75 6d6e 735b 2744 455f 4943 5253  columns['DE_ICRS
-0001be00: 275d 2e6e 616d 6520 3d20 2753 4453 535f  '].name = 'SDSS_
-0001be10: 4445 4a32 3030 3027 0a0a 2020 2020 6361  DEJ2000'..    ca
-0001be20: 7461 6c6f 672e 636f 6c75 6d6e 735b 2775  talog.columns['u
-0001be30: 6d61 6727 5d2e 6e61 6d65 203d 2027 5344  mag'].name = 'SD
-0001be40: 5353 5f55 270a 2020 2020 6361 7461 6c6f  SS_U'.    catalo
-0001be50: 672e 636f 6c75 6d6e 735b 2765 5f75 6d61  g.columns['e_uma
-0001be60: 6727 5d2e 6e61 6d65 203d 2027 5344 5353  g'].name = 'SDSS
-0001be70: 5f55 5f65 7272 270a 2020 2020 6361 7461  _U_err'.    cata
-0001be80: 6c6f 672e 636f 6c75 6d6e 735b 2767 6d61  log.columns['gma
-0001be90: 6727 5d2e 6e61 6d65 203d 2027 5344 5353  g'].name = 'SDSS
-0001bea0: 5f47 270a 2020 2020 6361 7461 6c6f 672e  _G'.    catalog.
-0001beb0: 636f 6c75 6d6e 735b 2765 5f67 6d61 6727  columns['e_gmag'
-0001bec0: 5d2e 6e61 6d65 203d 2027 5344 5353 5f47  ].name = 'SDSS_G
-0001bed0: 5f65 7272 270a 2020 2020 6361 7461 6c6f  _err'.    catalo
-0001bee0: 672e 636f 6c75 6d6e 735b 2772 6d61 6727  g.columns['rmag'
-0001bef0: 5d2e 6e61 6d65 203d 2027 5344 5353 5f52  ].name = 'SDSS_R
-0001bf00: 270a 2020 2020 6361 7461 6c6f 672e 636f  '.    catalog.co
-0001bf10: 6c75 6d6e 735b 2765 5f72 6d61 6727 5d2e  lumns['e_rmag'].
-0001bf20: 6e61 6d65 203d 2027 5344 5353 5f52 5f65  name = 'SDSS_R_e
-0001bf30: 7272 270a 2020 2020 6361 7461 6c6f 672e  rr'.    catalog.
-0001bf40: 636f 6c75 6d6e 735b 2769 6d61 6727 5d2e  columns['imag'].
-0001bf50: 6e61 6d65 203d 2027 5344 5353 5f49 270a  name = 'SDSS_I'.
-0001bf60: 2020 2020 6361 7461 6c6f 672e 636f 6c75      catalog.colu
-0001bf70: 6d6e 735b 2765 5f69 6d61 6727 5d2e 6e61  mns['e_imag'].na
-0001bf80: 6d65 203d 2027 5344 5353 5f49 5f65 7272  me = 'SDSS_I_err
-0001bf90: 270a 2020 2020 6361 7461 6c6f 672e 636f  '.    catalog.co
-0001bfa0: 6c75 6d6e 735b 277a 6d61 6727 5d2e 6e61  lumns['zmag'].na
-0001bfb0: 6d65 203d 2027 5344 5353 5f5a 270a 2020  me = 'SDSS_Z'.  
-0001bfc0: 2020 6361 7461 6c6f 672e 636f 6c75 6d6e    catalog.column
-0001bfd0: 735b 2765 5f7a 6d61 6727 5d2e 6e61 6d65  s['e_zmag'].name
-0001bfe0: 203d 2027 5344 5353 5f5a 5f65 7272 270a   = 'SDSS_Z_err'.
-0001bff0: 0a20 2020 2023 2054 7275 6e63 6174 6520  .    # Truncate 
-0001c000: 6465 7363 7269 7074 696f 6e20 2875 7375  description (usu
-0001c010: 616c 6c79 2074 6f20 6269 6720 746f 2073  ally to big to s
-0001c020: 6176 6520 6173 2066 6974 7329 0a20 2020  ave as fits).   
-0001c030: 2063 6174 616c 6f67 2e6d 6574 615b 2764   catalog.meta['d
-0001c040: 6573 6372 6970 7469 6f6e 275d 203d 2063  escription'] = c
-0001c050: 6174 616c 6f67 2e6d 6574 615b 2764 6573  atalog.meta['des
-0001c060: 6372 6970 7469 6f6e 275d 5b3a 3535 5d0a  cription'][:55].
-0001c070: 0a20 2020 2023 2053 6176 6520 7461 626c  .    # Save tabl
-0001c080: 6520 6173 2066 6974 730a 2020 2020 6361  e as fits.    ca
-0001c090: 7461 6c6f 672e 7772 6974 6528 7361 7665  talog.write(save
-0001c0a0: 5f66 696c 652c 206f 7665 7277 7269 7465  _file, overwrite
-0001c0b0: 203d 2054 7275 6529 0a0a 6465 6620 646f   = True)..def do
-0001c0c0: 776e 6c6f 6164 5f73 6473 7331 3628 7361  wnload_sdss16(sa
-0001c0d0: 7665 5f66 696c 652c 2069 6d61 6765 203d  ve_file, image =
-0001c0e0: 204e 6f6e 652c 2066 6965 6c64 4944 5f63   None, fieldID_c
-0001c0f0: 6174 616c 6f67 203d 204e 6f6e 6529 3a0a  atalog = None):.
-0001c100: 2020 2020 2222 220a 2020 2020 446f 776e      """.    Down
-0001c110: 6c6f 6164 7320 7468 6520 5344 5353 2044  loads the SDSS D
-0001c120: 5231 3620 6361 7461 6c6f 6720 6672 6f6d  R16 catalog from
-0001c130: 2074 6865 2076 697a 6965 7220 6461 7461   the vizier data
-0001c140: 6261 7365 2069 6e20 7468 6520 7265 6769  base in the regi
-0001c150: 6f6e 0a20 2020 2063 6f76 6572 6564 2062  on.    covered b
-0001c160: 7920 616e 2073 706c 7573 2069 6d61 6765  y an splus image
-0001c170: 2e20 4368 616e 6765 7320 636f 6c75 6d6e  . Changes column
-0001c180: 206e 616d 6573 2066 6f72 2074 6865 2066   names for the f
-0001c190: 6f72 6d61 7420 7573 6564 2062 7920 7468  ormat used by th
-0001c1a0: 650a 2020 2020 7069 7065 6c69 6e65 2c20  e.    pipeline, 
-0001c1b0: 6465 6c65 7465 7320 756e 6e65 6365 7373  deletes unnecess
-0001c1c0: 6172 7920 636f 6c75 6d6e 7320 616e 6420  ary columns and 
-0001c1d0: 7361 7665 7320 7265 7375 6c74 7320 746f  saves results to
-0001c1e0: 2061 2066 6974 7320 6669 6c65 0a0a 2020   a fits file..  
-0001c1f0: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-0001c200: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-0001c210: 696d 6167 6520 3a20 7374 720a 2020 2020  image : str.    
-0001c220: 2020 2020 4c6f 6361 7469 6f6e 206f 6620      Location of 
-0001c230: 7468 6520 7370 6c75 7320 696d 6167 6520  the splus image 
-0001c240: 286d 7573 7420 6265 202e 667a 290a 2020  (must be .fz).  
-0001c250: 2020 7361 7665 5f66 696c 6520 3a20 7374    save_file : st
-0001c260: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
-0001c270: 6f6e 2074 6f20 7361 7665 2074 6865 2072  on to save the r
-0001c280: 6574 7269 6576 6564 2063 6174 616c 6f67  etrieved catalog
-0001c290: 2028 6d75 7374 2062 6520 2e66 6974 7329   (must be .fits)
-0001c2a0: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
-0001c2b0: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 5361    -------.    Sa
-0001c2c0: 7665 7320 6361 7461 6c6f 6720 696e 2074  ves catalog in t
-0001c2d0: 6865 2064 6573 6972 6564 206c 6f63 6174  he desired locat
-0001c2e0: 696f 6e0a 2020 2020 2222 220a 0a20 2020  ion.    """..   
-0001c2f0: 2023 2056 697a 6965 7220 5461 626c 650a   # Vizier Table.
-0001c300: 2020 2020 6361 745f 6964 203d 2022 562f      cat_id = "V/
-0001c310: 3135 342f 7364 7373 3136 220a 0a20 2020  154/sdss16"..   
-0001c320: 2063 6f6c 756d 6e73 203d 205b 275f 5241   columns = ['_RA
-0001c330: 4a32 3030 3027 2c20 275f 4445 4a32 3030  J2000', '_DEJ200
-0001c340: 3027 2c20 276f 626a 4944 272c 2027 756d  0', 'objID', 'um
-0001c350: 6167 272c 2027 655f 756d 6167 272c 2027  ag', 'e_umag', '
-0001c360: 676d 6167 272c 0a20 2020 2020 2020 2020  gmag',.         
-0001c370: 2020 2020 2020 2765 5f67 6d61 6727 2c20        'e_gmag', 
-0001c380: 2772 6d61 6727 2c20 2765 5f72 6d61 6727  'rmag', 'e_rmag'
-0001c390: 2c20 2769 6d61 6727 2c20 2765 5f69 6d61  , 'imag', 'e_ima
-0001c3a0: 6727 2c20 277a 6d61 6727 2c20 2765 5f7a  g', 'zmag', 'e_z
-0001c3b0: 6d61 6727 5d0a 0a20 2020 2063 6f6c 756d  mag']..    colum
-0001c3c0: 6e5f 6669 6c74 6572 7320 3d20 7b27 636c  n_filters = {'cl
-0001c3d0: 6173 7327 3a20 273d 3627 2c20 2775 6d61  ass': '=6', 'uma
-0001c3e0: 6727 3a20 273c 3130 3027 2c20 2767 6d61  g': '<100', 'gma
-0001c3f0: 6727 3a20 273c 3130 3027 2c0a 2020 2020  g': '<100',.    
-0001c400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c410: 2020 2772 6d61 6727 3a20 273c 3130 3027    'rmag': '<100'
-0001c420: 2c20 2769 6d61 6727 3a20 273c 3130 3027  , 'imag': '<100'
-0001c430: 2c20 277a 6d61 6727 3a20 273c 3130 3027  , 'zmag': '<100'
-0001c440: 7d0a 0a20 2020 2023 2044 6f77 6e6c 6f61  }..    # Downloa
-0001c450: 6420 6361 7461 6c6f 670a 2020 2020 6361  d catalog.    ca
-0001c460: 7461 6c6f 6720 3d20 646f 776e 6c6f 6164  talog = download
-0001c470: 5f76 697a 6965 725f 6361 7461 6c6f 675f  _vizier_catalog_
-0001c480: 666f 725f 7370 6c75 735f 6669 656c 6428  for_splus_field(
-0001c490: 7370 6c75 735f 696d 6167 6520 3d20 696d  splus_image = im
-0001c4a0: 6167 652c 0a20 2020 2020 2020 2020 2020  age,.           
-0001c4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd30: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
+0001bd40: 6d6e 5f66 696c 7465 7273 203d 2063 6f6c  mn_filters = col
+0001bd50: 756d 6e5f 6669 6c74 6572 7329 0a0a 2020  umn_filters)..  
+0001bd60: 2020 2320 5265 6e61 6d65 2063 6f6c 756d    # Rename colum
+0001bd70: 6e73 0a20 2020 2063 6174 616c 6f67 2e63  ns.    catalog.c
+0001bd80: 6f6c 756d 6e73 5b27 5241 5f49 4352 5327  olumns['RA_ICRS'
+0001bd90: 5d2e 6e61 6d65 203d 2027 5344 5353 5f52  ].name = 'SDSS_R
+0001bda0: 414a 3230 3030 270a 2020 2020 6361 7461  AJ2000'.    cata
+0001bdb0: 6c6f 672e 636f 6c75 6d6e 735b 2744 455f  log.columns['DE_
+0001bdc0: 4943 5253 275d 2e6e 616d 6520 3d20 2753  ICRS'].name = 'S
+0001bdd0: 4453 535f 4445 4a32 3030 3027 0a0a 2020  DSS_DEJ2000'..  
+0001bde0: 2020 6361 7461 6c6f 672e 636f 6c75 6d6e    catalog.column
+0001bdf0: 735b 2775 6d61 6727 5d2e 6e61 6d65 203d  s['umag'].name =
+0001be00: 2027 5344 5353 5f55 270a 2020 2020 6361   'SDSS_U'.    ca
+0001be10: 7461 6c6f 672e 636f 6c75 6d6e 735b 2765  talog.columns['e
+0001be20: 5f75 6d61 6727 5d2e 6e61 6d65 203d 2027  _umag'].name = '
+0001be30: 5344 5353 5f55 5f65 7272 270a 2020 2020  SDSS_U_err'.    
+0001be40: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
+0001be50: 2767 6d61 6727 5d2e 6e61 6d65 203d 2027  'gmag'].name = '
+0001be60: 5344 5353 5f47 270a 2020 2020 6361 7461  SDSS_G'.    cata
+0001be70: 6c6f 672e 636f 6c75 6d6e 735b 2765 5f67  log.columns['e_g
+0001be80: 6d61 6727 5d2e 6e61 6d65 203d 2027 5344  mag'].name = 'SD
+0001be90: 5353 5f47 5f65 7272 270a 2020 2020 6361  SS_G_err'.    ca
+0001bea0: 7461 6c6f 672e 636f 6c75 6d6e 735b 2772  talog.columns['r
+0001beb0: 6d61 6727 5d2e 6e61 6d65 203d 2027 5344  mag'].name = 'SD
+0001bec0: 5353 5f52 270a 2020 2020 6361 7461 6c6f  SS_R'.    catalo
+0001bed0: 672e 636f 6c75 6d6e 735b 2765 5f72 6d61  g.columns['e_rma
+0001bee0: 6727 5d2e 6e61 6d65 203d 2027 5344 5353  g'].name = 'SDSS
+0001bef0: 5f52 5f65 7272 270a 2020 2020 6361 7461  _R_err'.    cata
+0001bf00: 6c6f 672e 636f 6c75 6d6e 735b 2769 6d61  log.columns['ima
+0001bf10: 6727 5d2e 6e61 6d65 203d 2027 5344 5353  g'].name = 'SDSS
+0001bf20: 5f49 270a 2020 2020 6361 7461 6c6f 672e  _I'.    catalog.
+0001bf30: 636f 6c75 6d6e 735b 2765 5f69 6d61 6727  columns['e_imag'
+0001bf40: 5d2e 6e61 6d65 203d 2027 5344 5353 5f49  ].name = 'SDSS_I
+0001bf50: 5f65 7272 270a 2020 2020 6361 7461 6c6f  _err'.    catalo
+0001bf60: 672e 636f 6c75 6d6e 735b 277a 6d61 6727  g.columns['zmag'
+0001bf70: 5d2e 6e61 6d65 203d 2027 5344 5353 5f5a  ].name = 'SDSS_Z
+0001bf80: 270a 2020 2020 6361 7461 6c6f 672e 636f  '.    catalog.co
+0001bf90: 6c75 6d6e 735b 2765 5f7a 6d61 6727 5d2e  lumns['e_zmag'].
+0001bfa0: 6e61 6d65 203d 2027 5344 5353 5f5a 5f65  name = 'SDSS_Z_e
+0001bfb0: 7272 270a 0a20 2020 2023 2054 7275 6e63  rr'..    # Trunc
+0001bfc0: 6174 6520 6465 7363 7269 7074 696f 6e20  ate description 
+0001bfd0: 2875 7375 616c 6c79 2074 6f20 6269 6720  (usually to big 
+0001bfe0: 746f 2073 6176 6520 6173 2066 6974 7329  to save as fits)
+0001bff0: 0a20 2020 2063 6174 616c 6f67 2e6d 6574  .    catalog.met
+0001c000: 615b 2764 6573 6372 6970 7469 6f6e 275d  a['description']
+0001c010: 203d 2063 6174 616c 6f67 2e6d 6574 615b   = catalog.meta[
+0001c020: 2764 6573 6372 6970 7469 6f6e 275d 5b3a  'description'][:
+0001c030: 3535 5d0a 0a20 2020 2023 2053 6176 6520  55]..    # Save 
+0001c040: 7461 626c 6520 6173 2066 6974 730a 2020  table as fits.  
+0001c050: 2020 6361 7461 6c6f 672e 7772 6974 6528    catalog.write(
+0001c060: 7361 7665 5f66 696c 652c 206f 7665 7277  save_file, overw
+0001c070: 7269 7465 203d 2054 7275 6529 0a0a 6465  rite = True)..de
+0001c080: 6620 646f 776e 6c6f 6164 5f73 6473 7331  f download_sdss1
+0001c090: 3628 7361 7665 5f66 696c 652c 2069 6d61  6(save_file, ima
+0001c0a0: 6765 203d 204e 6f6e 652c 2066 6965 6c64  ge = None, field
+0001c0b0: 4944 5f63 6174 616c 6f67 203d 204e 6f6e  ID_catalog = Non
+0001c0c0: 6529 3a0a 2020 2020 2222 220a 2020 2020  e):.    """.    
+0001c0d0: 446f 776e 6c6f 6164 7320 7468 6520 5344  Downloads the SD
+0001c0e0: 5353 2044 5231 3620 6361 7461 6c6f 6720  SS DR16 catalog 
+0001c0f0: 6672 6f6d 2074 6865 2076 697a 6965 7220  from the vizier 
+0001c100: 6461 7461 6261 7365 2069 6e20 7468 6520  database in the 
+0001c110: 7265 6769 6f6e 0a20 2020 2063 6f76 6572  region.    cover
+0001c120: 6564 2062 7920 616e 2073 706c 7573 2069  ed by an splus i
+0001c130: 6d61 6765 2e20 4368 616e 6765 7320 636f  mage. Changes co
+0001c140: 6c75 6d6e 206e 616d 6573 2066 6f72 2074  lumn names for t
+0001c150: 6865 2066 6f72 6d61 7420 7573 6564 2062  he format used b
+0001c160: 7920 7468 650a 2020 2020 7069 7065 6c69  y the.    pipeli
+0001c170: 6e65 2c20 6465 6c65 7465 7320 756e 6e65  ne, deletes unne
+0001c180: 6365 7373 6172 7920 636f 6c75 6d6e 7320  cessary columns 
+0001c190: 616e 6420 7361 7665 7320 7265 7375 6c74  and saves result
+0001c1a0: 7320 746f 2061 2066 6974 7320 6669 6c65  s to a fits file
+0001c1b0: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+0001c1c0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+0001c1d0: 2020 2020 696d 6167 6520 3a20 7374 720a      image : str.
+0001c1e0: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
+0001c1f0: 206f 6620 7468 6520 7370 6c75 7320 696d   of the splus im
+0001c200: 6167 6520 286d 7573 7420 6265 202e 667a  age (must be .fz
+0001c210: 290a 2020 2020 7361 7665 5f66 696c 6520  ).    save_file 
+0001c220: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
+0001c230: 6361 7469 6f6e 2074 6f20 7361 7665 2074  cation to save t
+0001c240: 6865 2072 6574 7269 6576 6564 2063 6174  he retrieved cat
+0001c250: 616c 6f67 2028 6d75 7374 2062 6520 2e66  alog (must be .f
+0001c260: 6974 7329 0a0a 2020 2020 5265 7475 726e  its)..    Return
+0001c270: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
+0001c280: 2020 5361 7665 7320 6361 7461 6c6f 6720    Saves catalog 
+0001c290: 696e 2074 6865 2064 6573 6972 6564 206c  in the desired l
+0001c2a0: 6f63 6174 696f 6e0a 2020 2020 2222 220a  ocation.    """.
+0001c2b0: 0a20 2020 2023 2056 697a 6965 7220 5461  .    # Vizier Ta
+0001c2c0: 626c 650a 2020 2020 6361 745f 6964 203d  ble.    cat_id =
+0001c2d0: 2022 562f 3135 342f 7364 7373 3136 220a   "V/154/sdss16".
+0001c2e0: 0a20 2020 2063 6f6c 756d 6e73 203d 205b  .    columns = [
+0001c2f0: 275f 5241 4a32 3030 3027 2c20 275f 4445  '_RAJ2000', '_DE
+0001c300: 4a32 3030 3027 2c20 276f 626a 4944 272c  J2000', 'objID',
+0001c310: 2027 756d 6167 272c 2027 655f 756d 6167   'umag', 'e_umag
+0001c320: 272c 2027 676d 6167 272c 0a20 2020 2020  ', 'gmag',.     
+0001c330: 2020 2020 2020 2020 2020 2765 5f67 6d61            'e_gma
+0001c340: 6727 2c20 2772 6d61 6727 2c20 2765 5f72  g', 'rmag', 'e_r
+0001c350: 6d61 6727 2c20 2769 6d61 6727 2c20 2765  mag', 'imag', 'e
+0001c360: 5f69 6d61 6727 2c20 277a 6d61 6727 2c20  _imag', 'zmag', 
+0001c370: 2765 5f7a 6d61 6727 5d0a 0a20 2020 2063  'e_zmag']..    c
+0001c380: 6f6c 756d 6e5f 6669 6c74 6572 7320 3d20  olumn_filters = 
+0001c390: 7b27 636c 6173 7327 3a20 273d 3627 2c20  {'class': '=6', 
+0001c3a0: 2775 6d61 6727 3a20 273c 3130 3027 2c20  'umag': '<100', 
+0001c3b0: 2767 6d61 6727 3a20 273c 3130 3027 2c0a  'gmag': '<100',.
+0001c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c3d0: 2020 2020 2020 2772 6d61 6727 3a20 273c        'rmag': '<
+0001c3e0: 3130 3027 2c20 2769 6d61 6727 3a20 273c  100', 'imag': '<
+0001c3f0: 3130 3027 2c20 277a 6d61 6727 3a20 273c  100', 'zmag': '<
+0001c400: 3130 3027 7d0a 0a20 2020 2023 2044 6f77  100'}..    # Dow
+0001c410: 6e6c 6f61 6420 6361 7461 6c6f 670a 2020  nload catalog.  
+0001c420: 2020 6361 7461 6c6f 6720 3d20 646f 776e    catalog = down
+0001c430: 6c6f 6164 5f76 697a 6965 725f 6361 7461  load_vizier_cata
+0001c440: 6c6f 675f 666f 725f 7370 6c75 735f 6669  log_for_splus_fi
+0001c450: 656c 6428 7370 6c75 735f 696d 6167 6520  eld(splus_image 
+0001c460: 3d20 696d 6167 652c 0a20 2020 2020 2020  = image,.       
+0001c470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c490: 2020 2020 2020 2020 6669 656c 6449 445f          fieldID_
+0001c4a0: 6361 7461 6c6f 673d 6669 656c 6449 445f  catalog=fieldID_
+0001c4b0: 6361 7461 6c6f 672c 0a20 2020 2020 2020  catalog,.       
 0001c4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c4d0: 2020 2020 6669 656c 6449 445f 6361 7461      fieldID_cata
-0001c4e0: 6c6f 673d 6669 656c 6449 445f 6361 7461  log=fieldID_cata
-0001c4f0: 6c6f 672c 0a20 2020 2020 2020 2020 2020  log,.           
-0001c500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c4e0: 2020 2020 2020 2020 7669 7a69 6572 5f63          vizier_c
+0001c4f0: 6174 616c 6f67 5f69 6420 3d20 6361 745f  atalog_id = cat_
+0001c500: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
 0001c510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c520: 2020 2020 7669 7a69 6572 5f63 6174 616c      vizier_catal
-0001c530: 6f67 5f69 6420 3d20 6361 745f 6964 2c0a  og_id = cat_id,.
-0001c540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c530: 2020 2063 6f6c 756d 6e73 203d 2063 6f6c     columns = col
+0001c540: 756d 6e73 2c0a 2020 2020 2020 2020 2020  umns,.          
 0001c550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c560: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001c570: 6f6c 756d 6e73 203d 2063 6f6c 756d 6e73  olumns = columns
-0001c580: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c5b0: 2063 6f6c 756d 6e5f 6669 6c74 6572 7320   column_filters 
-0001c5c0: 3d20 636f 6c75 6d6e 5f66 696c 7465 7273  = column_filters
-0001c5d0: 290a 2020 2020 0a20 2020 2063 6174 616c  ).    .    catal
-0001c5e0: 6f67 2e63 6f6c 756d 6e73 5b27 5f52 414a  og.columns['_RAJ
-0001c5f0: 3230 3030 275d 2e6e 616d 6520 3d20 2753  2000'].name = 'S
-0001c600: 4453 5331 365f 5241 4a32 3030 3027 0a20  DSS16_RAJ2000'. 
-0001c610: 2020 2063 6174 616c 6f67 2e63 6f6c 756d     catalog.colum
-0001c620: 6e73 5b27 5f44 454a 3230 3030 275d 2e6e  ns['_DEJ2000'].n
-0001c630: 616d 6520 3d20 2753 4453 5331 365f 4445  ame = 'SDSS16_DE
-0001c640: 4a32 3030 3027 0a20 2020 2063 6174 616c  J2000'.    catal
-0001c650: 6f67 2e63 6f6c 756d 6e73 5b27 6f62 6a49  og.columns['objI
-0001c660: 4427 5d2e 6e61 6d65 203d 2027 5344 5353  D'].name = 'SDSS
-0001c670: 3136 5f6f 626a 4944 270a 2020 2020 6361  16_objID'.    ca
-0001c680: 7461 6c6f 672e 636f 6c75 6d6e 735b 2775  talog.columns['u
-0001c690: 6d61 6727 5d2e 6e61 6d65 203d 2027 5344  mag'].name = 'SD
-0001c6a0: 5353 5f55 270a 2020 2020 6361 7461 6c6f  SS_U'.    catalo
-0001c6b0: 672e 636f 6c75 6d6e 735b 2765 5f75 6d61  g.columns['e_uma
-0001c6c0: 6727 5d2e 6e61 6d65 203d 2027 5344 5353  g'].name = 'SDSS
-0001c6d0: 5f55 5f65 7272 270a 2020 2020 6361 7461  _U_err'.    cata
-0001c6e0: 6c6f 672e 636f 6c75 6d6e 735b 2767 6d61  log.columns['gma
-0001c6f0: 6727 5d2e 6e61 6d65 203d 2027 5344 5353  g'].name = 'SDSS
-0001c700: 5f47 270a 2020 2020 6361 7461 6c6f 672e  _G'.    catalog.
-0001c710: 636f 6c75 6d6e 735b 2765 5f67 6d61 6727  columns['e_gmag'
-0001c720: 5d2e 6e61 6d65 203d 2027 5344 5353 5f47  ].name = 'SDSS_G
-0001c730: 5f65 7272 270a 2020 2020 6361 7461 6c6f  _err'.    catalo
-0001c740: 672e 636f 6c75 6d6e 735b 2772 6d61 6727  g.columns['rmag'
-0001c750: 5d2e 6e61 6d65 203d 2027 5344 5353 5f52  ].name = 'SDSS_R
-0001c760: 270a 2020 2020 6361 7461 6c6f 672e 636f  '.    catalog.co
-0001c770: 6c75 6d6e 735b 2765 5f72 6d61 6727 5d2e  lumns['e_rmag'].
-0001c780: 6e61 6d65 203d 2027 5344 5353 5f52 5f65  name = 'SDSS_R_e
-0001c790: 7272 270a 2020 2020 6361 7461 6c6f 672e  rr'.    catalog.
-0001c7a0: 636f 6c75 6d6e 735b 2769 6d61 6727 5d2e  columns['imag'].
-0001c7b0: 6e61 6d65 203d 2027 5344 5353 5f49 270a  name = 'SDSS_I'.
-0001c7c0: 2020 2020 6361 7461 6c6f 672e 636f 6c75      catalog.colu
-0001c7d0: 6d6e 735b 2765 5f69 6d61 6727 5d2e 6e61  mns['e_imag'].na
-0001c7e0: 6d65 203d 2027 5344 5353 5f49 5f65 7272  me = 'SDSS_I_err
-0001c7f0: 270a 2020 2020 6361 7461 6c6f 672e 636f  '.    catalog.co
-0001c800: 6c75 6d6e 735b 277a 6d61 6727 5d2e 6e61  lumns['zmag'].na
-0001c810: 6d65 203d 2027 5344 5353 5f5a 270a 2020  me = 'SDSS_Z'.  
-0001c820: 2020 6361 7461 6c6f 672e 636f 6c75 6d6e    catalog.column
-0001c830: 735b 2765 5f7a 6d61 6727 5d2e 6e61 6d65  s['e_zmag'].name
-0001c840: 203d 2027 5344 5353 5f5a 5f65 7272 270a   = 'SDSS_Z_err'.
-0001c850: 0a20 2020 2023 2054 7275 6e63 6174 6520  .    # Truncate 
-0001c860: 6465 7363 7269 7074 696f 6e20 2875 7375  description (usu
-0001c870: 616c 6c79 2074 6f20 6269 6720 746f 2073  ally to big to s
-0001c880: 6176 6520 6173 2066 6974 7329 0a20 2020  ave as fits).   
-0001c890: 2063 6174 616c 6f67 2e6d 6574 615b 2764   catalog.meta['d
-0001c8a0: 6573 6372 6970 7469 6f6e 275d 203d 2063  escription'] = c
-0001c8b0: 6174 616c 6f67 2e6d 6574 615b 2764 6573  atalog.meta['des
-0001c8c0: 6372 6970 7469 6f6e 275d 5b3a 3535 5d0a  cription'][:55].
-0001c8d0: 0a20 2020 2023 2053 6176 6520 7461 626c  .    # Save tabl
-0001c8e0: 6520 6173 2066 6974 730a 2020 2020 6361  e as fits.    ca
-0001c8f0: 7461 6c6f 672e 7772 6974 6528 7361 7665  talog.write(save
-0001c900: 5f66 696c 652c 206f 7665 7277 7269 7465  _file, overwrite
-0001c910: 203d 2054 7275 6529 0a0a 0a64 6566 2064   = True)...def d
-0001c920: 6f77 6e6c 6f61 645f 6761 6961 6472 3228  ownload_gaiadr2(
-0001c930: 7361 7665 5f66 696c 652c 2069 6d61 6765  save_file, image
-0001c940: 203d 204e 6f6e 652c 2066 6965 6c64 4944   = None, fieldID
-0001c950: 5f63 6174 616c 6f67 203d 204e 6f6e 6529  _catalog = None)
-0001c960: 3a0a 2020 2020 2222 220a 2020 2020 446f  :.    """.    Do
-0001c970: 776e 6c6f 6164 7320 7468 6520 4761 6961  wnloads the Gaia
-0001c980: 2045 4452 3320 6361 7461 6c6f 6720 6672   EDR3 catalog fr
-0001c990: 6f6d 2074 6865 2076 697a 6965 7220 6461  om the vizier da
-0001c9a0: 7461 6261 7365 2069 6e20 7468 6520 7265  tabase in the re
-0001c9b0: 6769 6f6e 0a20 2020 2063 6f76 6572 6564  gion.    covered
-0001c9c0: 2062 7920 616e 2073 706c 7573 2069 6d61   by an splus ima
-0001c9d0: 6765 2e20 4368 616e 6765 7320 636f 6c75  ge. Changes colu
-0001c9e0: 6d6e 206e 616d 6573 2066 6f72 2074 6865  mn names for the
-0001c9f0: 2066 6f72 6d61 7420 7573 6564 2062 7920   format used by 
-0001ca00: 7468 650a 2020 2020 7069 7065 6c69 6e65  the.    pipeline
-0001ca10: 2c20 6465 6c65 7465 7320 756e 6e65 6365  , deletes unnece
-0001ca20: 7373 6172 7920 636f 6c75 6d6e 7320 616e  ssary columns an
-0001ca30: 6420 7361 7665 7320 7265 7375 6c74 7320  d saves results 
-0001ca40: 746f 2061 2066 6974 7320 6669 6c65 0a0a  to a fits file..
-0001ca50: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-0001ca60: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-0001ca70: 2020 696d 6167 6520 3a20 7374 720a 2020    image : str.  
-0001ca80: 2020 2020 2020 4c6f 6361 7469 6f6e 206f        Location o
-0001ca90: 6620 7468 6520 7370 6c75 7320 696d 6167  f the splus imag
-0001caa0: 6520 286d 7573 7420 6265 202e 667a 290a  e (must be .fz).
-0001cab0: 2020 2020 7361 7665 5f66 696c 6520 3a20      save_file : 
-0001cac0: 7374 720a 2020 2020 2020 2020 4c6f 6361  str.        Loca
-0001cad0: 7469 6f6e 2074 6f20 7361 7665 2074 6865  tion to save the
-0001cae0: 2072 6574 7269 6576 6564 2063 6174 616c   retrieved catal
-0001caf0: 6f67 2028 6d75 7374 2062 6520 2e66 6974  og (must be .fit
-0001cb00: 7329 0a0a 2020 2020 5265 7475 726e 730a  s)..    Returns.
-0001cb10: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-0001cb20: 5361 7665 7320 6361 7461 6c6f 6720 696e  Saves catalog in
-0001cb30: 2074 6865 2064 6573 6972 6564 206c 6f63   the desired loc
-0001cb40: 6174 696f 6e0a 2020 2020 2222 220a 0a20  ation.    """.. 
-0001cb50: 2020 2023 2056 697a 6965 7220 5461 626c     # Vizier Tabl
-0001cb60: 650a 2020 2020 6361 745f 6964 203d 2022  e.    cat_id = "
-0001cb70: 492f 3334 352f 6761 6961 3222 0a0a 2020  I/345/gaia2"..  
-0001cb80: 2020 636f 6c75 6d6e 7320 3d20 5b27 5241    columns = ['RA
-0001cb90: 5f49 4352 5327 2c20 2744 455f 4943 5253  _ICRS', 'DE_ICRS
-0001cba0: 272c 2027 536f 7572 6365 272c 2027 506c  ', 'Source', 'Pl
-0001cbb0: 7827 2c20 2765 5f50 6c78 272c 2027 706d  x', 'e_Plx', 'pm
-0001cbc0: 5241 272c 2027 706d 4445 272c 0a20 2020  RA', 'pmDE',.   
-0001cbd0: 2020 2020 2020 2020 2020 2020 2747 6d61              'Gma
-0001cbe0: 6727 2c20 2765 5f47 6d61 6727 2c20 2742  g', 'e_Gmag', 'B
-0001cbf0: 506d 6167 272c 2027 655f 4250 6d61 6727  Pmag', 'e_BPmag'
-0001cc00: 2c20 2752 506d 6167 272c 2027 655f 5250  , 'RPmag', 'e_RP
-0001cc10: 6d61 6727 2c0a 2020 2020 2020 2020 2020  mag',.          
-0001cc20: 2020 2020 2027 4147 275d 0a0a 2020 2020       'AG']..    
-0001cc30: 636f 6c75 6d6e 5f66 696c 7465 7273 203d  column_filters =
-0001cc40: 207b 2750 6c78 273a 2027 3e30 272c 2027   {'Plx': '>0', '
-0001cc50: 5250 6c78 273a 2027 3e35 272c 0a20 2020  RPlx': '>5',.   
-0001cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc70: 2020 2027 476d 6167 273a 2027 3c33 3027     'Gmag': '<30'
-0001cc80: 2c20 2742 506d 6167 273a 2027 3c33 3027  , 'BPmag': '<30'
-0001cc90: 2c20 2752 506d 6167 273a 2027 3c33 3027  , 'RPmag': '<30'
-0001cca0: 7d0a 0a20 2020 2023 2044 6f77 6e6c 6f61  }..    # Downloa
-0001ccb0: 6420 6361 7461 6c6f 670a 2020 2020 6361  d catalog.    ca
-0001ccc0: 7461 6c6f 6720 3d20 646f 776e 6c6f 6164  talog = download
-0001ccd0: 5f76 697a 6965 725f 6361 7461 6c6f 675f  _vizier_catalog_
-0001cce0: 666f 725f 7370 6c75 735f 6669 656c 6428  for_splus_field(
-0001ccf0: 7370 6c75 735f 696d 6167 6520 3d20 696d  splus_image = im
-0001cd00: 6167 652c 0a20 2020 2020 2020 2020 2020  age,.           
-0001cd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c570: 2020 2020 2063 6f6c 756d 6e5f 6669 6c74       column_filt
+0001c580: 6572 7320 3d20 636f 6c75 6d6e 5f66 696c  ers = column_fil
+0001c590: 7465 7273 290a 2020 2020 0a20 2020 2063  ters).    .    c
+0001c5a0: 6174 616c 6f67 2e63 6f6c 756d 6e73 5b27  atalog.columns['
+0001c5b0: 5f52 414a 3230 3030 275d 2e6e 616d 6520  _RAJ2000'].name 
+0001c5c0: 3d20 2753 4453 5331 365f 5241 4a32 3030  = 'SDSS16_RAJ200
+0001c5d0: 3027 0a20 2020 2063 6174 616c 6f67 2e63  0'.    catalog.c
+0001c5e0: 6f6c 756d 6e73 5b27 5f44 454a 3230 3030  olumns['_DEJ2000
+0001c5f0: 275d 2e6e 616d 6520 3d20 2753 4453 5331  '].name = 'SDSS1
+0001c600: 365f 4445 4a32 3030 3027 0a20 2020 2063  6_DEJ2000'.    c
+0001c610: 6174 616c 6f67 2e63 6f6c 756d 6e73 5b27  atalog.columns['
+0001c620: 6f62 6a49 4427 5d2e 6e61 6d65 203d 2027  objID'].name = '
+0001c630: 5344 5353 3136 5f6f 626a 4944 270a 2020  SDSS16_objID'.  
+0001c640: 2020 6361 7461 6c6f 672e 636f 6c75 6d6e    catalog.column
+0001c650: 735b 2775 6d61 6727 5d2e 6e61 6d65 203d  s['umag'].name =
+0001c660: 2027 5344 5353 5f55 270a 2020 2020 6361   'SDSS_U'.    ca
+0001c670: 7461 6c6f 672e 636f 6c75 6d6e 735b 2765  talog.columns['e
+0001c680: 5f75 6d61 6727 5d2e 6e61 6d65 203d 2027  _umag'].name = '
+0001c690: 5344 5353 5f55 5f65 7272 270a 2020 2020  SDSS_U_err'.    
+0001c6a0: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
+0001c6b0: 2767 6d61 6727 5d2e 6e61 6d65 203d 2027  'gmag'].name = '
+0001c6c0: 5344 5353 5f47 270a 2020 2020 6361 7461  SDSS_G'.    cata
+0001c6d0: 6c6f 672e 636f 6c75 6d6e 735b 2765 5f67  log.columns['e_g
+0001c6e0: 6d61 6727 5d2e 6e61 6d65 203d 2027 5344  mag'].name = 'SD
+0001c6f0: 5353 5f47 5f65 7272 270a 2020 2020 6361  SS_G_err'.    ca
+0001c700: 7461 6c6f 672e 636f 6c75 6d6e 735b 2772  talog.columns['r
+0001c710: 6d61 6727 5d2e 6e61 6d65 203d 2027 5344  mag'].name = 'SD
+0001c720: 5353 5f52 270a 2020 2020 6361 7461 6c6f  SS_R'.    catalo
+0001c730: 672e 636f 6c75 6d6e 735b 2765 5f72 6d61  g.columns['e_rma
+0001c740: 6727 5d2e 6e61 6d65 203d 2027 5344 5353  g'].name = 'SDSS
+0001c750: 5f52 5f65 7272 270a 2020 2020 6361 7461  _R_err'.    cata
+0001c760: 6c6f 672e 636f 6c75 6d6e 735b 2769 6d61  log.columns['ima
+0001c770: 6727 5d2e 6e61 6d65 203d 2027 5344 5353  g'].name = 'SDSS
+0001c780: 5f49 270a 2020 2020 6361 7461 6c6f 672e  _I'.    catalog.
+0001c790: 636f 6c75 6d6e 735b 2765 5f69 6d61 6727  columns['e_imag'
+0001c7a0: 5d2e 6e61 6d65 203d 2027 5344 5353 5f49  ].name = 'SDSS_I
+0001c7b0: 5f65 7272 270a 2020 2020 6361 7461 6c6f  _err'.    catalo
+0001c7c0: 672e 636f 6c75 6d6e 735b 277a 6d61 6727  g.columns['zmag'
+0001c7d0: 5d2e 6e61 6d65 203d 2027 5344 5353 5f5a  ].name = 'SDSS_Z
+0001c7e0: 270a 2020 2020 6361 7461 6c6f 672e 636f  '.    catalog.co
+0001c7f0: 6c75 6d6e 735b 2765 5f7a 6d61 6727 5d2e  lumns['e_zmag'].
+0001c800: 6e61 6d65 203d 2027 5344 5353 5f5a 5f65  name = 'SDSS_Z_e
+0001c810: 7272 270a 0a20 2020 2023 2054 7275 6e63  rr'..    # Trunc
+0001c820: 6174 6520 6465 7363 7269 7074 696f 6e20  ate description 
+0001c830: 2875 7375 616c 6c79 2074 6f20 6269 6720  (usually to big 
+0001c840: 746f 2073 6176 6520 6173 2066 6974 7329  to save as fits)
+0001c850: 0a20 2020 2063 6174 616c 6f67 2e6d 6574  .    catalog.met
+0001c860: 615b 2764 6573 6372 6970 7469 6f6e 275d  a['description']
+0001c870: 203d 2063 6174 616c 6f67 2e6d 6574 615b   = catalog.meta[
+0001c880: 2764 6573 6372 6970 7469 6f6e 275d 5b3a  'description'][:
+0001c890: 3535 5d0a 0a20 2020 2023 2053 6176 6520  55]..    # Save 
+0001c8a0: 7461 626c 6520 6173 2066 6974 730a 2020  table as fits.  
+0001c8b0: 2020 6361 7461 6c6f 672e 7772 6974 6528    catalog.write(
+0001c8c0: 7361 7665 5f66 696c 652c 206f 7665 7277  save_file, overw
+0001c8d0: 7269 7465 203d 2054 7275 6529 0a0a 0a64  rite = True)...d
+0001c8e0: 6566 2064 6f77 6e6c 6f61 645f 6761 6961  ef download_gaia
+0001c8f0: 6472 3228 7361 7665 5f66 696c 652c 2069  dr2(save_file, i
+0001c900: 6d61 6765 203d 204e 6f6e 652c 2066 6965  mage = None, fie
+0001c910: 6c64 4944 5f63 6174 616c 6f67 203d 204e  ldID_catalog = N
+0001c920: 6f6e 6529 3a0a 2020 2020 2222 220a 2020  one):.    """.  
+0001c930: 2020 446f 776e 6c6f 6164 7320 7468 6520    Downloads the 
+0001c940: 4761 6961 2045 4452 3320 6361 7461 6c6f  Gaia EDR3 catalo
+0001c950: 6720 6672 6f6d 2074 6865 2076 697a 6965  g from the vizie
+0001c960: 7220 6461 7461 6261 7365 2069 6e20 7468  r database in th
+0001c970: 6520 7265 6769 6f6e 0a20 2020 2063 6f76  e region.    cov
+0001c980: 6572 6564 2062 7920 616e 2073 706c 7573  ered by an splus
+0001c990: 2069 6d61 6765 2e20 4368 616e 6765 7320   image. Changes 
+0001c9a0: 636f 6c75 6d6e 206e 616d 6573 2066 6f72  column names for
+0001c9b0: 2074 6865 2066 6f72 6d61 7420 7573 6564   the format used
+0001c9c0: 2062 7920 7468 650a 2020 2020 7069 7065   by the.    pipe
+0001c9d0: 6c69 6e65 2c20 6465 6c65 7465 7320 756e  line, deletes un
+0001c9e0: 6e65 6365 7373 6172 7920 636f 6c75 6d6e  necessary column
+0001c9f0: 7320 616e 6420 7361 7665 7320 7265 7375  s and saves resu
+0001ca00: 6c74 7320 746f 2061 2066 6974 7320 6669  lts to a fits fi
+0001ca10: 6c65 0a0a 2020 2020 5061 7261 6d65 7465  le..    Paramete
+0001ca20: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+0001ca30: 2d0a 2020 2020 696d 6167 6520 3a20 7374  -.    image : st
+0001ca40: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
+0001ca50: 6f6e 206f 6620 7468 6520 7370 6c75 7320  on of the splus 
+0001ca60: 696d 6167 6520 286d 7573 7420 6265 202e  image (must be .
+0001ca70: 667a 290a 2020 2020 7361 7665 5f66 696c  fz).    save_fil
+0001ca80: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
+0001ca90: 4c6f 6361 7469 6f6e 2074 6f20 7361 7665  Location to save
+0001caa0: 2074 6865 2072 6574 7269 6576 6564 2063   the retrieved c
+0001cab0: 6174 616c 6f67 2028 6d75 7374 2062 6520  atalog (must be 
+0001cac0: 2e66 6974 7329 0a0a 2020 2020 5265 7475  .fits)..    Retu
+0001cad0: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+0001cae0: 2020 2020 5361 7665 7320 6361 7461 6c6f      Saves catalo
+0001caf0: 6720 696e 2074 6865 2064 6573 6972 6564  g in the desired
+0001cb00: 206c 6f63 6174 696f 6e0a 2020 2020 2222   location.    ""
+0001cb10: 220a 0a20 2020 2023 2056 697a 6965 7220  "..    # Vizier 
+0001cb20: 5461 626c 650a 2020 2020 6361 745f 6964  Table.    cat_id
+0001cb30: 203d 2022 492f 3334 352f 6761 6961 3222   = "I/345/gaia2"
+0001cb40: 0a0a 2020 2020 636f 6c75 6d6e 7320 3d20  ..    columns = 
+0001cb50: 5b27 5241 5f49 4352 5327 2c20 2744 455f  ['RA_ICRS', 'DE_
+0001cb60: 4943 5253 272c 2027 536f 7572 6365 272c  ICRS', 'Source',
+0001cb70: 2027 506c 7827 2c20 2765 5f50 6c78 272c   'Plx', 'e_Plx',
+0001cb80: 2027 706d 5241 272c 2027 706d 4445 272c   'pmRA', 'pmDE',
+0001cb90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cba0: 2747 6d61 6727 2c20 2765 5f47 6d61 6727  'Gmag', 'e_Gmag'
+0001cbb0: 2c20 2742 506d 6167 272c 2027 655f 4250  , 'BPmag', 'e_BP
+0001cbc0: 6d61 6727 2c20 2752 506d 6167 272c 2027  mag', 'RPmag', '
+0001cbd0: 655f 5250 6d61 6727 2c0a 2020 2020 2020  e_RPmag',.      
+0001cbe0: 2020 2020 2020 2020 2027 4147 275d 0a0a           'AG']..
+0001cbf0: 2020 2020 636f 6c75 6d6e 5f66 696c 7465      column_filte
+0001cc00: 7273 203d 207b 2750 6c78 273a 2027 3e30  rs = {'Plx': '>0
+0001cc10: 272c 2027 5250 6c78 273a 2027 3e35 272c  ', 'RPlx': '>5',
+0001cc20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cc30: 2020 2020 2020 2027 476d 6167 273a 2027         'Gmag': '
+0001cc40: 3c33 3027 2c20 2742 506d 6167 273a 2027  <30', 'BPmag': '
+0001cc50: 3c33 3027 2c20 2752 506d 6167 273a 2027  <30', 'RPmag': '
+0001cc60: 3c33 3027 7d0a 0a20 2020 2023 2044 6f77  <30'}..    # Dow
+0001cc70: 6e6c 6f61 6420 6361 7461 6c6f 670a 2020  nload catalog.  
+0001cc80: 2020 6361 7461 6c6f 6720 3d20 646f 776e    catalog = down
+0001cc90: 6c6f 6164 5f76 697a 6965 725f 6361 7461  load_vizier_cata
+0001cca0: 6c6f 675f 666f 725f 7370 6c75 735f 6669  log_for_splus_fi
+0001ccb0: 656c 6428 7370 6c75 735f 696d 6167 6520  eld(splus_image 
+0001ccc0: 3d20 696d 6167 652c 0a20 2020 2020 2020  = image,.       
+0001ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ccf0: 2020 2020 2020 2020 6669 656c 6449 445f          fieldID_
+0001cd00: 6361 7461 6c6f 673d 6669 656c 6449 445f  catalog=fieldID_
+0001cd10: 6361 7461 6c6f 672c 0a20 2020 2020 2020  catalog,.       
 0001cd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd30: 2020 2020 6669 656c 6449 445f 6361 7461      fieldID_cata
-0001cd40: 6c6f 673d 6669 656c 6449 445f 6361 7461  log=fieldID_cata
-0001cd50: 6c6f 672c 0a20 2020 2020 2020 2020 2020  log,.           
-0001cd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd40: 2020 2020 2020 2020 7669 7a69 6572 5f63          vizier_c
+0001cd50: 6174 616c 6f67 5f69 6420 3d20 6361 745f  atalog_id = cat_
+0001cd60: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
 0001cd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd80: 2020 2020 7669 7a69 6572 5f63 6174 616c      vizier_catal
-0001cd90: 6f67 5f69 6420 3d20 6361 745f 6964 2c0a  og_id = cat_id,.
-0001cda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd90: 2020 2063 6f6c 756d 6e73 203d 2063 6f6c     columns = col
+0001cda0: 756d 6e73 2c0a 2020 2020 2020 2020 2020  umns,.          
 0001cdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cdc0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001cdd0: 6f6c 756d 6e73 203d 2063 6f6c 756d 6e73  olumns = columns
-0001cde0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001cdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ce00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ce10: 2063 6f6c 756d 6e5f 6669 6c74 6572 7320   column_filters 
-0001ce20: 3d20 636f 6c75 6d6e 5f66 696c 7465 7273  = column_filters
-0001ce30: 290a 0a20 2020 2023 2323 2323 2323 2323  )..    #########
-0001ce40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001ce50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001ce60: 2323 2323 2323 0a20 2020 2023 2043 6f76  ######.    # Cov
-0001ce70: 6572 7420 636f 6f72 6469 6e61 7465 7320  ert coordinates 
-0001ce80: 6672 6f6d 2045 504f 4348 2032 3031 3620  from EPOCH 2016 
-0001ce90: 746f 204a 3230 3030 0a20 2020 2072 615f  to J2000.    ra_
-0001cea0: 6963 7273 203d 2063 6174 616c 6f67 2e63  icrs = catalog.c
-0001ceb0: 6f6c 756d 6e73 5b27 5241 5f49 4352 5327  olumns['RA_ICRS'
-0001cec0: 5d0a 2020 2020 6465 5f69 6372 7320 3d20  ].    de_icrs = 
-0001ced0: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
-0001cee0: 2744 455f 4943 5253 275d 0a20 2020 2070  'DE_ICRS'].    p
-0001cef0: 6d72 6120 2020 203d 2063 6174 616c 6f67  mra    = catalog
-0001cf00: 2e63 6f6c 756d 6e73 5b27 706d 5241 275d  .columns['pmRA']
-0001cf10: 0a20 2020 2070 6d64 6520 2020 203d 2063  .    pmde    = c
-0001cf20: 6174 616c 6f67 2e63 6f6c 756d 6e73 5b27  atalog.columns['
-0001cf30: 706d 4445 275d 0a20 2020 2070 6c78 2020  pmDE'].    plx  
-0001cf40: 2020 203d 206e 702e 6172 7261 7928 6361     = np.array(ca
-0001cf50: 7461 6c6f 672e 636f 6c75 6d6e 735b 2750  talog.columns['P
-0001cf60: 6c78 275d 290a 0a20 2020 2063 203d 2053  lx'])..    c = S
-0001cf70: 6b79 436f 6f72 6428 7261 3d72 615f 6963  kyCoord(ra=ra_ic
-0001cf80: 7273 2c20 6465 633d 6465 5f69 6372 732c  rs, dec=de_icrs,
-0001cf90: 2066 7261 6d65 3d27 6963 7273 272c 0a20   frame='icrs',. 
-0001cfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cfb0: 706d 5f72 615f 636f 7364 6563 3d20 706d  pm_ra_cosdec= pm
-0001cfc0: 7261 2c20 706d 5f64 6563 203d 2070 6d64  ra, pm_dec = pmd
-0001cfd0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001cfe0: 2020 2020 6469 7374 616e 6365 203d 2044      distance = D
-0001cff0: 6973 7461 6e63 6528 7061 7261 6c6c 6178  istance(parallax
-0001d000: 3d70 6c78 2a75 2e6d 6173 2c20 616c 6c6f  =plx*u.mas, allo
-0001d010: 775f 6e65 6761 7469 7665 3d54 7275 6529  w_negative=True)
-0001d020: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001d030: 2020 206f 6273 7469 6d65 203d 2054 696d     obstime = Tim
-0001d040: 6528 3230 3136 2c20 666f 726d 6174 3d27  e(2016, format='
-0001d050: 6a79 6561 7227 2929 0a0a 2020 2020 2320  jyear'))..    # 
-0001d060: 436f 6e76 6572 7420 6570 6f63 6820 6672  Convert epoch fr
-0001d070: 6f6d 2032 3031 352e 3520 746f 204a 3230  om 2015.5 to J20
-0001d080: 3030 0a20 2020 2063 5f6a 3230 3030 203d  00.    c_j2000 =
-0001d090: 2063 2e61 7070 6c79 5f73 7061 6365 5f6d   c.apply_space_m
-0001d0a0: 6f74 696f 6e28 5469 6d65 2832 3030 302e  otion(Time(2000.
-0001d0b0: 302c 2066 6f72 6d61 743d 276a 7965 6172  0, format='jyear
-0001d0c0: 2729 290a 0a20 2020 2023 2047 6574 2052  '))..    # Get R
-0001d0d0: 4120 616e 6420 4445 430a 2020 2020 7261  A and DEC.    ra
-0001d0e0: 203d 206e 702e 6172 7261 7928 635f 6a32   = np.array(c_j2
-0001d0f0: 3030 302e 7261 290a 2020 2020 6465 203d  000.ra).    de =
-0001d100: 206e 702e 6172 7261 7928 635f 6a32 3030   np.array(c_j200
-0001d110: 302e 6465 6329 0a0a 2020 2020 2323 2323  0.dec)..    ####
-0001d120: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001d130: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
-0001d140: 2041 6464 2052 4120 616e 6420 4445 4320   Add RA and DEC 
-0001d150: 4a32 3030 3020 636f 6c75 6d6e 730a 2020  J2000 columns.  
-0001d160: 2020 6361 7461 6c6f 675b 2747 4149 4144    catalog['GAIAD
-0001d170: 5232 5f52 414a 3230 3030 275d 203d 2072  R2_RAJ2000'] = r
-0001d180: 610a 2020 2020 6361 7461 6c6f 675b 2747  a.    catalog['G
-0001d190: 4149 4144 5232 5f44 454a 3230 3030 275d  AIADR2_DEJ2000']
-0001d1a0: 203d 2064 650a 0a20 2020 2023 2052 656e   = de..    # Ren
-0001d1b0: 616d 6520 636f 6c75 6d6e 730a 2020 2020  ame columns.    
-0001d1c0: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
-0001d1d0: 2753 6f75 7263 6527 5d2e 6e61 6d65 203d  'Source'].name =
-0001d1e0: 2027 4741 4941 5f49 4427 0a0a 2020 2020   'GAIA_ID'..    
-0001d1f0: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
-0001d200: 2747 6d61 6727 5d2e 6e61 6d65 203d 2027  'Gmag'].name = '
-0001d210: 4741 4941 5f47 270a 2020 2020 6361 7461  GAIA_G'.    cata
-0001d220: 6c6f 672e 636f 6c75 6d6e 735b 2765 5f47  log.columns['e_G
-0001d230: 6d61 6727 5d2e 6e61 6d65 203d 2027 4741  mag'].name = 'GA
-0001d240: 4941 5f47 5f65 7272 270a 2020 2020 6361  IA_G_err'.    ca
-0001d250: 7461 6c6f 672e 636f 6c75 6d6e 735b 2742  talog.columns['B
-0001d260: 506d 6167 275d 2e6e 616d 6520 3d20 2747  Pmag'].name = 'G
-0001d270: 4149 415f 4250 270a 2020 2020 6361 7461  AIA_BP'.    cata
-0001d280: 6c6f 672e 636f 6c75 6d6e 735b 2765 5f42  log.columns['e_B
-0001d290: 506d 6167 275d 2e6e 616d 6520 3d20 2747  Pmag'].name = 'G
-0001d2a0: 4149 415f 4250 5f65 7272 270a 2020 2020  AIA_BP_err'.    
-0001d2b0: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
-0001d2c0: 2752 506d 6167 275d 2e6e 616d 6520 3d20  'RPmag'].name = 
-0001d2d0: 2747 4149 415f 5250 270a 2020 2020 6361  'GAIA_RP'.    ca
-0001d2e0: 7461 6c6f 672e 636f 6c75 6d6e 735b 2765  talog.columns['e
-0001d2f0: 5f52 506d 6167 275d 2e6e 616d 6520 3d20  _RPmag'].name = 
-0001d300: 2747 4149 415f 5250 5f65 7272 270a 0a20  'GAIA_RP_err'.. 
-0001d310: 2020 2063 6174 616c 6f67 2e63 6f6c 756d     catalog.colum
-0001d320: 6e73 5b27 4147 275d 2e6e 616d 6520 3d20  ns['AG'].name = 
-0001d330: 2747 4149 415f 4147 270a 0a20 2020 2023  'GAIA_AG'..    #
-0001d340: 2054 7275 6e63 6174 6520 6465 7363 7269   Truncate descri
-0001d350: 7074 696f 6e20 2875 7375 616c 6c79 2074  ption (usually t
-0001d360: 6f20 6269 6720 746f 2073 6176 6520 6173  o big to save as
-0001d370: 2066 6974 7329 0a20 2020 2063 6174 616c   fits).    catal
-0001d380: 6f67 2e6d 6574 615b 2764 6573 6372 6970  og.meta['descrip
-0001d390: 7469 6f6e 275d 203d 2063 6174 616c 6f67  tion'] = catalog
-0001d3a0: 2e6d 6574 615b 2764 6573 6372 6970 7469  .meta['descripti
-0001d3b0: 6f6e 275d 5b3a 3535 5d0a 0a20 2020 2023  on'][:55]..    #
-0001d3c0: 2053 6176 6520 7461 626c 6520 6173 2066   Save table as f
-0001d3d0: 6974 730a 2020 2020 6361 7461 6c6f 672e  its.    catalog.
-0001d3e0: 7772 6974 6528 7361 7665 5f66 696c 652c  write(save_file,
-0001d3f0: 206f 7665 7277 7269 7465 203d 2054 7275   overwrite = Tru
-0001d400: 6529 0a0a 0a64 6566 2064 6f77 6e6c 6f61  e)...def downloa
-0001d410: 645f 6761 6961 2873 6176 655f 6669 6c65  d_gaia(save_file
-0001d420: 2c20 696d 6167 6520 3d20 4e6f 6e65 2c20  , image = None, 
-0001d430: 6669 656c 6449 445f 6361 7461 6c6f 6720  fieldID_catalog 
-0001d440: 3d20 4e6f 6e65 293a 0a20 2020 2022 2222  = None):.    """
-0001d450: 0a20 2020 2044 6f77 6e6c 6f61 6473 2074  .    Downloads t
-0001d460: 6865 2047 6169 6120 4544 5233 2063 6174  he Gaia EDR3 cat
-0001d470: 616c 6f67 2066 726f 6d20 7468 6520 7669  alog from the vi
-0001d480: 7a69 6572 2064 6174 6162 6173 6520 696e  zier database in
-0001d490: 2074 6865 2072 6567 696f 6e0a 2020 2020   the region.    
-0001d4a0: 636f 7665 7265 6420 6279 2061 6e20 7370  covered by an sp
-0001d4b0: 6c75 7320 696d 6167 652e 2043 6861 6e67  lus image. Chang
-0001d4c0: 6573 2063 6f6c 756d 6e20 6e61 6d65 7320  es column names 
-0001d4d0: 666f 7220 7468 6520 666f 726d 6174 2075  for the format u
-0001d4e0: 7365 6420 6279 2074 6865 0a20 2020 2070  sed by the.    p
-0001d4f0: 6970 656c 696e 652c 2064 656c 6574 6573  ipeline, deletes
-0001d500: 2075 6e6e 6563 6573 7361 7279 2063 6f6c   unnecessary col
-0001d510: 756d 6e73 2061 6e64 2073 6176 6573 2072  umns and saves r
-0001d520: 6573 756c 7473 2074 6f20 6120 6669 7473  esults to a fits
-0001d530: 2066 696c 650a 0a20 2020 2050 6172 616d   file..    Param
-0001d540: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
-0001d550: 2d2d 2d2d 0a20 2020 2069 6d61 6765 203a  ----.    image :
-0001d560: 2073 7472 0a20 2020 2020 2020 204c 6f63   str.        Loc
-0001d570: 6174 696f 6e20 6f66 2074 6865 2073 706c  ation of the spl
-0001d580: 7573 2069 6d61 6765 2028 6d75 7374 2062  us image (must b
-0001d590: 6520 2e66 7a29 0a20 2020 2073 6176 655f  e .fz).    save_
-0001d5a0: 6669 6c65 203a 2073 7472 0a20 2020 2020  file : str.     
-0001d5b0: 2020 204c 6f63 6174 696f 6e20 746f 2073     Location to s
-0001d5c0: 6176 6520 7468 6520 7265 7472 6965 7665  ave the retrieve
-0001d5d0: 6420 6361 7461 6c6f 6720 286d 7573 7420  d catalog (must 
-0001d5e0: 6265 202e 6669 7473 290a 0a20 2020 2052  be .fits)..    R
-0001d5f0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
-0001d600: 2d2d 0a20 2020 2053 6176 6573 2063 6174  --.    Saves cat
-0001d610: 616c 6f67 2069 6e20 7468 6520 6465 7369  alog in the desi
-0001d620: 7265 6420 6c6f 6361 7469 6f6e 0a20 2020  red location.   
-0001d630: 2022 2222 0a0a 2020 2020 2320 5669 7a69   """..    # Vizi
-0001d640: 6572 2054 6162 6c65 0a20 2020 2063 6174  er Table.    cat
-0001d650: 5f69 6420 3d20 2249 2f33 3530 2f67 6169  _id = "I/350/gai
-0001d660: 6165 6472 3322 0a0a 2020 2020 636f 6c75  aedr3"..    colu
-0001d670: 6d6e 7320 3d20 5b27 5241 5f49 4352 5327  mns = ['RA_ICRS'
-0001d680: 2c20 2744 455f 4943 5253 272c 2027 536f  , 'DE_ICRS', 'So
-0001d690: 7572 6365 272c 2027 506c 7827 2c20 2770  urce', 'Plx', 'p
-0001d6a0: 6d52 4127 2c20 2770 6d44 4527 2c0a 2020  mRA', 'pmDE',.  
-0001d6b0: 2020 2020 2020 2020 2020 2020 2027 476d               'Gm
-0001d6c0: 6167 272c 2027 655f 476d 6167 272c 2027  ag', 'e_Gmag', '
-0001d6d0: 4250 6d61 6727 2c20 2765 5f42 506d 6167  BPmag', 'e_BPmag
-0001d6e0: 272c 2027 5250 6d61 6727 2c20 2765 5f52  ', 'RPmag', 'e_R
-0001d6f0: 506d 6167 275d 0a0a 2020 2020 636f 6c75  Pmag']..    colu
-0001d700: 6d6e 5f66 696c 7465 7273 203d 207b 2750  mn_filters = {'P
-0001d710: 6c78 273a 2027 3e30 272c 2027 476d 6167  lx': '>0', 'Gmag
-0001d720: 273a 2027 3c33 3027 2c0a 2020 2020 2020  ': '<30',.      
-0001d730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d740: 2742 506d 6167 273a 2027 3c33 3027 2c20  'BPmag': '<30', 
-0001d750: 2752 506d 6167 273a 2027 3c33 3027 7d0a  'RPmag': '<30'}.
-0001d760: 0a20 2020 2023 2044 6f77 6e6c 6f61 6420  .    # Download 
-0001d770: 6361 7461 6c6f 670a 2020 2020 6361 7461  catalog.    cata
-0001d780: 6c6f 6720 3d20 646f 776e 6c6f 6164 5f76  log = download_v
-0001d790: 697a 6965 725f 6361 7461 6c6f 675f 666f  izier_catalog_fo
-0001d7a0: 725f 7370 6c75 735f 6669 656c 6428 7370  r_splus_field(sp
-0001d7b0: 6c75 735f 696d 6167 6520 3d20 696d 6167  lus_image = imag
-0001d7c0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001d7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cdd0: 2020 2020 2063 6f6c 756d 6e5f 6669 6c74       column_filt
+0001cde0: 6572 7320 3d20 636f 6c75 6d6e 5f66 696c  ers = column_fil
+0001cdf0: 7465 7273 290a 0a20 2020 2023 2323 2323  ters)..    #####
+0001ce00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001ce10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001ce20: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
+0001ce30: 2043 6f76 6572 7420 636f 6f72 6469 6e61   Covert coordina
+0001ce40: 7465 7320 6672 6f6d 2045 504f 4348 2032  tes from EPOCH 2
+0001ce50: 3031 3620 746f 204a 3230 3030 0a20 2020  016 to J2000.   
+0001ce60: 2072 615f 6963 7273 203d 2063 6174 616c   ra_icrs = catal
+0001ce70: 6f67 2e63 6f6c 756d 6e73 5b27 5241 5f49  og.columns['RA_I
+0001ce80: 4352 5327 5d0a 2020 2020 6465 5f69 6372  CRS'].    de_icr
+0001ce90: 7320 3d20 6361 7461 6c6f 672e 636f 6c75  s = catalog.colu
+0001cea0: 6d6e 735b 2744 455f 4943 5253 275d 0a20  mns['DE_ICRS']. 
+0001ceb0: 2020 2070 6d72 6120 2020 203d 2063 6174     pmra    = cat
+0001cec0: 616c 6f67 2e63 6f6c 756d 6e73 5b27 706d  alog.columns['pm
+0001ced0: 5241 275d 0a20 2020 2070 6d64 6520 2020  RA'].    pmde   
+0001cee0: 203d 2063 6174 616c 6f67 2e63 6f6c 756d   = catalog.colum
+0001cef0: 6e73 5b27 706d 4445 275d 0a20 2020 2070  ns['pmDE'].    p
+0001cf00: 6c78 2020 2020 203d 206e 702e 6172 7261  lx     = np.arra
+0001cf10: 7928 6361 7461 6c6f 672e 636f 6c75 6d6e  y(catalog.column
+0001cf20: 735b 2750 6c78 275d 290a 0a20 2020 2063  s['Plx'])..    c
+0001cf30: 203d 2053 6b79 436f 6f72 6428 7261 3d72   = SkyCoord(ra=r
+0001cf40: 615f 6963 7273 2c20 6465 633d 6465 5f69  a_icrs, dec=de_i
+0001cf50: 6372 732c 2066 7261 6d65 3d27 6963 7273  crs, frame='icrs
+0001cf60: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0001cf70: 2020 2020 706d 5f72 615f 636f 7364 6563      pm_ra_cosdec
+0001cf80: 3d20 706d 7261 2c20 706d 5f64 6563 203d  = pmra, pm_dec =
+0001cf90: 2070 6d64 652c 0a20 2020 2020 2020 2020   pmde,.         
+0001cfa0: 2020 2020 2020 2020 6469 7374 616e 6365          distance
+0001cfb0: 203d 2044 6973 7461 6e63 6528 7061 7261   = Distance(para
+0001cfc0: 6c6c 6178 3d70 6c78 2a75 2e6d 6173 2c20  llax=plx*u.mas, 
+0001cfd0: 616c 6c6f 775f 6e65 6761 7469 7665 3d54  allow_negative=T
+0001cfe0: 7275 6529 2c0a 2020 2020 2020 2020 2020  rue),.          
+0001cff0: 2020 2020 2020 206f 6273 7469 6d65 203d         obstime =
+0001d000: 2054 696d 6528 3230 3136 2c20 666f 726d   Time(2016, form
+0001d010: 6174 3d27 6a79 6561 7227 2929 0a0a 2020  at='jyear'))..  
+0001d020: 2020 2320 436f 6e76 6572 7420 6570 6f63    # Convert epoc
+0001d030: 6820 6672 6f6d 2032 3031 352e 3520 746f  h from 2015.5 to
+0001d040: 204a 3230 3030 0a20 2020 2063 5f6a 3230   J2000.    c_j20
+0001d050: 3030 203d 2063 2e61 7070 6c79 5f73 7061  00 = c.apply_spa
+0001d060: 6365 5f6d 6f74 696f 6e28 5469 6d65 2832  ce_motion(Time(2
+0001d070: 3030 302e 302c 2066 6f72 6d61 743d 276a  000.0, format='j
+0001d080: 7965 6172 2729 290a 0a20 2020 2023 2047  year'))..    # G
+0001d090: 6574 2052 4120 616e 6420 4445 430a 2020  et RA and DEC.  
+0001d0a0: 2020 7261 203d 206e 702e 6172 7261 7928    ra = np.array(
+0001d0b0: 635f 6a32 3030 302e 7261 290a 2020 2020  c_j2000.ra).    
+0001d0c0: 6465 203d 206e 702e 6172 7261 7928 635f  de = np.array(c_
+0001d0d0: 6a32 3030 302e 6465 6329 0a0a 2020 2020  j2000.dec)..    
+0001d0e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001d0f0: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
+0001d100: 2020 2023 2041 6464 2052 4120 616e 6420     # Add RA and 
+0001d110: 4445 4320 4a32 3030 3020 636f 6c75 6d6e  DEC J2000 column
+0001d120: 730a 2020 2020 6361 7461 6c6f 675b 2747  s.    catalog['G
+0001d130: 4149 4144 5232 5f52 414a 3230 3030 275d  AIADR2_RAJ2000']
+0001d140: 203d 2072 610a 2020 2020 6361 7461 6c6f   = ra.    catalo
+0001d150: 675b 2747 4149 4144 5232 5f44 454a 3230  g['GAIADR2_DEJ20
+0001d160: 3030 275d 203d 2064 650a 0a20 2020 2023  00'] = de..    #
+0001d170: 2052 656e 616d 6520 636f 6c75 6d6e 730a   Rename columns.
+0001d180: 2020 2020 6361 7461 6c6f 672e 636f 6c75      catalog.colu
+0001d190: 6d6e 735b 2753 6f75 7263 6527 5d2e 6e61  mns['Source'].na
+0001d1a0: 6d65 203d 2027 4741 4941 5f49 4427 0a0a  me = 'GAIA_ID'..
+0001d1b0: 2020 2020 6361 7461 6c6f 672e 636f 6c75      catalog.colu
+0001d1c0: 6d6e 735b 2747 6d61 6727 5d2e 6e61 6d65  mns['Gmag'].name
+0001d1d0: 203d 2027 4741 4941 5f47 270a 2020 2020   = 'GAIA_G'.    
+0001d1e0: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
+0001d1f0: 2765 5f47 6d61 6727 5d2e 6e61 6d65 203d  'e_Gmag'].name =
+0001d200: 2027 4741 4941 5f47 5f65 7272 270a 2020   'GAIA_G_err'.  
+0001d210: 2020 6361 7461 6c6f 672e 636f 6c75 6d6e    catalog.column
+0001d220: 735b 2742 506d 6167 275d 2e6e 616d 6520  s['BPmag'].name 
+0001d230: 3d20 2747 4149 415f 4250 270a 2020 2020  = 'GAIA_BP'.    
+0001d240: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
+0001d250: 2765 5f42 506d 6167 275d 2e6e 616d 6520  'e_BPmag'].name 
+0001d260: 3d20 2747 4149 415f 4250 5f65 7272 270a  = 'GAIA_BP_err'.
+0001d270: 2020 2020 6361 7461 6c6f 672e 636f 6c75      catalog.colu
+0001d280: 6d6e 735b 2752 506d 6167 275d 2e6e 616d  mns['RPmag'].nam
+0001d290: 6520 3d20 2747 4149 415f 5250 270a 2020  e = 'GAIA_RP'.  
+0001d2a0: 2020 6361 7461 6c6f 672e 636f 6c75 6d6e    catalog.column
+0001d2b0: 735b 2765 5f52 506d 6167 275d 2e6e 616d  s['e_RPmag'].nam
+0001d2c0: 6520 3d20 2747 4149 415f 5250 5f65 7272  e = 'GAIA_RP_err
+0001d2d0: 270a 0a20 2020 2063 6174 616c 6f67 2e63  '..    catalog.c
+0001d2e0: 6f6c 756d 6e73 5b27 4147 275d 2e6e 616d  olumns['AG'].nam
+0001d2f0: 6520 3d20 2747 4149 415f 4147 270a 0a20  e = 'GAIA_AG'.. 
+0001d300: 2020 2023 2054 7275 6e63 6174 6520 6465     # Truncate de
+0001d310: 7363 7269 7074 696f 6e20 2875 7375 616c  scription (usual
+0001d320: 6c79 2074 6f20 6269 6720 746f 2073 6176  ly to big to sav
+0001d330: 6520 6173 2066 6974 7329 0a20 2020 2063  e as fits).    c
+0001d340: 6174 616c 6f67 2e6d 6574 615b 2764 6573  atalog.meta['des
+0001d350: 6372 6970 7469 6f6e 275d 203d 2063 6174  cription'] = cat
+0001d360: 616c 6f67 2e6d 6574 615b 2764 6573 6372  alog.meta['descr
+0001d370: 6970 7469 6f6e 275d 5b3a 3535 5d0a 0a20  iption'][:55].. 
+0001d380: 2020 2023 2053 6176 6520 7461 626c 6520     # Save table 
+0001d390: 6173 2066 6974 730a 2020 2020 6361 7461  as fits.    cata
+0001d3a0: 6c6f 672e 7772 6974 6528 7361 7665 5f66  log.write(save_f
+0001d3b0: 696c 652c 206f 7665 7277 7269 7465 203d  ile, overwrite =
+0001d3c0: 2054 7275 6529 0a0a 0a64 6566 2064 6f77   True)...def dow
+0001d3d0: 6e6c 6f61 645f 6761 6961 2873 6176 655f  nload_gaia(save_
+0001d3e0: 6669 6c65 2c20 696d 6167 6520 3d20 4e6f  file, image = No
+0001d3f0: 6e65 2c20 6669 656c 6449 445f 6361 7461  ne, fieldID_cata
+0001d400: 6c6f 6720 3d20 4e6f 6e65 293a 0a20 2020  log = None):.   
+0001d410: 2022 2222 0a20 2020 2044 6f77 6e6c 6f61   """.    Downloa
+0001d420: 6473 2074 6865 2047 6169 6120 4544 5233  ds the Gaia EDR3
+0001d430: 2063 6174 616c 6f67 2066 726f 6d20 7468   catalog from th
+0001d440: 6520 7669 7a69 6572 2064 6174 6162 6173  e vizier databas
+0001d450: 6520 696e 2074 6865 2072 6567 696f 6e0a  e in the region.
+0001d460: 2020 2020 636f 7665 7265 6420 6279 2061      covered by a
+0001d470: 6e20 7370 6c75 7320 696d 6167 652e 2043  n splus image. C
+0001d480: 6861 6e67 6573 2063 6f6c 756d 6e20 6e61  hanges column na
+0001d490: 6d65 7320 666f 7220 7468 6520 666f 726d  mes for the form
+0001d4a0: 6174 2075 7365 6420 6279 2074 6865 0a20  at used by the. 
+0001d4b0: 2020 2070 6970 656c 696e 652c 2064 656c     pipeline, del
+0001d4c0: 6574 6573 2075 6e6e 6563 6573 7361 7279  etes unnecessary
+0001d4d0: 2063 6f6c 756d 6e73 2061 6e64 2073 6176   columns and sav
+0001d4e0: 6573 2072 6573 756c 7473 2074 6f20 6120  es results to a 
+0001d4f0: 6669 7473 2066 696c 650a 0a20 2020 2050  fits file..    P
+0001d500: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+0001d510: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2069 6d61  --------.    ima
+0001d520: 6765 203a 2073 7472 0a20 2020 2020 2020  ge : str.       
+0001d530: 204c 6f63 6174 696f 6e20 6f66 2074 6865   Location of the
+0001d540: 2073 706c 7573 2069 6d61 6765 2028 6d75   splus image (mu
+0001d550: 7374 2062 6520 2e66 7a29 0a20 2020 2073  st be .fz).    s
+0001d560: 6176 655f 6669 6c65 203a 2073 7472 0a20  ave_file : str. 
+0001d570: 2020 2020 2020 204c 6f63 6174 696f 6e20         Location 
+0001d580: 746f 2073 6176 6520 7468 6520 7265 7472  to save the retr
+0001d590: 6965 7665 6420 6361 7461 6c6f 6720 286d  ieved catalog (m
+0001d5a0: 7573 7420 6265 202e 6669 7473 290a 0a20  ust be .fits).. 
+0001d5b0: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
+0001d5c0: 2d2d 2d2d 2d2d 0a20 2020 2053 6176 6573  ------.    Saves
+0001d5d0: 2063 6174 616c 6f67 2069 6e20 7468 6520   catalog in the 
+0001d5e0: 6465 7369 7265 6420 6c6f 6361 7469 6f6e  desired location
+0001d5f0: 0a20 2020 2022 2222 0a0a 2020 2020 2320  .    """..    # 
+0001d600: 5669 7a69 6572 2054 6162 6c65 0a20 2020  Vizier Table.   
+0001d610: 2063 6174 5f69 6420 3d20 2249 2f33 3530   cat_id = "I/350
+0001d620: 2f67 6169 6165 6472 3322 0a0a 2020 2020  /gaiaedr3"..    
+0001d630: 636f 6c75 6d6e 7320 3d20 5b27 5241 5f49  columns = ['RA_I
+0001d640: 4352 5327 2c20 2744 455f 4943 5253 272c  CRS', 'DE_ICRS',
+0001d650: 2027 536f 7572 6365 272c 2027 506c 7827   'Source', 'Plx'
+0001d660: 2c20 2770 6d52 4127 2c20 2770 6d44 4527  , 'pmRA', 'pmDE'
+0001d670: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001d680: 2027 476d 6167 272c 2027 655f 476d 6167   'Gmag', 'e_Gmag
+0001d690: 272c 2027 4250 6d61 6727 2c20 2765 5f42  ', 'BPmag', 'e_B
+0001d6a0: 506d 6167 272c 2027 5250 6d61 6727 2c20  Pmag', 'RPmag', 
+0001d6b0: 2765 5f52 506d 6167 275d 0a0a 2020 2020  'e_RPmag']..    
+0001d6c0: 636f 6c75 6d6e 5f66 696c 7465 7273 203d  column_filters =
+0001d6d0: 207b 2750 6c78 273a 2027 3e30 272c 2027   {'Plx': '>0', '
+0001d6e0: 476d 6167 273a 2027 3c33 3027 2c0a 2020  Gmag': '<30',.  
+0001d6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d700: 2020 2020 2742 506d 6167 273a 2027 3c33      'BPmag': '<3
+0001d710: 3027 2c20 2752 506d 6167 273a 2027 3c33  0', 'RPmag': '<3
+0001d720: 3027 7d0a 0a20 2020 2023 2044 6f77 6e6c  0'}..    # Downl
+0001d730: 6f61 6420 6361 7461 6c6f 670a 2020 2020  oad catalog.    
+0001d740: 6361 7461 6c6f 6720 3d20 646f 776e 6c6f  catalog = downlo
+0001d750: 6164 5f76 697a 6965 725f 6361 7461 6c6f  ad_vizier_catalo
+0001d760: 675f 666f 725f 7370 6c75 735f 6669 656c  g_for_splus_fiel
+0001d770: 6428 7370 6c75 735f 696d 6167 6520 3d20  d(splus_image = 
+0001d780: 696d 6167 652c 0a20 2020 2020 2020 2020  image,.         
+0001d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d7b0: 2020 2020 2020 6669 656c 6449 445f 6361        fieldID_ca
+0001d7c0: 7461 6c6f 673d 6669 656c 6449 445f 6361  talog=fieldID_ca
+0001d7d0: 7461 6c6f 672c 0a20 2020 2020 2020 2020  talog,.         
 0001d7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d7f0: 2020 6669 656c 6449 445f 6361 7461 6c6f    fieldID_catalo
-0001d800: 673d 6669 656c 6449 445f 6361 7461 6c6f  g=fieldID_catalo
-0001d810: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
-0001d820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d800: 2020 2020 2020 7669 7a69 6572 5f63 6174        vizier_cat
+0001d810: 616c 6f67 5f69 6420 3d20 6361 745f 6964  alog_id = cat_id
+0001d820: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0001d830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d840: 2020 7669 7a69 6572 5f63 6174 616c 6f67    vizier_catalog
-0001d850: 5f69 6420 3d20 6361 745f 6964 2c0a 2020  _id = cat_id,.  
-0001d860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d850: 2063 6f6c 756d 6e73 203d 2063 6f6c 756d   columns = colum
+0001d860: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
 0001d870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d880: 2020 2020 2020 2020 2020 2020 2063 6f6c               col
-0001d890: 756d 6e73 203d 2063 6f6c 756d 6e73 2c0a  umns = columns,.
-0001d8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d8c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001d8d0: 6f6c 756d 6e5f 6669 6c74 6572 7320 3d20  olumn_filters = 
-0001d8e0: 636f 6c75 6d6e 5f66 696c 7465 7273 290a  column_filters).
-0001d8f0: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
-0001d900: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001d910: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001d920: 2323 2323 0a20 2020 2023 2043 6f76 6572  ####.    # Cover
-0001d930: 7420 636f 6f72 6469 6e61 7465 7320 6672  t coordinates fr
-0001d940: 6f6d 2045 504f 4348 2032 3031 3620 746f  om EPOCH 2016 to
-0001d950: 204a 3230 3030 0a20 2020 2072 615f 6963   J2000.    ra_ic
-0001d960: 7273 203d 2063 6174 616c 6f67 2e63 6f6c  rs = catalog.col
-0001d970: 756d 6e73 5b27 5241 5f49 4352 5327 5d0a  umns['RA_ICRS'].
-0001d980: 2020 2020 6465 5f69 6372 7320 3d20 6361      de_icrs = ca
-0001d990: 7461 6c6f 672e 636f 6c75 6d6e 735b 2744  talog.columns['D
-0001d9a0: 455f 4943 5253 275d 0a20 2020 2070 6d72  E_ICRS'].    pmr
-0001d9b0: 6120 2020 203d 2063 6174 616c 6f67 2e63  a    = catalog.c
-0001d9c0: 6f6c 756d 6e73 5b27 706d 5241 275d 0a20  olumns['pmRA']. 
-0001d9d0: 2020 2070 6d64 6520 2020 203d 2063 6174     pmde    = cat
-0001d9e0: 616c 6f67 2e63 6f6c 756d 6e73 5b27 706d  alog.columns['pm
-0001d9f0: 4445 275d 0a20 2020 2070 6c78 2020 2020  DE'].    plx    
-0001da00: 203d 206e 702e 6172 7261 7928 6361 7461   = np.array(cata
-0001da10: 6c6f 672e 636f 6c75 6d6e 735b 2750 6c78  log.columns['Plx
-0001da20: 275d 290a 0a20 2020 2063 203d 2053 6b79  '])..    c = Sky
-0001da30: 436f 6f72 6428 7261 3d72 615f 6963 7273  Coord(ra=ra_icrs
-0001da40: 2c20 6465 633d 6465 5f69 6372 732c 2066  , dec=de_icrs, f
-0001da50: 7261 6d65 3d27 6963 7273 272c 0a20 2020  rame='icrs',.   
-0001da60: 2020 2020 2020 2020 2020 2020 2020 706d                pm
-0001da70: 5f72 615f 636f 7364 6563 3d20 706d 7261  _ra_cosdec= pmra
-0001da80: 2c20 706d 5f64 6563 203d 2070 6d64 652c  , pm_dec = pmde,
-0001da90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001daa0: 2020 6469 7374 616e 6365 203d 2044 6973    distance = Dis
-0001dab0: 7461 6e63 6528 7061 7261 6c6c 6178 3d70  tance(parallax=p
-0001dac0: 6c78 2a75 2e6d 6173 2c20 616c 6c6f 775f  lx*u.mas, allow_
-0001dad0: 6e65 6761 7469 7665 3d54 7275 6529 2c0a  negative=True),.
-0001dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001daf0: 206f 6273 7469 6d65 203d 2054 696d 6528   obstime = Time(
-0001db00: 3230 3136 2c20 666f 726d 6174 3d27 6a79  2016, format='jy
-0001db10: 6561 7227 2929 0a0a 2020 2020 2320 436f  ear'))..    # Co
-0001db20: 6e76 6572 7420 6570 6f63 6820 6672 6f6d  nvert epoch from
-0001db30: 2032 3031 352e 3520 746f 204a 3230 3030   2015.5 to J2000
-0001db40: 0a20 2020 2063 5f6a 3230 3030 203d 2063  .    c_j2000 = c
-0001db50: 2e61 7070 6c79 5f73 7061 6365 5f6d 6f74  .apply_space_mot
-0001db60: 696f 6e28 5469 6d65 2832 3030 302e 302c  ion(Time(2000.0,
-0001db70: 2066 6f72 6d61 743d 276a 7965 6172 2729   format='jyear')
-0001db80: 290a 0a20 2020 2023 2047 6574 2052 4120  )..    # Get RA 
-0001db90: 616e 6420 4445 430a 2020 2020 7261 203d  and DEC.    ra =
-0001dba0: 206e 702e 6172 7261 7928 635f 6a32 3030   np.array(c_j200
-0001dbb0: 302e 7261 290a 2020 2020 6465 203d 206e  0.ra).    de = n
-0001dbc0: 702e 6172 7261 7928 635f 6a32 3030 302e  p.array(c_j2000.
-0001dbd0: 6465 6329 0a0a 2020 2020 2323 2323 2323  dec)..    ######
-0001dbe0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001dbf0: 2323 2323 2323 2323 0a20 2020 2023 2041  ########.    # A
-0001dc00: 6464 2052 4120 616e 6420 4445 4320 4a32  dd RA and DEC J2
-0001dc10: 3030 3020 636f 6c75 6d6e 730a 2020 2020  000 columns.    
-0001dc20: 6361 7461 6c6f 675b 2747 4149 415f 5241  catalog['GAIA_RA
-0001dc30: 4a32 3030 3027 5d20 3d20 7261 0a20 2020  J2000'] = ra.   
-0001dc40: 2063 6174 616c 6f67 5b27 4741 4941 5f44   catalog['GAIA_D
-0001dc50: 454a 3230 3030 275d 203d 2064 650a 0a20  EJ2000'] = de.. 
-0001dc60: 2020 2023 2052 656e 616d 6520 636f 6c75     # Rename colu
-0001dc70: 6d6e 730a 2020 2020 6361 7461 6c6f 672e  mns.    catalog.
-0001dc80: 636f 6c75 6d6e 735b 2753 6f75 7263 6527  columns['Source'
-0001dc90: 5d2e 6e61 6d65 203d 2027 4741 4941 5f49  ].name = 'GAIA_I
-0001dca0: 4427 0a0a 2020 2020 6361 7461 6c6f 672e  D'..    catalog.
-0001dcb0: 636f 6c75 6d6e 735b 2747 6d61 6727 5d2e  columns['Gmag'].
-0001dcc0: 6e61 6d65 203d 2027 4741 4941 5f47 270a  name = 'GAIA_G'.
-0001dcd0: 2020 2020 6361 7461 6c6f 672e 636f 6c75      catalog.colu
-0001dce0: 6d6e 735b 2765 5f47 6d61 6727 5d2e 6e61  mns['e_Gmag'].na
-0001dcf0: 6d65 203d 2027 4741 4941 5f47 5f65 7272  me = 'GAIA_G_err
-0001dd00: 270a 2020 2020 6361 7461 6c6f 672e 636f  '.    catalog.co
-0001dd10: 6c75 6d6e 735b 2742 506d 6167 275d 2e6e  lumns['BPmag'].n
-0001dd20: 616d 6520 3d20 2747 4149 415f 4250 270a  ame = 'GAIA_BP'.
-0001dd30: 2020 2020 6361 7461 6c6f 672e 636f 6c75      catalog.colu
-0001dd40: 6d6e 735b 2765 5f42 506d 6167 275d 2e6e  mns['e_BPmag'].n
-0001dd50: 616d 6520 3d20 2747 4149 415f 4250 5f65  ame = 'GAIA_BP_e
-0001dd60: 7272 270a 2020 2020 6361 7461 6c6f 672e  rr'.    catalog.
-0001dd70: 636f 6c75 6d6e 735b 2752 506d 6167 275d  columns['RPmag']
-0001dd80: 2e6e 616d 6520 3d20 2747 4149 415f 5250  .name = 'GAIA_RP
-0001dd90: 270a 2020 2020 6361 7461 6c6f 672e 636f  '.    catalog.co
-0001dda0: 6c75 6d6e 735b 2765 5f52 506d 6167 275d  lumns['e_RPmag']
-0001ddb0: 2e6e 616d 6520 3d20 2747 4149 415f 5250  .name = 'GAIA_RP
-0001ddc0: 5f65 7272 270a 0a20 2020 2023 2054 7275  _err'..    # Tru
-0001ddd0: 6e63 6174 6520 6465 7363 7269 7074 696f  ncate descriptio
-0001dde0: 6e20 2875 7375 616c 6c79 2074 6f20 6269  n (usually to bi
-0001ddf0: 6720 746f 2073 6176 6520 6173 2066 6974  g to save as fit
-0001de00: 7329 0a20 2020 2063 6174 616c 6f67 2e6d  s).    catalog.m
-0001de10: 6574 615b 2764 6573 6372 6970 7469 6f6e  eta['description
-0001de20: 275d 203d 2063 6174 616c 6f67 2e6d 6574  '] = catalog.met
-0001de30: 615b 2764 6573 6372 6970 7469 6f6e 275d  a['description']
-0001de40: 5b3a 3535 5d0a 0a20 2020 2023 2053 6176  [:55]..    # Sav
-0001de50: 6520 7461 626c 6520 6173 2066 6974 730a  e table as fits.
-0001de60: 2020 2020 6361 7461 6c6f 672e 7772 6974      catalog.writ
-0001de70: 6528 7361 7665 5f66 696c 652c 206f 7665  e(save_file, ove
-0001de80: 7277 7269 7465 203d 2054 7275 6529 0a0a  rwrite = True)..
-0001de90: 6465 6620 646f 776e 6c6f 6164 5f67 6169  def download_gai
-0001dea0: 6133 2873 6176 655f 6669 6c65 2c20 696d  a3(save_file, im
-0001deb0: 6167 6520 3d20 4e6f 6e65 2c20 6669 656c  age = None, fiel
-0001dec0: 6449 445f 6361 7461 6c6f 6720 3d20 4e6f  dID_catalog = No
-0001ded0: 6e65 293a 0a20 2020 2022 2222 0a20 2020  ne):.    """.   
-0001dee0: 2044 6f77 6e6c 6f61 6473 2074 6865 2047   Downloads the G
-0001def0: 6169 6120 4452 3320 6361 7461 6c6f 6720  aia DR3 catalog 
-0001df00: 6672 6f6d 2074 6865 2076 697a 6965 7220  from the vizier 
-0001df10: 6461 7461 6261 7365 2069 6e20 7468 6520  database in the 
-0001df20: 7265 6769 6f6e 0a20 2020 2063 6f76 6572  region.    cover
-0001df30: 6564 2062 7920 616e 2073 706c 7573 2069  ed by an splus i
-0001df40: 6d61 6765 2e20 4368 616e 6765 7320 636f  mage. Changes co
-0001df50: 6c75 6d6e 206e 616d 6573 2066 6f72 2074  lumn names for t
-0001df60: 6865 2066 6f72 6d61 7420 7573 6564 2062  he format used b
-0001df70: 7920 7468 650a 2020 2020 7069 7065 6c69  y the.    pipeli
-0001df80: 6e65 2c20 6465 6c65 7465 7320 756e 6e65  ne, deletes unne
-0001df90: 6365 7373 6172 7920 636f 6c75 6d6e 7320  cessary columns 
-0001dfa0: 616e 6420 7361 7665 7320 7265 7375 6c74  and saves result
-0001dfb0: 7320 746f 2061 2066 6974 7320 6669 6c65  s to a fits file
-0001dfc0: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
-0001dfd0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-0001dfe0: 2020 2020 696d 6167 6520 3a20 7374 720a      image : str.
-0001dff0: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
-0001e000: 206f 6620 7468 6520 7370 6c75 7320 696d   of the splus im
-0001e010: 6167 6520 286d 7573 7420 6265 202e 667a  age (must be .fz
-0001e020: 290a 2020 2020 7361 7665 5f66 696c 6520  ).    save_file 
-0001e030: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
-0001e040: 6361 7469 6f6e 2074 6f20 7361 7665 2074  cation to save t
-0001e050: 6865 2072 6574 7269 6576 6564 2063 6174  he retrieved cat
-0001e060: 616c 6f67 2028 6d75 7374 2062 6520 2e66  alog (must be .f
-0001e070: 6974 7329 0a0a 2020 2020 5265 7475 726e  its)..    Return
-0001e080: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-0001e090: 2020 5361 7665 7320 6361 7461 6c6f 6720    Saves catalog 
-0001e0a0: 696e 2074 6865 2064 6573 6972 6564 206c  in the desired l
-0001e0b0: 6f63 6174 696f 6e0a 2020 2020 2222 220a  ocation.    """.
-0001e0c0: 0a20 2020 2023 2056 697a 6965 7220 5461  .    # Vizier Ta
-0001e0d0: 626c 650a 2020 2020 6361 745f 6964 203d  ble.    cat_id =
-0001e0e0: 2022 492f 3335 352f 6761 6961 6472 3322   "I/355/gaiadr3"
-0001e0f0: 0a0a 2020 2020 636f 6c75 6d6e 7320 3d20  ..    columns = 
-0001e100: 5b27 5241 5f49 4352 5327 2c20 2744 455f  ['RA_ICRS', 'DE_
-0001e110: 4943 5253 272c 2027 536f 7572 6365 272c  ICRS', 'Source',
-0001e120: 2027 506c 7827 2c20 2770 6d52 4127 2c20   'Plx', 'pmRA', 
-0001e130: 2770 6d44 4527 2c0a 2020 2020 2020 2020  'pmDE',.        
-0001e140: 2020 2020 2020 2027 476d 6167 272c 2027         'Gmag', '
-0001e150: 655f 476d 6167 272c 2027 4250 6d61 6727  e_Gmag', 'BPmag'
-0001e160: 2c20 2765 5f42 506d 6167 272c 2027 5250  , 'e_BPmag', 'RP
-0001e170: 6d61 6727 2c20 2765 5f52 506d 6167 272c  mag', 'e_RPmag',
-0001e180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e190: 2741 4727 5d0a 0a20 2020 2063 6f6c 756d  'AG']..    colum
-0001e1a0: 6e5f 6669 6c74 6572 7320 3d20 7b27 506c  n_filters = {'Pl
-0001e1b0: 7827 3a20 273e 3027 2c20 2747 6d61 6727  x': '>0', 'Gmag'
-0001e1c0: 3a20 273c 3330 272c 0a20 2020 2020 2020  : '<30',.       
-0001e1d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0001e1e0: 4250 6d61 6727 3a20 273c 3330 272c 2027  BPmag': '<30', '
-0001e1f0: 5250 6d61 6727 3a20 273c 3330 277d 0a0a  RPmag': '<30'}..
-0001e200: 2020 2020 2320 446f 776e 6c6f 6164 2063      # Download c
-0001e210: 6174 616c 6f67 0a20 2020 2070 7269 6e74  atalog.    print
-0001e220: 2829 0a20 2020 2070 7269 6e74 2866 2264  ().    print(f"d
-0001e230: 6f77 6e6c 6f61 645f 7669 7a69 6572 5f63  ownload_vizier_c
-0001e240: 6174 616c 6f67 5f66 6f72 5f73 706c 7573  atalog_for_splus
-0001e250: 5f66 6965 6c64 2873 706c 7573 5f69 6d61  _field(splus_ima
-0001e260: 6765 203d 207b 696d 6167 657d 2c22 290a  ge = {image},").
-0001e270: 2020 2020 7072 696e 7428 6622 6669 656c      print(f"fiel
-0001e280: 6449 445f 6361 7461 6c6f 673d 7b66 6965  dID_catalog={fie
-0001e290: 6c64 4944 5f63 6174 616c 6f67 7d2c 2229  ldID_catalog},")
-0001e2a0: 0a20 2020 2070 7269 6e74 2866 2276 697a  .    print(f"viz
-0001e2b0: 6965 725f 6361 7461 6c6f 675f 6964 203d  ier_catalog_id =
-0001e2c0: 207b 6361 745f 6964 7d2c 2229 0a20 2020   {cat_id},").   
-0001e2d0: 2070 7269 6e74 2866 2263 6f6c 756d 6e73   print(f"columns
-0001e2e0: 203d 207b 636f 6c75 6d6e 737d 2229 0a20   = {columns}"). 
-0001e2f0: 2020 2070 7269 6e74 2866 2263 6f6c 756d     print(f"colum
-0001e300: 6e5f 6669 6c74 6572 7320 3d20 7b63 6f6c  n_filters = {col
-0001e310: 756d 6e5f 6669 6c74 6572 737d 2922 290a  umn_filters})").
-0001e320: 2020 2020 7072 696e 7428 290a 0a20 2020      print()..   
-0001e330: 2063 6174 616c 6f67 203d 2064 6f77 6e6c   catalog = downl
-0001e340: 6f61 645f 7669 7a69 6572 5f63 6174 616c  oad_vizier_catal
-0001e350: 6f67 5f66 6f72 5f73 706c 7573 5f66 6965  og_for_splus_fie
-0001e360: 6c64 2873 706c 7573 5f69 6d61 6765 203d  ld(splus_image =
-0001e370: 2069 6d61 6765 2c0a 2020 2020 2020 2020   image,.        
-0001e380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d890: 2020 2063 6f6c 756d 6e5f 6669 6c74 6572     column_filter
+0001d8a0: 7320 3d20 636f 6c75 6d6e 5f66 696c 7465  s = column_filte
+0001d8b0: 7273 290a 0a20 2020 2023 2323 2323 2323  rs)..    #######
+0001d8c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001d8d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001d8e0: 2323 2323 2323 2323 0a20 2020 2023 2043  ########.    # C
+0001d8f0: 6f76 6572 7420 636f 6f72 6469 6e61 7465  overt coordinate
+0001d900: 7320 6672 6f6d 2045 504f 4348 2032 3031  s from EPOCH 201
+0001d910: 3620 746f 204a 3230 3030 0a20 2020 2072  6 to J2000.    r
+0001d920: 615f 6963 7273 203d 2063 6174 616c 6f67  a_icrs = catalog
+0001d930: 2e63 6f6c 756d 6e73 5b27 5241 5f49 4352  .columns['RA_ICR
+0001d940: 5327 5d0a 2020 2020 6465 5f69 6372 7320  S'].    de_icrs 
+0001d950: 3d20 6361 7461 6c6f 672e 636f 6c75 6d6e  = catalog.column
+0001d960: 735b 2744 455f 4943 5253 275d 0a20 2020  s['DE_ICRS'].   
+0001d970: 2070 6d72 6120 2020 203d 2063 6174 616c   pmra    = catal
+0001d980: 6f67 2e63 6f6c 756d 6e73 5b27 706d 5241  og.columns['pmRA
+0001d990: 275d 0a20 2020 2070 6d64 6520 2020 203d  '].    pmde    =
+0001d9a0: 2063 6174 616c 6f67 2e63 6f6c 756d 6e73   catalog.columns
+0001d9b0: 5b27 706d 4445 275d 0a20 2020 2070 6c78  ['pmDE'].    plx
+0001d9c0: 2020 2020 203d 206e 702e 6172 7261 7928       = np.array(
+0001d9d0: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
+0001d9e0: 2750 6c78 275d 290a 0a20 2020 2063 203d  'Plx'])..    c =
+0001d9f0: 2053 6b79 436f 6f72 6428 7261 3d72 615f   SkyCoord(ra=ra_
+0001da00: 6963 7273 2c20 6465 633d 6465 5f69 6372  icrs, dec=de_icr
+0001da10: 732c 2066 7261 6d65 3d27 6963 7273 272c  s, frame='icrs',
+0001da20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001da30: 2020 706d 5f72 615f 636f 7364 6563 3d20    pm_ra_cosdec= 
+0001da40: 706d 7261 2c20 706d 5f64 6563 203d 2070  pmra, pm_dec = p
+0001da50: 6d64 652c 0a20 2020 2020 2020 2020 2020  mde,.           
+0001da60: 2020 2020 2020 6469 7374 616e 6365 203d        distance =
+0001da70: 2044 6973 7461 6e63 6528 7061 7261 6c6c   Distance(parall
+0001da80: 6178 3d70 6c78 2a75 2e6d 6173 2c20 616c  ax=plx*u.mas, al
+0001da90: 6c6f 775f 6e65 6761 7469 7665 3d54 7275  low_negative=Tru
+0001daa0: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+0001dab0: 2020 2020 206f 6273 7469 6d65 203d 2054       obstime = T
+0001dac0: 696d 6528 3230 3136 2c20 666f 726d 6174  ime(2016, format
+0001dad0: 3d27 6a79 6561 7227 2929 0a0a 2020 2020  ='jyear'))..    
+0001dae0: 2320 436f 6e76 6572 7420 6570 6f63 6820  # Convert epoch 
+0001daf0: 6672 6f6d 2032 3031 352e 3520 746f 204a  from 2015.5 to J
+0001db00: 3230 3030 0a20 2020 2063 5f6a 3230 3030  2000.    c_j2000
+0001db10: 203d 2063 2e61 7070 6c79 5f73 7061 6365   = c.apply_space
+0001db20: 5f6d 6f74 696f 6e28 5469 6d65 2832 3030  _motion(Time(200
+0001db30: 302e 302c 2066 6f72 6d61 743d 276a 7965  0.0, format='jye
+0001db40: 6172 2729 290a 0a20 2020 2023 2047 6574  ar'))..    # Get
+0001db50: 2052 4120 616e 6420 4445 430a 2020 2020   RA and DEC.    
+0001db60: 7261 203d 206e 702e 6172 7261 7928 635f  ra = np.array(c_
+0001db70: 6a32 3030 302e 7261 290a 2020 2020 6465  j2000.ra).    de
+0001db80: 203d 206e 702e 6172 7261 7928 635f 6a32   = np.array(c_j2
+0001db90: 3030 302e 6465 6329 0a0a 2020 2020 2323  000.dec)..    ##
+0001dba0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001dbb0: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
+0001dbc0: 2023 2041 6464 2052 4120 616e 6420 4445   # Add RA and DE
+0001dbd0: 4320 4a32 3030 3020 636f 6c75 6d6e 730a  C J2000 columns.
+0001dbe0: 2020 2020 6361 7461 6c6f 675b 2747 4149      catalog['GAI
+0001dbf0: 415f 5241 4a32 3030 3027 5d20 3d20 7261  A_RAJ2000'] = ra
+0001dc00: 0a20 2020 2063 6174 616c 6f67 5b27 4741  .    catalog['GA
+0001dc10: 4941 5f44 454a 3230 3030 275d 203d 2064  IA_DEJ2000'] = d
+0001dc20: 650a 0a20 2020 2023 2052 656e 616d 6520  e..    # Rename 
+0001dc30: 636f 6c75 6d6e 730a 2020 2020 6361 7461  columns.    cata
+0001dc40: 6c6f 672e 636f 6c75 6d6e 735b 2753 6f75  log.columns['Sou
+0001dc50: 7263 6527 5d2e 6e61 6d65 203d 2027 4741  rce'].name = 'GA
+0001dc60: 4941 5f49 4427 0a0a 2020 2020 6361 7461  IA_ID'..    cata
+0001dc70: 6c6f 672e 636f 6c75 6d6e 735b 2747 6d61  log.columns['Gma
+0001dc80: 6727 5d2e 6e61 6d65 203d 2027 4741 4941  g'].name = 'GAIA
+0001dc90: 5f47 270a 2020 2020 6361 7461 6c6f 672e  _G'.    catalog.
+0001dca0: 636f 6c75 6d6e 735b 2765 5f47 6d61 6727  columns['e_Gmag'
+0001dcb0: 5d2e 6e61 6d65 203d 2027 4741 4941 5f47  ].name = 'GAIA_G
+0001dcc0: 5f65 7272 270a 2020 2020 6361 7461 6c6f  _err'.    catalo
+0001dcd0: 672e 636f 6c75 6d6e 735b 2742 506d 6167  g.columns['BPmag
+0001dce0: 275d 2e6e 616d 6520 3d20 2747 4149 415f  '].name = 'GAIA_
+0001dcf0: 4250 270a 2020 2020 6361 7461 6c6f 672e  BP'.    catalog.
+0001dd00: 636f 6c75 6d6e 735b 2765 5f42 506d 6167  columns['e_BPmag
+0001dd10: 275d 2e6e 616d 6520 3d20 2747 4149 415f  '].name = 'GAIA_
+0001dd20: 4250 5f65 7272 270a 2020 2020 6361 7461  BP_err'.    cata
+0001dd30: 6c6f 672e 636f 6c75 6d6e 735b 2752 506d  log.columns['RPm
+0001dd40: 6167 275d 2e6e 616d 6520 3d20 2747 4149  ag'].name = 'GAI
+0001dd50: 415f 5250 270a 2020 2020 6361 7461 6c6f  A_RP'.    catalo
+0001dd60: 672e 636f 6c75 6d6e 735b 2765 5f52 506d  g.columns['e_RPm
+0001dd70: 6167 275d 2e6e 616d 6520 3d20 2747 4149  ag'].name = 'GAI
+0001dd80: 415f 5250 5f65 7272 270a 0a20 2020 2023  A_RP_err'..    #
+0001dd90: 2054 7275 6e63 6174 6520 6465 7363 7269   Truncate descri
+0001dda0: 7074 696f 6e20 2875 7375 616c 6c79 2074  ption (usually t
+0001ddb0: 6f20 6269 6720 746f 2073 6176 6520 6173  o big to save as
+0001ddc0: 2066 6974 7329 0a20 2020 2063 6174 616c   fits).    catal
+0001ddd0: 6f67 2e6d 6574 615b 2764 6573 6372 6970  og.meta['descrip
+0001dde0: 7469 6f6e 275d 203d 2063 6174 616c 6f67  tion'] = catalog
+0001ddf0: 2e6d 6574 615b 2764 6573 6372 6970 7469  .meta['descripti
+0001de00: 6f6e 275d 5b3a 3535 5d0a 0a20 2020 2023  on'][:55]..    #
+0001de10: 2053 6176 6520 7461 626c 6520 6173 2066   Save table as f
+0001de20: 6974 730a 2020 2020 6361 7461 6c6f 672e  its.    catalog.
+0001de30: 7772 6974 6528 7361 7665 5f66 696c 652c  write(save_file,
+0001de40: 206f 7665 7277 7269 7465 203d 2054 7275   overwrite = Tru
+0001de50: 6529 0a0a 6465 6620 646f 776e 6c6f 6164  e)..def download
+0001de60: 5f67 6169 6133 2873 6176 655f 6669 6c65  _gaia3(save_file
+0001de70: 2c20 696d 6167 6520 3d20 4e6f 6e65 2c20  , image = None, 
+0001de80: 6669 656c 6449 445f 6361 7461 6c6f 6720  fieldID_catalog 
+0001de90: 3d20 4e6f 6e65 293a 0a20 2020 2022 2222  = None):.    """
+0001dea0: 0a20 2020 2044 6f77 6e6c 6f61 6473 2074  .    Downloads t
+0001deb0: 6865 2047 6169 6120 4452 3320 6361 7461  he Gaia DR3 cata
+0001dec0: 6c6f 6720 6672 6f6d 2074 6865 2076 697a  log from the viz
+0001ded0: 6965 7220 6461 7461 6261 7365 2069 6e20  ier database in 
+0001dee0: 7468 6520 7265 6769 6f6e 0a20 2020 2063  the region.    c
+0001def0: 6f76 6572 6564 2062 7920 616e 2073 706c  overed by an spl
+0001df00: 7573 2069 6d61 6765 2e20 4368 616e 6765  us image. Change
+0001df10: 7320 636f 6c75 6d6e 206e 616d 6573 2066  s column names f
+0001df20: 6f72 2074 6865 2066 6f72 6d61 7420 7573  or the format us
+0001df30: 6564 2062 7920 7468 650a 2020 2020 7069  ed by the.    pi
+0001df40: 7065 6c69 6e65 2c20 6465 6c65 7465 7320  peline, deletes 
+0001df50: 756e 6e65 6365 7373 6172 7920 636f 6c75  unnecessary colu
+0001df60: 6d6e 7320 616e 6420 7361 7665 7320 7265  mns and saves re
+0001df70: 7375 6c74 7320 746f 2061 2066 6974 7320  sults to a fits 
+0001df80: 6669 6c65 0a0a 2020 2020 5061 7261 6d65  file..    Parame
+0001df90: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+0001dfa0: 2d2d 2d0a 2020 2020 696d 6167 6520 3a20  ---.    image : 
+0001dfb0: 7374 720a 2020 2020 2020 2020 4c6f 6361  str.        Loca
+0001dfc0: 7469 6f6e 206f 6620 7468 6520 7370 6c75  tion of the splu
+0001dfd0: 7320 696d 6167 6520 286d 7573 7420 6265  s image (must be
+0001dfe0: 202e 667a 290a 2020 2020 7361 7665 5f66   .fz).    save_f
+0001dff0: 696c 6520 3a20 7374 720a 2020 2020 2020  ile : str.      
+0001e000: 2020 4c6f 6361 7469 6f6e 2074 6f20 7361    Location to sa
+0001e010: 7665 2074 6865 2072 6574 7269 6576 6564  ve the retrieved
+0001e020: 2063 6174 616c 6f67 2028 6d75 7374 2062   catalog (must b
+0001e030: 6520 2e66 6974 7329 0a0a 2020 2020 5265  e .fits)..    Re
+0001e040: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+0001e050: 2d0a 2020 2020 5361 7665 7320 6361 7461  -.    Saves cata
+0001e060: 6c6f 6720 696e 2074 6865 2064 6573 6972  log in the desir
+0001e070: 6564 206c 6f63 6174 696f 6e0a 2020 2020  ed location.    
+0001e080: 2222 220a 0a20 2020 2023 2056 697a 6965  """..    # Vizie
+0001e090: 7220 5461 626c 650a 2020 2020 6361 745f  r Table.    cat_
+0001e0a0: 6964 203d 2022 492f 3335 352f 6761 6961  id = "I/355/gaia
+0001e0b0: 6472 3322 0a0a 2020 2020 636f 6c75 6d6e  dr3"..    column
+0001e0c0: 7320 3d20 5b27 5241 5f49 4352 5327 2c20  s = ['RA_ICRS', 
+0001e0d0: 2744 455f 4943 5253 272c 2027 536f 7572  'DE_ICRS', 'Sour
+0001e0e0: 6365 272c 2027 506c 7827 2c20 2770 6d52  ce', 'Plx', 'pmR
+0001e0f0: 4127 2c20 2770 6d44 4527 2c0a 2020 2020  A', 'pmDE',.    
+0001e100: 2020 2020 2020 2020 2020 2027 476d 6167             'Gmag
+0001e110: 272c 2027 655f 476d 6167 272c 2027 4250  ', 'e_Gmag', 'BP
+0001e120: 6d61 6727 2c20 2765 5f42 506d 6167 272c  mag', 'e_BPmag',
+0001e130: 2027 5250 6d61 6727 2c20 2765 5f52 506d   'RPmag', 'e_RPm
+0001e140: 6167 272c 0a20 2020 2020 2020 2020 2020  ag',.           
+0001e150: 2020 2020 2741 4727 5d0a 0a20 2020 2063      'AG']..    c
+0001e160: 6f6c 756d 6e5f 6669 6c74 6572 7320 3d20  olumn_filters = 
+0001e170: 7b27 506c 7827 3a20 273e 3027 2c20 2747  {'Plx': '>0', 'G
+0001e180: 6d61 6727 3a20 273c 3330 272c 0a20 2020  mag': '<30',.   
+0001e190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e1a0: 2020 2027 4250 6d61 6727 3a20 273c 3330     'BPmag': '<30
+0001e1b0: 272c 2027 5250 6d61 6727 3a20 273c 3330  ', 'RPmag': '<30
+0001e1c0: 277d 0a0a 2020 2020 2320 446f 776e 6c6f  '}..    # Downlo
+0001e1d0: 6164 2063 6174 616c 6f67 0a20 2020 2070  ad catalog.    p
+0001e1e0: 7269 6e74 2829 0a20 2020 2070 7269 6e74  rint().    print
+0001e1f0: 2866 2264 6f77 6e6c 6f61 645f 7669 7a69  (f"download_vizi
+0001e200: 6572 5f63 6174 616c 6f67 5f66 6f72 5f73  er_catalog_for_s
+0001e210: 706c 7573 5f66 6965 6c64 2873 706c 7573  plus_field(splus
+0001e220: 5f69 6d61 6765 203d 207b 696d 6167 657d  _image = {image}
+0001e230: 2c22 290a 2020 2020 7072 696e 7428 6622  ,").    print(f"
+0001e240: 6669 656c 6449 445f 6361 7461 6c6f 673d  fieldID_catalog=
+0001e250: 7b66 6965 6c64 4944 5f63 6174 616c 6f67  {fieldID_catalog
+0001e260: 7d2c 2229 0a20 2020 2070 7269 6e74 2866  },").    print(f
+0001e270: 2276 697a 6965 725f 6361 7461 6c6f 675f  "vizier_catalog_
+0001e280: 6964 203d 207b 6361 745f 6964 7d2c 2229  id = {cat_id},")
+0001e290: 0a20 2020 2070 7269 6e74 2866 2263 6f6c  .    print(f"col
+0001e2a0: 756d 6e73 203d 207b 636f 6c75 6d6e 737d  umns = {columns}
+0001e2b0: 2229 0a20 2020 2070 7269 6e74 2866 2263  ").    print(f"c
+0001e2c0: 6f6c 756d 6e5f 6669 6c74 6572 7320 3d20  olumn_filters = 
+0001e2d0: 7b63 6f6c 756d 6e5f 6669 6c74 6572 737d  {column_filters}
+0001e2e0: 2922 290a 2020 2020 7072 696e 7428 290a  )").    print().
+0001e2f0: 0a20 2020 2063 6174 616c 6f67 203d 2064  .    catalog = d
+0001e300: 6f77 6e6c 6f61 645f 7669 7a69 6572 5f63  ownload_vizier_c
+0001e310: 6174 616c 6f67 5f66 6f72 5f73 706c 7573  atalog_for_splus
+0001e320: 5f66 6965 6c64 2873 706c 7573 5f69 6d61  _field(splus_ima
+0001e330: 6765 203d 2069 6d61 6765 2c0a 2020 2020  ge = image,.    
+0001e340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e360: 2020 2020 2020 2020 2020 2066 6965 6c64             field
+0001e370: 4944 5f63 6174 616c 6f67 3d66 6965 6c64  ID_catalog=field
+0001e380: 4944 5f63 6174 616c 6f67 2c0a 2020 2020  ID_catalog,.    
 0001e390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e3a0: 2020 2020 2020 2066 6965 6c64 4944 5f63         fieldID_c
-0001e3b0: 6174 616c 6f67 3d66 6965 6c64 4944 5f63  atalog=fieldID_c
-0001e3c0: 6174 616c 6f67 2c0a 2020 2020 2020 2020  atalog,.        
-0001e3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e3b0: 2020 2020 2020 2020 2020 2076 697a 6965             vizie
+0001e3c0: 725f 6361 7461 6c6f 675f 6964 203d 2063  r_catalog_id = c
+0001e3d0: 6174 5f69 642c 0a20 2020 2020 2020 2020  at_id,.         
 0001e3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e3f0: 2020 2020 2020 2076 697a 6965 725f 6361         vizier_ca
-0001e400: 7461 6c6f 675f 6964 203d 2063 6174 5f69  talog_id = cat_i
-0001e410: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0001e3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e400: 2020 2020 2020 636f 6c75 6d6e 7320 3d20        columns = 
+0001e410: 636f 6c75 6d6e 732c 0a20 2020 2020 2020  columns,.       
 0001e420: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001e430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e440: 2020 636f 6c75 6d6e 7320 3d20 636f 6c75    columns = colu
-0001e450: 6d6e 732c 0a20 2020 2020 2020 2020 2020  mns,.           
-0001e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e480: 2020 2020 636f 6c75 6d6e 5f66 696c 7465      column_filte
-0001e490: 7273 203d 2063 6f6c 756d 6e5f 6669 6c74  rs = column_filt
-0001e4a0: 6572 7329 0a0a 2020 2020 2323 2323 2323  ers)..    ######
-0001e4b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001e4c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001e4d0: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
-0001e4e0: 436f 7665 7274 2063 6f6f 7264 696e 6174  Covert coordinat
-0001e4f0: 6573 2066 726f 6d20 4550 4f43 4820 3230  es from EPOCH 20
-0001e500: 3136 2074 6f20 4a32 3030 300a 2020 2020  16 to J2000.    
-0001e510: 7261 5f69 6372 7320 3d20 6361 7461 6c6f  ra_icrs = catalo
-0001e520: 672e 636f 6c75 6d6e 735b 2752 415f 4943  g.columns['RA_IC
-0001e530: 5253 275d 0a20 2020 2064 655f 6963 7273  RS'].    de_icrs
-0001e540: 203d 2063 6174 616c 6f67 2e63 6f6c 756d   = catalog.colum
-0001e550: 6e73 5b27 4445 5f49 4352 5327 5d0a 2020  ns['DE_ICRS'].  
-0001e560: 2020 706d 7261 2020 2020 3d20 6361 7461    pmra    = cata
-0001e570: 6c6f 672e 636f 6c75 6d6e 735b 2770 6d52  log.columns['pmR
-0001e580: 4127 5d0a 2020 2020 706d 6465 2020 2020  A'].    pmde    
-0001e590: 3d20 6361 7461 6c6f 672e 636f 6c75 6d6e  = catalog.column
-0001e5a0: 735b 2770 6d44 4527 5d0a 2020 2020 706c  s['pmDE'].    pl
-0001e5b0: 7820 2020 2020 3d20 6e70 2e61 7272 6179  x     = np.array
-0001e5c0: 2863 6174 616c 6f67 2e63 6f6c 756d 6e73  (catalog.columns
-0001e5d0: 5b27 506c 7827 5d29 0a0a 2020 2020 6320  ['Plx'])..    c 
-0001e5e0: 3d20 536b 7943 6f6f 7264 2872 613d 7261  = SkyCoord(ra=ra
-0001e5f0: 5f69 6372 732c 2064 6563 3d64 655f 6963  _icrs, dec=de_ic
-0001e600: 7273 2c20 6672 616d 653d 2769 6372 7327  rs, frame='icrs'
-0001e610: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001e620: 2020 2070 6d5f 7261 5f63 6f73 6465 633d     pm_ra_cosdec=
-0001e630: 2070 6d72 612c 2070 6d5f 6465 6320 3d20   pmra, pm_dec = 
-0001e640: 706d 6465 2c0a 2020 2020 2020 2020 2020  pmde,.          
-0001e650: 2020 2020 2020 2064 6973 7461 6e63 6520         distance 
-0001e660: 3d20 4469 7374 616e 6365 2870 6172 616c  = Distance(paral
-0001e670: 6c61 783d 706c 782a 752e 6d61 732c 2061  lax=plx*u.mas, a
-0001e680: 6c6c 6f77 5f6e 6567 6174 6976 653d 5472  llow_negative=Tr
-0001e690: 7565 292c 0a20 2020 2020 2020 2020 2020  ue),.           
-0001e6a0: 2020 2020 2020 6f62 7374 696d 6520 3d20        obstime = 
-0001e6b0: 5469 6d65 2832 3031 362c 2066 6f72 6d61  Time(2016, forma
-0001e6c0: 743d 276a 7965 6172 2729 290a 0a20 2020  t='jyear'))..   
-0001e6d0: 2023 2043 6f6e 7665 7274 2065 706f 6368   # Convert epoch
-0001e6e0: 2066 726f 6d20 3230 3135 2e35 2074 6f20   from 2015.5 to 
-0001e6f0: 4a32 3030 300a 2020 2020 635f 6a32 3030  J2000.    c_j200
-0001e700: 3020 3d20 632e 6170 706c 795f 7370 6163  0 = c.apply_spac
-0001e710: 655f 6d6f 7469 6f6e 2854 696d 6528 3230  e_motion(Time(20
-0001e720: 3030 2e30 2c20 666f 726d 6174 3d27 6a79  00.0, format='jy
-0001e730: 6561 7227 2929 0a0a 2020 2020 2320 4765  ear'))..    # Ge
-0001e740: 7420 5241 2061 6e64 2044 4543 0a20 2020  t RA and DEC.   
-0001e750: 2072 6120 3d20 6e70 2e61 7272 6179 2863   ra = np.array(c
-0001e760: 5f6a 3230 3030 2e72 6129 0a20 2020 2064  _j2000.ra).    d
-0001e770: 6520 3d20 6e70 2e61 7272 6179 2863 5f6a  e = np.array(c_j
-0001e780: 3230 3030 2e64 6563 290a 0a20 2020 2023  2000.dec)..    #
-0001e790: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0001e7a0: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
-0001e7b0: 2020 2320 4164 6420 5241 2061 6e64 2044    # Add RA and D
-0001e7c0: 4543 204a 3230 3030 2063 6f6c 756d 6e73  EC J2000 columns
-0001e7d0: 0a20 2020 2063 6174 616c 6f67 5b27 4741  .    catalog['GA
-0001e7e0: 4941 4452 335f 5241 4a32 3030 3027 5d20  IADR3_RAJ2000'] 
-0001e7f0: 3d20 7261 0a20 2020 2063 6174 616c 6f67  = ra.    catalog
-0001e800: 5b27 4741 4941 4452 335f 4445 4a32 3030  ['GAIADR3_DEJ200
-0001e810: 3027 5d20 3d20 6465 0a0a 2020 2020 2320  0'] = de..    # 
-0001e820: 5265 6e61 6d65 2063 6f6c 756d 6e73 0a20  Rename columns. 
-0001e830: 2020 2063 6174 616c 6f67 2e63 6f6c 756d     catalog.colum
-0001e840: 6e73 5b27 536f 7572 6365 275d 2e6e 616d  ns['Source'].nam
-0001e850: 6520 3d20 2747 4149 4133 5f49 4427 0a0a  e = 'GAIA3_ID'..
-0001e860: 2020 2020 6361 7461 6c6f 672e 636f 6c75      catalog.colu
-0001e870: 6d6e 735b 2747 6d61 6727 5d2e 6e61 6d65  mns['Gmag'].name
-0001e880: 203d 2027 4741 4941 335f 4727 0a20 2020   = 'GAIA3_G'.   
-0001e890: 2063 6174 616c 6f67 2e63 6f6c 756d 6e73   catalog.columns
-0001e8a0: 5b27 655f 476d 6167 275d 2e6e 616d 6520  ['e_Gmag'].name 
-0001e8b0: 3d20 2747 4149 4133 5f47 5f65 7272 270a  = 'GAIA3_G_err'.
-0001e8c0: 2020 2020 6361 7461 6c6f 672e 636f 6c75      catalog.colu
-0001e8d0: 6d6e 735b 2742 506d 6167 275d 2e6e 616d  mns['BPmag'].nam
-0001e8e0: 6520 3d20 2747 4149 4133 5f42 5027 0a20  e = 'GAIA3_BP'. 
-0001e8f0: 2020 2063 6174 616c 6f67 2e63 6f6c 756d     catalog.colum
-0001e900: 6e73 5b27 655f 4250 6d61 6727 5d2e 6e61  ns['e_BPmag'].na
-0001e910: 6d65 203d 2027 4741 4941 335f 4250 5f65  me = 'GAIA3_BP_e
-0001e920: 7272 270a 2020 2020 6361 7461 6c6f 672e  rr'.    catalog.
-0001e930: 636f 6c75 6d6e 735b 2752 506d 6167 275d  columns['RPmag']
-0001e940: 2e6e 616d 6520 3d20 2747 4149 4133 5f52  .name = 'GAIA3_R
-0001e950: 5027 0a20 2020 2063 6174 616c 6f67 2e63  P'.    catalog.c
-0001e960: 6f6c 756d 6e73 5b27 655f 5250 6d61 6727  olumns['e_RPmag'
-0001e970: 5d2e 6e61 6d65 203d 2027 4741 4941 335f  ].name = 'GAIA3_
-0001e980: 5250 5f65 7272 270a 2020 2020 6361 7461  RP_err'.    cata
-0001e990: 6c6f 672e 636f 6c75 6d6e 735b 2741 4727  log.columns['AG'
-0001e9a0: 5d2e 6e61 6d65 203d 2027 4741 4941 335f  ].name = 'GAIA3_
-0001e9b0: 4147 270a 0a20 2020 2023 2054 7275 6e63  AG'..    # Trunc
-0001e9c0: 6174 6520 6465 7363 7269 7074 696f 6e20  ate description 
-0001e9d0: 2875 7375 616c 6c79 2074 6f20 6269 6720  (usually to big 
-0001e9e0: 746f 2073 6176 6520 6173 2066 6974 7329  to save as fits)
-0001e9f0: 0a20 2020 2063 6174 616c 6f67 2e6d 6574  .    catalog.met
-0001ea00: 615b 2764 6573 6372 6970 7469 6f6e 275d  a['description']
-0001ea10: 203d 2063 6174 616c 6f67 2e6d 6574 615b   = catalog.meta[
-0001ea20: 2764 6573 6372 6970 7469 6f6e 275d 5b3a  'description'][:
-0001ea30: 3535 5d0a 0a20 2020 2023 2053 6176 6520  55]..    # Save 
-0001ea40: 7461 626c 6520 6173 2066 6974 730a 2020  table as fits.  
-0001ea50: 2020 6361 7461 6c6f 672e 7772 6974 6528    catalog.write(
-0001ea60: 7361 7665 5f66 696c 652c 206f 7665 7277  save_file, overw
-0001ea70: 7269 7465 203d 2054 7275 6529 0a0a 6465  rite = True)..de
-0001ea80: 6620 646f 776e 6c6f 6164 5f73 6b79 6d61  f download_skyma
-0001ea90: 7070 6572 2873 6176 655f 6669 6c65 2c20  pper(save_file, 
-0001eaa0: 696d 6167 6520 3d20 4e6f 6e65 2c20 6669  image = None, fi
-0001eab0: 656c 6449 445f 6361 7461 6c6f 6720 3d20  eldID_catalog = 
-0001eac0: 4e6f 6e65 293a 0a20 2020 2022 2222 0a20  None):.    """. 
-0001ead0: 2020 2044 6f77 6e6c 6f61 6473 2074 6865     Downloads the
-0001eae0: 2053 6b79 6d61 7070 6572 2063 6174 616c   Skymapper catal
-0001eaf0: 6f67 2066 726f 6d20 7468 6520 7669 7a69  og from the vizi
-0001eb00: 6572 2064 6174 6162 6173 6520 696e 2074  er database in t
-0001eb10: 6865 2072 6567 696f 6e0a 2020 2020 636f  he region.    co
-0001eb20: 7665 7265 6420 6279 2061 6e20 7370 6c75  vered by an splu
-0001eb30: 7320 696d 6167 652e 2043 6861 6e67 6573  s image. Changes
-0001eb40: 2063 6f6c 756d 6e20 6e61 6d65 7320 666f   column names fo
-0001eb50: 7220 7468 6520 666f 726d 6174 2075 7365  r the format use
-0001eb60: 6420 6279 2074 6865 0a20 2020 2070 6970  d by the.    pip
-0001eb70: 656c 696e 652c 2064 656c 6574 6573 2075  eline, deletes u
-0001eb80: 6e6e 6563 6573 7361 7279 2063 6f6c 756d  nnecessary colum
-0001eb90: 6e73 2061 6e64 2073 6176 6573 2072 6573  ns and saves res
-0001eba0: 756c 7473 2074 6f20 6120 6669 7473 2066  ults to a fits f
-0001ebb0: 696c 650a 0a20 2020 2050 6172 616d 6574  ile..    Paramet
-0001ebc0: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-0001ebd0: 2d2d 0a20 2020 2069 6d61 6765 203a 2073  --.    image : s
-0001ebe0: 7472 0a20 2020 2020 2020 204c 6f63 6174  tr.        Locat
-0001ebf0: 696f 6e20 6f66 2074 6865 2073 706c 7573  ion of the splus
-0001ec00: 2069 6d61 6765 2028 6d75 7374 2062 6520   image (must be 
-0001ec10: 2e66 7a29 0a20 2020 2073 6176 655f 6669  .fz).    save_fi
-0001ec20: 6c65 203a 2073 7472 0a20 2020 2020 2020  le : str.       
-0001ec30: 204c 6f63 6174 696f 6e20 746f 2073 6176   Location to sav
-0001ec40: 6520 7468 6520 7265 7472 6965 7665 6420  e the retrieved 
-0001ec50: 6361 7461 6c6f 6720 286d 7573 7420 6265  catalog (must be
-0001ec60: 202e 6669 7473 290a 0a20 2020 2052 6574   .fits)..    Ret
-0001ec70: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
-0001ec80: 0a20 2020 2053 6176 6573 2063 6174 616c  .    Saves catal
-0001ec90: 6f67 2069 6e20 7468 6520 6465 7369 7265  og in the desire
-0001eca0: 6420 6c6f 6361 7469 6f6e 0a20 2020 2022  d location.    "
-0001ecb0: 2222 0a0a 2020 2020 2320 5669 7a69 6572  ""..    # Vizier
-0001ecc0: 2054 6162 6c65 0a20 2020 2063 6174 5f69   Table.    cat_i
-0001ecd0: 6420 3d20 2249 492f 3335 382f 736d 7373  d = "II/358/smss
-0001ece0: 220a 0a20 2020 2063 6f6c 756d 6e73 203d  "..    columns =
-0001ecf0: 205b 2752 4149 4352 5327 2c20 2744 4549   ['RAICRS', 'DEI
-0001ed00: 4352 5327 2c20 2775 5053 4627 2c20 2765  CRS', 'uPSF', 'e
-0001ed10: 5f75 5053 4627 2c20 2776 5053 4627 2c20  _uPSF', 'vPSF', 
-0001ed20: 2765 5f76 5053 4627 2c0a 2020 2020 2020  'e_vPSF',.      
-0001ed30: 2020 2020 2020 2020 2027 6750 5346 272c           'gPSF',
-0001ed40: 2027 655f 6750 5346 272c 2027 7250 5346   'e_gPSF', 'rPSF
-0001ed50: 272c 2027 655f 7250 5346 272c 2027 6950  ', 'e_rPSF', 'iP
-0001ed60: 5346 272c 2027 655f 6950 5346 272c 0a20  SF', 'e_iPSF',. 
-0001ed70: 2020 2020 2020 2020 2020 2020 2020 277a                'z
-0001ed80: 5053 4627 2c20 2765 5f7a 5053 4627 5d0a  PSF', 'e_zPSF'].
-0001ed90: 0a20 2020 2063 6f6c 756d 6e5f 6669 6c74  .    column_filt
-0001eda0: 6572 7320 3d20 7b27 436c 6173 7353 7461  ers = {'ClassSta
-0001edb0: 7227 3a20 273e 302e 3527 2c20 2775 5053  r': '>0.5', 'uPS
-0001edc0: 4627 3a20 273c 3530 272c 2027 7650 5346  F': '<50', 'vPSF
-0001edd0: 273a 2027 3c35 3027 2c0a 2020 2020 2020  ': '<50',.      
-0001ede0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001edf0: 2767 5053 4627 3a20 273c 3530 272c 2027  'gPSF': '<50', '
-0001ee00: 7250 5346 273a 2027 3c35 3027 2c20 2769  rPSF': '<50', 'i
-0001ee10: 5053 4627 3a20 273c 3530 272c 0a20 2020  PSF': '<50',.   
-0001ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee30: 2020 2027 7a50 5346 273a 2027 3c35 3027     'zPSF': '<50'
-0001ee40: 7d0a 0a20 2020 2023 2044 6f77 6e6c 6f61  }..    # Downloa
-0001ee50: 6420 6361 7461 6c6f 670a 2020 2020 6361  d catalog.    ca
-0001ee60: 7461 6c6f 6720 3d20 646f 776e 6c6f 6164  talog = download
-0001ee70: 5f76 697a 6965 725f 6361 7461 6c6f 675f  _vizier_catalog_
-0001ee80: 666f 725f 7370 6c75 735f 6669 656c 6428  for_splus_field(
-0001ee90: 7370 6c75 735f 696d 6167 6520 3d20 696d  splus_image = im
-0001eea0: 6167 652c 0a20 2020 2020 2020 2020 2020  age,.           
-0001eeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e440: 2020 2020 2020 2020 636f 6c75 6d6e 5f66          column_f
+0001e450: 696c 7465 7273 203d 2063 6f6c 756d 6e5f  ilters = column_
+0001e460: 6669 6c74 6572 7329 0a0a 2020 2020 2323  filters)..    ##
+0001e470: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001e480: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001e490: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
+0001e4a0: 2020 2320 436f 7665 7274 2063 6f6f 7264    # Covert coord
+0001e4b0: 696e 6174 6573 2066 726f 6d20 4550 4f43  inates from EPOC
+0001e4c0: 4820 3230 3136 2074 6f20 4a32 3030 300a  H 2016 to J2000.
+0001e4d0: 2020 2020 7261 5f69 6372 7320 3d20 6361      ra_icrs = ca
+0001e4e0: 7461 6c6f 672e 636f 6c75 6d6e 735b 2752  talog.columns['R
+0001e4f0: 415f 4943 5253 275d 0a20 2020 2064 655f  A_ICRS'].    de_
+0001e500: 6963 7273 203d 2063 6174 616c 6f67 2e63  icrs = catalog.c
+0001e510: 6f6c 756d 6e73 5b27 4445 5f49 4352 5327  olumns['DE_ICRS'
+0001e520: 5d0a 2020 2020 706d 7261 2020 2020 3d20  ].    pmra    = 
+0001e530: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
+0001e540: 2770 6d52 4127 5d0a 2020 2020 706d 6465  'pmRA'].    pmde
+0001e550: 2020 2020 3d20 6361 7461 6c6f 672e 636f      = catalog.co
+0001e560: 6c75 6d6e 735b 2770 6d44 4527 5d0a 2020  lumns['pmDE'].  
+0001e570: 2020 706c 7820 2020 2020 3d20 6e70 2e61    plx     = np.a
+0001e580: 7272 6179 2863 6174 616c 6f67 2e63 6f6c  rray(catalog.col
+0001e590: 756d 6e73 5b27 506c 7827 5d29 0a0a 2020  umns['Plx'])..  
+0001e5a0: 2020 6320 3d20 536b 7943 6f6f 7264 2872    c = SkyCoord(r
+0001e5b0: 613d 7261 5f69 6372 732c 2064 6563 3d64  a=ra_icrs, dec=d
+0001e5c0: 655f 6963 7273 2c20 6672 616d 653d 2769  e_icrs, frame='i
+0001e5d0: 6372 7327 2c0a 2020 2020 2020 2020 2020  crs',.          
+0001e5e0: 2020 2020 2020 2070 6d5f 7261 5f63 6f73         pm_ra_cos
+0001e5f0: 6465 633d 2070 6d72 612c 2070 6d5f 6465  dec= pmra, pm_de
+0001e600: 6320 3d20 706d 6465 2c0a 2020 2020 2020  c = pmde,.      
+0001e610: 2020 2020 2020 2020 2020 2064 6973 7461             dista
+0001e620: 6e63 6520 3d20 4469 7374 616e 6365 2870  nce = Distance(p
+0001e630: 6172 616c 6c61 783d 706c 782a 752e 6d61  arallax=plx*u.ma
+0001e640: 732c 2061 6c6c 6f77 5f6e 6567 6174 6976  s, allow_negativ
+0001e650: 653d 5472 7565 292c 0a20 2020 2020 2020  e=True),.       
+0001e660: 2020 2020 2020 2020 2020 6f62 7374 696d            obstim
+0001e670: 6520 3d20 5469 6d65 2832 3031 362c 2066  e = Time(2016, f
+0001e680: 6f72 6d61 743d 276a 7965 6172 2729 290a  ormat='jyear')).
+0001e690: 0a20 2020 2023 2043 6f6e 7665 7274 2065  .    # Convert e
+0001e6a0: 706f 6368 2066 726f 6d20 3230 3135 2e35  poch from 2015.5
+0001e6b0: 2074 6f20 4a32 3030 300a 2020 2020 635f   to J2000.    c_
+0001e6c0: 6a32 3030 3020 3d20 632e 6170 706c 795f  j2000 = c.apply_
+0001e6d0: 7370 6163 655f 6d6f 7469 6f6e 2854 696d  space_motion(Tim
+0001e6e0: 6528 3230 3030 2e30 2c20 666f 726d 6174  e(2000.0, format
+0001e6f0: 3d27 6a79 6561 7227 2929 0a0a 2020 2020  ='jyear'))..    
+0001e700: 2320 4765 7420 5241 2061 6e64 2044 4543  # Get RA and DEC
+0001e710: 0a20 2020 2072 6120 3d20 6e70 2e61 7272  .    ra = np.arr
+0001e720: 6179 2863 5f6a 3230 3030 2e72 6129 0a20  ay(c_j2000.ra). 
+0001e730: 2020 2064 6520 3d20 6e70 2e61 7272 6179     de = np.array
+0001e740: 2863 5f6a 3230 3030 2e64 6563 290a 0a20  (c_j2000.dec).. 
+0001e750: 2020 2023 2323 2323 2323 2323 2323 2323     #############
+0001e760: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001e770: 230a 2020 2020 2320 4164 6420 5241 2061  #.    # Add RA a
+0001e780: 6e64 2044 4543 204a 3230 3030 2063 6f6c  nd DEC J2000 col
+0001e790: 756d 6e73 0a20 2020 2063 6174 616c 6f67  umns.    catalog
+0001e7a0: 5b27 4741 4941 4452 335f 5241 4a32 3030  ['GAIADR3_RAJ200
+0001e7b0: 3027 5d20 3d20 7261 0a20 2020 2063 6174  0'] = ra.    cat
+0001e7c0: 616c 6f67 5b27 4741 4941 4452 335f 4445  alog['GAIADR3_DE
+0001e7d0: 4a32 3030 3027 5d20 3d20 6465 0a0a 2020  J2000'] = de..  
+0001e7e0: 2020 2320 5265 6e61 6d65 2063 6f6c 756d    # Rename colum
+0001e7f0: 6e73 0a20 2020 2063 6174 616c 6f67 2e63  ns.    catalog.c
+0001e800: 6f6c 756d 6e73 5b27 536f 7572 6365 275d  olumns['Source']
+0001e810: 2e6e 616d 6520 3d20 2747 4149 4133 5f49  .name = 'GAIA3_I
+0001e820: 4427 0a0a 2020 2020 6361 7461 6c6f 672e  D'..    catalog.
+0001e830: 636f 6c75 6d6e 735b 2747 6d61 6727 5d2e  columns['Gmag'].
+0001e840: 6e61 6d65 203d 2027 4741 4941 335f 4727  name = 'GAIA3_G'
+0001e850: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
+0001e860: 756d 6e73 5b27 655f 476d 6167 275d 2e6e  umns['e_Gmag'].n
+0001e870: 616d 6520 3d20 2747 4149 4133 5f47 5f65  ame = 'GAIA3_G_e
+0001e880: 7272 270a 2020 2020 6361 7461 6c6f 672e  rr'.    catalog.
+0001e890: 636f 6c75 6d6e 735b 2742 506d 6167 275d  columns['BPmag']
+0001e8a0: 2e6e 616d 6520 3d20 2747 4149 4133 5f42  .name = 'GAIA3_B
+0001e8b0: 5027 0a20 2020 2063 6174 616c 6f67 2e63  P'.    catalog.c
+0001e8c0: 6f6c 756d 6e73 5b27 655f 4250 6d61 6727  olumns['e_BPmag'
+0001e8d0: 5d2e 6e61 6d65 203d 2027 4741 4941 335f  ].name = 'GAIA3_
+0001e8e0: 4250 5f65 7272 270a 2020 2020 6361 7461  BP_err'.    cata
+0001e8f0: 6c6f 672e 636f 6c75 6d6e 735b 2752 506d  log.columns['RPm
+0001e900: 6167 275d 2e6e 616d 6520 3d20 2747 4149  ag'].name = 'GAI
+0001e910: 4133 5f52 5027 0a20 2020 2063 6174 616c  A3_RP'.    catal
+0001e920: 6f67 2e63 6f6c 756d 6e73 5b27 655f 5250  og.columns['e_RP
+0001e930: 6d61 6727 5d2e 6e61 6d65 203d 2027 4741  mag'].name = 'GA
+0001e940: 4941 335f 5250 5f65 7272 270a 2020 2020  IA3_RP_err'.    
+0001e950: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
+0001e960: 2741 4727 5d2e 6e61 6d65 203d 2027 4741  'AG'].name = 'GA
+0001e970: 4941 335f 4147 270a 0a20 2020 2023 2054  IA3_AG'..    # T
+0001e980: 7275 6e63 6174 6520 6465 7363 7269 7074  runcate descript
+0001e990: 696f 6e20 2875 7375 616c 6c79 2074 6f20  ion (usually to 
+0001e9a0: 6269 6720 746f 2073 6176 6520 6173 2066  big to save as f
+0001e9b0: 6974 7329 0a20 2020 2063 6174 616c 6f67  its).    catalog
+0001e9c0: 2e6d 6574 615b 2764 6573 6372 6970 7469  .meta['descripti
+0001e9d0: 6f6e 275d 203d 2063 6174 616c 6f67 2e6d  on'] = catalog.m
+0001e9e0: 6574 615b 2764 6573 6372 6970 7469 6f6e  eta['description
+0001e9f0: 275d 5b3a 3535 5d0a 0a20 2020 2023 2053  '][:55]..    # S
+0001ea00: 6176 6520 7461 626c 6520 6173 2066 6974  ave table as fit
+0001ea10: 730a 2020 2020 6361 7461 6c6f 672e 7772  s.    catalog.wr
+0001ea20: 6974 6528 7361 7665 5f66 696c 652c 206f  ite(save_file, o
+0001ea30: 7665 7277 7269 7465 203d 2054 7275 6529  verwrite = True)
+0001ea40: 0a0a 6465 6620 646f 776e 6c6f 6164 5f73  ..def download_s
+0001ea50: 6b79 6d61 7070 6572 2873 6176 655f 6669  kymapper(save_fi
+0001ea60: 6c65 2c20 696d 6167 6520 3d20 4e6f 6e65  le, image = None
+0001ea70: 2c20 6669 656c 6449 445f 6361 7461 6c6f  , fieldID_catalo
+0001ea80: 6720 3d20 4e6f 6e65 293a 0a20 2020 2022  g = None):.    "
+0001ea90: 2222 0a20 2020 2044 6f77 6e6c 6f61 6473  "".    Downloads
+0001eaa0: 2074 6865 2053 6b79 6d61 7070 6572 2063   the Skymapper c
+0001eab0: 6174 616c 6f67 2066 726f 6d20 7468 6520  atalog from the 
+0001eac0: 7669 7a69 6572 2064 6174 6162 6173 6520  vizier database 
+0001ead0: 696e 2074 6865 2072 6567 696f 6e0a 2020  in the region.  
+0001eae0: 2020 636f 7665 7265 6420 6279 2061 6e20    covered by an 
+0001eaf0: 7370 6c75 7320 696d 6167 652e 2043 6861  splus image. Cha
+0001eb00: 6e67 6573 2063 6f6c 756d 6e20 6e61 6d65  nges column name
+0001eb10: 7320 666f 7220 7468 6520 666f 726d 6174  s for the format
+0001eb20: 2075 7365 6420 6279 2074 6865 0a20 2020   used by the.   
+0001eb30: 2070 6970 656c 696e 652c 2064 656c 6574   pipeline, delet
+0001eb40: 6573 2075 6e6e 6563 6573 7361 7279 2063  es unnecessary c
+0001eb50: 6f6c 756d 6e73 2061 6e64 2073 6176 6573  olumns and saves
+0001eb60: 2072 6573 756c 7473 2074 6f20 6120 6669   results to a fi
+0001eb70: 7473 2066 696c 650a 0a20 2020 2050 6172  ts file..    Par
+0001eb80: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+0001eb90: 2d2d 2d2d 2d2d 0a20 2020 2069 6d61 6765  ------.    image
+0001eba0: 203a 2073 7472 0a20 2020 2020 2020 204c   : str.        L
+0001ebb0: 6f63 6174 696f 6e20 6f66 2074 6865 2073  ocation of the s
+0001ebc0: 706c 7573 2069 6d61 6765 2028 6d75 7374  plus image (must
+0001ebd0: 2062 6520 2e66 7a29 0a20 2020 2073 6176   be .fz).    sav
+0001ebe0: 655f 6669 6c65 203a 2073 7472 0a20 2020  e_file : str.   
+0001ebf0: 2020 2020 204c 6f63 6174 696f 6e20 746f       Location to
+0001ec00: 2073 6176 6520 7468 6520 7265 7472 6965   save the retrie
+0001ec10: 7665 6420 6361 7461 6c6f 6720 286d 7573  ved catalog (mus
+0001ec20: 7420 6265 202e 6669 7473 290a 0a20 2020  t be .fits)..   
+0001ec30: 2052 6574 7572 6e73 0a20 2020 202d 2d2d   Returns.    ---
+0001ec40: 2d2d 2d2d 0a20 2020 2053 6176 6573 2063  ----.    Saves c
+0001ec50: 6174 616c 6f67 2069 6e20 7468 6520 6465  atalog in the de
+0001ec60: 7369 7265 6420 6c6f 6361 7469 6f6e 0a20  sired location. 
+0001ec70: 2020 2022 2222 0a0a 2020 2020 2320 5669     """..    # Vi
+0001ec80: 7a69 6572 2054 6162 6c65 0a20 2020 2063  zier Table.    c
+0001ec90: 6174 5f69 6420 3d20 2249 492f 3335 382f  at_id = "II/358/
+0001eca0: 736d 7373 220a 0a20 2020 2063 6f6c 756d  smss"..    colum
+0001ecb0: 6e73 203d 205b 2752 4149 4352 5327 2c20  ns = ['RAICRS', 
+0001ecc0: 2744 4549 4352 5327 2c20 2775 5053 4627  'DEICRS', 'uPSF'
+0001ecd0: 2c20 2765 5f75 5053 4627 2c20 2776 5053  , 'e_uPSF', 'vPS
+0001ece0: 4627 2c20 2765 5f76 5053 4627 2c0a 2020  F', 'e_vPSF',.  
+0001ecf0: 2020 2020 2020 2020 2020 2020 2027 6750               'gP
+0001ed00: 5346 272c 2027 655f 6750 5346 272c 2027  SF', 'e_gPSF', '
+0001ed10: 7250 5346 272c 2027 655f 7250 5346 272c  rPSF', 'e_rPSF',
+0001ed20: 2027 6950 5346 272c 2027 655f 6950 5346   'iPSF', 'e_iPSF
+0001ed30: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0001ed40: 2020 277a 5053 4627 2c20 2765 5f7a 5053    'zPSF', 'e_zPS
+0001ed50: 4627 5d0a 0a20 2020 2063 6f6c 756d 6e5f  F']..    column_
+0001ed60: 6669 6c74 6572 7320 3d20 7b27 436c 6173  filters = {'Clas
+0001ed70: 7353 7461 7227 3a20 273e 302e 3527 2c20  sStar': '>0.5', 
+0001ed80: 2775 5053 4627 3a20 273c 3530 272c 2027  'uPSF': '<50', '
+0001ed90: 7650 5346 273a 2027 3c35 3027 2c0a 2020  vPSF': '<50',.  
+0001eda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001edb0: 2020 2020 2767 5053 4627 3a20 273c 3530      'gPSF': '<50
+0001edc0: 272c 2027 7250 5346 273a 2027 3c35 3027  ', 'rPSF': '<50'
+0001edd0: 2c20 2769 5053 4627 3a20 273c 3530 272c  , 'iPSF': '<50',
+0001ede0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001edf0: 2020 2020 2020 2027 7a50 5346 273a 2027         'zPSF': '
+0001ee00: 3c35 3027 7d0a 0a20 2020 2023 2044 6f77  <50'}..    # Dow
+0001ee10: 6e6c 6f61 6420 6361 7461 6c6f 670a 2020  nload catalog.  
+0001ee20: 2020 6361 7461 6c6f 6720 3d20 646f 776e    catalog = down
+0001ee30: 6c6f 6164 5f76 697a 6965 725f 6361 7461  load_vizier_cata
+0001ee40: 6c6f 675f 666f 725f 7370 6c75 735f 6669  log_for_splus_fi
+0001ee50: 656c 6428 7370 6c75 735f 696d 6167 6520  eld(splus_image 
+0001ee60: 3d20 696d 6167 652c 0a20 2020 2020 2020  = image,.       
+0001ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee90: 2020 2020 2020 2020 6669 656c 6449 445f          fieldID_
+0001eea0: 6361 7461 6c6f 673d 6669 656c 6449 445f  catalog=fieldID_
+0001eeb0: 6361 7461 6c6f 672c 0a20 2020 2020 2020  catalog,.       
 0001eec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eed0: 2020 2020 6669 656c 6449 445f 6361 7461      fieldID_cata
-0001eee0: 6c6f 673d 6669 656c 6449 445f 6361 7461  log=fieldID_cata
-0001eef0: 6c6f 672c 0a20 2020 2020 2020 2020 2020  log,.           
-0001ef00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eee0: 2020 2020 2020 2020 7669 7a69 6572 5f63          vizier_c
+0001eef0: 6174 616c 6f67 5f69 6420 3d20 6361 745f  atalog_id = cat_
+0001ef00: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
 0001ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef20: 2020 2020 7669 7a69 6572 5f63 6174 616c      vizier_catal
-0001ef30: 6f67 5f69 6420 3d20 6361 745f 6964 2c0a  og_id = cat_id,.
-0001ef40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef30: 2020 2063 6f6c 756d 6e73 203d 2063 6f6c     columns = col
+0001ef40: 756d 6e73 2c0a 2020 2020 2020 2020 2020  umns,.          
 0001ef50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef60: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001ef70: 6f6c 756d 6e73 203d 2063 6f6c 756d 6e73  olumns = columns
-0001ef80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001ef90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001efa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001efb0: 2063 6f6c 756d 6e5f 6669 6c74 6572 7320   column_filters 
-0001efc0: 3d20 636f 6c75 6d6e 5f66 696c 7465 7273  = column_filters
-0001efd0: 290a 0a20 2020 2023 2052 656e 616d 6520  )..    # Rename 
-0001efe0: 636f 6c75 6d6e 730a 2020 2020 6361 7461  columns.    cata
-0001eff0: 6c6f 672e 636f 6c75 6d6e 735b 2752 4149  log.columns['RAI
-0001f000: 4352 5327 5d2e 6e61 6d65 203d 2027 534b  CRS'].name = 'SK
-0001f010: 594d 4150 5045 525f 5241 4a32 3030 3027  YMAPPER_RAJ2000'
-0001f020: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
-0001f030: 756d 6e73 5b27 4445 4943 5253 275d 2e6e  umns['DEICRS'].n
-0001f040: 616d 6520 3d20 2753 4b59 4d41 5050 4552  ame = 'SKYMAPPER
-0001f050: 5f44 454a 3230 3030 270a 0a20 2020 2063  _DEJ2000'..    c
-0001f060: 6174 616c 6f67 2e63 6f6c 756d 6e73 5b27  atalog.columns['
-0001f070: 7550 5346 275d 2e6e 616d 6520 3d20 2753  uPSF'].name = 'S
-0001f080: 4d5f 5527 0a20 2020 2063 6174 616c 6f67  M_U'.    catalog
-0001f090: 2e63 6f6c 756d 6e73 5b27 655f 7550 5346  .columns['e_uPSF
-0001f0a0: 275d 2e6e 616d 6520 3d20 2753 4d5f 555f  '].name = 'SM_U_
-0001f0b0: 6572 7227 0a20 2020 2063 6174 616c 6f67  err'.    catalog
-0001f0c0: 2e63 6f6c 756d 6e73 5b27 7650 5346 275d  .columns['vPSF']
-0001f0d0: 2e6e 616d 6520 3d20 2753 4d5f 5627 0a20  .name = 'SM_V'. 
-0001f0e0: 2020 2063 6174 616c 6f67 2e63 6f6c 756d     catalog.colum
-0001f0f0: 6e73 5b27 655f 7650 5346 275d 2e6e 616d  ns['e_vPSF'].nam
-0001f100: 6520 3d20 2753 4d5f 565f 6572 7227 0a20  e = 'SM_V_err'. 
-0001f110: 2020 2063 6174 616c 6f67 2e63 6f6c 756d     catalog.colum
-0001f120: 6e73 5b27 6750 5346 275d 2e6e 616d 6520  ns['gPSF'].name 
-0001f130: 3d20 2753 4d5f 4727 0a20 2020 2063 6174  = 'SM_G'.    cat
-0001f140: 616c 6f67 2e63 6f6c 756d 6e73 5b27 655f  alog.columns['e_
-0001f150: 6750 5346 275d 2e6e 616d 6520 3d20 2753  gPSF'].name = 'S
-0001f160: 4d5f 475f 6572 7227 0a20 2020 2063 6174  M_G_err'.    cat
-0001f170: 616c 6f67 2e63 6f6c 756d 6e73 5b27 7250  alog.columns['rP
-0001f180: 5346 275d 2e6e 616d 6520 3d20 2753 4d5f  SF'].name = 'SM_
-0001f190: 5227 0a20 2020 2063 6174 616c 6f67 2e63  R'.    catalog.c
-0001f1a0: 6f6c 756d 6e73 5b27 655f 7250 5346 275d  olumns['e_rPSF']
-0001f1b0: 2e6e 616d 6520 3d20 2753 4d5f 525f 6572  .name = 'SM_R_er
-0001f1c0: 7227 0a20 2020 2063 6174 616c 6f67 2e63  r'.    catalog.c
-0001f1d0: 6f6c 756d 6e73 5b27 6950 5346 275d 2e6e  olumns['iPSF'].n
-0001f1e0: 616d 6520 3d20 2753 4d5f 4927 0a20 2020  ame = 'SM_I'.   
-0001f1f0: 2063 6174 616c 6f67 2e63 6f6c 756d 6e73   catalog.columns
-0001f200: 5b27 655f 6950 5346 275d 2e6e 616d 6520  ['e_iPSF'].name 
-0001f210: 3d20 2753 4d5f 495f 6572 7227 0a20 2020  = 'SM_I_err'.   
-0001f220: 2063 6174 616c 6f67 2e63 6f6c 756d 6e73   catalog.columns
-0001f230: 5b27 7a50 5346 275d 2e6e 616d 6520 3d20  ['zPSF'].name = 
-0001f240: 2753 4d5f 5a27 0a20 2020 2063 6174 616c  'SM_Z'.    catal
-0001f250: 6f67 2e63 6f6c 756d 6e73 5b27 655f 7a50  og.columns['e_zP
-0001f260: 5346 275d 2e6e 616d 6520 3d20 2753 4d5f  SF'].name = 'SM_
-0001f270: 5a5f 6572 7227 0a0a 2020 2020 2323 2323  Z_err'..    ####
-0001f280: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-0001f290: 2020 2020 2320 5265 6d6f 7665 206e 616e      # Remove nan
-0001f2a0: 2076 616c 7565 730a 2020 2020 4e72 6f77   values.    Nrow
-0001f2b0: 7320 3d20 6e70 2e61 7272 6179 2863 6174  s = np.array(cat
-0001f2c0: 616c 6f67 2e63 6f6c 756d 6e73 5b27 534b  alog.columns['SK
-0001f2d0: 594d 4150 5045 525f 5241 4a32 3030 3027  YMAPPER_RAJ2000'
-0001f2e0: 5d29 2e73 6861 7065 5b30 5d0a 2020 2020  ]).shape[0].    
-0001f2f0: 6620 3d20 6e70 2e66 756c 6c28 4e72 6f77  f = np.full(Nrow
-0001f300: 732c 2054 7275 6529 0a0a 2020 2020 666f  s, True)..    fo
-0001f310: 7220 6d61 6720 696e 205b 2755 272c 2027  r mag in ['U', '
-0001f320: 4727 2c20 2752 272c 2027 4927 2c20 275a  G', 'R', 'I', 'Z
-0001f330: 275d 3a0a 2020 2020 2020 2020 6620 3d20  ']:.        f = 
-0001f340: 6620 2620 7e6e 702e 6973 6e61 6e28 6361  f & ~np.isnan(ca
-0001f350: 7461 6c6f 672e 636f 6c75 6d6e 735b 6627  talog.columns[f'
-0001f360: 534d 5f7b 6d61 677d 275d 290a 0a20 2020  SM_{mag}'])..   
-0001f370: 2063 6174 616c 6f67 203d 2063 6174 616c   catalog = catal
-0001f380: 6f67 5b66 5d0a 0a20 2020 2023 2054 7275  og[f]..    # Tru
-0001f390: 6e63 6174 6520 6465 7363 7269 7074 696f  ncate descriptio
-0001f3a0: 6e20 2875 7375 616c 6c79 2074 6f20 6269  n (usually to bi
-0001f3b0: 6720 746f 2073 6176 6520 6173 2066 6974  g to save as fit
-0001f3c0: 7329 0a20 2020 2063 6174 616c 6f67 2e6d  s).    catalog.m
-0001f3d0: 6574 615b 2764 6573 6372 6970 7469 6f6e  eta['description
-0001f3e0: 275d 203d 2063 6174 616c 6f67 2e6d 6574  '] = catalog.met
-0001f3f0: 615b 2764 6573 6372 6970 7469 6f6e 275d  a['description']
-0001f400: 5b3a 3535 5d0a 0a20 2020 2023 2053 6176  [:55]..    # Sav
-0001f410: 6520 7461 626c 6520 6173 2066 6974 730a  e table as fits.
-0001f420: 2020 2020 6361 7461 6c6f 672e 7772 6974      catalog.writ
-0001f430: 6528 7361 7665 5f66 696c 652c 206f 7665  e(save_file, ove
-0001f440: 7277 7269 7465 203d 2054 7275 6529 0a0a  rwrite = True)..
-0001f450: 0a64 6566 2064 6f77 6e6c 6f61 645f 7265  .def download_re
-0001f460: 6665 7265 6e63 6528 7265 6665 7265 6e63  ference(referenc
-0001f470: 652c 2073 6176 655f 6669 6c65 2c20 696d  e, save_file, im
-0001f480: 6167 6520 3d20 4e6f 6e65 2c0a 2020 2020  age = None,.    
-0001f490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f4a0: 2020 2066 6965 6c64 4944 5f63 6174 616c     fieldID_catal
-0001f4b0: 6f67 203d 204e 6f6e 6529 3a0a 2020 2020  og = None):.    
-0001f4c0: 2222 220a 2020 2020 4765 6e65 7261 6c20  """.    General 
-0001f4d0: 6675 6e63 7469 6f6e 2074 6f20 646f 776e  function to down
-0001f4e0: 6c6f 6164 2061 2073 7065 6369 6669 6320  load a specific 
-0001f4f0: 7265 6665 7265 6e63 6520 6361 7461 6c6f  reference catalo
-0001f500: 670a 0a20 2020 2050 6172 616d 6574 6572  g..    Parameter
-0001f510: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-0001f520: 0a20 2020 2069 6d61 6765 203a 2073 7472  .    image : str
-0001f530: 0a20 2020 2020 2020 204c 6f63 6174 696f  .        Locatio
-0001f540: 6e20 6f66 2074 6865 2073 706c 7573 2069  n of the splus i
-0001f550: 6d61 6765 2028 6d75 7374 2062 6520 2e66  mage (must be .f
-0001f560: 7a29 0a20 2020 2072 6566 6572 656e 6365  z).    reference
-0001f570: 203a 2073 7472 0a20 2020 2020 2020 2049   : str.        I
-0001f580: 6e64 6963 6961 7465 7320 7468 6520 7265  ndiciates the re
-0001f590: 6665 7265 6e63 6520 6361 7461 6c6f 6720  ference catalog 
-0001f5a0: 746f 2064 6f77 6e6c 6f61 640a 2020 2020  to download.    
-0001f5b0: 7361 7665 5f66 696c 6520 3a20 7374 720a  save_file : str.
-0001f5c0: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
-0001f5d0: 2074 6f20 7361 7665 2074 6865 2072 6574   to save the ret
-0001f5e0: 7269 6576 6564 2063 6174 616c 6f67 2028  rieved catalog (
-0001f5f0: 6d75 7374 2062 6520 2e66 6974 7329 0a0a  must be .fits)..
-0001f600: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-0001f610: 2d2d 2d2d 2d2d 2d0a 2020 2020 5361 7665  -------.    Save
-0001f620: 7320 6361 7461 6c6f 6720 696e 2074 6865  s catalog in the
-0001f630: 2064 6573 6972 6564 206c 6f63 6174 696f   desired locatio
-0001f640: 6e0a 2020 2020 2222 220a 0a20 2020 2069  n.    """..    i
-0001f650: 6620 7265 6665 7265 6e63 652e 6c6f 7765  f reference.lowe
-0001f660: 7228 2920 3d3d 2027 6761 6c65 7827 3a0a  r() == 'galex':.
-0001f670: 2020 2020 2020 2020 646f 776e 6c6f 6164          download
-0001f680: 5f67 616c 6578 2873 6176 655f 6669 6c65  _galex(save_file
-0001f690: 3d73 6176 655f 6669 6c65 2c20 696d 6167  =save_file, imag
-0001f6a0: 653d 696d 6167 652c 0a20 2020 2020 2020  e=image,.       
-0001f6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f6c0: 6669 656c 6449 445f 6361 7461 6c6f 673d  fieldID_catalog=
-0001f6d0: 6669 656c 6449 445f 6361 7461 6c6f 6729  fieldID_catalog)
-0001f6e0: 0a0a 2020 2020 656c 6966 2072 6566 6572  ..    elif refer
-0001f6f0: 656e 6365 2e6c 6f77 6572 2829 203d 3d20  ence.lower() == 
-0001f700: 2772 6566 6361 7432 273a 0a20 2020 2020  'refcat2':.     
-0001f710: 2020 2064 6f77 6e6c 6f61 645f 7265 6663     download_refc
-0001f720: 6174 3228 7361 7665 5f66 696c 653d 7361  at2(save_file=sa
-0001f730: 7665 5f66 696c 652c 2069 6d61 6765 3d69  ve_file, image=i
-0001f740: 6d61 6765 2c0a 2020 2020 2020 2020 2020  mage,.          
-0001f750: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0001f760: 6965 6c64 4944 5f63 6174 616c 6f67 3d66  ieldID_catalog=f
-0001f770: 6965 6c64 4944 5f63 6174 616c 6f67 290a  ieldID_catalog).
-0001f780: 0a20 2020 2065 6c69 6620 7265 6665 7265  .    elif refere
-0001f790: 6e63 652e 6c6f 7765 7228 2920 3d3d 2027  nce.lower() == '
-0001f7a0: 6976 657a 6963 273a 0a20 2020 2020 2020  ivezic':.       
-0001f7b0: 2064 6f77 6e6c 6f61 645f 6976 657a 6963   download_ivezic
-0001f7c0: 2873 6176 655f 6669 6c65 3d73 6176 655f  (save_file=save_
-0001f7d0: 6669 6c65 2c20 696d 6167 653d 696d 6167  file, image=imag
-0001f7e0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001f7f0: 2020 2020 2020 2020 2020 2066 6965 6c64             field
-0001f800: 4944 5f63 6174 616c 6f67 3d66 6965 6c64  ID_catalog=field
-0001f810: 4944 5f63 6174 616c 6f67 290a 0a20 2020  ID_catalog)..   
-0001f820: 2065 6c69 6620 7265 6665 7265 6e63 652e   elif reference.
-0001f830: 6c6f 7765 7228 2920 3d3d 2027 6976 657a  lower() == 'ivez
-0001f840: 6963 6162 273a 0a20 2020 2020 2020 2064  icab':.        d
-0001f850: 6f77 6e6c 6f61 645f 6976 657a 6963 4142  ownload_ivezicAB
-0001f860: 2873 6176 655f 6669 6c65 3d73 6176 655f  (save_file=save_
-0001f870: 6669 6c65 2c20 696d 6167 653d 696d 6167  file, image=imag
-0001f880: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-0001f890: 2020 2020 2020 2020 2020 2066 6965 6c64             field
-0001f8a0: 4944 5f63 6174 616c 6f67 3d66 6965 6c64  ID_catalog=field
-0001f8b0: 4944 5f63 6174 616c 6f67 290a 2020 2020  ID_catalog).    
-0001f8c0: 0a20 2020 2065 6c69 6620 7265 6665 7265  .    elif refere
-0001f8d0: 6e63 652e 6c6f 7765 7228 2920 3d3d 2027  nce.lower() == '
-0001f8e0: 6976 657a 6963 6162 3227 3a0a 2020 2020  ivezicab2':.    
-0001f8f0: 2020 2020 646f 776e 6c6f 6164 5f69 7665      download_ive
-0001f900: 7a69 6341 4232 2873 6176 655f 6669 6c65  zicAB2(save_file
-0001f910: 3d73 6176 655f 6669 6c65 2c20 696d 6167  =save_file, imag
-0001f920: 653d 696d 6167 652c 0a20 2020 2020 2020  e=image,.       
-0001f930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f940: 2066 6965 6c64 4944 5f63 6174 616c 6f67   fieldID_catalog
-0001f950: 3d66 6965 6c64 4944 5f63 6174 616c 6f67  =fieldID_catalog
-0001f960: 290a 2020 2020 0a20 2020 2065 6c69 6620  ).    .    elif 
-0001f970: 7265 6665 7265 6e63 652e 6c6f 7765 7228  reference.lower(
-0001f980: 2920 3d3d 2027 7364 7373 273a 0a20 2020  ) == 'sdss':.   
-0001f990: 2020 2020 2064 6f77 6e6c 6f61 645f 7364       download_sd
-0001f9a0: 7373 2873 6176 655f 6669 6c65 3d73 6176  ss(save_file=sav
-0001f9b0: 655f 6669 6c65 2c20 696d 6167 653d 696d  e_file, image=im
-0001f9c0: 6167 652c 0a20 2020 2020 2020 2020 2020  age,.           
-0001f9d0: 2020 2020 2020 2020 2020 2066 6965 6c64             field
-0001f9e0: 4944 5f63 6174 616c 6f67 3d66 6965 6c64  ID_catalog=field
-0001f9f0: 4944 5f63 6174 616c 6f67 290a 0a20 2020  ID_catalog)..   
-0001fa00: 2065 6c69 6620 7265 6665 7265 6e63 652e   elif reference.
-0001fa10: 6c6f 7765 7228 2920 3d3d 2027 7364 7373  lower() == 'sdss
-0001fa20: 3136 273a 0a20 2020 2020 2020 2064 6f77  16':.        dow
-0001fa30: 6e6c 6f61 645f 7364 7373 3136 2873 6176  nload_sdss16(sav
-0001fa40: 655f 6669 6c65 3d73 6176 655f 6669 6c65  e_file=save_file
-0001fa50: 2c20 696d 6167 653d 696d 6167 652c 0a20  , image=image,. 
-0001fa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa70: 2020 2020 2066 6965 6c64 4944 5f63 6174       fieldID_cat
-0001fa80: 616c 6f67 3d66 6965 6c64 4944 5f63 6174  alog=fieldID_cat
-0001fa90: 616c 6f67 290a 0a20 2020 2065 6c69 6620  alog)..    elif 
-0001faa0: 7265 6665 7265 6e63 652e 6c6f 7765 7228  reference.lower(
-0001fab0: 2920 3d3d 2027 6761 6961 273a 0a20 2020  ) == 'gaia':.   
-0001fac0: 2020 2020 2064 6f77 6e6c 6f61 645f 6761       download_ga
-0001fad0: 6961 2873 6176 655f 6669 6c65 3d73 6176  ia(save_file=sav
-0001fae0: 655f 6669 6c65 2c20 696d 6167 653d 696d  e_file, image=im
-0001faf0: 6167 652c 0a20 2020 2020 2020 2020 2020  age,.           
-0001fb00: 2020 2020 2020 2020 2020 2066 6965 6c64             field
-0001fb10: 4944 5f63 6174 616c 6f67 3d66 6965 6c64  ID_catalog=field
-0001fb20: 4944 5f63 6174 616c 6f67 290a 0a20 2020  ID_catalog)..   
-0001fb30: 2065 6c69 6620 7265 6665 7265 6e63 652e   elif reference.
-0001fb40: 6c6f 7765 7228 2920 3d3d 2027 6761 6961  lower() == 'gaia
-0001fb50: 6472 3227 3a0a 2020 2020 2020 2020 646f  dr2':.        do
-0001fb60: 776e 6c6f 6164 5f67 6169 6164 7232 2873  wnload_gaiadr2(s
-0001fb70: 6176 655f 6669 6c65 3d73 6176 655f 6669  ave_file=save_fi
-0001fb80: 6c65 2c20 696d 6167 653d 696d 6167 652c  le, image=image,
-0001fb90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fba0: 2020 2020 2020 2020 2020 6669 656c 6449            fieldI
-0001fbb0: 445f 6361 7461 6c6f 673d 6669 656c 6449  D_catalog=fieldI
-0001fbc0: 445f 6361 7461 6c6f 6729 0a0a 2020 2020  D_catalog)..    
-0001fbd0: 656c 6966 2072 6566 6572 656e 6365 2e6c  elif reference.l
-0001fbe0: 6f77 6572 2829 203d 3d20 2767 6169 6164  ower() == 'gaiad
-0001fbf0: 7233 273a 0a20 2020 2020 2020 2070 7269  r3':.        pri
-0001fc00: 6e74 2866 2264 6f77 6e6c 6f61 645f 6761  nt(f"download_ga
-0001fc10: 6961 3328 7361 7665 5f66 696c 653d 7b73  ia3(save_file={s
-0001fc20: 6176 655f 6669 6c65 7d2c 2229 0a20 2020  ave_file},").   
-0001fc30: 2020 2020 2070 7269 6e74 2866 2220 2020       print(f"   
-0001fc40: 2020 2020 2020 2020 2020 2020 696d 6167              imag
-0001fc50: 653d 7b69 6d61 6765 7d2c 2229 0a20 2020  e={image},").   
-0001fc60: 2020 2020 2070 7269 6e74 2866 2220 2020       print(f"   
-0001fc70: 2020 2020 2020 2020 2020 2020 6669 656c              fiel
-0001fc80: 6449 445f 6361 7461 6c6f 673d 7b66 6965  dID_catalog={fie
-0001fc90: 6c64 4944 5f63 6174 616c 6f67 7d29 2229  ldID_catalog})")
-0001fca0: 0a20 2020 2020 2020 2064 6f77 6e6c 6f61  .        downloa
-0001fcb0: 645f 6761 6961 3328 7361 7665 5f66 696c  d_gaia3(save_fil
-0001fcc0: 653d 7361 7665 5f66 696c 652c 2069 6d61  e=save_file, ima
-0001fcd0: 6765 3d69 6d61 6765 2c0a 2020 2020 2020  ge=image,.      
-0001fce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fcf0: 2020 2066 6965 6c64 4944 5f63 6174 616c     fieldID_catal
-0001fd00: 6f67 3d66 6965 6c64 4944 5f63 6174 616c  og=fieldID_catal
-0001fd10: 6f67 290a 0a20 2020 2065 6c69 6620 7265  og)..    elif re
-0001fd20: 6665 7265 6e63 652e 6c6f 7765 7228 2920  ference.lower() 
-0001fd30: 3d3d 2027 736b 796d 6170 7065 7227 3a0a  == 'skymapper':.
-0001fd40: 2020 2020 2020 2020 646f 776e 6c6f 6164          download
-0001fd50: 5f73 6b79 6d61 7070 6572 2873 6176 655f  _skymapper(save_
-0001fd60: 6669 6c65 3d73 6176 655f 6669 6c65 2c20  file=save_file, 
-0001fd70: 696d 6167 653d 696d 6167 652c 0a20 2020  image=image,.   
-0001fd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fd90: 2020 2020 2020 6669 656c 6449 445f 6361        fieldID_ca
-0001fda0: 7461 6c6f 673d 6669 656c 6449 445f 6361  talog=fieldID_ca
-0001fdb0: 7461 6c6f 6729 0a0a 2020 2020 656c 7365  talog)..    else
-0001fdc0: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
-0001fdd0: 5661 6c75 6545 7272 6f72 2828 6622 5265  ValueError((f"Re
-0001fde0: 6665 7265 6e63 6520 7b72 6566 6572 656e  ference {referen
-0001fdf0: 6365 7d20 6973 206e 6f74 2073 7570 706f  ce} is not suppo
-0001fe00: 7274 6564 2e20 4375 7272 656e 746c 7920  rted. Currently 
-0001fe10: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0001fe20: 2020 2020 2020 2020 2020 2020 2273 7570              "sup
-0001fe30: 706f 7274 6564 2076 616c 7565 7320 6172  ported values ar
-0001fe40: 6520 2747 414c 4558 272c 2027 5245 4643  e 'GALEX', 'REFC
-0001fe50: 4154 3227 2c20 2749 5645 5a49 4327 2c20  AT2', 'IVEZIC', 
-0001fe60: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0001fe70: 2020 2020 2020 2020 2020 2020 2227 5344              "'SD
-0001fe80: 5353 272c 2061 6e64 2027 4741 4941 2722  SS', and 'GAIA'"
-0001fe90: 2929 0a0a 0a64 6566 2063 726f 7373 6d61  ))...def crossma
-0001fea0: 7463 685f 6361 7461 6c6f 675f 6e61 6d65  tch_catalog_name
-0001feb0: 2866 6965 6c64 2c20 636f 6e66 293a 0a20  (field, conf):. 
-0001fec0: 2020 2022 2222 0a20 2020 2047 656e 6572     """.    Gener
-0001fed0: 6174 6573 2074 6865 206e 616d 6520 6f66  ates the name of
-0001fee0: 2074 6865 2053 2d50 4c55 532f 7265 6665   the S-PLUS/refe
-0001fef0: 7265 6e63 6573 2063 726f 7373 6d61 7463  rences crossmatc
-0001ff00: 6865 6420 6361 7461 6c6f 6720 7461 6b69  hed catalog taki
-0001ff10: 6e67 0a20 2020 2069 6e74 6f20 6163 636f  ng.    into acco
-0001ff20: 756e 7420 7468 6520 7068 6f74 6f6d 6574  unt the photomet
-0001ff30: 7279 206d 6f64 6520 616e 6420 7468 6520  ry mode and the 
-0001ff40: 7265 6665 7265 6e63 6520 6361 7461 6c6f  reference catalo
-0001ff50: 6728 7329 2075 7365 6420 666f 720a 2020  g(s) used for.  
-0001ff60: 2020 6361 6c69 6272 6174 696f 6e0a 0a20    calibration.. 
-0001ff70: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-0001ff80: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-0001ff90: 2066 6965 6c64 203a 2073 7472 0a20 2020   field : str.   
-0001ffa0: 2020 2020 204e 616d 6520 6f66 2074 6865       Name of the
-0001ffb0: 2053 2d50 4c55 5320 6669 656c 640a 2020   S-PLUS field.  
-0001ffc0: 2020 636f 6e66 203a 2064 6963 740a 2020    conf : dict.  
-0001ffd0: 2020 2020 2020 4469 6374 696f 6e61 7279        Dictionary
-0001ffe0: 206c 6f61 6465 6420 6672 6f6d 2074 6865   loaded from the
-0001fff0: 2063 6f6e 6669 6775 7261 7469 6f6e 2066   configuration f
-00020000: 696c 650a 0a20 2020 2052 6574 7572 6e73  ile..    Returns
-00020010: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
-00020020: 2073 7472 0a20 2020 2020 2020 204e 616d   str.        Nam
-00020030: 6520 6f66 2074 6865 2063 726f 7373 6d61  e of the crossma
-00020040: 7463 6865 6420 6361 7461 6c6f 670a 2020  tched catalog.  
-00020050: 2020 2222 220a 0a20 2020 2063 616c 6962    """..    calib
-00020060: 5f70 686f 7420 3d20 636f 6e66 5b27 6361  _phot = conf['ca
-00020070: 6c69 6272 6174 696f 6e5f 7068 6f74 6f6d  libration_photom
-00020080: 6574 7279 275d 0a20 2020 2063 6d61 7463  etry'].    cmatc
-00020090: 685f 6e61 6d65 203d 2066 227b 6669 656c  h_name = f"{fiel
-000200a0: 647d 5f53 504c 5553 5f7b 6361 6c69 625f  d}_SPLUS_{calib_
-000200b0: 7068 6f74 7d22 0a0a 2020 2020 6e72 6566  phot}"..    nref
-000200c0: 203d 206c 656e 2863 6f6e 665b 2772 6566   = len(conf['ref
-000200d0: 6572 656e 6365 5f63 6174 616c 6f67 275d  erence_catalog']
-000200e0: 290a 2020 2020 666f 7220 6920 696e 2072  ).    for i in r
-000200f0: 616e 6765 286e 7265 6629 3a0a 2020 2020  ange(nref):.    
-00020100: 2020 2020 636d 6174 6368 5f6e 616d 6520      cmatch_name 
-00020110: 2b3d 2066 225f 7b63 6f6e 665b 2772 6566  += f"_{conf['ref
-00020120: 6572 656e 6365 5f63 6174 616c 6f67 275d  erence_catalog']
-00020130: 5b69 5d7d 220a 0a20 2020 2063 6d61 7463  [i]}"..    cmatc
-00020140: 685f 6e61 6d65 202b 3d20 222e 6669 7473  h_name += ".fits
-00020150: 220a 0a20 2020 2072 6574 7572 6e20 636d  "..    return cm
-00020160: 6174 6368 5f6e 616d 650a 0a0a 6465 6620  atch_name...def 
-00020170: 636f 6e76 6572 745f 6761 6961 5f56 6567  convert_gaia_Veg
-00020180: 6132 4142 2867 6169 615f 6361 7461 6c6f  a2AB(gaia_catalo
-00020190: 672c 2073 6176 655f 6669 6c65 293a 0a20  g, save_file):. 
-000201a0: 2020 2022 2222 0a20 2020 2043 6f6e 7665     """.    Conve
-000201b0: 7274 7320 6761 6961 206d 6167 6e69 7475  rts gaia magnitu
-000201c0: 6465 7320 6672 6f6d 2056 4547 4120 7379  des from VEGA sy
-000201d0: 7374 656d 2074 6f20 4142 2073 7973 7465  stem to AB syste
-000201e0: 6d0a 0a20 2020 2067 6169 615f 6361 7461  m..    gaia_cata
-000201f0: 6c6f 673a 2073 7472 0a20 2020 2020 2020  log: str.       
-00020200: 206f 7574 7075 7420 6f66 2064 6f77 6e6c   output of downl
-00020210: 6f61 645f 6761 6961 6472 320a 2020 2020  oad_gaiadr2.    
-00020220: 7361 7665 5f66 696c 653a 2073 7472 0a20  save_file: str. 
-00020230: 2020 2020 2020 2070 6174 6820 7768 6572         path wher
-00020240: 6520 7468 6520 6f75 7470 7574 2041 4220  e the output AB 
-00020250: 6d61 676e 6974 7564 6573 2077 696c 6c20  magnitudes will 
-00020260: 6265 2073 6176 6564 0a20 2020 2022 2222  be saved.    """
-00020270: 0a0a 2020 2020 2320 436f 6e76 6572 7369  ..    # Conversi
-00020280: 6f6e 2063 6f6e 7374 616e 7473 0a20 2020  on constants.   
-00020290: 2023 2072 6566 6572 656e 6365 2068 7474   # reference htt
-000202a0: 7073 3a2f 2f67 6561 2e65 7361 632e 6573  ps://gea.esac.es
-000202b0: 612e 696e 742f 6172 6368 6976 652f 646f  a.int/archive/do
-000202c0: 6375 6d65 6e74 6174 696f 6e2f 4744 5232  cumentation/GDR2
-000202d0: 2f44 6174 615f 7072 6f63 6573 7369 6e67  /Data_processing
-000202e0: 2f63 6861 705f 6375 3570 686f 2f73 6563  /chap_cu5pho/sec
-000202f0: 5f63 7535 7068 6f5f 6361 6c69 6272 2f73  _cu5pho_calibr/s
-00020300: 7365 635f 6375 3570 686f 5f63 616c 6962  sec_cu5pho_calib
-00020310: 725f 6578 7465 726e 2e68 746d 6c0a 2020  r_extern.html.  
-00020320: 2020 7a70 5f47 5f56 6567 6120 203d 2032    zp_G_Vega  = 2
-00020330: 352e 3638 3834 0a20 2020 207a 705f 4250  5.6884.    zp_BP
-00020340: 5f56 6567 6120 3d20 3235 2e33 3531 340a  _Vega = 25.3514.
-00020350: 2020 2020 7a70 5f52 505f 5665 6761 203d      zp_RP_Vega =
-00020360: 2032 342e 3736 3139 0a0a 2020 2020 7a70   24.7619..    zp
-00020370: 5f47 5f41 4220 203d 2032 352e 3739 3334  _G_AB  = 25.7934
-00020380: 0a20 2020 207a 705f 4250 5f41 4220 3d20  .    zp_BP_AB = 
-00020390: 3235 2e33 3830 360a 2020 2020 7a70 5f52  25.3806.    zp_R
-000203a0: 505f 4142 203d 2032 352e 3131 3631 0a0a  P_AB = 25.1161..
-000203b0: 2020 2020 2320 4c6f 6164 2047 4149 4120      # Load GAIA 
-000203c0: 5645 4741 2063 6174 616c 6f67 0a20 2020  VEGA catalog.   
-000203d0: 2023 204c 6f61 6420 7068 6f74 6f6d 6574   # Load photomet
-000203e0: 7279 2063 6174 616c 6f67 2028 7769 7468  ry catalog (with
-000203f0: 2061 7065 7274 7572 6520 636f 7272 6563   aperture correc
-00020400: 7469 6f6e 290a 2020 2020 7665 6761 5f63  tion).    vega_c
-00020410: 6174 203d 2066 6974 732e 6f70 656e 2867  at = fits.open(g
-00020420: 6169 615f 6361 7461 6c6f 6729 0a20 2020  aia_catalog).   
-00020430: 2076 6567 615f 6361 7420 3d20 7665 6761   vega_cat = vega
-00020440: 5f63 6174 5b31 5d2e 6461 7461 0a0a 2020  _cat[1].data..  
-00020450: 2020 2320 4372 6561 7465 206e 6577 2064    # Create new d
-00020460: 6174 6120 5461 626c 650a 2020 2020 6361  ata Table.    ca
-00020470: 7420 3d20 5b5d 0a0a 2020 2020 666f 7220  t = []..    for 
-00020480: 636f 6c20 696e 2076 6567 615f 6361 742e  col in vega_cat.
-00020490: 636f 6c75 6d6e 733a 0a20 2020 2020 2020  columns:.       
-000204a0: 2069 6620 636f 6c2e 6e61 6d65 203d 3d20   if col.name == 
-000204b0: 2247 4149 415f 4722 3a0a 2020 2020 2020  "GAIA_G":.      
-000204c0: 2020 2020 2020 636f 6c2e 6172 7261 7920        col.array 
-000204d0: 2b3d 207a 705f 475f 4142 202d 207a 705f  += zp_G_AB - zp_
-000204e0: 475f 5665 6761 0a20 2020 2020 2020 2065  G_Vega.        e
-000204f0: 6c69 6620 636f 6c2e 6e61 6d65 203d 3d20  lif col.name == 
-00020500: 2247 4149 415f 4250 223a 0a20 2020 2020  "GAIA_BP":.     
-00020510: 2020 2020 2020 2063 6f6c 2e61 7272 6179         col.array
-00020520: 202b 3d20 7a70 5f42 505f 4142 202d 207a   += zp_BP_AB - z
-00020530: 705f 4250 5f56 6567 610a 2020 2020 2020  p_BP_Vega.      
-00020540: 2020 656c 6966 2063 6f6c 2e6e 616d 6520    elif col.name 
-00020550: 3d3d 2022 4741 4941 5f52 5022 3a0a 2020  == "GAIA_RP":.  
-00020560: 2020 2020 2020 2020 2020 636f 6c2e 6172            col.ar
-00020570: 7261 7920 2b3d 207a 705f 5250 5f41 4220  ray += zp_RP_AB 
-00020580: 2d20 7a70 5f52 505f 5665 6761 0a0a 2020  - zp_RP_Vega..  
-00020590: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
-000205a0: 2863 6f6c 290a 0a20 2020 2068 6475 6c5f  (col)..    hdul_
-000205b0: 7661 6320 3d20 6669 7473 2e42 696e 5461  vac = fits.BinTa
-000205c0: 626c 6548 4455 2e66 726f 6d5f 636f 6c75  bleHDU.from_colu
-000205d0: 6d6e 7328 6361 7429 0a20 2020 2068 6475  mns(cat).    hdu
-000205e0: 6c5f 7661 632e 7772 6974 6574 6f28 7361  l_vac.writeto(sa
-000205f0: 7665 5f66 696c 6529 0a0a 0a64 6566 2063  ve_file)...def c
-00020600: 6f6e 7665 7274 5f67 6169 6144 5233 5f56  onvert_gaiaDR3_V
-00020610: 6567 6132 4142 2867 6169 615f 6361 7461  ega2AB(gaia_cata
-00020620: 6c6f 672c 2073 6176 655f 6669 6c65 293a  log, save_file):
-00020630: 0a20 2020 2022 2222 0a20 2020 2043 6f6e  .    """.    Con
-00020640: 7665 7274 7320 6761 6961 2044 5233 206d  verts gaia DR3 m
-00020650: 6167 6e69 7475 6465 7320 6672 6f6d 2056  agnitudes from V
-00020660: 4547 4120 7379 7374 656d 2074 6f20 4142  EGA system to AB
-00020670: 2073 7973 7465 6d0a 0a20 2020 2067 6169   system..    gai
-00020680: 615f 6361 7461 6c6f 673a 2073 7472 0a20  a_catalog: str. 
-00020690: 2020 2020 2020 206f 7574 7075 7420 6f66         output of
-000206a0: 2064 6f77 6e6c 6f61 645f 6761 6961 6472   download_gaiadr
-000206b0: 320a 2020 2020 7361 7665 5f66 696c 653a  2.    save_file:
-000206c0: 2073 7472 0a20 2020 2020 2020 2070 6174   str.        pat
-000206d0: 6820 7768 6572 6520 7468 6520 6f75 7470  h where the outp
-000206e0: 7574 2041 4220 6d61 676e 6974 7564 6573  ut AB magnitudes
-000206f0: 2077 696c 6c20 6265 2073 6176 6564 0a20   will be saved. 
-00020700: 2020 2022 2222 0a0a 2020 2020 2320 436f     """..    # Co
-00020710: 6e76 6572 7369 6f6e 2063 6f6e 7374 616e  nversion constan
-00020720: 7473 0a20 2020 2023 2052 6566 6572 656e  ts.    # Referen
-00020730: 6365 2052 6965 6c6c 6f20 6574 2061 6c2e  ce Riello et al.
-00020740: 2028 3230 3231 293b 2041 2641 2036 3439   (2021); A&A 649
-00020750: 2c20 4133 0a0a 2020 2020 7a70 5f47 5f56  , A3..    zp_G_V
-00020760: 6567 6120 203d 2032 352e 3638 3734 0a20  ega  = 25.6874. 
-00020770: 2020 207a 705f 4250 5f56 6567 6120 3d20     zp_BP_Vega = 
-00020780: 3235 2e33 3338 350a 2020 2020 7a70 5f52  25.3385.    zp_R
-00020790: 505f 5665 6761 203d 2032 342e 3734 3739  P_Vega = 24.7479
-000207a0: 0a0a 2020 2020 7a70 5f47 5f41 4220 203d  ..    zp_G_AB  =
-000207b0: 2032 352e 3830 3130 0a20 2020 207a 705f   25.8010.    zp_
-000207c0: 4250 5f41 4220 3d20 3235 2e33 3534 300a  BP_AB = 25.3540.
-000207d0: 2020 2020 7a70 5f52 505f 4142 203d 2032      zp_RP_AB = 2
-000207e0: 352e 3130 3430 0a0a 2020 2020 2320 4c6f  5.1040..    # Lo
-000207f0: 6164 2047 4149 4120 5645 4741 2063 6174  ad GAIA VEGA cat
-00020800: 616c 6f67 0a20 2020 2023 204c 6f61 6420  alog.    # Load 
-00020810: 7068 6f74 6f6d 6574 7279 2063 6174 616c  photometry catal
-00020820: 6f67 2028 7769 7468 2061 7065 7274 7572  og (with apertur
-00020830: 6520 636f 7272 6563 7469 6f6e 290a 2020  e correction).  
-00020840: 2020 7665 6761 5f63 6174 203d 2066 6974    vega_cat = fit
-00020850: 732e 6f70 656e 2867 6169 615f 6361 7461  s.open(gaia_cata
-00020860: 6c6f 6729 0a20 2020 2076 6567 615f 6361  log).    vega_ca
-00020870: 7420 3d20 7665 6761 5f63 6174 5b31 5d2e  t = vega_cat[1].
-00020880: 6461 7461 0a0a 2020 2020 2320 4372 6561  data..    # Crea
-00020890: 7465 206e 6577 2064 6174 6120 5461 626c  te new data Tabl
-000208a0: 650a 2020 2020 6361 7420 3d20 5b5d 0a0a  e.    cat = []..
-000208b0: 2020 2020 666f 7220 636f 6c20 696e 2076      for col in v
-000208c0: 6567 615f 6361 742e 636f 6c75 6d6e 733a  ega_cat.columns:
-000208d0: 0a20 2020 2020 2020 2069 6620 636f 6c2e  .        if col.
-000208e0: 6e61 6d65 203d 3d20 2247 4149 4133 5f47  name == "GAIA3_G
-000208f0: 223a 0a20 2020 2020 2020 2020 2020 2063  ":.            c
-00020900: 6f6c 2e61 7272 6179 202b 3d20 7a70 5f47  ol.array += zp_G
-00020910: 5f41 4220 2d20 7a70 5f47 5f56 6567 610a  _AB - zp_G_Vega.
-00020920: 2020 2020 2020 2020 656c 6966 2063 6f6c          elif col
-00020930: 2e6e 616d 6520 3d3d 2022 4741 4941 335f  .name == "GAIA3_
-00020940: 4250 223a 0a20 2020 2020 2020 2020 2020  BP":.           
-00020950: 2063 6f6c 2e61 7272 6179 202b 3d20 7a70   col.array += zp
-00020960: 5f42 505f 4142 202d 207a 705f 4250 5f56  _BP_AB - zp_BP_V
-00020970: 6567 610a 2020 2020 2020 2020 656c 6966  ega.        elif
-00020980: 2063 6f6c 2e6e 616d 6520 3d3d 2022 4741   col.name == "GA
-00020990: 4941 335f 5250 223a 0a20 2020 2020 2020  IA3_RP":.       
-000209a0: 2020 2020 2063 6f6c 2e61 7272 6179 202b       col.array +
-000209b0: 3d20 7a70 5f52 505f 4142 202d 207a 705f  = zp_RP_AB - zp_
-000209c0: 5250 5f56 6567 610a 0a20 2020 2020 2020  RP_Vega..       
-000209d0: 2063 6174 2e61 7070 656e 6428 636f 6c29   cat.append(col)
-000209e0: 0a0a 2020 2020 6864 756c 5f76 6163 203d  ..    hdul_vac =
-000209f0: 2066 6974 732e 4269 6e54 6162 6c65 4844   fits.BinTableHD
-00020a00: 552e 6672 6f6d 5f63 6f6c 756d 6e73 2863  U.from_columns(c
-00020a10: 6174 290a 2020 2020 6864 756c 5f76 6163  at).    hdul_vac
-00020a20: 2e77 7269 7465 746f 2873 6176 655f 6669  .writeto(save_fi
-00020a30: 6c65 290a 0a23 2323 2323 2323 2323 2323  le)..###########
-00020a40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001ef60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef70: 2020 2020 2063 6f6c 756d 6e5f 6669 6c74       column_filt
+0001ef80: 6572 7320 3d20 636f 6c75 6d6e 5f66 696c  ers = column_fil
+0001ef90: 7465 7273 290a 0a20 2020 2023 2052 656e  ters)..    # Ren
+0001efa0: 616d 6520 636f 6c75 6d6e 730a 2020 2020  ame columns.    
+0001efb0: 6361 7461 6c6f 672e 636f 6c75 6d6e 735b  catalog.columns[
+0001efc0: 2752 4149 4352 5327 5d2e 6e61 6d65 203d  'RAICRS'].name =
+0001efd0: 2027 534b 594d 4150 5045 525f 5241 4a32   'SKYMAPPER_RAJ2
+0001efe0: 3030 3027 0a20 2020 2063 6174 616c 6f67  000'.    catalog
+0001eff0: 2e63 6f6c 756d 6e73 5b27 4445 4943 5253  .columns['DEICRS
+0001f000: 275d 2e6e 616d 6520 3d20 2753 4b59 4d41  '].name = 'SKYMA
+0001f010: 5050 4552 5f44 454a 3230 3030 270a 0a20  PPER_DEJ2000'.. 
+0001f020: 2020 2063 6174 616c 6f67 2e63 6f6c 756d     catalog.colum
+0001f030: 6e73 5b27 7550 5346 275d 2e6e 616d 6520  ns['uPSF'].name 
+0001f040: 3d20 2753 4d5f 5527 0a20 2020 2063 6174  = 'SM_U'.    cat
+0001f050: 616c 6f67 2e63 6f6c 756d 6e73 5b27 655f  alog.columns['e_
+0001f060: 7550 5346 275d 2e6e 616d 6520 3d20 2753  uPSF'].name = 'S
+0001f070: 4d5f 555f 6572 7227 0a20 2020 2063 6174  M_U_err'.    cat
+0001f080: 616c 6f67 2e63 6f6c 756d 6e73 5b27 7650  alog.columns['vP
+0001f090: 5346 275d 2e6e 616d 6520 3d20 2753 4d5f  SF'].name = 'SM_
+0001f0a0: 5627 0a20 2020 2063 6174 616c 6f67 2e63  V'.    catalog.c
+0001f0b0: 6f6c 756d 6e73 5b27 655f 7650 5346 275d  olumns['e_vPSF']
+0001f0c0: 2e6e 616d 6520 3d20 2753 4d5f 565f 6572  .name = 'SM_V_er
+0001f0d0: 7227 0a20 2020 2063 6174 616c 6f67 2e63  r'.    catalog.c
+0001f0e0: 6f6c 756d 6e73 5b27 6750 5346 275d 2e6e  olumns['gPSF'].n
+0001f0f0: 616d 6520 3d20 2753 4d5f 4727 0a20 2020  ame = 'SM_G'.   
+0001f100: 2063 6174 616c 6f67 2e63 6f6c 756d 6e73   catalog.columns
+0001f110: 5b27 655f 6750 5346 275d 2e6e 616d 6520  ['e_gPSF'].name 
+0001f120: 3d20 2753 4d5f 475f 6572 7227 0a20 2020  = 'SM_G_err'.   
+0001f130: 2063 6174 616c 6f67 2e63 6f6c 756d 6e73   catalog.columns
+0001f140: 5b27 7250 5346 275d 2e6e 616d 6520 3d20  ['rPSF'].name = 
+0001f150: 2753 4d5f 5227 0a20 2020 2063 6174 616c  'SM_R'.    catal
+0001f160: 6f67 2e63 6f6c 756d 6e73 5b27 655f 7250  og.columns['e_rP
+0001f170: 5346 275d 2e6e 616d 6520 3d20 2753 4d5f  SF'].name = 'SM_
+0001f180: 525f 6572 7227 0a20 2020 2063 6174 616c  R_err'.    catal
+0001f190: 6f67 2e63 6f6c 756d 6e73 5b27 6950 5346  og.columns['iPSF
+0001f1a0: 275d 2e6e 616d 6520 3d20 2753 4d5f 4927  '].name = 'SM_I'
+0001f1b0: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
+0001f1c0: 756d 6e73 5b27 655f 6950 5346 275d 2e6e  umns['e_iPSF'].n
+0001f1d0: 616d 6520 3d20 2753 4d5f 495f 6572 7227  ame = 'SM_I_err'
+0001f1e0: 0a20 2020 2063 6174 616c 6f67 2e63 6f6c  .    catalog.col
+0001f1f0: 756d 6e73 5b27 7a50 5346 275d 2e6e 616d  umns['zPSF'].nam
+0001f200: 6520 3d20 2753 4d5f 5a27 0a20 2020 2063  e = 'SM_Z'.    c
+0001f210: 6174 616c 6f67 2e63 6f6c 756d 6e73 5b27  atalog.columns['
+0001f220: 655f 7a50 5346 275d 2e6e 616d 6520 3d20  e_zPSF'].name = 
+0001f230: 2753 4d5f 5a5f 6572 7227 0a0a 2020 2020  'SM_Z_err'..    
+0001f240: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0001f250: 2323 230a 2020 2020 2320 5265 6d6f 7665  ###.    # Remove
+0001f260: 206e 616e 2076 616c 7565 730a 2020 2020   nan values.    
+0001f270: 4e72 6f77 7320 3d20 6e70 2e61 7272 6179  Nrows = np.array
+0001f280: 2863 6174 616c 6f67 2e63 6f6c 756d 6e73  (catalog.columns
+0001f290: 5b27 534b 594d 4150 5045 525f 5241 4a32  ['SKYMAPPER_RAJ2
+0001f2a0: 3030 3027 5d29 2e73 6861 7065 5b30 5d0a  000']).shape[0].
+0001f2b0: 2020 2020 6620 3d20 6e70 2e66 756c 6c28      f = np.full(
+0001f2c0: 4e72 6f77 732c 2054 7275 6529 0a0a 2020  Nrows, True)..  
+0001f2d0: 2020 666f 7220 6d61 6720 696e 205b 2755    for mag in ['U
+0001f2e0: 272c 2027 4727 2c20 2752 272c 2027 4927  ', 'G', 'R', 'I'
+0001f2f0: 2c20 275a 275d 3a0a 2020 2020 2020 2020  , 'Z']:.        
+0001f300: 6620 3d20 6620 2620 7e6e 702e 6973 6e61  f = f & ~np.isna
+0001f310: 6e28 6361 7461 6c6f 672e 636f 6c75 6d6e  n(catalog.column
+0001f320: 735b 6627 534d 5f7b 6d61 677d 275d 290a  s[f'SM_{mag}']).
+0001f330: 0a20 2020 2063 6174 616c 6f67 203d 2063  .    catalog = c
+0001f340: 6174 616c 6f67 5b66 5d0a 0a20 2020 2023  atalog[f]..    #
+0001f350: 2054 7275 6e63 6174 6520 6465 7363 7269   Truncate descri
+0001f360: 7074 696f 6e20 2875 7375 616c 6c79 2074  ption (usually t
+0001f370: 6f20 6269 6720 746f 2073 6176 6520 6173  o big to save as
+0001f380: 2066 6974 7329 0a20 2020 2063 6174 616c   fits).    catal
+0001f390: 6f67 2e6d 6574 615b 2764 6573 6372 6970  og.meta['descrip
+0001f3a0: 7469 6f6e 275d 203d 2063 6174 616c 6f67  tion'] = catalog
+0001f3b0: 2e6d 6574 615b 2764 6573 6372 6970 7469  .meta['descripti
+0001f3c0: 6f6e 275d 5b3a 3535 5d0a 0a20 2020 2023  on'][:55]..    #
+0001f3d0: 2053 6176 6520 7461 626c 6520 6173 2066   Save table as f
+0001f3e0: 6974 730a 2020 2020 6361 7461 6c6f 672e  its.    catalog.
+0001f3f0: 7772 6974 6528 7361 7665 5f66 696c 652c  write(save_file,
+0001f400: 206f 7665 7277 7269 7465 203d 2054 7275   overwrite = Tru
+0001f410: 6529 0a0a 0a64 6566 2064 6f77 6e6c 6f61  e)...def downloa
+0001f420: 645f 7265 6665 7265 6e63 6528 7265 6665  d_reference(refe
+0001f430: 7265 6e63 652c 2073 6176 655f 6669 6c65  rence, save_file
+0001f440: 2c20 696d 6167 6520 3d20 4e6f 6e65 2c0a  , image = None,.
+0001f450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f460: 2020 2020 2020 2066 6965 6c64 4944 5f63         fieldID_c
+0001f470: 6174 616c 6f67 203d 204e 6f6e 6529 3a0a  atalog = None):.
+0001f480: 2020 2020 2222 220a 2020 2020 4765 6e65      """.    Gene
+0001f490: 7261 6c20 6675 6e63 7469 6f6e 2074 6f20  ral function to 
+0001f4a0: 646f 776e 6c6f 6164 2061 2073 7065 6369  download a speci
+0001f4b0: 6669 6320 7265 6665 7265 6e63 6520 6361  fic reference ca
+0001f4c0: 7461 6c6f 670a 0a20 2020 2050 6172 616d  talog..    Param
+0001f4d0: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
+0001f4e0: 2d2d 2d2d 0a20 2020 2069 6d61 6765 203a  ----.    image :
+0001f4f0: 2073 7472 0a20 2020 2020 2020 204c 6f63   str.        Loc
+0001f500: 6174 696f 6e20 6f66 2074 6865 2073 706c  ation of the spl
+0001f510: 7573 2069 6d61 6765 2028 6d75 7374 2062  us image (must b
+0001f520: 6520 2e66 7a29 0a20 2020 2072 6566 6572  e .fz).    refer
+0001f530: 656e 6365 203a 2073 7472 0a20 2020 2020  ence : str.     
+0001f540: 2020 2049 6e64 6963 6961 7465 7320 7468     Indiciates th
+0001f550: 6520 7265 6665 7265 6e63 6520 6361 7461  e reference cata
+0001f560: 6c6f 6720 746f 2064 6f77 6e6c 6f61 640a  log to download.
+0001f570: 2020 2020 7361 7665 5f66 696c 6520 3a20      save_file : 
+0001f580: 7374 720a 2020 2020 2020 2020 4c6f 6361  str.        Loca
+0001f590: 7469 6f6e 2074 6f20 7361 7665 2074 6865  tion to save the
+0001f5a0: 2072 6574 7269 6576 6564 2063 6174 616c   retrieved catal
+0001f5b0: 6f67 2028 6d75 7374 2062 6520 2e66 6974  og (must be .fit
+0001f5c0: 7329 0a0a 2020 2020 5265 7475 726e 730a  s)..    Returns.
+0001f5d0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+0001f5e0: 5361 7665 7320 6361 7461 6c6f 6720 696e  Saves catalog in
+0001f5f0: 2074 6865 2064 6573 6972 6564 206c 6f63   the desired loc
+0001f600: 6174 696f 6e0a 2020 2020 2222 220a 0a20  ation.    """.. 
+0001f610: 2020 2069 6620 7265 6665 7265 6e63 652e     if reference.
+0001f620: 6c6f 7765 7228 2920 3d3d 2027 6761 6c65  lower() == 'gale
+0001f630: 7827 3a0a 2020 2020 2020 2020 646f 776e  x':.        down
+0001f640: 6c6f 6164 5f67 616c 6578 2873 6176 655f  load_galex(save_
+0001f650: 6669 6c65 3d73 6176 655f 6669 6c65 2c20  file=save_file, 
+0001f660: 696d 6167 653d 696d 6167 652c 0a20 2020  image=image,.   
+0001f670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f680: 2020 2020 6669 656c 6449 445f 6361 7461      fieldID_cata
+0001f690: 6c6f 673d 6669 656c 6449 445f 6361 7461  log=fieldID_cata
+0001f6a0: 6c6f 6729 0a0a 2020 2020 656c 6966 2072  log)..    elif r
+0001f6b0: 6566 6572 656e 6365 2e6c 6f77 6572 2829  eference.lower()
+0001f6c0: 203d 3d20 2772 6566 6361 7432 273a 0a20   == 'refcat2':. 
+0001f6d0: 2020 2020 2020 2064 6f77 6e6c 6f61 645f         download_
+0001f6e0: 7265 6663 6174 3228 7361 7665 5f66 696c  refcat2(save_fil
+0001f6f0: 653d 7361 7665 5f66 696c 652c 2069 6d61  e=save_file, ima
+0001f700: 6765 3d69 6d61 6765 2c0a 2020 2020 2020  ge=image,.      
+0001f710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f720: 2020 2066 6965 6c64 4944 5f63 6174 616c     fieldID_catal
+0001f730: 6f67 3d66 6965 6c64 4944 5f63 6174 616c  og=fieldID_catal
+0001f740: 6f67 290a 0a20 2020 2065 6c69 6620 7265  og)..    elif re
+0001f750: 6665 7265 6e63 652e 6c6f 7765 7228 2920  ference.lower() 
+0001f760: 3d3d 2027 6976 657a 6963 273a 0a20 2020  == 'ivezic':.   
+0001f770: 2020 2020 2064 6f77 6e6c 6f61 645f 6976       download_iv
+0001f780: 657a 6963 2873 6176 655f 6669 6c65 3d73  ezic(save_file=s
+0001f790: 6176 655f 6669 6c65 2c20 696d 6167 653d  ave_file, image=
+0001f7a0: 696d 6167 652c 0a20 2020 2020 2020 2020  image,.         
+0001f7b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001f7c0: 6965 6c64 4944 5f63 6174 616c 6f67 3d66  ieldID_catalog=f
+0001f7d0: 6965 6c64 4944 5f63 6174 616c 6f67 290a  ieldID_catalog).
+0001f7e0: 0a20 2020 2065 6c69 6620 7265 6665 7265  .    elif refere
+0001f7f0: 6e63 652e 6c6f 7765 7228 2920 3d3d 2027  nce.lower() == '
+0001f800: 6976 657a 6963 6162 273a 0a20 2020 2020  ivezicab':.     
+0001f810: 2020 2064 6f77 6e6c 6f61 645f 6976 657a     download_ivez
+0001f820: 6963 4142 2873 6176 655f 6669 6c65 3d73  icAB(save_file=s
+0001f830: 6176 655f 6669 6c65 2c20 696d 6167 653d  ave_file, image=
+0001f840: 696d 6167 652c 0a20 2020 2020 2020 2020  image,.         
+0001f850: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001f860: 6965 6c64 4944 5f63 6174 616c 6f67 3d66  ieldID_catalog=f
+0001f870: 6965 6c64 4944 5f63 6174 616c 6f67 290a  ieldID_catalog).
+0001f880: 2020 2020 0a20 2020 2065 6c69 6620 7265      .    elif re
+0001f890: 6665 7265 6e63 652e 6c6f 7765 7228 2920  ference.lower() 
+0001f8a0: 3d3d 2027 6976 657a 6963 6162 3227 3a0a  == 'ivezicab2':.
+0001f8b0: 2020 2020 2020 2020 646f 776e 6c6f 6164          download
+0001f8c0: 5f69 7665 7a69 6341 4232 2873 6176 655f  _ivezicAB2(save_
+0001f8d0: 6669 6c65 3d73 6176 655f 6669 6c65 2c20  file=save_file, 
+0001f8e0: 696d 6167 653d 696d 6167 652c 0a20 2020  image=image,.   
+0001f8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f900: 2020 2020 2066 6965 6c64 4944 5f63 6174       fieldID_cat
+0001f910: 616c 6f67 3d66 6965 6c64 4944 5f63 6174  alog=fieldID_cat
+0001f920: 616c 6f67 290a 2020 2020 0a20 2020 2065  alog).    .    e
+0001f930: 6c69 6620 7265 6665 7265 6e63 652e 6c6f  lif reference.lo
+0001f940: 7765 7228 2920 3d3d 2027 7364 7373 273a  wer() == 'sdss':
+0001f950: 0a20 2020 2020 2020 2064 6f77 6e6c 6f61  .        downloa
+0001f960: 645f 7364 7373 2873 6176 655f 6669 6c65  d_sdss(save_file
+0001f970: 3d73 6176 655f 6669 6c65 2c20 696d 6167  =save_file, imag
+0001f980: 653d 696d 6167 652c 0a20 2020 2020 2020  e=image,.       
+0001f990: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001f9a0: 6965 6c64 4944 5f63 6174 616c 6f67 3d66  ieldID_catalog=f
+0001f9b0: 6965 6c64 4944 5f63 6174 616c 6f67 290a  ieldID_catalog).
+0001f9c0: 0a20 2020 2065 6c69 6620 7265 6665 7265  .    elif refere
+0001f9d0: 6e63 652e 6c6f 7765 7228 2920 3d3d 2027  nce.lower() == '
+0001f9e0: 7364 7373 3136 273a 0a20 2020 2020 2020  sdss16':.       
+0001f9f0: 2064 6f77 6e6c 6f61 645f 7364 7373 3136   download_sdss16
+0001fa00: 2873 6176 655f 6669 6c65 3d73 6176 655f  (save_file=save_
+0001fa10: 6669 6c65 2c20 696d 6167 653d 696d 6167  file, image=imag
+0001fa20: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0001fa30: 2020 2020 2020 2020 2066 6965 6c64 4944           fieldID
+0001fa40: 5f63 6174 616c 6f67 3d66 6965 6c64 4944  _catalog=fieldID
+0001fa50: 5f63 6174 616c 6f67 290a 0a20 2020 2065  _catalog)..    e
+0001fa60: 6c69 6620 7265 6665 7265 6e63 652e 6c6f  lif reference.lo
+0001fa70: 7765 7228 2920 3d3d 2027 6761 6961 273a  wer() == 'gaia':
+0001fa80: 0a20 2020 2020 2020 2064 6f77 6e6c 6f61  .        downloa
+0001fa90: 645f 6761 6961 2873 6176 655f 6669 6c65  d_gaia(save_file
+0001faa0: 3d73 6176 655f 6669 6c65 2c20 696d 6167  =save_file, imag
+0001fab0: 653d 696d 6167 652c 0a20 2020 2020 2020  e=image,.       
+0001fac0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001fad0: 6965 6c64 4944 5f63 6174 616c 6f67 3d66  ieldID_catalog=f
+0001fae0: 6965 6c64 4944 5f63 6174 616c 6f67 290a  ieldID_catalog).
+0001faf0: 0a20 2020 2065 6c69 6620 7265 6665 7265  .    elif refere
+0001fb00: 6e63 652e 6c6f 7765 7228 2920 3d3d 2027  nce.lower() == '
+0001fb10: 6761 6961 6472 3227 3a0a 2020 2020 2020  gaiadr2':.      
+0001fb20: 2020 646f 776e 6c6f 6164 5f67 6169 6164    download_gaiad
+0001fb30: 7232 2873 6176 655f 6669 6c65 3d73 6176  r2(save_file=sav
+0001fb40: 655f 6669 6c65 2c20 696d 6167 653d 696d  e_file, image=im
+0001fb50: 6167 652c 0a20 2020 2020 2020 2020 2020  age,.           
+0001fb60: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+0001fb70: 656c 6449 445f 6361 7461 6c6f 673d 6669  eldID_catalog=fi
+0001fb80: 656c 6449 445f 6361 7461 6c6f 6729 0a0a  eldID_catalog)..
+0001fb90: 2020 2020 656c 6966 2072 6566 6572 656e      elif referen
+0001fba0: 6365 2e6c 6f77 6572 2829 203d 3d20 2767  ce.lower() == 'g
+0001fbb0: 6169 6164 7233 273a 0a20 2020 2020 2020  aiadr3':.       
+0001fbc0: 2070 7269 6e74 2866 2264 6f77 6e6c 6f61   print(f"downloa
+0001fbd0: 645f 6761 6961 3328 7361 7665 5f66 696c  d_gaia3(save_fil
+0001fbe0: 653d 7b73 6176 655f 6669 6c65 7d2c 2229  e={save_file},")
+0001fbf0: 0a20 2020 2020 2020 2070 7269 6e74 2866  .        print(f
+0001fc00: 2220 2020 2020 2020 2020 2020 2020 2020  "               
+0001fc10: 696d 6167 653d 7b69 6d61 6765 7d2c 2229  image={image},")
+0001fc20: 0a20 2020 2020 2020 2070 7269 6e74 2866  .        print(f
+0001fc30: 2220 2020 2020 2020 2020 2020 2020 2020  "               
+0001fc40: 6669 656c 6449 445f 6361 7461 6c6f 673d  fieldID_catalog=
+0001fc50: 7b66 6965 6c64 4944 5f63 6174 616c 6f67  {fieldID_catalog
+0001fc60: 7d29 2229 0a20 2020 2020 2020 2064 6f77  })").        dow
+0001fc70: 6e6c 6f61 645f 6761 6961 3328 7361 7665  nload_gaia3(save
+0001fc80: 5f66 696c 653d 7361 7665 5f66 696c 652c  _file=save_file,
+0001fc90: 2069 6d61 6765 3d69 6d61 6765 2c0a 2020   image=image,.  
+0001fca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fcb0: 2020 2020 2020 2066 6965 6c64 4944 5f63         fieldID_c
+0001fcc0: 6174 616c 6f67 3d66 6965 6c64 4944 5f63  atalog=fieldID_c
+0001fcd0: 6174 616c 6f67 290a 0a20 2020 2065 6c69  atalog)..    eli
+0001fce0: 6620 7265 6665 7265 6e63 652e 6c6f 7765  f reference.lowe
+0001fcf0: 7228 2920 3d3d 2027 736b 796d 6170 7065  r() == 'skymappe
+0001fd00: 7227 3a0a 2020 2020 2020 2020 646f 776e  r':.        down
+0001fd10: 6c6f 6164 5f73 6b79 6d61 7070 6572 2873  load_skymapper(s
+0001fd20: 6176 655f 6669 6c65 3d73 6176 655f 6669  ave_file=save_fi
+0001fd30: 6c65 2c20 696d 6167 653d 696d 6167 652c  le, image=image,
+0001fd40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fd50: 2020 2020 2020 2020 2020 6669 656c 6449            fieldI
+0001fd60: 445f 6361 7461 6c6f 673d 6669 656c 6449  D_catalog=fieldI
+0001fd70: 445f 6361 7461 6c6f 6729 0a0a 2020 2020  D_catalog)..    
+0001fd80: 656c 7365 3a0a 2020 2020 2020 2020 7261  else:.        ra
+0001fd90: 6973 6520 5661 6c75 6545 7272 6f72 2828  ise ValueError((
+0001fda0: 6622 5265 6665 7265 6e63 6520 7b72 6566  f"Reference {ref
+0001fdb0: 6572 656e 6365 7d20 6973 206e 6f74 2073  erence} is not s
+0001fdc0: 7570 706f 7274 6564 2e20 4375 7272 656e  upported. Curren
+0001fdd0: 746c 7920 220a 2020 2020 2020 2020 2020  tly ".          
+0001fde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fdf0: 2273 7570 706f 7274 6564 2076 616c 7565  "supported value
+0001fe00: 7320 6172 6520 2747 414c 4558 272c 2027  s are 'GALEX', '
+0001fe10: 5245 4643 4154 3227 2c20 2749 5645 5a49  REFCAT2', 'IVEZI
+0001fe20: 4327 2c20 220a 2020 2020 2020 2020 2020  C', ".          
+0001fe30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fe40: 2227 5344 5353 272c 2061 6e64 2027 4741  "'SDSS', and 'GA
+0001fe50: 4941 2722 2929 0a0a 0a64 6566 2063 726f  IA'"))...def cro
+0001fe60: 7373 6d61 7463 685f 6361 7461 6c6f 675f  ssmatch_catalog_
+0001fe70: 6e61 6d65 2866 6965 6c64 2c20 636f 6e66  name(field, conf
+0001fe80: 293a 0a20 2020 2022 2222 0a20 2020 2047  ):.    """.    G
+0001fe90: 656e 6572 6174 6573 2074 6865 206e 616d  enerates the nam
+0001fea0: 6520 6f66 2074 6865 2053 2d50 4c55 532f  e of the S-PLUS/
+0001feb0: 7265 6665 7265 6e63 6573 2063 726f 7373  references cross
+0001fec0: 6d61 7463 6865 6420 6361 7461 6c6f 6720  matched catalog 
+0001fed0: 7461 6b69 6e67 0a20 2020 2069 6e74 6f20  taking.    into 
+0001fee0: 6163 636f 756e 7420 7468 6520 7068 6f74  account the phot
+0001fef0: 6f6d 6574 7279 206d 6f64 6520 616e 6420  ometry mode and 
+0001ff00: 7468 6520 7265 6665 7265 6e63 6520 6361  the reference ca
+0001ff10: 7461 6c6f 6728 7329 2075 7365 6420 666f  talog(s) used fo
+0001ff20: 720a 2020 2020 6361 6c69 6272 6174 696f  r.    calibratio
+0001ff30: 6e0a 0a20 2020 2050 6172 616d 6574 6572  n..    Parameter
+0001ff40: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+0001ff50: 0a20 2020 2066 6965 6c64 203a 2073 7472  .    field : str
+0001ff60: 0a20 2020 2020 2020 204e 616d 6520 6f66  .        Name of
+0001ff70: 2074 6865 2053 2d50 4c55 5320 6669 656c   the S-PLUS fiel
+0001ff80: 640a 2020 2020 636f 6e66 203a 2064 6963  d.    conf : dic
+0001ff90: 740a 2020 2020 2020 2020 4469 6374 696f  t.        Dictio
+0001ffa0: 6e61 7279 206c 6f61 6465 6420 6672 6f6d  nary loaded from
+0001ffb0: 2074 6865 2063 6f6e 6669 6775 7261 7469   the configurati
+0001ffc0: 6f6e 2066 696c 650a 0a20 2020 2052 6574  on file..    Ret
+0001ffd0: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+0001ffe0: 0a20 2020 2073 7472 0a20 2020 2020 2020  .    str.       
+0001fff0: 204e 616d 6520 6f66 2074 6865 2063 726f   Name of the cro
+00020000: 7373 6d61 7463 6865 6420 6361 7461 6c6f  ssmatched catalo
+00020010: 670a 2020 2020 2222 220a 0a20 2020 2063  g.    """..    c
+00020020: 616c 6962 5f70 686f 7420 3d20 636f 6e66  alib_phot = conf
+00020030: 5b27 6361 6c69 6272 6174 696f 6e5f 7068  ['calibration_ph
+00020040: 6f74 6f6d 6574 7279 275d 0a20 2020 2063  otometry'].    c
+00020050: 6d61 7463 685f 6e61 6d65 203d 2066 227b  match_name = f"{
+00020060: 6669 656c 647d 5f53 504c 5553 5f7b 6361  field}_SPLUS_{ca
+00020070: 6c69 625f 7068 6f74 7d22 0a0a 2020 2020  lib_phot}"..    
+00020080: 6e72 6566 203d 206c 656e 2863 6f6e 665b  nref = len(conf[
+00020090: 2772 6566 6572 656e 6365 5f63 6174 616c  'reference_catal
+000200a0: 6f67 275d 290a 2020 2020 666f 7220 6920  og']).    for i 
+000200b0: 696e 2072 616e 6765 286e 7265 6629 3a0a  in range(nref):.
+000200c0: 2020 2020 2020 2020 636d 6174 6368 5f6e          cmatch_n
+000200d0: 616d 6520 2b3d 2066 225f 7b63 6f6e 665b  ame += f"_{conf[
+000200e0: 2772 6566 6572 656e 6365 5f63 6174 616c  'reference_catal
+000200f0: 6f67 275d 5b69 5d7d 220a 0a20 2020 2063  og'][i]}"..    c
+00020100: 6d61 7463 685f 6e61 6d65 202b 3d20 222e  match_name += ".
+00020110: 6669 7473 220a 0a20 2020 2072 6574 7572  fits"..    retur
+00020120: 6e20 636d 6174 6368 5f6e 616d 650a 0a0a  n cmatch_name...
+00020130: 6465 6620 636f 6e76 6572 745f 6761 6961  def convert_gaia
+00020140: 5f56 6567 6132 4142 2867 6169 615f 6361  _Vega2AB(gaia_ca
+00020150: 7461 6c6f 672c 2073 6176 655f 6669 6c65  talog, save_file
+00020160: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
+00020170: 6f6e 7665 7274 7320 6761 6961 206d 6167  onverts gaia mag
+00020180: 6e69 7475 6465 7320 6672 6f6d 2056 4547  nitudes from VEG
+00020190: 4120 7379 7374 656d 2074 6f20 4142 2073  A system to AB s
+000201a0: 7973 7465 6d0a 0a20 2020 2067 6169 615f  ystem..    gaia_
+000201b0: 6361 7461 6c6f 673a 2073 7472 0a20 2020  catalog: str.   
+000201c0: 2020 2020 206f 7574 7075 7420 6f66 2064       output of d
+000201d0: 6f77 6e6c 6f61 645f 6761 6961 6472 320a  ownload_gaiadr2.
+000201e0: 2020 2020 7361 7665 5f66 696c 653a 2073      save_file: s
+000201f0: 7472 0a20 2020 2020 2020 2070 6174 6820  tr.        path 
+00020200: 7768 6572 6520 7468 6520 6f75 7470 7574  where the output
+00020210: 2041 4220 6d61 676e 6974 7564 6573 2077   AB magnitudes w
+00020220: 696c 6c20 6265 2073 6176 6564 0a20 2020  ill be saved.   
+00020230: 2022 2222 0a0a 2020 2020 2320 436f 6e76   """..    # Conv
+00020240: 6572 7369 6f6e 2063 6f6e 7374 616e 7473  ersion constants
+00020250: 0a20 2020 2023 2072 6566 6572 656e 6365  .    # reference
+00020260: 2068 7474 7073 3a2f 2f67 6561 2e65 7361   https://gea.esa
+00020270: 632e 6573 612e 696e 742f 6172 6368 6976  c.esa.int/archiv
+00020280: 652f 646f 6375 6d65 6e74 6174 696f 6e2f  e/documentation/
+00020290: 4744 5232 2f44 6174 615f 7072 6f63 6573  GDR2/Data_proces
+000202a0: 7369 6e67 2f63 6861 705f 6375 3570 686f  sing/chap_cu5pho
+000202b0: 2f73 6563 5f63 7535 7068 6f5f 6361 6c69  /sec_cu5pho_cali
+000202c0: 6272 2f73 7365 635f 6375 3570 686f 5f63  br/ssec_cu5pho_c
+000202d0: 616c 6962 725f 6578 7465 726e 2e68 746d  alibr_extern.htm
+000202e0: 6c0a 2020 2020 7a70 5f47 5f56 6567 6120  l.    zp_G_Vega 
+000202f0: 203d 2032 352e 3638 3834 0a20 2020 207a   = 25.6884.    z
+00020300: 705f 4250 5f56 6567 6120 3d20 3235 2e33  p_BP_Vega = 25.3
+00020310: 3531 340a 2020 2020 7a70 5f52 505f 5665  514.    zp_RP_Ve
+00020320: 6761 203d 2032 342e 3736 3139 0a0a 2020  ga = 24.7619..  
+00020330: 2020 7a70 5f47 5f41 4220 203d 2032 352e    zp_G_AB  = 25.
+00020340: 3739 3334 0a20 2020 207a 705f 4250 5f41  7934.    zp_BP_A
+00020350: 4220 3d20 3235 2e33 3830 360a 2020 2020  B = 25.3806.    
+00020360: 7a70 5f52 505f 4142 203d 2032 352e 3131  zp_RP_AB = 25.11
+00020370: 3631 0a0a 2020 2020 2320 4c6f 6164 2047  61..    # Load G
+00020380: 4149 4120 5645 4741 2063 6174 616c 6f67  AIA VEGA catalog
+00020390: 0a20 2020 2023 204c 6f61 6420 7068 6f74  .    # Load phot
+000203a0: 6f6d 6574 7279 2063 6174 616c 6f67 2028  ometry catalog (
+000203b0: 7769 7468 2061 7065 7274 7572 6520 636f  with aperture co
+000203c0: 7272 6563 7469 6f6e 290a 2020 2020 7665  rrection).    ve
+000203d0: 6761 5f63 6174 203d 2066 6974 732e 6f70  ga_cat = fits.op
+000203e0: 656e 2867 6169 615f 6361 7461 6c6f 6729  en(gaia_catalog)
+000203f0: 0a20 2020 2076 6567 615f 6361 7420 3d20  .    vega_cat = 
+00020400: 7665 6761 5f63 6174 5b31 5d2e 6461 7461  vega_cat[1].data
+00020410: 0a0a 2020 2020 2320 4372 6561 7465 206e  ..    # Create n
+00020420: 6577 2064 6174 6120 5461 626c 650a 2020  ew data Table.  
+00020430: 2020 6361 7420 3d20 5b5d 0a0a 2020 2020    cat = []..    
+00020440: 666f 7220 636f 6c20 696e 2076 6567 615f  for col in vega_
+00020450: 6361 742e 636f 6c75 6d6e 733a 0a20 2020  cat.columns:.   
+00020460: 2020 2020 2069 6620 636f 6c2e 6e61 6d65       if col.name
+00020470: 203d 3d20 2247 4149 415f 4722 3a0a 2020   == "GAIA_G":.  
+00020480: 2020 2020 2020 2020 2020 636f 6c2e 6172            col.ar
+00020490: 7261 7920 2b3d 207a 705f 475f 4142 202d  ray += zp_G_AB -
+000204a0: 207a 705f 475f 5665 6761 0a20 2020 2020   zp_G_Vega.     
+000204b0: 2020 2065 6c69 6620 636f 6c2e 6e61 6d65     elif col.name
+000204c0: 203d 3d20 2247 4149 415f 4250 223a 0a20   == "GAIA_BP":. 
+000204d0: 2020 2020 2020 2020 2020 2063 6f6c 2e61             col.a
+000204e0: 7272 6179 202b 3d20 7a70 5f42 505f 4142  rray += zp_BP_AB
+000204f0: 202d 207a 705f 4250 5f56 6567 610a 2020   - zp_BP_Vega.  
+00020500: 2020 2020 2020 656c 6966 2063 6f6c 2e6e        elif col.n
+00020510: 616d 6520 3d3d 2022 4741 4941 5f52 5022  ame == "GAIA_RP"
+00020520: 3a0a 2020 2020 2020 2020 2020 2020 636f  :.            co
+00020530: 6c2e 6172 7261 7920 2b3d 207a 705f 5250  l.array += zp_RP
+00020540: 5f41 4220 2d20 7a70 5f52 505f 5665 6761  _AB - zp_RP_Vega
+00020550: 0a0a 2020 2020 2020 2020 6361 742e 6170  ..        cat.ap
+00020560: 7065 6e64 2863 6f6c 290a 0a20 2020 2068  pend(col)..    h
+00020570: 6475 6c5f 7661 6320 3d20 6669 7473 2e42  dul_vac = fits.B
+00020580: 696e 5461 626c 6548 4455 2e66 726f 6d5f  inTableHDU.from_
+00020590: 636f 6c75 6d6e 7328 6361 7429 0a20 2020  columns(cat).   
+000205a0: 2068 6475 6c5f 7661 632e 7772 6974 6574   hdul_vac.writet
+000205b0: 6f28 7361 7665 5f66 696c 6529 0a0a 0a64  o(save_file)...d
+000205c0: 6566 2063 6f6e 7665 7274 5f67 6169 6144  ef convert_gaiaD
+000205d0: 5233 5f56 6567 6132 4142 2867 6169 615f  R3_Vega2AB(gaia_
+000205e0: 6361 7461 6c6f 672c 2073 6176 655f 6669  catalog, save_fi
+000205f0: 6c65 293a 0a20 2020 2022 2222 0a20 2020  le):.    """.   
+00020600: 2043 6f6e 7665 7274 7320 6761 6961 2044   Converts gaia D
+00020610: 5233 206d 6167 6e69 7475 6465 7320 6672  R3 magnitudes fr
+00020620: 6f6d 2056 4547 4120 7379 7374 656d 2074  om VEGA system t
+00020630: 6f20 4142 2073 7973 7465 6d0a 0a20 2020  o AB system..   
+00020640: 2067 6169 615f 6361 7461 6c6f 673a 2073   gaia_catalog: s
+00020650: 7472 0a20 2020 2020 2020 206f 7574 7075  tr.        outpu
+00020660: 7420 6f66 2064 6f77 6e6c 6f61 645f 6761  t of download_ga
+00020670: 6961 6472 320a 2020 2020 7361 7665 5f66  iadr2.    save_f
+00020680: 696c 653a 2073 7472 0a20 2020 2020 2020  ile: str.       
+00020690: 2070 6174 6820 7768 6572 6520 7468 6520   path where the 
+000206a0: 6f75 7470 7574 2041 4220 6d61 676e 6974  output AB magnit
+000206b0: 7564 6573 2077 696c 6c20 6265 2073 6176  udes will be sav
+000206c0: 6564 0a20 2020 2022 2222 0a0a 2020 2020  ed.    """..    
+000206d0: 2320 436f 6e76 6572 7369 6f6e 2063 6f6e  # Conversion con
+000206e0: 7374 616e 7473 0a20 2020 2023 2052 6566  stants.    # Ref
+000206f0: 6572 656e 6365 2052 6965 6c6c 6f20 6574  erence Riello et
+00020700: 2061 6c2e 2028 3230 3231 293b 2041 2641   al. (2021); A&A
+00020710: 2036 3439 2c20 4133 0a0a 2020 2020 7a70   649, A3..    zp
+00020720: 5f47 5f56 6567 6120 203d 2032 352e 3638  _G_Vega  = 25.68
+00020730: 3734 0a20 2020 207a 705f 4250 5f56 6567  74.    zp_BP_Veg
+00020740: 6120 3d20 3235 2e33 3338 350a 2020 2020  a = 25.3385.    
+00020750: 7a70 5f52 505f 5665 6761 203d 2032 342e  zp_RP_Vega = 24.
+00020760: 3734 3739 0a0a 2020 2020 7a70 5f47 5f41  7479..    zp_G_A
+00020770: 4220 203d 2032 352e 3830 3130 0a20 2020  B  = 25.8010.   
+00020780: 207a 705f 4250 5f41 4220 3d20 3235 2e33   zp_BP_AB = 25.3
+00020790: 3534 300a 2020 2020 7a70 5f52 505f 4142  540.    zp_RP_AB
+000207a0: 203d 2032 352e 3130 3430 0a0a 2020 2020   = 25.1040..    
+000207b0: 2320 4c6f 6164 2047 4149 4120 5645 4741  # Load GAIA VEGA
+000207c0: 2063 6174 616c 6f67 0a20 2020 2023 204c   catalog.    # L
+000207d0: 6f61 6420 7068 6f74 6f6d 6574 7279 2063  oad photometry c
+000207e0: 6174 616c 6f67 2028 7769 7468 2061 7065  atalog (with ape
+000207f0: 7274 7572 6520 636f 7272 6563 7469 6f6e  rture correction
+00020800: 290a 2020 2020 7665 6761 5f63 6174 203d  ).    vega_cat =
+00020810: 2066 6974 732e 6f70 656e 2867 6169 615f   fits.open(gaia_
+00020820: 6361 7461 6c6f 6729 0a20 2020 2076 6567  catalog).    veg
+00020830: 615f 6361 7420 3d20 7665 6761 5f63 6174  a_cat = vega_cat
+00020840: 5b31 5d2e 6461 7461 0a0a 2020 2020 2320  [1].data..    # 
+00020850: 4372 6561 7465 206e 6577 2064 6174 6120  Create new data 
+00020860: 5461 626c 650a 2020 2020 6361 7420 3d20  Table.    cat = 
+00020870: 5b5d 0a0a 2020 2020 666f 7220 636f 6c20  []..    for col 
+00020880: 696e 2076 6567 615f 6361 742e 636f 6c75  in vega_cat.colu
+00020890: 6d6e 733a 0a20 2020 2020 2020 2069 6620  mns:.        if 
+000208a0: 636f 6c2e 6e61 6d65 203d 3d20 2247 4149  col.name == "GAI
+000208b0: 4133 5f47 223a 0a20 2020 2020 2020 2020  A3_G":.         
+000208c0: 2020 2063 6f6c 2e61 7272 6179 202b 3d20     col.array += 
+000208d0: 7a70 5f47 5f41 4220 2d20 7a70 5f47 5f56  zp_G_AB - zp_G_V
+000208e0: 6567 610a 2020 2020 2020 2020 656c 6966  ega.        elif
+000208f0: 2063 6f6c 2e6e 616d 6520 3d3d 2022 4741   col.name == "GA
+00020900: 4941 335f 4250 223a 0a20 2020 2020 2020  IA3_BP":.       
+00020910: 2020 2020 2063 6f6c 2e61 7272 6179 202b       col.array +
+00020920: 3d20 7a70 5f42 505f 4142 202d 207a 705f  = zp_BP_AB - zp_
+00020930: 4250 5f56 6567 610a 2020 2020 2020 2020  BP_Vega.        
+00020940: 656c 6966 2063 6f6c 2e6e 616d 6520 3d3d  elif col.name ==
+00020950: 2022 4741 4941 335f 5250 223a 0a20 2020   "GAIA3_RP":.   
+00020960: 2020 2020 2020 2020 2063 6f6c 2e61 7272           col.arr
+00020970: 6179 202b 3d20 7a70 5f52 505f 4142 202d  ay += zp_RP_AB -
+00020980: 207a 705f 5250 5f56 6567 610a 0a20 2020   zp_RP_Vega..   
+00020990: 2020 2020 2063 6174 2e61 7070 656e 6428       cat.append(
+000209a0: 636f 6c29 0a0a 2020 2020 6864 756c 5f76  col)..    hdul_v
+000209b0: 6163 203d 2066 6974 732e 4269 6e54 6162  ac = fits.BinTab
+000209c0: 6c65 4844 552e 6672 6f6d 5f63 6f6c 756d  leHDU.from_colum
+000209d0: 6e73 2863 6174 290a 2020 2020 6864 756c  ns(cat).    hdul
+000209e0: 5f76 6163 2e77 7269 7465 746f 2873 6176  _vac.writeto(sav
+000209f0: 655f 6669 6c65 290a 0a23 2323 2323 2323  e_file)..#######
+00020a00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00020a10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00020a20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00020a30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00020a40: 2323 2323 2323 2323 230a 2323 2323 2323  #########.######
 00020a50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00020a60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00020a70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00020a80: 2323 2323 230a 2323 2323 2323 2323 2323  #####.##########
-00020a90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00020aa0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00020ab0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00020ac0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00020ad0: 2323 2323 2323 0a23 2045 7874 696e 6374  ######.# Extinct
-00020ae0: 696f 6e20 436f 7272 6563 7469 6f6e 0a0a  ion Correction..
-00020af0: 2320 5072 6576 696f 7573 6c79 0a23 2068  # Previously.# h
-00020b00: 7474 703a 2f2f 7376 6f32 2e63 6162 2e69  ttp://svo2.cab.i
-00020b10: 6e74 612d 6373 6963 2e65 732f 7376 6f2f  nta-csic.es/svo/
-00020b20: 7468 656f 7279 2f66 7073 332f 696e 6465  theory/fps3/inde
-00020b30: 782e 7068 703f 6d6f 6465 3d62 726f 7773  x.php?mode=brows
-00020b40: 650a 5f6c 616d 6264 615f 6566 6620 3d20  e._lambda_eff = 
-00020b50: 7b20 2027 5350 4c55 535f 5527 3a20 3335  {  'SPLUS_U': 35
-00020b60: 3432 2e30 372c 2027 5350 4c55 535f 4633  42.07, 'SPLUS_F3
-00020b70: 3738 273a 2033 3738 332e 3639 2c0a 2020  78': 3783.69,.  
+00020a80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00020a90: 2323 2323 2323 2323 2323 0a23 2045 7874  ##########.# Ext
+00020aa0: 696e 6374 696f 6e20 436f 7272 6563 7469  inction Correcti
+00020ab0: 6f6e 0a0a 2320 5072 6576 696f 7573 6c79  on..# Previously
+00020ac0: 0a23 2068 7474 703a 2f2f 7376 6f32 2e63  .# http://svo2.c
+00020ad0: 6162 2e69 6e74 612d 6373 6963 2e65 732f  ab.inta-csic.es/
+00020ae0: 7376 6f2f 7468 656f 7279 2f66 7073 332f  svo/theory/fps3/
+00020af0: 696e 6465 782e 7068 703f 6d6f 6465 3d62  index.php?mode=b
+00020b00: 726f 7773 650a 5f6c 616d 6264 615f 6566  rowse._lambda_ef
+00020b10: 6620 3d20 7b20 2027 5350 4c55 535f 5527  f = {  'SPLUS_U'
+00020b20: 3a20 3335 3432 2e30 372c 2027 5350 4c55  : 3542.07, 'SPLU
+00020b30: 535f 4633 3738 273a 2033 3738 332e 3639  S_F378': 3783.69
+00020b40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00020b50: 2753 504c 5553 5f46 3339 3527 3a20 3339  'SPLUS_F395': 39
+00020b60: 3430 2e31 372c 2027 5350 4c55 535f 4634  40.17, 'SPLUS_F4
+00020b70: 3130 273a 2034 3039 342e 3633 2c0a 2020  10': 4094.63,.  
 00020b80: 2020 2020 2020 2020 2020 2020 2753 504c              'SPL
-00020b90: 5553 5f46 3339 3527 3a20 3339 3430 2e31  US_F395': 3940.1
-00020ba0: 372c 2027 5350 4c55 535f 4634 3130 273a  7, 'SPLUS_F410':
-00020bb0: 2034 3039 342e 3633 2c0a 2020 2020 2020   4094.63,.      
+00020b90: 5553 5f46 3433 3027 3a20 3432 3836 2e35  US_F430': 4286.5
+00020ba0: 322c 2020 2020 2753 504c 5553 5f47 273a  2,    'SPLUS_G':
+00020bb0: 2034 3731 352e 3833 2c0a 2020 2020 2020   4715.83,.      
 00020bc0: 2020 2020 2020 2020 2753 504c 5553 5f46          'SPLUS_F
-00020bd0: 3433 3027 3a20 3432 3836 2e35 322c 2020  430': 4286.52,  
-00020be0: 2020 2753 504c 5553 5f47 273a 2034 3731    'SPLUS_G': 471
-00020bf0: 352e 3833 2c0a 2020 2020 2020 2020 2020  5.83,.          
-00020c00: 2020 2020 2753 504c 5553 5f46 3531 3527      'SPLUS_F515'
-00020c10: 3a20 3531 3331 2e39 332c 2020 2020 2753  : 5131.93,    'S
-00020c20: 504c 5553 5f52 273a 2036 3230 322e 3537  PLUS_R': 6202.57
+00020bd0: 3531 3527 3a20 3531 3331 2e39 332c 2020  515': 5131.93,  
+00020be0: 2020 2753 504c 5553 5f52 273a 2036 3230    'SPLUS_R': 620
+00020bf0: 322e 3537 2c0a 2020 2020 2020 2020 2020  2.57,.          
+00020c00: 2020 2020 2753 504c 5553 5f46 3636 3027      'SPLUS_F660'
+00020c10: 3a20 3636 3136 2e39 352c 2020 2020 2753  : 6616.95,    'S
+00020c20: 504c 5553 5f49 273a 2037 3632 372e 3031  PLUS_I': 7627.01
 00020c30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020c40: 2753 504c 5553 5f46 3636 3027 3a20 3636  'SPLUS_F660': 66
-00020c50: 3136 2e39 352c 2020 2020 2753 504c 5553  16.95,    'SPLUS
-00020c60: 5f49 273a 2037 3632 372e 3031 2c0a 2020  _I': 7627.01,.  
-00020c70: 2020 2020 2020 2020 2020 2020 2753 504c              'SPL
-00020c80: 5553 5f46 3836 3127 3a20 3836 3037 2e31  US_F861': 8607.1
-00020c90: 372c 2020 2020 2753 504c 5553 5f5a 273a  7,    'SPLUS_Z':
-00020ca0: 2038 3931 332e 3437 2c0a 2020 2020 2020   8913.47,.      
-00020cb0: 2020 2020 2020 2020 2027 4741 4c45 585f           'GALEX_
-00020cc0: 4655 5627 3a20 3135 3439 2e30 322c 2020  FUV': 1549.02,  
-00020cd0: 2747 414c 4558 5f4e 5556 273a 2032 3330  'GALEX_NUV': 230
-00020ce0: 342e 3734 2c0a 2020 2020 2020 2020 2020  4.74,.          
-00020cf0: 2020 2020 2020 2020 2753 4453 535f 5527          'SDSS_U'
-00020d00: 3a20 3336 3038 2e30 342c 2020 2020 2027  : 3608.04,     '
-00020d10: 5344 5353 5f47 273a 2034 3637 312e 3738  SDSS_G': 4671.78
+00020c40: 2753 504c 5553 5f46 3836 3127 3a20 3836  'SPLUS_F861': 86
+00020c50: 3037 2e31 372c 2020 2020 2753 504c 5553  07.17,    'SPLUS
+00020c60: 5f5a 273a 2038 3931 332e 3437 2c0a 2020  _Z': 8913.47,.  
+00020c70: 2020 2020 2020 2020 2020 2020 2027 4741               'GA
+00020c80: 4c45 585f 4655 5627 3a20 3135 3439 2e30  LEX_FUV': 1549.0
+00020c90: 322c 2020 2747 414c 4558 5f4e 5556 273a  2,  'GALEX_NUV':
+00020ca0: 2032 3330 342e 3734 2c0a 2020 2020 2020   2304.74,.      
+00020cb0: 2020 2020 2020 2020 2020 2020 2753 4453              'SDS
+00020cc0: 535f 5527 3a20 3336 3038 2e30 342c 2020  S_U': 3608.04,  
+00020cd0: 2020 2027 5344 5353 5f47 273a 2034 3637     'SDSS_G': 467
+00020ce0: 312e 3738 2c0a 2020 2020 2020 2020 2020  1.78,.          
+00020cf0: 2020 2020 2020 2020 2753 4453 535f 5227          'SDSS_R'
+00020d00: 3a20 3631 3431 2e31 322c 2020 2020 2027  : 6141.12,     '
+00020d10: 5344 5353 5f49 273a 2037 3435 372e 3839  SDSS_I': 7457.89
 00020d20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020d30: 2020 2020 2753 4453 535f 5227 3a20 3631      'SDSS_R': 61
-00020d40: 3431 2e31 322c 2020 2020 2027 5344 5353  41.12,     'SDSS
-00020d50: 5f49 273a 2037 3435 372e 3839 2c0a 2020  _I': 7457.89,.  
+00020d30: 2020 2020 2753 4453 535f 5a27 3a20 3839      'SDSS_Z': 89
+00020d40: 3232 2e37 382c 2020 2020 2020 2027 5053  22.78,       'PS
+00020d50: 5f47 273a 2034 3831 302e 3838 2c0a 2020  _G': 4810.88,.  
 00020d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020d70: 2753 4453 535f 5a27 3a20 3839 3232 2e37  'SDSS_Z': 8922.7
-00020d80: 382c 2020 2020 2020 2027 5053 5f47 273a  8,       'PS_G':
-00020d90: 2034 3831 302e 3838 2c0a 2020 2020 2020   4810.88,.      
+00020d70: 2020 2750 535f 5227 3a20 3631 3536 2e33    'PS_R': 6156.3
+00020d80: 362c 2020 2020 2020 2027 5053 5f49 273a  6,       'PS_I':
+00020d90: 2037 3530 332e 3638 2c0a 2020 2020 2020   7503.68,.      
 00020da0: 2020 2020 2020 2020 2020 2020 2020 2750                'P
-00020db0: 535f 5227 3a20 3631 3536 2e33 362c 2020  S_R': 6156.36,  
-00020dc0: 2020 2020 2027 5053 5f49 273a 2037 3530       'PS_I': 750
-00020dd0: 332e 3638 2c0a 2020 2020 2020 2020 2020  3.68,.          
-00020de0: 2020 2020 2020 2020 2020 2750 535f 5a27            'PS_Z'
-00020df0: 3a20 3836 3638 2e35 362c 2020 2020 2747  : 8668.56,    'G
-00020e00: 4149 415f 4250 273a 2035 3032 302e 3932  AIA_BP': 5020.92
+00020db0: 535f 5a27 3a20 3836 3638 2e35 362c 2020  S_Z': 8668.56,  
+00020dc0: 2020 2747 4149 415f 4250 273a 2035 3032    'GAIA_BP': 502
+00020dd0: 302e 3932 2c0a 2020 2020 2020 2020 2020  0.92,.          
+00020de0: 2020 2020 2020 2020 2747 4149 415f 4727          'GAIA_G'
+00020df0: 3a20 3538 3336 2e33 312c 2020 2020 2747  : 5836.31,    'G
+00020e00: 4149 415f 5250 273a 2037 3538 382e 3833  AIA_RP': 7588.83
 00020e10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020e20: 2020 2020 2747 4149 415f 4727 3a20 3538      'GAIA_G': 58
-00020e30: 3336 2e33 312c 2020 2020 2747 4149 415f  36.31,    'GAIA_
-00020e40: 5250 273a 2037 3538 382e 3833 2c0a 2020  RP': 7588.83,.  
+00020e20: 2020 2020 2020 2753 4d5f 5527 3a20 3335        'SM_U': 35
+00020e30: 3030 2e32 322c 2020 2020 2020 2027 534d  00.22,       'SM
+00020e40: 5f56 273a 2033 3837 382e 3638 2c0a 2020  _V': 3878.68,.  
 00020e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020e60: 2020 2753 4d5f 5527 3a20 3335 3030 2e32    'SM_U': 3500.2
-00020e70: 322c 2020 2020 2020 2027 534d 5f56 273a  2,       'SM_V':
-00020e80: 2033 3837 382e 3638 2c0a 2020 2020 2020   3878.68,.      
+00020e60: 2020 2753 4d5f 4727 3a20 3530 3136 2e30    'SM_G': 5016.0
+00020e70: 352c 2020 2020 2020 2027 534d 5f52 273a  5,       'SM_R':
+00020e80: 2036 3037 362e 3835 2c0a 2020 2020 2020   6076.85,.      
 00020e90: 2020 2020 2020 2020 2020 2020 2020 2753                'S
-00020ea0: 4d5f 4727 3a20 3530 3136 2e30 352c 2020  M_G': 5016.05,  
-00020eb0: 2020 2020 2027 534d 5f52 273a 2036 3037       'SM_R': 607
-00020ec0: 362e 3835 2c0a 2020 2020 2020 2020 2020  6.85,.          
-00020ed0: 2020 2020 2020 2020 2020 2753 4d5f 4927            'SM_I'
-00020ee0: 3a20 3737 3332 2e38 332c 2020 2020 2020  : 7732.83,      
-00020ef0: 2027 534d 5f5a 273a 2039 3132 302e 3235   'SM_Z': 9120.25
+00020ea0: 4d5f 4927 3a20 3737 3332 2e38 332c 2020  M_I': 7732.83,  
+00020eb0: 2020 2020 2027 534d 5f5a 273a 2039 3132       'SM_Z': 912
+00020ec0: 302e 3235 2c0a 2020 2020 2020 2020 2020  0.25,.          
+00020ed0: 2020 2020 2020 2027 4741 4941 335f 4727         'GAIA3_G'
+00020ee0: 3a20 3538 3232 2e33 392c 2020 2027 4741  : 5822.39,   'GA
+00020ef0: 4941 335f 4250 273a 2035 3033 352e 3735  IA3_BP': 5035.75
 00020f00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020f10: 2020 2027 4741 4941 335f 4727 3a20 3538     'GAIA3_G': 58
-00020f20: 3232 2e33 392c 2020 2027 4741 4941 335f  22.39,   'GAIA3_
-00020f30: 4250 273a 2035 3033 352e 3735 2c0a 2020  BP': 5035.75,.  
-00020f40: 2020 2020 2020 2020 2020 2020 2020 2747                'G
-00020f50: 4149 4133 5f52 5027 3a20 3736 3139 2e39  AIA3_RP': 7619.9
-00020f60: 367d 0a0a 2320 5072 6576 696f 7573 6c79  6}..# Previously
-00020f70: 0a23 2073 6f75 7263 653a 2068 7474 703a  .# source: http:
-00020f80: 2f2f 7374 6576 2e6f 6170 642e 696e 6166  //stev.oapd.inaf
-00020f90: 2e69 742f 6367 692d 6269 6e2f 636d 645f  .it/cgi-bin/cmd_
-00020fa0: 332e 350a 235f 416c 616d 6264 615f 4176  3.5.#_Alambda_Av
-00020fb0: 203d 207b 2020 2753 504c 5553 5f55 273a   = {  'SPLUS_U':
-00020fc0: 2031 2e36 3036 3734 2c20 2753 504c 5553   1.60674, 'SPLUS
-00020fd0: 5f46 3337 3827 3a20 312e 3438 3730 342c  _F378': 1.48704,
-00020fe0: 0a23 2020 2020 2020 2020 2020 2020 2020  .#              
-00020ff0: 2753 504c 5553 5f46 3339 3527 3a20 312e  'SPLUS_F395': 1.
-00021000: 3433 3937 392c 2027 5350 4c55 535f 4634  43979, 'SPLUS_F4
-00021010: 3130 273a 2031 2e34 3030 3233 2c0a 2320  10': 1.40023,.# 
-00021020: 2020 2020 2020 2020 2020 2020 2027 5350               'SP
-00021030: 4c55 535f 4634 3330 273a 2031 2e33 3438  LUS_F430': 1.348
-00021040: 3937 2c20 2020 2027 5350 4c55 535f 4727  97,    'SPLUS_G'
-00021050: 3a20 312e 3231 3235 362c 0a23 2020 2020  : 1.21256,.#    
-00021060: 2020 2020 2020 2020 2020 2753 504c 5553            'SPLUS
-00021070: 5f46 3531 3527 3a20 312e 3039 3138 372c  _F515': 1.09187,
-00021080: 2020 2020 2753 504c 5553 5f52 273a 2030      'SPLUS_R': 0
-00021090: 2e38 3534 3635 2c0a 2320 2020 2020 2020  .85465,.#       
-000210a0: 2020 2020 2020 2027 5350 4c55 535f 4636         'SPLUS_F6
-000210b0: 3630 273a 2030 2e38 3037 3139 2c20 2020  60': 0.80719,   
-000210c0: 2027 5350 4c55 535f 4927 3a20 302e 3635   'SPLUS_I': 0.65
-000210d0: 3037 312c 0a23 2020 2020 2020 2020 2020  071,.#          
-000210e0: 2020 2020 2753 504c 5553 5f46 3836 3127      'SPLUS_F861'
-000210f0: 3a20 302e 3532 3036 342c 2020 2020 2753  : 0.52064,    'S
-00021100: 504c 5553 5f5a 273a 2030 2e34 3236 3334  PLUS_Z': 0.42634
-00021110: 2c0a 2320 2020 2020 2020 2020 2020 2020  ,.#             
-00021120: 2020 2747 414c 4558 5f46 5556 273a 2032    'GALEX_FUV': 2
-00021130: 2e36 3136 3836 2c20 2027 4741 4c45 585f  .61686,  'GALEX_
-00021140: 4e55 5627 3a20 322e 3830 3831 372c 0a23  NUV': 2.80817,.#
-00021150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021160: 2020 2753 4453 535f 5527 3a20 312e 3537    'SDSS_U': 1.57
-00021170: 3436 352c 2020 2020 2027 5344 5353 5f47  465,     'SDSS_G
-00021180: 273a 2031 2e32 3236 3531 2c0a 2320 2020  ': 1.22651,.#   
-00021190: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000211a0: 5344 5353 5f52 273a 2030 2e38 3636 3339  SDSS_R': 0.86639
-000211b0: 2c20 2020 2020 2753 4453 535f 4927 3a20  ,     'SDSS_I': 
-000211c0: 302e 3638 3331 312c 0a23 2020 2020 2020  0.68311,.#      
-000211d0: 2020 2020 2020 2020 2020 2020 2753 4453              'SDS
-000211e0: 535f 5a27 3a20 302e 3438 3234 352c 2020  S_Z': 0.48245,  
-000211f0: 2020 2020 2027 5053 5f47 273a 2031 2e31       'PS_G': 1.1
-00021200: 3739 3934 2c0a 2320 2020 2020 2020 2020  7994,.#         
-00021210: 2020 2020 2020 2020 2020 2027 5053 5f52             'PS_R
-00021220: 273a 2030 2e38 3631 3930 2c20 2020 2020  ': 0.86190,     
-00021230: 2020 2750 535f 4927 3a20 302e 3637 3634    'PS_I': 0.6764
-00021240: 382c 0a23 2020 2020 2020 2020 2020 2020  8,.#            
-00021250: 2020 2020 2020 2020 2750 535f 5a27 3a20          'PS_Z': 
-00021260: 302e 3531 3239 362c 2020 2020 2747 4149  0.51296,    'GAI
-00021270: 415f 4250 273a 2031 2e30 3939 3039 2c0a  A_BP': 1.09909,.
-00021280: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-00021290: 2020 2027 4741 4941 5f47 273a 2030 2e38     'GAIA_G': 0.8
-000212a0: 3331 3339 2c20 2020 2027 4741 4941 5f52  3139,    'GAIA_R
-000212b0: 5027 3a20 302e 3633 3833 312c 0a23 2020  P': 0.63831,.#  
+00020f10: 2020 2747 4149 4133 5f52 5027 3a20 3736    'GAIA3_RP': 76
+00020f20: 3139 2e39 367d 0a0a 2320 5072 6576 696f  19.96}..# Previo
+00020f30: 7573 6c79 0a23 2073 6f75 7263 653a 2068  usly.# source: h
+00020f40: 7474 703a 2f2f 7374 6576 2e6f 6170 642e  ttp://stev.oapd.
+00020f50: 696e 6166 2e69 742f 6367 692d 6269 6e2f  inaf.it/cgi-bin/
+00020f60: 636d 645f 332e 350a 235f 416c 616d 6264  cmd_3.5.#_Alambd
+00020f70: 615f 4176 203d 207b 2020 2753 504c 5553  a_Av = {  'SPLUS
+00020f80: 5f55 273a 2031 2e36 3036 3734 2c20 2753  _U': 1.60674, 'S
+00020f90: 504c 5553 5f46 3337 3827 3a20 312e 3438  PLUS_F378': 1.48
+00020fa0: 3730 342c 0a23 2020 2020 2020 2020 2020  704,.#          
+00020fb0: 2020 2020 2753 504c 5553 5f46 3339 3527      'SPLUS_F395'
+00020fc0: 3a20 312e 3433 3937 392c 2027 5350 4c55  : 1.43979, 'SPLU
+00020fd0: 535f 4634 3130 273a 2031 2e34 3030 3233  S_F410': 1.40023
+00020fe0: 2c0a 2320 2020 2020 2020 2020 2020 2020  ,.#             
+00020ff0: 2027 5350 4c55 535f 4634 3330 273a 2031   'SPLUS_F430': 1
+00021000: 2e33 3438 3937 2c20 2020 2027 5350 4c55  .34897,    'SPLU
+00021010: 535f 4727 3a20 312e 3231 3235 362c 0a23  S_G': 1.21256,.#
+00021020: 2020 2020 2020 2020 2020 2020 2020 2753                'S
+00021030: 504c 5553 5f46 3531 3527 3a20 312e 3039  PLUS_F515': 1.09
+00021040: 3138 372c 2020 2020 2753 504c 5553 5f52  187,    'SPLUS_R
+00021050: 273a 2030 2e38 3534 3635 2c0a 2320 2020  ': 0.85465,.#   
+00021060: 2020 2020 2020 2020 2020 2027 5350 4c55             'SPLU
+00021070: 535f 4636 3630 273a 2030 2e38 3037 3139  S_F660': 0.80719
+00021080: 2c20 2020 2027 5350 4c55 535f 4927 3a20  ,    'SPLUS_I': 
+00021090: 302e 3635 3037 312c 0a23 2020 2020 2020  0.65071,.#      
+000210a0: 2020 2020 2020 2020 2753 504c 5553 5f46          'SPLUS_F
+000210b0: 3836 3127 3a20 302e 3532 3036 342c 2020  861': 0.52064,  
+000210c0: 2020 2753 504c 5553 5f5a 273a 2030 2e34    'SPLUS_Z': 0.4
+000210d0: 3236 3334 2c0a 2320 2020 2020 2020 2020  2634,.#         
+000210e0: 2020 2020 2020 2747 414c 4558 5f46 5556        'GALEX_FUV
+000210f0: 273a 2032 2e36 3136 3836 2c20 2027 4741  ': 2.61686,  'GA
+00021100: 4c45 585f 4e55 5627 3a20 322e 3830 3831  LEX_NUV': 2.8081
+00021110: 372c 0a23 2020 2020 2020 2020 2020 2020  7,.#            
+00021120: 2020 2020 2020 2753 4453 535f 5527 3a20        'SDSS_U': 
+00021130: 312e 3537 3436 352c 2020 2020 2027 5344  1.57465,     'SD
+00021140: 5353 5f47 273a 2031 2e32 3236 3531 2c0a  SS_G': 1.22651,.
+00021150: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+00021160: 2020 2027 5344 5353 5f52 273a 2030 2e38     'SDSS_R': 0.8
+00021170: 3636 3339 2c20 2020 2020 2753 4453 535f  6639,     'SDSS_
+00021180: 4927 3a20 302e 3638 3331 312c 0a23 2020  I': 0.68311,.#  
+00021190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000211a0: 2753 4453 535f 5a27 3a20 302e 3438 3234  'SDSS_Z': 0.4824
+000211b0: 352c 2020 2020 2020 2027 5053 5f47 273a  5,       'PS_G':
+000211c0: 2031 2e31 3739 3934 2c0a 2320 2020 2020   1.17994,.#     
+000211d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+000211e0: 5053 5f52 273a 2030 2e38 3631 3930 2c20  PS_R': 0.86190, 
+000211f0: 2020 2020 2020 2750 535f 4927 3a20 302e        'PS_I': 0.
+00021200: 3637 3634 382c 0a23 2020 2020 2020 2020  67648,.#        
+00021210: 2020 2020 2020 2020 2020 2020 2750 535f              'PS_
+00021220: 5a27 3a20 302e 3531 3239 362c 2020 2020  Z': 0.51296,    
+00021230: 2747 4149 415f 4250 273a 2031 2e30 3939  'GAIA_BP': 1.099
+00021240: 3039 2c0a 2320 2020 2020 2020 2020 2020  09,.#           
+00021250: 2020 2020 2020 2027 4741 4941 5f47 273a         'GAIA_G':
+00021260: 2030 2e38 3331 3339 2c20 2020 2027 4741   0.83139,    'GA
+00021270: 4941 5f52 5027 3a20 302e 3633 3833 312c  IA_RP': 0.63831,
+00021280: 0a23 2020 2020 2020 2020 2020 2020 2020  .#              
+00021290: 2020 2020 2020 2753 4d5f 5527 3a20 312e        'SM_U': 1.
+000212a0: 3630 3537 342c 2020 2020 2020 2027 534d  60574,       'SM
+000212b0: 5f56 273a 2031 2e34 3730 3836 2c0a 2320  _V': 1.47086,.# 
 000212c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000212d0: 2020 2753 4d5f 5527 3a20 312e 3630 3537    'SM_U': 1.6057
-000212e0: 342c 2020 2020 2020 2027 534d 5f56 273a  4,       'SM_V':
-000212f0: 2031 2e34 3730 3836 2c0a 2320 2020 2020   1.47086,.#     
-00021300: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00021310: 534d 5f47 273a 2031 2e31 3037 3839 2c20  SM_G': 1.10789, 
-00021320: 2020 2020 2020 2753 4d5f 5227 3a20 302e        'SM_R': 0.
-00021330: 3837 3037 322c 0a23 2020 2020 2020 2020  87072,.#        
-00021340: 2020 2020 2020 2020 2020 2020 2753 4d5f              'SM_
-00021350: 4927 3a20 302e 3634 3134 352c 2020 2020  I': 0.64145,    
-00021360: 2020 2027 534d 5f5a 273a 2030 2e34 3635     'SM_Z': 0.465
-00021370: 3135 7d0a 0a23 2043 7572 7265 6e74 0a23  15}..# Current.#
-00021380: 2068 7474 703a 2f2f 7376 6f32 2e63 6162   http://svo2.cab
-00021390: 2e69 6e74 612d 6373 6963 2e65 732f 7376  .inta-csic.es/sv
-000213a0: 6f2f 7468 656f 7279 2f66 7073 332f 696e  o/theory/fps3/in
-000213b0: 6465 782e 7068 703f 6d6f 6465 3d62 726f  dex.php?mode=bro
-000213c0: 7773 650a 5f41 6c61 6d62 6461 5f41 7620  wse._Alambda_Av 
-000213d0: 3d20 7b20 2027 5350 4c55 535f 5527 3a20  = {  'SPLUS_U': 
-000213e0: 312e 3631 2c20 2753 504c 5553 5f46 3337  1.61, 'SPLUS_F37
-000213f0: 3827 3a20 312e 3532 2c0a 2020 2020 2020  8': 1.52,.      
-00021400: 2020 2020 2020 2020 2753 504c 5553 5f46          'SPLUS_F
-00021410: 3339 3527 3a20 312e 3436 2c20 2753 504c  395': 1.46, 'SPL
-00021420: 5553 5f46 3431 3027 3a20 312e 3430 2c0a  US_F410': 1.40,.
-00021430: 2020 2020 2020 2020 2020 2020 2020 2753                'S
-00021440: 504c 5553 5f46 3433 3027 3a20 312e 3333  PLUS_F430': 1.33
-00021450: 2c20 2020 2027 5350 4c55 535f 4727 3a20  ,    'SPLUS_G': 
-00021460: 312e 3230 2c0a 2020 2020 2020 2020 2020  1.20,.          
-00021470: 2020 2020 2753 504c 5553 5f46 3531 3527      'SPLUS_F515'
-00021480: 3a20 312e 3130 2c20 2020 2027 5350 4c55  : 1.10,    'SPLU
-00021490: 535f 5227 3a20 302e 3836 342c 0a20 2020  S_R': 0.864,.   
-000214a0: 2020 2020 2020 2020 2020 2027 5350 4c55             'SPLU
-000214b0: 535f 4636 3630 273a 2030 2e37 3938 2c20  S_F660': 0.798, 
-000214c0: 2020 2027 5350 4c55 535f 4927 3a20 302e     'SPLUS_I': 0.
-000214d0: 3634 382c 0a20 2020 2020 2020 2020 2020  648,.           
-000214e0: 2020 2027 5350 4c55 535f 4638 3631 273a     'SPLUS_F861':
-000214f0: 2030 2e35 3339 2c20 2020 2027 5350 4c55   0.539,    'SPLU
-00021500: 535f 5a27 3a20 302e 3531 332c 0a20 2020  S_Z': 0.513,.   
-00021510: 2020 2020 2020 2020 2020 2020 2747 414c              'GAL
-00021520: 4558 5f46 5556 273a 2032 2e36 312c 2020  EX_FUV': 2.61,  
-00021530: 2747 414c 4558 5f4e 5556 273a 2032 2e38  'GALEX_NUV': 2.8
-00021540: 352c 0a20 2020 2020 2020 2020 2020 2020  5,.             
-00021550: 2020 2020 2027 5344 5353 5f55 273a 2031       'SDSS_U': 1
-00021560: 2e35 382c 2020 2020 2027 5344 5353 5f47  .58,     'SDSS_G
-00021570: 273a 2031 2e32 322c 0a20 2020 2020 2020  ': 1.22,.       
-00021580: 2020 2020 2020 2020 2020 2027 5344 5353             'SDSS
-00021590: 5f52 273a 2030 2e38 3834 2c20 2020 2020  _R': 0.884,     
-000215a0: 2753 4453 535f 4927 3a20 302e 3637 332c  'SDSS_I': 0.673,
-000215b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000215c0: 2020 2027 5344 5353 5f5a 273a 2030 2e35     'SDSS_Z': 0.5
-000215d0: 3134 2c20 2020 2020 2020 2750 535f 4727  14,       'PS_G'
-000215e0: 3a20 312e 3138 2c0a 2020 2020 2020 2020  : 1.18,.        
-000215f0: 2020 2020 2020 2020 2020 2020 2750 535f              'PS_
-00021600: 5227 3a20 302e 3838 312c 2020 2020 2020  R': 0.881,      
-00021610: 2027 5053 5f49 273a 2030 2e36 3637 2c0a   'PS_I': 0.667,.
-00021620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021630: 2020 2020 2750 535f 5a27 3a20 302e 3533      'PS_Z': 0.53
-00021640: 342c 2020 2020 2747 4149 415f 4250 273a  4,    'GAIA_BP':
-00021650: 2031 2e31 332c 0a20 2020 2020 2020 2020   1.13,.         
-00021660: 2020 2020 2020 2020 2027 4741 4941 5f47           'GAIA_G
-00021670: 273a 2030 2e39 3339 2c20 2020 2027 4741  ': 0.939,    'GA
-00021680: 4941 5f52 5027 3a20 302e 3635 382c 0a20  IA_RP': 0.658,. 
-00021690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000216a0: 2020 2027 534d 5f55 273a 2031 2e36 332c     'SM_U': 1.63,
-000216b0: 2020 2020 2020 2027 534d 5f56 273a 2031         'SM_V': 1
-000216c0: 2e35 302c 0a20 2020 2020 2020 2020 2020  .50,.           
-000216d0: 2020 2020 2020 2020 2027 534d 5f47 273a           'SM_G':
-000216e0: 2031 2e31 312c 2020 2020 2020 2027 534d   1.11,       'SM
-000216f0: 5f52 273a 2030 2e38 3835 2c0a 2020 2020  _R': 0.885,.    
-00021700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021710: 2753 4d5f 4927 3a20 302e 3633 362c 2020  'SM_I': 0.636,  
-00021720: 2020 2020 2027 534d 5f5a 273a 2030 2e34       'SM_Z': 0.4
-00021730: 3936 2c0a 2020 2020 2020 2020 2020 2020  96,.            
-00021740: 2020 2020 2027 4741 4941 335f 4727 3a20       'GAIA3_G': 
-00021750: 302e 3837 2c20 2020 2027 4741 4941 335f  0.87,    'GAIA3_
-00021760: 4250 273a 2031 2e31 302c 0a20 2020 2020  BP': 1.10,.     
-00021770: 2020 2020 2020 2020 2020 2027 4741 4941             'GAIA
-00021780: 335f 5250 273a 302e 3633 367d 0a0a 0a64  3_RP':0.636}...d
-00021790: 6566 2067 6574 5f45 4256 5f73 6368 6c65  ef get_EBV_schle
-000217a0: 6765 6c28 5241 2c20 4445 432c 2065 6276  gel(RA, DEC, ebv
-000217b0: 5f6d 6170 735f 7061 7468 293a 0a0a 2020  _maps_path):..  
-000217c0: 2020 2222 220a 2020 2020 5265 7475 726e    """.    Return
-000217d0: 7320 5363 686c 6567 656c 2773 2045 5f42  s Schlegel's E_B
-000217e0: 2d56 2066 6f72 2070 6f73 6974 696f 6e73  -V for positions
-000217f0: 2052 4120 616e 6420 4445 430a 0a20 2020   RA and DEC..   
-00021800: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-00021810: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2052  ----------.    R
-00021820: 4120 3a20 6e70 2e61 7272 6179 0a20 2020  A : np.array.   
-00021830: 2020 2020 204c 6973 7420 6f66 2073 6f75       List of sou
-00021840: 7263 6573 2720 7269 6768 7420 6173 6365  rces' right asce
-00021850: 6e74 696f 6e73 0a20 2020 2044 4543 203a  ntions.    DEC :
-00021860: 206e 702e 6172 7261 790a 2020 2020 2020   np.array.      
-00021870: 2020 4c69 7374 206f 6620 736f 7572 6365    List of source
-00021880: 7327 2064 6563 6c69 6e61 7469 6f6e 730a  s' declinations.
-00021890: 2020 2020 6562 765f 6d61 7073 5f70 6174      ebv_maps_pat
-000218a0: 6820 3a20 7374 720a 2020 2020 2020 2020  h : str.        
-000218b0: 4c6f 6361 7469 6f6e 206f 6620 4953 4d20  Location of ISM 
-000218c0: 6578 7469 6e63 7469 6f6e 206d 6170 730a  extinction maps.
-000218d0: 0a20 2020 2052 6574 7572 6e73 0a20 2020  .    Returns.   
-000218e0: 202d 2d2d 2d2d 2d2d 0a20 2020 206e 702e   -------.    np.
-000218f0: 6172 7261 790a 2020 2020 2020 2020 6172  array.        ar
-00021900: 7261 7920 6f66 2045 5f42 2d56 2069 6e20  ray of E_B-V in 
-00021910: 7468 6520 706f 7369 7469 6f6e 206f 6620  the position of 
-00021920: 7468 6520 736f 7572 6365 730a 2020 2020  the sources.    
-00021930: 2222 220a 0a20 2020 206d 203d 2073 6664  """..    m = sfd
-00021940: 6d61 702e 5346 444d 6170 2865 6276 5f6d  map.SFDMap(ebv_m
-00021950: 6170 735f 7061 7468 290a 2020 2020 4542  aps_path).    EB
-00021960: 5620 3d20 6d2e 6562 7628 5241 2c20 4445  V = m.ebv(RA, DE
-00021970: 4329 0a0a 2020 2020 7265 7475 726e 2045  C)..    return E
-00021980: 4256 0a0a 0a0a 6465 6620 636f 7272 6563  BV....def correc
-00021990: 745f 6578 7469 6e63 7469 6f6e 5f73 6368  t_extinction_sch
-000219a0: 6c65 6765 6c28 6361 7461 6c6f 672c 2073  legel(catalog, s
-000219b0: 6176 655f 6669 6c65 2c20 6562 765f 6d61  ave_file, ebv_ma
-000219c0: 7073 5f70 6174 682c 0a20 2020 2020 2020  ps_path,.       
-000219d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000219e0: 2020 2020 2020 2020 2066 696c 7465 7273           filters
-000219f0: 5f41 6c61 6d62 6461 5f41 763d 4e6f 6e65  _Alambda_Av=None
-00021a00: 2c20 7265 7665 7273 6520 3d20 4661 6c73  , reverse = Fals
-00021a10: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00021a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021a30: 2020 2069 6e63 6c75 6465 5f6d 6f64 203d     include_mod =
-00021a40: 2046 616c 7365 293a 0a20 2020 2022 2222   False):.    """
-00021a50: 0a20 2020 2043 6f72 7265 6374 7320 4953  .    Corrects IS
-00021a60: 4d20 6578 7469 6e63 7469 6f6e 2069 6e20  M extinction in 
-00021a70: 7468 6520 6769 7665 6e20 6361 7461 6c6f  the given catalo
-00021a80: 6720 7573 696e 6720 5363 6865 6c65 6765  g using Schelege
-00021a90: 6c20 4542 2d56 206d 6170 730a 0a20 2020  l EB-V maps..   
-00021aa0: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-00021ab0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063  ----------.    c
-00021ac0: 6174 616c 6f67 203a 2073 7472 0a20 2020  atalog : str.   
-00021ad0: 2020 2020 204c 6f63 6174 696f 6e20 6f66       Location of
-00021ae0: 2074 6865 2063 6174 616c 6f67 2077 6869   the catalog whi
-00021af0: 6368 2077 696c 6c20 6861 7665 2065 7863  ch will have exc
-00021b00: 7469 6e63 7469 6f6e 2063 6f72 7265 6374  tinction correct
-00021b10: 6564 0a20 2020 2073 6176 655f 6669 6c65  ed.    save_file
-00021b20: 203a 2073 7472 0a20 2020 2020 2020 204c   : str.        L
-00021b30: 6f63 6174 696f 6e20 6f66 2066 696c 6520  ocation of file 
-00021b40: 746f 2073 6176 6520 7468 6520 7265 7375  to save the resu
-00021b50: 6c74 730a 2020 2020 6562 765f 6d61 7073  lts.    ebv_maps
-00021b60: 5f70 6174 6820 3a20 7374 720a 2020 2020  _path : str.    
-00021b70: 2020 2020 5061 7468 2074 6f20 6469 7265      Path to dire
-00021b80: 6374 6f72 7920 636f 6e74 6169 6e69 6e67  ctory containing
-00021b90: 2065 7874 696e 6374 696f 6e20 6d61 7073   extinction maps
-00021ba0: 0a20 2020 2066 696c 7465 7273 5f41 6c61  .    filters_Ala
-00021bb0: 6d62 6461 5f41 7620 3a20 6469 6374 0a20  mbda_Av : dict. 
-00021bc0: 2020 2020 2020 2044 6963 7469 6f6e 6172         Dictionar
-00021bd0: 7920 7769 7468 2076 616c 7565 7320 6f66  y with values of
-00021be0: 2041 6c61 6d62 6461 2f41 760a 2020 2020   Alambda/Av.    
-00021bf0: 7265 7665 7273 6520 3a20 626f 6f6c 0a20  reverse : bool. 
-00021c00: 2020 2020 2020 2049 6620 7472 7565 2c20         If true, 
-00021c10: 6578 7469 6e63 7469 6f6e 2069 7320 6170  extinction is ap
-00021c20: 706c 6965 6420 696e 7374 6561 6420 6f66  plied instead of
-00021c30: 2063 6f72 7265 6374 6564 0a20 2020 2069   corrected.    i
-00021c40: 6e63 6c75 6465 5f6d 6f64 203a 2062 6f6f  nclude_mod : boo
-00021c50: 6c0a 2020 2020 2020 2020 4966 2074 7275  l.        If tru
-00021c60: 652c 2061 6c73 6f20 6170 706c 6965 7320  e, also applies 
-00021c70: 636f 7272 6563 7469 6f6e 2074 6f20 636f  correction to co
-00021c80: 6c75 6d6e 7320 7b66 696c 747d 5f6d 6f64  lumns {filt}_mod
-00021c90: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
-00021ca0: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 5361    -------.    Sa
-00021cb0: 7665 7320 6361 7461 6c6f 6720 7769 7468  ves catalog with
-00021cc0: 2063 6f72 7265 6374 6564 2065 7874 696e   corrected extin
-00021cd0: 6374 696f 6e73 0a20 2020 2022 2222 0a0a  ctions.    """..
-00021ce0: 2020 2020 6966 2066 696c 7465 7273 5f41      if filters_A
-00021cf0: 6c61 6d62 6461 5f41 7620 6973 204e 6f6e  lambda_Av is Non
-00021d00: 653a 0a20 2020 2020 2020 2066 696c 7465  e:.        filte
-00021d10: 7273 5f41 6c61 6d62 6461 5f41 7620 3d20  rs_Alambda_Av = 
-00021d20: 5f41 6c61 6d62 6461 5f41 760a 0a20 2020  _Alambda_Av..   
-00021d30: 2023 2041 6c73 6f20 6170 706c 7920 636f   # Also apply co
-00021d40: 7272 6563 7469 6f6e 2074 6f20 6d6f 6465  rrection to mode
-00021d50: 6c20 7072 6564 6963 7465 6420 6d61 676e  l predicted magn
-00021d60: 6974 7564 6573 0a20 2020 2069 6620 696e  itudes.    if in
-00021d70: 636c 7564 655f 6d6f 6420 6973 2054 7275  clude_mod is Tru
-00021d80: 653a 0a20 2020 2020 2020 2066 696c 7465  e:.        filte
-00021d90: 7273 203d 206c 6973 7428 6669 6c74 6572  rs = list(filter
-00021da0: 735f 416c 616d 6264 615f 4176 2e6b 6579  s_Alambda_Av.key
-00021db0: 7328 2929 0a20 2020 2020 2020 2066 6f72  s()).        for
-00021dc0: 2066 696c 7420 696e 2066 696c 7465 7273   filt in filters
-00021dd0: 3a0a 2020 2020 2020 2020 2020 2020 6669  :.            fi
-00021de0: 6c74 6572 735f 416c 616d 6264 615f 4176  lters_Alambda_Av
-00021df0: 5b66 227b 6669 6c74 7d5f 6d6f 6422 5d20  [f"{filt}_mod"] 
-00021e00: 3d20 6669 6c74 6572 735f 416c 616d 6264  = filters_Alambd
-00021e10: 615f 4176 5b66 696c 745d 0a0a 2020 2020  a_Av[filt]..    
-00021e20: 6d20 3d20 7366 646d 6170 2e53 4644 4d61  m = sfdmap.SFDMa
-00021e30: 7028 6562 765f 6d61 7073 5f70 6174 6829  p(ebv_maps_path)
-00021e40: 0a0a 2020 2020 2320 5265 6164 696e 6720  ..    # Reading 
-00021e50: 4361 7461 6c6f 6720 6461 7461 0a20 2020  Catalog data.   
-00021e60: 2063 6174 203d 2066 6974 732e 6f70 656e   cat = fits.open
-00021e70: 2863 6174 616c 6f67 290a 2020 2020 6361  (catalog).    ca
-00021e80: 745f 6461 7461 203d 2063 6174 5b31 5d2e  t_data = cat[1].
-00021e90: 6461 7461 0a0a 2020 2020 2323 2323 2323  data..    ######
-00021ea0: 2323 2323 2323 2323 0a20 2020 2023 204f  ########.    # O
-00021eb0: 6274 6169 6e69 6e67 2041 560a 2020 2020  btaining AV.    
-00021ec0: 5241 203d 2063 6174 5f64 6174 615b 2752  RA = cat_data['R
-00021ed0: 414a 3230 3030 275d 0a20 2020 2044 4543  AJ2000'].    DEC
-00021ee0: 203d 2063 6174 5f64 6174 615b 2744 454a   = cat_data['DEJ
-00021ef0: 3230 3030 275d 0a0a 2020 2020 4542 5620  2000']..    EBV 
-00021f00: 3d20 6d2e 6562 7628 5241 2c20 4445 4329  = m.ebv(RA, DEC)
-00021f10: 0a20 2020 2041 7620 3d20 4542 5620 2a20  .    Av = EBV * 
-00021f20: 332e 310a 0a20 2020 2023 2323 2323 2323  3.1..    #######
-00021f30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00021f40: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
-00021f50: 2020 2320 436f 7272 6563 7420 6578 7469    # Correct exti
-00021f60: 6e63 7469 6f6e 2066 6f72 2065 6163 6820  nction for each 
-00021f70: 6669 6c74 6572 0a0a 2020 2020 666f 7220  filter..    for 
-00021f80: 6669 6c74 2069 6e20 6c69 7374 2866 696c  filt in list(fil
-00021f90: 7465 7273 5f41 6c61 6d62 6461 5f41 762e  ters_Alambda_Av.
-00021fa0: 6b65 7973 2829 293a 0a20 2020 2020 2020  keys()):.       
-00021fb0: 2069 6620 6669 6c74 2069 6e20 6361 745f   if filt in cat_
-00021fc0: 6461 7461 2e63 6f6c 756d 6e73 2e6e 616d  data.columns.nam
-00021fd0: 6573 3a0a 0a20 2020 2020 2020 2020 2020  es:..           
-00021fe0: 2041 6c61 6d62 6461 203d 2041 7620 2a20   Alambda = Av * 
-00021ff0: 6669 6c74 6572 735f 416c 616d 6264 615f  filters_Alambda_
-00022000: 4176 5b66 696c 745d 0a0a 2020 2020 2020  Av[filt]..      
-00022010: 2020 2020 2020 6e6f 745f 6e61 6e20 3d20        not_nan = 
-00022020: 6361 745f 6461 7461 2e63 6f6c 756d 6e73  cat_data.columns
-00022030: 5b66 696c 745d 2e61 7272 6179 2021 3d20  [filt].array != 
-00022040: 3939 0a0a 2020 2020 2020 2020 2020 2020  99..            
-00022050: 2320 4966 2072 6576 6572 7365 2c20 6578  # If reverse, ex
-00022060: 7469 6e63 7469 6f6e 2069 7320 6170 706c  tinction is appl
-00022070: 6965 640a 2020 2020 2020 2020 2020 2020  ied.            
-00022080: 6966 2072 6576 6572 7365 2069 7320 5472  if reverse is Tr
-00022090: 7565 3a0a 2020 2020 2020 2020 2020 2020  ue:.            
-000220a0: 2020 2020 6361 745f 6461 7461 2e63 6f6c      cat_data.col
-000220b0: 756d 6e73 5b66 696c 745d 2e61 7272 6179  umns[filt].array
-000220c0: 5b6e 6f74 5f6e 616e 5d20 2b3d 2041 6c61  [not_nan] += Ala
-000220d0: 6d62 6461 5b6e 6f74 5f6e 616e 5d0a 2020  mbda[not_nan].  
-000220e0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000220f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022100: 6361 745f 6461 7461 2e63 6f6c 756d 6e73  cat_data.columns
-00022110: 5b66 696c 745d 2e61 7272 6179 5b6e 6f74  [filt].array[not
-00022120: 5f6e 616e 5d20 2d3d 2041 6c61 6d62 6461  _nan] -= Alambda
-00022130: 5b6e 6f74 5f6e 616e 5d0a 0a20 2020 2023  [not_nan]..    #
-00022140: 2053 6176 6520 6f75 7470 7574 2064 6174   Save output dat
-00022150: 610a 2020 2020 6361 742e 7772 6974 6574  a.    cat.writet
-00022160: 6f28 7361 7665 5f66 696c 6529 0a20 2020  o(save_file).   
-00022170: 2070 7269 6e74 2827 4372 6561 7465 6420   print('Created 
-00022180: 6669 6c65 2025 7327 2025 2073 6176 655f  file %s' % save_
-00022190: 6669 6c65 290a 0a0a 6465 6620 636f 7272  file)...def corr
-000221a0: 6563 745f 6578 7469 6e63 7469 6f6e 5f73  ect_extinction_s
-000221b0: 6368 6c61 666c 7928 6361 7461 6c6f 672c  chlafly(catalog,
-000221c0: 2073 6176 655f 6669 6c65 2c20 6562 765f   save_file, ebv_
-000221d0: 6d61 7073 5f70 6174 682c 0a20 2020 2020  maps_path,.     
-000221e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000221f0: 2020 2020 2020 2020 2020 2066 696c 7465             filte
-00022200: 7273 5f41 6c61 6d62 6461 5f41 763d 4e6f  rs_Alambda_Av=No
-00022210: 6e65 2c20 7265 7665 7273 6520 3d20 4661  ne, reverse = Fa
-00022220: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
-00022230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022240: 2020 2020 2069 6e63 6c75 6465 5f6d 6f64       include_mod
-00022250: 203d 2046 616c 7365 293a 0a20 2020 2022   = False):.    "
-00022260: 2222 0a20 2020 2043 6f72 7265 6374 7320  "".    Corrects 
-00022270: 4953 4d20 6578 7469 6e63 7469 6f6e 2069  ISM extinction i
-00022280: 6e20 7468 6520 6769 7665 6e20 6361 7461  n the given cata
-00022290: 6c6f 6720 7573 696e 6720 5363 6865 6c65  log using Schele
-000222a0: 6765 6c20 4542 2d56 206d 6170 730a 2020  gel EB-V maps.  
-000222b0: 2020 616e 6420 6170 706c 7969 6e67 2074    and applying t
-000222c0: 6865 2063 6f72 7265 6374 696f 6e20 7072  he correction pr
-000222d0: 6f70 6f73 6564 2062 7920 5363 686c 6166  oposed by Schlaf
-000222e0: 6c79 2065 7420 616c 2e20 3230 3130 3a0a  ly et al. 2010:.
-000222f0: 0a20 2020 2045 422d 5620 3d20 302e 3836  .    EB-V = 0.86
-00022300: 202a 2045 422d 565f 5363 686c 6567 656c   * EB-V_Schlegel
-00022310: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
-00022320: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-00022330: 2020 2020 6361 7461 6c6f 6720 3a20 7374      catalog : st
-00022340: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
-00022350: 6f6e 206f 6620 7468 6520 6361 7461 6c6f  on of the catalo
-00022360: 6720 7768 6963 6820 7769 6c6c 2068 6176  g which will hav
-00022370: 6520 6578 6374 696e 6374 696f 6e20 636f  e exctinction co
-00022380: 7272 6563 7465 640a 2020 2020 7361 7665  rrected.    save
-00022390: 5f66 696c 6520 3a20 7374 720a 2020 2020  _file : str.    
-000223a0: 2020 2020 4c6f 6361 7469 6f6e 206f 6620      Location of 
-000223b0: 6669 6c65 2074 6f20 7361 7665 2074 6865  file to save the
-000223c0: 2072 6573 756c 7473 0a20 2020 2065 6276   results.    ebv
-000223d0: 5f6d 6170 7369 5f70 6174 6820 3a20 7374  _mapsi_path : st
-000223e0: 720a 2020 2020 2020 2020 5061 7468 2074  r.        Path t
-000223f0: 6f20 6469 7265 6374 6f72 7920 636f 6e74  o directory cont
-00022400: 6169 6e69 6e67 2065 7874 696e 6374 696f  aining extinctio
-00022410: 6e20 6d61 7073 0a20 2020 2066 696c 7465  n maps.    filte
-00022420: 7273 5f41 6c61 6d62 6461 5f41 7620 3a20  rs_Alambda_Av : 
-00022430: 6469 6374 0a20 2020 2020 2020 2044 6963  dict.        Dic
-00022440: 7469 6f6e 6172 7920 7769 7468 2076 616c  tionary with val
-00022450: 7565 7320 6f66 2041 6c61 6d62 6461 2f41  ues of Alambda/A
-00022460: 760a 2020 2020 7265 7665 7273 6520 3a20  v.    reverse : 
-00022470: 626f 6f6c 0a20 2020 2020 2020 2049 6620  bool.        If 
-00022480: 7472 7565 2c20 6578 7469 6e63 7469 6f6e  true, extinction
-00022490: 2069 7320 6170 706c 6965 6420 696e 7374   is applied inst
-000224a0: 6561 6420 6f66 2063 6f72 7265 6374 6564  ead of corrected
-000224b0: 0a20 2020 2069 6e63 6c75 6465 5f6d 6f64  .    include_mod
-000224c0: 203a 2062 6f6f 6c0a 2020 2020 2020 2020   : bool.        
-000224d0: 4966 2074 7275 652c 2061 6c73 6f20 6170  If true, also ap
-000224e0: 706c 6965 7320 636f 7272 6563 7469 6f6e  plies correction
-000224f0: 2074 6f20 636f 6c75 6d6e 7320 7b66 696c   to columns {fil
-00022500: 747d 5f6d 6f64 0a0a 2020 2020 5265 7475  t}_mod..    Retu
-00022510: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00022520: 2020 2020 5361 7665 7320 6361 7461 6c6f      Saves catalo
-00022530: 6720 7769 7468 2063 6f72 7265 6374 6564  g with corrected
-00022540: 2065 7874 696e 6374 696f 6e73 0a20 2020   extinctions.   
-00022550: 2022 2222 0a0a 2020 2020 6966 2066 696c   """..    if fil
-00022560: 7465 7273 5f41 6c61 6d62 6461 5f41 7620  ters_Alambda_Av 
-00022570: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00022580: 2066 696c 7465 7273 5f41 6c61 6d62 6461   filters_Alambda
-00022590: 5f41 7620 3d20 5f41 6c61 6d62 6461 5f41  _Av = _Alambda_A
-000225a0: 760a 0a20 2020 2023 2041 6c73 6f20 6170  v..    # Also ap
-000225b0: 706c 7920 636f 7272 6563 7469 6f6e 2074  ply correction t
-000225c0: 6f20 6d6f 6465 6c20 7072 6564 6963 7465  o model predicte
-000225d0: 6420 6d61 676e 6974 7564 6573 0a20 2020  d magnitudes.   
-000225e0: 2069 6620 696e 636c 7564 655f 6d6f 6420   if include_mod 
-000225f0: 6973 2054 7275 653a 0a20 2020 2020 2020  is True:.       
-00022600: 2066 696c 7465 7273 203d 206c 6973 7428   filters = list(
-00022610: 6669 6c74 6572 735f 416c 616d 6264 615f  filters_Alambda_
-00022620: 4176 2e6b 6579 7328 2929 0a20 2020 2020  Av.keys()).     
-00022630: 2020 2066 6f72 2066 696c 7420 696e 2066     for filt in f
-00022640: 696c 7465 7273 3a0a 2020 2020 2020 2020  ilters:.        
-00022650: 2020 2020 6669 6c74 6572 735f 416c 616d      filters_Alam
-00022660: 6264 615f 4176 5b66 227b 6669 6c74 7d5f  bda_Av[f"{filt}_
-00022670: 6d6f 6422 5d20 3d20 6669 6c74 6572 735f  mod"] = filters_
-00022680: 416c 616d 6264 615f 4176 5b66 696c 745d  Alambda_Av[filt]
-00022690: 0a0a 2020 2020 6d20 3d20 7366 646d 6170  ..    m = sfdmap
-000226a0: 2e53 4644 4d61 7028 6562 765f 6d61 7073  .SFDMap(ebv_maps
-000226b0: 5f70 6174 6829 0a0a 2020 2020 2320 5265  _path)..    # Re
-000226c0: 6164 696e 6720 4361 7461 6c6f 6720 6461  ading Catalog da
-000226d0: 7461 0a20 2020 2063 6174 203d 2066 6974  ta.    cat = fit
-000226e0: 732e 6f70 656e 2863 6174 616c 6f67 290a  s.open(catalog).
-000226f0: 2020 2020 6361 745f 6461 7461 203d 2063      cat_data = c
-00022700: 6174 5b31 5d2e 6461 7461 0a0a 2020 2020  at[1].data..    
-00022710: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-00022720: 2020 2023 204f 6274 6169 6e69 6e67 2041     # Obtaining A
-00022730: 560a 2020 2020 5241 203d 2063 6174 5f64  V.    RA = cat_d
-00022740: 6174 615b 2752 414a 3230 3030 275d 0a20  ata['RAJ2000']. 
-00022750: 2020 2044 4543 203d 2063 6174 5f64 6174     DEC = cat_dat
-00022760: 615b 2744 454a 3230 3030 275d 0a0a 2020  a['DEJ2000']..  
-00022770: 2020 4542 5620 3d20 6d2e 6562 7628 5241    EBV = m.ebv(RA
-00022780: 2c20 4445 4329 0a20 2020 2041 7620 3d20  , DEC).    Av = 
-00022790: 4542 5620 2a20 302e 3836 202a 2033 2e31  EBV * 0.86 * 3.1
-000227a0: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
-000227b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000227c0: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
-000227d0: 2043 6f72 7265 6374 2065 7874 696e 6374   Correct extinct
-000227e0: 696f 6e20 666f 7220 6561 6368 2066 696c  ion for each fil
-000227f0: 7465 720a 0a20 2020 2066 6f72 2066 696c  ter..    for fil
-00022800: 7420 696e 206c 6973 7428 6669 6c74 6572  t in list(filter
-00022810: 735f 416c 616d 6264 615f 4176 2e6b 6579  s_Alambda_Av.key
-00022820: 7328 2929 3a0a 2020 2020 2020 2020 6966  s()):.        if
-00022830: 2066 696c 7420 696e 2063 6174 5f64 6174   filt in cat_dat
-00022840: 612e 636f 6c75 6d6e 732e 6e61 6d65 733a  a.columns.names:
-00022850: 0a0a 2020 2020 2020 2020 2020 2020 416c  ..            Al
-00022860: 616d 6264 6120 3d20 4176 202a 2066 696c  ambda = Av * fil
-00022870: 7465 7273 5f41 6c61 6d62 6461 5f41 765b  ters_Alambda_Av[
-00022880: 6669 6c74 5d0a 0a20 2020 2020 2020 2020  filt]..         
-00022890: 2020 206e 6f74 5f6e 616e 203d 2063 6174     not_nan = cat
-000228a0: 5f64 6174 612e 636f 6c75 6d6e 735b 6669  _data.columns[fi
-000228b0: 6c74 5d2e 6172 7261 7920 213d 2039 390a  lt].array != 99.
-000228c0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
-000228d0: 6620 7265 7665 7273 652c 2065 7874 696e  f reverse, extin
-000228e0: 6374 696f 6e20 6973 2061 7070 6c69 6564  ction is applied
-000228f0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00022900: 7265 7665 7273 6520 6973 2054 7275 653a  reverse is True:
-00022910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022920: 2063 6174 5f64 6174 612e 636f 6c75 6d6e   cat_data.column
-00022930: 735b 6669 6c74 5d2e 6172 7261 795b 6e6f  s[filt].array[no
-00022940: 745f 6e61 6e5d 202b 3d20 416c 616d 6264  t_nan] += Alambd
-00022950: 615b 6e6f 745f 6e61 6e5d 0a20 2020 2020  a[not_nan].     
-00022960: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00022970: 2020 2020 2020 2020 2020 2020 2063 6174               cat
-00022980: 5f64 6174 612e 636f 6c75 6d6e 735b 6669  _data.columns[fi
-00022990: 6c74 5d2e 6172 7261 795b 6e6f 745f 6e61  lt].array[not_na
-000229a0: 6e5d 202d 3d20 416c 616d 6264 615b 6e6f  n] -= Alambda[no
-000229b0: 745f 6e61 6e5d 0a0a 2020 2020 2320 5361  t_nan]..    # Sa
-000229c0: 7665 206f 7574 7075 7420 6461 7461 0a20  ve output data. 
-000229d0: 2020 2063 6174 2e77 7269 7465 746f 2873     cat.writeto(s
-000229e0: 6176 655f 6669 6c65 290a 2020 2020 7072  ave_file).    pr
-000229f0: 696e 7428 2743 7265 6174 6564 2066 696c  int('Created fil
-00022a00: 6520 2573 2720 2520 7361 7665 5f66 696c  e %s' % save_fil
-00022a10: 6529 0a0a 0a64 6566 2063 6f72 7265 6374  e)...def correct
-00022a20: 5f65 7874 696e 6374 696f 6e5f 676f 7273  _extinction_gors
-00022a30: 6b69 2863 6174 616c 6f67 2c20 7361 7665  ki(catalog, save
-00022a40: 5f66 696c 652c 2065 6276 5f6d 6170 735f  _file, ebv_maps_
-00022a50: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-00022a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022a70: 2020 2020 6669 6c74 6572 735f 416c 616d      filters_Alam
-00022a80: 6264 615f 4176 3d4e 6f6e 652c 2072 6576  bda_Av=None, rev
-00022a90: 6572 7365 203d 2046 616c 7365 2c0a 2020  erse = False,.  
-00022aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ab0: 2020 2020 2020 2020 2020 2020 696e 636c              incl
-00022ac0: 7564 655f 6d6f 6420 3d20 4661 6c73 6529  ude_mod = False)
-00022ad0: 3a0a 2020 2020 2222 220a 2020 2020 436f  :.    """.    Co
-00022ae0: 7272 6563 7473 2049 534d 2065 7874 696e  rrects ISM extin
-00022af0: 6374 696f 6e20 696e 2074 6865 2067 6976  ction in the giv
-00022b00: 656e 2063 6174 616c 6f67 2075 7369 6e67  en catalog using
-00022b10: 2047 6f72 736b 6920 6574 2061 6c2e 2032   Gorski et al. 2
-00022b20: 3032 300a 2020 2020 4542 2d56 206d 6170  020.    EB-V map
-00022b30: 7320 666f 7220 7468 6520 736d 616c 6c20  s for the small 
-00022b40: 616e 6420 6c61 7267 6520 6d61 6765 6c6c  and large magell
-00022b50: 616e 6963 2063 6c6f 7564 730a 0a20 2020  anic clouds..   
-00022b60: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-00022b70: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063  ----------.    c
-00022b80: 6174 616c 6f67 203a 2073 7472 0a20 2020  atalog : str.   
-00022b90: 2020 2020 204c 6f63 6174 696f 6e20 6f66       Location of
-00022ba0: 2074 6865 2063 6174 616c 6f67 2077 6869   the catalog whi
-00022bb0: 6368 2077 696c 6c20 6861 7665 2065 7863  ch will have exc
-00022bc0: 7469 6e63 7469 6f6e 2063 6f72 7265 6374  tinction correct
-00022bd0: 6564 0a20 2020 2073 6176 655f 6669 6c65  ed.    save_file
-00022be0: 203a 2073 7472 0a20 2020 2020 2020 204c   : str.        L
-00022bf0: 6f63 6174 696f 6e20 6f66 2066 696c 6520  ocation of file 
-00022c00: 746f 2073 6176 6520 7468 6520 7265 7375  to save the resu
-00022c10: 6c74 730a 2020 2020 6562 765f 6d61 7073  lts.    ebv_maps
-00022c20: 5f70 6174 6820 3a20 7374 720a 2020 2020  _path : str.    
-00022c30: 2020 2020 5061 7468 2074 6f20 6469 7265      Path to dire
-00022c40: 6374 6f72 7920 636f 6e74 6169 6e69 6e67  ctory containing
-00022c50: 2065 7874 696e 6374 696f 6e20 6d61 7073   extinction maps
-00022c60: 0a20 2020 2066 696c 7465 7273 5f41 6c61  .    filters_Ala
-00022c70: 6d62 6461 5f41 7620 3a20 6469 6374 0a20  mbda_Av : dict. 
-00022c80: 2020 2020 2020 2044 6963 7469 6f6e 6172         Dictionar
-00022c90: 7920 7769 7468 2076 616c 7565 7320 6f66  y with values of
-00022ca0: 2041 6c61 6d62 6461 2f41 760a 2020 2020   Alambda/Av.    
-00022cb0: 7265 7665 7273 6520 3a20 626f 6f6c 0a20  reverse : bool. 
-00022cc0: 2020 2020 2020 2049 6620 7472 7565 2c20         If true, 
-00022cd0: 6578 7469 6e63 7469 6f6e 2069 7320 6170  extinction is ap
-00022ce0: 706c 6965 6420 696e 7374 6561 6420 6f66  plied instead of
-00022cf0: 2063 6f72 7265 6374 6564 0a20 2020 2069   corrected.    i
-00022d00: 6e63 6c75 6465 5f6d 6f64 203a 2062 6f6f  nclude_mod : boo
-00022d10: 6c0a 2020 2020 2020 2020 4966 2074 7275  l.        If tru
-00022d20: 652c 2061 6c73 6f20 6170 706c 6965 7320  e, also applies 
-00022d30: 636f 7272 6563 7469 6f6e 2074 6f20 636f  correction to co
-00022d40: 6c75 6d6e 7320 7b66 696c 747d 5f6d 6f64  lumns {filt}_mod
-00022d50: 0a0a 2020 2020 5265 7475 726e 730a 2020  ..    Returns.  
-00022d60: 2020 2d2d 2d2d 2d2d 2d0a 2020 2020 5361    -------.    Sa
-00022d70: 7665 7320 6361 7461 6c6f 6720 7769 7468  ves catalog with
-00022d80: 2063 6f72 7265 6374 6564 2065 7874 696e   corrected extin
-00022d90: 6374 696f 6e73 0a20 2020 2022 2222 0a0a  ctions.    """..
-00022da0: 2020 2020 2320 4164 6420 6f6e 2061 206c      # Add on a l
-00022db0: 6174 6572 2064 6174 6520 666f 7220 7072  ater date for pr
-00022dc0: 6f70 6572 2063 616c 6962 7261 7469 6f6e  oper calibration
-00022dd0: 206f 6620 7468 6520 4d43 730a 2020 2020   of the MCs.    
-00022de0: 2320 4578 7469 6e63 7469 6f6e 206d 6170  # Extinction map
-00022df0: 7320 6172 6520 616c 7265 6164 7920 696e  s are already in
-00022e00: 2074 6865 202f 7374 6573 2f52 6573 6f75   the /stes/Resou
-00022e10: 7263 6573 2f45 7874 696e 6374 696f 6e20  rces/Extinction 
-00022e20: 7061 7468 0a20 2020 2069 6620 6669 6c74  path.    if filt
-00022e30: 6572 735f 416c 616d 6264 615f 4176 2069  ers_Alambda_Av i
-00022e40: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00022e50: 6669 6c74 6572 735f 416c 616d 6264 615f  filters_Alambda_
-00022e60: 4176 203d 205f 416c 616d 6264 615f 4176  Av = _Alambda_Av
-00022e70: 0a0a 2020 2020 2320 416c 736f 2061 7070  ..    # Also app
-00022e80: 6c79 2063 6f72 7265 6374 696f 6e20 746f  ly correction to
-00022e90: 206d 6f64 656c 2070 7265 6469 6374 6564   model predicted
-00022ea0: 206d 6167 6e69 7475 6465 730a 2020 2020   magnitudes.    
-00022eb0: 6966 2069 6e63 6c75 6465 5f6d 6f64 2069  if include_mod i
-00022ec0: 7320 5472 7565 3a0a 2020 2020 2020 2020  s True:.        
-00022ed0: 6669 6c74 6572 7320 3d20 6c69 7374 2866  filters = list(f
-00022ee0: 696c 7465 7273 5f41 6c61 6d62 6461 5f41  ilters_Alambda_A
-00022ef0: 762e 6b65 7973 2829 290a 2020 2020 2020  v.keys()).      
-00022f00: 2020 666f 7220 6669 6c74 2069 6e20 6669    for filt in fi
-00022f10: 6c74 6572 733a 0a20 2020 2020 2020 2020  lters:.         
-00022f20: 2020 2066 696c 7465 7273 5f41 6c61 6d62     filters_Alamb
-00022f30: 6461 5f41 765b 6622 7b66 696c 747d 5f6d  da_Av[f"{filt}_m
-00022f40: 6f64 225d 203d 2066 696c 7465 7273 5f41  od"] = filters_A
-00022f50: 6c61 6d62 6461 5f41 765b 6669 6c74 5d0a  lambda_Av[filt].
-00022f60: 0a20 2020 2023 2053 4d43 2061 6e64 204c  .    # SMC and L
-00022f70: 4d43 2067 7269 6420 636f 7665 7261 6765  MC grid coverage
-00022f80: 0a20 2020 2023 204d 6164 6520 6279 2068  .    # Made by h
-00022f90: 616e 6420 7573 696e 6720 746f 7063 6174  and using topcat
-00022fa0: 0a20 2020 2073 6d63 5f70 6f6c 7967 6f6e  .    smc_polygon
-00022fb0: 203d 2050 6f6c 7967 6f6e 285b 5b31 332e   = Polygon([[13.
-00022fc0: 3339 382c 2d37 312e 3230 315d 2c20 5b32  398,-71.201], [2
-00022fd0: 302e 3438 312c 2d37 312e 3230 315d 2c20  0.481,-71.201], 
-00022fe0: 5b32 322e 3032 392c 2d37 342e 3139 375d  [22.029,-74.197]
-00022ff0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00023000: 2020 2020 2020 2020 2020 2020 205b 3133               [13
-00023010: 2e37 3730 2c2d 3734 2e32 3732 5d2c 205b  .770,-74.272], [
-00023020: 3133 2e35 3539 2c2d 3734 2e36 3933 5d2c  13.559,-74.693],
-00023030: 205b 3132 2e33 3231 2c2d 3734 2e35 3639   [12.321,-74.569
-00023040: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00023050: 2020 2020 2020 2020 2020 2020 2020 5b31                [1
-00023060: 322e 3232 322c 2d37 342e 3733 305d 2c20  2.222,-74.730], 
-00023070: 5b31 312e 3632 372c 2d37 342e 3634 335d  [11.627,-74.643]
-00023080: 2c20 5b31 312e 3535 332c 2d37 342e 3835  , [11.553,-74.85
-00023090: 345d 2c0a 2020 2020 2020 2020 2020 2020  4],.            
-000230a0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-000230b0: 342e 3839 312c 2d37 342e 3831 375d 2c20  4.891,-74.817], 
-000230c0: 205b 352e 3730 382c 2d37 322e 3331 355d   [5.708,-72.315]
-000230d0: 2c20 205b 3131 2e33 3932 2c2d 3732 2e33  ,  [11.392,-72.3
-000230e0: 3737 5d2c 0a20 2020 2020 2020 2020 2020  77],.           
-000230f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023100: 5b31 312e 3531 362c 2d37 312e 3630 395d  [11.516,-71.609]
-00023110: 2c20 5b31 332e 3239 392c 2d37 312e 3538  , [13.299,-71.58
-00023120: 355d 5d29 0a0a 2020 2020 6c6d 635f 706f  5]])..    lmc_po
-00023130: 6c79 676f 6e20 3d20 506f 6c79 676f 6e28  lygon = Polygon(
-00023140: 5b5b 3638 2e38 392c 202d 3636 2e35 315d  [[68.89, -66.51]
-00023150: 2c20 5b37 392e 3130 2c20 2d36 362e 3531  , [79.10, -66.51
-00023160: 5d2c 205b 3739 2e30 382c 202d 3637 2e36  ], [79.08, -67.6
-00023170: 375d 2c0a 2020 2020 2020 2020 2020 2020  7],.            
-00023180: 2020 2020 2020 2020 2020 2020 2020 205b                 [
-00023190: 3836 2e36 362c 202d 3637 2e37 315d 2c20  86.66, -67.71], 
-000231a0: 5b38 362e 3735 2c20 2d36 382e 3235 5d2c  [86.75, -68.25],
-000231b0: 205b 3931 2e35 352c 202d 3638 2e33 325d   [91.55, -68.32]
-000231c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000231d0: 2020 2020 2020 2020 2020 2020 205b 3931               [91
-000231e0: 2e37 342c 202d 3638 2e38 375d 2c20 5b39  .74, -68.87], [9
-000231f0: 332e 3532 2c20 2d36 382e 3930 5d2c 205b  3.52, -68.90], [
-00023200: 3934 2e38 322c 202d 3731 2e33 315d 2c0a  94.82, -71.31],.
-00023210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023220: 2020 2020 2020 2020 2020 205b 3933 2e34             [93.4
-00023230: 382c 202d 3731 2e34 335d 2c20 5b39 332e  8, -71.43], [93.
-00023240: 3939 2c20 2d37 332e 3038 5d2c 205b 3839  99, -73.08], [89
-00023250: 2e38 352c 202d 3733 2e31 355d 2c0a 2020  .85, -73.15],.  
-00023260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023270: 2020 2020 2020 2020 205b 3839 2e37 392c           [89.79,
-00023280: 202d 3732 2e35 375d 2c20 5b38 342e 3231   -72.57], [84.21
-00023290: 2c20 2d37 322e 3533 5d2c 205b 3834 2e31  , -72.53], [84.1
-000232a0: 362c 202d 3731 2e39 385d 2c0a 2020 2020  6, -71.98],.    
-000232b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000232c0: 2020 2020 2020 205b 3738 2e37 312c 202d         [78.71, -
-000232d0: 3731 2e39 335d 2c20 5b37 382e 3735 2c20  71.93], [78.75, 
-000232e0: 2d37 312e 3338 5d2c 205b 3733 2e34 352c  -71.38], [73.45,
-000232f0: 202d 3731 2e33 385d 2c0a 2020 2020 2020   -71.38],.      
-00023300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023310: 2020 2020 205b 3733 2e34 392c 202d 3730       [73.49, -70
-00023320: 2e38 355d 2c20 5b36 362e 3738 2c20 2d37  .85], [66.78, -7
-00023330: 302e 3637 5d5d 290a 0a20 2020 2023 2052  0.67]])..    # R
-00023340: 6561 6469 6e67 2043 6174 616c 6f67 2064  eading Catalog d
-00023350: 6174 610a 2020 2020 6361 7420 3d20 6669  ata.    cat = fi
-00023360: 7473 2e6f 7065 6e28 6361 7461 6c6f 6729  ts.open(catalog)
-00023370: 0a20 2020 2063 6174 5f64 6174 6120 3d20  .    cat_data = 
-00023380: 6361 745b 315d 2e64 6174 610a 0a20 2020  cat[1].data..   
-00023390: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
-000233a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000233b0: 2323 230a 2020 2020 2320 4368 6f6f 7365  ###.    # Choose
-000233c0: 2062 6574 7765 656e 204c 4d43 2061 6e64   between LMC and
-000233d0: 2053 4d43 2067 7269 6473 0a0a 2020 2020   SMC grids..    
-000233e0: 5241 203d 2063 6174 5f64 6174 615b 2752  RA = cat_data['R
-000233f0: 414a 3230 3030 275d 0a20 2020 2044 4543  AJ2000'].    DEC
-00023400: 203d 2063 6174 5f64 6174 615b 2744 454a   = cat_data['DEJ
-00023410: 3230 3030 275d 0a0a 2020 2020 7769 7468  2000']..    with
-00023420: 696e 5f73 6d63 203d 206e 702e 6675 6c6c  in_smc = np.full
-00023430: 286c 656e 2852 4129 2c20 4661 6c73 6529  (len(RA), False)
-00023440: 0a20 2020 2077 6974 6869 6e5f 6c6d 6320  .    within_lmc 
-00023450: 3d20 6e70 2e66 756c 6c28 6c65 6e28 5241  = np.full(len(RA
-00023460: 292c 2046 616c 7365 290a 0a20 2020 2023  ), False)..    #
-00023470: 2043 6865 636b 696e 6720 6966 2070 6f69   Checking if poi
-00023480: 6e74 7320 6172 6520 7769 7468 696e 206c  nts are within l
-00023490: 6d63 206f 7220 736d 630a 2020 2020 666f  mc or smc.    fo
-000234a0: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
-000234b0: 2852 4129 293a 0a20 2020 2020 2020 2070  (RA)):.        p
-000234c0: 203d 2050 6f69 6e74 2852 415b 695d 2c20   = Point(RA[i], 
-000234d0: 4445 435b 695d 290a 2020 2020 2020 2020  DEC[i]).        
-000234e0: 7769 7468 696e 5f73 6d63 5b69 5d20 3d20  within_smc[i] = 
-000234f0: 702e 7769 7468 696e 2873 6d63 5f70 6f6c  p.within(smc_pol
-00023500: 7967 6f6e 290a 2020 2020 2020 2020 7769  ygon).        wi
-00023510: 7468 696e 5f6c 6d63 5b69 5d20 3d20 702e  thin_lmc[i] = p.
-00023520: 7769 7468 696e 286c 6d63 5f70 6f6c 7967  within(lmc_polyg
-00023530: 6f6e 290a 0a20 2020 2069 6620 7769 7468  on)..    if with
-00023540: 696e 5f73 6d63 2e73 756d 2829 203e 2030  in_smc.sum() > 0
-00023550: 3a0a 2020 2020 2020 2020 6772 6964 203d  :.        grid =
-00023560: 206f 732e 7061 7468 2e6a 6f69 6e28 6562   os.path.join(eb
-00023570: 765f 6d61 7073 5f70 6174 682c 2027 476f  v_maps_path, 'Go
-00023580: 7273 6b69 5f45 4256 5f72 6573 335f 736d  rski_EBV_res3_sm
-00023590: 632e 7478 7427 290a 0a20 2020 2065 6c69  c.txt')..    eli
-000235a0: 6620 7769 7468 696e 5f6c 6d63 2e73 756d  f within_lmc.sum
-000235b0: 2829 203e 2030 3a0a 2020 2020 2020 2020  () > 0:.        
-000235c0: 6772 6964 203d 206f 732e 7061 7468 2e6a  grid = os.path.j
-000235d0: 6f69 6e28 6562 765f 6d61 7073 5f70 6174  oin(ebv_maps_pat
-000235e0: 682c 2027 476f 7273 6b69 5f45 4256 5f72  h, 'Gorski_EBV_r
-000235f0: 6573 335f 6c6d 632e 7478 7427 290a 0a20  es3_lmc.txt').. 
-00023600: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00023610: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00023620: 7228 2243 616e 6e6f 7420 6361 6c69 6272  r("Cannot calibr
-00023630: 6174 6520 6669 656c 6420 7573 696e 6720  ate field using 
-00023640: 476f 7273 6b69 2045 4256 206d 6170 7322  Gorski EBV maps"
-00023650: 290a 0a20 2020 2023 2323 2323 2323 2323  )..    #########
-00023660: 2323 2323 2323 2323 0a20 2020 2023 2049  ########.    # I
-00023670: 6e74 6572 706f 6c61 7465 2045 4256 0a0a  nterpolate EBV..
-00023680: 2020 2020 6562 765f 6d61 7020 3d20 7064      ebv_map = pd
-00023690: 2e72 6561 645f 6373 7628 6772 6964 2c20  .read_csv(grid, 
-000236a0: 6465 6c69 6d5f 7768 6974 6573 7061 6365  delim_whitespace
-000236b0: 3d54 7275 652c 2063 6f6d 6d65 6e74 203d  =True, comment =
-000236c0: 2022 2322 2c0a 2020 2020 2020 2020 2020   "#",.          
-000236d0: 2020 2020 2020 2020 2020 6e61 6d65 7320            names 
-000236e0: 3d20 5b27 5241 272c 2027 4445 4327 2c20  = ['RA', 'DEC', 
-000236f0: 2745 4256 272c 2027 655f 4542 5627 2c20  'EBV', 'e_EBV', 
-00023700: 2773 6967 6d61 5f52 4327 2c20 274e 5f52  'sigma_RC', 'N_R
-00023710: 4327 5d29 0a0a 2020 2020 7072 696e 7428  C'])..    print(
-00023720: 2249 6e74 6572 706f 6c61 7469 6e67 2065  "Interpolating e
-00023730: 7874 696e 6374 696f 6e20 6d61 7022 290a  xtinction map").
-00023740: 2020 2020 6562 765f 696e 7465 7270 203d      ebv_interp =
-00023750: 2069 6e74 6572 7032 6428 6562 765f 6d61   interp2d(ebv_ma
-00023760: 705b 2752 4127 5d2c 2065 6276 5f6d 6170  p['RA'], ebv_map
-00023770: 5b27 4445 4327 5d2c 2065 6276 5f6d 6170  ['DEC'], ebv_map
-00023780: 5b27 4542 5627 5d29 0a0a 2020 2020 2320  ['EBV'])..    # 
-00023790: 4765 7420 4542 2d56 0a20 2020 2045 4256  Get EB-V.    EBV
-000237a0: 203d 206e 702e 6675 6c6c 286c 656e 2852   = np.full(len(R
-000237b0: 4129 2c20 6e70 2e6e 616e 290a 0a20 2020  A), np.nan)..   
-000237c0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-000237d0: 6c65 6e28 5241 2929 3a0a 2020 2020 2020  len(RA)):.      
-000237e0: 2020 4542 565b 695d 203d 2065 6276 5f69    EBV[i] = ebv_i
-000237f0: 6e74 6572 7028 5241 5b69 5d2c 4445 435b  nterp(RA[i],DEC[
-00023800: 695d 290a 0a20 2020 2041 7620 3d20 4542  i])..    Av = EB
-00023810: 5620 2a20 332e 310a 0a20 2020 2023 2323  V * 3.1..    ###
-00023820: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00023830: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00023840: 230a 2020 2020 2320 436f 7272 6563 7420  #.    # Correct 
-00023850: 6578 7469 6e63 7469 6f6e 2066 6f72 2065  extinction for e
-00023860: 6163 6820 6669 6c74 6572 0a20 2020 2066  ach filter.    f
-00023870: 6f72 2066 696c 7420 696e 206c 6973 7428  or filt in list(
-00023880: 6669 6c74 6572 735f 416c 616d 6264 615f  filters_Alambda_
-00023890: 4176 2e6b 6579 7328 2929 3a0a 2020 2020  Av.keys()):.    
-000238a0: 2020 2020 6966 2066 696c 7420 696e 2063      if filt in c
-000238b0: 6174 5f64 6174 612e 636f 6c75 6d6e 732e  at_data.columns.
-000238c0: 6e61 6d65 733a 0a0a 2020 2020 2020 2020  names:..        
-000238d0: 2020 2020 416c 616d 6264 6120 3d20 4176      Alambda = Av
-000238e0: 202a 2066 696c 7465 7273 5f41 6c61 6d62   * filters_Alamb
-000238f0: 6461 5f41 765b 6669 6c74 5d0a 0a20 2020  da_Av[filt]..   
-00023900: 2020 2020 2020 2020 206e 6f74 5f6e 616e           not_nan
-00023910: 203d 2063 6174 5f64 6174 612e 636f 6c75   = cat_data.colu
-00023920: 6d6e 735b 6669 6c74 5d2e 6172 7261 7920  mns[filt].array 
-00023930: 213d 2039 390a 2020 2020 2020 2020 2020  != 99.          
-00023940: 2020 2320 4966 2072 6576 6572 7365 2c20    # If reverse, 
-00023950: 6578 7469 6e63 7469 6f6e 2069 7320 6170  extinction is ap
-00023960: 706c 6965 640a 2020 2020 2020 2020 2020  plied.          
-00023970: 2020 6966 2072 6576 6572 7365 2069 7320    if reverse is 
-00023980: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
-00023990: 2020 2020 2020 6361 745f 6461 7461 2e63        cat_data.c
-000239a0: 6f6c 756d 6e73 5b66 696c 745d 2e61 7272  olumns[filt].arr
-000239b0: 6179 5b6e 6f74 5f6e 616e 5d20 2b3d 2041  ay[not_nan] += A
-000239c0: 6c61 6d62 6461 5b6e 6f74 5f6e 616e 5d0a  lambda[not_nan].
-000239d0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000239e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000239f0: 2020 6361 745f 6461 7461 2e63 6f6c 756d    cat_data.colum
-00023a00: 6e73 5b66 696c 745d 2e61 7272 6179 5b6e  ns[filt].array[n
-00023a10: 6f74 5f6e 616e 5d20 2d3d 2041 6c61 6d62  ot_nan] -= Alamb
-00023a20: 6461 5b6e 6f74 5f6e 616e 5d0a 0a20 2020  da[not_nan]..   
-00023a30: 2023 2053 6176 6520 6f75 7470 7574 2064   # Save output d
-00023a40: 6174 610a 2020 2020 6361 742e 7772 6974  ata.    cat.writ
-00023a50: 6574 6f28 7361 7665 5f66 696c 6529 0a20  eto(save_file). 
-00023a60: 2020 2070 7269 6e74 2827 4372 6561 7465     print('Create
-00023a70: 6420 6669 6c65 2025 7327 2025 2073 6176  d file %s' % sav
-00023a80: 655f 6669 6c65 290a 0a0a 6465 6620 636f  e_file)...def co
-00023a90: 7272 6563 745f 6578 7469 6e63 7469 6f6e  rrect_extinction
-00023aa0: 5f67 6169 6164 7232 2863 6174 616c 6f67  _gaiadr2(catalog
-00023ab0: 2c20 7361 7665 5f66 696c 652c 2065 6276  , save_file, ebv
-00023ac0: 5f6d 6170 735f 7061 7468 3d4e 6f6e 652c  _maps_path=None,
-00023ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000212d0: 2020 2027 534d 5f47 273a 2031 2e31 3037     'SM_G': 1.107
+000212e0: 3839 2c20 2020 2020 2020 2753 4d5f 5227  89,       'SM_R'
+000212f0: 3a20 302e 3837 3037 322c 0a23 2020 2020  : 0.87072,.#    
+00021300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021310: 2753 4d5f 4927 3a20 302e 3634 3134 352c  'SM_I': 0.64145,
+00021320: 2020 2020 2020 2027 534d 5f5a 273a 2030         'SM_Z': 0
+00021330: 2e34 3635 3135 7d0a 0a23 2043 7572 7265  .46515}..# Curre
+00021340: 6e74 0a23 2068 7474 703a 2f2f 7376 6f32  nt.# http://svo2
+00021350: 2e63 6162 2e69 6e74 612d 6373 6963 2e65  .cab.inta-csic.e
+00021360: 732f 7376 6f2f 7468 656f 7279 2f66 7073  s/svo/theory/fps
+00021370: 332f 696e 6465 782e 7068 703f 6d6f 6465  3/index.php?mode
+00021380: 3d62 726f 7773 650a 5f41 6c61 6d62 6461  =browse._Alambda
+00021390: 5f41 7620 3d20 7b20 2027 5350 4c55 535f  _Av = {  'SPLUS_
+000213a0: 5527 3a20 312e 3631 2c20 2753 504c 5553  U': 1.61, 'SPLUS
+000213b0: 5f46 3337 3827 3a20 312e 3532 2c0a 2020  _F378': 1.52,.  
+000213c0: 2020 2020 2020 2020 2020 2020 2753 504c              'SPL
+000213d0: 5553 5f46 3339 3527 3a20 312e 3436 2c20  US_F395': 1.46, 
+000213e0: 2753 504c 5553 5f46 3431 3027 3a20 312e  'SPLUS_F410': 1.
+000213f0: 3430 2c0a 2020 2020 2020 2020 2020 2020  40,.            
+00021400: 2020 2753 504c 5553 5f46 3433 3027 3a20    'SPLUS_F430': 
+00021410: 312e 3333 2c20 2020 2027 5350 4c55 535f  1.33,    'SPLUS_
+00021420: 4727 3a20 312e 3230 2c0a 2020 2020 2020  G': 1.20,.      
+00021430: 2020 2020 2020 2020 2753 504c 5553 5f46          'SPLUS_F
+00021440: 3531 3527 3a20 312e 3130 2c20 2020 2027  515': 1.10,    '
+00021450: 5350 4c55 535f 5227 3a20 302e 3836 342c  SPLUS_R': 0.864,
+00021460: 0a20 2020 2020 2020 2020 2020 2020 2027  .              '
+00021470: 5350 4c55 535f 4636 3630 273a 2030 2e37  SPLUS_F660': 0.7
+00021480: 3938 2c20 2020 2027 5350 4c55 535f 4927  98,    'SPLUS_I'
+00021490: 3a20 302e 3634 382c 0a20 2020 2020 2020  : 0.648,.       
+000214a0: 2020 2020 2020 2027 5350 4c55 535f 4638         'SPLUS_F8
+000214b0: 3631 273a 2030 2e35 3339 2c20 2020 2027  61': 0.539,    '
+000214c0: 5350 4c55 535f 5a27 3a20 302e 3531 332c  SPLUS_Z': 0.513,
+000214d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000214e0: 2747 414c 4558 5f46 5556 273a 2032 2e36  'GALEX_FUV': 2.6
+000214f0: 312c 2020 2747 414c 4558 5f4e 5556 273a  1,  'GALEX_NUV':
+00021500: 2032 2e38 352c 0a20 2020 2020 2020 2020   2.85,.         
+00021510: 2020 2020 2020 2020 2027 5344 5353 5f55           'SDSS_U
+00021520: 273a 2031 2e35 382c 2020 2020 2027 5344  ': 1.58,     'SD
+00021530: 5353 5f47 273a 2031 2e32 322c 0a20 2020  SS_G': 1.22,.   
+00021540: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00021550: 5344 5353 5f52 273a 2030 2e38 3834 2c20  SDSS_R': 0.884, 
+00021560: 2020 2020 2753 4453 535f 4927 3a20 302e      'SDSS_I': 0.
+00021570: 3637 332c 0a20 2020 2020 2020 2020 2020  673,.           
+00021580: 2020 2020 2020 2027 5344 5353 5f5a 273a         'SDSS_Z':
+00021590: 2030 2e35 3134 2c20 2020 2020 2020 2750   0.514,       'P
+000215a0: 535f 4727 3a20 312e 3138 2c0a 2020 2020  S_G': 1.18,.    
+000215b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000215c0: 2750 535f 5227 3a20 302e 3838 312c 2020  'PS_R': 0.881,  
+000215d0: 2020 2020 2027 5053 5f49 273a 2030 2e36       'PS_I': 0.6
+000215e0: 3637 2c0a 2020 2020 2020 2020 2020 2020  67,.            
+000215f0: 2020 2020 2020 2020 2750 535f 5a27 3a20          'PS_Z': 
+00021600: 302e 3533 342c 2020 2020 2747 4149 415f  0.534,    'GAIA_
+00021610: 4250 273a 2031 2e31 332c 0a20 2020 2020  BP': 1.13,.     
+00021620: 2020 2020 2020 2020 2020 2020 2027 4741               'GA
+00021630: 4941 5f47 273a 2030 2e39 3339 2c20 2020  IA_G': 0.939,   
+00021640: 2027 4741 4941 5f52 5027 3a20 302e 3635   'GAIA_RP': 0.65
+00021650: 382c 0a20 2020 2020 2020 2020 2020 2020  8,.             
+00021660: 2020 2020 2020 2027 534d 5f55 273a 2031         'SM_U': 1
+00021670: 2e36 332c 2020 2020 2020 2027 534d 5f56  .63,       'SM_V
+00021680: 273a 2031 2e35 302c 0a20 2020 2020 2020  ': 1.50,.       
+00021690: 2020 2020 2020 2020 2020 2020 2027 534d               'SM
+000216a0: 5f47 273a 2031 2e31 312c 2020 2020 2020  _G': 1.11,      
+000216b0: 2027 534d 5f52 273a 2030 2e38 3835 2c0a   'SM_R': 0.885,.
+000216c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000216d0: 2020 2020 2753 4d5f 4927 3a20 302e 3633      'SM_I': 0.63
+000216e0: 362c 2020 2020 2020 2027 534d 5f5a 273a  6,       'SM_Z':
+000216f0: 2030 2e34 3936 2c0a 2020 2020 2020 2020   0.496,.        
+00021700: 2020 2020 2020 2020 2027 4741 4941 335f           'GAIA3_
+00021710: 4727 3a20 302e 3837 2c20 2020 2027 4741  G': 0.87,    'GA
+00021720: 4941 335f 4250 273a 2031 2e31 302c 0a20  IA3_BP': 1.10,. 
+00021730: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00021740: 4741 4941 335f 5250 273a 302e 3633 367d  GAIA3_RP':0.636}
+00021750: 0a0a 0a64 6566 2067 6574 5f45 4256 5f73  ...def get_EBV_s
+00021760: 6368 6c65 6765 6c28 5241 2c20 4445 432c  chlegel(RA, DEC,
+00021770: 2065 6276 5f6d 6170 735f 7061 7468 293a   ebv_maps_path):
+00021780: 0a0a 2020 2020 2222 220a 2020 2020 5265  ..    """.    Re
+00021790: 7475 726e 7320 5363 686c 6567 656c 2773  turns Schlegel's
+000217a0: 2045 5f42 2d56 2066 6f72 2070 6f73 6974   E_B-V for posit
+000217b0: 696f 6e73 2052 4120 616e 6420 4445 430a  ions RA and DEC.
+000217c0: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+000217d0: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+000217e0: 2020 2052 4120 3a20 6e70 2e61 7272 6179     RA : np.array
+000217f0: 0a20 2020 2020 2020 204c 6973 7420 6f66  .        List of
+00021800: 2073 6f75 7263 6573 2720 7269 6768 7420   sources' right 
+00021810: 6173 6365 6e74 696f 6e73 0a20 2020 2044  ascentions.    D
+00021820: 4543 203a 206e 702e 6172 7261 790a 2020  EC : np.array.  
+00021830: 2020 2020 2020 4c69 7374 206f 6620 736f        List of so
+00021840: 7572 6365 7327 2064 6563 6c69 6e61 7469  urces' declinati
+00021850: 6f6e 730a 2020 2020 6562 765f 6d61 7073  ons.    ebv_maps
+00021860: 5f70 6174 6820 3a20 7374 720a 2020 2020  _path : str.    
+00021870: 2020 2020 4c6f 6361 7469 6f6e 206f 6620      Location of 
+00021880: 4953 4d20 6578 7469 6e63 7469 6f6e 206d  ISM extinction m
+00021890: 6170 730a 0a20 2020 2052 6574 7572 6e73  aps..    Returns
+000218a0: 0a20 2020 202d 2d2d 2d2d 2d2d 0a20 2020  .    -------.   
+000218b0: 206e 702e 6172 7261 790a 2020 2020 2020   np.array.      
+000218c0: 2020 6172 7261 7920 6f66 2045 5f42 2d56    array of E_B-V
+000218d0: 2069 6e20 7468 6520 706f 7369 7469 6f6e   in the position
+000218e0: 206f 6620 7468 6520 736f 7572 6365 730a   of the sources.
+000218f0: 2020 2020 2222 220a 0a20 2020 206d 203d      """..    m =
+00021900: 2073 6664 6d61 702e 5346 444d 6170 2865   sfdmap.SFDMap(e
+00021910: 6276 5f6d 6170 735f 7061 7468 290a 2020  bv_maps_path).  
+00021920: 2020 4542 5620 3d20 6d2e 6562 7628 5241    EBV = m.ebv(RA
+00021930: 2c20 4445 4329 0a0a 2020 2020 7265 7475  , DEC)..    retu
+00021940: 726e 2045 4256 0a0a 0a0a 6465 6620 636f  rn EBV....def co
+00021950: 7272 6563 745f 6578 7469 6e63 7469 6f6e  rrect_extinction
+00021960: 5f73 6368 6c65 6765 6c28 6361 7461 6c6f  _schlegel(catalo
+00021970: 672c 2073 6176 655f 6669 6c65 2c20 6562  g, save_file, eb
+00021980: 765f 6d61 7073 5f70 6174 682c 0a20 2020  v_maps_path,.   
+00021990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000219a0: 2020 2020 2020 2020 2020 2020 2066 696c               fil
+000219b0: 7465 7273 5f41 6c61 6d62 6461 5f41 763d  ters_Alambda_Av=
+000219c0: 4e6f 6e65 2c20 7265 7665 7273 6520 3d20  None, reverse = 
+000219d0: 4661 6c73 652c 0a20 2020 2020 2020 2020  False,.         
+000219e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000219f0: 2020 2020 2020 2069 6e63 6c75 6465 5f6d         include_m
+00021a00: 6f64 203d 2046 616c 7365 293a 0a20 2020  od = False):.   
+00021a10: 2022 2222 0a20 2020 2043 6f72 7265 6374   """.    Correct
+00021a20: 7320 4953 4d20 6578 7469 6e63 7469 6f6e  s ISM extinction
+00021a30: 2069 6e20 7468 6520 6769 7665 6e20 6361   in the given ca
+00021a40: 7461 6c6f 6720 7573 696e 6720 5363 6865  talog using Sche
+00021a50: 6c65 6765 6c20 4542 2d56 206d 6170 730a  legel EB-V maps.
+00021a60: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00021a70: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00021a80: 2020 2063 6174 616c 6f67 203a 2073 7472     catalog : str
+00021a90: 0a20 2020 2020 2020 204c 6f63 6174 696f  .        Locatio
+00021aa0: 6e20 6f66 2074 6865 2063 6174 616c 6f67  n of the catalog
+00021ab0: 2077 6869 6368 2077 696c 6c20 6861 7665   which will have
+00021ac0: 2065 7863 7469 6e63 7469 6f6e 2063 6f72   exctinction cor
+00021ad0: 7265 6374 6564 0a20 2020 2073 6176 655f  rected.    save_
+00021ae0: 6669 6c65 203a 2073 7472 0a20 2020 2020  file : str.     
+00021af0: 2020 204c 6f63 6174 696f 6e20 6f66 2066     Location of f
+00021b00: 696c 6520 746f 2073 6176 6520 7468 6520  ile to save the 
+00021b10: 7265 7375 6c74 730a 2020 2020 6562 765f  results.    ebv_
+00021b20: 6d61 7073 5f70 6174 6820 3a20 7374 720a  maps_path : str.
+00021b30: 2020 2020 2020 2020 5061 7468 2074 6f20          Path to 
+00021b40: 6469 7265 6374 6f72 7920 636f 6e74 6169  directory contai
+00021b50: 6e69 6e67 2065 7874 696e 6374 696f 6e20  ning extinction 
+00021b60: 6d61 7073 0a20 2020 2066 696c 7465 7273  maps.    filters
+00021b70: 5f41 6c61 6d62 6461 5f41 7620 3a20 6469  _Alambda_Av : di
+00021b80: 6374 0a20 2020 2020 2020 2044 6963 7469  ct.        Dicti
+00021b90: 6f6e 6172 7920 7769 7468 2076 616c 7565  onary with value
+00021ba0: 7320 6f66 2041 6c61 6d62 6461 2f41 760a  s of Alambda/Av.
+00021bb0: 2020 2020 7265 7665 7273 6520 3a20 626f      reverse : bo
+00021bc0: 6f6c 0a20 2020 2020 2020 2049 6620 7472  ol.        If tr
+00021bd0: 7565 2c20 6578 7469 6e63 7469 6f6e 2069  ue, extinction i
+00021be0: 7320 6170 706c 6965 6420 696e 7374 6561  s applied instea
+00021bf0: 6420 6f66 2063 6f72 7265 6374 6564 0a20  d of corrected. 
+00021c00: 2020 2069 6e63 6c75 6465 5f6d 6f64 203a     include_mod :
+00021c10: 2062 6f6f 6c0a 2020 2020 2020 2020 4966   bool.        If
+00021c20: 2074 7275 652c 2061 6c73 6f20 6170 706c   true, also appl
+00021c30: 6965 7320 636f 7272 6563 7469 6f6e 2074  ies correction t
+00021c40: 6f20 636f 6c75 6d6e 7320 7b66 696c 747d  o columns {filt}
+00021c50: 5f6d 6f64 0a0a 2020 2020 5265 7475 726e  _mod..    Return
+00021c60: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
+00021c70: 2020 5361 7665 7320 6361 7461 6c6f 6720    Saves catalog 
+00021c80: 7769 7468 2063 6f72 7265 6374 6564 2065  with corrected e
+00021c90: 7874 696e 6374 696f 6e73 0a20 2020 2022  xtinctions.    "
+00021ca0: 2222 0a0a 2020 2020 6966 2066 696c 7465  ""..    if filte
+00021cb0: 7273 5f41 6c61 6d62 6461 5f41 7620 6973  rs_Alambda_Av is
+00021cc0: 204e 6f6e 653a 0a20 2020 2020 2020 2066   None:.        f
+00021cd0: 696c 7465 7273 5f41 6c61 6d62 6461 5f41  ilters_Alambda_A
+00021ce0: 7620 3d20 5f41 6c61 6d62 6461 5f41 760a  v = _Alambda_Av.
+00021cf0: 0a20 2020 2023 2041 6c73 6f20 6170 706c  .    # Also appl
+00021d00: 7920 636f 7272 6563 7469 6f6e 2074 6f20  y correction to 
+00021d10: 6d6f 6465 6c20 7072 6564 6963 7465 6420  model predicted 
+00021d20: 6d61 676e 6974 7564 6573 0a20 2020 2069  magnitudes.    i
+00021d30: 6620 696e 636c 7564 655f 6d6f 6420 6973  f include_mod is
+00021d40: 2054 7275 653a 0a20 2020 2020 2020 2066   True:.        f
+00021d50: 696c 7465 7273 203d 206c 6973 7428 6669  ilters = list(fi
+00021d60: 6c74 6572 735f 416c 616d 6264 615f 4176  lters_Alambda_Av
+00021d70: 2e6b 6579 7328 2929 0a20 2020 2020 2020  .keys()).       
+00021d80: 2066 6f72 2066 696c 7420 696e 2066 696c   for filt in fil
+00021d90: 7465 7273 3a0a 2020 2020 2020 2020 2020  ters:.          
+00021da0: 2020 6669 6c74 6572 735f 416c 616d 6264    filters_Alambd
+00021db0: 615f 4176 5b66 227b 6669 6c74 7d5f 6d6f  a_Av[f"{filt}_mo
+00021dc0: 6422 5d20 3d20 6669 6c74 6572 735f 416c  d"] = filters_Al
+00021dd0: 616d 6264 615f 4176 5b66 696c 745d 0a0a  ambda_Av[filt]..
+00021de0: 2020 2020 6d20 3d20 7366 646d 6170 2e53      m = sfdmap.S
+00021df0: 4644 4d61 7028 6562 765f 6d61 7073 5f70  FDMap(ebv_maps_p
+00021e00: 6174 6829 0a0a 2020 2020 2320 5265 6164  ath)..    # Read
+00021e10: 696e 6720 4361 7461 6c6f 6720 6461 7461  ing Catalog data
+00021e20: 0a20 2020 2063 6174 203d 2066 6974 732e  .    cat = fits.
+00021e30: 6f70 656e 2863 6174 616c 6f67 290a 2020  open(catalog).  
+00021e40: 2020 6361 745f 6461 7461 203d 2063 6174    cat_data = cat
+00021e50: 5b31 5d2e 6461 7461 0a0a 2020 2020 2323  [1].data..    ##
+00021e60: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
+00021e70: 2023 204f 6274 6169 6e69 6e67 2041 560a   # Obtaining AV.
+00021e80: 2020 2020 5241 203d 2063 6174 5f64 6174      RA = cat_dat
+00021e90: 615b 2752 414a 3230 3030 275d 0a20 2020  a['RAJ2000'].   
+00021ea0: 2044 4543 203d 2063 6174 5f64 6174 615b   DEC = cat_data[
+00021eb0: 2744 454a 3230 3030 275d 0a0a 2020 2020  'DEJ2000']..    
+00021ec0: 4542 5620 3d20 6d2e 6562 7628 5241 2c20  EBV = m.ebv(RA, 
+00021ed0: 4445 4329 0a20 2020 2041 7620 3d20 4542  DEC).    Av = EB
+00021ee0: 5620 2a20 332e 310a 0a20 2020 2023 2323  V * 3.1..    ###
+00021ef0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00021f00: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00021f10: 230a 2020 2020 2320 436f 7272 6563 7420  #.    # Correct 
+00021f20: 6578 7469 6e63 7469 6f6e 2066 6f72 2065  extinction for e
+00021f30: 6163 6820 6669 6c74 6572 0a0a 2020 2020  ach filter..    
+00021f40: 666f 7220 6669 6c74 2069 6e20 6c69 7374  for filt in list
+00021f50: 2866 696c 7465 7273 5f41 6c61 6d62 6461  (filters_Alambda
+00021f60: 5f41 762e 6b65 7973 2829 293a 0a20 2020  _Av.keys()):.   
+00021f70: 2020 2020 2069 6620 6669 6c74 2069 6e20       if filt in 
+00021f80: 6361 745f 6461 7461 2e63 6f6c 756d 6e73  cat_data.columns
+00021f90: 2e6e 616d 6573 3a0a 0a20 2020 2020 2020  .names:..       
+00021fa0: 2020 2020 2041 6c61 6d62 6461 203d 2041       Alambda = A
+00021fb0: 7620 2a20 6669 6c74 6572 735f 416c 616d  v * filters_Alam
+00021fc0: 6264 615f 4176 5b66 696c 745d 0a0a 2020  bda_Av[filt]..  
+00021fd0: 2020 2020 2020 2020 2020 6e6f 745f 6e61            not_na
+00021fe0: 6e20 3d20 6361 745f 6461 7461 2e63 6f6c  n = cat_data.col
+00021ff0: 756d 6e73 5b66 696c 745d 2e61 7272 6179  umns[filt].array
+00022000: 2021 3d20 3939 0a0a 2020 2020 2020 2020   != 99..        
+00022010: 2020 2020 2320 4966 2072 6576 6572 7365      # If reverse
+00022020: 2c20 6578 7469 6e63 7469 6f6e 2069 7320  , extinction is 
+00022030: 6170 706c 6965 640a 2020 2020 2020 2020  applied.        
+00022040: 2020 2020 6966 2072 6576 6572 7365 2069      if reverse i
+00022050: 7320 5472 7565 3a0a 2020 2020 2020 2020  s True:.        
+00022060: 2020 2020 2020 2020 6361 745f 6461 7461          cat_data
+00022070: 2e63 6f6c 756d 6e73 5b66 696c 745d 2e61  .columns[filt].a
+00022080: 7272 6179 5b6e 6f74 5f6e 616e 5d20 2b3d  rray[not_nan] +=
+00022090: 2041 6c61 6d62 6461 5b6e 6f74 5f6e 616e   Alambda[not_nan
+000220a0: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
+000220b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000220c0: 2020 2020 6361 745f 6461 7461 2e63 6f6c      cat_data.col
+000220d0: 756d 6e73 5b66 696c 745d 2e61 7272 6179  umns[filt].array
+000220e0: 5b6e 6f74 5f6e 616e 5d20 2d3d 2041 6c61  [not_nan] -= Ala
+000220f0: 6d62 6461 5b6e 6f74 5f6e 616e 5d0a 0a20  mbda[not_nan].. 
+00022100: 2020 2023 2053 6176 6520 6f75 7470 7574     # Save output
+00022110: 2064 6174 610a 2020 2020 6361 742e 7772   data.    cat.wr
+00022120: 6974 6574 6f28 7361 7665 5f66 696c 6529  iteto(save_file)
+00022130: 0a20 2020 2070 7269 6e74 2827 4372 6561  .    print('Crea
+00022140: 7465 6420 6669 6c65 2025 7327 2025 2073  ted file %s' % s
+00022150: 6176 655f 6669 6c65 290a 0a0a 6465 6620  ave_file)...def 
+00022160: 636f 7272 6563 745f 6578 7469 6e63 7469  correct_extincti
+00022170: 6f6e 5f73 6368 6c61 666c 7928 6361 7461  on_schlafly(cata
+00022180: 6c6f 672c 2073 6176 655f 6669 6c65 2c20  log, save_file, 
+00022190: 6562 765f 6d61 7073 5f70 6174 682c 0a20  ebv_maps_path,. 
+000221a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000221b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000221c0: 696c 7465 7273 5f41 6c61 6d62 6461 5f41  ilters_Alambda_A
+000221d0: 763d 4e6f 6e65 2c20 7265 7665 7273 6520  v=None, reverse 
+000221e0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+000221f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022200: 2020 2020 2020 2020 2069 6e63 6c75 6465           include
+00022210: 5f6d 6f64 203d 2046 616c 7365 293a 0a20  _mod = False):. 
+00022220: 2020 2022 2222 0a20 2020 2043 6f72 7265     """.    Corre
+00022230: 6374 7320 4953 4d20 6578 7469 6e63 7469  cts ISM extincti
+00022240: 6f6e 2069 6e20 7468 6520 6769 7665 6e20  on in the given 
+00022250: 6361 7461 6c6f 6720 7573 696e 6720 5363  catalog using Sc
+00022260: 6865 6c65 6765 6c20 4542 2d56 206d 6170  helegel EB-V map
+00022270: 730a 2020 2020 616e 6420 6170 706c 7969  s.    and applyi
+00022280: 6e67 2074 6865 2063 6f72 7265 6374 696f  ng the correctio
+00022290: 6e20 7072 6f70 6f73 6564 2062 7920 5363  n proposed by Sc
+000222a0: 686c 6166 6c79 2065 7420 616c 2e20 3230  hlafly et al. 20
+000222b0: 3130 3a0a 0a20 2020 2045 422d 5620 3d20  10:..    EB-V = 
+000222c0: 302e 3836 202a 2045 422d 565f 5363 686c  0.86 * EB-V_Schl
+000222d0: 6567 656c 0a0a 2020 2020 5061 7261 6d65  egel..    Parame
+000222e0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+000222f0: 2d2d 2d0a 2020 2020 6361 7461 6c6f 6720  ---.    catalog 
+00022300: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
+00022310: 6361 7469 6f6e 206f 6620 7468 6520 6361  cation of the ca
+00022320: 7461 6c6f 6720 7768 6963 6820 7769 6c6c  talog which will
+00022330: 2068 6176 6520 6578 6374 696e 6374 696f   have exctinctio
+00022340: 6e20 636f 7272 6563 7465 640a 2020 2020  n corrected.    
+00022350: 7361 7665 5f66 696c 6520 3a20 7374 720a  save_file : str.
+00022360: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
+00022370: 206f 6620 6669 6c65 2074 6f20 7361 7665   of file to save
+00022380: 2074 6865 2072 6573 756c 7473 0a20 2020   the results.   
+00022390: 2065 6276 5f6d 6170 7369 5f70 6174 6820   ebv_mapsi_path 
+000223a0: 3a20 7374 720a 2020 2020 2020 2020 5061  : str.        Pa
+000223b0: 7468 2074 6f20 6469 7265 6374 6f72 7920  th to directory 
+000223c0: 636f 6e74 6169 6e69 6e67 2065 7874 696e  containing extin
+000223d0: 6374 696f 6e20 6d61 7073 0a20 2020 2066  ction maps.    f
+000223e0: 696c 7465 7273 5f41 6c61 6d62 6461 5f41  ilters_Alambda_A
+000223f0: 7620 3a20 6469 6374 0a20 2020 2020 2020  v : dict.       
+00022400: 2044 6963 7469 6f6e 6172 7920 7769 7468   Dictionary with
+00022410: 2076 616c 7565 7320 6f66 2041 6c61 6d62   values of Alamb
+00022420: 6461 2f41 760a 2020 2020 7265 7665 7273  da/Av.    revers
+00022430: 6520 3a20 626f 6f6c 0a20 2020 2020 2020  e : bool.       
+00022440: 2049 6620 7472 7565 2c20 6578 7469 6e63   If true, extinc
+00022450: 7469 6f6e 2069 7320 6170 706c 6965 6420  tion is applied 
+00022460: 696e 7374 6561 6420 6f66 2063 6f72 7265  instead of corre
+00022470: 6374 6564 0a20 2020 2069 6e63 6c75 6465  cted.    include
+00022480: 5f6d 6f64 203a 2062 6f6f 6c0a 2020 2020  _mod : bool.    
+00022490: 2020 2020 4966 2074 7275 652c 2061 6c73      If true, als
+000224a0: 6f20 6170 706c 6965 7320 636f 7272 6563  o applies correc
+000224b0: 7469 6f6e 2074 6f20 636f 6c75 6d6e 7320  tion to columns 
+000224c0: 7b66 696c 747d 5f6d 6f64 0a0a 2020 2020  {filt}_mod..    
+000224d0: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+000224e0: 2d2d 2d0a 2020 2020 5361 7665 7320 6361  ---.    Saves ca
+000224f0: 7461 6c6f 6720 7769 7468 2063 6f72 7265  talog with corre
+00022500: 6374 6564 2065 7874 696e 6374 696f 6e73  cted extinctions
+00022510: 0a20 2020 2022 2222 0a0a 2020 2020 6966  .    """..    if
+00022520: 2066 696c 7465 7273 5f41 6c61 6d62 6461   filters_Alambda
+00022530: 5f41 7620 6973 204e 6f6e 653a 0a20 2020  _Av is None:.   
+00022540: 2020 2020 2066 696c 7465 7273 5f41 6c61       filters_Ala
+00022550: 6d62 6461 5f41 7620 3d20 5f41 6c61 6d62  mbda_Av = _Alamb
+00022560: 6461 5f41 760a 0a20 2020 2023 2041 6c73  da_Av..    # Als
+00022570: 6f20 6170 706c 7920 636f 7272 6563 7469  o apply correcti
+00022580: 6f6e 2074 6f20 6d6f 6465 6c20 7072 6564  on to model pred
+00022590: 6963 7465 6420 6d61 676e 6974 7564 6573  icted magnitudes
+000225a0: 0a20 2020 2069 6620 696e 636c 7564 655f  .    if include_
+000225b0: 6d6f 6420 6973 2054 7275 653a 0a20 2020  mod is True:.   
+000225c0: 2020 2020 2066 696c 7465 7273 203d 206c       filters = l
+000225d0: 6973 7428 6669 6c74 6572 735f 416c 616d  ist(filters_Alam
+000225e0: 6264 615f 4176 2e6b 6579 7328 2929 0a20  bda_Av.keys()). 
+000225f0: 2020 2020 2020 2066 6f72 2066 696c 7420         for filt 
+00022600: 696e 2066 696c 7465 7273 3a0a 2020 2020  in filters:.    
+00022610: 2020 2020 2020 2020 6669 6c74 6572 735f          filters_
+00022620: 416c 616d 6264 615f 4176 5b66 227b 6669  Alambda_Av[f"{fi
+00022630: 6c74 7d5f 6d6f 6422 5d20 3d20 6669 6c74  lt}_mod"] = filt
+00022640: 6572 735f 416c 616d 6264 615f 4176 5b66  ers_Alambda_Av[f
+00022650: 696c 745d 0a0a 2020 2020 6d20 3d20 7366  ilt]..    m = sf
+00022660: 646d 6170 2e53 4644 4d61 7028 6562 765f  dmap.SFDMap(ebv_
+00022670: 6d61 7073 5f70 6174 6829 0a0a 2020 2020  maps_path)..    
+00022680: 2320 5265 6164 696e 6720 4361 7461 6c6f  # Reading Catalo
+00022690: 6720 6461 7461 0a20 2020 2063 6174 203d  g data.    cat =
+000226a0: 2066 6974 732e 6f70 656e 2863 6174 616c   fits.open(catal
+000226b0: 6f67 290a 2020 2020 6361 745f 6461 7461  og).    cat_data
+000226c0: 203d 2063 6174 5b31 5d2e 6461 7461 0a0a   = cat[1].data..
+000226d0: 2020 2020 2323 2323 2323 2323 2323 2323      ############
+000226e0: 2323 0a20 2020 2023 204f 6274 6169 6e69  ##.    # Obtaini
+000226f0: 6e67 2041 560a 2020 2020 5241 203d 2063  ng AV.    RA = c
+00022700: 6174 5f64 6174 615b 2752 414a 3230 3030  at_data['RAJ2000
+00022710: 275d 0a20 2020 2044 4543 203d 2063 6174  '].    DEC = cat
+00022720: 5f64 6174 615b 2744 454a 3230 3030 275d  _data['DEJ2000']
+00022730: 0a0a 2020 2020 4542 5620 3d20 6d2e 6562  ..    EBV = m.eb
+00022740: 7628 5241 2c20 4445 4329 0a20 2020 2041  v(RA, DEC).    A
+00022750: 7620 3d20 4542 5620 2a20 302e 3836 202a  v = EBV * 0.86 *
+00022760: 2033 2e31 0a0a 2020 2020 2323 2323 2323   3.1..    ######
+00022770: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00022780: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
+00022790: 2020 2023 2043 6f72 7265 6374 2065 7874     # Correct ext
+000227a0: 696e 6374 696f 6e20 666f 7220 6561 6368  inction for each
+000227b0: 2066 696c 7465 720a 0a20 2020 2066 6f72   filter..    for
+000227c0: 2066 696c 7420 696e 206c 6973 7428 6669   filt in list(fi
+000227d0: 6c74 6572 735f 416c 616d 6264 615f 4176  lters_Alambda_Av
+000227e0: 2e6b 6579 7328 2929 3a0a 2020 2020 2020  .keys()):.      
+000227f0: 2020 6966 2066 696c 7420 696e 2063 6174    if filt in cat
+00022800: 5f64 6174 612e 636f 6c75 6d6e 732e 6e61  _data.columns.na
+00022810: 6d65 733a 0a0a 2020 2020 2020 2020 2020  mes:..          
+00022820: 2020 416c 616d 6264 6120 3d20 4176 202a    Alambda = Av *
+00022830: 2066 696c 7465 7273 5f41 6c61 6d62 6461   filters_Alambda
+00022840: 5f41 765b 6669 6c74 5d0a 0a20 2020 2020  _Av[filt]..     
+00022850: 2020 2020 2020 206e 6f74 5f6e 616e 203d         not_nan =
+00022860: 2063 6174 5f64 6174 612e 636f 6c75 6d6e   cat_data.column
+00022870: 735b 6669 6c74 5d2e 6172 7261 7920 213d  s[filt].array !=
+00022880: 2039 390a 0a20 2020 2020 2020 2020 2020   99..           
+00022890: 2023 2049 6620 7265 7665 7273 652c 2065   # If reverse, e
+000228a0: 7874 696e 6374 696f 6e20 6973 2061 7070  xtinction is app
+000228b0: 6c69 6564 0a20 2020 2020 2020 2020 2020  lied.           
+000228c0: 2069 6620 7265 7665 7273 6520 6973 2054   if reverse is T
+000228d0: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
+000228e0: 2020 2020 2063 6174 5f64 6174 612e 636f       cat_data.co
+000228f0: 6c75 6d6e 735b 6669 6c74 5d2e 6172 7261  lumns[filt].arra
+00022900: 795b 6e6f 745f 6e61 6e5d 202b 3d20 416c  y[not_nan] += Al
+00022910: 616d 6264 615b 6e6f 745f 6e61 6e5d 0a20  ambda[not_nan]. 
+00022920: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00022930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022940: 2063 6174 5f64 6174 612e 636f 6c75 6d6e   cat_data.column
+00022950: 735b 6669 6c74 5d2e 6172 7261 795b 6e6f  s[filt].array[no
+00022960: 745f 6e61 6e5d 202d 3d20 416c 616d 6264  t_nan] -= Alambd
+00022970: 615b 6e6f 745f 6e61 6e5d 0a0a 2020 2020  a[not_nan]..    
+00022980: 2320 5361 7665 206f 7574 7075 7420 6461  # Save output da
+00022990: 7461 0a20 2020 2063 6174 2e77 7269 7465  ta.    cat.write
+000229a0: 746f 2873 6176 655f 6669 6c65 290a 2020  to(save_file).  
+000229b0: 2020 7072 696e 7428 2743 7265 6174 6564    print('Created
+000229c0: 2066 696c 6520 2573 2720 2520 7361 7665   file %s' % save
+000229d0: 5f66 696c 6529 0a0a 0a64 6566 2063 6f72  _file)...def cor
+000229e0: 7265 6374 5f65 7874 696e 6374 696f 6e5f  rect_extinction_
+000229f0: 676f 7273 6b69 2863 6174 616c 6f67 2c20  gorski(catalog, 
+00022a00: 7361 7665 5f66 696c 652c 2065 6276 5f6d  save_file, ebv_m
+00022a10: 6170 735f 7061 7468 2c0a 2020 2020 2020  aps_path,.      
+00022a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022a30: 2020 2020 2020 2020 6669 6c74 6572 735f          filters_
+00022a40: 416c 616d 6264 615f 4176 3d4e 6f6e 652c  Alambda_Av=None,
+00022a50: 2072 6576 6572 7365 203d 2046 616c 7365   reverse = False
+00022a60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00022a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022a80: 696e 636c 7564 655f 6d6f 6420 3d20 4661  include_mod = Fa
+00022a90: 6c73 6529 3a0a 2020 2020 2222 220a 2020  lse):.    """.  
+00022aa0: 2020 436f 7272 6563 7473 2049 534d 2065    Corrects ISM e
+00022ab0: 7874 696e 6374 696f 6e20 696e 2074 6865  xtinction in the
+00022ac0: 2067 6976 656e 2063 6174 616c 6f67 2075   given catalog u
+00022ad0: 7369 6e67 2047 6f72 736b 6920 6574 2061  sing Gorski et a
+00022ae0: 6c2e 2032 3032 300a 2020 2020 4542 2d56  l. 2020.    EB-V
+00022af0: 206d 6170 7320 666f 7220 7468 6520 736d   maps for the sm
+00022b00: 616c 6c20 616e 6420 6c61 7267 6520 6d61  all and large ma
+00022b10: 6765 6c6c 616e 6963 2063 6c6f 7564 730a  gellanic clouds.
+00022b20: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00022b30: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00022b40: 2020 2063 6174 616c 6f67 203a 2073 7472     catalog : str
+00022b50: 0a20 2020 2020 2020 204c 6f63 6174 696f  .        Locatio
+00022b60: 6e20 6f66 2074 6865 2063 6174 616c 6f67  n of the catalog
+00022b70: 2077 6869 6368 2077 696c 6c20 6861 7665   which will have
+00022b80: 2065 7863 7469 6e63 7469 6f6e 2063 6f72   exctinction cor
+00022b90: 7265 6374 6564 0a20 2020 2073 6176 655f  rected.    save_
+00022ba0: 6669 6c65 203a 2073 7472 0a20 2020 2020  file : str.     
+00022bb0: 2020 204c 6f63 6174 696f 6e20 6f66 2066     Location of f
+00022bc0: 696c 6520 746f 2073 6176 6520 7468 6520  ile to save the 
+00022bd0: 7265 7375 6c74 730a 2020 2020 6562 765f  results.    ebv_
+00022be0: 6d61 7073 5f70 6174 6820 3a20 7374 720a  maps_path : str.
+00022bf0: 2020 2020 2020 2020 5061 7468 2074 6f20          Path to 
+00022c00: 6469 7265 6374 6f72 7920 636f 6e74 6169  directory contai
+00022c10: 6e69 6e67 2065 7874 696e 6374 696f 6e20  ning extinction 
+00022c20: 6d61 7073 0a20 2020 2066 696c 7465 7273  maps.    filters
+00022c30: 5f41 6c61 6d62 6461 5f41 7620 3a20 6469  _Alambda_Av : di
+00022c40: 6374 0a20 2020 2020 2020 2044 6963 7469  ct.        Dicti
+00022c50: 6f6e 6172 7920 7769 7468 2076 616c 7565  onary with value
+00022c60: 7320 6f66 2041 6c61 6d62 6461 2f41 760a  s of Alambda/Av.
+00022c70: 2020 2020 7265 7665 7273 6520 3a20 626f      reverse : bo
+00022c80: 6f6c 0a20 2020 2020 2020 2049 6620 7472  ol.        If tr
+00022c90: 7565 2c20 6578 7469 6e63 7469 6f6e 2069  ue, extinction i
+00022ca0: 7320 6170 706c 6965 6420 696e 7374 6561  s applied instea
+00022cb0: 6420 6f66 2063 6f72 7265 6374 6564 0a20  d of corrected. 
+00022cc0: 2020 2069 6e63 6c75 6465 5f6d 6f64 203a     include_mod :
+00022cd0: 2062 6f6f 6c0a 2020 2020 2020 2020 4966   bool.        If
+00022ce0: 2074 7275 652c 2061 6c73 6f20 6170 706c   true, also appl
+00022cf0: 6965 7320 636f 7272 6563 7469 6f6e 2074  ies correction t
+00022d00: 6f20 636f 6c75 6d6e 7320 7b66 696c 747d  o columns {filt}
+00022d10: 5f6d 6f64 0a0a 2020 2020 5265 7475 726e  _mod..    Return
+00022d20: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
+00022d30: 2020 5361 7665 7320 6361 7461 6c6f 6720    Saves catalog 
+00022d40: 7769 7468 2063 6f72 7265 6374 6564 2065  with corrected e
+00022d50: 7874 696e 6374 696f 6e73 0a20 2020 2022  xtinctions.    "
+00022d60: 2222 0a0a 2020 2020 2320 4164 6420 6f6e  ""..    # Add on
+00022d70: 2061 206c 6174 6572 2064 6174 6520 666f   a later date fo
+00022d80: 7220 7072 6f70 6572 2063 616c 6962 7261  r proper calibra
+00022d90: 7469 6f6e 206f 6620 7468 6520 4d43 730a  tion of the MCs.
+00022da0: 2020 2020 2320 4578 7469 6e63 7469 6f6e      # Extinction
+00022db0: 206d 6170 7320 6172 6520 616c 7265 6164   maps are alread
+00022dc0: 7920 696e 2074 6865 202f 7374 6573 2f52  y in the /stes/R
+00022dd0: 6573 6f75 7263 6573 2f45 7874 696e 6374  esources/Extinct
+00022de0: 696f 6e20 7061 7468 0a20 2020 2069 6620  ion path.    if 
+00022df0: 6669 6c74 6572 735f 416c 616d 6264 615f  filters_Alambda_
+00022e00: 4176 2069 7320 4e6f 6e65 3a0a 2020 2020  Av is None:.    
+00022e10: 2020 2020 6669 6c74 6572 735f 416c 616d      filters_Alam
+00022e20: 6264 615f 4176 203d 205f 416c 616d 6264  bda_Av = _Alambd
+00022e30: 615f 4176 0a0a 2020 2020 2320 416c 736f  a_Av..    # Also
+00022e40: 2061 7070 6c79 2063 6f72 7265 6374 696f   apply correctio
+00022e50: 6e20 746f 206d 6f64 656c 2070 7265 6469  n to model predi
+00022e60: 6374 6564 206d 6167 6e69 7475 6465 730a  cted magnitudes.
+00022e70: 2020 2020 6966 2069 6e63 6c75 6465 5f6d      if include_m
+00022e80: 6f64 2069 7320 5472 7565 3a0a 2020 2020  od is True:.    
+00022e90: 2020 2020 6669 6c74 6572 7320 3d20 6c69      filters = li
+00022ea0: 7374 2866 696c 7465 7273 5f41 6c61 6d62  st(filters_Alamb
+00022eb0: 6461 5f41 762e 6b65 7973 2829 290a 2020  da_Av.keys()).  
+00022ec0: 2020 2020 2020 666f 7220 6669 6c74 2069        for filt i
+00022ed0: 6e20 6669 6c74 6572 733a 0a20 2020 2020  n filters:.     
+00022ee0: 2020 2020 2020 2066 696c 7465 7273 5f41         filters_A
+00022ef0: 6c61 6d62 6461 5f41 765b 6622 7b66 696c  lambda_Av[f"{fil
+00022f00: 747d 5f6d 6f64 225d 203d 2066 696c 7465  t}_mod"] = filte
+00022f10: 7273 5f41 6c61 6d62 6461 5f41 765b 6669  rs_Alambda_Av[fi
+00022f20: 6c74 5d0a 0a20 2020 2023 2053 4d43 2061  lt]..    # SMC a
+00022f30: 6e64 204c 4d43 2067 7269 6420 636f 7665  nd LMC grid cove
+00022f40: 7261 6765 0a20 2020 2023 204d 6164 6520  rage.    # Made 
+00022f50: 6279 2068 616e 6420 7573 696e 6720 746f  by hand using to
+00022f60: 7063 6174 0a20 2020 2073 6d63 5f70 6f6c  pcat.    smc_pol
+00022f70: 7967 6f6e 203d 2050 6f6c 7967 6f6e 285b  ygon = Polygon([
+00022f80: 5b31 332e 3339 382c 2d37 312e 3230 315d  [13.398,-71.201]
+00022f90: 2c20 5b32 302e 3438 312c 2d37 312e 3230  , [20.481,-71.20
+00022fa0: 315d 2c20 5b32 322e 3032 392c 2d37 342e  1], [22.029,-74.
+00022fb0: 3139 375d 2c0a 2020 2020 2020 2020 2020  197],.          
+00022fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022fd0: 205b 3133 2e37 3730 2c2d 3734 2e32 3732   [13.770,-74.272
+00022fe0: 5d2c 205b 3133 2e35 3539 2c2d 3734 2e36  ], [13.559,-74.6
+00022ff0: 3933 5d2c 205b 3132 2e33 3231 2c2d 3734  93], [12.321,-74
+00023000: 2e35 3639 5d2c 0a20 2020 2020 2020 2020  .569],.         
+00023010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023020: 2020 5b31 322e 3232 322c 2d37 342e 3733    [12.222,-74.73
+00023030: 305d 2c20 5b31 312e 3632 372c 2d37 342e  0], [11.627,-74.
+00023040: 3634 335d 2c20 5b31 312e 3535 332c 2d37  643], [11.553,-7
+00023050: 342e 3835 345d 2c0a 2020 2020 2020 2020  4.854],.        
+00023060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023070: 2020 205b 342e 3839 312c 2d37 342e 3831     [4.891,-74.81
+00023080: 375d 2c20 205b 352e 3730 382c 2d37 322e  7],  [5.708,-72.
+00023090: 3331 355d 2c20 205b 3131 2e33 3932 2c2d  315],  [11.392,-
+000230a0: 3732 2e33 3737 5d2c 0a20 2020 2020 2020  72.377],.       
+000230b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000230c0: 2020 2020 5b31 312e 3531 362c 2d37 312e      [11.516,-71.
+000230d0: 3630 395d 2c20 5b31 332e 3239 392c 2d37  609], [13.299,-7
+000230e0: 312e 3538 355d 5d29 0a0a 2020 2020 6c6d  1.585]])..    lm
+000230f0: 635f 706f 6c79 676f 6e20 3d20 506f 6c79  c_polygon = Poly
+00023100: 676f 6e28 5b5b 3638 2e38 392c 202d 3636  gon([[68.89, -66
+00023110: 2e35 315d 2c20 5b37 392e 3130 2c20 2d36  .51], [79.10, -6
+00023120: 362e 3531 5d2c 205b 3739 2e30 382c 202d  6.51], [79.08, -
+00023130: 3637 2e36 375d 2c0a 2020 2020 2020 2020  67.67],.        
+00023140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023150: 2020 205b 3836 2e36 362c 202d 3637 2e37     [86.66, -67.7
+00023160: 315d 2c20 5b38 362e 3735 2c20 2d36 382e  1], [86.75, -68.
+00023170: 3235 5d2c 205b 3931 2e35 352c 202d 3638  25], [91.55, -68
+00023180: 2e33 325d 2c0a 2020 2020 2020 2020 2020  .32],.          
+00023190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000231a0: 205b 3931 2e37 342c 202d 3638 2e38 375d   [91.74, -68.87]
+000231b0: 2c20 5b39 332e 3532 2c20 2d36 382e 3930  , [93.52, -68.90
+000231c0: 5d2c 205b 3934 2e38 322c 202d 3731 2e33  ], [94.82, -71.3
+000231d0: 315d 2c0a 2020 2020 2020 2020 2020 2020  1],.            
+000231e0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+000231f0: 3933 2e34 382c 202d 3731 2e34 335d 2c20  93.48, -71.43], 
+00023200: 5b39 332e 3939 2c20 2d37 332e 3038 5d2c  [93.99, -73.08],
+00023210: 205b 3839 2e38 352c 202d 3733 2e31 355d   [89.85, -73.15]
+00023220: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00023230: 2020 2020 2020 2020 2020 2020 205b 3839               [89
+00023240: 2e37 392c 202d 3732 2e35 375d 2c20 5b38  .79, -72.57], [8
+00023250: 342e 3231 2c20 2d37 322e 3533 5d2c 205b  4.21, -72.53], [
+00023260: 3834 2e31 362c 202d 3731 2e39 385d 2c0a  84.16, -71.98],.
+00023270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023280: 2020 2020 2020 2020 2020 205b 3738 2e37             [78.7
+00023290: 312c 202d 3731 2e39 335d 2c20 5b37 382e  1, -71.93], [78.
+000232a0: 3735 2c20 2d37 312e 3338 5d2c 205b 3733  75, -71.38], [73
+000232b0: 2e34 352c 202d 3731 2e33 385d 2c0a 2020  .45, -71.38],.  
+000232c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000232d0: 2020 2020 2020 2020 205b 3733 2e34 392c           [73.49,
+000232e0: 202d 3730 2e38 355d 2c20 5b36 362e 3738   -70.85], [66.78
+000232f0: 2c20 2d37 302e 3637 5d5d 290a 0a20 2020  , -70.67]])..   
+00023300: 2023 2052 6561 6469 6e67 2043 6174 616c   # Reading Catal
+00023310: 6f67 2064 6174 610a 2020 2020 6361 7420  og data.    cat 
+00023320: 3d20 6669 7473 2e6f 7065 6e28 6361 7461  = fits.open(cata
+00023330: 6c6f 6729 0a20 2020 2063 6174 5f64 6174  log).    cat_dat
+00023340: 6120 3d20 6361 745b 315d 2e64 6174 610a  a = cat[1].data.
+00023350: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
+00023360: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00023370: 2323 2323 2323 230a 2020 2020 2320 4368  #######.    # Ch
+00023380: 6f6f 7365 2062 6574 7765 656e 204c 4d43  oose between LMC
+00023390: 2061 6e64 2053 4d43 2067 7269 6473 0a0a   and SMC grids..
+000233a0: 2020 2020 5241 203d 2063 6174 5f64 6174      RA = cat_dat
+000233b0: 615b 2752 414a 3230 3030 275d 0a20 2020  a['RAJ2000'].   
+000233c0: 2044 4543 203d 2063 6174 5f64 6174 615b   DEC = cat_data[
+000233d0: 2744 454a 3230 3030 275d 0a0a 2020 2020  'DEJ2000']..    
+000233e0: 7769 7468 696e 5f73 6d63 203d 206e 702e  within_smc = np.
+000233f0: 6675 6c6c 286c 656e 2852 4129 2c20 4661  full(len(RA), Fa
+00023400: 6c73 6529 0a20 2020 2077 6974 6869 6e5f  lse).    within_
+00023410: 6c6d 6320 3d20 6e70 2e66 756c 6c28 6c65  lmc = np.full(le
+00023420: 6e28 5241 292c 2046 616c 7365 290a 0a20  n(RA), False).. 
+00023430: 2020 2023 2043 6865 636b 696e 6720 6966     # Checking if
+00023440: 2070 6f69 6e74 7320 6172 6520 7769 7468   points are with
+00023450: 696e 206c 6d63 206f 7220 736d 630a 2020  in lmc or smc.  
+00023460: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+00023470: 286c 656e 2852 4129 293a 0a20 2020 2020  (len(RA)):.     
+00023480: 2020 2070 203d 2050 6f69 6e74 2852 415b     p = Point(RA[
+00023490: 695d 2c20 4445 435b 695d 290a 2020 2020  i], DEC[i]).    
+000234a0: 2020 2020 7769 7468 696e 5f73 6d63 5b69      within_smc[i
+000234b0: 5d20 3d20 702e 7769 7468 696e 2873 6d63  ] = p.within(smc
+000234c0: 5f70 6f6c 7967 6f6e 290a 2020 2020 2020  _polygon).      
+000234d0: 2020 7769 7468 696e 5f6c 6d63 5b69 5d20    within_lmc[i] 
+000234e0: 3d20 702e 7769 7468 696e 286c 6d63 5f70  = p.within(lmc_p
+000234f0: 6f6c 7967 6f6e 290a 0a20 2020 2069 6620  olygon)..    if 
+00023500: 7769 7468 696e 5f73 6d63 2e73 756d 2829  within_smc.sum()
+00023510: 203e 2030 3a0a 2020 2020 2020 2020 6772   > 0:.        gr
+00023520: 6964 203d 206f 732e 7061 7468 2e6a 6f69  id = os.path.joi
+00023530: 6e28 6562 765f 6d61 7073 5f70 6174 682c  n(ebv_maps_path,
+00023540: 2027 476f 7273 6b69 5f45 4256 5f72 6573   'Gorski_EBV_res
+00023550: 335f 736d 632e 7478 7427 290a 0a20 2020  3_smc.txt')..   
+00023560: 2065 6c69 6620 7769 7468 696e 5f6c 6d63   elif within_lmc
+00023570: 2e73 756d 2829 203e 2030 3a0a 2020 2020  .sum() > 0:.    
+00023580: 2020 2020 6772 6964 203d 206f 732e 7061      grid = os.pa
+00023590: 7468 2e6a 6f69 6e28 6562 765f 6d61 7073  th.join(ebv_maps
+000235a0: 5f70 6174 682c 2027 476f 7273 6b69 5f45  _path, 'Gorski_E
+000235b0: 4256 5f72 6573 335f 6c6d 632e 7478 7427  BV_res3_lmc.txt'
+000235c0: 290a 0a20 2020 2065 6c73 653a 0a20 2020  )..    else:.   
+000235d0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+000235e0: 4572 726f 7228 2243 616e 6e6f 7420 6361  Error("Cannot ca
+000235f0: 6c69 6272 6174 6520 6669 656c 6420 7573  librate field us
+00023600: 696e 6720 476f 7273 6b69 2045 4256 206d  ing Gorski EBV m
+00023610: 6170 7322 290a 0a20 2020 2023 2323 2323  aps")..    #####
+00023620: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
+00023630: 2023 2049 6e74 6572 706f 6c61 7465 2045   # Interpolate E
+00023640: 4256 0a0a 2020 2020 6562 765f 6d61 7020  BV..    ebv_map 
+00023650: 3d20 7064 2e72 6561 645f 6373 7628 6772  = pd.read_csv(gr
+00023660: 6964 2c20 6465 6c69 6d5f 7768 6974 6573  id, delim_whites
+00023670: 7061 6365 3d54 7275 652c 2063 6f6d 6d65  pace=True, comme
+00023680: 6e74 203d 2022 2322 2c0a 2020 2020 2020  nt = "#",.      
+00023690: 2020 2020 2020 2020 2020 2020 2020 6e61                na
+000236a0: 6d65 7320 3d20 5b27 5241 272c 2027 4445  mes = ['RA', 'DE
+000236b0: 4327 2c20 2745 4256 272c 2027 655f 4542  C', 'EBV', 'e_EB
+000236c0: 5627 2c20 2773 6967 6d61 5f52 4327 2c20  V', 'sigma_RC', 
+000236d0: 274e 5f52 4327 5d29 0a0a 2020 2020 7072  'N_RC'])..    pr
+000236e0: 696e 7428 2249 6e74 6572 706f 6c61 7469  int("Interpolati
+000236f0: 6e67 2065 7874 696e 6374 696f 6e20 6d61  ng extinction ma
+00023700: 7022 290a 2020 2020 6562 765f 696e 7465  p").    ebv_inte
+00023710: 7270 203d 2069 6e74 6572 7032 6428 6562  rp = interp2d(eb
+00023720: 765f 6d61 705b 2752 4127 5d2c 2065 6276  v_map['RA'], ebv
+00023730: 5f6d 6170 5b27 4445 4327 5d2c 2065 6276  _map['DEC'], ebv
+00023740: 5f6d 6170 5b27 4542 5627 5d29 0a0a 2020  _map['EBV'])..  
+00023750: 2020 2320 4765 7420 4542 2d56 0a20 2020    # Get EB-V.   
+00023760: 2045 4256 203d 206e 702e 6675 6c6c 286c   EBV = np.full(l
+00023770: 656e 2852 4129 2c20 6e70 2e6e 616e 290a  en(RA), np.nan).
+00023780: 0a20 2020 2066 6f72 2069 2069 6e20 7261  .    for i in ra
+00023790: 6e67 6528 6c65 6e28 5241 2929 3a0a 2020  nge(len(RA)):.  
+000237a0: 2020 2020 2020 4542 565b 695d 203d 2065        EBV[i] = e
+000237b0: 6276 5f69 6e74 6572 7028 5241 5b69 5d2c  bv_interp(RA[i],
+000237c0: 4445 435b 695d 290a 0a20 2020 2041 7620  DEC[i])..    Av 
+000237d0: 3d20 4542 5620 2a20 332e 310a 0a20 2020  = EBV * 3.1..   
+000237e0: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+000237f0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00023800: 2323 2323 230a 2020 2020 2320 436f 7272  #####.    # Corr
+00023810: 6563 7420 6578 7469 6e63 7469 6f6e 2066  ect extinction f
+00023820: 6f72 2065 6163 6820 6669 6c74 6572 0a20  or each filter. 
+00023830: 2020 2066 6f72 2066 696c 7420 696e 206c     for filt in l
+00023840: 6973 7428 6669 6c74 6572 735f 416c 616d  ist(filters_Alam
+00023850: 6264 615f 4176 2e6b 6579 7328 2929 3a0a  bda_Av.keys()):.
+00023860: 2020 2020 2020 2020 6966 2066 696c 7420          if filt 
+00023870: 696e 2063 6174 5f64 6174 612e 636f 6c75  in cat_data.colu
+00023880: 6d6e 732e 6e61 6d65 733a 0a0a 2020 2020  mns.names:..    
+00023890: 2020 2020 2020 2020 416c 616d 6264 6120          Alambda 
+000238a0: 3d20 4176 202a 2066 696c 7465 7273 5f41  = Av * filters_A
+000238b0: 6c61 6d62 6461 5f41 765b 6669 6c74 5d0a  lambda_Av[filt].
+000238c0: 0a20 2020 2020 2020 2020 2020 206e 6f74  .            not
+000238d0: 5f6e 616e 203d 2063 6174 5f64 6174 612e  _nan = cat_data.
+000238e0: 636f 6c75 6d6e 735b 6669 6c74 5d2e 6172  columns[filt].ar
+000238f0: 7261 7920 213d 2039 390a 2020 2020 2020  ray != 99.      
+00023900: 2020 2020 2020 2320 4966 2072 6576 6572        # If rever
+00023910: 7365 2c20 6578 7469 6e63 7469 6f6e 2069  se, extinction i
+00023920: 7320 6170 706c 6965 640a 2020 2020 2020  s applied.      
+00023930: 2020 2020 2020 6966 2072 6576 6572 7365        if reverse
+00023940: 2069 7320 5472 7565 3a0a 2020 2020 2020   is True:.      
+00023950: 2020 2020 2020 2020 2020 6361 745f 6461            cat_da
+00023960: 7461 2e63 6f6c 756d 6e73 5b66 696c 745d  ta.columns[filt]
+00023970: 2e61 7272 6179 5b6e 6f74 5f6e 616e 5d20  .array[not_nan] 
+00023980: 2b3d 2041 6c61 6d62 6461 5b6e 6f74 5f6e  += Alambda[not_n
+00023990: 616e 5d0a 2020 2020 2020 2020 2020 2020  an].            
+000239a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000239b0: 2020 2020 2020 6361 745f 6461 7461 2e63        cat_data.c
+000239c0: 6f6c 756d 6e73 5b66 696c 745d 2e61 7272  olumns[filt].arr
+000239d0: 6179 5b6e 6f74 5f6e 616e 5d20 2d3d 2041  ay[not_nan] -= A
+000239e0: 6c61 6d62 6461 5b6e 6f74 5f6e 616e 5d0a  lambda[not_nan].
+000239f0: 0a20 2020 2023 2053 6176 6520 6f75 7470  .    # Save outp
+00023a00: 7574 2064 6174 610a 2020 2020 6361 742e  ut data.    cat.
+00023a10: 7772 6974 6574 6f28 7361 7665 5f66 696c  writeto(save_fil
+00023a20: 6529 0a20 2020 2070 7269 6e74 2827 4372  e).    print('Cr
+00023a30: 6561 7465 6420 6669 6c65 2025 7327 2025  eated file %s' %
+00023a40: 2073 6176 655f 6669 6c65 290a 0a0a 6465   save_file)...de
+00023a50: 6620 636f 7272 6563 745f 6578 7469 6e63  f correct_extinc
+00023a60: 7469 6f6e 5f67 6169 6164 7232 2863 6174  tion_gaiadr2(cat
+00023a70: 616c 6f67 2c20 7361 7665 5f66 696c 652c  alog, save_file,
+00023a80: 2065 6276 5f6d 6170 735f 7061 7468 3d4e   ebv_maps_path=N
+00023a90: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+00023aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023ab0: 2020 2020 6669 6c74 6572 735f 416c 616d      filters_Alam
+00023ac0: 6264 615f 4176 3d4e 6f6e 652c 2072 6576  bda_Av=None, rev
+00023ad0: 6572 7365 3d46 616c 7365 2c0a 2020 2020  erse=False,.    
 00023ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023af0: 6669 6c74 6572 735f 416c 616d 6264 615f  filters_Alambda_
-00023b00: 4176 3d4e 6f6e 652c 2072 6576 6572 7365  Av=None, reverse
-00023b10: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
-00023b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023b30: 2020 2020 2020 2069 6e63 6c75 6465 5f6d         include_m
-00023b40: 6f64 3d46 616c 7365 293a 0a20 2020 2022  od=False):.    "
-00023b50: 2222 0a20 2020 2043 6f72 7265 6374 7320  "".    Corrects 
-00023b60: 4953 4d20 6578 7469 6e63 7469 6f6e 2069  ISM extinction i
-00023b70: 6e20 7468 6520 6769 7665 6e20 6361 7461  n the given cata
-00023b80: 6c6f 6720 7573 696e 6720 4741 4941 2044  log using GAIA D
-00023b90: 5232 2041 4720 7661 6c75 6573 0a0a 2020  R2 AG values..  
-00023ba0: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-00023bb0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-00023bc0: 6361 7461 6c6f 6720 3a20 7374 720a 2020  catalog : str.  
-00023bd0: 2020 2020 2020 4c6f 6361 7469 6f6e 206f        Location o
-00023be0: 6620 7468 6520 6361 7461 6c6f 6720 7768  f the catalog wh
-00023bf0: 6963 6820 7769 6c6c 2068 6176 6520 6578  ich will have ex
-00023c00: 6374 696e 6374 696f 6e20 636f 7272 6563  ctinction correc
-00023c10: 7465 642e 0a20 2020 2020 2020 2054 6865  ted..        The
-00023c20: 2063 6174 616c 6f67 206d 7573 7420 6861   catalog must ha
-00023c30: 7665 2062 6565 6e20 7072 6576 696f 7573  ve been previous
-00023c40: 6c79 2063 726f 7373 6d61 7463 6865 6420  ly crossmatched 
-00023c50: 7769 7468 2047 6169 6120 4452 3220 616e  with Gaia DR2 an
-00023c60: 640a 2020 2020 2020 2020 6e65 6564 2074  d.        need t
-00023c70: 6f20 6861 7665 2074 6865 2047 4149 415f  o have the GAIA_
-00023c80: 4147 2063 6f6c 756d 6e2e 0a20 2020 2073  AG column..    s
-00023c90: 6176 655f 6669 6c65 203a 2073 7472 0a20  ave_file : str. 
-00023ca0: 2020 2020 2020 204c 6f63 6174 696f 6e20         Location 
-00023cb0: 6f66 2066 696c 6520 746f 2073 6176 6520  of file to save 
-00023cc0: 7468 6520 7265 7375 6c74 730a 2020 2020  the results.    
-00023cd0: 6669 6c74 6572 735f 416c 616d 6264 615f  filters_Alambda_
-00023ce0: 4176 203a 2064 6963 740a 2020 2020 2020  Av : dict.      
-00023cf0: 2020 4469 6374 696f 6e61 7279 2077 6974    Dictionary wit
-00023d00: 6820 7661 6c75 6573 206f 6620 416c 616d  h values of Alam
-00023d10: 6264 612f 4176 0a20 2020 2065 6276 5f6d  bda/Av.    ebv_m
-00023d20: 6170 735f 7061 7468 203a 204e 6f6e 650a  aps_path : None.
-00023d30: 2020 2020 2020 2020 446f 6573 206e 6f74          Does not
-00023d40: 6869 6e67 2c20 6f6e 6c79 2069 6e63 6c75  hing, only inclu
-00023d50: 6465 6420 746f 2073 696d 706c 6966 7920  ded to simplify 
-00023d60: 6261 636b 7761 7264 7320 636f 6d70 6174  backwards compat
-00023d70: 6962 696c 6974 792e 0a20 2020 2072 6576  ibility..    rev
-00023d80: 6572 7365 203a 2062 6f6f 6c0a 2020 2020  erse : bool.    
-00023d90: 2020 2020 4966 2074 7275 652c 2065 7874      If true, ext
-00023da0: 696e 6374 696f 6e20 6973 2061 7070 6c69  inction is appli
-00023db0: 6564 2069 6e73 7465 6164 206f 6620 636f  ed instead of co
-00023dc0: 7272 6563 7465 640a 2020 2020 696e 636c  rrected.    incl
-00023dd0: 7564 655f 6d6f 6420 3a20 626f 6f6c 0a20  ude_mod : bool. 
-00023de0: 2020 2020 2020 2049 6620 7472 7565 2c20         If true, 
-00023df0: 616c 736f 2061 7070 6c69 6573 2063 6f72  also applies cor
-00023e00: 7265 6374 696f 6e20 746f 2063 6f6c 756d  rection to colum
-00023e10: 6e73 207b 6669 6c74 7d5f 6d6f 640a 0a20  ns {filt}_mod.. 
-00023e20: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
-00023e30: 2d2d 2d2d 2d2d 0a20 2020 2053 6176 6573  ------.    Saves
-00023e40: 2063 6174 616c 6f67 2077 6974 6820 636f   catalog with co
-00023e50: 7272 6563 7465 6420 6578 7469 6e63 7469  rrected extincti
-00023e60: 6f6e 730a 2020 2020 2222 220a 0a20 2020  ons.    """..   
-00023e70: 2069 6620 6669 6c74 6572 735f 416c 616d   if filters_Alam
-00023e80: 6264 615f 4176 2069 7320 4e6f 6e65 3a0a  bda_Av is None:.
-00023e90: 2020 2020 2020 2020 6669 6c74 6572 735f          filters_
-00023ea0: 416c 616d 6264 615f 4176 203d 205f 416c  Alambda_Av = _Al
-00023eb0: 616d 6264 615f 4176 0a0a 2020 2020 2320  ambda_Av..    # 
-00023ec0: 416c 736f 2061 7070 6c79 2063 6f72 7265  Also apply corre
-00023ed0: 6374 696f 6e20 746f 206d 6f64 656c 2070  ction to model p
-00023ee0: 7265 6469 6374 6564 206d 6167 6e69 7475  redicted magnitu
-00023ef0: 6465 730a 2020 2020 6966 2069 6e63 6c75  des.    if inclu
-00023f00: 6465 5f6d 6f64 2069 7320 5472 7565 3a0a  de_mod is True:.
-00023f10: 2020 2020 2020 2020 6669 6c74 6572 7320          filters 
-00023f20: 3d20 6c69 7374 2866 696c 7465 7273 5f41  = list(filters_A
-00023f30: 6c61 6d62 6461 5f41 762e 6b65 7973 2829  lambda_Av.keys()
-00023f40: 290a 2020 2020 2020 2020 666f 7220 6669  ).        for fi
-00023f50: 6c74 2069 6e20 6669 6c74 6572 733a 0a20  lt in filters:. 
-00023f60: 2020 2020 2020 2020 2020 2066 696c 7465             filte
-00023f70: 7273 5f41 6c61 6d62 6461 5f41 765b 6622  rs_Alambda_Av[f"
-00023f80: 7b66 696c 747d 5f6d 6f64 225d 203d 2066  {filt}_mod"] = f
-00023f90: 696c 7465 7273 5f41 6c61 6d62 6461 5f41  ilters_Alambda_A
-00023fa0: 765b 6669 6c74 5d0a 0a20 2020 2023 2052  v[filt]..    # R
-00023fb0: 6561 6469 6e67 2043 6174 616c 6f67 2064  eading Catalog d
-00023fc0: 6174 610a 2020 2020 6361 7420 3d20 6669  ata.    cat = fi
-00023fd0: 7473 2e6f 7065 6e28 6361 7461 6c6f 6729  ts.open(catalog)
-00023fe0: 0a20 2020 2063 6174 5f64 6174 6120 3d20  .    cat_data = 
-00023ff0: 6361 745b 315d 2e64 6174 610a 0a20 2020  cat[1].data..   
-00024000: 2023 2323 2323 2323 2323 2323 2323 230a   ##############.
-00024010: 2020 2020 2320 4f62 7461 696e 696e 6720      # Obtaining 
-00024020: 4156 0a20 2020 2041 4720 3d20 6361 745f  AV.    AG = cat_
-00024030: 6461 7461 5b27 4741 4941 5f41 4727 5d0a  data['GAIA_AG'].
-00024040: 0a20 2020 2041 7620 3d20 4147 202f 2066  .    Av = AG / f
-00024050: 696c 7465 7273 5f41 6c61 6d62 6461 5f41  ilters_Alambda_A
-00024060: 765b 2747 4149 415f 4727 5d0a 0a20 2020  v['GAIA_G']..   
-00024070: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
-00024080: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00024090: 2323 2323 230a 2020 2020 2320 436f 7272  #####.    # Corr
-000240a0: 6563 7420 6578 7469 6e63 7469 6f6e 2066  ect extinction f
-000240b0: 6f72 2065 6163 6820 6669 6c74 6572 0a20  or each filter. 
-000240c0: 2020 2066 6f72 2066 696c 7420 696e 206c     for filt in l
-000240d0: 6973 7428 6669 6c74 6572 735f 416c 616d  ist(filters_Alam
-000240e0: 6264 615f 4176 2e6b 6579 7328 2929 3a0a  bda_Av.keys()):.
-000240f0: 2020 2020 2020 2020 6966 2066 696c 7420          if filt 
-00024100: 696e 2063 6174 5f64 6174 612e 636f 6c75  in cat_data.colu
-00024110: 6d6e 732e 6e61 6d65 733a 0a0a 2020 2020  mns.names:..    
-00024120: 2020 2020 2020 2020 416c 616d 6264 6120          Alambda 
-00024130: 3d20 4176 202a 2066 696c 7465 7273 5f41  = Av * filters_A
-00024140: 6c61 6d62 6461 5f41 765b 6669 6c74 5d0a  lambda_Av[filt].
-00024150: 0a20 2020 2020 2020 2020 2020 206e 616e  .            nan
-00024160: 5f41 4720 3d20 4147 203e 2031 3030 2023  _AG = AG > 100 #
-00024170: 2077 696c 6c20 7265 6d6f 7665 7320 6e61   will removes na
-00024180: 6e20 7661 6c75 6573 2031 2c30 3030 3030  n values 1,00000
-00024190: 3045 3230 0a0a 2020 2020 2020 2020 2020  0E20..          
-000241a0: 2020 6e6f 745f 6e61 6e20 3d20 6361 745f    not_nan = cat_
-000241b0: 6461 7461 2e63 6f6c 756d 6e73 5b66 696c  data.columns[fil
-000241c0: 745d 2e61 7272 6179 2021 3d20 3939 0a20  t].array != 99. 
-000241d0: 2020 2020 2020 2020 2020 206e 6f74 5f6e             not_n
-000241e0: 616e 203d 206e 6f74 5f6e 616e 2026 207e  an = not_nan & ~
-000241f0: 6e61 6e5f 4147 0a0a 2020 2020 2020 2020  nan_AG..        
-00024200: 2020 2020 2320 4966 2072 6576 6572 7365      # If reverse
-00024210: 2c20 6578 7469 6e63 7469 6f6e 2069 7320  , extinction is 
-00024220: 6170 706c 6965 640a 2020 2020 2020 2020  applied.        
-00024230: 2020 2020 6966 2072 6576 6572 7365 2069      if reverse i
-00024240: 7320 5472 7565 3a0a 2020 2020 2020 2020  s True:.        
-00024250: 2020 2020 2020 2020 6361 745f 6461 7461          cat_data
-00024260: 2e63 6f6c 756d 6e73 5b66 696c 745d 2e61  .columns[filt].a
-00024270: 7272 6179 5b6e 6f74 5f6e 616e 5d20 2b3d  rray[not_nan] +=
-00024280: 2041 6c61 6d62 6461 5b6e 6f74 5f6e 616e   Alambda[not_nan
-00024290: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
-000242a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000242b0: 2020 2020 6361 745f 6461 7461 2e63 6f6c      cat_data.col
-000242c0: 756d 6e73 5b66 696c 745d 2e61 7272 6179  umns[filt].array
-000242d0: 5b6e 6f74 5f6e 616e 5d20 2d3d 2041 6c61  [not_nan] -= Ala
-000242e0: 6d62 6461 5b6e 6f74 5f6e 616e 5d0a 0a20  mbda[not_nan].. 
-000242f0: 2020 2020 2020 2020 2020 2023 2054 7572             # Tur
-00024300: 6e20 6d61 676e 6974 7564 6573 2074 6861  n magnitudes tha
-00024310: 7420 6361 6e27 7420 6265 2063 6f72 7265  t can't be corre
-00024320: 6374 6564 2069 6e74 6f20 3939 0a20 2020  cted into 99.   
-00024330: 2020 2020 2020 2020 2063 6174 5f64 6174           cat_dat
-00024340: 612e 636f 6c75 6d6e 735b 6669 6c74 5d2e  a.columns[filt].
-00024350: 6172 7261 795b 6e61 6e5f 4147 5d20 3d20  array[nan_AG] = 
-00024360: 3939 0a0a 2020 2020 2320 5361 7665 206f  99..    # Save o
-00024370: 7574 7075 7420 6461 7461 0a20 2020 2063  utput data.    c
-00024380: 6174 2e77 7269 7465 746f 2873 6176 655f  at.writeto(save_
-00024390: 6669 6c65 290a 2020 2020 7072 696e 7428  file).    print(
-000243a0: 2743 7265 6174 6564 2066 696c 6520 2573  'Created file %s
-000243b0: 2720 2520 7361 7665 5f66 696c 6529 0a0a  ' % save_file)..
-000243c0: 0a64 6566 2063 6f72 7265 6374 5f65 7874  .def correct_ext
-000243d0: 696e 6374 696f 6e5f 6761 6961 6472 3328  inction_gaiadr3(
-000243e0: 6361 7461 6c6f 672c 2073 6176 655f 6669  catalog, save_fi
-000243f0: 6c65 2c20 6562 765f 6d61 7073 5f70 6174  le, ebv_maps_pat
-00024400: 683d 4e6f 6e65 2c0a 2020 2020 2020 2020  h=None,.        
-00024410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024420: 2020 2020 2020 2066 696c 7465 7273 5f41         filters_A
-00024430: 6c61 6d62 6461 5f41 763d 4e6f 6e65 2c20  lambda_Av=None, 
-00024440: 7265 7665 7273 653d 4661 6c73 652c 0a20  reverse=False,. 
-00024450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024460: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00024470: 636c 7564 655f 6d6f 643d 4661 6c73 6529  clude_mod=False)
-00024480: 3a0a 2020 2020 2222 220a 2020 2020 436f  :.    """.    Co
-00024490: 7272 6563 7473 2049 534d 2065 7874 696e  rrects ISM extin
-000244a0: 6374 696f 6e20 696e 2074 6865 2067 6976  ction in the giv
-000244b0: 656e 2063 6174 616c 6f67 2075 7369 6e67  en catalog using
-000244c0: 2047 4149 4120 4452 3320 4147 2076 616c   GAIA DR3 AG val
-000244d0: 7565 730a 0a20 2020 2050 6172 616d 6574  ues..    Paramet
-000244e0: 6572 730a 2020 2020 2d2d 2d2d 2d2d 2d2d  ers.    --------
-000244f0: 2d2d 0a20 2020 2063 6174 616c 6f67 203a  --.    catalog :
-00024500: 2073 7472 0a20 2020 2020 2020 204c 6f63   str.        Loc
-00024510: 6174 696f 6e20 6f66 2074 6865 2063 6174  ation of the cat
-00024520: 616c 6f67 2077 6869 6368 2077 696c 6c20  alog which will 
-00024530: 6861 7665 2065 7863 7469 6e63 7469 6f6e  have exctinction
-00024540: 2063 6f72 7265 6374 6564 2e0a 2020 2020   corrected..    
-00024550: 2020 2020 5468 6520 6361 7461 6c6f 6720      The catalog 
-00024560: 6d75 7374 2068 6176 6520 6265 656e 2070  must have been p
-00024570: 7265 7669 6f75 736c 7920 6372 6f73 736d  reviously crossm
-00024580: 6174 6368 6564 2077 6974 6820 4761 6961  atched with Gaia
-00024590: 2044 5233 2061 6e64 0a20 2020 2020 2020   DR3 and.       
-000245a0: 206e 6565 6420 746f 2068 6176 6520 7468   need to have th
-000245b0: 6520 4741 4941 5f41 4720 636f 6c75 6d6e  e GAIA_AG column
-000245c0: 2e0a 2020 2020 7361 7665 5f66 696c 6520  ..    save_file 
-000245d0: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
-000245e0: 6361 7469 6f6e 206f 6620 6669 6c65 2074  cation of file t
-000245f0: 6f20 7361 7665 2074 6865 2072 6573 756c  o save the resul
-00024600: 7473 0a20 2020 2066 696c 7465 7273 5f41  ts.    filters_A
-00024610: 6c61 6d62 6461 5f41 7620 3a20 6469 6374  lambda_Av : dict
-00024620: 0a20 2020 2020 2020 2044 6963 7469 6f6e  .        Diction
-00024630: 6172 7920 7769 7468 2076 616c 7565 7320  ary with values 
-00024640: 6f66 2041 6c61 6d62 6461 2f41 760a 2020  of Alambda/Av.  
-00024650: 2020 6562 765f 6d61 7073 5f70 6174 6820    ebv_maps_path 
-00024660: 3a20 4e6f 6e65 0a20 2020 2020 2020 2044  : None.        D
-00024670: 6f65 7320 6e6f 7468 696e 672c 206f 6e6c  oes nothing, onl
-00024680: 7920 696e 636c 7564 6564 2074 6f20 7369  y included to si
-00024690: 6d70 6c69 6679 2062 6163 6b77 6172 6473  mplify backwards
-000246a0: 2063 6f6d 7061 7469 6269 6c69 7479 2e0a   compatibility..
-000246b0: 2020 2020 7265 7665 7273 6520 3a20 626f      reverse : bo
-000246c0: 6f6c 0a20 2020 2020 2020 2049 6620 7472  ol.        If tr
-000246d0: 7565 2c20 6578 7469 6e63 7469 6f6e 2069  ue, extinction i
-000246e0: 7320 6170 706c 6965 6420 696e 7374 6561  s applied instea
-000246f0: 6420 6f66 2063 6f72 7265 6374 6564 0a20  d of corrected. 
-00024700: 2020 2069 6e63 6c75 6465 5f6d 6f64 203a     include_mod :
-00024710: 2062 6f6f 6c0a 2020 2020 2020 2020 4966   bool.        If
-00024720: 2074 7275 652c 2061 6c73 6f20 6170 706c   true, also appl
-00024730: 6965 7320 636f 7272 6563 7469 6f6e 2074  ies correction t
-00024740: 6f20 636f 6c75 6d6e 7320 7b66 696c 747d  o columns {filt}
-00024750: 5f6d 6f64 0a0a 2020 2020 5265 7475 726e  _mod..    Return
-00024760: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-00024770: 2020 5361 7665 7320 6361 7461 6c6f 6720    Saves catalog 
-00024780: 7769 7468 2063 6f72 7265 6374 6564 2065  with corrected e
-00024790: 7874 696e 6374 696f 6e73 0a20 2020 2022  xtinctions.    "
-000247a0: 2222 0a0a 2020 2020 6966 2066 696c 7465  ""..    if filte
-000247b0: 7273 5f41 6c61 6d62 6461 5f41 7620 6973  rs_Alambda_Av is
-000247c0: 204e 6f6e 653a 0a20 2020 2020 2020 2066   None:.        f
-000247d0: 696c 7465 7273 5f41 6c61 6d62 6461 5f41  ilters_Alambda_A
-000247e0: 7620 3d20 5f41 6c61 6d62 6461 5f41 760a  v = _Alambda_Av.
-000247f0: 0a20 2020 2023 2041 6c73 6f20 6170 706c  .    # Also appl
-00024800: 7920 636f 7272 6563 7469 6f6e 2074 6f20  y correction to 
-00024810: 6d6f 6465 6c20 7072 6564 6963 7465 6420  model predicted 
-00024820: 6d61 676e 6974 7564 6573 0a20 2020 2069  magnitudes.    i
-00024830: 6620 696e 636c 7564 655f 6d6f 6420 6973  f include_mod is
-00024840: 2054 7275 653a 0a20 2020 2020 2020 2066   True:.        f
-00024850: 696c 7465 7273 203d 206c 6973 7428 6669  ilters = list(fi
-00024860: 6c74 6572 735f 416c 616d 6264 615f 4176  lters_Alambda_Av
-00024870: 2e6b 6579 7328 2929 0a20 2020 2020 2020  .keys()).       
-00024880: 2066 6f72 2066 696c 7420 696e 2066 696c   for filt in fil
-00024890: 7465 7273 3a0a 2020 2020 2020 2020 2020  ters:.          
-000248a0: 2020 6669 6c74 6572 735f 416c 616d 6264    filters_Alambd
-000248b0: 615f 4176 5b66 227b 6669 6c74 7d5f 6d6f  a_Av[f"{filt}_mo
-000248c0: 6422 5d20 3d20 6669 6c74 6572 735f 416c  d"] = filters_Al
-000248d0: 616d 6264 615f 4176 5b66 696c 745d 0a0a  ambda_Av[filt]..
-000248e0: 2020 2020 2320 5265 6164 696e 6720 4361      # Reading Ca
-000248f0: 7461 6c6f 6720 6461 7461 0a20 2020 2063  talog data.    c
-00024900: 6174 203d 2066 6974 732e 6f70 656e 2863  at = fits.open(c
-00024910: 6174 616c 6f67 290a 2020 2020 6361 745f  atalog).    cat_
-00024920: 6461 7461 203d 2063 6174 5b31 5d2e 6461  data = cat[1].da
-00024930: 7461 0a0a 2020 2020 2323 2323 2323 2323  ta..    ########
-00024940: 2323 2323 2323 0a20 2020 2023 204f 6274  ######.    # Obt
-00024950: 6169 6e69 6e67 2041 560a 2020 2020 4147  aining AV.    AG
-00024960: 203d 2063 6174 5f64 6174 615b 2747 4149   = cat_data['GAI
-00024970: 4133 5f41 4727 5d0a 0a20 2020 2041 7620  A3_AG']..    Av 
-00024980: 3d20 4147 202f 2066 696c 7465 7273 5f41  = AG / filters_A
-00024990: 6c61 6d62 6461 5f41 765b 2747 4149 4133  lambda_Av['GAIA3
-000249a0: 5f47 275d 0a0a 2020 2020 2323 2323 2323  _G']..    ######
-000249b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000249c0: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-000249d0: 2020 2023 2043 6f72 7265 6374 2065 7874     # Correct ext
-000249e0: 696e 6374 696f 6e20 666f 7220 6561 6368  inction for each
-000249f0: 2066 696c 7465 720a 2020 2020 666f 7220   filter.    for 
-00024a00: 6669 6c74 2069 6e20 6c69 7374 2866 696c  filt in list(fil
-00024a10: 7465 7273 5f41 6c61 6d62 6461 5f41 762e  ters_Alambda_Av.
-00024a20: 6b65 7973 2829 293a 0a20 2020 2020 2020  keys()):.       
-00024a30: 2069 6620 6669 6c74 2069 6e20 6361 745f   if filt in cat_
-00024a40: 6461 7461 2e63 6f6c 756d 6e73 2e6e 616d  data.columns.nam
-00024a50: 6573 3a0a 0a20 2020 2020 2020 2020 2020  es:..           
-00024a60: 2041 6c61 6d62 6461 203d 2041 7620 2a20   Alambda = Av * 
-00024a70: 6669 6c74 6572 735f 416c 616d 6264 615f  filters_Alambda_
-00024a80: 4176 5b66 696c 745d 0a0a 2020 2020 2020  Av[filt]..      
-00024a90: 2020 2020 2020 6e61 6e5f 4147 203d 2041        nan_AG = A
-00024aa0: 4720 3e20 3130 3020 2320 7769 6c6c 2072  G > 100 # will r
-00024ab0: 656d 6f76 6573 206e 616e 2076 616c 7565  emoves nan value
-00024ac0: 7320 312c 3030 3030 3030 4532 300a 0a20  s 1,000000E20.. 
-00024ad0: 2020 2020 2020 2020 2020 206e 6f74 5f6e             not_n
-00024ae0: 616e 203d 2063 6174 5f64 6174 612e 636f  an = cat_data.co
-00024af0: 6c75 6d6e 735b 6669 6c74 5d2e 6172 7261  lumns[filt].arra
-00024b00: 7920 213d 2039 390a 2020 2020 2020 2020  y != 99.        
-00024b10: 2020 2020 6e6f 745f 6e61 6e20 3d20 6e6f      not_nan = no
-00024b20: 745f 6e61 6e20 2620 7e6e 616e 5f41 470a  t_nan & ~nan_AG.
-00024b30: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
-00024b40: 6620 7265 7665 7273 652c 2065 7874 696e  f reverse, extin
-00024b50: 6374 696f 6e20 6973 2061 7070 6c69 6564  ction is applied
-00024b60: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00024b70: 7265 7665 7273 6520 6973 2054 7275 653a  reverse is True:
-00024b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024b90: 2063 6174 5f64 6174 612e 636f 6c75 6d6e   cat_data.column
-00024ba0: 735b 6669 6c74 5d2e 6172 7261 795b 6e6f  s[filt].array[no
-00024bb0: 745f 6e61 6e5d 202b 3d20 416c 616d 6264  t_nan] += Alambd
-00024bc0: 615b 6e6f 745f 6e61 6e5d 0a20 2020 2020  a[not_nan].     
-00024bd0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00024be0: 2020 2020 2020 2020 2020 2020 2063 6174               cat
-00024bf0: 5f64 6174 612e 636f 6c75 6d6e 735b 6669  _data.columns[fi
-00024c00: 6c74 5d2e 6172 7261 795b 6e6f 745f 6e61  lt].array[not_na
-00024c10: 6e5d 202d 3d20 416c 616d 6264 615b 6e6f  n] -= Alambda[no
-00024c20: 745f 6e61 6e5d 0a0a 2020 2020 2020 2020  t_nan]..        
-00024c30: 2020 2020 2320 5475 726e 206d 6167 6e69      # Turn magni
-00024c40: 7475 6465 7320 7468 6174 2063 616e 2774  tudes that can't
-00024c50: 2062 6520 636f 7272 6563 7465 6420 696e   be corrected in
-00024c60: 746f 2039 390a 2020 2020 2020 2020 2020  to 99.          
-00024c70: 2020 6361 745f 6461 7461 2e63 6f6c 756d    cat_data.colum
-00024c80: 6e73 5b66 696c 745d 2e61 7272 6179 5b6e  ns[filt].array[n
-00024c90: 616e 5f41 475d 203d 2039 390a 0a20 2020  an_AG] = 99..   
-00024ca0: 2023 2053 6176 6520 6f75 7470 7574 2064   # Save output d
-00024cb0: 6174 610a 2020 2020 6361 742e 7772 6974  ata.    cat.writ
-00024cc0: 6574 6f28 7361 7665 5f66 696c 6529 0a20  eto(save_file). 
-00024cd0: 2020 2070 7269 6e74 2827 4372 6561 7465     print('Create
-00024ce0: 6420 6669 6c65 2025 7327 2025 2073 6176  d file %s' % sav
-00024cf0: 655f 6669 6c65 290a 0a0a 6465 6620 636f  e_file)...def co
-00024d00: 7272 6563 745f 6578 7469 6e63 7469 6f6e  rrect_extinction
-00024d10: 2863 6174 616c 6f67 2c20 7361 7665 5f66  (catalog, save_f
-00024d20: 696c 652c 2063 6f72 7265 6374 696f 6e2c  ile, correction,
-00024d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024d40: 2020 2020 2020 2020 6669 6c74 6572 735f          filters_
-00024d50: 416c 616d 6264 615f 4176 3d4e 6f6e 652c  Alambda_Av=None,
-00024d60: 202a 2a6b 7761 7267 7329 3a0a 0a20 2020   **kwargs):..   
-00024d70: 2022 2222 0a20 2020 2047 656e 6572 616c   """.    General
-00024d80: 2066 756e 6374 696f 6e20 746f 2063 6f72   function to cor
-00024d90: 7265 6374 2065 7874 696e 6374 696f 6e20  rect extinction 
-00024da0: 7573 696e 6720 6120 7370 6563 6966 6963  using a specific
-00024db0: 206d 6170 0a0a 2020 2020 5061 7261 6d65   map..    Parame
-00024dc0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
-00024dd0: 2d2d 2d0a 2020 2020 6361 7461 6c6f 6720  ---.    catalog 
-00024de0: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
-00024df0: 6361 7469 6f6e 206f 6620 7468 6520 6361  cation of the ca
-00024e00: 7461 6c6f 6720 7768 6963 6820 7769 6c6c  talog which will
-00024e10: 2068 6176 6520 6578 6374 696e 6374 696f   have exctinctio
-00024e20: 6e20 636f 7272 6563 7465 640a 2020 2020  n corrected.    
-00024e30: 7361 7665 5f66 696c 6520 3a20 7374 720a  save_file : str.
-00024e40: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
-00024e50: 206f 6620 6669 6c65 2074 6f20 7361 7665   of file to save
-00024e60: 2074 6865 2072 6573 756c 7473 0a20 2020   the results.   
-00024e70: 2063 6f72 7265 6374 696f 6e20 3a20 7374   correction : st
-00024e80: 720a 2020 2020 2020 2020 5768 6963 6820  r.        Which 
-00024e90: 636f 7272 6563 7469 6f6e 206d 6170 2073  correction map s
-00024ea0: 686f 756c 6420 6265 2061 7070 6c69 6564  hould be applied
-00024eb0: 3a20 5343 484c 4549 4745 4c2c 2047 4f52  : SCHLEIGEL, GOR
-00024ec0: 534b 490a 2020 2020 6669 6c74 6572 735f  SKI.    filters_
-00024ed0: 416c 616d 6264 615f 4176 203a 2064 6963  Alambda_Av : dic
-00024ee0: 740a 2020 2020 2020 2020 4469 6374 696f  t.        Dictio
-00024ef0: 6e61 7279 2077 6974 6820 7661 6c75 6573  nary with values
-00024f00: 206f 6620 416c 616d 6264 612f 4176 0a0a   of Alambda/Av..
-00024f10: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-00024f20: 2d2d 2d2d 2d2d 2d0a 2020 2020 5361 7665  -------.    Save
-00024f30: 7320 6361 7461 6c6f 6720 7769 7468 2063  s catalog with c
-00024f40: 6f72 7265 6374 6564 2065 7874 696e 6374  orrected extinct
-00024f50: 696f 6e73 0a20 2020 2022 2222 0a0a 2020  ions.    """..  
-00024f60: 2020 6966 2066 696c 7465 7273 5f41 6c61    if filters_Ala
-00024f70: 6d62 6461 5f41 7620 6973 204e 6f6e 653a  mbda_Av is None:
-00024f80: 0a20 2020 2020 2020 2066 696c 7465 7273  .        filters
-00024f90: 5f6c 616d 6264 6120 3d20 5f41 6c61 6d62  _lambda = _Alamb
-00024fa0: 6461 5f41 760a 0a20 2020 2069 6620 636f  da_Av..    if co
-00024fb0: 7272 6563 7469 6f6e 2e6c 6f77 6572 2829  rrection.lower()
-00024fc0: 203d 3d20 2773 6368 6c65 6765 6c27 3a0a   == 'schlegel':.
-00024fd0: 2020 2020 2020 2020 636f 7272 6563 745f          correct_
-00024fe0: 6578 7469 6e63 7469 6f6e 5f73 6368 6c65  extinction_schle
-00024ff0: 6765 6c28 6361 7461 6c6f 673d 6361 7461  gel(catalog=cata
-00025000: 6c6f 672c 2073 6176 655f 6669 6c65 3d73  log, save_file=s
-00025010: 6176 655f 6669 6c65 2c0a 2020 2020 2020  ave_file,.      
-00025020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025030: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-00025040: 6c74 6572 735f 416c 616d 6264 615f 4176  lters_Alambda_Av
-00025050: 3d66 696c 7465 7273 5f41 6c61 6d62 6461  =filters_Alambda
-00025060: 5f41 762c 0a20 2020 2020 2020 2020 2020  _Av,.           
-00025070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025080: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
-00025090: 7329 0a0a 2020 2020 656c 6966 2063 6f72  s)..    elif cor
-000250a0: 7265 6374 696f 6e2e 6c6f 7765 7228 2920  rection.lower() 
-000250b0: 3d3d 2027 7363 686c 6166 6c79 273a 0a20  == 'schlafly':. 
-000250c0: 2020 2020 2020 2063 6f72 7265 6374 5f65         correct_e
-000250d0: 7874 696e 6374 696f 6e5f 7363 686c 6166  xtinction_schlaf
-000250e0: 6c79 2863 6174 616c 6f67 3d63 6174 616c  ly(catalog=catal
-000250f0: 6f67 2c20 7361 7665 5f66 696c 653d 7361  og, save_file=sa
-00025100: 7665 5f66 696c 652c 0a20 2020 2020 2020  ve_file,.       
-00025110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025120: 2020 2020 2020 2020 2020 2020 2066 696c               fil
-00025130: 7465 7273 5f41 6c61 6d62 6461 5f41 763d  ters_Alambda_Av=
-00025140: 6669 6c74 6572 735f 416c 616d 6264 615f  filters_Alambda_
-00025150: 4176 2c0a 2020 2020 2020 2020 2020 2020  Av,.            
-00025160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025170: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
-00025180: 290a 0a20 2020 2065 6c69 6620 636f 7272  )..    elif corr
-00025190: 6563 7469 6f6e 2e6c 6f77 6572 2829 203d  ection.lower() =
-000251a0: 3d20 2767 6f72 736b 6927 3a0a 2020 2020  = 'gorski':.    
-000251b0: 2020 2020 636f 7272 6563 745f 6578 7469      correct_exti
-000251c0: 6e63 7469 6f6e 5f67 6f72 736b 6928 6361  nction_gorski(ca
-000251d0: 7461 6c6f 673d 6361 7461 6c6f 672c 2073  talog=catalog, s
-000251e0: 6176 655f 6669 6c65 3d73 6176 655f 6669  ave_file=save_fi
-000251f0: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
-00025200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025210: 2020 2020 2020 6669 6c74 6572 735f 416c        filters_Al
-00025220: 616d 6264 615f 4176 3d66 696c 7465 7273  ambda_Av=filters
-00025230: 5f41 6c61 6d62 6461 5f41 762c 0a20 2020  _Alambda_Av,.   
-00025240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025250: 2020 2020 2020 2020 2020 2020 2020 202a                 *
-00025260: 2a6b 7761 7267 7329 0a0a 2020 2020 656c  *kwargs)..    el
-00025270: 6966 2063 6f72 7265 6374 696f 6e2e 6c6f  if correction.lo
-00025280: 7765 7228 2920 3d3d 2027 6761 6961 6472  wer() == 'gaiadr
-00025290: 3227 3a0a 2020 2020 2020 2020 636f 7272  2':.        corr
-000252a0: 6563 745f 6578 7469 6e63 7469 6f6e 5f67  ect_extinction_g
-000252b0: 6169 6164 7232 2863 6174 616c 6f67 3d63  aiadr2(catalog=c
-000252c0: 6174 616c 6f67 2c20 7361 7665 5f66 696c  atalog, save_fil
-000252d0: 653d 7361 7665 5f66 696c 652c 0a20 2020  e=save_file,.   
-000252e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023af0: 2020 2020 2020 2020 2020 2069 6e63 6c75             inclu
+00023b00: 6465 5f6d 6f64 3d46 616c 7365 293a 0a20  de_mod=False):. 
+00023b10: 2020 2022 2222 0a20 2020 2043 6f72 7265     """.    Corre
+00023b20: 6374 7320 4953 4d20 6578 7469 6e63 7469  cts ISM extincti
+00023b30: 6f6e 2069 6e20 7468 6520 6769 7665 6e20  on in the given 
+00023b40: 6361 7461 6c6f 6720 7573 696e 6720 4741  catalog using GA
+00023b50: 4941 2044 5232 2041 4720 7661 6c75 6573  IA DR2 AG values
+00023b60: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00023b70: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+00023b80: 2020 2020 6361 7461 6c6f 6720 3a20 7374      catalog : st
+00023b90: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
+00023ba0: 6f6e 206f 6620 7468 6520 6361 7461 6c6f  on of the catalo
+00023bb0: 6720 7768 6963 6820 7769 6c6c 2068 6176  g which will hav
+00023bc0: 6520 6578 6374 696e 6374 696f 6e20 636f  e exctinction co
+00023bd0: 7272 6563 7465 642e 0a20 2020 2020 2020  rrected..       
+00023be0: 2054 6865 2063 6174 616c 6f67 206d 7573   The catalog mus
+00023bf0: 7420 6861 7665 2062 6565 6e20 7072 6576  t have been prev
+00023c00: 696f 7573 6c79 2063 726f 7373 6d61 7463  iously crossmatc
+00023c10: 6865 6420 7769 7468 2047 6169 6120 4452  hed with Gaia DR
+00023c20: 3220 616e 640a 2020 2020 2020 2020 6e65  2 and.        ne
+00023c30: 6564 2074 6f20 6861 7665 2074 6865 2047  ed to have the G
+00023c40: 4149 415f 4147 2063 6f6c 756d 6e2e 0a20  AIA_AG column.. 
+00023c50: 2020 2073 6176 655f 6669 6c65 203a 2073     save_file : s
+00023c60: 7472 0a20 2020 2020 2020 204c 6f63 6174  tr.        Locat
+00023c70: 696f 6e20 6f66 2066 696c 6520 746f 2073  ion of file to s
+00023c80: 6176 6520 7468 6520 7265 7375 6c74 730a  ave the results.
+00023c90: 2020 2020 6669 6c74 6572 735f 416c 616d      filters_Alam
+00023ca0: 6264 615f 4176 203a 2064 6963 740a 2020  bda_Av : dict.  
+00023cb0: 2020 2020 2020 4469 6374 696f 6e61 7279        Dictionary
+00023cc0: 2077 6974 6820 7661 6c75 6573 206f 6620   with values of 
+00023cd0: 416c 616d 6264 612f 4176 0a20 2020 2065  Alambda/Av.    e
+00023ce0: 6276 5f6d 6170 735f 7061 7468 203a 204e  bv_maps_path : N
+00023cf0: 6f6e 650a 2020 2020 2020 2020 446f 6573  one.        Does
+00023d00: 206e 6f74 6869 6e67 2c20 6f6e 6c79 2069   nothing, only i
+00023d10: 6e63 6c75 6465 6420 746f 2073 696d 706c  ncluded to simpl
+00023d20: 6966 7920 6261 636b 7761 7264 7320 636f  ify backwards co
+00023d30: 6d70 6174 6962 696c 6974 792e 0a20 2020  mpatibility..   
+00023d40: 2072 6576 6572 7365 203a 2062 6f6f 6c0a   reverse : bool.
+00023d50: 2020 2020 2020 2020 4966 2074 7275 652c          If true,
+00023d60: 2065 7874 696e 6374 696f 6e20 6973 2061   extinction is a
+00023d70: 7070 6c69 6564 2069 6e73 7465 6164 206f  pplied instead o
+00023d80: 6620 636f 7272 6563 7465 640a 2020 2020  f corrected.    
+00023d90: 696e 636c 7564 655f 6d6f 6420 3a20 626f  include_mod : bo
+00023da0: 6f6c 0a20 2020 2020 2020 2049 6620 7472  ol.        If tr
+00023db0: 7565 2c20 616c 736f 2061 7070 6c69 6573  ue, also applies
+00023dc0: 2063 6f72 7265 6374 696f 6e20 746f 2063   correction to c
+00023dd0: 6f6c 756d 6e73 207b 6669 6c74 7d5f 6d6f  olumns {filt}_mo
+00023de0: 640a 0a20 2020 2052 6574 7572 6e73 0a20  d..    Returns. 
+00023df0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2053     -------.    S
+00023e00: 6176 6573 2063 6174 616c 6f67 2077 6974  aves catalog wit
+00023e10: 6820 636f 7272 6563 7465 6420 6578 7469  h corrected exti
+00023e20: 6e63 7469 6f6e 730a 2020 2020 2222 220a  nctions.    """.
+00023e30: 0a20 2020 2069 6620 6669 6c74 6572 735f  .    if filters_
+00023e40: 416c 616d 6264 615f 4176 2069 7320 4e6f  Alambda_Av is No
+00023e50: 6e65 3a0a 2020 2020 2020 2020 6669 6c74  ne:.        filt
+00023e60: 6572 735f 416c 616d 6264 615f 4176 203d  ers_Alambda_Av =
+00023e70: 205f 416c 616d 6264 615f 4176 0a0a 2020   _Alambda_Av..  
+00023e80: 2020 2320 416c 736f 2061 7070 6c79 2063    # Also apply c
+00023e90: 6f72 7265 6374 696f 6e20 746f 206d 6f64  orrection to mod
+00023ea0: 656c 2070 7265 6469 6374 6564 206d 6167  el predicted mag
+00023eb0: 6e69 7475 6465 730a 2020 2020 6966 2069  nitudes.    if i
+00023ec0: 6e63 6c75 6465 5f6d 6f64 2069 7320 5472  nclude_mod is Tr
+00023ed0: 7565 3a0a 2020 2020 2020 2020 6669 6c74  ue:.        filt
+00023ee0: 6572 7320 3d20 6c69 7374 2866 696c 7465  ers = list(filte
+00023ef0: 7273 5f41 6c61 6d62 6461 5f41 762e 6b65  rs_Alambda_Av.ke
+00023f00: 7973 2829 290a 2020 2020 2020 2020 666f  ys()).        fo
+00023f10: 7220 6669 6c74 2069 6e20 6669 6c74 6572  r filt in filter
+00023f20: 733a 0a20 2020 2020 2020 2020 2020 2066  s:.            f
+00023f30: 696c 7465 7273 5f41 6c61 6d62 6461 5f41  ilters_Alambda_A
+00023f40: 765b 6622 7b66 696c 747d 5f6d 6f64 225d  v[f"{filt}_mod"]
+00023f50: 203d 2066 696c 7465 7273 5f41 6c61 6d62   = filters_Alamb
+00023f60: 6461 5f41 765b 6669 6c74 5d0a 0a20 2020  da_Av[filt]..   
+00023f70: 2023 2052 6561 6469 6e67 2043 6174 616c   # Reading Catal
+00023f80: 6f67 2064 6174 610a 2020 2020 6361 7420  og data.    cat 
+00023f90: 3d20 6669 7473 2e6f 7065 6e28 6361 7461  = fits.open(cata
+00023fa0: 6c6f 6729 0a20 2020 2063 6174 5f64 6174  log).    cat_dat
+00023fb0: 6120 3d20 6361 745b 315d 2e64 6174 610a  a = cat[1].data.
+00023fc0: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
+00023fd0: 2323 230a 2020 2020 2320 4f62 7461 696e  ###.    # Obtain
+00023fe0: 696e 6720 4156 0a20 2020 2041 4720 3d20  ing AV.    AG = 
+00023ff0: 6361 745f 6461 7461 5b27 4741 4941 5f41  cat_data['GAIA_A
+00024000: 4727 5d0a 0a20 2020 2041 7620 3d20 4147  G']..    Av = AG
+00024010: 202f 2066 696c 7465 7273 5f41 6c61 6d62   / filters_Alamb
+00024020: 6461 5f41 765b 2747 4149 415f 4727 5d0a  da_Av['GAIA_G'].
+00024030: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
+00024040: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00024050: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
+00024060: 436f 7272 6563 7420 6578 7469 6e63 7469  Correct extincti
+00024070: 6f6e 2066 6f72 2065 6163 6820 6669 6c74  on for each filt
+00024080: 6572 0a20 2020 2066 6f72 2066 696c 7420  er.    for filt 
+00024090: 696e 206c 6973 7428 6669 6c74 6572 735f  in list(filters_
+000240a0: 416c 616d 6264 615f 4176 2e6b 6579 7328  Alambda_Av.keys(
+000240b0: 2929 3a0a 2020 2020 2020 2020 6966 2066  )):.        if f
+000240c0: 696c 7420 696e 2063 6174 5f64 6174 612e  ilt in cat_data.
+000240d0: 636f 6c75 6d6e 732e 6e61 6d65 733a 0a0a  columns.names:..
+000240e0: 2020 2020 2020 2020 2020 2020 416c 616d              Alam
+000240f0: 6264 6120 3d20 4176 202a 2066 696c 7465  bda = Av * filte
+00024100: 7273 5f41 6c61 6d62 6461 5f41 765b 6669  rs_Alambda_Av[fi
+00024110: 6c74 5d0a 0a20 2020 2020 2020 2020 2020  lt]..           
+00024120: 206e 616e 5f41 4720 3d20 4147 203e 2031   nan_AG = AG > 1
+00024130: 3030 2023 2077 696c 6c20 7265 6d6f 7665  00 # will remove
+00024140: 7320 6e61 6e20 7661 6c75 6573 2031 2c30  s nan values 1,0
+00024150: 3030 3030 3045 3230 0a0a 2020 2020 2020  00000E20..      
+00024160: 2020 2020 2020 6e6f 745f 6e61 6e20 3d20        not_nan = 
+00024170: 6361 745f 6461 7461 2e63 6f6c 756d 6e73  cat_data.columns
+00024180: 5b66 696c 745d 2e61 7272 6179 2021 3d20  [filt].array != 
+00024190: 3939 0a20 2020 2020 2020 2020 2020 206e  99.            n
+000241a0: 6f74 5f6e 616e 203d 206e 6f74 5f6e 616e  ot_nan = not_nan
+000241b0: 2026 207e 6e61 6e5f 4147 0a0a 2020 2020   & ~nan_AG..    
+000241c0: 2020 2020 2020 2020 2320 4966 2072 6576          # If rev
+000241d0: 6572 7365 2c20 6578 7469 6e63 7469 6f6e  erse, extinction
+000241e0: 2069 7320 6170 706c 6965 640a 2020 2020   is applied.    
+000241f0: 2020 2020 2020 2020 6966 2072 6576 6572          if rever
+00024200: 7365 2069 7320 5472 7565 3a0a 2020 2020  se is True:.    
+00024210: 2020 2020 2020 2020 2020 2020 6361 745f              cat_
+00024220: 6461 7461 2e63 6f6c 756d 6e73 5b66 696c  data.columns[fil
+00024230: 745d 2e61 7272 6179 5b6e 6f74 5f6e 616e  t].array[not_nan
+00024240: 5d20 2b3d 2041 6c61 6d62 6461 5b6e 6f74  ] += Alambda[not
+00024250: 5f6e 616e 5d0a 2020 2020 2020 2020 2020  _nan].          
+00024260: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00024270: 2020 2020 2020 2020 6361 745f 6461 7461          cat_data
+00024280: 2e63 6f6c 756d 6e73 5b66 696c 745d 2e61  .columns[filt].a
+00024290: 7272 6179 5b6e 6f74 5f6e 616e 5d20 2d3d  rray[not_nan] -=
+000242a0: 2041 6c61 6d62 6461 5b6e 6f74 5f6e 616e   Alambda[not_nan
+000242b0: 5d0a 0a20 2020 2020 2020 2020 2020 2023  ]..            #
+000242c0: 2054 7572 6e20 6d61 676e 6974 7564 6573   Turn magnitudes
+000242d0: 2074 6861 7420 6361 6e27 7420 6265 2063   that can't be c
+000242e0: 6f72 7265 6374 6564 2069 6e74 6f20 3939  orrected into 99
+000242f0: 0a20 2020 2020 2020 2020 2020 2063 6174  .            cat
+00024300: 5f64 6174 612e 636f 6c75 6d6e 735b 6669  _data.columns[fi
+00024310: 6c74 5d2e 6172 7261 795b 6e61 6e5f 4147  lt].array[nan_AG
+00024320: 5d20 3d20 3939 0a0a 2020 2020 2320 5361  ] = 99..    # Sa
+00024330: 7665 206f 7574 7075 7420 6461 7461 0a20  ve output data. 
+00024340: 2020 2063 6174 2e77 7269 7465 746f 2873     cat.writeto(s
+00024350: 6176 655f 6669 6c65 290a 2020 2020 7072  ave_file).    pr
+00024360: 696e 7428 2743 7265 6174 6564 2066 696c  int('Created fil
+00024370: 6520 2573 2720 2520 7361 7665 5f66 696c  e %s' % save_fil
+00024380: 6529 0a0a 0a64 6566 2063 6f72 7265 6374  e)...def correct
+00024390: 5f65 7874 696e 6374 696f 6e5f 6761 6961  _extinction_gaia
+000243a0: 6472 3328 6361 7461 6c6f 672c 2073 6176  dr3(catalog, sav
+000243b0: 655f 6669 6c65 2c20 6562 765f 6d61 7073  e_file, ebv_maps
+000243c0: 5f70 6174 683d 4e6f 6e65 2c0a 2020 2020  _path=None,.    
+000243d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000243e0: 2020 2020 2020 2020 2020 2066 696c 7465             filte
+000243f0: 7273 5f41 6c61 6d62 6461 5f41 763d 4e6f  rs_Alambda_Av=No
+00024400: 6e65 2c20 7265 7665 7273 653d 4661 6c73  ne, reverse=Fals
+00024410: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00024420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024430: 2020 696e 636c 7564 655f 6d6f 643d 4661    include_mod=Fa
+00024440: 6c73 6529 3a0a 2020 2020 2222 220a 2020  lse):.    """.  
+00024450: 2020 436f 7272 6563 7473 2049 534d 2065    Corrects ISM e
+00024460: 7874 696e 6374 696f 6e20 696e 2074 6865  xtinction in the
+00024470: 2067 6976 656e 2063 6174 616c 6f67 2075   given catalog u
+00024480: 7369 6e67 2047 4149 4120 4452 3320 4147  sing GAIA DR3 AG
+00024490: 2076 616c 7565 730a 0a20 2020 2050 6172   values..    Par
+000244a0: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
+000244b0: 2d2d 2d2d 2d2d 0a20 2020 2063 6174 616c  ------.    catal
+000244c0: 6f67 203a 2073 7472 0a20 2020 2020 2020  og : str.       
+000244d0: 204c 6f63 6174 696f 6e20 6f66 2074 6865   Location of the
+000244e0: 2063 6174 616c 6f67 2077 6869 6368 2077   catalog which w
+000244f0: 696c 6c20 6861 7665 2065 7863 7469 6e63  ill have exctinc
+00024500: 7469 6f6e 2063 6f72 7265 6374 6564 2e0a  tion corrected..
+00024510: 2020 2020 2020 2020 5468 6520 6361 7461          The cata
+00024520: 6c6f 6720 6d75 7374 2068 6176 6520 6265  log must have be
+00024530: 656e 2070 7265 7669 6f75 736c 7920 6372  en previously cr
+00024540: 6f73 736d 6174 6368 6564 2077 6974 6820  ossmatched with 
+00024550: 4761 6961 2044 5233 2061 6e64 0a20 2020  Gaia DR3 and.   
+00024560: 2020 2020 206e 6565 6420 746f 2068 6176       need to hav
+00024570: 6520 7468 6520 4741 4941 5f41 4720 636f  e the GAIA_AG co
+00024580: 6c75 6d6e 2e0a 2020 2020 7361 7665 5f66  lumn..    save_f
+00024590: 696c 6520 3a20 7374 720a 2020 2020 2020  ile : str.      
+000245a0: 2020 4c6f 6361 7469 6f6e 206f 6620 6669    Location of fi
+000245b0: 6c65 2074 6f20 7361 7665 2074 6865 2072  le to save the r
+000245c0: 6573 756c 7473 0a20 2020 2066 696c 7465  esults.    filte
+000245d0: 7273 5f41 6c61 6d62 6461 5f41 7620 3a20  rs_Alambda_Av : 
+000245e0: 6469 6374 0a20 2020 2020 2020 2044 6963  dict.        Dic
+000245f0: 7469 6f6e 6172 7920 7769 7468 2076 616c  tionary with val
+00024600: 7565 7320 6f66 2041 6c61 6d62 6461 2f41  ues of Alambda/A
+00024610: 760a 2020 2020 6562 765f 6d61 7073 5f70  v.    ebv_maps_p
+00024620: 6174 6820 3a20 4e6f 6e65 0a20 2020 2020  ath : None.     
+00024630: 2020 2044 6f65 7320 6e6f 7468 696e 672c     Does nothing,
+00024640: 206f 6e6c 7920 696e 636c 7564 6564 2074   only included t
+00024650: 6f20 7369 6d70 6c69 6679 2062 6163 6b77  o simplify backw
+00024660: 6172 6473 2063 6f6d 7061 7469 6269 6c69  ards compatibili
+00024670: 7479 2e0a 2020 2020 7265 7665 7273 6520  ty..    reverse 
+00024680: 3a20 626f 6f6c 0a20 2020 2020 2020 2049  : bool.        I
+00024690: 6620 7472 7565 2c20 6578 7469 6e63 7469  f true, extincti
+000246a0: 6f6e 2069 7320 6170 706c 6965 6420 696e  on is applied in
+000246b0: 7374 6561 6420 6f66 2063 6f72 7265 6374  stead of correct
+000246c0: 6564 0a20 2020 2069 6e63 6c75 6465 5f6d  ed.    include_m
+000246d0: 6f64 203a 2062 6f6f 6c0a 2020 2020 2020  od : bool.      
+000246e0: 2020 4966 2074 7275 652c 2061 6c73 6f20    If true, also 
+000246f0: 6170 706c 6965 7320 636f 7272 6563 7469  applies correcti
+00024700: 6f6e 2074 6f20 636f 6c75 6d6e 7320 7b66  on to columns {f
+00024710: 696c 747d 5f6d 6f64 0a0a 2020 2020 5265  ilt}_mod..    Re
+00024720: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+00024730: 2d0a 2020 2020 5361 7665 7320 6361 7461  -.    Saves cata
+00024740: 6c6f 6720 7769 7468 2063 6f72 7265 6374  log with correct
+00024750: 6564 2065 7874 696e 6374 696f 6e73 0a20  ed extinctions. 
+00024760: 2020 2022 2222 0a0a 2020 2020 6966 2066     """..    if f
+00024770: 696c 7465 7273 5f41 6c61 6d62 6461 5f41  ilters_Alambda_A
+00024780: 7620 6973 204e 6f6e 653a 0a20 2020 2020  v is None:.     
+00024790: 2020 2066 696c 7465 7273 5f41 6c61 6d62     filters_Alamb
+000247a0: 6461 5f41 7620 3d20 5f41 6c61 6d62 6461  da_Av = _Alambda
+000247b0: 5f41 760a 0a20 2020 2023 2041 6c73 6f20  _Av..    # Also 
+000247c0: 6170 706c 7920 636f 7272 6563 7469 6f6e  apply correction
+000247d0: 2074 6f20 6d6f 6465 6c20 7072 6564 6963   to model predic
+000247e0: 7465 6420 6d61 676e 6974 7564 6573 0a20  ted magnitudes. 
+000247f0: 2020 2069 6620 696e 636c 7564 655f 6d6f     if include_mo
+00024800: 6420 6973 2054 7275 653a 0a20 2020 2020  d is True:.     
+00024810: 2020 2066 696c 7465 7273 203d 206c 6973     filters = lis
+00024820: 7428 6669 6c74 6572 735f 416c 616d 6264  t(filters_Alambd
+00024830: 615f 4176 2e6b 6579 7328 2929 0a20 2020  a_Av.keys()).   
+00024840: 2020 2020 2066 6f72 2066 696c 7420 696e       for filt in
+00024850: 2066 696c 7465 7273 3a0a 2020 2020 2020   filters:.      
+00024860: 2020 2020 2020 6669 6c74 6572 735f 416c        filters_Al
+00024870: 616d 6264 615f 4176 5b66 227b 6669 6c74  ambda_Av[f"{filt
+00024880: 7d5f 6d6f 6422 5d20 3d20 6669 6c74 6572  }_mod"] = filter
+00024890: 735f 416c 616d 6264 615f 4176 5b66 696c  s_Alambda_Av[fil
+000248a0: 745d 0a0a 2020 2020 2320 5265 6164 696e  t]..    # Readin
+000248b0: 6720 4361 7461 6c6f 6720 6461 7461 0a20  g Catalog data. 
+000248c0: 2020 2063 6174 203d 2066 6974 732e 6f70     cat = fits.op
+000248d0: 656e 2863 6174 616c 6f67 290a 2020 2020  en(catalog).    
+000248e0: 6361 745f 6461 7461 203d 2063 6174 5b31  cat_data = cat[1
+000248f0: 5d2e 6461 7461 0a0a 2020 2020 2323 2323  ].data..    ####
+00024900: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
+00024910: 204f 6274 6169 6e69 6e67 2041 560a 2020   Obtaining AV.  
+00024920: 2020 4147 203d 2063 6174 5f64 6174 615b    AG = cat_data[
+00024930: 2747 4149 4133 5f41 4727 5d0a 0a20 2020  'GAIA3_AG']..   
+00024940: 2041 7620 3d20 4147 202f 2066 696c 7465   Av = AG / filte
+00024950: 7273 5f41 6c61 6d62 6461 5f41 765b 2747  rs_Alambda_Av['G
+00024960: 4149 4133 5f47 275d 0a0a 2020 2020 2323  AIA3_G']..    ##
+00024970: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00024980: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00024990: 2323 0a20 2020 2023 2043 6f72 7265 6374  ##.    # Correct
+000249a0: 2065 7874 696e 6374 696f 6e20 666f 7220   extinction for 
+000249b0: 6561 6368 2066 696c 7465 720a 2020 2020  each filter.    
+000249c0: 666f 7220 6669 6c74 2069 6e20 6c69 7374  for filt in list
+000249d0: 2866 696c 7465 7273 5f41 6c61 6d62 6461  (filters_Alambda
+000249e0: 5f41 762e 6b65 7973 2829 293a 0a20 2020  _Av.keys()):.   
+000249f0: 2020 2020 2069 6620 6669 6c74 2069 6e20       if filt in 
+00024a00: 6361 745f 6461 7461 2e63 6f6c 756d 6e73  cat_data.columns
+00024a10: 2e6e 616d 6573 3a0a 0a20 2020 2020 2020  .names:..       
+00024a20: 2020 2020 2041 6c61 6d62 6461 203d 2041       Alambda = A
+00024a30: 7620 2a20 6669 6c74 6572 735f 416c 616d  v * filters_Alam
+00024a40: 6264 615f 4176 5b66 696c 745d 0a0a 2020  bda_Av[filt]..  
+00024a50: 2020 2020 2020 2020 2020 6e61 6e5f 4147            nan_AG
+00024a60: 203d 2041 4720 3e20 3130 3020 2320 7769   = AG > 100 # wi
+00024a70: 6c6c 2072 656d 6f76 6573 206e 616e 2076  ll removes nan v
+00024a80: 616c 7565 7320 312c 3030 3030 3030 4532  alues 1,000000E2
+00024a90: 300a 0a20 2020 2020 2020 2020 2020 206e  0..            n
+00024aa0: 6f74 5f6e 616e 203d 2063 6174 5f64 6174  ot_nan = cat_dat
+00024ab0: 612e 636f 6c75 6d6e 735b 6669 6c74 5d2e  a.columns[filt].
+00024ac0: 6172 7261 7920 213d 2039 390a 2020 2020  array != 99.    
+00024ad0: 2020 2020 2020 2020 6e6f 745f 6e61 6e20          not_nan 
+00024ae0: 3d20 6e6f 745f 6e61 6e20 2620 7e6e 616e  = not_nan & ~nan
+00024af0: 5f41 470a 0a20 2020 2020 2020 2020 2020  _AG..           
+00024b00: 2023 2049 6620 7265 7665 7273 652c 2065   # If reverse, e
+00024b10: 7874 696e 6374 696f 6e20 6973 2061 7070  xtinction is app
+00024b20: 6c69 6564 0a20 2020 2020 2020 2020 2020  lied.           
+00024b30: 2069 6620 7265 7665 7273 6520 6973 2054   if reverse is T
+00024b40: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
+00024b50: 2020 2020 2063 6174 5f64 6174 612e 636f       cat_data.co
+00024b60: 6c75 6d6e 735b 6669 6c74 5d2e 6172 7261  lumns[filt].arra
+00024b70: 795b 6e6f 745f 6e61 6e5d 202b 3d20 416c  y[not_nan] += Al
+00024b80: 616d 6264 615b 6e6f 745f 6e61 6e5d 0a20  ambda[not_nan]. 
+00024b90: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00024ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024bb0: 2063 6174 5f64 6174 612e 636f 6c75 6d6e   cat_data.column
+00024bc0: 735b 6669 6c74 5d2e 6172 7261 795b 6e6f  s[filt].array[no
+00024bd0: 745f 6e61 6e5d 202d 3d20 416c 616d 6264  t_nan] -= Alambd
+00024be0: 615b 6e6f 745f 6e61 6e5d 0a0a 2020 2020  a[not_nan]..    
+00024bf0: 2020 2020 2020 2020 2320 5475 726e 206d          # Turn m
+00024c00: 6167 6e69 7475 6465 7320 7468 6174 2063  agnitudes that c
+00024c10: 616e 2774 2062 6520 636f 7272 6563 7465  an't be correcte
+00024c20: 6420 696e 746f 2039 390a 2020 2020 2020  d into 99.      
+00024c30: 2020 2020 2020 6361 745f 6461 7461 2e63        cat_data.c
+00024c40: 6f6c 756d 6e73 5b66 696c 745d 2e61 7272  olumns[filt].arr
+00024c50: 6179 5b6e 616e 5f41 475d 203d 2039 390a  ay[nan_AG] = 99.
+00024c60: 0a20 2020 2023 2053 6176 6520 6f75 7470  .    # Save outp
+00024c70: 7574 2064 6174 610a 2020 2020 6361 742e  ut data.    cat.
+00024c80: 7772 6974 6574 6f28 7361 7665 5f66 696c  writeto(save_fil
+00024c90: 6529 0a20 2020 2070 7269 6e74 2827 4372  e).    print('Cr
+00024ca0: 6561 7465 6420 6669 6c65 2025 7327 2025  eated file %s' %
+00024cb0: 2073 6176 655f 6669 6c65 290a 0a0a 6465   save_file)...de
+00024cc0: 6620 636f 7272 6563 745f 6578 7469 6e63  f correct_extinc
+00024cd0: 7469 6f6e 2863 6174 616c 6f67 2c20 7361  tion(catalog, sa
+00024ce0: 7665 5f66 696c 652c 2063 6f72 7265 6374  ve_file, correct
+00024cf0: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
+00024d00: 2020 2020 2020 2020 2020 2020 6669 6c74              filt
+00024d10: 6572 735f 416c 616d 6264 615f 4176 3d4e  ers_Alambda_Av=N
+00024d20: 6f6e 652c 202a 2a6b 7761 7267 7329 3a0a  one, **kwargs):.
+00024d30: 0a20 2020 2022 2222 0a20 2020 2047 656e  .    """.    Gen
+00024d40: 6572 616c 2066 756e 6374 696f 6e20 746f  eral function to
+00024d50: 2063 6f72 7265 6374 2065 7874 696e 6374   correct extinct
+00024d60: 696f 6e20 7573 696e 6720 6120 7370 6563  ion using a spec
+00024d70: 6966 6963 206d 6170 0a0a 2020 2020 5061  ific map..    Pa
+00024d80: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
+00024d90: 2d2d 2d2d 2d2d 2d0a 2020 2020 6361 7461  -------.    cata
+00024da0: 6c6f 6720 3a20 7374 720a 2020 2020 2020  log : str.      
+00024db0: 2020 4c6f 6361 7469 6f6e 206f 6620 7468    Location of th
+00024dc0: 6520 6361 7461 6c6f 6720 7768 6963 6820  e catalog which 
+00024dd0: 7769 6c6c 2068 6176 6520 6578 6374 696e  will have exctin
+00024de0: 6374 696f 6e20 636f 7272 6563 7465 640a  ction corrected.
+00024df0: 2020 2020 7361 7665 5f66 696c 6520 3a20      save_file : 
+00024e00: 7374 720a 2020 2020 2020 2020 4c6f 6361  str.        Loca
+00024e10: 7469 6f6e 206f 6620 6669 6c65 2074 6f20  tion of file to 
+00024e20: 7361 7665 2074 6865 2072 6573 756c 7473  save the results
+00024e30: 0a20 2020 2063 6f72 7265 6374 696f 6e20  .    correction 
+00024e40: 3a20 7374 720a 2020 2020 2020 2020 5768  : str.        Wh
+00024e50: 6963 6820 636f 7272 6563 7469 6f6e 206d  ich correction m
+00024e60: 6170 2073 686f 756c 6420 6265 2061 7070  ap should be app
+00024e70: 6c69 6564 3a20 5343 484c 4549 4745 4c2c  lied: SCHLEIGEL,
+00024e80: 2047 4f52 534b 490a 2020 2020 6669 6c74   GORSKI.    filt
+00024e90: 6572 735f 416c 616d 6264 615f 4176 203a  ers_Alambda_Av :
+00024ea0: 2064 6963 740a 2020 2020 2020 2020 4469   dict.        Di
+00024eb0: 6374 696f 6e61 7279 2077 6974 6820 7661  ctionary with va
+00024ec0: 6c75 6573 206f 6620 416c 616d 6264 612f  lues of Alambda/
+00024ed0: 4176 0a0a 2020 2020 5265 7475 726e 730a  Av..    Returns.
+00024ee0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+00024ef0: 5361 7665 7320 6361 7461 6c6f 6720 7769  Saves catalog wi
+00024f00: 7468 2063 6f72 7265 6374 6564 2065 7874  th corrected ext
+00024f10: 696e 6374 696f 6e73 0a20 2020 2022 2222  inctions.    """
+00024f20: 0a0a 2020 2020 6966 2066 696c 7465 7273  ..    if filters
+00024f30: 5f41 6c61 6d62 6461 5f41 7620 6973 204e  _Alambda_Av is N
+00024f40: 6f6e 653a 0a20 2020 2020 2020 2066 696c  one:.        fil
+00024f50: 7465 7273 5f6c 616d 6264 6120 3d20 5f41  ters_lambda = _A
+00024f60: 6c61 6d62 6461 5f41 760a 0a20 2020 2069  lambda_Av..    i
+00024f70: 6620 636f 7272 6563 7469 6f6e 2e6c 6f77  f correction.low
+00024f80: 6572 2829 203d 3d20 2773 6368 6c65 6765  er() == 'schlege
+00024f90: 6c27 3a0a 2020 2020 2020 2020 636f 7272  l':.        corr
+00024fa0: 6563 745f 6578 7469 6e63 7469 6f6e 5f73  ect_extinction_s
+00024fb0: 6368 6c65 6765 6c28 6361 7461 6c6f 673d  chlegel(catalog=
+00024fc0: 6361 7461 6c6f 672c 2073 6176 655f 6669  catalog, save_fi
+00024fd0: 6c65 3d73 6176 655f 6669 6c65 2c0a 2020  le=save_file,.  
+00024fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025000: 2020 6669 6c74 6572 735f 416c 616d 6264    filters_Alambd
+00025010: 615f 4176 3d66 696c 7465 7273 5f41 6c61  a_Av=filters_Ala
+00025020: 6d62 6461 5f41 762c 0a20 2020 2020 2020  mbda_Av,.       
+00025030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025040: 2020 2020 2020 2020 2020 2020 202a 2a6b               **k
+00025050: 7761 7267 7329 0a0a 2020 2020 656c 6966  wargs)..    elif
+00025060: 2063 6f72 7265 6374 696f 6e2e 6c6f 7765   correction.lowe
+00025070: 7228 2920 3d3d 2027 7363 686c 6166 6c79  r() == 'schlafly
+00025080: 273a 0a20 2020 2020 2020 2063 6f72 7265  ':.        corre
+00025090: 6374 5f65 7874 696e 6374 696f 6e5f 7363  ct_extinction_sc
+000250a0: 686c 6166 6c79 2863 6174 616c 6f67 3d63  hlafly(catalog=c
+000250b0: 6174 616c 6f67 2c20 7361 7665 5f66 696c  atalog, save_fil
+000250c0: 653d 7361 7665 5f66 696c 652c 0a20 2020  e=save_file,.   
+000250d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000250e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000250f0: 2066 696c 7465 7273 5f41 6c61 6d62 6461   filters_Alambda
+00025100: 5f41 763d 6669 6c74 6572 735f 416c 616d  _Av=filters_Alam
+00025110: 6264 615f 4176 2c0a 2020 2020 2020 2020  bda_Av,.        
+00025120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025130: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
+00025140: 6172 6773 290a 0a20 2020 2065 6c69 6620  args)..    elif 
+00025150: 636f 7272 6563 7469 6f6e 2e6c 6f77 6572  correction.lower
+00025160: 2829 203d 3d20 2767 6f72 736b 6927 3a0a  () == 'gorski':.
+00025170: 2020 2020 2020 2020 636f 7272 6563 745f          correct_
+00025180: 6578 7469 6e63 7469 6f6e 5f67 6f72 736b  extinction_gorsk
+00025190: 6928 6361 7461 6c6f 673d 6361 7461 6c6f  i(catalog=catalo
+000251a0: 672c 2073 6176 655f 6669 6c65 3d73 6176  g, save_file=sav
+000251b0: 655f 6669 6c65 2c0a 2020 2020 2020 2020  e_file,.        
+000251c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000251d0: 2020 2020 2020 2020 2020 6669 6c74 6572            filter
+000251e0: 735f 416c 616d 6264 615f 4176 3d66 696c  s_Alambda_Av=fil
+000251f0: 7465 7273 5f41 6c61 6d62 6461 5f41 762c  ters_Alambda_Av,
+00025200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025220: 2020 202a 2a6b 7761 7267 7329 0a0a 2020     **kwargs)..  
+00025230: 2020 656c 6966 2063 6f72 7265 6374 696f    elif correctio
+00025240: 6e2e 6c6f 7765 7228 2920 3d3d 2027 6761  n.lower() == 'ga
+00025250: 6961 6472 3227 3a0a 2020 2020 2020 2020  iadr2':.        
+00025260: 636f 7272 6563 745f 6578 7469 6e63 7469  correct_extincti
+00025270: 6f6e 5f67 6169 6164 7232 2863 6174 616c  on_gaiadr2(catal
+00025280: 6f67 3d63 6174 616c 6f67 2c20 7361 7665  og=catalog, save
+00025290: 5f66 696c 653d 7361 7665 5f66 696c 652c  _file=save_file,
+000252a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000252b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000252c0: 2020 2020 6669 6c74 6572 735f 416c 616d      filters_Alam
+000252d0: 6264 615f 4176 3d66 696c 7465 7273 5f41  bda_Av=filters_A
+000252e0: 6c61 6d62 6461 5f41 762c 0a20 2020 2020  lambda_Av,.     
 000252f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025300: 6669 6c74 6572 735f 416c 616d 6264 615f  filters_Alambda_
-00025310: 4176 3d66 696c 7465 7273 5f41 6c61 6d62  Av=filters_Alamb
-00025320: 6461 5f41 762c 0a20 2020 2020 2020 2020  da_Av,.         
-00025330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025340: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
-00025350: 6773 290a 0a20 2020 2065 6c69 6620 636f  gs)..    elif co
-00025360: 7272 6563 7469 6f6e 2e6c 6f77 6572 2829  rrection.lower()
-00025370: 203d 3d20 2767 6169 6164 7233 273a 0a20   == 'gaiadr3':. 
-00025380: 2020 2020 2020 2063 6f72 7265 6374 5f65         correct_e
-00025390: 7874 696e 6374 696f 6e5f 6761 6961 6472  xtinction_gaiadr
-000253a0: 3328 6361 7461 6c6f 673d 6361 7461 6c6f  3(catalog=catalo
-000253b0: 672c 2073 6176 655f 6669 6c65 3d73 6176  g, save_file=sav
-000253c0: 655f 6669 6c65 2c0a 2020 2020 2020 2020  e_file,.        
-000253d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000253e0: 2020 2020 2020 2020 2020 2066 696c 7465             filte
-000253f0: 7273 5f41 6c61 6d62 6461 5f41 763d 6669  rs_Alambda_Av=fi
-00025400: 6c74 6572 735f 416c 616d 6264 615f 4176  lters_Alambda_Av
-00025410: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00025420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025430: 2020 2020 202a 2a6b 7761 7267 7329 0a20       **kwargs). 
-00025440: 2020 200a 2020 2020 656c 7365 3a0a 2020     .    else:.  
-00025450: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00025460: 6545 7272 6f72 2866 2245 7874 696e 6374  eError(f"Extinct
-00025470: 696f 6e20 7b63 6f72 7265 6374 696f 6e7d  ion {correction}
-00025480: 2069 7320 6e6f 7420 7375 7070 6f72 7465   is not supporte
-00025490: 642e 2229 0a0a 2323 2323 2323 2323 2323  d.")..##########
-000254a0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000254b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000254c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000254d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000254e0: 2323 2323 2323 0a23 2043 616c 6962 7261  ######.# Calibra
-000254f0: 7469 6f6e 0a0a 2320 5c74 6f64 6f20 4144  tion..# \todo AD
-00025500: 4420 756e 6365 7274 6169 6e74 7920 6573  D uncertainty es
-00025510: 7469 6d61 7469 6f6e 2074 6f20 7468 6520  timation to the 
-00025520: 5345 4420 6669 7474 6564 207a 6572 6f2d  SED fitted zero-
-00025530: 706f 696e 7473 0a0a 0a64 6566 207a 705f  points...def zp_
-00025540: 7772 6974 6528 7a70 5f64 6963 742c 2073  write(zp_dict, s
-00025550: 6176 655f 6669 6c65 2c20 6669 6c74 6572  ave_file, filter
-00025560: 735f 6c69 7374 3d4e 6f6e 6529 3a0a 2020  s_list=None):.  
-00025570: 2020 2222 220a 2020 2020 7772 6974 6573    """.    writes
-00025580: 2061 202e 7a70 2066 696c 650a 0a20 2020   a .zp file..   
-00025590: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-000255a0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 207a  ----------.    z
-000255b0: 705f 6469 6374 203a 2064 6963 740a 2020  p_dict : dict.  
-000255c0: 2020 2020 2020 4469 6374 696f 6e61 7279        Dictionary
-000255d0: 206f 6620 7a65 726f 2070 6f69 6e74 7320   of zero points 
-000255e0: 286b 6579 733a 2066 696c 7465 7220 6e61  (keys: filter na
-000255f0: 6d65 2c20 7661 6c75 653a 2066 696c 7465  me, value: filte
-00025600: 7220 7a65 726f 2d70 6f69 6e74 290a 2020  r zero-point).  
-00025610: 2020 7361 7665 5f66 696c 6520 3a20 7374    save_file : st
-00025620: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
-00025630: 6f6e 2074 6f20 7361 7665 2074 6865 207a  on to save the z
-00025640: 7020 6669 6c65 0a20 2020 2066 696c 7465  p file.    filte
-00025650: 7273 5f6c 6973 7420 3a20 6c69 7374 0a20  rs_list : list. 
-00025660: 2020 2020 2020 204c 6973 7420 6f66 2066         List of f
-00025670: 696c 7465 7273 2074 6f20 7361 7665 207a  ilters to save z
-00025680: 6572 6f2d 706f 696e 7473 2e20 4966 204e  ero-points. If N
-00025690: 6f6e 652c 2061 6c6c 2066 696c 7465 7273  one, all filters
-000256a0: 2069 6e20 7a70 5f64 6963 7420 6172 650a   in zp_dict are.
-000256b0: 2020 2020 2020 2020 7361 7665 640a 0a20          saved.. 
-000256c0: 2020 2052 6574 7572 6e73 0a20 2020 202d     Returns.    -
-000256d0: 2d2d 2d2d 2d2d 0a20 2020 2053 6176 6573  ------.    Saves
-000256e0: 2061 207a 7020 6669 6c65 0a20 2020 2022   a zp file.    "
-000256f0: 2222 0a0a 2020 2020 7072 696e 7428 275c  ""..    print('\
-00025700: 6e53 6176 696e 6720 7265 7375 6c74 7320  nSaving results 
-00025710: 746f 2066 696c 6520 2573 2720 2520 7361  to file %s' % sa
-00025720: 7665 5f66 696c 6529 0a0a 2020 2020 6966  ve_file)..    if
-00025730: 2066 696c 7465 7273 5f6c 6973 7420 6973   filters_list is
-00025740: 204e 6f6e 653a 0a20 2020 2020 2020 2066   None:.        f
-00025750: 696c 7465 7273 5f6c 6973 7420 3d20 7a70  ilters_list = zp
-00025760: 5f64 6963 742e 6b65 7973 2829 0a0a 2020  _dict.keys()..  
-00025770: 2020 7769 7468 206f 7065 6e28 7361 7665    with open(save
-00025780: 5f66 696c 652c 2027 7727 2920 6173 2066  _file, 'w') as f
-00025790: 3a0a 0a20 2020 2020 2020 2069 6620 7479  :..        if ty
-000257a0: 7065 2866 696c 7465 7273 5f6c 6973 7429  pe(filters_list)
-000257b0: 2069 7320 7374 723a 0a20 2020 2020 2020   is str:.       
-000257c0: 2020 2020 2066 2e77 7269 7465 2822 7b3a       f.write("{:
-000257d0: 737d 207b 3a2e 3566 7d5c 6e22 2e66 6f72  s} {:.5f}\n".for
-000257e0: 6d61 7428 6669 6c74 6572 735f 6c69 7374  mat(filters_list
-000257f0: 2c20 7a70 5f64 6963 745b 6669 6c74 6572  , zp_dict[filter
-00025800: 735f 6c69 7374 5d29 290a 0a20 2020 2020  s_list]))..     
-00025810: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00025820: 2020 2020 2066 6f72 2066 696c 7420 696e       for filt in
-00025830: 2066 696c 7465 7273 5f6c 6973 743a 0a20   filters_list:. 
-00025840: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00025850: 2e77 7269 7465 2822 7b3a 737d 207b 3a2e  .write("{:s} {:.
-00025860: 3566 7d5c 6e22 2e66 6f72 6d61 7428 6669  5f}\n".format(fi
-00025870: 6c74 2c20 7a70 5f64 6963 745b 6669 6c74  lt, zp_dict[filt
-00025880: 5d29 290a 0a20 2020 2070 7269 6e74 2827  ]))..    print('
-00025890: 5265 7375 6c74 7320 6172 6520 7361 7665  Results are save
-000258a0: 6420 696e 2066 696c 6520 2573 2720 2520  d in file %s' % 
-000258b0: 7361 7665 5f66 696c 6529 0a0a 0a64 6566  save_file)...def
-000258c0: 207a 705f 7265 6164 286c 6f61 645f 6669   zp_read(load_fi
-000258d0: 6c65 2c20 7a70 5f63 6f6c 203d 2031 293a  le, zp_col = 1):
-000258e0: 0a20 2020 2022 2222 0a20 2020 2052 6561  .    """.    Rea
-000258f0: 6473 2061 202e 7a70 2066 696c 650a 2020  ds a .zp file.  
-00025900: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-00025910: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-00025920: 6c6f 6164 5f66 696c 6520 3a20 7374 720a  load_file : str.
-00025930: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
-00025940: 206f 6620 7468 6520 2e7a 7020 6669 6c65   of the .zp file
-00025950: 0a20 2020 207a 705f 636f 6c20 3a20 696e  .    zp_col : in
-00025960: 740a 2020 2020 2020 2020 436f 6c75 6d6e  t.        Column
-00025970: 2077 6865 7265 207a 6572 6f2d 706f 696e   where zero-poin
-00025980: 7420 6973 2073 6176 6564 0a0a 2020 2020  t is saved..    
-00025990: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
-000259a0: 2d2d 2d0a 2020 2020 6469 6374 0a20 2020  ---.    dict.   
-000259b0: 2020 2020 2044 6963 7469 6f6e 6172 7920       Dictionary 
-000259c0: 6f66 207a 6572 6f2d 706f 696e 7473 2028  of zero-points (
-000259d0: 6b65 7973 3a20 6669 6c74 6572 206e 616d  keys: filter nam
-000259e0: 652c 2076 616c 7565 3a20 6669 6c74 6572  e, value: filter
-000259f0: 207a 6572 6f2d 706f 696e 7429 0a20 2020   zero-point).   
-00025a00: 2022 2222 0a0a 2020 2020 6669 6c74 6572   """..    filter
-00025a10: 7320 3d20 6e70 2e67 656e 6672 6f6d 7478  s = np.genfromtx
-00025a20: 7428 6c6f 6164 5f66 696c 652c 2064 7479  t(load_file, dty
-00025a30: 7065 3d73 7472 2c20 7573 6563 6f6c 733d  pe=str, usecols=
-00025a40: 5b30 5d29 0a20 2020 205a 5073 203d 206e  [0]).    ZPs = n
-00025a50: 702e 6765 6e66 726f 6d74 7874 286c 6f61  p.genfromtxt(loa
-00025a60: 645f 6669 6c65 2c20 6474 7970 653d 666c  d_file, dtype=fl
-00025a70: 6f61 742c 2075 7365 636f 6c73 3d5b 7a70  oat, usecols=[zp
-00025a80: 5f63 6f6c 5d29 0a0a 2020 2020 7a70 5f64  _col])..    zp_d
-00025a90: 6963 7420 3d20 7b7d 0a0a 2020 2020 7472  ict = {}..    tr
-00025aa0: 793a 0a20 2020 2020 2020 2066 6f72 2069  y:.        for i
-00025ab0: 2069 6e20 7261 6e67 6528 6c65 6e28 6669   in range(len(fi
-00025ac0: 6c74 6572 7329 293a 0a20 2020 2020 2020  lters)):.       
-00025ad0: 2020 2020 207a 705f 6469 6374 5b66 696c       zp_dict[fil
-00025ae0: 7465 7273 5b69 5d5d 203d 205a 5073 5b69  ters[i]] = ZPs[i
-00025af0: 5d0a 0a20 2020 2065 7863 6570 7420 5479  ]..    except Ty
-00025b00: 7065 4572 726f 723a 0a20 2020 2020 2020  peError:.       
-00025b10: 207a 705f 6469 6374 5b73 7472 2866 696c   zp_dict[str(fil
-00025b20: 7465 7273 295d 203d 2066 6c6f 6174 285a  ters)] = float(Z
-00025b30: 5073 290a 0a20 2020 2072 6574 7572 6e20  Ps)..    return 
-00025b40: 7a70 5f64 6963 740a 0a0a 6465 6620 7a70  zp_dict...def zp
-00025b50: 5f61 6464 287a 705f 6669 6c65 5f6c 6973  _add(zp_file_lis
-00025b60: 742c 2073 6176 655f 6669 6c65 2c20 6669  t, save_file, fi
-00025b70: 6c74 6572 732c 2069 6e73 745f 7a70 3d4e  lters, inst_zp=N
-00025b80: 6f6e 6529 3a0a 2020 2020 2222 220a 2020  one):.    """.  
-00025b90: 2020 4164 6473 2074 6865 207a 6572 6f2d    Adds the zero-
-00025ba0: 706f 696e 7473 2066 6f72 2074 6865 2073  points for the s
-00025bb0: 616d 6520 6669 6c74 6572 7320 696e 206d  ame filters in m
-00025bc0: 756c 7469 706c 6520 2e7a 7020 6669 6c65  ultiple .zp file
-00025bd0: 730a 0a20 2020 2043 616e 2061 6c73 6f20  s..    Can also 
-00025be0: 6265 2075 7365 6420 746f 2063 6f6d 6269  be used to combi
-00025bf0: 6e65 206d 756c 7469 706c 6520 2e7a 7020  ne multiple .zp 
-00025c00: 6669 6c65 7320 6665 6174 7572 696e 6720  files featuring 
-00025c10: 6469 6666 6572 656e 7420 6669 6c74 6572  different filter
-00025c20: 730a 0a20 2020 2050 6172 616d 6574 6572  s..    Parameter
-00025c30: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-00025c40: 0a20 2020 207a 705f 6669 6c65 5f6c 6973  .    zp_file_lis
-00025c50: 7420 3a20 6c69 7374 0a20 2020 2020 2020  t : list.       
-00025c60: 204c 6973 7420 6f66 202e 7a70 2066 696c   List of .zp fil
-00025c70: 6573 2074 6f20 6164 640a 2020 2020 7361  es to add.    sa
-00025c80: 7665 5f66 696c 6520 3a20 7374 720a 2020  ve_file : str.  
-00025c90: 2020 2020 2020 4c6f 6361 7469 6f6e 2074        Location t
-00025ca0: 6f20 7361 7665 2074 6865 2072 6573 756c  o save the resul
-00025cb0: 7469 6e67 202e 7a70 2066 696c 650a 2020  ting .zp file.  
-00025cc0: 2020 6669 6c74 6572 7320 3a20 6c69 7374    filters : list
-00025cd0: 0a20 2020 2020 2020 204c 6973 7420 6f66  .        List of
-00025ce0: 2066 696c 7465 7273 2074 6f20 6164 6420   filters to add 
-00025cf0: 7a70 7320 616e 6420 7361 7665 2069 6e20  zps and save in 
-00025d00: 7468 6520 7361 7665 5f66 696c 650a 2020  the save_file.  
-00025d10: 2020 696e 7374 5f7a 7020 3a20 666c 6f61    inst_zp : floa
-00025d20: 740a 2020 2020 2020 2020 4120 7a65 726f  t.        A zero
-00025d30: 2d70 6f69 6e74 2076 616c 7565 2074 6f20  -point value to 
-00025d40: 6265 2061 6464 6564 2066 6f72 2061 6c6c  be added for all
-00025d50: 2066 696c 7465 7273 2e20 4465 6661 756c   filters. Defaul
-00025d60: 7420 3d20 4e6f 6e65 0a0a 2020 2020 5265  t = None..    Re
-00025d70: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00025d80: 2d0a 2020 2020 5361 7665 7320 7468 6520  -.    Saves the 
-00025d90: 7265 7375 6c74 696e 6720 2e7a 7020 6669  resulting .zp fi
-00025da0: 6c65 0a20 2020 2022 2222 0a0a 2020 2020  le.    """..    
-00025db0: 7a70 5f64 6963 745f 7375 6d20 3d20 7b7d  zp_dict_sum = {}
-00025dc0: 0a20 2020 207a 705f 6469 6374 5f6c 6973  .    zp_dict_lis
-00025dd0: 7420 3d20 5b5d 0a0a 2020 2020 666f 7220  t = []..    for 
-00025de0: 7a70 5f66 696c 6520 696e 207a 705f 6669  zp_file in zp_fi
-00025df0: 6c65 5f6c 6973 743a 0a20 2020 2020 2020  le_list:.       
-00025e00: 207a 705f 6469 6374 5f6c 6973 742e 6170   zp_dict_list.ap
-00025e10: 7065 6e64 287a 705f 7265 6164 287a 705f  pend(zp_read(zp_
-00025e20: 6669 6c65 2929 0a0a 2020 2020 666f 7220  file))..    for 
-00025e30: 6669 6c74 2069 6e20 6669 6c74 6572 733a  filt in filters:
-00025e40: 0a20 2020 2020 2020 207a 705f 7375 6d20  .        zp_sum 
-00025e50: 3d20 300a 2020 2020 2020 2020 666f 7220  = 0.        for 
-00025e60: 7a70 5f64 6963 7420 696e 207a 705f 6469  zp_dict in zp_di
-00025e70: 6374 5f6c 6973 743a 0a20 2020 2020 2020  ct_list:.       
-00025e80: 2020 2020 2069 6620 6669 6c74 2069 6e20       if filt in 
-00025e90: 7a70 5f64 6963 742e 6b65 7973 2829 3a0a  zp_dict.keys():.
-00025ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025eb0: 7a70 5f73 756d 202b 3d20 7a70 5f64 6963  zp_sum += zp_dic
-00025ec0: 745b 6669 6c74 5d0a 0a20 2020 2020 2020  t[filt]..       
-00025ed0: 207a 705f 6469 6374 5f73 756d 5b66 696c   zp_dict_sum[fil
-00025ee0: 745d 203d 207a 705f 7375 6d0a 0a20 2020  t] = zp_sum..   
-00025ef0: 2020 2020 2069 6620 696e 7374 5f7a 7020       if inst_zp 
-00025f00: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00025f10: 2020 2020 2020 2020 207a 705f 6469 6374           zp_dict
-00025f20: 5f73 756d 5b66 696c 745d 203d 207a 705f  _sum[filt] = zp_
-00025f30: 6469 6374 5f73 756d 5b66 696c 745d 202b  dict_sum[filt] +
-00025f40: 2069 6e73 745f 7a70 0a0a 2020 2020 7a70   inst_zp..    zp
-00025f50: 5f77 7269 7465 287a 705f 6469 6374 3d7a  _write(zp_dict=z
-00025f60: 705f 6469 6374 5f73 756d 2c0a 2020 2020  p_dict_sum,.    
-00025f70: 2020 2020 2020 2020 2073 6176 655f 6669           save_fi
-00025f80: 6c65 3d73 6176 655f 6669 6c65 2c0a 2020  le=save_file,.  
-00025f90: 2020 2020 2020 2020 2020 2066 696c 7465             filte
-00025fa0: 7273 5f6c 6973 743d 6669 6c74 6572 7329  rs_list=filters)
-00025fb0: 0a0a 0a64 6566 2063 616c 6962 7261 7469  ...def calibrati
-00025fc0: 6f6e 5f73 7566 6669 7828 636f 6e66 293a  on_suffix(conf):
-00025fd0: 0a20 2020 2022 2222 0a20 2020 2047 656e  .    """.    Gen
-00025fe0: 6572 6174 6573 2074 6865 2073 7566 6669  erates the suffi
-00025ff0: 7820 746f 2061 7070 6c79 2074 6f20 6120  x to apply to a 
-00026000: 6769 7665 6e20 6361 6c69 6272 6174 696f  given calibratio
-00026010: 6e20 636f 6e66 6967 7572 6174 696f 6e20  n configuration 
-00026020: 7461 6b69 6e67 0a20 2020 2069 6e74 6f20  taking.    into 
-00026030: 6163 636f 756e 7420 7468 6520 7068 6f74  account the phot
-00026040: 6f6d 6574 7279 206d 6f64 6520 616e 6420  ometry mode and 
-00026050: 7468 6520 7265 6665 7265 6e63 6520 6361  the reference ca
-00026060: 7461 6c6f 6728 7329 2075 7365 6420 666f  talog(s) used fo
-00026070: 720a 2020 2020 6361 6c69 6272 6174 696f  r.    calibratio
-00026080: 6e0a 0a20 2020 2050 6172 616d 6574 6572  n..    Parameter
-00026090: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
-000260a0: 0a20 2020 2063 6f6e 6620 3a20 6469 6374  .    conf : dict
-000260b0: 0a20 2020 2020 2020 2044 6963 7469 6f6e  .        Diction
-000260c0: 6172 7920 6c6f 6164 6564 2066 726f 6d20  ary loaded from 
-000260d0: 7468 6520 636f 6e66 6967 7572 6174 696f  the configuratio
-000260e0: 6e20 6669 6c65 0a0a 2020 2020 5265 7475  n file..    Retu
-000260f0: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
-00026100: 2020 2020 7374 720a 2020 2020 2020 2020      str.        
-00026110: 5375 6666 6978 2074 6f20 6170 706c 7920  Suffix to apply 
-00026120: 746f 2063 616c 6962 7261 7469 6f6e 2061  to calibration a
-00026130: 6e64 2063 6174 616c 6f67 7320 666f 7220  nd catalogs for 
-00026140: 6120 6769 7665 6e20 6361 6c69 6272 6174  a given calibrat
-00026150: 696f 6e0a 2020 2020 2020 2020 636f 6e66  ion.        conf
-00026160: 6967 7572 6174 696f 6e0a 2020 2020 2222  iguration.    ""
-00026170: 220a 0a20 2020 2069 6620 636f 6e66 5b27  "..    if conf['
-00026180: 6461 7461 5f72 656c 6561 7365 5f6e 616d  data_release_nam
-00026190: 6527 5d20 3d3d 2027 6944 5234 5f31 273a  e'] == 'iDR4_1':
-000261a0: 0a20 2020 2020 2020 2023 2050 686f 746f  .        # Photo
-000261b0: 6d65 7472 7920 6d6f 6465 0a20 2020 2020  metry mode.     
-000261c0: 2020 2073 7566 6669 7820 3d20 6622 7b63     suffix = f"{c
-000261d0: 6f6e 665b 2763 616c 6962 7261 7469 6f6e  onf['calibration
-000261e0: 5f70 686f 746f 6d65 7472 7927 5d7d 5f22  _photometry']}_"
-000261f0: 0a0a 2020 2020 2020 2020 2320 5265 6665  ..        # Refe
-00026200: 7265 6e63 6520 6361 7461 6c6f 6773 0a20  rence catalogs. 
-00026210: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-00026220: 7261 6e67 6528 6c65 6e28 636f 6e66 5b27  range(len(conf['
-00026230: 7265 6665 7265 6e63 655f 6361 7461 6c6f  reference_catalo
-00026240: 6727 5d29 293a 0a20 2020 2020 2020 2020  g'])):.         
-00026250: 2020 2069 6620 6920 213d 2030 3a0a 2020     if i != 0:.  
-00026260: 2020 2020 2020 2020 2020 2020 2020 7375                su
-00026270: 6666 6978 202b 3d20 272b 270a 0a20 2020  ffix += '+'..   
-00026280: 2020 2020 2020 2020 2073 7566 6669 7820           suffix 
-00026290: 2b3d 2066 227b 636f 6e66 5b27 7265 6665  += f"{conf['refe
-000262a0: 7265 6e63 655f 6361 7461 6c6f 6727 5d5b  rence_catalog'][
-000262b0: 695d 7d22 0a0a 2020 2020 2020 2020 7265  i]}"..        re
-000262c0: 7475 726e 2073 7566 6669 780a 0a20 2020  turn suffix..   
-000262d0: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
-000262e0: 6574 7572 6e20 636f 6e66 5b27 6361 6c69  eturn conf['cali
-000262f0: 6272 6174 696f 6e5f 6e61 6d65 275d 0a0a  bration_name']..
-00026300: 6465 6620 7365 645f 6669 7474 696e 6728  def sed_fitting(
-00026310: 6d6f 6465 6c73 2c20 6361 7461 6c6f 672c  models, catalog,
-00026320: 2073 6176 655f 6669 6c65 2c20 7265 665f   save_file, ref_
-00026330: 6d61 675f 636f 6c73 2c0a 2020 2020 2020  mag_cols,.      
-00026340: 2020 2020 2020 2020 2020 7072 6564 5f6d            pred_m
-00026350: 6167 5f63 6f6c 7320 3d20 4e6f 6e65 2c20  ag_cols = None, 
-00026360: 6261 7965 7369 616e 203d 2046 616c 7365  bayesian = False
-00026370: 2c20 6562 765f 6d6f 6465 203d 2046 616c  , ebv_mode = Fal
-00026380: 7365 293a 0a20 2020 2022 2222 0a0a 2020  se):.    """..  
-00026390: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-000263a0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-000263b0: 6d6f 6465 6c73 203a 2073 7472 0a20 2020  models : str.   
-000263c0: 2020 2020 204c 6f63 6174 696f 6e20 6f66       Location of
-000263d0: 2074 6865 206d 6f64 656c 2773 2066 696c   the model's fil
-000263e0: 6520 7769 7468 2073 796e 7468 6574 6963  e with synthetic
-000263f0: 2053 4544 7320 636f 6e76 6f6c 7665 6420   SEDs convolved 
-00026400: 746f 2074 6865 0a20 2020 2020 2020 2070  to the.        p
-00026410: 6970 656c 696e 6520 7375 7070 6f72 7465  ipeline supporte
-00026420: 6420 6669 6c74 6572 730a 2020 2020 6361  d filters.    ca
-00026430: 7461 6c6f 6720 3a20 7374 720a 2020 2020  talog : str.    
-00026440: 2020 2020 4c6f 6361 7469 6f6e 206f 6620      Location of 
-00026450: 7468 6520 6361 7461 6c6f 6720 7769 7468  the catalog with
-00026460: 2074 6865 2066 696c 7465 7273 2064 6174   the filters dat
-00026470: 6120 746f 2066 6974 2074 6865 2053 4544  a to fit the SED
-00026480: 730a 2020 2020 7361 7665 5f66 696c 6520  s.    save_file 
-00026490: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
-000264a0: 6361 7469 6f6e 206f 6620 7468 6520 6465  cation of the de
-000264b0: 7369 7265 6420 7361 7665 2066 696c 6520  sired save file 
-000264c0: 7768 6572 6520 6d6f 6465 6c20 7072 6564  where model pred
-000264d0: 6963 7465 6420 6d61 676e 6974 7564 6573  icted magnitudes
-000264e0: 2077 696c 6c0a 2020 2020 2020 2020 6265   will.        be
-000264f0: 2073 6176 6564 0a20 2020 2072 6566 5f6d   saved.    ref_m
-00026500: 6167 5f63 6f6c 7320 3a20 6c69 7374 0a20  ag_cols : list. 
-00026510: 2020 2020 2020 204c 6973 7420 6f66 206d         List of m
-00026520: 6167 6e69 7475 6465 7320 7573 6564 2074  agnitudes used t
-00026530: 6f20 6669 7420 7468 6520 5345 4473 0a20  o fit the SEDs. 
-00026540: 2020 2070 7265 645f 6d61 675f 636f 6c73     pred_mag_cols
-00026550: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
-00026560: 4c69 7374 206f 6620 6d61 676e 6974 7564  List of magnitud
-00026570: 6573 2070 7265 6469 6374 6564 2062 7920  es predicted by 
-00026580: 7468 6520 6669 7474 6564 2053 4544 732e  the fitted SEDs.
-00026590: 2049 6620 6e6f 6e65 2c20 7468 6520 636f   If none, the co
-000265a0: 6465 0a20 2020 2020 2020 2070 7265 6469  de.        predi
-000265b0: 6374 7320 6d61 676e 6974 7564 6573 2066  cts magnitudes f
-000265c0: 6f72 2072 6566 5f6d 6167 5f63 6f6c 7320  or ref_mag_cols 
-000265d0: 6f6e 6c79 2e0a 2020 2020 6261 7965 7369  only..    bayesi
-000265e0: 616e 203a 2062 6f6f 6c0a 2020 2020 2020  an : bool.      
-000265f0: 2020 4966 2054 7275 652c 206d 6f64 656c    If True, model
-00026600: 2073 656c 6563 7469 6f6e 2063 6f6d 6573   selection comes
-00026610: 2066 726f 6d20 6d61 7869 6d69 7a61 7469   from maximizati
-00026620: 6f6e 206f 6620 706f 7374 6572 696f 722c  on of posterior,
-00026630: 0a20 2020 2020 2020 206f 7468 6572 7769  .        otherwi
-00026640: 7365 2c20 6672 6f6d 206d 696e 696d 697a  se, from minimiz
-00026650: 6174 696f 6e20 6f66 2063 6869 320a 2020  ation of chi2.  
-00026660: 2020 6562 765f 6d6f 6465 203a 2062 6f6f    ebv_mode : boo
-00026670: 6c0a 2020 2020 2020 2020 4966 2074 7275  l.        If tru
-00026680: 652c 2074 6865 206d 6f64 6520 6461 7461  e, the mode data
-00026690: 2045 425f 5620 7769 6c6c 2062 6520 6573   EB_V will be es
-000266a0: 7469 6d61 7465 6420 616e 6420 6f6e 6c79  timated and only
-000266b0: 206d 6f64 656c 7320 7769 7468 2074 6869   models with thi
-000266c0: 730a 2020 2020 2020 2020 6578 6374 696e  s.        exctin
-000266d0: 6374 696f 6e20 7769 6c6c 2062 6520 636f  ction will be co
-000266e0: 6e73 6964 6572 6564 0a0a 2020 2020 5265  nsidered..    Re
-000266f0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00026700: 2d0a 2020 2020 5361 7665 7320 7072 6564  -.    Saves pred
-00026710: 6963 7465 6420 6d61 676e 6974 7564 6573  icted magnitudes
-00026720: 2074 6f20 7468 6520 7361 7665 5f66 696c   to the save_fil
-00026730: 6520 6c6f 6361 7469 6f6e 2e0a 2020 2020  e location..    
-00026740: 2222 220a 0a20 2020 2069 6620 6562 765f  """..    if ebv_
-00026750: 6d6f 6465 3a0a 2020 2020 2020 2020 6361  mode:.        ca
-00026760: 7461 6c6f 675f 6461 7461 203d 206c 6f61  talog_data = loa
-00026770: 645f 6461 7461 2863 6174 616c 6f67 290a  d_data(catalog).
-00026780: 2020 2020 2020 2020 6562 765f 6375 7420          ebv_cut 
-00026790: 3d20 6d6f 6465 2863 6174 616c 6f67 5f64  = mode(catalog_d
-000267a0: 6174 615b 2745 425f 5627 5d29 0a20 2020  ata['EB_V']).   
-000267b0: 2065 6c73 653a 0a20 2020 2020 2020 2065   else:.        e
-000267c0: 6276 5f63 7574 203d 204e 6f6e 650a 0a20  bv_cut = None.. 
-000267d0: 2020 2073 662e 6765 745f 6d6f 6465 6c5f     sf.get_model_
-000267e0: 6d61 6773 286d 6f64 656c 735f 6669 6c65  mags(models_file
-000267f0: 2020 203d 206d 6f64 656c 732c 0a20 2020     = models,.   
-00026800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026810: 2020 2064 6174 615f 6669 6c65 2020 2020     data_file    
-00026820: 203d 2063 6174 616c 6f67 2c0a 2020 2020   = catalog,.    
-00026830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026840: 2020 7361 7665 5f66 696c 6520 2020 2020    save_file     
-00026850: 3d20 7361 7665 5f66 696c 652c 0a20 2020  = save_file,.   
-00026860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026870: 2020 2072 6566 5f6d 6167 5f63 6f6c 7320     ref_mag_cols 
-00026880: 203d 2072 6566 5f6d 6167 5f63 6f6c 732c   = ref_mag_cols,
-00026890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000268a0: 2020 2020 2020 2070 7265 645f 6d61 675f         pred_mag_
-000268b0: 636f 6c73 203d 2070 7265 645f 6d61 675f  cols = pred_mag_
-000268c0: 636f 6c73 2c0a 2020 2020 2020 2020 2020  cols,.          
-000268d0: 2020 2020 2020 2020 2020 2020 6261 7965              baye
-000268e0: 7369 616e 2020 2020 2020 3d20 6261 7965  sian      = baye
-000268f0: 7369 616e 2c0a 2020 2020 2020 2020 2020  sian,.          
-00026900: 2020 2020 2020 2020 2020 2020 6562 765f              ebv_
-00026910: 6375 7420 2020 2020 2020 3d20 6562 765f  cut       = ebv_
-00026920: 6375 7429 0a0a 0a64 6566 2067 6574 5f66  cut)...def get_f
-00026930: 696c 7465 725f 7a65 726f 706f 696e 7428  ilter_zeropoint(
-00026940: 6f62 735f 6d61 675f 6172 7261 792c 206d  obs_mag_array, m
-00026950: 6f64 656c 5f6d 6167 5f61 7272 6179 2c20  odel_mag_array, 
-00026960: 6375 743d 2831 342c 3139 2929 3a0a 2020  cut=(14,19)):.  
-00026970: 2020 2222 220a 2020 2020 4573 7469 6d61    """.    Estima
-00026980: 7465 2074 6865 207a 6572 6f20 706f 696e  te the zero poin
-00026990: 7420 6f66 2061 2070 6172 7469 6375 6c61  t of a particula
-000269a0: 7220 6669 6c74 6572 2062 7920 636f 6d70  r filter by comp
-000269b0: 6172 696e 6720 6f62 7365 7276 6564 0a20  aring observed. 
-000269c0: 2020 206d 6167 6e69 7475 6465 7320 616e     magnitudes an
-000269d0: 6420 6d6f 6465 6c20 7072 6564 6963 7465  d model predicte
-000269e0: 6420 6d61 676e 6974 7564 6573 2e0a 0a20  d magnitudes... 
-000269f0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-00026a00: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-00026a10: 206f 6273 5f6d 6167 5f61 7272 6179 203a   obs_mag_array :
-00026a20: 206e 702e 6172 7261 790a 2020 2020 2020   np.array.      
-00026a30: 2020 6172 7261 7920 6f66 206f 6273 6572    array of obser
-00026a40: 7665 6420 7a65 726f 2d70 6f69 6e74 730a  ved zero-points.
-00026a50: 2020 2020 6d6f 6465 6c5f 6d61 675f 6172      model_mag_ar
-00026a60: 7261 7920 3a20 6e70 2e61 7272 6179 0a20  ray : np.array. 
-00026a70: 2020 2020 2020 2061 7272 6179 206f 6620         array of 
-00026a80: 6d6f 6465 6c20 7072 6564 6963 7465 6420  model predicted 
-00026a90: 7a65 726f 2d70 6f69 6e74 730a 2020 2020  zero-points.    
-00026aa0: 6375 7420 3a20 6c69 7374 0a20 2020 2020  cut : list.     
-00026ab0: 2020 2049 6e74 6572 7661 6c20 5b6d 696e     Interval [min
-00026ac0: 2c6d 6178 5d20 6f66 206d 6167 6e69 7475  ,max] of magnitu
-00026ad0: 6465 7320 746f 2062 6520 636f 6e73 6964  des to be consid
-00026ae0: 6572 6564 2066 6f72 2074 6865 2065 7374  ered for the est
-00026af0: 696d 6174 696f 6e0a 2020 2020 2020 2020  imation.        
-00026b00: 6f66 2074 6865 207a 6572 6f2d 706f 696e  of the zero-poin
-00026b10: 7473 0a0a 2020 2020 5265 7475 726e 730a  ts..    Returns.
-00026b20: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-00026b30: 666c 6f61 740a 2020 2020 2020 2020 5468  float.        Th
-00026b40: 6520 7661 6c75 6520 6f66 2074 6865 207a  e value of the z
-00026b50: 6572 6f2d 706f 696e 740a 2020 2020 2222  ero-point.    ""
-00026b60: 220a 0a20 2020 2066 203d 2028 6d6f 6465  "..    f = (mode
-00026b70: 6c5f 6d61 675f 6172 7261 7920 3e3d 2063  l_mag_array >= c
-00026b80: 7574 5b30 5d29 2026 2028 6d6f 6465 6c5f  ut[0]) & (model_
-00026b90: 6d61 675f 6172 7261 7920 3c3d 2063 7574  mag_array <= cut
-00026ba0: 5b31 5d29 0a0a 2020 2020 6465 6c74 615f  [1])..    delta_
-00026bb0: 6172 7261 7920 3d20 6d6f 6465 6c5f 6d61  array = model_ma
-00026bc0: 675f 6172 7261 795b 665d 202d 206f 6273  g_array[f] - obs
-00026bd0: 5f6d 6167 5f61 7272 6179 5b66 5d0a 0a20  _mag_array[f].. 
-00026be0: 2020 2064 656c 7461 5f61 7272 6179 203d     delta_array =
-00026bf0: 2064 656c 7461 5f61 7272 6179 2e76 616c   delta_array.val
-00026c00: 7565 732e 7265 7368 6170 6528 2d31 2c20  ues.reshape(-1, 
-00026c10: 3129 0a0a 2020 2020 6b64 655f 6465 6e73  1)..    kde_dens
-00026c20: 203d 204b 6572 6e65 6c44 656e 7369 7479   = KernelDensity
-00026c30: 286b 6572 6e65 6c3d 2767 6175 7373 6961  (kernel='gaussia
-00026c40: 6e27 2c20 6261 6e64 7769 6474 683d 302e  n', bandwidth=0.
-00026c50: 3035 292e 6669 7428 6465 6c74 615f 6172  05).fit(delta_ar
-00026c60: 7261 7929 0a0a 2020 2020 2320 5472 616e  ray)..    # Tran
-00026c70: 7366 6f72 6d20 746f 206b 6465 0a20 2020  sform to kde.   
-00026c80: 2078 203d 206e 702e 6172 616e 6765 282d   x = np.arange(-
-00026c90: 3130 2c20 3130 2c20 302e 3030 3129 0a20  10, 10, 0.001). 
-00026ca0: 2020 2079 203d 206e 702e 6578 7028 6b64     y = np.exp(kd
-00026cb0: 655f 6465 6e73 2e73 636f 7265 5f73 616d  e_dens.score_sam
-00026cc0: 706c 6573 2878 2e72 6573 6861 7065 282d  ples(x.reshape(-
-00026cd0: 312c 2031 2929 290a 0a20 2020 2023 2067  1, 1)))..    # g
-00026ce0: 6574 206d 6f64 650a 2020 2020 6d6f 6465  et mode.    mode
-00026cf0: 203d 2078 5b79 203d 3d20 6e70 2e6d 6178   = x[y == np.max
-00026d00: 2879 295d 5b30 5d0a 0a20 2020 2072 6574  (y)][0]..    ret
-00026d10: 7572 6e20 6d6f 6465 0a0a 0a64 6566 207a  urn mode...def z
-00026d20: 705f 6573 7469 6d61 7465 2863 6174 616c  p_estimate(catal
-00026d30: 6f67 2c20 7361 7665 5f66 696c 652c 2066  og, save_file, f
-00026d40: 696c 7465 7273 5f6c 6973 742c 206d 6167  ilters_list, mag
-00026d50: 5f6c 6f77 3d31 342c 206d 6167 5f75 703d  _low=14, mag_up=
-00026d60: 3139 2c0a 2020 2020 2020 2020 2020 2020  19,.            
-00026d70: 2020 2020 6d61 675f 6375 7420 3d20 4e6f      mag_cut = No
-00026d80: 6e65 293a 0a20 2020 2022 2222 0a20 2020  ne):.    """.   
-00026d90: 204f 6274 6169 6e20 7a65 726f 2d70 6f69   Obtain zero-poi
-00026da0: 6e74 7320 666f 7220 6120 6769 7665 6e20  nts for a given 
-00026db0: 6361 7461 6c6f 6720 6279 2063 6f6d 7061  catalog by compa
-00026dc0: 7269 6e67 2074 6865 206f 6273 6572 7665  ring the observe
-00026dd0: 6420 616e 6420 6d6f 6465 6c0a 2020 2020  d and model.    
-00026de0: 7072 6564 6963 7465 6420 6d61 676e 6974  predicted magnit
-00026df0: 7564 6573 2069 6e20 7468 6973 2063 6174  udes in this cat
-00026e00: 616c 6f67 2e20 496e 7075 7420 6361 7461  alog. Input cata
-00026e10: 6c6f 6720 6d75 7374 2062 6520 7468 6520  log must be the 
-00026e20: 6f75 7470 7574 206f 660a 2020 2020 7365  output of.    se
-00026e30: 645f 6669 7474 696e 672e 6765 745f 6d6f  d_fitting.get_mo
-00026e40: 6465 6c5f 6d61 6773 0a0a 2020 2020 5061  del_mags..    Pa
-00026e50: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-00026e60: 2d2d 2d2d 2d2d 2d0a 0a20 2020 2063 6174  -------..    cat
-00026e70: 616c 6f67 203a 2073 7472 0a20 2020 2020  alog : str.     
-00026e80: 2020 204c 6f63 6174 696f 6e20 6f66 2074     Location of t
-00026e90: 6865 2069 6e70 7574 2063 6174 616c 6f67  he input catalog
-00026ea0: 2e20 4d75 7374 2062 6520 7468 6520 6f75  . Must be the ou
-00026eb0: 7470 7574 0a20 2020 2020 2020 206f 6620  tput.        of 
-00026ec0: 7365 645f 6669 7474 696e 672e 6765 745f  sed_fitting.get_
-00026ed0: 6d6f 6465 6c5f 6d61 6773 0a20 2020 2073  model_mags.    s
-00026ee0: 6176 655f 6669 6c65 203a 2073 7472 0a20  ave_file : str. 
-00026ef0: 2020 2020 2020 204c 6f63 6174 696f 6e20         Location 
-00026f00: 746f 2073 6176 6520 7468 6520 6573 7469  to save the esti
-00026f10: 6d61 7465 6420 7a65 726f 2d70 6f69 6e74  mated zero-point
-00026f20: 730a 2020 2020 6669 6c74 6572 735f 6c69  s.    filters_li
-00026f30: 7374 203a 206c 6973 740a 2020 2020 2020  st : list.      
-00026f40: 2020 4c69 7374 206f 6620 6669 6c74 6572    List of filter
-00026f50: 7320 746f 2065 7374 696d 6174 6520 7468  s to estimate th
-00026f60: 6520 7a65 726f 2d70 6f69 6e74 730a 2020  e zero-points.  
-00026f70: 2020 6d61 675f 6375 7420 3a20 6c69 7374    mag_cut : list
-00026f80: 205b 6f62 736f 6c65 7465 5d0a 2020 2020   [obsolete].    
-00026f90: 2020 2020 496e 7465 7276 616c 205b 6d69      Interval [mi
-00026fa0: 6e2c 6d61 785d 206f 6620 6d61 676e 6974  n,max] of magnit
-00026fb0: 7564 6573 2074 6f20 6265 2063 6f6e 7369  udes to be consi
-00026fc0: 6465 7265 6420 666f 7220 7468 6520 6573  dered for the es
-00026fd0: 7469 6d61 7469 6f6e 0a20 2020 2020 2020  timation.       
-00026fe0: 206f 6620 7468 6520 7a65 726f 2d70 6f69   of the zero-poi
-00026ff0: 6e74 730a 2020 2020 6d61 675f 7570 203a  nts.    mag_up :
-00027000: 206c 6973 740a 2020 2020 2020 2020 4c69   list.        Li
-00027010: 7374 206f 6620 7570 7065 7220 6c69 6d69  st of upper limi
-00027020: 7473 2066 6f72 2074 6865 206d 6167 6e69  ts for the magni
-00027030: 7475 6465 7320 746f 2062 6520 636f 6e73  tudes to be cons
-00027040: 6964 6572 6564 2066 6f72 2074 6865 0a20  idered for the. 
-00027050: 2020 2020 2020 2065 7374 696d 6174 696f         estimatio
-00027060: 6e20 6f66 2074 6865 207a 6572 6f2d 706f  n of the zero-po
-00027070: 696e 7473 2c20 666f 7220 6561 6368 2066  ints, for each f
-00027080: 696c 7465 7220 696e 2066 696c 7465 7273  ilter in filters
-00027090: 5f6c 6973 740a 2020 2020 6d61 675f 6c6f  _list.    mag_lo
-000270a0: 7720 3a20 6c69 7374 0a20 2020 2020 2020  w : list.       
-000270b0: 204c 6973 7420 6f66 206c 6f77 6572 206c   List of lower l
-000270c0: 696d 6974 7320 666f 7220 7468 6520 6d61  imits for the ma
-000270d0: 676e 6974 7564 6573 2074 6f20 6265 2063  gnitudes to be c
-000270e0: 6f6e 7369 6465 7265 6420 666f 7220 7468  onsidered for th
-000270f0: 650a 2020 2020 2020 2020 6573 7469 6d61  e.        estima
-00027100: 7469 6f6e 206f 6620 7468 6520 7a65 726f  tion of the zero
-00027110: 2d70 6f69 6e74 732c 2066 6f72 2065 6163  -points, for eac
-00027120: 6820 6669 6c74 6572 2069 6e20 6669 6c74  h filter in filt
-00027130: 6572 735f 6c69 7374 0a0a 2020 2020 5265  ers_list..    Re
-00027140: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00027150: 2d0a 2020 2020 5361 7665 7320 7468 6520  -.    Saves the 
-00027160: 7a65 726f 2d70 6f69 6e74 7320 696e 2061  zero-points in a
-00027170: 202e 7a70 2066 696c 650a 2020 2020 2222   .zp file.    ""
-00027180: 220a 0a20 2020 2064 6174 6120 3d20 6c6f  "..    data = lo
-00027190: 6164 5f64 6174 6128 6361 7461 6c6f 6729  ad_data(catalog)
-000271a0: 0a20 2020 2070 7269 6e74 2822 5c6e 5c6e  .    print("\n\n
-000271b0: 5374 6172 7469 6e67 2074 6f20 6170 706c  Starting to appl
-000271c0: 7920 5a65 726f 506f 696e 7473 5c6e 5c6e  y ZeroPoints\n\n
-000271d0: 2229 0a0a 2020 2020 7072 696e 7428 224f  ")..    print("O
-000271e0: 6274 6169 6e69 6e67 207a 6572 6f20 706f  btaining zero po
-000271f0: 696e 7420 666f 7220 6d61 676e 6974 7564  int for magnitud
-00027200: 6573 3a22 290a 2020 2020 7072 696e 7428  es:").    print(
-00027210: 6669 6c74 6572 735f 6c69 7374 290a 0a20  filters_list).. 
-00027220: 2020 2070 7269 6e74 2822 5573 696e 6720     print("Using 
-00027230: 7b30 7d20 7374 6172 7320 746f 2065 7374  {0} stars to est
-00027240: 696d 6174 6520 5a50 7322 2e66 6f72 6d61  imate ZPs".forma
-00027250: 7428 6461 7461 2e73 6861 7065 5b30 5d29  t(data.shape[0])
-00027260: 290a 0a20 2020 2023 2055 7365 206d 6167  )..    # Use mag
-00027270: 5f63 7574 2c20 666f 7220 7265 7472 6f63  _cut, for retroc
-00027280: 6f6d 7061 7469 6269 6c69 7479 0a20 2020  ompatibility.   
-00027290: 2069 6620 6d61 675f 6375 7420 6973 206e   if mag_cut is n
-000272a0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-000272b0: 206d 6167 5f6c 6f77 203d 206d 6167 5f63   mag_low = mag_c
-000272c0: 7574 5b30 5d0a 2020 2020 2020 2020 6d61  ut[0].        ma
-000272d0: 675f 7570 203d 206d 6167 5f63 7574 5b31  g_up = mag_cut[1
-000272e0: 5d0a 0a20 2020 2023 2043 7265 6174 6520  ]..    # Create 
-000272f0: 6d61 675f 6c6f 7720 616e 6420 6d61 675f  mag_low and mag_
-00027300: 7570 206c 6973 7420 6966 206e 6563 6573  up list if neces
-00027310: 7361 7279 0a20 2020 2069 6620 6973 696e  sary.    if isin
-00027320: 7374 616e 6365 286d 6167 5f6c 6f77 2c20  stance(mag_low, 
-00027330: 666c 6f61 7429 3a0a 2020 2020 2020 2020  float):.        
-00027340: 6d61 675f 6c6f 7720 3d20 5b6d 6167 5f6c  mag_low = [mag_l
-00027350: 6f77 5d2a 6c65 6e28 6669 6c74 6572 735f  ow]*len(filters_
-00027360: 6c69 7374 290a 2020 2020 6966 2069 7369  list).    if isi
-00027370: 6e73 7461 6e63 6528 6d61 675f 6c6f 772c  nstance(mag_low,
-00027380: 206c 6973 7429 3a0a 2020 2020 2020 2020   list):.        
-00027390: 6966 206c 656e 286d 6167 5f6c 6f77 2920  if len(mag_low) 
-000273a0: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
-000273b0: 2020 6d61 675f 6c6f 7720 3d20 5b6d 6167    mag_low = [mag
-000273c0: 5f6c 6f77 5b30 5d5d 2a6c 656e 2866 696c  _low[0]]*len(fil
-000273d0: 7465 7273 5f6c 6973 7429 0a0a 2020 2020  ters_list)..    
-000273e0: 6966 2069 7369 6e73 7461 6e63 6528 6d61  if isinstance(ma
-000273f0: 675f 7570 2c20 666c 6f61 7429 3a0a 2020  g_up, float):.  
-00027400: 2020 2020 2020 6d61 675f 7570 203d 205b        mag_up = [
-00027410: 6d61 675f 7570 5d2a 6c65 6e28 6669 6c74  mag_up]*len(filt
-00027420: 6572 735f 6c69 7374 290a 2020 2020 6966  ers_list).    if
-00027430: 2069 7369 6e73 7461 6e63 6528 6d61 675f   isinstance(mag_
-00027440: 7570 2c20 6c69 7374 293a 0a20 2020 2020  up, list):.     
-00027450: 2020 2069 6620 6c65 6e28 6d61 675f 7570     if len(mag_up
-00027460: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
-00027470: 2020 2020 6d61 675f 6c6f 7720 3d20 5b6d      mag_low = [m
-00027480: 6167 5f75 705b 305d 5d2a 6c65 6e28 6669  ag_up[0]]*len(fi
-00027490: 6c74 6572 735f 6c69 7374 290a 0a20 2020  lters_list)..   
-000274a0: 2023 2045 7374 696d 6174 696e 6720 616e   # Estimating an
-000274b0: 6420 6170 706c 7969 6e67 205a 500a 2020  d applying ZP.  
-000274c0: 2020 7a70 5f64 6963 7420 3d20 7b7d 0a0a    zp_dict = {}..
-000274d0: 2020 2020 666f 7220 6669 6c74 2c20 6d61      for filt, ma
-000274e0: 675f 6c2c 206d 6167 5f75 2069 6e20 7a69  g_l, mag_u in zi
-000274f0: 7028 6669 6c74 6572 735f 6c69 7374 2c20  p(filters_list, 
-00027500: 6d61 675f 6c6f 772c 206d 6167 5f75 7029  mag_low, mag_up)
-00027510: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
-00027520: 225c 6e45 7374 696d 6174 696e 6720 5a50  "\nEstimating ZP
-00027530: 2066 6f72 206d 6167 207b 307d 222e 666f   for mag {0}".fo
-00027540: 726d 6174 2866 696c 7429 290a 0a20 2020  rmat(filt))..   
-00027550: 2020 2020 2023 2043 7574 206c 6f67 670a       # Cut logg.
-00027560: 2020 2020 2020 2020 6477 6172 6673 203d          dwarfs =
-00027570: 2064 6174 612e 6c6f 635b 3a2c 2027 6c6f   data.loc[:, 'lo
-00027580: 6767 275d 2e76 616c 7565 7320 3e20 330a  gg'].values > 3.
-00027590: 0a20 2020 2020 2020 206f 6273 5f6d 6167  .        obs_mag
-000275a0: 5f61 7272 6179 203d 2064 6174 612e 6c6f  _array = data.lo
-000275b0: 635b 6477 6172 6673 2c20 6622 7b66 696c  c[dwarfs, f"{fil
-000275c0: 747d 225d 0a20 2020 2020 2020 206d 6f64  t}"].        mod
-000275d0: 5f6d 6167 5f61 7272 6179 203d 2064 6174  _mag_array = dat
-000275e0: 612e 6c6f 635b 6477 6172 6673 2c20 6622  a.loc[dwarfs, f"
-000275f0: 7b66 696c 747d 5f6d 6f64 225d 0a0a 2020  {filt}_mod"]..  
-00027600: 2020 2020 2020 6669 6c74 5f7a 7020 3d20        filt_zp = 
-00027610: 6765 745f 6669 6c74 6572 5f7a 6572 6f70  get_filter_zerop
-00027620: 6f69 6e74 286f 6273 5f6d 6167 5f61 7272  oint(obs_mag_arr
-00027630: 6179 3d6f 6273 5f6d 6167 5f61 7272 6179  ay=obs_mag_array
-00027640: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00025300: 2020 2020 2020 2020 2020 2020 2020 2a2a                **
+00025310: 6b77 6172 6773 290a 0a20 2020 2065 6c69  kwargs)..    eli
+00025320: 6620 636f 7272 6563 7469 6f6e 2e6c 6f77  f correction.low
+00025330: 6572 2829 203d 3d20 2767 6169 6164 7233  er() == 'gaiadr3
+00025340: 273a 0a20 2020 2020 2020 2063 6f72 7265  ':.        corre
+00025350: 6374 5f65 7874 696e 6374 696f 6e5f 6761  ct_extinction_ga
+00025360: 6961 6472 3328 6361 7461 6c6f 673d 6361  iadr3(catalog=ca
+00025370: 7461 6c6f 672c 2073 6176 655f 6669 6c65  talog, save_file
+00025380: 3d73 6176 655f 6669 6c65 2c0a 2020 2020  =save_file,.    
+00025390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000253a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000253b0: 696c 7465 7273 5f41 6c61 6d62 6461 5f41  ilters_Alambda_A
+000253c0: 763d 6669 6c74 6572 735f 416c 616d 6264  v=filters_Alambd
+000253d0: 615f 4176 2c0a 2020 2020 2020 2020 2020  a_Av,.          
+000253e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000253f0: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+00025400: 7329 0a20 2020 200a 2020 2020 656c 7365  s).    .    else
+00025410: 3a0a 2020 2020 2020 2020 7261 6973 6520  :.        raise 
+00025420: 5661 6c75 6545 7272 6f72 2866 2245 7874  ValueError(f"Ext
+00025430: 696e 6374 696f 6e20 7b63 6f72 7265 6374  inction {correct
+00025440: 696f 6e7d 2069 7320 6e6f 7420 7375 7070  ion} is not supp
+00025450: 6f72 7465 642e 2229 0a0a 2323 2323 2323  orted.")..######
+00025460: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00025470: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00025480: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00025490: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000254a0: 2323 2323 2323 2323 2323 0a23 2043 616c  ##########.# Cal
+000254b0: 6962 7261 7469 6f6e 0a0a 2320 5c74 6f64  ibration..# \tod
+000254c0: 6f20 4144 4420 756e 6365 7274 6169 6e74  o ADD uncertaint
+000254d0: 7920 6573 7469 6d61 7469 6f6e 2074 6f20  y estimation to 
+000254e0: 7468 6520 5345 4420 6669 7474 6564 207a  the SED fitted z
+000254f0: 6572 6f2d 706f 696e 7473 0a0a 0a64 6566  ero-points...def
+00025500: 207a 705f 7772 6974 6528 7a70 5f64 6963   zp_write(zp_dic
+00025510: 742c 2073 6176 655f 6669 6c65 2c20 6669  t, save_file, fi
+00025520: 6c74 6572 735f 6c69 7374 3d4e 6f6e 6529  lters_list=None)
+00025530: 3a0a 2020 2020 2222 220a 2020 2020 7772  :.    """.    wr
+00025540: 6974 6573 2061 202e 7a70 2066 696c 650a  ites a .zp file.
+00025550: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+00025560: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00025570: 2020 207a 705f 6469 6374 203a 2064 6963     zp_dict : dic
+00025580: 740a 2020 2020 2020 2020 4469 6374 696f  t.        Dictio
+00025590: 6e61 7279 206f 6620 7a65 726f 2070 6f69  nary of zero poi
+000255a0: 6e74 7320 286b 6579 733a 2066 696c 7465  nts (keys: filte
+000255b0: 7220 6e61 6d65 2c20 7661 6c75 653a 2066  r name, value: f
+000255c0: 696c 7465 7220 7a65 726f 2d70 6f69 6e74  ilter zero-point
+000255d0: 290a 2020 2020 7361 7665 5f66 696c 6520  ).    save_file 
+000255e0: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
+000255f0: 6361 7469 6f6e 2074 6f20 7361 7665 2074  cation to save t
+00025600: 6865 207a 7020 6669 6c65 0a20 2020 2066  he zp file.    f
+00025610: 696c 7465 7273 5f6c 6973 7420 3a20 6c69  ilters_list : li
+00025620: 7374 0a20 2020 2020 2020 204c 6973 7420  st.        List 
+00025630: 6f66 2066 696c 7465 7273 2074 6f20 7361  of filters to sa
+00025640: 7665 207a 6572 6f2d 706f 696e 7473 2e20  ve zero-points. 
+00025650: 4966 204e 6f6e 652c 2061 6c6c 2066 696c  If None, all fil
+00025660: 7465 7273 2069 6e20 7a70 5f64 6963 7420  ters in zp_dict 
+00025670: 6172 650a 2020 2020 2020 2020 7361 7665  are.        save
+00025680: 640a 0a20 2020 2052 6574 7572 6e73 0a20  d..    Returns. 
+00025690: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2053     -------.    S
+000256a0: 6176 6573 2061 207a 7020 6669 6c65 0a20  aves a zp file. 
+000256b0: 2020 2022 2222 0a0a 2020 2020 7072 696e     """..    prin
+000256c0: 7428 275c 6e53 6176 696e 6720 7265 7375  t('\nSaving resu
+000256d0: 6c74 7320 746f 2066 696c 6520 2573 2720  lts to file %s' 
+000256e0: 2520 7361 7665 5f66 696c 6529 0a0a 2020  % save_file)..  
+000256f0: 2020 6966 2066 696c 7465 7273 5f6c 6973    if filters_lis
+00025700: 7420 6973 204e 6f6e 653a 0a20 2020 2020  t is None:.     
+00025710: 2020 2066 696c 7465 7273 5f6c 6973 7420     filters_list 
+00025720: 3d20 7a70 5f64 6963 742e 6b65 7973 2829  = zp_dict.keys()
+00025730: 0a0a 2020 2020 7769 7468 206f 7065 6e28  ..    with open(
+00025740: 7361 7665 5f66 696c 652c 2027 7727 2920  save_file, 'w') 
+00025750: 6173 2066 3a0a 0a20 2020 2020 2020 2069  as f:..        i
+00025760: 6620 7479 7065 2866 696c 7465 7273 5f6c  f type(filters_l
+00025770: 6973 7429 2069 7320 7374 723a 0a20 2020  ist) is str:.   
+00025780: 2020 2020 2020 2020 2066 2e77 7269 7465           f.write
+00025790: 2822 7b3a 737d 207b 3a2e 3566 7d5c 6e22  ("{:s} {:.5f}\n"
+000257a0: 2e66 6f72 6d61 7428 6669 6c74 6572 735f  .format(filters_
+000257b0: 6c69 7374 2c20 7a70 5f64 6963 745b 6669  list, zp_dict[fi
+000257c0: 6c74 6572 735f 6c69 7374 5d29 290a 0a20  lters_list])).. 
+000257d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000257e0: 2020 2020 2020 2020 2066 6f72 2066 696c           for fil
+000257f0: 7420 696e 2066 696c 7465 7273 5f6c 6973  t in filters_lis
+00025800: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00025810: 2020 2066 2e77 7269 7465 2822 7b3a 737d     f.write("{:s}
+00025820: 207b 3a2e 3566 7d5c 6e22 2e66 6f72 6d61   {:.5f}\n".forma
+00025830: 7428 6669 6c74 2c20 7a70 5f64 6963 745b  t(filt, zp_dict[
+00025840: 6669 6c74 5d29 290a 0a20 2020 2070 7269  filt]))..    pri
+00025850: 6e74 2827 5265 7375 6c74 7320 6172 6520  nt('Results are 
+00025860: 7361 7665 6420 696e 2066 696c 6520 2573  saved in file %s
+00025870: 2720 2520 7361 7665 5f66 696c 6529 0a0a  ' % save_file)..
+00025880: 0a64 6566 207a 705f 7265 6164 286c 6f61  .def zp_read(loa
+00025890: 645f 6669 6c65 2c20 7a70 5f63 6f6c 203d  d_file, zp_col =
+000258a0: 2031 293a 0a20 2020 2022 2222 0a20 2020   1):.    """.   
+000258b0: 2052 6561 6473 2061 202e 7a70 2066 696c   Reads a .zp fil
+000258c0: 650a 2020 2020 5061 7261 6d65 7465 7273  e.    Parameters
+000258d0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+000258e0: 2020 2020 6c6f 6164 5f66 696c 6520 3a20      load_file : 
+000258f0: 7374 720a 2020 2020 2020 2020 4c6f 6361  str.        Loca
+00025900: 7469 6f6e 206f 6620 7468 6520 2e7a 7020  tion of the .zp 
+00025910: 6669 6c65 0a20 2020 207a 705f 636f 6c20  file.    zp_col 
+00025920: 3a20 696e 740a 2020 2020 2020 2020 436f  : int.        Co
+00025930: 6c75 6d6e 2077 6865 7265 207a 6572 6f2d  lumn where zero-
+00025940: 706f 696e 7420 6973 2073 6176 6564 0a0a  point is saved..
+00025950: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00025960: 2d2d 2d2d 2d2d 2d0a 2020 2020 6469 6374  -------.    dict
+00025970: 0a20 2020 2020 2020 2044 6963 7469 6f6e  .        Diction
+00025980: 6172 7920 6f66 207a 6572 6f2d 706f 696e  ary of zero-poin
+00025990: 7473 2028 6b65 7973 3a20 6669 6c74 6572  ts (keys: filter
+000259a0: 206e 616d 652c 2076 616c 7565 3a20 6669   name, value: fi
+000259b0: 6c74 6572 207a 6572 6f2d 706f 696e 7429  lter zero-point)
+000259c0: 0a20 2020 2022 2222 0a0a 2020 2020 6669  .    """..    fi
+000259d0: 6c74 6572 7320 3d20 6e70 2e67 656e 6672  lters = np.genfr
+000259e0: 6f6d 7478 7428 6c6f 6164 5f66 696c 652c  omtxt(load_file,
+000259f0: 2064 7479 7065 3d73 7472 2c20 7573 6563   dtype=str, usec
+00025a00: 6f6c 733d 5b30 5d29 0a20 2020 205a 5073  ols=[0]).    ZPs
+00025a10: 203d 206e 702e 6765 6e66 726f 6d74 7874   = np.genfromtxt
+00025a20: 286c 6f61 645f 6669 6c65 2c20 6474 7970  (load_file, dtyp
+00025a30: 653d 666c 6f61 742c 2075 7365 636f 6c73  e=float, usecols
+00025a40: 3d5b 7a70 5f63 6f6c 5d29 0a0a 2020 2020  =[zp_col])..    
+00025a50: 7a70 5f64 6963 7420 3d20 7b7d 0a0a 2020  zp_dict = {}..  
+00025a60: 2020 7472 793a 0a20 2020 2020 2020 2066    try:.        f
+00025a70: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
+00025a80: 6e28 6669 6c74 6572 7329 293a 0a20 2020  n(filters)):.   
+00025a90: 2020 2020 2020 2020 207a 705f 6469 6374           zp_dict
+00025aa0: 5b66 696c 7465 7273 5b69 5d5d 203d 205a  [filters[i]] = Z
+00025ab0: 5073 5b69 5d0a 0a20 2020 2065 7863 6570  Ps[i]..    excep
+00025ac0: 7420 5479 7065 4572 726f 723a 0a20 2020  t TypeError:.   
+00025ad0: 2020 2020 207a 705f 6469 6374 5b73 7472       zp_dict[str
+00025ae0: 2866 696c 7465 7273 295d 203d 2066 6c6f  (filters)] = flo
+00025af0: 6174 285a 5073 290a 0a20 2020 2072 6574  at(ZPs)..    ret
+00025b00: 7572 6e20 7a70 5f64 6963 740a 0a0a 6465  urn zp_dict...de
+00025b10: 6620 7a70 5f61 6464 287a 705f 6669 6c65  f zp_add(zp_file
+00025b20: 5f6c 6973 742c 2073 6176 655f 6669 6c65  _list, save_file
+00025b30: 2c20 6669 6c74 6572 732c 2069 6e73 745f  , filters, inst_
+00025b40: 7a70 3d4e 6f6e 6529 3a0a 2020 2020 2222  zp=None):.    ""
+00025b50: 220a 2020 2020 4164 6473 2074 6865 207a  ".    Adds the z
+00025b60: 6572 6f2d 706f 696e 7473 2066 6f72 2074  ero-points for t
+00025b70: 6865 2073 616d 6520 6669 6c74 6572 7320  he same filters 
+00025b80: 696e 206d 756c 7469 706c 6520 2e7a 7020  in multiple .zp 
+00025b90: 6669 6c65 730a 0a20 2020 2043 616e 2061  files..    Can a
+00025ba0: 6c73 6f20 6265 2075 7365 6420 746f 2063  lso be used to c
+00025bb0: 6f6d 6269 6e65 206d 756c 7469 706c 6520  ombine multiple 
+00025bc0: 2e7a 7020 6669 6c65 7320 6665 6174 7572  .zp files featur
+00025bd0: 696e 6720 6469 6666 6572 656e 7420 6669  ing different fi
+00025be0: 6c74 6572 730a 0a20 2020 2050 6172 616d  lters..    Param
+00025bf0: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
+00025c00: 2d2d 2d2d 0a20 2020 207a 705f 6669 6c65  ----.    zp_file
+00025c10: 5f6c 6973 7420 3a20 6c69 7374 0a20 2020  _list : list.   
+00025c20: 2020 2020 204c 6973 7420 6f66 202e 7a70       List of .zp
+00025c30: 2066 696c 6573 2074 6f20 6164 640a 2020   files to add.  
+00025c40: 2020 7361 7665 5f66 696c 6520 3a20 7374    save_file : st
+00025c50: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
+00025c60: 6f6e 2074 6f20 7361 7665 2074 6865 2072  on to save the r
+00025c70: 6573 756c 7469 6e67 202e 7a70 2066 696c  esulting .zp fil
+00025c80: 650a 2020 2020 6669 6c74 6572 7320 3a20  e.    filters : 
+00025c90: 6c69 7374 0a20 2020 2020 2020 204c 6973  list.        Lis
+00025ca0: 7420 6f66 2066 696c 7465 7273 2074 6f20  t of filters to 
+00025cb0: 6164 6420 7a70 7320 616e 6420 7361 7665  add zps and save
+00025cc0: 2069 6e20 7468 6520 7361 7665 5f66 696c   in the save_fil
+00025cd0: 650a 2020 2020 696e 7374 5f7a 7020 3a20  e.    inst_zp : 
+00025ce0: 666c 6f61 740a 2020 2020 2020 2020 4120  float.        A 
+00025cf0: 7a65 726f 2d70 6f69 6e74 2076 616c 7565  zero-point value
+00025d00: 2074 6f20 6265 2061 6464 6564 2066 6f72   to be added for
+00025d10: 2061 6c6c 2066 696c 7465 7273 2e20 4465   all filters. De
+00025d20: 6661 756c 7420 3d20 4e6f 6e65 0a0a 2020  fault = None..  
+00025d30: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+00025d40: 2d2d 2d2d 2d0a 2020 2020 5361 7665 7320  -----.    Saves 
+00025d50: 7468 6520 7265 7375 6c74 696e 6720 2e7a  the resulting .z
+00025d60: 7020 6669 6c65 0a20 2020 2022 2222 0a0a  p file.    """..
+00025d70: 2020 2020 7a70 5f64 6963 745f 7375 6d20      zp_dict_sum 
+00025d80: 3d20 7b7d 0a20 2020 207a 705f 6469 6374  = {}.    zp_dict
+00025d90: 5f6c 6973 7420 3d20 5b5d 0a0a 2020 2020  _list = []..    
+00025da0: 666f 7220 7a70 5f66 696c 6520 696e 207a  for zp_file in z
+00025db0: 705f 6669 6c65 5f6c 6973 743a 0a20 2020  p_file_list:.   
+00025dc0: 2020 2020 207a 705f 6469 6374 5f6c 6973       zp_dict_lis
+00025dd0: 742e 6170 7065 6e64 287a 705f 7265 6164  t.append(zp_read
+00025de0: 287a 705f 6669 6c65 2929 0a0a 2020 2020  (zp_file))..    
+00025df0: 666f 7220 6669 6c74 2069 6e20 6669 6c74  for filt in filt
+00025e00: 6572 733a 0a20 2020 2020 2020 207a 705f  ers:.        zp_
+00025e10: 7375 6d20 3d20 300a 2020 2020 2020 2020  sum = 0.        
+00025e20: 666f 7220 7a70 5f64 6963 7420 696e 207a  for zp_dict in z
+00025e30: 705f 6469 6374 5f6c 6973 743a 0a20 2020  p_dict_list:.   
+00025e40: 2020 2020 2020 2020 2069 6620 6669 6c74           if filt
+00025e50: 2069 6e20 7a70 5f64 6963 742e 6b65 7973   in zp_dict.keys
+00025e60: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00025e70: 2020 2020 7a70 5f73 756d 202b 3d20 7a70      zp_sum += zp
+00025e80: 5f64 6963 745b 6669 6c74 5d0a 0a20 2020  _dict[filt]..   
+00025e90: 2020 2020 207a 705f 6469 6374 5f73 756d       zp_dict_sum
+00025ea0: 5b66 696c 745d 203d 207a 705f 7375 6d0a  [filt] = zp_sum.
+00025eb0: 0a20 2020 2020 2020 2069 6620 696e 7374  .        if inst
+00025ec0: 5f7a 7020 6973 206e 6f74 204e 6f6e 653a  _zp is not None:
+00025ed0: 0a20 2020 2020 2020 2020 2020 207a 705f  .            zp_
+00025ee0: 6469 6374 5f73 756d 5b66 696c 745d 203d  dict_sum[filt] =
+00025ef0: 207a 705f 6469 6374 5f73 756d 5b66 696c   zp_dict_sum[fil
+00025f00: 745d 202b 2069 6e73 745f 7a70 0a0a 2020  t] + inst_zp..  
+00025f10: 2020 7a70 5f77 7269 7465 287a 705f 6469    zp_write(zp_di
+00025f20: 6374 3d7a 705f 6469 6374 5f73 756d 2c0a  ct=zp_dict_sum,.
+00025f30: 2020 2020 2020 2020 2020 2020 2073 6176               sav
+00025f40: 655f 6669 6c65 3d73 6176 655f 6669 6c65  e_file=save_file
+00025f50: 2c0a 2020 2020 2020 2020 2020 2020 2066  ,.             f
+00025f60: 696c 7465 7273 5f6c 6973 743d 6669 6c74  ilters_list=filt
+00025f70: 6572 7329 0a0a 0a64 6566 2063 616c 6962  ers)...def calib
+00025f80: 7261 7469 6f6e 5f73 7566 6669 7828 636f  ration_suffix(co
+00025f90: 6e66 293a 0a20 2020 2022 2222 0a20 2020  nf):.    """.   
+00025fa0: 2047 656e 6572 6174 6573 2074 6865 2073   Generates the s
+00025fb0: 7566 6669 7820 746f 2061 7070 6c79 2074  uffix to apply t
+00025fc0: 6f20 6120 6769 7665 6e20 6361 6c69 6272  o a given calibr
+00025fd0: 6174 696f 6e20 636f 6e66 6967 7572 6174  ation configurat
+00025fe0: 696f 6e20 7461 6b69 6e67 0a20 2020 2069  ion taking.    i
+00025ff0: 6e74 6f20 6163 636f 756e 7420 7468 6520  nto account the 
+00026000: 7068 6f74 6f6d 6574 7279 206d 6f64 6520  photometry mode 
+00026010: 616e 6420 7468 6520 7265 6665 7265 6e63  and the referenc
+00026020: 6520 6361 7461 6c6f 6728 7329 2075 7365  e catalog(s) use
+00026030: 6420 666f 720a 2020 2020 6361 6c69 6272  d for.    calibr
+00026040: 6174 696f 6e0a 0a20 2020 2050 6172 616d  ation..    Param
+00026050: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
+00026060: 2d2d 2d2d 0a20 2020 2063 6f6e 6620 3a20  ----.    conf : 
+00026070: 6469 6374 0a20 2020 2020 2020 2044 6963  dict.        Dic
+00026080: 7469 6f6e 6172 7920 6c6f 6164 6564 2066  tionary loaded f
+00026090: 726f 6d20 7468 6520 636f 6e66 6967 7572  rom the configur
+000260a0: 6174 696f 6e20 6669 6c65 0a0a 2020 2020  ation file..    
+000260b0: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
+000260c0: 2d2d 2d0a 2020 2020 7374 720a 2020 2020  ---.    str.    
+000260d0: 2020 2020 5375 6666 6978 2074 6f20 6170      Suffix to ap
+000260e0: 706c 7920 746f 2063 616c 6962 7261 7469  ply to calibrati
+000260f0: 6f6e 2061 6e64 2063 6174 616c 6f67 7320  on and catalogs 
+00026100: 666f 7220 6120 6769 7665 6e20 6361 6c69  for a given cali
+00026110: 6272 6174 696f 6e0a 2020 2020 2020 2020  bration.        
+00026120: 636f 6e66 6967 7572 6174 696f 6e0a 2020  configuration.  
+00026130: 2020 2222 220a 0a20 2020 2069 6620 636f    """..    if co
+00026140: 6e66 5b27 6461 7461 5f72 656c 6561 7365  nf['data_release
+00026150: 5f6e 616d 6527 5d20 3d3d 2027 6944 5234  _name'] == 'iDR4
+00026160: 5f31 273a 0a20 2020 2020 2020 2023 2050  _1':.        # P
+00026170: 686f 746f 6d65 7472 7920 6d6f 6465 0a20  hotometry mode. 
+00026180: 2020 2020 2020 2073 7566 6669 7820 3d20         suffix = 
+00026190: 6622 7b63 6f6e 665b 2763 616c 6962 7261  f"{conf['calibra
+000261a0: 7469 6f6e 5f70 686f 746f 6d65 7472 7927  tion_photometry'
+000261b0: 5d7d 5f22 0a0a 2020 2020 2020 2020 2320  ]}_"..        # 
+000261c0: 5265 6665 7265 6e63 6520 6361 7461 6c6f  Reference catalo
+000261d0: 6773 0a20 2020 2020 2020 2066 6f72 2069  gs.        for i
+000261e0: 2069 6e20 7261 6e67 6528 6c65 6e28 636f   in range(len(co
+000261f0: 6e66 5b27 7265 6665 7265 6e63 655f 6361  nf['reference_ca
+00026200: 7461 6c6f 6727 5d29 293a 0a20 2020 2020  talog'])):.     
+00026210: 2020 2020 2020 2069 6620 6920 213d 2030         if i != 0
+00026220: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00026230: 2020 7375 6666 6978 202b 3d20 272b 270a    suffix += '+'.
+00026240: 0a20 2020 2020 2020 2020 2020 2073 7566  .            suf
+00026250: 6669 7820 2b3d 2066 227b 636f 6e66 5b27  fix += f"{conf['
+00026260: 7265 6665 7265 6e63 655f 6361 7461 6c6f  reference_catalo
+00026270: 6727 5d5b 695d 7d22 0a0a 2020 2020 2020  g'][i]}"..      
+00026280: 2020 7265 7475 726e 2073 7566 6669 780a    return suffix.
+00026290: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+000262a0: 2020 2072 6574 7572 6e20 636f 6e66 5b27     return conf['
+000262b0: 6361 6c69 6272 6174 696f 6e5f 6e61 6d65  calibration_name
+000262c0: 275d 0a0a 6465 6620 7365 645f 6669 7474  ']..def sed_fitt
+000262d0: 696e 6728 6d6f 6465 6c73 2c20 6361 7461  ing(models, cata
+000262e0: 6c6f 672c 2073 6176 655f 6669 6c65 2c20  log, save_file, 
+000262f0: 7265 665f 6d61 675f 636f 6c73 2c0a 2020  ref_mag_cols,.  
+00026300: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00026310: 6564 5f6d 6167 5f63 6f6c 7320 3d20 4e6f  ed_mag_cols = No
+00026320: 6e65 2c20 6261 7965 7369 616e 203d 2046  ne, bayesian = F
+00026330: 616c 7365 2c20 6562 765f 6d6f 6465 203d  alse, ebv_mode =
+00026340: 2046 616c 7365 293a 0a20 2020 2022 2222   False):.    """
+00026350: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
+00026360: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
+00026370: 2020 2020 6d6f 6465 6c73 203a 2073 7472      models : str
+00026380: 0a20 2020 2020 2020 204c 6f63 6174 696f  .        Locatio
+00026390: 6e20 6f66 2074 6865 206d 6f64 656c 2773  n of the model's
+000263a0: 2066 696c 6520 7769 7468 2073 796e 7468   file with synth
+000263b0: 6574 6963 2053 4544 7320 636f 6e76 6f6c  etic SEDs convol
+000263c0: 7665 6420 746f 2074 6865 0a20 2020 2020  ved to the.     
+000263d0: 2020 2070 6970 656c 696e 6520 7375 7070     pipeline supp
+000263e0: 6f72 7465 6420 6669 6c74 6572 730a 2020  orted filters.  
+000263f0: 2020 6361 7461 6c6f 6720 3a20 7374 720a    catalog : str.
+00026400: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
+00026410: 206f 6620 7468 6520 6361 7461 6c6f 6720   of the catalog 
+00026420: 7769 7468 2074 6865 2066 696c 7465 7273  with the filters
+00026430: 2064 6174 6120 746f 2066 6974 2074 6865   data to fit the
+00026440: 2053 4544 730a 2020 2020 7361 7665 5f66   SEDs.    save_f
+00026450: 696c 6520 3a20 7374 720a 2020 2020 2020  ile : str.      
+00026460: 2020 4c6f 6361 7469 6f6e 206f 6620 7468    Location of th
+00026470: 6520 6465 7369 7265 6420 7361 7665 2066  e desired save f
+00026480: 696c 6520 7768 6572 6520 6d6f 6465 6c20  ile where model 
+00026490: 7072 6564 6963 7465 6420 6d61 676e 6974  predicted magnit
+000264a0: 7564 6573 2077 696c 6c0a 2020 2020 2020  udes will.      
+000264b0: 2020 6265 2073 6176 6564 0a20 2020 2072    be saved.    r
+000264c0: 6566 5f6d 6167 5f63 6f6c 7320 3a20 6c69  ef_mag_cols : li
+000264d0: 7374 0a20 2020 2020 2020 204c 6973 7420  st.        List 
+000264e0: 6f66 206d 6167 6e69 7475 6465 7320 7573  of magnitudes us
+000264f0: 6564 2074 6f20 6669 7420 7468 6520 5345  ed to fit the SE
+00026500: 4473 0a20 2020 2070 7265 645f 6d61 675f  Ds.    pred_mag_
+00026510: 636f 6c73 203a 206c 6973 740a 2020 2020  cols : list.    
+00026520: 2020 2020 4c69 7374 206f 6620 6d61 676e      List of magn
+00026530: 6974 7564 6573 2070 7265 6469 6374 6564  itudes predicted
+00026540: 2062 7920 7468 6520 6669 7474 6564 2053   by the fitted S
+00026550: 4544 732e 2049 6620 6e6f 6e65 2c20 7468  EDs. If none, th
+00026560: 6520 636f 6465 0a20 2020 2020 2020 2070  e code.        p
+00026570: 7265 6469 6374 7320 6d61 676e 6974 7564  redicts magnitud
+00026580: 6573 2066 6f72 2072 6566 5f6d 6167 5f63  es for ref_mag_c
+00026590: 6f6c 7320 6f6e 6c79 2e0a 2020 2020 6261  ols only..    ba
+000265a0: 7965 7369 616e 203a 2062 6f6f 6c0a 2020  yesian : bool.  
+000265b0: 2020 2020 2020 4966 2054 7275 652c 206d        If True, m
+000265c0: 6f64 656c 2073 656c 6563 7469 6f6e 2063  odel selection c
+000265d0: 6f6d 6573 2066 726f 6d20 6d61 7869 6d69  omes from maximi
+000265e0: 7a61 7469 6f6e 206f 6620 706f 7374 6572  zation of poster
+000265f0: 696f 722c 0a20 2020 2020 2020 206f 7468  ior,.        oth
+00026600: 6572 7769 7365 2c20 6672 6f6d 206d 696e  erwise, from min
+00026610: 696d 697a 6174 696f 6e20 6f66 2063 6869  imization of chi
+00026620: 320a 2020 2020 6562 765f 6d6f 6465 203a  2.    ebv_mode :
+00026630: 2062 6f6f 6c0a 2020 2020 2020 2020 4966   bool.        If
+00026640: 2074 7275 652c 2074 6865 206d 6f64 6520   true, the mode 
+00026650: 6461 7461 2045 425f 5620 7769 6c6c 2062  data EB_V will b
+00026660: 6520 6573 7469 6d61 7465 6420 616e 6420  e estimated and 
+00026670: 6f6e 6c79 206d 6f64 656c 7320 7769 7468  only models with
+00026680: 2074 6869 730a 2020 2020 2020 2020 6578   this.        ex
+00026690: 6374 696e 6374 696f 6e20 7769 6c6c 2062  ctinction will b
+000266a0: 6520 636f 6e73 6964 6572 6564 0a0a 2020  e considered..  
+000266b0: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+000266c0: 2d2d 2d2d 2d0a 2020 2020 5361 7665 7320  -----.    Saves 
+000266d0: 7072 6564 6963 7465 6420 6d61 676e 6974  predicted magnit
+000266e0: 7564 6573 2074 6f20 7468 6520 7361 7665  udes to the save
+000266f0: 5f66 696c 6520 6c6f 6361 7469 6f6e 2e0a  _file location..
+00026700: 2020 2020 2222 220a 0a20 2020 2069 6620      """..    if 
+00026710: 6562 765f 6d6f 6465 3a0a 2020 2020 2020  ebv_mode:.      
+00026720: 2020 6361 7461 6c6f 675f 6461 7461 203d    catalog_data =
+00026730: 206c 6f61 645f 6461 7461 2863 6174 616c   load_data(catal
+00026740: 6f67 290a 2020 2020 2020 2020 6562 765f  og).        ebv_
+00026750: 6375 7420 3d20 6d6f 6465 2863 6174 616c  cut = mode(catal
+00026760: 6f67 5f64 6174 615b 2745 425f 5627 5d29  og_data['EB_V'])
+00026770: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00026780: 2020 2065 6276 5f63 7574 203d 204e 6f6e     ebv_cut = Non
+00026790: 650a 0a20 2020 2073 662e 6765 745f 6d6f  e..    sf.get_mo
+000267a0: 6465 6c5f 6d61 6773 286d 6f64 656c 735f  del_mags(models_
+000267b0: 6669 6c65 2020 203d 206d 6f64 656c 732c  file   = models,
+000267c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000267d0: 2020 2020 2020 2064 6174 615f 6669 6c65         data_file
+000267e0: 2020 2020 203d 2063 6174 616c 6f67 2c0a       = catalog,.
+000267f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026800: 2020 2020 2020 7361 7665 5f66 696c 6520        save_file 
+00026810: 2020 2020 3d20 7361 7665 5f66 696c 652c      = save_file,
+00026820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026830: 2020 2020 2020 2072 6566 5f6d 6167 5f63         ref_mag_c
+00026840: 6f6c 7320 203d 2072 6566 5f6d 6167 5f63  ols  = ref_mag_c
+00026850: 6f6c 732c 0a20 2020 2020 2020 2020 2020  ols,.           
+00026860: 2020 2020 2020 2020 2020 2070 7265 645f             pred_
+00026870: 6d61 675f 636f 6c73 203d 2070 7265 645f  mag_cols = pred_
+00026880: 6d61 675f 636f 6c73 2c0a 2020 2020 2020  mag_cols,.      
+00026890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000268a0: 6261 7965 7369 616e 2020 2020 2020 3d20  bayesian      = 
+000268b0: 6261 7965 7369 616e 2c0a 2020 2020 2020  bayesian,.      
+000268c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000268d0: 6562 765f 6375 7420 2020 2020 2020 3d20  ebv_cut       = 
+000268e0: 6562 765f 6375 7429 0a0a 0a64 6566 2067  ebv_cut)...def g
+000268f0: 6574 5f66 696c 7465 725f 7a65 726f 706f  et_filter_zeropo
+00026900: 696e 7428 6f62 735f 6d61 675f 6172 7261  int(obs_mag_arra
+00026910: 792c 206d 6f64 656c 5f6d 6167 5f61 7272  y, model_mag_arr
+00026920: 6179 2c20 6375 743d 2831 342c 3139 2929  ay, cut=(14,19))
+00026930: 3a0a 2020 2020 2222 220a 2020 2020 4573  :.    """.    Es
+00026940: 7469 6d61 7465 2074 6865 207a 6572 6f20  timate the zero 
+00026950: 706f 696e 7420 6f66 2061 2070 6172 7469  point of a parti
+00026960: 6375 6c61 7220 6669 6c74 6572 2062 7920  cular filter by 
+00026970: 636f 6d70 6172 696e 6720 6f62 7365 7276  comparing observ
+00026980: 6564 0a20 2020 206d 6167 6e69 7475 6465  ed.    magnitude
+00026990: 7320 616e 6420 6d6f 6465 6c20 7072 6564  s and model pred
+000269a0: 6963 7465 6420 6d61 676e 6974 7564 6573  icted magnitudes
+000269b0: 2e0a 0a20 2020 2050 6172 616d 6574 6572  ...    Parameter
+000269c0: 730a 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d  s.    ----------
+000269d0: 0a20 2020 206f 6273 5f6d 6167 5f61 7272  .    obs_mag_arr
+000269e0: 6179 203a 206e 702e 6172 7261 790a 2020  ay : np.array.  
+000269f0: 2020 2020 2020 6172 7261 7920 6f66 206f        array of o
+00026a00: 6273 6572 7665 6420 7a65 726f 2d70 6f69  bserved zero-poi
+00026a10: 6e74 730a 2020 2020 6d6f 6465 6c5f 6d61  nts.    model_ma
+00026a20: 675f 6172 7261 7920 3a20 6e70 2e61 7272  g_array : np.arr
+00026a30: 6179 0a20 2020 2020 2020 2061 7272 6179  ay.        array
+00026a40: 206f 6620 6d6f 6465 6c20 7072 6564 6963   of model predic
+00026a50: 7465 6420 7a65 726f 2d70 6f69 6e74 730a  ted zero-points.
+00026a60: 2020 2020 6375 7420 3a20 6c69 7374 0a20      cut : list. 
+00026a70: 2020 2020 2020 2049 6e74 6572 7661 6c20         Interval 
+00026a80: 5b6d 696e 2c6d 6178 5d20 6f66 206d 6167  [min,max] of mag
+00026a90: 6e69 7475 6465 7320 746f 2062 6520 636f  nitudes to be co
+00026aa0: 6e73 6964 6572 6564 2066 6f72 2074 6865  nsidered for the
+00026ab0: 2065 7374 696d 6174 696f 6e0a 2020 2020   estimation.    
+00026ac0: 2020 2020 6f66 2074 6865 207a 6572 6f2d      of the zero-
+00026ad0: 706f 696e 7473 0a0a 2020 2020 5265 7475  points..    Retu
+00026ae0: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+00026af0: 2020 2020 666c 6f61 740a 2020 2020 2020      float.      
+00026b00: 2020 5468 6520 7661 6c75 6520 6f66 2074    The value of t
+00026b10: 6865 207a 6572 6f2d 706f 696e 740a 2020  he zero-point.  
+00026b20: 2020 2222 220a 0a20 2020 2066 203d 2028    """..    f = (
+00026b30: 6d6f 6465 6c5f 6d61 675f 6172 7261 7920  model_mag_array 
+00026b40: 3e3d 2063 7574 5b30 5d29 2026 2028 6d6f  >= cut[0]) & (mo
+00026b50: 6465 6c5f 6d61 675f 6172 7261 7920 3c3d  del_mag_array <=
+00026b60: 2063 7574 5b31 5d29 0a0a 2020 2020 6465   cut[1])..    de
+00026b70: 6c74 615f 6172 7261 7920 3d20 6d6f 6465  lta_array = mode
+00026b80: 6c5f 6d61 675f 6172 7261 795b 665d 202d  l_mag_array[f] -
+00026b90: 206f 6273 5f6d 6167 5f61 7272 6179 5b66   obs_mag_array[f
+00026ba0: 5d0a 0a20 2020 2064 656c 7461 5f61 7272  ]..    delta_arr
+00026bb0: 6179 203d 2064 656c 7461 5f61 7272 6179  ay = delta_array
+00026bc0: 2e76 616c 7565 732e 7265 7368 6170 6528  .values.reshape(
+00026bd0: 2d31 2c20 3129 0a0a 2020 2020 6b64 655f  -1, 1)..    kde_
+00026be0: 6465 6e73 203d 204b 6572 6e65 6c44 656e  dens = KernelDen
+00026bf0: 7369 7479 286b 6572 6e65 6c3d 2767 6175  sity(kernel='gau
+00026c00: 7373 6961 6e27 2c20 6261 6e64 7769 6474  ssian', bandwidt
+00026c10: 683d 302e 3035 292e 6669 7428 6465 6c74  h=0.05).fit(delt
+00026c20: 615f 6172 7261 7929 0a0a 2020 2020 2320  a_array)..    # 
+00026c30: 5472 616e 7366 6f72 6d20 746f 206b 6465  Transform to kde
+00026c40: 0a20 2020 2078 203d 206e 702e 6172 616e  .    x = np.aran
+00026c50: 6765 282d 3130 2c20 3130 2c20 302e 3030  ge(-10, 10, 0.00
+00026c60: 3129 0a20 2020 2079 203d 206e 702e 6578  1).    y = np.ex
+00026c70: 7028 6b64 655f 6465 6e73 2e73 636f 7265  p(kde_dens.score
+00026c80: 5f73 616d 706c 6573 2878 2e72 6573 6861  _samples(x.resha
+00026c90: 7065 282d 312c 2031 2929 290a 0a20 2020  pe(-1, 1)))..   
+00026ca0: 2023 2067 6574 206d 6f64 650a 2020 2020   # get mode.    
+00026cb0: 6d6f 6465 203d 2078 5b79 203d 3d20 6e70  mode = x[y == np
+00026cc0: 2e6d 6178 2879 295d 5b30 5d0a 0a20 2020  .max(y)][0]..   
+00026cd0: 2072 6574 7572 6e20 6d6f 6465 0a0a 0a64   return mode...d
+00026ce0: 6566 207a 705f 6573 7469 6d61 7465 2863  ef zp_estimate(c
+00026cf0: 6174 616c 6f67 2c20 7361 7665 5f66 696c  atalog, save_fil
+00026d00: 652c 2066 696c 7465 7273 5f6c 6973 742c  e, filters_list,
+00026d10: 206d 6167 5f6c 6f77 3d31 342c 206d 6167   mag_low=14, mag
+00026d20: 5f75 703d 3139 2c0a 2020 2020 2020 2020  _up=19,.        
+00026d30: 2020 2020 2020 2020 6d61 675f 6375 7420          mag_cut 
+00026d40: 3d20 4e6f 6e65 293a 0a20 2020 2022 2222  = None):.    """
+00026d50: 0a20 2020 204f 6274 6169 6e20 7a65 726f  .    Obtain zero
+00026d60: 2d70 6f69 6e74 7320 666f 7220 6120 6769  -points for a gi
+00026d70: 7665 6e20 6361 7461 6c6f 6720 6279 2063  ven catalog by c
+00026d80: 6f6d 7061 7269 6e67 2074 6865 206f 6273  omparing the obs
+00026d90: 6572 7665 6420 616e 6420 6d6f 6465 6c0a  erved and model.
+00026da0: 2020 2020 7072 6564 6963 7465 6420 6d61      predicted ma
+00026db0: 676e 6974 7564 6573 2069 6e20 7468 6973  gnitudes in this
+00026dc0: 2063 6174 616c 6f67 2e20 496e 7075 7420   catalog. Input 
+00026dd0: 6361 7461 6c6f 6720 6d75 7374 2062 6520  catalog must be 
+00026de0: 7468 6520 6f75 7470 7574 206f 660a 2020  the output of.  
+00026df0: 2020 7365 645f 6669 7474 696e 672e 6765    sed_fitting.ge
+00026e00: 745f 6d6f 6465 6c5f 6d61 6773 0a0a 2020  t_model_mags..  
+00026e10: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00026e20: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 0a20 2020   ----------..   
+00026e30: 2063 6174 616c 6f67 203a 2073 7472 0a20   catalog : str. 
+00026e40: 2020 2020 2020 204c 6f63 6174 696f 6e20         Location 
+00026e50: 6f66 2074 6865 2069 6e70 7574 2063 6174  of the input cat
+00026e60: 616c 6f67 2e20 4d75 7374 2062 6520 7468  alog. Must be th
+00026e70: 6520 6f75 7470 7574 0a20 2020 2020 2020  e output.       
+00026e80: 206f 6620 7365 645f 6669 7474 696e 672e   of sed_fitting.
+00026e90: 6765 745f 6d6f 6465 6c5f 6d61 6773 0a20  get_model_mags. 
+00026ea0: 2020 2073 6176 655f 6669 6c65 203a 2073     save_file : s
+00026eb0: 7472 0a20 2020 2020 2020 204c 6f63 6174  tr.        Locat
+00026ec0: 696f 6e20 746f 2073 6176 6520 7468 6520  ion to save the 
+00026ed0: 6573 7469 6d61 7465 6420 7a65 726f 2d70  estimated zero-p
+00026ee0: 6f69 6e74 730a 2020 2020 6669 6c74 6572  oints.    filter
+00026ef0: 735f 6c69 7374 203a 206c 6973 740a 2020  s_list : list.  
+00026f00: 2020 2020 2020 4c69 7374 206f 6620 6669        List of fi
+00026f10: 6c74 6572 7320 746f 2065 7374 696d 6174  lters to estimat
+00026f20: 6520 7468 6520 7a65 726f 2d70 6f69 6e74  e the zero-point
+00026f30: 730a 2020 2020 6d61 675f 6375 7420 3a20  s.    mag_cut : 
+00026f40: 6c69 7374 205b 6f62 736f 6c65 7465 5d0a  list [obsolete].
+00026f50: 2020 2020 2020 2020 496e 7465 7276 616c          Interval
+00026f60: 205b 6d69 6e2c 6d61 785d 206f 6620 6d61   [min,max] of ma
+00026f70: 676e 6974 7564 6573 2074 6f20 6265 2063  gnitudes to be c
+00026f80: 6f6e 7369 6465 7265 6420 666f 7220 7468  onsidered for th
+00026f90: 6520 6573 7469 6d61 7469 6f6e 0a20 2020  e estimation.   
+00026fa0: 2020 2020 206f 6620 7468 6520 7a65 726f       of the zero
+00026fb0: 2d70 6f69 6e74 730a 2020 2020 6d61 675f  -points.    mag_
+00026fc0: 7570 203a 206c 6973 740a 2020 2020 2020  up : list.      
+00026fd0: 2020 4c69 7374 206f 6620 7570 7065 7220    List of upper 
+00026fe0: 6c69 6d69 7473 2066 6f72 2074 6865 206d  limits for the m
+00026ff0: 6167 6e69 7475 6465 7320 746f 2062 6520  agnitudes to be 
+00027000: 636f 6e73 6964 6572 6564 2066 6f72 2074  considered for t
+00027010: 6865 0a20 2020 2020 2020 2065 7374 696d  he.        estim
+00027020: 6174 696f 6e20 6f66 2074 6865 207a 6572  ation of the zer
+00027030: 6f2d 706f 696e 7473 2c20 666f 7220 6561  o-points, for ea
+00027040: 6368 2066 696c 7465 7220 696e 2066 696c  ch filter in fil
+00027050: 7465 7273 5f6c 6973 740a 2020 2020 6d61  ters_list.    ma
+00027060: 675f 6c6f 7720 3a20 6c69 7374 0a20 2020  g_low : list.   
+00027070: 2020 2020 204c 6973 7420 6f66 206c 6f77       List of low
+00027080: 6572 206c 696d 6974 7320 666f 7220 7468  er limits for th
+00027090: 6520 6d61 676e 6974 7564 6573 2074 6f20  e magnitudes to 
+000270a0: 6265 2063 6f6e 7369 6465 7265 6420 666f  be considered fo
+000270b0: 7220 7468 650a 2020 2020 2020 2020 6573  r the.        es
+000270c0: 7469 6d61 7469 6f6e 206f 6620 7468 6520  timation of the 
+000270d0: 7a65 726f 2d70 6f69 6e74 732c 2066 6f72  zero-points, for
+000270e0: 2065 6163 6820 6669 6c74 6572 2069 6e20   each filter in 
+000270f0: 6669 6c74 6572 735f 6c69 7374 0a0a 2020  filters_list..  
+00027100: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+00027110: 2d2d 2d2d 2d0a 2020 2020 5361 7665 7320  -----.    Saves 
+00027120: 7468 6520 7a65 726f 2d70 6f69 6e74 7320  the zero-points 
+00027130: 696e 2061 202e 7a70 2066 696c 650a 2020  in a .zp file.  
+00027140: 2020 2222 220a 0a20 2020 2064 6174 6120    """..    data 
+00027150: 3d20 6c6f 6164 5f64 6174 6128 6361 7461  = load_data(cata
+00027160: 6c6f 6729 0a20 2020 2070 7269 6e74 2822  log).    print("
+00027170: 5c6e 5c6e 5374 6172 7469 6e67 2074 6f20  \n\nStarting to 
+00027180: 6170 706c 7920 5a65 726f 506f 696e 7473  apply ZeroPoints
+00027190: 5c6e 5c6e 2229 0a0a 2020 2020 7072 696e  \n\n")..    prin
+000271a0: 7428 224f 6274 6169 6e69 6e67 207a 6572  t("Obtaining zer
+000271b0: 6f20 706f 696e 7420 666f 7220 6d61 676e  o point for magn
+000271c0: 6974 7564 6573 3a22 290a 2020 2020 7072  itudes:").    pr
+000271d0: 696e 7428 6669 6c74 6572 735f 6c69 7374  int(filters_list
+000271e0: 290a 0a20 2020 2070 7269 6e74 2822 5573  )..    print("Us
+000271f0: 696e 6720 7b30 7d20 7374 6172 7320 746f  ing {0} stars to
+00027200: 2065 7374 696d 6174 6520 5a50 7322 2e66   estimate ZPs".f
+00027210: 6f72 6d61 7428 6461 7461 2e73 6861 7065  ormat(data.shape
+00027220: 5b30 5d29 290a 0a20 2020 2023 2055 7365  [0]))..    # Use
+00027230: 206d 6167 5f63 7574 2c20 666f 7220 7265   mag_cut, for re
+00027240: 7472 6f63 6f6d 7061 7469 6269 6c69 7479  trocompatibility
+00027250: 0a20 2020 2069 6620 6d61 675f 6375 7420  .    if mag_cut 
+00027260: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00027270: 2020 2020 206d 6167 5f6c 6f77 203d 206d       mag_low = m
+00027280: 6167 5f63 7574 5b30 5d0a 2020 2020 2020  ag_cut[0].      
+00027290: 2020 6d61 675f 7570 203d 206d 6167 5f63    mag_up = mag_c
+000272a0: 7574 5b31 5d0a 0a20 2020 2023 2043 7265  ut[1]..    # Cre
+000272b0: 6174 6520 6d61 675f 6c6f 7720 616e 6420  ate mag_low and 
+000272c0: 6d61 675f 7570 206c 6973 7420 6966 206e  mag_up list if n
+000272d0: 6563 6573 7361 7279 0a20 2020 2069 6620  ecessary.    if 
+000272e0: 6973 696e 7374 616e 6365 286d 6167 5f6c  isinstance(mag_l
+000272f0: 6f77 2c20 666c 6f61 7429 3a0a 2020 2020  ow, float):.    
+00027300: 2020 2020 6d61 675f 6c6f 7720 3d20 5b6d      mag_low = [m
+00027310: 6167 5f6c 6f77 5d2a 6c65 6e28 6669 6c74  ag_low]*len(filt
+00027320: 6572 735f 6c69 7374 290a 2020 2020 6966  ers_list).    if
+00027330: 2069 7369 6e73 7461 6e63 6528 6d61 675f   isinstance(mag_
+00027340: 6c6f 772c 206c 6973 7429 3a0a 2020 2020  low, list):.    
+00027350: 2020 2020 6966 206c 656e 286d 6167 5f6c      if len(mag_l
+00027360: 6f77 2920 3d3d 2031 3a0a 2020 2020 2020  ow) == 1:.      
+00027370: 2020 2020 2020 6d61 675f 6c6f 7720 3d20        mag_low = 
+00027380: 5b6d 6167 5f6c 6f77 5b30 5d5d 2a6c 656e  [mag_low[0]]*len
+00027390: 2866 696c 7465 7273 5f6c 6973 7429 0a0a  (filters_list)..
+000273a0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+000273b0: 6528 6d61 675f 7570 2c20 666c 6f61 7429  e(mag_up, float)
+000273c0: 3a0a 2020 2020 2020 2020 6d61 675f 7570  :.        mag_up
+000273d0: 203d 205b 6d61 675f 7570 5d2a 6c65 6e28   = [mag_up]*len(
+000273e0: 6669 6c74 6572 735f 6c69 7374 290a 2020  filters_list).  
+000273f0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00027400: 6d61 675f 7570 2c20 6c69 7374 293a 0a20  mag_up, list):. 
+00027410: 2020 2020 2020 2069 6620 6c65 6e28 6d61         if len(ma
+00027420: 675f 7570 2920 3d3d 2031 3a0a 2020 2020  g_up) == 1:.    
+00027430: 2020 2020 2020 2020 6d61 675f 6c6f 7720          mag_low 
+00027440: 3d20 5b6d 6167 5f75 705b 305d 5d2a 6c65  = [mag_up[0]]*le
+00027450: 6e28 6669 6c74 6572 735f 6c69 7374 290a  n(filters_list).
+00027460: 0a20 2020 2023 2045 7374 696d 6174 696e  .    # Estimatin
+00027470: 6720 616e 6420 6170 706c 7969 6e67 205a  g and applying Z
+00027480: 500a 2020 2020 7a70 5f64 6963 7420 3d20  P.    zp_dict = 
+00027490: 7b7d 0a0a 2020 2020 666f 7220 6669 6c74  {}..    for filt
+000274a0: 2c20 6d61 675f 6c2c 206d 6167 5f75 2069  , mag_l, mag_u i
+000274b0: 6e20 7a69 7028 6669 6c74 6572 735f 6c69  n zip(filters_li
+000274c0: 7374 2c20 6d61 675f 6c6f 772c 206d 6167  st, mag_low, mag
+000274d0: 5f75 7029 3a0a 2020 2020 2020 2020 7072  _up):.        pr
+000274e0: 696e 7428 225c 6e45 7374 696d 6174 696e  int("\nEstimatin
+000274f0: 6720 5a50 2066 6f72 206d 6167 207b 307d  g ZP for mag {0}
+00027500: 222e 666f 726d 6174 2866 696c 7429 290a  ".format(filt)).
+00027510: 0a20 2020 2020 2020 2023 2043 7574 206c  .        # Cut l
+00027520: 6f67 670a 2020 2020 2020 2020 6477 6172  ogg.        dwar
+00027530: 6673 203d 2064 6174 612e 6c6f 635b 3a2c  fs = data.loc[:,
+00027540: 2027 6c6f 6767 275d 2e76 616c 7565 7320   'logg'].values 
+00027550: 3e20 330a 0a20 2020 2020 2020 206f 6273  > 3..        obs
+00027560: 5f6d 6167 5f61 7272 6179 203d 2064 6174  _mag_array = dat
+00027570: 612e 6c6f 635b 6477 6172 6673 2c20 6622  a.loc[dwarfs, f"
+00027580: 7b66 696c 747d 225d 0a20 2020 2020 2020  {filt}"].       
+00027590: 206d 6f64 5f6d 6167 5f61 7272 6179 203d   mod_mag_array =
+000275a0: 2064 6174 612e 6c6f 635b 6477 6172 6673   data.loc[dwarfs
+000275b0: 2c20 6622 7b66 696c 747d 5f6d 6f64 225d  , f"{filt}_mod"]
+000275c0: 0a0a 2020 2020 2020 2020 6669 6c74 5f7a  ..        filt_z
+000275d0: 7020 3d20 6765 745f 6669 6c74 6572 5f7a  p = get_filter_z
+000275e0: 6572 6f70 6f69 6e74 286f 6273 5f6d 6167  eropoint(obs_mag
+000275f0: 5f61 7272 6179 3d6f 6273 5f6d 6167 5f61  _array=obs_mag_a
+00027600: 7272 6179 2c0a 2020 2020 2020 2020 2020  rray,.          
+00027610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027620: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+00027630: 6c5f 6d61 675f 6172 7261 793d 6d6f 645f  l_mag_array=mod_
+00027640: 6d61 675f 6172 7261 792c 0a20 2020 2020  mag_array,.     
 00027650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027660: 2020 2020 2020 2020 6d6f 6465 6c5f 6d61          model_ma
-00027670: 675f 6172 7261 793d 6d6f 645f 6d61 675f  g_array=mod_mag_
-00027680: 6172 7261 792c 0a20 2020 2020 2020 2020  array,.         
-00027690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000276a0: 2020 2020 2020 2020 2020 2020 2063 7574               cut
-000276b0: 3d5b 6d61 675f 6c2c 206d 6167 5f75 5d29  =[mag_l, mag_u])
-000276c0: 0a0a 2020 2020 2020 2020 7a70 5f64 6963  ..        zp_dic
-000276d0: 745b 6669 6c74 5d20 3d20 6669 6c74 5f7a  t[filt] = filt_z
-000276e0: 700a 0a20 2020 2020 2020 2064 6174 612e  p..        data.
-000276f0: 6c6f 635b 3a2c 2066 227b 6669 6c74 7d22  loc[:, f"{filt}"
-00027700: 5d20 3d20 6461 7461 2e6c 6f63 5b3a 2c20  ] = data.loc[:, 
-00027710: 6622 7b66 696c 747d 225d 202b 2066 696c  f"{filt}"] + fil
-00027720: 745f 7a70 0a0a 2020 2020 2020 2020 7072  t_zp..        pr
-00027730: 696e 7428 227b 7d20 5a50 203d 207b 3a2e  int("{} ZP = {:.
-00027740: 3366 7d22 2e66 6f72 6d61 7428 6622 7b66  3f}".format(f"{f
-00027750: 696c 747d 222c 2066 696c 745f 7a70 2929  ilt}", filt_zp))
-00027760: 0a0a 2020 2020 2320 5361 7669 6e67 2064  ..    # Saving d
-00027770: 6174 610a 2020 2020 7a70 5f77 7269 7465  ata.    zp_write
-00027780: 287a 705f 6469 6374 3d7a 705f 6469 6374  (zp_dict=zp_dict
-00027790: 2c20 7361 7665 5f66 696c 653d 7361 7665  , save_file=save
-000277a0: 5f66 696c 652c 2066 696c 7465 7273 5f6c  _file, filters_l
-000277b0: 6973 743d 6669 6c74 6572 735f 6c69 7374  ist=filters_list
-000277c0: 290a 0a0a 6465 6620 7a70 5f67 6169 6173  )...def zp_gaias
-000277d0: 6361 6c65 2867 6169 615f 7a70 5f66 696c  cale(gaia_zp_fil
-000277e0: 652c 2073 6176 655f 6669 6c65 2c20 6669  e, save_file, fi
-000277f0: 6c74 6572 735f 6c69 7374 293a 0a20 2020  lters_list):.   
-00027800: 2022 2222 0a20 2020 204f 6274 6169 6e20   """.    Obtain 
-00027810: 6761 6961 7363 616c 6520 7a65 726f 2d70  gaiascale zero-p
-00027820: 6f69 6e74 7320 6672 6f6d 2074 6865 2067  oints from the g
-00027830: 6169 6120 7a65 726f 2070 6f69 6e74 7320  aia zero points 
-00027840: 6573 7469 6d61 7465 6420 636f 6d70 6172  estimated compar
-00027850: 696e 670a 2020 2020 6361 7461 6c6f 6720  ing.    catalog 
-00027860: 616e 6420 6d6f 6465 6c20 7072 6564 6963  and model predic
-00027870: 7465 6420 6d61 676e 6974 7564 6573 2e0a  ted magnitudes..
-00027880: 0a20 2020 2066 6f72 2065 6163 6820 6669  .    for each fi
-00027890: 6c74 6572 2069 6e20 6669 6c74 6572 735f  lter in filters_
-000278a0: 6c69 7374 3a0a 2020 2020 6761 6961 5f73  list:.    gaia_s
-000278b0: 6361 6c65 5f7a 7020 3d20 2d6d 6561 6e28  cale_zp = -mean(
-000278c0: 6761 6961 5f66 696c 7465 725f 7a70 7329  gaia_filter_zps)
-000278d0: 0a0a 2020 2020 5061 7261 6d65 7465 7273  ..    Parameters
-000278e0: 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a  .    ----------.
-000278f0: 2020 2020 6761 6961 5f7a 705f 6669 6c65      gaia_zp_file
-00027900: 203a 2073 7472 0a20 2020 2020 2020 207a   : str.        z
-00027910: 7020 6669 6c65 206f 6620 6761 6961 2066  p file of gaia f
-00027920: 696c 7465 7273 0a20 2020 2073 6176 655f  ilters.    save_
-00027930: 6669 6c65 203a 2073 7472 0a20 2020 2020  file : str.     
-00027940: 2020 204c 6f63 6174 696f 6e20 746f 2073     Location to s
-00027950: 6176 6520 7468 6520 6573 7469 6d61 7465  ave the estimate
-00027960: 6420 6761 6961 2073 6361 6c65 207a 6572  d gaia scale zer
-00027970: 6f2d 706f 696e 7473 0a20 2020 2066 696c  o-points.    fil
-00027980: 7465 7273 5f6c 6973 7420 3a20 6c69 7374  ters_list : list
-00027990: 0a20 2020 2020 2020 204c 6973 7420 6f66  .        List of
-000279a0: 2066 696c 7465 7273 2074 6f20 6573 7469   filters to esti
-000279b0: 6d61 7465 2074 6865 207a 6572 6f2d 706f  mate the zero-po
-000279c0: 696e 7473 0a0a 2020 2020 5265 7475 726e  ints..    Return
-000279d0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-000279e0: 2020 5361 7665 7320 7468 6520 7a65 726f    Saves the zero
-000279f0: 2d70 6f69 6e74 7320 696e 2061 202e 7a70  -points in a .zp
-00027a00: 2066 696c 650a 2020 2020 2222 220a 0a20   file.    """.. 
-00027a10: 2020 2067 6169 615f 7a70 7320 3d20 7a70     gaia_zps = zp
-00027a20: 5f72 6561 6428 6761 6961 5f7a 705f 6669  _read(gaia_zp_fi
-00027a30: 6c65 290a 0a20 2020 2070 7269 6e74 2822  le)..    print("
-00027a40: 5c6e 5c6e 4f62 7461 696e 696e 6720 6761  \n\nObtaining ga
-00027a50: 6961 2073 6361 6c65 205a 5073 5c6e 5c6e  ia scale ZPs\n\n
-00027a60: 2229 0a20 2020 2067 6169 615f 7363 616c  ").    gaia_scal
-00027a70: 655f 7a70 203d 202d 6e70 2e6d 6561 6e28  e_zp = -np.mean(
-00027a80: 6c69 7374 2867 6169 615f 7a70 732e 7661  list(gaia_zps.va
-00027a90: 6c75 6573 2829 2929 0a0a 2020 2020 2320  lues()))..    # 
-00027aa0: 4164 6469 6e67 2074 6f20 7468 6520 6469  Adding to the di
-00027ab0: 6374 696f 6e61 7279 0a20 2020 2073 706c  ctionary.    spl
-00027ac0: 7573 5f7a 705f 6469 6374 203d 207b 7d0a  us_zp_dict = {}.
-00027ad0: 0a20 2020 2066 6f72 2066 696c 7420 696e  .    for filt in
-00027ae0: 2066 696c 7465 7273 5f6c 6973 743a 0a20   filters_list:. 
-00027af0: 2020 2020 2020 2073 706c 7573 5f7a 705f         splus_zp_
-00027b00: 6469 6374 5b66 696c 745d 203d 2067 6169  dict[filt] = gai
-00027b10: 615f 7363 616c 655f 7a70 0a0a 2020 2020  a_scale_zp..    
-00027b20: 2020 2020 7072 696e 7428 227b 7d20 5a50      print("{} ZP
-00027b30: 203d 207b 3a2e 3366 7d22 2e66 6f72 6d61   = {:.3f}".forma
-00027b40: 7428 6622 7b66 696c 747d 222c 2067 6169  t(f"{filt}", gai
-00027b50: 615f 7363 616c 655f 7a70 2929 0a0a 2020  a_scale_zp))..  
-00027b60: 2020 2320 5361 7669 6e67 2064 6174 610a    # Saving data.
-00027b70: 2020 2020 7a70 5f77 7269 7465 287a 705f      zp_write(zp_
-00027b80: 6469 6374 3d73 706c 7573 5f7a 705f 6469  dict=splus_zp_di
-00027b90: 6374 2c0a 2020 2020 2020 2020 2020 2020  ct,.            
-00027ba0: 2073 6176 655f 6669 6c65 3d73 6176 655f   save_file=save_
-00027bb0: 6669 6c65 2c0a 2020 2020 2020 2020 2020  file,.          
-00027bc0: 2020 2066 696c 7465 7273 5f6c 6973 743d     filters_list=
-00027bd0: 6669 6c74 6572 735f 6c69 7374 290a 0a64  filters_list)..d
-00027be0: 6566 207a 705f 6170 706c 7928 6361 7461  ef zp_apply(cata
-00027bf0: 6c6f 672c 2073 6176 655f 6669 6c65 2c20  log, save_file, 
-00027c00: 7a70 5f66 696c 652c 2066 6d74 203d 2022  zp_file, fmt = "
-00027c10: 6173 6369 6922 2c20 7a70 5f69 6e73 7420  ascii", zp_inst 
-00027c20: 3d20 4e6f 6e65 293a 0a20 2020 2022 2222  = None):.    """
-00027c30: 0a20 2020 2041 7070 6c69 6573 2074 6865  .    Applies the
-00027c40: 207a 6572 6f2d 706f 696e 7473 2074 6f20   zero-points to 
-00027c50: 7468 6520 6d61 676e 6974 7564 6573 2063  the magnitudes c
-00027c60: 6174 616c 6f67 0a0a 2020 2020 5061 7261  atalog..    Para
-00027c70: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
-00027c80: 2d2d 2d2d 2d0a 2020 2020 6361 7461 6c6f  -----.    catalo
-00027c90: 6720 3a20 7374 720a 2020 2020 2020 2020  g : str.        
-00027ca0: 4c6f 6361 7469 6f6e 206f 6620 7468 6520  Location of the 
-00027cb0: 6361 7461 6c6f 670a 2020 2020 7361 7665  catalog.    save
-00027cc0: 5f66 696c 6520 3a20 7374 720a 2020 2020  _file : str.    
-00027cd0: 2020 2020 4c6f 6361 7469 6f6e 2074 6f20      Location to 
-00027ce0: 7361 7665 2074 6865 2063 6174 616c 6f67  save the catalog
-00027cf0: 2077 6974 6820 7a65 726f 2d70 6f69 6e74   with zero-point
-00027d00: 7320 6170 706c 6965 640a 2020 2020 7a70  s applied.    zp
-00027d10: 5f66 696c 6520 3a20 7374 720a 2020 2020  _file : str.    
-00027d20: 2020 2020 4c6f 6361 7469 6f6e 2074 6f20      Location to 
-00027d30: 7468 6520 2e7a 7020 6669 6c65 2077 6974  the .zp file wit
-00027d40: 6820 7468 6520 7a65 726f 2d70 6f69 6e74  h the zero-point
-00027d50: 730a 2020 2020 666d 7420 3a20 7374 720a  s.    fmt : str.
-00027d60: 2020 2020 2020 2020 4f75 7470 7574 2066          Output f
-00027d70: 6f72 6d61 740a 2020 2020 7a70 5f69 6e73  ormat.    zp_ins
-00027d80: 7420 3a20 666c 6f61 740a 2020 2020 2020  t : float.      
-00027d90: 2020 436f 6e73 7461 6e74 207a 7020 746f    Constant zp to
-00027da0: 2062 6520 6164 6465 6420 746f 2061 6c6c   be added to all
-00027db0: 2066 696c 7465 7273 2e20 4465 6661 756c   filters. Defaul
-00027dc0: 7420 3d20 4e6f 6e65 0a0a 2020 2020 5265  t = None..    Re
-00027dd0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-00027de0: 2d0a 2020 2020 5361 7665 7320 6e65 7720  -.    Saves new 
-00027df0: 6361 7461 6c6f 6720 7769 7468 207a 6572  catalog with zer
-00027e00: 6f2d 706f 696e 7473 2061 7070 6c69 6564  o-points applied
-00027e10: 0a20 2020 2022 2222 0a0a 2020 2020 5a50  .    """..    ZP
-00027e20: 7320 3d20 7a70 5f72 6561 6428 7a70 5f66  s = zp_read(zp_f
-00027e30: 696c 6529 0a20 2020 2063 6174 5f64 6174  ile).    cat_dat
-00027e40: 6120 3d20 6c6f 6164 5f64 6174 6128 6361  a = load_data(ca
-00027e50: 7461 6c6f 6729 0a0a 2020 2020 2320 4170  talog)..    # Ap
-00027e60: 706c 7920 5a65 726f 2050 6f69 6e74 730a  ply Zero Points.
-00027e70: 2020 2020 666f 7220 6669 6c74 2069 6e20      for filt in 
-00027e80: 5a50 732e 6b65 7973 2829 3a0a 0a20 2020  ZPs.keys():..   
-00027e90: 2020 2020 2069 6620 7a70 5f69 6e73 7420       if zp_inst 
-00027ea0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00027eb0: 2020 2020 207a 705f 6920 3d20 5a50 735b       zp_i = ZPs[
-00027ec0: 6669 6c74 5d0a 2020 2020 2020 2020 656c  filt].        el
-00027ed0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00027ee0: 7a70 5f69 203d 205a 5073 5b66 696c 745d  zp_i = ZPs[filt]
-00027ef0: 202b 207a 705f 696e 7374 0a0a 2020 2020   + zp_inst..    
-00027f00: 2020 2020 6e6f 5f6e 616e 203d 2063 6174      no_nan = cat
-00027f10: 5f64 6174 612e 6c6f 635b 3a2c 2066 696c  _data.loc[:, fil
-00027f20: 745d 2021 3d20 3939 0a0a 2020 2020 2020  t] != 99..      
-00027f30: 2020 6361 745f 6461 7461 2e6c 6f63 5b6e    cat_data.loc[n
-00027f40: 6f5f 6e61 6e2c 2066 696c 745d 203d 2063  o_nan, filt] = c
-00027f50: 6174 5f64 6174 612e 6c6f 635b 6e6f 5f6e  at_data.loc[no_n
-00027f60: 616e 2c20 6669 6c74 5d20 2b20 7a70 5f69  an, filt] + zp_i
-00027f70: 0a0a 2020 2020 7769 7468 206f 7065 6e28  ..    with open(
-00027f80: 6361 7461 6c6f 672c 2027 7227 2920 6173  catalog, 'r') as
-00027f90: 2066 3a0a 2020 2020 2020 2020 6669 7273   f:.        firs
-00027fa0: 745f 6c69 6e65 203d 2066 2e72 6561 646c  t_line = f.readl
-00027fb0: 696e 6528 290a 0a20 2020 2069 6620 666d  ine()..    if fm
-00027fc0: 7420 3d3d 2027 6173 6369 6927 3a0a 2020  t == 'ascii':.  
-00027fd0: 2020 2020 2020 7769 7468 206f 7065 6e28        with open(
-00027fe0: 7361 7665 5f66 696c 652c 2027 7727 2920  save_file, 'w') 
-00027ff0: 6173 2066 3a0a 2020 2020 2020 2020 2020  as f:.          
-00028000: 2020 662e 7772 6974 6528 6669 7273 745f    f.write(first_
-00028010: 6c69 6e65 290a 2020 2020 2020 2020 2020  line).          
-00028020: 2020 6e70 2e73 6176 6574 7874 2866 2c20    np.savetxt(f, 
-00028030: 6361 745f 6461 7461 2c20 666d 743d 2725  cat_data, fmt='%
-00028040: 2e35 6627 290a 0a20 2020 2065 6c69 6620  .5f')..    elif 
-00028050: 666d 7420 3d3d 2027 6669 7473 273a 0a20  fmt == 'fits':. 
-00028060: 2020 2020 2020 2074 203d 2054 6162 6c65         t = Table
-00028070: 2e66 726f 6d5f 7061 6e64 6173 2863 6174  .from_pandas(cat
-00028080: 5f64 6174 6129 0a20 2020 2020 2020 2074  _data).        t
-00028090: 2e77 7269 7465 2873 6176 655f 6669 6c65  .write(save_file
-000280a0: 290a 0a0a 6465 6620 706c 6f74 5f7a 705f  )...def plot_zp_
-000280b0: 6669 7474 696e 6728 7365 645f 6669 745f  fitting(sed_fit_
-000280c0: 6669 6c65 2c20 7361 7665 5f66 696c 652c  file, save_file,
-000280d0: 2066 696c 742c 206d 6167 5f63 7574 203d   filt, mag_cut =
-000280e0: 2028 3134 2c20 3139 292c 0a20 2020 2020   (14, 19),.     
-000280f0: 2020 2020 2020 2020 2020 2020 2020 207a                 z
-00028100: 705f 6669 6c65 203d 204e 6f6e 652c 206c  p_file = None, l
-00028110: 6162 656c 203d 2027 6d61 675f 696e 7374  abel = 'mag_inst
-00028120: 272c 2063 6f6c 6f72 203d 2022 2332 3236  ', color = "#226
-00028130: 3666 6622 293a 0a0a 2020 2020 2222 220a  6ff"):..    """.
-00028140: 2020 2020 4d61 6b65 7320 6120 706c 6f74      Makes a plot
-00028150: 206f 6620 7468 6520 7a65 726f 2d70 6f69   of the zero-poi
-00028160: 6e74 2065 7374 696d 6174 696f 6e20 7072  nt estimation pr
-00028170: 6f63 6573 730a 0a20 2020 2050 6172 616d  ocess..    Param
-00028180: 6574 6572 730a 2020 2020 2d2d 2d2d 2d2d  eters.    ------
-00028190: 2d2d 2d2d 0a20 2020 2073 6564 5f66 6974  ----.    sed_fit
-000281a0: 5f66 696c 6520 3a20 7374 720a 2020 2020  _file : str.    
-000281b0: 2020 2020 4c6f 6361 7469 6f6e 206f 6620      Location of 
-000281c0: 7468 6520 6361 7461 6c6f 6720 7769 7468  the catalog with
-000281d0: 2066 6974 7465 6420 616e 6420 6d6f 6465   fitted and mode
-000281e0: 6c2d 7072 6564 6963 7465 6420 6d61 676e  l-predicted magn
-000281f0: 6974 7564 6573 0a20 2020 207a 705f 6669  itudes.    zp_fi
-00028200: 6c65 203a 2073 7472 0a20 2020 2020 2020  le : str.       
-00028210: 204c 6f63 6174 696f 6e20 6f66 2074 6865   Location of the
-00028220: 206f 6274 6169 6e65 6420 7a70 2066 696c   obtained zp fil
-00028230: 650a 2020 2020 7361 7665 5f66 696c 6520  e.    save_file 
-00028240: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
-00028250: 6361 7469 6f6e 2074 6f20 7361 7665 2074  cation to save t
-00028260: 6865 2070 6c6f 740a 2020 2020 6669 6c74  he plot.    filt
-00028270: 203a 2073 7472 0a20 2020 2020 2020 204e   : str.        N
-00028280: 616d 6520 6f66 2074 6865 2066 696c 7465  ame of the filte
-00028290: 7220 746f 2070 6c6f 740a 2020 2020 6d61  r to plot.    ma
-000282a0: 675f 6375 7420 3a20 6c69 7374 0a20 2020  g_cut : list.   
-000282b0: 2020 2020 204c 696d 6974 7320 6f66 206d       Limits of m
-000282c0: 6167 6e69 7475 6465 7320 5b6d 696e 2c6d  agnitudes [min,m
-000282d0: 6178 5d20 7365 6c65 6374 6564 2066 6f72  ax] selected for
-000282e0: 207a 6572 6f2d 706f 696e 7420 6573 7469   zero-point esti
-000282f0: 6d61 7469 6f6e 0a20 2020 206c 6162 656c  mation.    label
-00028300: 203a 2073 7472 0a20 2020 2020 2020 2049   : str.        I
-00028310: 6465 6e74 6966 7920 7468 6520 7374 6570  dentify the step
-00028320: 2069 6e20 7468 6520 6361 6c69 6272 6174   in the calibrat
-00028330: 696f 6e20 7072 6f63 6573 730a 2020 2020  ion process.    
-00028340: 636f 6c6f 7220 3a20 7374 720a 2020 2020  color : str.    
-00028350: 2020 2020 436f 6c6f 7220 6f66 2074 6865      Color of the
-00028360: 2070 6f69 6e74 7320 696e 2074 6865 2073   points in the s
-00028370: 6361 7474 6572 2070 6c6f 7420 616e 6420  catter plot and 
-00028380: 6c69 6e65 206f 6620 6465 6e73 6974 7920  line of density 
-00028390: 706c 6f74 0a0a 2020 2020 5265 7475 726e  plot..    Return
-000283a0: 730a 2020 2020 2d2d 2d2d 2d2d 2d0a 2020  s.    -------.  
-000283b0: 2020 5361 7665 7320 7468 6520 706c 6f74    Saves the plot
-000283c0: 0a20 2020 2022 2222 0a0a 2020 2020 2323  .    """..    ##
-000283d0: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
-000283e0: 4c6f 6164 2064 6174 610a 0a20 2020 2063  Load data..    c
-000283f0: 6174 5f64 6174 6120 3d20 6c6f 6164 5f64  at_data = load_d
-00028400: 6174 6128 7365 645f 6669 745f 6669 6c65  ata(sed_fit_file
-00028410: 290a 0a20 2020 2023 2052 656d 6f76 6520  )..    # Remove 
-00028420: 3939 0a20 2020 2064 6174 615f 7365 6c65  99.    data_sele
-00028430: 6374 696f 6e20 3d20 6e70 2e61 6273 2863  ction = np.abs(c
-00028440: 6174 5f64 6174 612e 6c6f 635b 3a2c 2066  at_data.loc[:, f
-00028450: 696c 745d 203c 2035 3029 0a20 2020 2063  ilt] < 50).    c
-00028460: 6174 5f64 6174 6120 3d20 6361 745f 6461  at_data = cat_da
-00028470: 7461 5b64 6174 615f 7365 6c65 6374 696f  ta[data_selectio
-00028480: 6e5d 0a0a 2020 2020 2323 2323 2323 2323  n]..    ########
-00028490: 2323 2323 2323 0a20 2020 2023 2050 7265  ######.    # Pre
-000284a0: 7061 7265 2064 6174 610a 0a20 2020 2078  pare data..    x
-000284b0: 203d 2063 6174 5f64 6174 612e 6c6f 635b   = cat_data.loc[
-000284c0: 3a2c 2066 277b 6669 6c74 7d5f 6d6f 6427  :, f'{filt}_mod'
-000284d0: 5d0a 2020 2020 7920 3d20 7820 2d20 6361  ].    y = x - ca
-000284e0: 745f 6461 7461 2e6c 6f63 5b3a 2c20 6627  t_data.loc[:, f'
-000284f0: 7b66 696c 747d 275d 0a0a 2020 2020 6477  {filt}']..    dw
-00028500: 6172 6673 203d 2063 6174 5f64 6174 612e  arfs = cat_data.
-00028510: 6c6f 635b 3a2c 2027 6c6f 6767 275d 2e76  loc[:, 'logg'].v
-00028520: 616c 7565 7320 3e20 330a 2020 2020 7365  alues > 3.    se
-00028530: 6c65 6374 696f 6e20 3d20 2878 203e 3d20  lection = (x >= 
-00028540: 6d61 675f 6375 745b 305d 2920 2620 2878  mag_cut[0]) & (x
-00028550: 203c 3d20 6d61 675f 6375 745b 315d 2920   <= mag_cut[1]) 
-00028560: 2620 6477 6172 6673 0a0a 2020 2020 2323  & dwarfs..    ##
-00028570: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00028580: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
-00028590: 2041 7070 6c79 2064 6966 6665 7265 6e74   Apply different
-000285a0: 2065 7374 696d 6174 6f72 730a 0a20 2020   estimators..   
-000285b0: 2064 656c 7461 203d 2079 5b73 656c 6563   delta = y[selec
-000285c0: 7469 6f6e 5d0a 2020 2020 6465 6c74 6120  tion].    delta 
-000285d0: 3d20 6465 6c74 612e 7661 6c75 6573 2e72  = delta.values.r
-000285e0: 6573 6861 7065 282d 312c 2031 290a 0a20  eshape(-1, 1).. 
-000285f0: 2020 206b 6465 5f64 656e 7320 3d20 4b65     kde_dens = Ke
-00028600: 726e 656c 4465 6e73 6974 7928 6b65 726e  rnelDensity(kern
-00028610: 656c 3d27 6761 7573 7369 616e 272c 2062  el='gaussian', b
-00028620: 616e 6477 6964 7468 3d30 2e30 3529 2e66  andwidth=0.05).f
-00028630: 6974 2864 656c 7461 290a 0a20 2020 2079  it(delta)..    y
-00028640: 5f64 656e 7320 3d20 6e70 2e61 7261 6e67  _dens = np.arang
-00028650: 6528 2d31 302c 2031 302c 2030 2e30 3031  e(-10, 10, 0.001
-00028660: 290a 2020 2020 785f 6465 6e73 203d 206e  ).    x_dens = n
-00028670: 702e 6578 7028 6b64 655f 6465 6e73 2e73  p.exp(kde_dens.s
-00028680: 636f 7265 5f73 616d 706c 6573 2879 5f64  core_samples(y_d
-00028690: 656e 732e 7265 7368 6170 6528 2d31 2c20  ens.reshape(-1, 
-000286a0: 3129 2929 0a0a 2020 2020 6d6f 6465 203d  1)))..    mode =
-000286b0: 2079 5f64 656e 735b 785f 6465 6e73 203d   y_dens[x_dens =
-000286c0: 3d20 6e70 2e6d 6178 2878 5f64 656e 7329  = np.max(x_dens)
-000286d0: 5d5b 305d 0a0a 2020 2020 6d75 203d 206e  ][0]..    mu = n
-000286e0: 702e 6d65 616e 2879 5b73 656c 6563 7469  p.mean(y[selecti
-000286f0: 6f6e 5d29 0a20 2020 206d 755f 726f 6275  on]).    mu_robu
-00028700: 7374 203d 206d 6561 6e5f 726f 6275 7374  st = mean_robust
-00028710: 2879 5b73 656c 6563 7469 6f6e 5d29 0a0a  (y[selection])..
-00028720: 2020 2020 2323 2323 2323 2323 2323 2323      ############
-00028730: 2323 2323 0a20 2020 2023 204d 616b 6520  ####.    # Make 
-00028740: 7468 6520 706c 6f74 730a 0a20 2020 2066  the plots..    f
-00028750: 6967 203d 2070 6c74 2e66 6967 7572 6528  ig = plt.figure(
-00028760: 6669 6773 697a 653d 2838 2c20 3529 290a  figsize=(8, 5)).
-00028770: 2020 2020 6773 203d 2067 7269 6473 7065      gs = gridspe
-00028780: 632e 4772 6964 5370 6563 2831 2c20 322c  c.GridSpec(1, 2,
-00028790: 2077 6964 7468 5f72 6174 696f 733d 5b33   width_ratios=[3
-000287a0: 2c20 315d 290a 0a20 2020 2061 7831 203d  , 1])..    ax1 =
-000287b0: 2070 6c74 2e73 7562 706c 6f74 2867 735b   plt.subplot(gs[
-000287c0: 305d 290a 0a20 2020 2061 7831 2e73 6361  0])..    ax1.sca
-000287d0: 7474 6572 2878 5b73 656c 6563 7469 6f6e  tter(x[selection
-000287e0: 5d2c 2079 5b73 656c 6563 7469 6f6e 5d2c  ], y[selection],
-000287f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028800: 2063 3d63 6f6c 6f72 2c20 733d 3230 2c20   c=color, s=20, 
-00028810: 616c 7068 613d 302e 352c 207a 6f72 6465  alpha=0.5, zorde
-00028820: 723d 3129 0a0a 2020 2020 6178 312e 7363  r=1)..    ax1.sc
-00028830: 6174 7465 7228 785b 7e73 656c 6563 7469  atter(x[~selecti
-00028840: 6f6e 5d2c 2079 5b7e 7365 6c65 6374 696f  on], y[~selectio
-00028850: 6e5d 2c0a 2020 2020 2020 2020 2020 2020  n],.            
-00028860: 2020 2020 633d 636f 6c6f 722c 2073 3d32      c=color, s=2
-00028870: 302c 2061 6c70 6861 3d30 2e30 352c 207a  0, alpha=0.05, z
-00028880: 6f72 6465 723d 3229 0a0a 2020 2020 6178  order=2)..    ax
-00028890: 312e 706c 6f74 285b 6d61 675f 6375 745b  1.plot([mag_cut[
-000288a0: 305d 2c20 6d61 675f 6375 745b 315d 5d2c  0], mag_cut[1]],
-000288b0: 205b 6d6f 6465 2c20 6d6f 6465 5d2c 0a20   [mode, mode],. 
-000288c0: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-000288d0: 723d 2723 4646 3332 3139 272c 206c 696e  r='#FF3219', lin
-000288e0: 6573 7479 6c65 3d27 2d27 2c20 7a6f 7264  estyle='-', zord
-000288f0: 6572 3d36 290a 0a20 2020 2023 2323 230a  er=6)..    ####.
-00028900: 2020 2020 2320 4c69 6d69 7473 206f 6620      # Limits of 
-00028910: 7468 6520 706c 6f74 0a20 2020 2023 2323  the plot.    ###
-00028920: 230a 2020 2020 786c 696d 203d 205b 6d61  #.    xlim = [ma
-00028930: 675f 6375 745b 305d 202d 2032 2c20 6d61  g_cut[0] - 2, ma
-00028940: 675f 6375 745b 315d 202b 2034 5d0a 2020  g_cut[1] + 4].  
-00028950: 2020 796c 696d 203d 205b 6d6f 6465 202d    ylim = [mode -
-00028960: 2031 2e35 2c20 6d6f 6465 202b 2031 2e35   1.5, mode + 1.5
-00028970: 5d0a 0a20 2020 2061 7831 2e74 6578 7428  ]..    ax1.text(
-00028980: 6d61 675f 6375 745b 305d 202d 2031 2e35  mag_cut[0] - 1.5
-00028990: 2c20 6d6f 6465 202b 2031 2e33 2c20 6622  , mode + 1.3, f"
-000289a0: 7b66 696c 747d 222c 2066 6f6e 7473 697a  {filt}", fontsiz
-000289b0: 653d 3134 290a 0a20 2020 2061 7831 2e73  e=14)..    ax1.s
-000289c0: 6574 5f78 6c69 6d28 786c 696d 290a 2020  et_xlim(xlim).  
-000289d0: 2020 6178 312e 7365 745f 796c 696d 2879    ax1.set_ylim(y
-000289e0: 6c69 6d29 0a0a 2020 2020 6178 312e 7365  lim)..    ax1.se
-000289f0: 745f 786c 6162 656c 2822 6d61 675f 6d6f  t_xlabel("mag_mo
-00028a00: 6465 6c22 290a 2020 2020 6178 312e 7365  del").    ax1.se
-00028a10: 745f 796c 6162 656c 2866 226d 6167 5f6d  t_ylabel(f"mag_m
-00028a20: 6f64 656c 202d 207b 6c61 6265 6c7d 2229  odel - {label}")
-00028a30: 0a0a 2020 2020 2323 230a 2020 2020 2320  ..    ###.    # 
-00028a40: 506c 6f74 204b 4445 2064 6973 7472 6962  Plot KDE distrib
-00028a50: 7574 696f 6e0a 2020 2020 2323 230a 0a20  ution.    ###.. 
-00028a60: 2020 2061 7832 203d 2070 6c74 2e73 7562     ax2 = plt.sub
-00028a70: 706c 6f74 2867 735b 315d 290a 0a20 2020  plot(gs[1])..   
-00028a80: 2061 7832 2e70 6c6f 7428 785f 6465 6e73   ax2.plot(x_dens
-00028a90: 202f 206e 702e 6d61 7828 785f 6465 6e73   / np.max(x_dens
-00028aa0: 292c 2079 5f64 656e 732c 207a 6f72 6465  ), y_dens, zorde
-00028ab0: 723d 332c 2063 6f6c 6f72 203d 2063 6f6c  r=3, color = col
-00028ac0: 6f72 290a 0a20 2020 2069 6620 7a70 5f66  or)..    if zp_f
-00028ad0: 696c 6520 6973 206e 6f74 204e 6f6e 653a  ile is not None:
-00028ae0: 0a20 2020 2020 2020 207a 705f 6461 7461  .        zp_data
-00028af0: 203d 207a 705f 7265 6164 287a 705f 6669   = zp_read(zp_fi
-00028b00: 6c65 290a 2020 2020 2020 2020 7a70 203d  le).        zp =
-00028b10: 207a 705f 6461 7461 5b66 696c 745d 0a0a   zp_data[filt]..
-00028b20: 2020 2020 2020 2020 6178 322e 706c 6f74          ax2.plot
-00028b30: 285b 302c 2032 5d2c 205b 7a70 2c20 7a70  ([0, 2], [zp, zp
-00028b40: 5d2c 2063 6f6c 6f72 3d27 2330 3030 3030  ], color='#00000
-00028b50: 3027 2c20 6c69 6e65 7374 796c 653d 272d  0', linestyle='-
-00028b60: 2d27 2c0a 2020 2020 2020 2020 2020 2020  -',.            
-00028b70: 2020 2020 207a 6f72 6465 723d 332c 206c       zorder=3, l
-00028b80: 6162 656c 3d27 7a70 3a20 7b3a 2e34 667d  abel='zp: {:.4f}
-00028b90: 272e 666f 726d 6174 286d 6f64 6529 290a  '.format(mode)).
-00028ba0: 0a20 2020 2061 7832 2e70 6c6f 7428 5b30  .    ax2.plot([0
-00028bb0: 2c20 325d 2c20 5b6d 6f64 652c 206d 6f64  , 2], [mode, mod
-00028bc0: 655d 2c20 636f 6c6f 723d 2723 4646 3332  e], color='#FF32
-00028bd0: 3139 272c 206c 696e 6573 7479 6c65 3d27  19', linestyle='
-00028be0: 2d27 2c0a 2020 2020 2020 2020 2020 2020  -',.            
-00028bf0: 207a 6f72 6465 723d 322c 206c 6162 656c   zorder=2, label
-00028c00: 3d27 6d6f 6465 3a20 7b3a 2e34 667d 272e  ='mode: {:.4f}'.
-00028c10: 666f 726d 6174 286d 6f64 6529 290a 0a20  format(mode)).. 
-00028c20: 2020 2061 7832 2e70 6c6f 7428 5b30 2c20     ax2.plot([0, 
-00028c30: 325d 2c20 5b6d 752c 206d 755d 2c20 636f  2], [mu, mu], co
-00028c40: 6c6f 723d 2723 3139 3332 4646 272c 206c  lor='#1932FF', l
-00028c50: 696e 6573 7479 6c65 3d27 2d2d 272c 0a20  inestyle='--',. 
-00028c60: 2020 2020 2020 2020 2020 2020 7a6f 7264              zord
-00028c70: 6572 3d31 2c20 6c61 6265 6c3d 276d 6561  er=1, label='mea
-00028c80: 6e3a 207b 3a2e 3466 7d27 2e66 6f72 6d61  n: {:.4f}'.forma
-00028c90: 7428 6d75 2929 0a0a 2020 2020 6178 322e  t(mu))..    ax2.
-00028ca0: 706c 6f74 285b 302c 2032 5d2c 205b 6d75  plot([0, 2], [mu
-00028cb0: 5f72 6f62 7573 742c 206d 755f 726f 6275  _robust, mu_robu
-00028cc0: 7374 5d2c 2063 6f6c 6f72 3d27 2331 3944  st], color='#19D
-00028cd0: 4433 3227 2c20 6c69 6e65 7374 796c 653d  D32', linestyle=
-00028ce0: 273a 272c 0a20 2020 2020 2020 2020 2020  ':',.           
-00028cf0: 2020 7a6f 7264 6572 3d31 2c0a 2020 2020    zorder=1,.    
-00028d00: 2020 2020 2020 2020 206c 6162 656c 3d27           label='
-00028d10: 6d65 616e 5f72 6f62 7573 743a 207b 3a2e  mean_robust: {:.
-00028d20: 3466 7d27 2e66 6f72 6d61 7428 6d75 5f72  4f}'.format(mu_r
-00028d30: 6f62 7573 7429 290a 0a20 2020 2061 7832  obust))..    ax2
-00028d40: 2e73 6574 5f78 6c69 6d28 5b30 2c20 312e  .set_xlim([0, 1.
-00028d50: 315d 290a 2020 2020 6178 322e 7365 745f  1]).    ax2.set_
-00028d60: 796c 696d 2879 6c69 6d29 0a0a 2020 2020  ylim(ylim)..    
-00028d70: 6178 322e 6c65 6765 6e64 2866 6f6e 7473  ax2.legend(fonts
-00028d80: 697a 653d 3729 0a0a 2020 2020 6178 322e  ize=7)..    ax2.
-00028d90: 6178 6573 2e67 6574 5f78 6178 6973 2829  axes.get_xaxis()
-00028da0: 2e73 6574 5f76 6973 6962 6c65 2846 616c  .set_visible(Fal
-00028db0: 7365 290a 2020 2020 6178 322e 6178 6573  se).    ax2.axes
-00028dc0: 2e67 6574 5f79 6178 6973 2829 2e73 6574  .get_yaxis().set
-00028dd0: 5f76 6973 6962 6c65 2846 616c 7365 290a  _visible(False).
-00028de0: 2020 2020 6178 322e 7365 745f 796c 6162      ax2.set_ylab
-00028df0: 656c 2822 4465 6e73 6974 7922 290a 0a20  el("Density").. 
-00028e00: 2020 2023 2323 2323 2323 2323 2323 230a     ############.
-00028e10: 2020 2020 2320 506c 6f74 2067 7269 6473      # Plot grids
-00028e20: 0a0a 2020 2020 666f 7220 6920 696e 206e  ..    for i in n
-00028e30: 702e 6172 616e 6765 282d 3130 2c20 3130  p.arange(-10, 10
-00028e40: 2c20 302e 3529 3a0a 0a20 2020 2020 2020  , 0.5):..       
-00028e50: 2061 7831 2e70 6c6f 7428 5b30 2c20 3330   ax1.plot([0, 30
-00028e60: 5d2c 205b 692c 2069 5d2c 0a20 2020 2020  ], [i, i],.     
-00028e70: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-00028e80: 723d 2223 3636 3636 3636 222c 2061 6c70  r="#666666", alp
-00028e90: 6861 3d30 2e33 2c0a 2020 2020 2020 2020  ha=0.3,.        
-00028ea0: 2020 2020 2020 2020 206c 696e 6577 6964           linewid
-00028eb0: 7468 3d30 2e35 2c20 7a6f 7264 6572 3d2d  th=0.5, zorder=-
-00028ec0: 3529 0a0a 2020 2020 2020 2020 6178 322e  5)..        ax2.
-00028ed0: 706c 6f74 285b 302c 2033 305d 2c20 5b69  plot([0, 30], [i
-00028ee0: 2c20 695d 2c0a 2020 2020 2020 2020 2020  , i],.          
-00028ef0: 2020 2020 2020 2063 6f6c 6f72 3d22 2336         color="#6
-00028f00: 3636 3636 3622 2c20 616c 7068 613d 302e  66666", alpha=0.
-00028f10: 332c 0a20 2020 2020 2020 2020 2020 2020  3,.             
-00028f20: 2020 2020 6c69 6e65 7769 6474 683d 302e      linewidth=0.
-00028f30: 352c 207a 6f72 6465 723d 2d35 290a 0a20  5, zorder=-5).. 
-00028f40: 2020 2066 6f72 2069 2069 6e20 6e70 2e61     for i in np.a
-00028f50: 7261 6e67 6528 2d31 302c 2031 302c 2030  range(-10, 10, 0
-00028f60: 2e31 293a 0a0a 2020 2020 2020 2020 6178  .1):..        ax
-00028f70: 312e 706c 6f74 285b 302c 2033 305d 2c20  1.plot([0, 30], 
-00028f80: 5b69 2c20 695d 2c0a 2020 2020 2020 2020  [i, i],.        
-00028f90: 2020 2020 2020 2020 2063 6f6c 6f72 3d22           color="
-00028fa0: 2336 3636 3636 3622 2c20 616c 7068 613d  #666666", alpha=
-00028fb0: 302e 312c 0a20 2020 2020 2020 2020 2020  0.1,.           
-00028fc0: 2020 2020 2020 6c69 6e65 7769 6474 683d        linewidth=
-00028fd0: 302e 352c 207a 6f72 6465 723d 2d35 290a  0.5, zorder=-5).
-00028fe0: 0a20 2020 2020 2020 2061 7832 2e70 6c6f  .        ax2.plo
-00028ff0: 7428 5b30 2c20 3330 5d2c 205b 692c 2069  t([0, 30], [i, i
-00029000: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00029010: 2020 2020 636f 6c6f 723d 2223 3636 3636      color="#6666
-00029020: 3636 222c 2061 6c70 6861 3d30 2e31 2c0a  66", alpha=0.1,.
-00029030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029040: 206c 696e 6577 6964 7468 3d30 2e35 2c20   linewidth=0.5, 
-00029050: 7a6f 7264 6572 3d2d 3529 0a0a 2020 2020  zorder=-5)..    
-00029060: 666f 7220 6920 696e 206e 702e 6172 616e  for i in np.aran
-00029070: 6765 2831 2c20 3330 2c20 3129 3a0a 0a20  ge(1, 30, 1):.. 
-00029080: 2020 2020 2020 2061 7831 2e70 6c6f 7428         ax1.plot(
-00029090: 5b69 2c20 695d 2c20 5b2d 3130 2c20 3130  [i, i], [-10, 10
-000290a0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000290b0: 2020 2020 636f 6c6f 723d 2223 3636 3636      color="#6666
-000290c0: 3636 222c 206c 696e 6577 6964 7468 3d30  66", linewidth=0
-000290d0: 2e35 2c0a 2020 2020 2020 2020 2020 2020  .5,.            
-000290e0: 2020 2020 2061 6c70 6861 3d30 2e31 2c20       alpha=0.1, 
-000290f0: 7a6f 7264 6572 3d2d 3529 0a0a 2020 2020  zorder=-5)..    
-00029100: 666f 7220 6920 696e 206e 702e 6172 616e  for i in np.aran
-00029110: 6765 2832 2c20 3330 2c20 3229 3a0a 0a20  ge(2, 30, 2):.. 
-00029120: 2020 2020 2020 2061 7831 2e70 6c6f 7428         ax1.plot(
-00029130: 5b69 2c20 695d 2c20 5b2d 3130 2c20 3130  [i, i], [-10, 10
-00029140: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00029150: 2020 2020 636f 6c6f 723d 2223 3636 3636      color="#6666
-00029160: 3636 222c 206c 696e 6577 6964 7468 3d30  66", linewidth=0
-00029170: 2e35 2c0a 2020 2020 2020 2020 2020 2020  .5,.            
-00029180: 2020 2020 2061 6c70 6861 3d30 2e33 2c20       alpha=0.3, 
-00029190: 7a6f 7264 6572 3d2d 3529 0a0a 2020 2020  zorder=-5)..    
-000291a0: 706c 742e 7375 6270 6c6f 7473 5f61 646a  plt.subplots_adj
-000291b0: 7573 7428 746f 703d 302e 3938 2c20 6c65  ust(top=0.98, le
-000291c0: 6674 3d30 2e31 2c20 7269 6768 743d 302e  ft=0.1, right=0.
-000291d0: 3938 2c20 7773 7061 6365 3d30 290a 0a20  98, wspace=0).. 
-000291e0: 2020 2070 6c74 2e73 6176 6566 6967 2873     plt.savefig(s
-000291f0: 6176 655f 6669 6c65 290a 2020 2020 706c  ave_file).    pl
-00029200: 742e 636c 6628 290a 2020 2020 706c 742e  t.clf().    plt.
-00029210: 636c 6f73 6528 290a 0a0a 2323 2323 2323  close()...######
-00029220: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00029230: 2323 2323 230a 2320 5374 656c 6c61 7220  #####.# Stellar 
-00029240: 4c6f 6375 7320 6361 6c69 6272 6174 696f  Locus calibratio
-00029250: 6e0a 0a64 6566 207a 705f 6573 7469 6d61  n..def zp_estima
-00029260: 7465 5f73 746c 6f63 7573 2863 6174 616c  te_stlocus(catal
-00029270: 6f67 2c20 7361 7665 5f66 696c 652c 2073  og, save_file, s
-00029280: 746c 6f63 7573 5f72 6566 5f63 6174 2c0a  tlocus_ref_cat,.
-00029290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000292a0: 2020 2020 2020 2020 6669 6c74 735f 636f          filts_co
-000292b0: 6c6f 725f 7265 662c 2066 696c 745f 7265  lor_ref, filt_re
-000292c0: 662c 2066 696c 7473 5f74 6f5f 6765 745f  f, filts_to_get_
-000292d0: 7a70 2c0a 2020 2020 2020 2020 2020 2020  zp,.            
-000292e0: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-000292f0: 725f 7261 6e67 652c 206e 6269 6e73 2c20  r_range, nbins, 
-00029300: 706c 6f74 5f70 6174 6820 3d20 4e6f 6e65  plot_path = None
-00029310: 2c20 6669 656c 6420 3d20 4e6f 6e65 293a  , field = None):
-00029320: 0a0a 2020 2020 2222 220a 2020 2020 4170  ..    """.    Ap
-00029330: 706c 6965 7320 7468 6520 7374 656c 6c61  plies the stella
-00029340: 7220 6c6f 6375 7320 7465 6368 6e69 7175  r locus techniqu
-00029350: 6520 746f 2064 6572 6976 6520 7468 6520  e to derive the 
-00029360: 7a65 726f 2d70 6f69 6e74 7320 6f66 2061  zero-points of a
-00029370: 206c 6973 740a 2020 2020 6f66 2066 696c   list.    of fil
-00029380: 7465 7273 2079 6574 2074 6f20 6265 2063  ters yet to be c
-00029390: 616c 6962 7261 7465 642e 0a0a 2020 2020  alibrated...    
-000293a0: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
-000293b0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6361  ---------.    ca
-000293c0: 7461 6c6f 6720 3a20 7374 720a 2020 2020  talog : str.    
-000293d0: 2020 2020 4c6f 6361 7469 6f6e 206f 6620      Location of 
-000293e0: 7468 6520 6361 7461 6c6f 6720 7769 7468  the catalog with
-000293f0: 2066 696c 7465 7220 636f 6c75 6d6e 7320   filter columns 
-00029400: 746f 2062 6520 6361 6c69 6272 6174 6564  to be calibrated
-00029410: 0a20 2020 2073 6176 655f 6669 6c65 203a  .    save_file :
-00029420: 2073 7472 0a20 2020 2020 2020 204c 6f63   str.        Loc
-00029430: 6174 696f 6e20 6f66 2074 6865 202e 7a70  ation of the .zp
-00029440: 206f 7574 7075 7420 6669 6c65 0a20 2020   output file.   
-00029450: 2073 746c 6f63 7573 5f72 6566 5f63 6174   stlocus_ref_cat
-00029460: 203a 2073 7472 0a20 2020 2020 2020 204c   : str.        L
-00029470: 6f63 6174 696f 6e20 6f66 2074 6865 2063  ocation of the c
-00029480: 6174 616c 6f67 2075 7365 6420 6173 2074  atalog used as t
-00029490: 6865 2072 6566 6572 656e 6365 2066 6f72  he reference for
-000294a0: 2074 6865 2063 616c 6962 7261 7469 6f6e   the calibration
-000294b0: 0a20 2020 2066 696c 7473 5f63 6f6c 6f72  .    filts_color
-000294c0: 5f72 6566 203a 206c 6973 740a 2020 2020  _ref : list.    
-000294d0: 2020 2020 636f 6c6f 7220 6669 6c74 3120      color filt1 
-000294e0: 2d20 6669 6c74 3220 6973 2063 616c 6375  - filt2 is calcu
-000294f0: 6c61 7465 6420 6672 6f6d 2074 6865 2063  lated from the c
-00029500: 6f6c 756d 6e73 205b 6669 6c74 312c 2066  olumns [filt1, f
-00029510: 696c 7432 5d0a 2020 2020 6669 6c74 5f72  ilt2].    filt_r
-00029520: 6566 203a 2073 7472 0a20 2020 2020 2020  ef : str.       
-00029530: 2066 696c 7465 7220 7468 6174 2063 6f6d   filter that com
-00029540: 706c 6574 6573 2074 6865 2063 6f6c 6f72  pletes the color
-00029550: 2069 6e20 7468 6520 7920 6178 6973 0a20   in the y axis. 
-00029560: 2020 2066 696c 7473 5f74 6f5f 6765 745f     filts_to_get_
-00029570: 7a70 203a 206c 6973 740a 2020 2020 2020  zp : list.      
-00029580: 2020 4c69 7374 206f 6620 6669 6c74 6572    List of filter
-00029590: 7320 746f 206f 6274 6169 6e20 7a70 2075  s to obtain zp u
-000295a0: 7369 6e67 2074 6865 2073 7465 6c6c 6172  sing the stellar
-000295b0: 206c 6f63 7573 2074 6563 686e 6971 7565   locus technique
-000295c0: 0a20 2020 2063 6f6c 6f72 5f72 616e 6765  .    color_range
-000295d0: 203a 206c 6973 740a 2020 2020 2020 2020   : list.        
-000295e0: 782d 6178 6973 2063 6f6c 6f72 2072 616e  x-axis color ran
-000295f0: 6765 2063 6f6e 7369 6465 7265 6420 696e  ge considered in
-00029600: 2074 6865 207a 7020 6669 7474 696e 6720   the zp fitting 
-00029610: 5b6d 696e 2c20 6d61 785d 0a20 2020 206e  [min, max].    n
-00029620: 6269 6e73 203a 2069 6e74 0a20 2020 2020  bins : int.     
-00029630: 2020 204e 756d 6265 7220 6f66 2062 696e     Number of bin
-00029640: 7320 746f 2064 6976 6964 6520 7468 6520  s to divide the 
-00029650: 636f 6c6f 725f 7261 6e67 6520 696e 7465  color_range inte
-00029660: 7276 616c 0a20 2020 2070 6c6f 745f 7061  rval.    plot_pa
-00029670: 7468 203a 2073 7472 0a20 2020 2020 2020  th : str.       
-00029680: 204c 6f63 6174 696f 6e20 6f66 2074 6865   Location of the
-00029690: 2064 6972 6563 746f 7279 2074 6f20 7361   directory to sa
-000296a0: 7665 2070 6c6f 7473 2028 6361 6e20 6265  ve plots (can be
-000296b0: 204e 6f6e 6529 0a20 2020 2066 6965 6c64   None).    field
-000296c0: 203a 2073 7472 0a20 2020 2020 2020 204e   : str.        N
-000296d0: 616d 6520 6f66 2074 6865 2066 6965 6c64  ame of the field
-000296e0: 2028 7573 6564 206f 6e6c 7920 666f 7220   (used only for 
-000296f0: 7468 6520 706c 6f74 7320 6669 6c65 206e  the plots file n
-00029700: 616d 6573 290a 0a20 2020 2052 6574 7572  ames)..    Retur
-00029710: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a20  ns.    -------. 
-00029720: 2020 2053 6176 6573 2061 202e 7a70 2066     Saves a .zp f
-00029730: 696c 6520 7769 7468 2074 6865 207a 6572  ile with the zer
-00029740: 6f20 706f 696e 7473 2061 6e64 2c20 6f70  o points and, op
-00029750: 7469 6f6e 616c 6c79 2c20 7361 7665 7320  tionally, saves 
-00029760: 706c 6f74 7320 6f66 2074 6865 0a20 2020  plots of the.   
-00029770: 2070 726f 6365 7373 0a20 2020 2022 2222   process.    """
-00029780: 0a0a 2020 2020 2320 4c6f 6164 2052 6566  ..    # Load Ref
-00029790: 6572 656e 6365 2061 6e64 2064 6174 610a  erence and data.
-000297a0: 2020 2020 7265 6665 7265 6e63 6520 3d20      reference = 
-000297b0: 6c6f 6164 5f64 6174 6128 7374 6c6f 6375  load_data(stlocu
-000297c0: 735f 7265 665f 6361 7429 0a20 2020 2063  s_ref_cat).    c
-000297d0: 6174 5f64 6174 6120 3d20 6c6f 6164 5f64  at_data = load_d
-000297e0: 6174 6128 6361 7461 6c6f 6729 0a0a 2020  ata(catalog)..  
-000297f0: 2020 2320 6465 6669 6e65 2078 2061 7869    # define x axi
-00029800: 7320 3d3e 2063 6f6c 6f72 203d 2066 696c  s => color = fil
-00029810: 745f 7830 202d 2066 696c 745f 7831 0a20  t_x0 - filt_x1. 
-00029820: 2020 2066 696c 745f 7830 203d 2066 696c     filt_x0 = fil
-00029830: 7473 5f63 6f6c 6f72 5f72 6566 5b30 5d0a  ts_color_ref[0].
-00029840: 2020 2020 6669 6c74 5f78 3120 3d20 6669      filt_x1 = fi
-00029850: 6c74 735f 636f 6c6f 725f 7265 665b 315d  lts_color_ref[1]
-00029860: 0a0a 2020 2020 2320 4361 6c63 756c 6174  ..    # Calculat
-00029870: 6520 636f 6c6f 7273 2066 726f 6d20 7265  e colors from re
-00029880: 6665 7265 6e63 6520 616e 6420 6672 6f6d  ference and from
-00029890: 2063 6174 616c 6f67 2074 6f20 6361 6c69   catalog to cali
-000298a0: 6272 6174 650a 2020 2020 7265 6665 7265  brate.    refere
-000298b0: 6e63 655f 7820 3d20 7265 6665 7265 6e63  nce_x = referenc
-000298c0: 652e 6c6f 635b 3a2c 2066 696c 745f 7830  e.loc[:, filt_x0
-000298d0: 5d20 2d20 7265 6665 7265 6e63 652e 6c6f  ] - reference.lo
-000298e0: 635b 3a2c 2066 696c 745f 7831 5d0a 2020  c[:, filt_x1].  
-000298f0: 2020 6361 745f 6461 7461 5f78 2020 3d20    cat_data_x  = 
-00029900: 6361 745f 6461 7461 2e6c 6f63 5b3a 2c20  cat_data.loc[:, 
-00029910: 6669 6c74 5f78 305d 202d 2063 6174 5f64  filt_x0] - cat_d
-00029920: 6174 612e 6c6f 635b 3a2c 2066 696c 745f  ata.loc[:, filt_
-00029930: 7831 5d0a 0a20 2020 207a 705f 6469 6374  x1]..    zp_dict
-00029940: 203d 207b 7d0a 0a20 2020 2062 696e 7320   = {}..    bins 
-00029950: 3d20 6e70 2e6c 696e 7370 6163 6528 636f  = np.linspace(co
-00029960: 6c6f 725f 7261 6e67 655b 305d 2c20 636f  lor_range[0], co
-00029970: 6c6f 725f 7261 6e67 655b 315d 2c20 6e62  lor_range[1], nb
-00029980: 696e 7329 0a20 2020 2064 656c 7461 5f62  ins).    delta_b
-00029990: 696e 203d 2062 696e 735b 315d 202d 2062  in = bins[1] - b
-000299a0: 696e 735b 305d 0a0a 2020 2020 2320 4f62  ins[0]..    # Ob
-000299b0: 7461 696e 207a 6572 6f20 706f 696e 7473  tain zero points
-000299c0: 0a20 2020 2066 6f72 2066 696c 7420 696e  .    for filt in
-000299d0: 2066 696c 7473 5f74 6f5f 6765 745f 7a70   filts_to_get_zp
-000299e0: 3a0a 2020 2020 2020 2020 7072 696e 7428  :.        print(
-000299f0: 6622 4573 7469 6d61 7469 6e67 205a 5020  f"Estimating ZP 
-00029a00: 666f 7220 6669 6c74 6572 207b 6669 6c74  for filter {filt
-00029a10: 7d20 7573 696e 6720 7468 6520 7374 656c  } using the stel
-00029a20: 6c61 7220 6c6f 6375 7322 290a 0a20 2020  lar locus")..   
-00029a30: 2020 2020 2064 656c 7461 5f6d 6167 203d       delta_mag =
-00029a40: 205b 5d0a 0a20 2020 2020 2020 2023 2323   []..        ###
-00029a50: 230a 2020 2020 2020 2020 7265 6665 7265  #.        refere
-00029a60: 6e63 655f 6269 6e5f 795f 6c69 7374 203d  nce_bin_y_list =
-00029a70: 205b 5d0a 2020 2020 2020 2020 6461 7461   [].        data
-00029a80: 5f62 696e 5f79 5f6c 6973 7420 3d20 5b5d  _bin_y_list = []
-00029a90: 0a20 2020 2020 2020 2023 2323 230a 0a20  .        ####.. 
-00029aa0: 2020 2020 2020 2023 2052 656d 6f76 6520         # Remove 
-00029ab0: 6d61 6720 3d20 3939 206f 7220 2d39 390a  mag = 99 or -99.
-00029ac0: 2020 2020 2020 2020 7265 6d6f 7665 5f62          remove_b
-00029ad0: 6164 5f64 6174 6120 3d20 2863 6174 5f64  ad_data = (cat_d
-00029ae0: 6174 612e 6c6f 635b 3a2c 2066 696c 745d  ata.loc[:, filt]
-00029af0: 2e76 616c 7565 7320 213d 202d 3939 2920  .values != -99) 
-00029b00: 2620 5c0a 2020 2020 2020 2020 2020 2020  & \.            
-00029b10: 2020 2020 2020 2020 2020 2020 2020 2863                (c
-00029b20: 6174 5f64 6174 612e 6c6f 635b 3a2c 2066  at_data.loc[:, f
-00029b30: 696c 745d 2e76 616c 7565 7320 213d 2039  ilt].values != 9
-00029b40: 3929 2026 205c 0a20 2020 2020 2020 2020  9) & \.         
-00029b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029b60: 2028 6361 745f 6461 7461 2e6c 6f63 5b3a   (cat_data.loc[:
-00029b70: 2c20 6669 6c74 5f72 6566 5d2e 7661 6c75  , filt_ref].valu
-00029b80: 6573 2021 3d20 2d39 3929 2026 205c 0a20  es != -99) & \. 
-00029b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029ba0: 2020 2020 2020 2020 2028 6361 745f 6461           (cat_da
-00029bb0: 7461 2e6c 6f63 5b3a 2c20 6669 6c74 5f72  ta.loc[:, filt_r
-00029bc0: 6566 5d2e 7661 6c75 6573 2021 3d20 3939  ef].values != 99
-00029bd0: 2920 2620 5c0a 2020 2020 2020 2020 2020  ) & \.          
-00029be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029bf0: 2863 6174 5f64 6174 612e 6c6f 635b 3a2c  (cat_data.loc[:,
-00029c00: 2066 696c 745f 7830 5d2e 7661 6c75 6573   filt_x0].values
-00029c10: 2021 3d20 2d39 3929 2026 205c 0a20 2020   != -99) & \.   
-00029c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029c30: 2020 2020 2020 2028 6361 745f 6461 7461         (cat_data
-00029c40: 2e6c 6f63 5b3a 2c20 6669 6c74 5f78 305d  .loc[:, filt_x0]
-00029c50: 2e76 616c 7565 7320 213d 2039 3929 2026  .values != 99) &
-00029c60: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
-00029c70: 2020 2020 2020 2020 2020 2020 2028 6361               (ca
-00029c80: 745f 6461 7461 2e6c 6f63 5b3a 2c20 6669  t_data.loc[:, fi
-00029c90: 6c74 5f78 315d 2e76 616c 7565 7320 213d  lt_x1].values !=
-00029ca0: 202d 3939 2920 2620 5c0a 2020 2020 2020   -99) & \.      
-00029cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029cc0: 2020 2020 2863 6174 5f64 6174 612e 6c6f      (cat_data.lo
-00029cd0: 635b 3a2c 2066 696c 745f 7831 5d2e 7661  c[:, filt_x1].va
-00029ce0: 6c75 6573 2021 3d20 3939 290a 0a20 2020  lues != 99)..   
-00029cf0: 2020 2020 2066 6f72 2062 696e 5f69 2069       for bin_i i
-00029d00: 6e20 6269 6e73 5b3a 2d31 5d3a 0a0a 2020  n bins[:-1]:..  
-00029d10: 2020 2020 2020 2020 2020 7265 6665 7265            refere
-00029d20: 6e63 655f 6269 6e5f 6375 7420 3d20 2872  nce_bin_cut = (r
-00029d30: 6566 6572 656e 6365 5f78 203e 3d20 6269  eference_x >= bi
-00029d40: 6e5f 6929 2026 205c 0a20 2020 2020 2020  n_i) & \.       
-00029d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029d60: 2020 2020 2020 2020 2028 7265 6665 7265           (refere
-00029d70: 6e63 655f 7820 3c20 6269 6e5f 6920 2b20  nce_x < bin_i + 
-00029d80: 6465 6c74 615f 6269 6e29 0a0a 2020 2020  delta_bin)..    
-00029d90: 2020 2020 2020 2020 6461 7461 5f62 696e          data_bin
-00029da0: 5f63 7574 203d 2028 6361 745f 6461 7461  _cut = (cat_data
-00029db0: 5f78 203e 3d20 6269 6e5f 6929 2026 205c  _x >= bin_i) & \
-00029dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029dd0: 2020 2020 2020 2020 2020 2020 2863 6174              (cat
-00029de0: 5f64 6174 615f 7820 3c20 6269 6e5f 6920  _data_x < bin_i 
-00029df0: 2b20 6465 6c74 615f 6269 6e29 2026 205c  + delta_bin) & \
-00029e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029e10: 2020 2020 2020 2020 2020 2020 7265 6d6f              remo
-00029e20: 7665 5f62 6164 5f64 6174 610a 0a20 2020  ve_bad_data..   
-00029e30: 2020 2020 2020 2020 2072 6566 6572 656e           referen
-00029e40: 6365 5f62 696e 5f79 203d 2072 6566 6572  ce_bin_y = refer
-00029e50: 656e 6365 2e6c 6f63 5b72 6566 6572 656e  ence.loc[referen
-00029e60: 6365 5f62 696e 5f63 7574 2c20 6669 6c74  ce_bin_cut, filt
-00029e70: 5d20 2d20 5c0a 2020 2020 2020 2020 2020  ] - \.          
-00029e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029e90: 2020 2020 7265 6665 7265 6e63 652e 6c6f      reference.lo
-00029ea0: 635b 7265 6665 7265 6e63 655f 6269 6e5f  c[reference_bin_
-00029eb0: 6375 742c 2066 696c 745f 7265 665d 0a0a  cut, filt_ref]..
-00029ec0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00029ed0: 5f62 696e 5f79 203d 2063 6174 5f64 6174  _bin_y = cat_dat
-00029ee0: 612e 6c6f 635b 6461 7461 5f62 696e 5f63  a.loc[data_bin_c
-00029ef0: 7574 2c20 6669 6c74 5d20 2d20 5c0a 2020  ut, filt] - \.  
-00029f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029f10: 2020 2020 2020 2063 6174 5f64 6174 612e         cat_data.
-00029f20: 6c6f 635b 6461 7461 5f62 696e 5f63 7574  loc[data_bin_cut
-00029f30: 2c20 6669 6c74 5f72 6566 5d0a 0a20 2020  , filt_ref]..   
-00029f40: 2020 2020 2020 2020 206d 6561 6e5f 7265           mean_re
-00029f50: 6665 7265 6e63 655f 6269 6e5f 7920 3d20  ference_bin_y = 
-00029f60: 6d65 616e 5f72 6f62 7573 7428 7265 6665  mean_robust(refe
-00029f70: 7265 6e63 655f 6269 6e5f 7929 0a0a 2020  rence_bin_y)..  
-00029f80: 2020 2020 2020 2020 2020 6375 745f 6f75            cut_ou
-00029f90: 746c 6965 7273 203d 2028 6461 7461 5f62  tliers = (data_b
-00029fa0: 696e 5f79 203e 202d 3529 2026 2028 6461  in_y > -5) & (da
-00029fb0: 7461 5f62 696e 5f79 203c 2035 290a 2020  ta_bin_y < 5).  
-00029fc0: 2020 2020 2020 2020 2020 6d65 616e 5f64            mean_d
-00029fd0: 6174 615f 6269 6e5f 7920 3d20 6d65 616e  ata_bin_y = mean
-00029fe0: 5f72 6f62 7573 7428 6461 7461 5f62 696e  _robust(data_bin
-00029ff0: 5f79 5b63 7574 5f6f 7574 6c69 6572 735d  _y[cut_outliers]
-0002a000: 2c20 302e 352c 2030 2e35 290a 0a20 2020  , 0.5, 0.5)..   
-0002a010: 2020 2020 2020 2020 2064 656c 7461 5f6d           delta_m
-0002a020: 6167 2e61 7070 656e 6428 6d65 616e 5f72  ag.append(mean_r
-0002a030: 6566 6572 656e 6365 5f62 696e 5f79 202d  eference_bin_y -
-0002a040: 206d 6561 6e5f 6461 7461 5f62 696e 5f79   mean_data_bin_y
-0002a050: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-0002a060: 2323 230a 2020 2020 2020 2020 2020 2020  ###.            
-0002a070: 7265 6665 7265 6e63 655f 6269 6e5f 795f  reference_bin_y_
-0002a080: 6c69 7374 2e61 7070 656e 6428 6d65 616e  list.append(mean
-0002a090: 5f72 6566 6572 656e 6365 5f62 696e 5f79  _reference_bin_y
-0002a0a0: 290a 2020 2020 2020 2020 2020 2020 6461  ).            da
-0002a0b0: 7461 5f62 696e 5f79 5f6c 6973 742e 6170  ta_bin_y_list.ap
-0002a0c0: 7065 6e64 286d 6561 6e5f 6461 7461 5f62  pend(mean_data_b
-0002a0d0: 696e 5f79 290a 2020 2020 2020 2020 2020  in_y).          
-0002a0e0: 2020 2323 2323 0a0a 2020 2020 2020 2020    ####..        
-0002a0f0: 2320 4361 6c63 756c 6174 6520 5a50 0a20  # Calculate ZP. 
-0002a100: 2020 2020 2020 2064 656c 7461 5f6d 6167         delta_mag
-0002a110: 203d 206e 702e 6172 7261 7928 6465 6c74   = np.array(delt
-0002a120: 615f 6d61 6729 0a0a 2020 2020 2020 2020  a_mag)..        
-0002a130: 7265 6665 7265 6e63 655f 6269 6e5f 795f  reference_bin_y_
-0002a140: 6c69 7374 203d 206e 702e 6172 7261 7928  list = np.array(
-0002a150: 7265 6665 7265 6e63 655f 6269 6e5f 795f  reference_bin_y_
-0002a160: 6c69 7374 290a 2020 2020 2020 2020 6461  list).        da
-0002a170: 7461 5f62 696e 5f79 5f6c 6973 7420 3d20  ta_bin_y_list = 
-0002a180: 6e70 2e61 7272 6179 2864 6174 615f 6269  np.array(data_bi
-0002a190: 6e5f 795f 6c69 7374 290a 0a20 2020 2020  n_y_list)..     
-0002a1a0: 2020 2023 2047 6574 206f 7264 6572 2074     # Get order t
-0002a1b0: 6f20 7265 6d6f 7665 206d 6178 2061 6e64  o remove max and
-0002a1c0: 206d 696e 2076 616c 7565 730a 2020 2020   min values.    
-0002a1d0: 2020 2020 6f20 3d20 6e70 2e61 7267 736f      o = np.argso
-0002a1e0: 7274 2864 656c 7461 5f6d 6167 290a 0a20  rt(delta_mag).. 
-0002a1f0: 2020 2020 2020 207a 705f 6469 6374 5b66         zp_dict[f
-0002a200: 696c 745d 203d 206d 6561 6e5f 726f 6275  ilt] = mean_robu
-0002a210: 7374 2864 656c 7461 5f6d 6167 5b6f 5d5b  st(delta_mag[o][
-0002a220: 313a 2d31 5d29 0a20 2020 2020 2020 2070  1:-1]).        p
-0002a230: 7269 6e74 2866 227b 6669 6c74 7d20 5a50  rint(f"{filt} ZP
-0002a240: 203d 207b 7a70 5f64 6963 745b 6669 6c74   = {zp_dict[filt
-0002a250: 5d3a 2e33 667d 2229 0a0a 2020 2020 2020  ]:.3f}")..      
-0002a260: 2020 2323 2323 2323 230a 2020 2020 2020    #######.      
-0002a270: 2020 7361 7665 5f66 6967 5f6e 616d 6520    save_fig_name 
-0002a280: 3d20 6622 7b66 6965 6c64 7d5f 7b66 696c  = f"{field}_{fil
-0002a290: 747d 5f73 746c 6f63 7573 2e70 6e67 220a  t}_stlocus.png".
-0002a2a0: 2020 2020 2020 2020 7361 7665 5f66 6967          save_fig
-0002a2b0: 5f66 696c 6520 3d20 6f73 2e70 6174 682e  _file = os.path.
-0002a2c0: 6a6f 696e 2870 6c6f 745f 7061 7468 2c20  join(plot_path, 
-0002a2d0: 7361 7665 5f66 6967 5f6e 616d 6529 0a0a  save_fig_name)..
-0002a2e0: 2020 2020 2020 2020 6966 2028 706c 6f74          if (plot
-0002a2f0: 5f70 6174 6820 6973 206e 6f74 204e 6f6e  _path is not Non
-0002a300: 6529 2061 6e64 2028 6e6f 7420 6f73 2e70  e) and (not os.p
-0002a310: 6174 682e 6578 6973 7473 2873 6176 655f  ath.exists(save_
-0002a320: 6669 675f 6669 6c65 2929 3a0a 0a20 2020  fig_file)):..   
-0002a330: 2020 2020 2020 2020 2078 203d 206e 702e           x = np.
-0002a340: 6172 7261 7928 6269 6e73 5b3a 2d31 5d29  array(bins[:-1])
-0002a350: 202b 2064 656c 7461 5f62 696e 2f32 0a0a   + delta_bin/2..
-0002a360: 2020 2020 2020 2020 2020 2020 706c 742e              plt.
-0002a370: 7363 6174 7465 7228 7265 6665 7265 6e63  scatter(referenc
-0002a380: 655f 782c 0a20 2020 2020 2020 2020 2020  e_x,.           
-0002a390: 2020 2020 2020 2020 2020 2020 2072 6566               ref
-0002a3a0: 6572 656e 6365 2e6c 6f63 5b3a 2c20 6669  erence.loc[:, fi
-0002a3b0: 6c74 5d20 2d20 7265 6665 7265 6e63 652e  lt] - reference.
-0002a3c0: 6c6f 635b 3a2c 2066 696c 745f 7265 665d  loc[:, filt_ref]
-0002a3d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002a3e0: 2020 2020 2020 2020 2020 7a6f 7264 6572            zorder
-0002a3f0: 203d 2031 2c20 616c 7068 6120 3d20 302e   = 1, alpha = 0.
-0002a400: 3032 2c20 636f 6c6f 7220 3d20 2223 3434  02, color = "#44
-0002a410: 3434 3434 2229 0a0a 2020 2020 2020 2020  4444")..        
-0002a420: 2020 2020 706c 742e 7363 6174 7465 7228      plt.scatter(
-0002a430: 785b 6f5d 5b31 3a2d 315d 2c20 7265 6665  x[o][1:-1], refe
-0002a440: 7265 6e63 655f 6269 6e5f 795f 6c69 7374  rence_bin_y_list
-0002a450: 5b6f 5d5b 313a 2d31 5d2c 0a20 2020 2020  [o][1:-1],.     
-0002a460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a470: 2020 2073 203d 2031 3030 2c20 6320 3d20     s = 100, c = 
-0002a480: 2223 3030 3030 3030 222c 207a 6f72 6465  "#000000", zorde
-0002a490: 7220 3d20 3329 0a0a 2020 2020 2020 2020  r = 3)..        
-0002a4a0: 2020 2020 706c 742e 7363 6174 7465 7228      plt.scatter(
-0002a4b0: 785b 6f5d 5b30 5d2c 2072 6566 6572 656e  x[o][0], referen
-0002a4c0: 6365 5f62 696e 5f79 5f6c 6973 745b 6f5d  ce_bin_y_list[o]
-0002a4d0: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
-0002a4e0: 2020 2020 2020 2020 2020 2020 2073 203d               s =
-0002a4f0: 2031 3030 2c20 6320 3d20 2223 3030 3030   100, c = "#0000
-0002a500: 3030 222c 206d 6172 6b65 7220 3d20 2778  00", marker = 'x
-0002a510: 272c 207a 6f72 6465 7220 3d20 3329 0a0a  ', zorder = 3)..
-0002a520: 2020 2020 2020 2020 2020 2020 706c 742e              plt.
-0002a530: 7363 6174 7465 7228 785b 6f5d 5b2d 315d  scatter(x[o][-1]
-0002a540: 2c20 7265 6665 7265 6e63 655f 6269 6e5f  , reference_bin_
-0002a550: 795f 6c69 7374 5b6f 5d5b 2d31 5d2c 0a20  y_list[o][-1],. 
-0002a560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a570: 2020 2020 2020 2073 203d 2031 3030 2c20         s = 100, 
-0002a580: 6320 3d20 2223 3030 3030 3030 222c 206d  c = "#000000", m
-0002a590: 6172 6b65 7220 3d20 2778 272c 207a 6f72  arker = 'x', zor
-0002a5a0: 6465 7220 3d20 3329 0a0a 2020 2020 2020  der = 3)..      
-0002a5b0: 2020 2020 2020 706c 742e 706c 6f74 2878        plt.plot(x
-0002a5c0: 2c20 7265 6665 7265 6e63 655f 6269 6e5f  , reference_bin_
-0002a5d0: 795f 6c69 7374 2c20 636f 6c6f 7220 3d20  y_list, color = 
-0002a5e0: 2223 3030 3030 3030 222c 207a 6f72 6465  "#000000", zorde
-0002a5f0: 7220 3d20 3429 0a0a 2020 2020 2020 2020  r = 4)..        
-0002a600: 2020 2020 785f 6461 7461 203d 2063 6174      x_data = cat
-0002a610: 5f64 6174 615f 785b 7265 6d6f 7665 5f62  _data_x[remove_b
-0002a620: 6164 5f64 6174 615d 0a20 2020 2020 2020  ad_data].       
-0002a630: 2020 2020 2079 5f64 6174 6120 3d20 6361       y_data = ca
-0002a640: 745f 6461 7461 2e6c 6f63 5b72 656d 6f76  t_data.loc[remov
-0002a650: 655f 6261 645f 6461 7461 2c20 6669 6c74  e_bad_data, filt
-0002a660: 5d20 2d20 5c0a 2020 2020 2020 2020 2020  ] - \.          
-0002a670: 2020 2020 2020 2020 2020 2063 6174 5f64             cat_d
-0002a680: 6174 612e 6c6f 635b 7265 6d6f 7665 5f62  ata.loc[remove_b
-0002a690: 6164 5f64 6174 612c 2066 696c 745f 7265  ad_data, filt_re
-0002a6a0: 665d 0a0a 2020 2020 2020 2020 2020 2020  f]..            
-0002a6b0: 706c 742e 7363 6174 7465 7228 785f 6461  plt.scatter(x_da
-0002a6c0: 7461 2c20 795f 6461 7461 2c20 6320 3d20  ta, y_data, c = 
-0002a6d0: 2223 4141 3838 3030 222c 207a 6f72 6465  "#AA8800", zorde
-0002a6e0: 723d 322c 2061 6c70 6861 3d30 2e32 290a  r=2, alpha=0.2).
-0002a6f0: 0a20 2020 2020 2020 2020 2020 2070 6c74  .            plt
-0002a700: 2e73 6361 7474 6572 2878 5b6f 5d5b 313a  .scatter(x[o][1:
-0002a710: 2d31 5d2c 2064 6174 615f 6269 6e5f 795f  -1], data_bin_y_
-0002a720: 6c69 7374 5b6f 5d5b 313a 2d31 5d2c 0a20  list[o][1:-1],. 
-0002a730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a740: 2020 2020 2020 2073 203d 2031 3030 2c20         s = 100, 
-0002a750: 6320 3d20 2223 3636 3434 3030 222c 207a  c = "#664400", z
-0002a760: 6f72 6465 7220 3d20 3529 0a0a 2020 2020  order = 5)..    
-0002a770: 2020 2020 2020 2020 706c 742e 7363 6174          plt.scat
-0002a780: 7465 7228 785b 6f5d 5b30 5d2c 2064 6174  ter(x[o][0], dat
-0002a790: 615f 6269 6e5f 795f 6c69 7374 5b6f 5d5b  a_bin_y_list[o][
-0002a7a0: 305d 2c0a 2020 2020 2020 2020 2020 2020  0],.            
-0002a7b0: 2020 2020 2020 2020 2020 2020 7320 3d20              s = 
-0002a7c0: 3130 302c 2063 203d 2022 2330 3030 3030  100, c = "#00000
-0002a7d0: 3022 2c20 6d61 726b 6572 203d 2027 7827  0", marker = 'x'
-0002a7e0: 2c20 7a6f 7264 6572 203d 2035 290a 0a20  , zorder = 5).. 
-0002a7f0: 2020 2020 2020 2020 2020 2070 6c74 2e73             plt.s
-0002a800: 6361 7474 6572 2878 5b6f 5d5b 2d31 5d2c  catter(x[o][-1],
-0002a810: 2064 6174 615f 6269 6e5f 795f 6c69 7374   data_bin_y_list
-0002a820: 5b6f 5d5b 2d31 5d2c 0a20 2020 2020 2020  [o][-1],.       
-0002a830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a840: 2073 203d 2031 3030 2c20 6320 3d20 2223   s = 100, c = "#
-0002a850: 3030 3030 3030 222c 206d 6172 6b65 7220  000000", marker 
-0002a860: 3d20 2778 272c 207a 6f72 6465 7220 3d20  = 'x', zorder = 
-0002a870: 3529 0a0a 2020 2020 2020 2020 2020 2020  5)..            
-0002a880: 706c 742e 706c 6f74 2878 2c20 6461 7461  plt.plot(x, data
-0002a890: 5f62 696e 5f79 5f6c 6973 742c 2063 6f6c  _bin_y_list, col
-0002a8a0: 6f72 203d 2022 2336 3634 3430 3022 2c20  or = "#664400", 
-0002a8b0: 7a6f 7264 6572 203d 2036 290a 0a20 2020  zorder = 6)..   
-0002a8c0: 2020 2020 2020 2020 2079 6d61 7820 3d20           ymax = 
-0002a8d0: 6e70 2e6e 616e 6d61 7828 286e 702e 6d61  np.nanmax((np.ma
-0002a8e0: 7828 7265 6665 7265 6e63 655f 6269 6e5f  x(reference_bin_
-0002a8f0: 795f 6c69 7374 292c 0a20 2020 2020 2020  y_list),.       
-0002a900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a910: 2020 206e 702e 6d61 7828 6461 7461 5f62     np.max(data_b
-0002a920: 696e 5f79 5f6c 6973 7429 2929 202b 2031  in_y_list))) + 1
-0002a930: 0a20 2020 2020 2020 2020 2020 2079 6d69  .            ymi
-0002a940: 6e20 3d20 6e70 2e6e 616e 6d69 6e28 286e  n = np.nanmin((n
-0002a950: 702e 6d69 6e28 7265 6665 7265 6e63 655f  p.min(reference_
-0002a960: 6269 6e5f 795f 6c69 7374 292c 0a20 2020  bin_y_list),.   
-0002a970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a980: 2020 2020 2020 206e 702e 6d69 6e28 6461         np.min(da
-0002a990: 7461 5f62 696e 5f79 5f6c 6973 7429 2929  ta_bin_y_list)))
-0002a9a0: 202d 2031 0a0a 2020 2020 2020 2020 2020   - 1..          
-0002a9b0: 2020 706c 742e 6763 6128 292e 7365 745f    plt.gca().set_
-0002a9c0: 786c 6162 656c 2866 227b 6669 6c74 5f78  xlabel(f"{filt_x
-0002a9d0: 307d 202d 207b 6669 6c74 5f78 317d 2229  0} - {filt_x1}")
-0002a9e0: 0a20 2020 2020 2020 2020 2020 2070 6c74  .            plt
-0002a9f0: 2e67 6361 2829 2e73 6574 5f79 6c61 6265  .gca().set_ylabe
-0002aa00: 6c28 6622 7b66 696c 747d 202d 207b 6669  l(f"{filt} - {fi
-0002aa10: 6c74 5f72 6566 7d22 290a 2020 2020 2020  lt_ref}").      
-0002aa20: 2020 2020 2020 706c 742e 6763 6128 292e        plt.gca().
-0002aa30: 7365 745f 796c 696d 2828 796d 696e 2c20  set_ylim((ymin, 
-0002aa40: 796d 6178 2929 0a20 2020 2020 2020 2020  ymax)).         
-0002aa50: 2020 2070 6c74 2e67 6361 2829 2e73 6574     plt.gca().set
-0002aa60: 5f78 6c69 6d28 636f 6c6f 725f 7261 6e67  _xlim(color_rang
-0002aa70: 6529 0a20 2020 2020 2020 2020 2020 2070  e).            p
-0002aa80: 6c74 2e73 6176 6566 6967 2873 6176 655f  lt.savefig(save_
-0002aa90: 6669 675f 6669 6c65 290a 2020 2020 2020  fig_file).      
-0002aaa0: 2020 2020 2020 706c 742e 636c 6628 290a        plt.clf().
-0002aab0: 2020 2020 2020 2020 2020 2020 706c 742e              plt.
-0002aac0: 636c 6f73 6528 290a 2020 2020 2020 2020  close().        
-0002aad0: 2020 2020 2323 2323 2323 230a 0a20 2020      #######..   
-0002aae0: 2023 2057 7269 7465 207a 6572 6f2d 706f   # Write zero-po
-0002aaf0: 696e 7473 2074 6f20 2e7a 7020 6669 6c65  ints to .zp file
-0002ab00: 0a20 2020 207a 705f 7772 6974 6528 7a70  .    zp_write(zp
-0002ab10: 5f64 6963 743d 7a70 5f64 6963 742c 0a20  _dict=zp_dict,. 
-0002ab20: 2020 2020 2020 2020 2020 2020 7361 7665              save
-0002ab30: 5f66 696c 653d 7361 7665 5f66 696c 652c  _file=save_file,
-0002ab40: 0a20 2020 2020 2020 2020 2020 2020 6669  .             fi
-0002ab50: 6c74 6572 735f 6c69 7374 3d66 696c 7473  lters_list=filts
-0002ab60: 5f74 6f5f 6765 745f 7a70 290a 0a0a 6465  _to_get_zp)...de
-0002ab70: 6620 7a70 5f63 6f6d 7061 7269 736f 6e28  f zp_comparison(
-0002ab80: 6669 656c 6473 5f7a 7073 2c20 7361 7665  fields_zps, save
-0002ab90: 5f66 696c 652c 2066 6965 6c64 735f 6c69  _file, fields_li
-0002aba0: 7374 293a 0a20 2020 2022 2222 0a20 2020  st):.    """.   
-0002abb0: 2043 7265 6174 6573 2061 2063 6f6d 7061   Creates a compa
-0002abc0: 7269 736f 6e20 6669 6c65 2062 6574 7765  rison file betwe
-0002abd0: 656e 2074 776f 207a 6572 6f20 706f 696e  en two zero poin
-0002abe0: 7473 2063 616c 6962 7261 7469 6f6e 7320  ts calibrations 
-0002abf0: 666f 7220 6120 6c69 7374 0a20 2020 206f  for a list.    o
-0002ac00: 6620 6669 656c 6473 0a0a 2020 2020 5061  f fields..    Pa
-0002ac10: 7261 6d65 7465 7273 0a20 2020 202d 2d2d  rameters.    ---
-0002ac20: 2d2d 2d2d 2d2d 2d0a 2020 2020 6669 656c  -------.    fiel
-0002ac30: 6473 5f7a 7073 203a 2064 6963 740a 2020  ds_zps : dict.  
-0002ac40: 2020 2020 2020 4469 6374 696f 6e61 7279        Dictionary
-0002ac50: 2066 6f72 6d61 7465 6420 6173 2066 6965   formated as fie
-0002ac60: 6c64 735f 7a70 735b 2a66 6965 6c64 2a5d  lds_zps[*field*]
-0002ac70: 203d 205b 7a70 5f66 696c 6531 2c20 7a70   = [zp_file1, zp
-0002ac80: 5f66 696c 6532 5d2c 0a20 2020 2020 2020  _file2],.       
-0002ac90: 2077 6865 7265 207a 705f 6669 6c65 2063   where zp_file c
-0002aca0: 6f72 7265 7370 6f6e 6473 2074 6f20 7468  orresponds to th
-0002acb0: 6520 2e7a 7020 6669 6c65 206f 6620 6561  e .zp file of ea
-0002acc0: 6368 2063 616c 6962 7261 7469 6f6e 2074  ch calibration t
-0002acd0: 6f0a 2020 2020 2020 2020 636f 6d70 6172  o.        compar
-0002ace0: 650a 2020 2020 6669 656c 6473 5f6c 6973  e.    fields_lis
-0002acf0: 7420 3a20 6c69 7374 0a20 2020 2020 2020  t : list.       
-0002ad00: 204c 6973 7420 6f66 2066 696c 7465 7273   List of filters
-0002ad10: 2e20 4966 204e 6f6e 6520 7468 6520 6c69  . If None the li
-0002ad20: 7374 2069 7320 7461 6b69 6e67 2066 726f  st is taking fro
-0002ad30: 6d20 6669 656c 6473 5f7a 7073 2e6b 6579  m fields_zps.key
-0002ad40: 7328 292c 0a20 2020 2020 2020 2061 6c74  s(),.        alt
-0002ad50: 686f 7567 6820 696e 2074 6869 7320 6361  hough in this ca
-0002ad60: 7365 2074 6865 206f 7264 6572 206f 6620  se the order of 
-0002ad70: 7468 6520 6669 656c 6473 2077 696c 6c20  the fields will 
-0002ad80: 6265 2072 616e 646f 6d69 7a65 640a 2020  be randomized.  
-0002ad90: 2020 7361 7665 5f66 696c 6520 3a20 7374    save_file : st
-0002ada0: 720a 2020 2020 2020 2020 4c6f 6361 7469  r.        Locati
-0002adb0: 6f6e 2074 6f20 7361 7665 2074 6865 2072  on to save the r
-0002adc0: 6573 756c 7469 6e67 2063 6f6d 7061 7269  esulting compari
-0002add0: 736f 6e20 6669 6c65 0a0a 2020 2020 5265  son file..    Re
-0002ade0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-0002adf0: 2d0a 2020 2020 5361 7665 7320 6120 2e63  -.    Saves a .c
-0002ae00: 6174 2074 6162 6c65 2077 6974 6820 7a65  at table with ze
-0002ae10: 726f 2070 6f69 6e74 7320 6672 6f6d 2062  ro points from b
-0002ae20: 6f74 6820 6361 6c69 6272 6174 696f 6e73  oth calibrations
-0002ae30: 2061 6e64 2074 6865 6972 0a20 2020 2064   and their.    d
-0002ae40: 6966 6665 7265 6e63 6573 0a20 2020 2022  ifferences.    "
-0002ae50: 2222 0a0a 2020 2020 2323 2323 2323 2323  ""..    ########
-0002ae60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002ae70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002ae80: 230a 2020 2020 2320 4765 7420 6c69 7374  #.    # Get list
-0002ae90: 206f 6620 6669 6c74 6572 7320 6672 6f6d   of filters from
-0002aea0: 2066 6972 7374 202e 7a70 2066 696c 650a   first .zp file.
-0002aeb0: 2020 2020 6669 656c 6430 2020 203d 206c      field0   = l
-0002aec0: 6973 7428 6669 656c 6473 5f7a 7073 2e6b  ist(fields_zps.k
-0002aed0: 6579 7328 2929 5b30 5d0a 2020 2020 7a70  eys())[0].    zp
-0002aee0: 5f66 696c 6530 203d 2066 6965 6c64 735f  _file0 = fields_
-0002aef0: 7a70 735b 6669 656c 6430 5d5b 305d 0a0a  zps[field0][0]..
-0002af00: 2020 2020 6669 6c74 6572 7320 3d20 6e70      filters = np
-0002af10: 2e67 656e 6672 6f6d 7478 7428 7a70 5f66  .genfromtxt(zp_f
-0002af20: 696c 6530 2c20 6474 7970 653d 7374 722c  ile0, dtype=str,
-0002af30: 2075 7365 636f 6c73 3d5b 305d 290a 0a20   usecols=[0]).. 
-0002af40: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-0002af50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002af60: 230a 2020 2020 2320 4372 6561 7465 2063  #.    # Create c
-0002af70: 6f6d 7061 7269 736f 6e20 6461 7461 2066  omparison data f
-0002af80: 7261 6d65 0a20 2020 2069 6620 6669 656c  rame.    if fiel
-0002af90: 6473 5f6c 6973 7420 6973 204e 6f6e 653a  ds_list is None:
-0002afa0: 0a20 2020 2020 2020 2066 6965 6c64 7320  .        fields 
-0002afb0: 3d20 6669 656c 6473 5f7a 7073 2e6b 6579  = fields_zps.key
-0002afc0: 7328 290a 2020 2020 656c 7365 3a0a 2020  s().    else:.  
-0002afd0: 2020 2020 2020 6669 656c 6473 203d 2066        fields = f
-0002afe0: 6965 6c64 735f 6c69 7374 0a0a 2020 2020  ields_list..    
-0002aff0: 7a70 5f64 6174 6120 3d20 7064 2e44 6174  zp_data = pd.Dat
-0002b000: 6146 7261 6d65 2829 0a0a 2020 2020 7a70  aFrame()..    zp
-0002b010: 5f64 6174 615b 2766 6965 6c64 275d 203d  _data['field'] =
-0002b020: 2066 6965 6c64 730a 2020 2020 666f 7220   fields.    for 
-0002b030: 6669 6c74 2069 6e20 6669 6c74 6572 733a  filt in filters:
-0002b040: 0a20 2020 2020 2020 207a 705f 6461 7461  .        zp_data
-0002b050: 5b66 277a 705f 7b66 696c 747d 5f31 275d  [f'zp_{filt}_1']
-0002b060: 203d 206e 702e 6675 6c6c 286c 656e 2866   = np.full(len(f
-0002b070: 6965 6c64 7329 2c20 6e70 2e6e 616e 290a  ields), np.nan).
-0002b080: 2020 2020 2020 2020 7a70 5f64 6174 615b          zp_data[
-0002b090: 6627 7a70 5f7b 6669 6c74 7d5f 3227 5d20  f'zp_{filt}_2'] 
-0002b0a0: 3d20 6e70 2e66 756c 6c28 6c65 6e28 6669  = np.full(len(fi
-0002b0b0: 656c 6473 292c 206e 702e 6e61 6e29 0a20  elds), np.nan). 
-0002b0c0: 2020 2020 2020 207a 705f 6461 7461 5b66         zp_data[f
-0002b0d0: 277a 705f 7b66 696c 747d 5f64 6966 6627  'zp_{filt}_diff'
-0002b0e0: 5d20 3d20 6e70 2e66 756c 6c28 6c65 6e28  ] = np.full(len(
-0002b0f0: 6669 656c 6473 292c 206e 702e 6e61 6e29  fields), np.nan)
-0002b100: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
-0002b110: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002b120: 2323 0a20 2020 2023 2046 696c 6c20 636f  ##.    # Fill co
-0002b130: 6d70 6172 6973 6f6e 2064 6174 6120 6672  mparison data fr
-0002b140: 616d 650a 2020 2020 666f 7220 6920 696e  ame.    for i in
-0002b150: 2072 616e 6765 286c 656e 2866 6965 6c64   range(len(field
-0002b160: 7329 293a 0a0a 2020 2020 2020 2020 6669  s)):..        fi
-0002b170: 656c 6420 3d20 6669 656c 6473 5b69 5d0a  eld = fields[i].
-0002b180: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0002b190: 2020 2020 2020 2020 207a 7031 203d 207a           zp1 = z
-0002b1a0: 705f 7265 6164 2866 6965 6c64 735f 7a70  p_read(fields_zp
-0002b1b0: 735b 6669 656c 645d 5b30 5d29 0a20 2020  s[field][0]).   
-0002b1c0: 2020 2020 2065 7863 6570 7420 4f53 4572       except OSEr
-0002b1d0: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-0002b1e0: 207a 7031 203d 204e 6f6e 650a 0a20 2020   zp1 = None..   
-0002b1f0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0002b200: 2020 2020 2020 7a70 3220 3d20 7a70 5f72        zp2 = zp_r
-0002b210: 6561 6428 6669 656c 6473 5f7a 7073 5b66  ead(fields_zps[f
-0002b220: 6965 6c64 5d5b 315d 290a 2020 2020 2020  ield][1]).      
-0002b230: 2020 6578 6365 7074 204f 5345 7272 6f72    except OSError
-0002b240: 3a0a 2020 2020 2020 2020 2020 2020 7a70  :.            zp
-0002b250: 3220 3d20 4e6f 6e65 0a0a 2020 2020 2020  2 = None..      
-0002b260: 2020 666f 7220 6669 6c74 2069 6e20 6669    for filt in fi
-0002b270: 6c74 6572 733a 0a0a 2020 2020 2020 2020  lters:..        
-0002b280: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0002b290: 2020 2020 2020 2020 207a 705f 6461 7461           zp_data
-0002b2a0: 2e6c 6f63 5b69 2c20 6627 7a70 5f7b 6669  .loc[i, f'zp_{fi
-0002b2b0: 6c74 7d5f 3127 5d20 3d20 7a70 315b 6669  lt}_1'] = zp1[fi
-0002b2c0: 6c74 5d0a 2020 2020 2020 2020 2020 2020  lt].            
-0002b2d0: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
-0002b2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b2f0: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
-0002b300: 2020 6578 6365 7074 2054 7970 6545 7272    except TypeErr
-0002b310: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-0002b320: 2020 2020 7061 7373 0a0a 2020 2020 2020      pass..      
-0002b330: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0002b340: 2020 2020 2020 2020 2020 207a 705f 6461             zp_da
-0002b350: 7461 2e6c 6f63 5b69 2c20 6627 7a70 5f7b  ta.loc[i, f'zp_{
-0002b360: 6669 6c74 7d5f 3227 5d20 3d20 7a70 325b  filt}_2'] = zp2[
-0002b370: 6669 6c74 5d0a 2020 2020 2020 2020 2020  filt].          
-0002b380: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
-0002b390: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0002b3a0: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
-0002b3b0: 2020 2020 6578 6365 7074 2054 7970 6545      except TypeE
-0002b3c0: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-0002b3d0: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
-0002b3e0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0002b3f0: 2020 2020 2020 2020 2020 2020 2064 6966               dif
-0002b400: 6620 3d20 7a70 315b 6669 6c74 5d20 2d20  f = zp1[filt] - 
-0002b410: 7a70 325b 6669 6c74 5d0a 2020 2020 2020  zp2[filt].      
-0002b420: 2020 2020 2020 2020 2020 7a70 5f64 6174            zp_dat
-0002b430: 612e 6c6f 635b 692c 2066 277a 705f 7b66  a.loc[i, f'zp_{f
-0002b440: 696c 747d 5f64 6966 6627 5d20 3d20 6e70  ilt}_diff'] = np
-0002b450: 2e61 726f 756e 6428 6469 6666 2c20 3529  .around(diff, 5)
-0002b460: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0002b470: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
-0002b480: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-0002b490: 7373 0a20 2020 2020 2020 2020 2020 2065  ss.            e
-0002b4a0: 7863 6570 7420 5479 7065 4572 726f 723a  xcept TypeError:
-0002b4b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b4c0: 2070 6173 730a 0a20 2020 2023 2323 2323   pass..    #####
-0002b4d0: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
-0002b4e0: 2023 2053 6176 6520 6461 7461 2066 7261   # Save data fra
-0002b4f0: 6d65 0a20 2020 2077 6974 6820 6f70 656e  me.    with open
-0002b500: 2873 6176 655f 6669 6c65 2c20 2777 2729  (save_file, 'w')
-0002b510: 2061 7320 663a 0a20 2020 2020 2020 2066   as f:.        f
-0002b520: 2e77 7269 7465 2822 2320 2229 0a20 2020  .write("# ").   
-0002b530: 2020 2020 207a 705f 6461 7461 2e74 6f5f       zp_data.to_
-0002b540: 6373 7628 662c 2069 6e64 6578 203d 2046  csv(f, index = F
-0002b550: 616c 7365 2c20 7365 7020 3d20 222c 2229  alse, sep = ",")
-0002b560: 0a0a 0a64 6566 207a 705f 6669 745f 6f66  ...def zp_fit_of
-0002b570: 6673 6574 7328 7a70 5f63 6f6d 7061 7269  fsets(zp_compari
-0002b580: 736f 6e5f 6669 6c65 2c20 7361 7665 5f66  son_file, save_f
-0002b590: 696c 652c 2066 696c 7465 7273 293a 0a20  ile, filters):. 
-0002b5a0: 2020 2022 2222 0a20 2020 2066 6974 206f     """.    fit o
-0002b5b0: 6666 7365 7473 2062 6574 7765 656e 2074  ffsets between t
-0002b5c0: 6865 207a 6572 6f2d 706f 696e 7473 206f  he zero-points o
-0002b5d0: 6274 6169 6e65 6420 6672 6f6d 2074 776f  btained from two
-0002b5e0: 2064 6966 6665 7265 6e74 2063 616c 6962   different calib
-0002b5f0: 7261 7469 6f6e 730a 0a20 2020 2050 6172  rations..    Par
-0002b600: 616d 6574 6572 730a 2020 2020 2d2d 2d2d  ameters.    ----
-0002b610: 2d2d 2d2d 2d2d 0a20 2020 207a 705f 636f  ------.    zp_co
-0002b620: 6d70 6172 6973 6f6e 5f66 696c 6520 3a20  mparison_file : 
-0002b630: 7374 720a 2020 2020 2020 2020 4c6f 6361  str.        Loca
-0002b640: 7469 6f6e 206f 6620 7468 6520 2e63 6174  tion of the .cat
-0002b650: 207a 6572 6f2d 706f 696e 7420 636f 6d70   zero-point comp
-0002b660: 6172 6973 6f6e 2063 6174 616c 6f67 0a20  arison catalog. 
-0002b670: 2020 2020 2020 2028 6f75 7470 7574 206f         (output o
-0002b680: 6620 6675 6e63 3a7a 705f 636f 6d70 6172  f func:zp_compar
-0002b690: 6973 6f6e 290a 0a20 2020 2073 6176 655f  ison)..    save_
-0002b6a0: 6669 6c65 203a 2073 7472 0a20 2020 2020  file : str.     
-0002b6b0: 2020 204c 6f63 6174 696f 6e20 746f 2073     Location to s
-0002b6c0: 6176 6520 6f66 6673 6574 207a 7020 6669  ave offset zp fi
-0002b6d0: 6c65 0a0a 2020 2020 6669 6c74 6572 7320  le..    filters 
-0002b6e0: 3a20 6c69 7374 0a20 2020 2020 2020 204c  : list.        L
-0002b6f0: 6973 7420 6f66 2066 696c 7465 7273 2074  ist of filters t
-0002b700: 6f20 6573 7469 6d61 7465 206f 6666 7365  o estimate offse
-0002b710: 7473 0a0a 2020 2020 5265 7475 726e 730a  ts..    Returns.
-0002b720: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-0002b730: 5361 7665 7320 2e7a 7020 6669 6c65 2077  Saves .zp file w
-0002b740: 6974 6820 7468 6520 6f66 6673 6574 7320  ith the offsets 
-0002b750: 746f 2062 6520 6170 706c 6965 640a 2020  to be applied.  
-0002b760: 2020 2222 220a 0a20 2020 206f 6666 7365    """..    offse
-0002b770: 7473 203d 207b 7d0a 2020 2020 7a70 5f64  ts = {}.    zp_d
-0002b780: 6966 6620 3d20 7064 2e72 6561 645f 6373  iff = pd.read_cs
-0002b790: 7628 7a70 5f63 6f6d 7061 7269 736f 6e5f  v(zp_comparison_
-0002b7a0: 6669 6c65 2c20 6573 6361 7065 6368 6172  file, escapechar
-0002b7b0: 3d27 2327 2c0a 2020 2020 2020 2020 2020  ='#',.          
-0002b7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b7d0: 2020 2020 2073 6b69 7069 6e69 7469 616c       skipinitial
-0002b7e0: 7370 6163 653d 5472 7565 290a 0a20 2020  space=True)..   
-0002b7f0: 2066 6f72 2066 696c 7420 696e 2066 696c   for filt in fil
-0002b800: 7465 7273 3a0a 2020 2020 2020 2020 6469  ters:.        di
-0002b810: 6666 5f61 7272 6179 203d 206e 702e 6172  ff_array = np.ar
-0002b820: 7261 7928 7a70 5f64 6966 665b 6627 7a70  ray(zp_diff[f'zp
-0002b830: 5f7b 6669 6c74 7d5f 6469 6666 275d 290a  _{filt}_diff']).
-0002b840: 2020 2020 2020 2020 6469 6666 5f61 7272          diff_arr
-0002b850: 6179 203d 2064 6966 665f 6172 7261 795b  ay = diff_array[
-0002b860: 7e6e 702e 6973 6e61 6e28 6469 6666 5f61  ~np.isnan(diff_a
-0002b870: 7272 6179 295d 0a20 2020 2020 2020 2064  rray)].        d
-0002b880: 6966 665f 6172 7261 7920 3d20 6469 6666  iff_array = diff
-0002b890: 5f61 7272 6179 2e72 6573 6861 7065 282d  _array.reshape(-
-0002b8a0: 312c 2031 290a 0a20 2020 2020 2020 206b  1, 1)..        k
-0002b8b0: 6465 5f64 656e 7320 3d20 4b65 726e 656c  de_dens = Kernel
-0002b8c0: 4465 6e73 6974 7928 6b65 726e 656c 3d27  Density(kernel='
-0002b8d0: 6761 7573 7369 616e 272c 2062 616e 6477  gaussian', bandw
-0002b8e0: 6964 7468 3d30 2e30 3529 0a20 2020 2020  idth=0.05).     
-0002b8f0: 2020 206b 6465 5f64 656e 7320 3d20 6b64     kde_dens = kd
-0002b900: 655f 6465 6e73 2e66 6974 2864 6966 665f  e_dens.fit(diff_
-0002b910: 6172 7261 7929 0a0a 2020 2020 2020 2020  array)..        
-0002b920: 2320 5472 616e 7366 6f72 6d20 746f 206b  # Transform to k
-0002b930: 6465 0a20 2020 2020 2020 2078 203d 206e  de.        x = n
-0002b940: 702e 6172 616e 6765 282d 312c 2031 2c20  p.arange(-1, 1, 
-0002b950: 302e 3030 3129 0a20 2020 2020 2020 2079  0.001).        y
-0002b960: 203d 206e 702e 6578 7028 6b64 655f 6465   = np.exp(kde_de
-0002b970: 6e73 2e73 636f 7265 5f73 616d 706c 6573  ns.score_samples
-0002b980: 2878 2e72 6573 6861 7065 282d 312c 2031  (x.reshape(-1, 1
-0002b990: 2929 290a 0a20 2020 2020 2020 2023 2067  )))..        # g
-0002b9a0: 6574 206d 6f64 650a 2020 2020 2020 2020  et mode.        
-0002b9b0: 6d6f 6465 203d 2078 5b79 203d 3d20 6e70  mode = x[y == np
-0002b9c0: 2e6d 6178 2879 295d 5b30 5d0a 0a20 2020  .max(y)][0]..   
-0002b9d0: 2020 2020 206f 6666 7365 7473 5b66 696c       offsets[fil
-0002b9e0: 745d 203d 206d 6f64 650a 0a20 2020 207a  t] = mode..    z
-0002b9f0: 705f 7772 6974 6528 7a70 5f64 6963 743d  p_write(zp_dict=
-0002ba00: 6f66 6673 6574 732c 0a20 2020 2020 2020  offsets,.       
-0002ba10: 2020 2020 2020 7361 7665 5f66 696c 653d        save_file=
-0002ba20: 7361 7665 5f66 696c 652c 0a20 2020 2020  save_file,.     
-0002ba30: 2020 2020 2020 2020 6669 6c74 6572 735f          filters_
-0002ba40: 6c69 7374 3d66 696c 7465 7273 290a 0a0a  list=filters)...
+00027660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027670: 2063 7574 3d5b 6d61 675f 6c2c 206d 6167   cut=[mag_l, mag
+00027680: 5f75 5d29 0a0a 2020 2020 2020 2020 7a70  _u])..        zp
+00027690: 5f64 6963 745b 6669 6c74 5d20 3d20 6669  _dict[filt] = fi
+000276a0: 6c74 5f7a 700a 0a20 2020 2020 2020 2064  lt_zp..        d
+000276b0: 6174 612e 6c6f 635b 3a2c 2066 227b 6669  ata.loc[:, f"{fi
+000276c0: 6c74 7d22 5d20 3d20 6461 7461 2e6c 6f63  lt}"] = data.loc
+000276d0: 5b3a 2c20 6622 7b66 696c 747d 225d 202b  [:, f"{filt}"] +
+000276e0: 2066 696c 745f 7a70 0a0a 2020 2020 2020   filt_zp..      
+000276f0: 2020 7072 696e 7428 227b 7d20 5a50 203d    print("{} ZP =
+00027700: 207b 3a2e 3366 7d22 2e66 6f72 6d61 7428   {:.3f}".format(
+00027710: 6622 7b66 696c 747d 222c 2066 696c 745f  f"{filt}", filt_
+00027720: 7a70 2929 0a0a 2020 2020 2320 5361 7669  zp))..    # Savi
+00027730: 6e67 2064 6174 610a 2020 2020 7a70 5f77  ng data.    zp_w
+00027740: 7269 7465 287a 705f 6469 6374 3d7a 705f  rite(zp_dict=zp_
+00027750: 6469 6374 2c20 7361 7665 5f66 696c 653d  dict, save_file=
+00027760: 7361 7665 5f66 696c 652c 2066 696c 7465  save_file, filte
+00027770: 7273 5f6c 6973 743d 6669 6c74 6572 735f  rs_list=filters_
+00027780: 6c69 7374 290a 0a0a 6465 6620 7a70 5f67  list)...def zp_g
+00027790: 6169 6173 6361 6c65 2867 6169 615f 7a70  aiascale(gaia_zp
+000277a0: 5f66 696c 652c 2073 6176 655f 6669 6c65  _file, save_file
+000277b0: 2c20 6669 6c74 6572 735f 6c69 7374 293a  , filters_list):
+000277c0: 0a20 2020 2022 2222 0a20 2020 204f 6274  .    """.    Obt
+000277d0: 6169 6e20 6761 6961 7363 616c 6520 7a65  ain gaiascale ze
+000277e0: 726f 2d70 6f69 6e74 7320 6672 6f6d 2074  ro-points from t
+000277f0: 6865 2067 6169 6120 7a65 726f 2070 6f69  he gaia zero poi
+00027800: 6e74 7320 6573 7469 6d61 7465 6420 636f  nts estimated co
+00027810: 6d70 6172 696e 670a 2020 2020 6361 7461  mparing.    cata
+00027820: 6c6f 6720 616e 6420 6d6f 6465 6c20 7072  log and model pr
+00027830: 6564 6963 7465 6420 6d61 676e 6974 7564  edicted magnitud
+00027840: 6573 2e0a 0a20 2020 2066 6f72 2065 6163  es...    for eac
+00027850: 6820 6669 6c74 6572 2069 6e20 6669 6c74  h filter in filt
+00027860: 6572 735f 6c69 7374 3a0a 2020 2020 6761  ers_list:.    ga
+00027870: 6961 5f73 6361 6c65 5f7a 7020 3d20 2d6d  ia_scale_zp = -m
+00027880: 6561 6e28 6761 6961 5f66 696c 7465 725f  ean(gaia_filter_
+00027890: 7a70 7329 0a0a 2020 2020 5061 7261 6d65  zps)..    Parame
+000278a0: 7465 7273 0a20 2020 202d 2d2d 2d2d 2d2d  ters.    -------
+000278b0: 2d2d 2d0a 2020 2020 6761 6961 5f7a 705f  ---.    gaia_zp_
+000278c0: 6669 6c65 203a 2073 7472 0a20 2020 2020  file : str.     
+000278d0: 2020 207a 7020 6669 6c65 206f 6620 6761     zp file of ga
+000278e0: 6961 2066 696c 7465 7273 0a20 2020 2073  ia filters.    s
+000278f0: 6176 655f 6669 6c65 203a 2073 7472 0a20  ave_file : str. 
+00027900: 2020 2020 2020 204c 6f63 6174 696f 6e20         Location 
+00027910: 746f 2073 6176 6520 7468 6520 6573 7469  to save the esti
+00027920: 6d61 7465 6420 6761 6961 2073 6361 6c65  mated gaia scale
+00027930: 207a 6572 6f2d 706f 696e 7473 0a20 2020   zero-points.   
+00027940: 2066 696c 7465 7273 5f6c 6973 7420 3a20   filters_list : 
+00027950: 6c69 7374 0a20 2020 2020 2020 204c 6973  list.        Lis
+00027960: 7420 6f66 2066 696c 7465 7273 2074 6f20  t of filters to 
+00027970: 6573 7469 6d61 7465 2074 6865 207a 6572  estimate the zer
+00027980: 6f2d 706f 696e 7473 0a0a 2020 2020 5265  o-points..    Re
+00027990: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+000279a0: 2d0a 2020 2020 5361 7665 7320 7468 6520  -.    Saves the 
+000279b0: 7a65 726f 2d70 6f69 6e74 7320 696e 2061  zero-points in a
+000279c0: 202e 7a70 2066 696c 650a 2020 2020 2222   .zp file.    ""
+000279d0: 220a 0a20 2020 2067 6169 615f 7a70 7320  "..    gaia_zps 
+000279e0: 3d20 7a70 5f72 6561 6428 6761 6961 5f7a  = zp_read(gaia_z
+000279f0: 705f 6669 6c65 290a 0a20 2020 2070 7269  p_file)..    pri
+00027a00: 6e74 2822 5c6e 5c6e 4f62 7461 696e 696e  nt("\n\nObtainin
+00027a10: 6720 6761 6961 2073 6361 6c65 205a 5073  g gaia scale ZPs
+00027a20: 5c6e 5c6e 2229 0a20 2020 2067 6169 615f  \n\n").    gaia_
+00027a30: 7363 616c 655f 7a70 203d 202d 6e70 2e6d  scale_zp = -np.m
+00027a40: 6561 6e28 6c69 7374 2867 6169 615f 7a70  ean(list(gaia_zp
+00027a50: 732e 7661 6c75 6573 2829 2929 0a0a 2020  s.values()))..  
+00027a60: 2020 2320 4164 6469 6e67 2074 6f20 7468    # Adding to th
+00027a70: 6520 6469 6374 696f 6e61 7279 0a20 2020  e dictionary.   
+00027a80: 2073 706c 7573 5f7a 705f 6469 6374 203d   splus_zp_dict =
+00027a90: 207b 7d0a 0a20 2020 2066 6f72 2066 696c   {}..    for fil
+00027aa0: 7420 696e 2066 696c 7465 7273 5f6c 6973  t in filters_lis
+00027ab0: 743a 0a20 2020 2020 2020 2073 706c 7573  t:.        splus
+00027ac0: 5f7a 705f 6469 6374 5b66 696c 745d 203d  _zp_dict[filt] =
+00027ad0: 2067 6169 615f 7363 616c 655f 7a70 0a0a   gaia_scale_zp..
+00027ae0: 2020 2020 2020 2020 7072 696e 7428 227b          print("{
+00027af0: 7d20 5a50 203d 207b 3a2e 3366 7d22 2e66  } ZP = {:.3f}".f
+00027b00: 6f72 6d61 7428 6622 7b66 696c 747d 222c  ormat(f"{filt}",
+00027b10: 2067 6169 615f 7363 616c 655f 7a70 2929   gaia_scale_zp))
+00027b20: 0a0a 2020 2020 2320 5361 7669 6e67 2064  ..    # Saving d
+00027b30: 6174 610a 2020 2020 7a70 5f77 7269 7465  ata.    zp_write
+00027b40: 287a 705f 6469 6374 3d73 706c 7573 5f7a  (zp_dict=splus_z
+00027b50: 705f 6469 6374 2c0a 2020 2020 2020 2020  p_dict,.        
+00027b60: 2020 2020 2073 6176 655f 6669 6c65 3d73       save_file=s
+00027b70: 6176 655f 6669 6c65 2c0a 2020 2020 2020  ave_file,.      
+00027b80: 2020 2020 2020 2066 696c 7465 7273 5f6c         filters_l
+00027b90: 6973 743d 6669 6c74 6572 735f 6c69 7374  ist=filters_list
+00027ba0: 290a 0a64 6566 207a 705f 6170 706c 7928  )..def zp_apply(
+00027bb0: 6361 7461 6c6f 672c 2073 6176 655f 6669  catalog, save_fi
+00027bc0: 6c65 2c20 7a70 5f66 696c 652c 2066 6d74  le, zp_file, fmt
+00027bd0: 203d 2022 6173 6369 6922 2c20 7a70 5f69   = "ascii", zp_i
+00027be0: 6e73 7420 3d20 4e6f 6e65 293a 0a20 2020  nst = None):.   
+00027bf0: 2022 2222 0a20 2020 2041 7070 6c69 6573   """.    Applies
+00027c00: 2074 6865 207a 6572 6f2d 706f 696e 7473   the zero-points
+00027c10: 2074 6f20 7468 6520 6d61 676e 6974 7564   to the magnitud
+00027c20: 6573 2063 6174 616c 6f67 0a0a 2020 2020  es catalog..    
+00027c30: 5061 7261 6d65 7465 7273 0a20 2020 202d  Parameters.    -
+00027c40: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 6361  ---------.    ca
+00027c50: 7461 6c6f 6720 3a20 7374 720a 2020 2020  talog : str.    
+00027c60: 2020 2020 4c6f 6361 7469 6f6e 206f 6620      Location of 
+00027c70: 7468 6520 6361 7461 6c6f 670a 2020 2020  the catalog.    
+00027c80: 7361 7665 5f66 696c 6520 3a20 7374 720a  save_file : str.
+00027c90: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
+00027ca0: 2074 6f20 7361 7665 2074 6865 2063 6174   to save the cat
+00027cb0: 616c 6f67 2077 6974 6820 7a65 726f 2d70  alog with zero-p
+00027cc0: 6f69 6e74 7320 6170 706c 6965 640a 2020  oints applied.  
+00027cd0: 2020 7a70 5f66 696c 6520 3a20 7374 720a    zp_file : str.
+00027ce0: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
+00027cf0: 2074 6f20 7468 6520 2e7a 7020 6669 6c65   to the .zp file
+00027d00: 2077 6974 6820 7468 6520 7a65 726f 2d70   with the zero-p
+00027d10: 6f69 6e74 730a 2020 2020 666d 7420 3a20  oints.    fmt : 
+00027d20: 7374 720a 2020 2020 2020 2020 4f75 7470  str.        Outp
+00027d30: 7574 2066 6f72 6d61 740a 2020 2020 7a70  ut format.    zp
+00027d40: 5f69 6e73 7420 3a20 666c 6f61 740a 2020  _inst : float.  
+00027d50: 2020 2020 2020 436f 6e73 7461 6e74 207a        Constant z
+00027d60: 7020 746f 2062 6520 6164 6465 6420 746f  p to be added to
+00027d70: 2061 6c6c 2066 696c 7465 7273 2e20 4465   all filters. De
+00027d80: 6661 756c 7420 3d20 4e6f 6e65 0a0a 2020  fault = None..  
+00027d90: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+00027da0: 2d2d 2d2d 2d0a 2020 2020 5361 7665 7320  -----.    Saves 
+00027db0: 6e65 7720 6361 7461 6c6f 6720 7769 7468  new catalog with
+00027dc0: 207a 6572 6f2d 706f 696e 7473 2061 7070   zero-points app
+00027dd0: 6c69 6564 0a20 2020 2022 2222 0a0a 2020  lied.    """..  
+00027de0: 2020 5a50 7320 3d20 7a70 5f72 6561 6428    ZPs = zp_read(
+00027df0: 7a70 5f66 696c 6529 0a20 2020 2063 6174  zp_file).    cat
+00027e00: 5f64 6174 6120 3d20 6c6f 6164 5f64 6174  _data = load_dat
+00027e10: 6128 6361 7461 6c6f 6729 0a0a 2020 2020  a(catalog)..    
+00027e20: 2320 4170 706c 7920 5a65 726f 2050 6f69  # Apply Zero Poi
+00027e30: 6e74 730a 2020 2020 666f 7220 6669 6c74  nts.    for filt
+00027e40: 2069 6e20 5a50 732e 6b65 7973 2829 3a0a   in ZPs.keys():.
+00027e50: 0a20 2020 2020 2020 2069 6620 7a70 5f69  .        if zp_i
+00027e60: 6e73 7420 6973 204e 6f6e 653a 0a20 2020  nst is None:.   
+00027e70: 2020 2020 2020 2020 207a 705f 6920 3d20           zp_i = 
+00027e80: 5a50 735b 6669 6c74 5d0a 2020 2020 2020  ZPs[filt].      
+00027e90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00027ea0: 2020 2020 7a70 5f69 203d 205a 5073 5b66      zp_i = ZPs[f
+00027eb0: 696c 745d 202b 207a 705f 696e 7374 0a0a  ilt] + zp_inst..
+00027ec0: 2020 2020 2020 2020 6e6f 5f6e 616e 203d          no_nan =
+00027ed0: 2063 6174 5f64 6174 612e 6c6f 635b 3a2c   cat_data.loc[:,
+00027ee0: 2066 696c 745d 2021 3d20 3939 0a0a 2020   filt] != 99..  
+00027ef0: 2020 2020 2020 6361 745f 6461 7461 2e6c        cat_data.l
+00027f00: 6f63 5b6e 6f5f 6e61 6e2c 2066 696c 745d  oc[no_nan, filt]
+00027f10: 203d 2063 6174 5f64 6174 612e 6c6f 635b   = cat_data.loc[
+00027f20: 6e6f 5f6e 616e 2c20 6669 6c74 5d20 2b20  no_nan, filt] + 
+00027f30: 7a70 5f69 0a0a 2020 2020 7769 7468 206f  zp_i..    with o
+00027f40: 7065 6e28 6361 7461 6c6f 672c 2027 7227  pen(catalog, 'r'
+00027f50: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+00027f60: 6669 7273 745f 6c69 6e65 203d 2066 2e72  first_line = f.r
+00027f70: 6561 646c 696e 6528 290a 0a20 2020 2069  eadline()..    i
+00027f80: 6620 666d 7420 3d3d 2027 6173 6369 6927  f fmt == 'ascii'
+00027f90: 3a0a 2020 2020 2020 2020 7769 7468 206f  :.        with o
+00027fa0: 7065 6e28 7361 7665 5f66 696c 652c 2027  pen(save_file, '
+00027fb0: 7727 2920 6173 2066 3a0a 2020 2020 2020  w') as f:.      
+00027fc0: 2020 2020 2020 662e 7772 6974 6528 6669        f.write(fi
+00027fd0: 7273 745f 6c69 6e65 290a 2020 2020 2020  rst_line).      
+00027fe0: 2020 2020 2020 6e70 2e73 6176 6574 7874        np.savetxt
+00027ff0: 2866 2c20 6361 745f 6461 7461 2c20 666d  (f, cat_data, fm
+00028000: 743d 2725 2e35 6627 290a 0a20 2020 2065  t='%.5f')..    e
+00028010: 6c69 6620 666d 7420 3d3d 2027 6669 7473  lif fmt == 'fits
+00028020: 273a 0a20 2020 2020 2020 2074 203d 2054  ':.        t = T
+00028030: 6162 6c65 2e66 726f 6d5f 7061 6e64 6173  able.from_pandas
+00028040: 2863 6174 5f64 6174 6129 0a20 2020 2020  (cat_data).     
+00028050: 2020 2074 2e77 7269 7465 2873 6176 655f     t.write(save_
+00028060: 6669 6c65 290a 0a0a 6465 6620 706c 6f74  file)...def plot
+00028070: 5f7a 705f 6669 7474 696e 6728 7365 645f  _zp_fitting(sed_
+00028080: 6669 745f 6669 6c65 2c20 7361 7665 5f66  fit_file, save_f
+00028090: 696c 652c 2066 696c 742c 206d 6167 5f63  ile, filt, mag_c
+000280a0: 7574 203d 2028 3134 2c20 3139 292c 0a20  ut = (14, 19),. 
+000280b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000280c0: 2020 207a 705f 6669 6c65 203d 204e 6f6e     zp_file = Non
+000280d0: 652c 206c 6162 656c 203d 2027 6d61 675f  e, label = 'mag_
+000280e0: 696e 7374 272c 2063 6f6c 6f72 203d 2022  inst', color = "
+000280f0: 2332 3236 3666 6622 293a 0a0a 2020 2020  #2266ff"):..    
+00028100: 2222 220a 2020 2020 4d61 6b65 7320 6120  """.    Makes a 
+00028110: 706c 6f74 206f 6620 7468 6520 7a65 726f  plot of the zero
+00028120: 2d70 6f69 6e74 2065 7374 696d 6174 696f  -point estimatio
+00028130: 6e20 7072 6f63 6573 730a 0a20 2020 2050  n process..    P
+00028140: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
+00028150: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2073 6564  --------.    sed
+00028160: 5f66 6974 5f66 696c 6520 3a20 7374 720a  _fit_file : str.
+00028170: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
+00028180: 206f 6620 7468 6520 6361 7461 6c6f 6720   of the catalog 
+00028190: 7769 7468 2066 6974 7465 6420 616e 6420  with fitted and 
+000281a0: 6d6f 6465 6c2d 7072 6564 6963 7465 6420  model-predicted 
+000281b0: 6d61 676e 6974 7564 6573 0a20 2020 207a  magnitudes.    z
+000281c0: 705f 6669 6c65 203a 2073 7472 0a20 2020  p_file : str.   
+000281d0: 2020 2020 204c 6f63 6174 696f 6e20 6f66       Location of
+000281e0: 2074 6865 206f 6274 6169 6e65 6420 7a70   the obtained zp
+000281f0: 2066 696c 650a 2020 2020 7361 7665 5f66   file.    save_f
+00028200: 696c 6520 3a20 7374 720a 2020 2020 2020  ile : str.      
+00028210: 2020 4c6f 6361 7469 6f6e 2074 6f20 7361    Location to sa
+00028220: 7665 2074 6865 2070 6c6f 740a 2020 2020  ve the plot.    
+00028230: 6669 6c74 203a 2073 7472 0a20 2020 2020  filt : str.     
+00028240: 2020 204e 616d 6520 6f66 2074 6865 2066     Name of the f
+00028250: 696c 7465 7220 746f 2070 6c6f 740a 2020  ilter to plot.  
+00028260: 2020 6d61 675f 6375 7420 3a20 6c69 7374    mag_cut : list
+00028270: 0a20 2020 2020 2020 204c 696d 6974 7320  .        Limits 
+00028280: 6f66 206d 6167 6e69 7475 6465 7320 5b6d  of magnitudes [m
+00028290: 696e 2c6d 6178 5d20 7365 6c65 6374 6564  in,max] selected
+000282a0: 2066 6f72 207a 6572 6f2d 706f 696e 7420   for zero-point 
+000282b0: 6573 7469 6d61 7469 6f6e 0a20 2020 206c  estimation.    l
+000282c0: 6162 656c 203a 2073 7472 0a20 2020 2020  abel : str.     
+000282d0: 2020 2049 6465 6e74 6966 7920 7468 6520     Identify the 
+000282e0: 7374 6570 2069 6e20 7468 6520 6361 6c69  step in the cali
+000282f0: 6272 6174 696f 6e20 7072 6f63 6573 730a  bration process.
+00028300: 2020 2020 636f 6c6f 7220 3a20 7374 720a      color : str.
+00028310: 2020 2020 2020 2020 436f 6c6f 7220 6f66          Color of
+00028320: 2074 6865 2070 6f69 6e74 7320 696e 2074   the points in t
+00028330: 6865 2073 6361 7474 6572 2070 6c6f 7420  he scatter plot 
+00028340: 616e 6420 6c69 6e65 206f 6620 6465 6e73  and line of dens
+00028350: 6974 7920 706c 6f74 0a0a 2020 2020 5265  ity plot..    Re
+00028360: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
+00028370: 2d0a 2020 2020 5361 7665 7320 7468 6520  -.    Saves the 
+00028380: 706c 6f74 0a20 2020 2022 2222 0a0a 2020  plot.    """..  
+00028390: 2020 2323 2323 2323 2323 2323 230a 2020    ###########.  
+000283a0: 2020 2320 4c6f 6164 2064 6174 610a 0a20    # Load data.. 
+000283b0: 2020 2063 6174 5f64 6174 6120 3d20 6c6f     cat_data = lo
+000283c0: 6164 5f64 6174 6128 7365 645f 6669 745f  ad_data(sed_fit_
+000283d0: 6669 6c65 290a 0a20 2020 2023 2052 656d  file)..    # Rem
+000283e0: 6f76 6520 3939 0a20 2020 2064 6174 615f  ove 99.    data_
+000283f0: 7365 6c65 6374 696f 6e20 3d20 6e70 2e61  selection = np.a
+00028400: 6273 2863 6174 5f64 6174 612e 6c6f 635b  bs(cat_data.loc[
+00028410: 3a2c 2066 696c 745d 203c 2035 3029 0a20  :, filt] < 50). 
+00028420: 2020 2063 6174 5f64 6174 6120 3d20 6361     cat_data = ca
+00028430: 745f 6461 7461 5b64 6174 615f 7365 6c65  t_data[data_sele
+00028440: 6374 696f 6e5d 0a0a 2020 2020 2323 2323  ction]..    ####
+00028450: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
+00028460: 2050 7265 7061 7265 2064 6174 610a 0a20   Prepare data.. 
+00028470: 2020 2078 203d 2063 6174 5f64 6174 612e     x = cat_data.
+00028480: 6c6f 635b 3a2c 2066 277b 6669 6c74 7d5f  loc[:, f'{filt}_
+00028490: 6d6f 6427 5d0a 2020 2020 7920 3d20 7820  mod'].    y = x 
+000284a0: 2d20 6361 745f 6461 7461 2e6c 6f63 5b3a  - cat_data.loc[:
+000284b0: 2c20 6627 7b66 696c 747d 275d 0a0a 2020  , f'{filt}']..  
+000284c0: 2020 6477 6172 6673 203d 2063 6174 5f64    dwarfs = cat_d
+000284d0: 6174 612e 6c6f 635b 3a2c 2027 6c6f 6767  ata.loc[:, 'logg
+000284e0: 275d 2e76 616c 7565 7320 3e20 330a 2020  '].values > 3.  
+000284f0: 2020 7365 6c65 6374 696f 6e20 3d20 2878    selection = (x
+00028500: 203e 3d20 6d61 675f 6375 745b 305d 2920   >= mag_cut[0]) 
+00028510: 2620 2878 203c 3d20 6d61 675f 6375 745b  & (x <= mag_cut[
+00028520: 315d 2920 2620 6477 6172 6673 0a0a 2020  1]) & dwarfs..  
+00028530: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+00028540: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
+00028550: 2020 2023 2041 7070 6c79 2064 6966 6665     # Apply diffe
+00028560: 7265 6e74 2065 7374 696d 6174 6f72 730a  rent estimators.
+00028570: 0a20 2020 2064 656c 7461 203d 2079 5b73  .    delta = y[s
+00028580: 656c 6563 7469 6f6e 5d0a 2020 2020 6465  election].    de
+00028590: 6c74 6120 3d20 6465 6c74 612e 7661 6c75  lta = delta.valu
+000285a0: 6573 2e72 6573 6861 7065 282d 312c 2031  es.reshape(-1, 1
+000285b0: 290a 0a20 2020 206b 6465 5f64 656e 7320  )..    kde_dens 
+000285c0: 3d20 4b65 726e 656c 4465 6e73 6974 7928  = KernelDensity(
+000285d0: 6b65 726e 656c 3d27 6761 7573 7369 616e  kernel='gaussian
+000285e0: 272c 2062 616e 6477 6964 7468 3d30 2e30  ', bandwidth=0.0
+000285f0: 3529 2e66 6974 2864 656c 7461 290a 0a20  5).fit(delta).. 
+00028600: 2020 2079 5f64 656e 7320 3d20 6e70 2e61     y_dens = np.a
+00028610: 7261 6e67 6528 2d31 302c 2031 302c 2030  range(-10, 10, 0
+00028620: 2e30 3031 290a 2020 2020 785f 6465 6e73  .001).    x_dens
+00028630: 203d 206e 702e 6578 7028 6b64 655f 6465   = np.exp(kde_de
+00028640: 6e73 2e73 636f 7265 5f73 616d 706c 6573  ns.score_samples
+00028650: 2879 5f64 656e 732e 7265 7368 6170 6528  (y_dens.reshape(
+00028660: 2d31 2c20 3129 2929 0a0a 2020 2020 6d6f  -1, 1)))..    mo
+00028670: 6465 203d 2079 5f64 656e 735b 785f 6465  de = y_dens[x_de
+00028680: 6e73 203d 3d20 6e70 2e6d 6178 2878 5f64  ns == np.max(x_d
+00028690: 656e 7329 5d5b 305d 0a0a 2020 2020 6d75  ens)][0]..    mu
+000286a0: 203d 206e 702e 6d65 616e 2879 5b73 656c   = np.mean(y[sel
+000286b0: 6563 7469 6f6e 5d29 0a20 2020 206d 755f  ection]).    mu_
+000286c0: 726f 6275 7374 203d 206d 6561 6e5f 726f  robust = mean_ro
+000286d0: 6275 7374 2879 5b73 656c 6563 7469 6f6e  bust(y[selection
+000286e0: 5d29 0a0a 2020 2020 2323 2323 2323 2323  ])..    ########
+000286f0: 2323 2323 2323 2323 0a20 2020 2023 204d  ########.    # M
+00028700: 616b 6520 7468 6520 706c 6f74 730a 0a20  ake the plots.. 
+00028710: 2020 2066 6967 203d 2070 6c74 2e66 6967     fig = plt.fig
+00028720: 7572 6528 6669 6773 697a 653d 2838 2c20  ure(figsize=(8, 
+00028730: 3529 290a 2020 2020 6773 203d 2067 7269  5)).    gs = gri
+00028740: 6473 7065 632e 4772 6964 5370 6563 2831  dspec.GridSpec(1
+00028750: 2c20 322c 2077 6964 7468 5f72 6174 696f  , 2, width_ratio
+00028760: 733d 5b33 2c20 315d 290a 0a20 2020 2061  s=[3, 1])..    a
+00028770: 7831 203d 2070 6c74 2e73 7562 706c 6f74  x1 = plt.subplot
+00028780: 2867 735b 305d 290a 0a20 2020 2061 7831  (gs[0])..    ax1
+00028790: 2e73 6361 7474 6572 2878 5b73 656c 6563  .scatter(x[selec
+000287a0: 7469 6f6e 5d2c 2079 5b73 656c 6563 7469  tion], y[selecti
+000287b0: 6f6e 5d2c 0a20 2020 2020 2020 2020 2020  on],.           
+000287c0: 2020 2020 2063 3d63 6f6c 6f72 2c20 733d       c=color, s=
+000287d0: 3230 2c20 616c 7068 613d 302e 352c 207a  20, alpha=0.5, z
+000287e0: 6f72 6465 723d 3129 0a0a 2020 2020 6178  order=1)..    ax
+000287f0: 312e 7363 6174 7465 7228 785b 7e73 656c  1.scatter(x[~sel
+00028800: 6563 7469 6f6e 5d2c 2079 5b7e 7365 6c65  ection], y[~sele
+00028810: 6374 696f 6e5d 2c0a 2020 2020 2020 2020  ction],.        
+00028820: 2020 2020 2020 2020 633d 636f 6c6f 722c          c=color,
+00028830: 2073 3d32 302c 2061 6c70 6861 3d30 2e30   s=20, alpha=0.0
+00028840: 352c 207a 6f72 6465 723d 3229 0a0a 2020  5, zorder=2)..  
+00028850: 2020 6178 312e 706c 6f74 285b 6d61 675f    ax1.plot([mag_
+00028860: 6375 745b 305d 2c20 6d61 675f 6375 745b  cut[0], mag_cut[
+00028870: 315d 5d2c 205b 6d6f 6465 2c20 6d6f 6465  1]], [mode, mode
+00028880: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00028890: 636f 6c6f 723d 2723 4646 3332 3139 272c  color='#FF3219',
+000288a0: 206c 696e 6573 7479 6c65 3d27 2d27 2c20   linestyle='-', 
+000288b0: 7a6f 7264 6572 3d36 290a 0a20 2020 2023  zorder=6)..    #
+000288c0: 2323 230a 2020 2020 2320 4c69 6d69 7473  ###.    # Limits
+000288d0: 206f 6620 7468 6520 706c 6f74 0a20 2020   of the plot.   
+000288e0: 2023 2323 230a 2020 2020 786c 696d 203d   ####.    xlim =
+000288f0: 205b 6d61 675f 6375 745b 305d 202d 2032   [mag_cut[0] - 2
+00028900: 2c20 6d61 675f 6375 745b 315d 202b 2034  , mag_cut[1] + 4
+00028910: 5d0a 2020 2020 796c 696d 203d 205b 6d6f  ].    ylim = [mo
+00028920: 6465 202d 2031 2e35 2c20 6d6f 6465 202b  de - 1.5, mode +
+00028930: 2031 2e35 5d0a 0a20 2020 2061 7831 2e74   1.5]..    ax1.t
+00028940: 6578 7428 6d61 675f 6375 745b 305d 202d  ext(mag_cut[0] -
+00028950: 2031 2e35 2c20 6d6f 6465 202b 2031 2e33   1.5, mode + 1.3
+00028960: 2c20 6622 7b66 696c 747d 222c 2066 6f6e  , f"{filt}", fon
+00028970: 7473 697a 653d 3134 290a 0a20 2020 2061  tsize=14)..    a
+00028980: 7831 2e73 6574 5f78 6c69 6d28 786c 696d  x1.set_xlim(xlim
+00028990: 290a 2020 2020 6178 312e 7365 745f 796c  ).    ax1.set_yl
+000289a0: 696d 2879 6c69 6d29 0a0a 2020 2020 6178  im(ylim)..    ax
+000289b0: 312e 7365 745f 786c 6162 656c 2822 6d61  1.set_xlabel("ma
+000289c0: 675f 6d6f 6465 6c22 290a 2020 2020 6178  g_model").    ax
+000289d0: 312e 7365 745f 796c 6162 656c 2866 226d  1.set_ylabel(f"m
+000289e0: 6167 5f6d 6f64 656c 202d 207b 6c61 6265  ag_model - {labe
+000289f0: 6c7d 2229 0a0a 2020 2020 2323 230a 2020  l}")..    ###.  
+00028a00: 2020 2320 506c 6f74 204b 4445 2064 6973    # Plot KDE dis
+00028a10: 7472 6962 7574 696f 6e0a 2020 2020 2323  tribution.    ##
+00028a20: 230a 0a20 2020 2061 7832 203d 2070 6c74  #..    ax2 = plt
+00028a30: 2e73 7562 706c 6f74 2867 735b 315d 290a  .subplot(gs[1]).
+00028a40: 0a20 2020 2061 7832 2e70 6c6f 7428 785f  .    ax2.plot(x_
+00028a50: 6465 6e73 202f 206e 702e 6d61 7828 785f  dens / np.max(x_
+00028a60: 6465 6e73 292c 2079 5f64 656e 732c 207a  dens), y_dens, z
+00028a70: 6f72 6465 723d 332c 2063 6f6c 6f72 203d  order=3, color =
+00028a80: 2063 6f6c 6f72 290a 0a20 2020 2069 6620   color)..    if 
+00028a90: 7a70 5f66 696c 6520 6973 206e 6f74 204e  zp_file is not N
+00028aa0: 6f6e 653a 0a20 2020 2020 2020 207a 705f  one:.        zp_
+00028ab0: 6461 7461 203d 207a 705f 7265 6164 287a  data = zp_read(z
+00028ac0: 705f 6669 6c65 290a 2020 2020 2020 2020  p_file).        
+00028ad0: 7a70 203d 207a 705f 6461 7461 5b66 696c  zp = zp_data[fil
+00028ae0: 745d 0a0a 2020 2020 2020 2020 6178 322e  t]..        ax2.
+00028af0: 706c 6f74 285b 302c 2032 5d2c 205b 7a70  plot([0, 2], [zp
+00028b00: 2c20 7a70 5d2c 2063 6f6c 6f72 3d27 2330  , zp], color='#0
+00028b10: 3030 3030 3027 2c20 6c69 6e65 7374 796c  00000', linestyl
+00028b20: 653d 272d 2d27 2c0a 2020 2020 2020 2020  e='--',.        
+00028b30: 2020 2020 2020 2020 207a 6f72 6465 723d           zorder=
+00028b40: 332c 206c 6162 656c 3d27 7a70 3a20 7b3a  3, label='zp: {:
+00028b50: 2e34 667d 272e 666f 726d 6174 286d 6f64  .4f}'.format(mod
+00028b60: 6529 290a 0a20 2020 2061 7832 2e70 6c6f  e))..    ax2.plo
+00028b70: 7428 5b30 2c20 325d 2c20 5b6d 6f64 652c  t([0, 2], [mode,
+00028b80: 206d 6f64 655d 2c20 636f 6c6f 723d 2723   mode], color='#
+00028b90: 4646 3332 3139 272c 206c 696e 6573 7479  FF3219', linesty
+00028ba0: 6c65 3d27 2d27 2c0a 2020 2020 2020 2020  le='-',.        
+00028bb0: 2020 2020 207a 6f72 6465 723d 322c 206c       zorder=2, l
+00028bc0: 6162 656c 3d27 6d6f 6465 3a20 7b3a 2e34  abel='mode: {:.4
+00028bd0: 667d 272e 666f 726d 6174 286d 6f64 6529  f}'.format(mode)
+00028be0: 290a 0a20 2020 2061 7832 2e70 6c6f 7428  )..    ax2.plot(
+00028bf0: 5b30 2c20 325d 2c20 5b6d 752c 206d 755d  [0, 2], [mu, mu]
+00028c00: 2c20 636f 6c6f 723d 2723 3139 3332 4646  , color='#1932FF
+00028c10: 272c 206c 696e 6573 7479 6c65 3d27 2d2d  ', linestyle='--
+00028c20: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+00028c30: 7a6f 7264 6572 3d31 2c20 6c61 6265 6c3d  zorder=1, label=
+00028c40: 276d 6561 6e3a 207b 3a2e 3466 7d27 2e66  'mean: {:.4f}'.f
+00028c50: 6f72 6d61 7428 6d75 2929 0a0a 2020 2020  ormat(mu))..    
+00028c60: 6178 322e 706c 6f74 285b 302c 2032 5d2c  ax2.plot([0, 2],
+00028c70: 205b 6d75 5f72 6f62 7573 742c 206d 755f   [mu_robust, mu_
+00028c80: 726f 6275 7374 5d2c 2063 6f6c 6f72 3d27  robust], color='
+00028c90: 2331 3944 4433 3227 2c20 6c69 6e65 7374  #19DD32', linest
+00028ca0: 796c 653d 273a 272c 0a20 2020 2020 2020  yle=':',.       
+00028cb0: 2020 2020 2020 7a6f 7264 6572 3d31 2c0a        zorder=1,.
+00028cc0: 2020 2020 2020 2020 2020 2020 206c 6162               lab
+00028cd0: 656c 3d27 6d65 616e 5f72 6f62 7573 743a  el='mean_robust:
+00028ce0: 207b 3a2e 3466 7d27 2e66 6f72 6d61 7428   {:.4f}'.format(
+00028cf0: 6d75 5f72 6f62 7573 7429 290a 0a20 2020  mu_robust))..   
+00028d00: 2061 7832 2e73 6574 5f78 6c69 6d28 5b30   ax2.set_xlim([0
+00028d10: 2c20 312e 315d 290a 2020 2020 6178 322e  , 1.1]).    ax2.
+00028d20: 7365 745f 796c 696d 2879 6c69 6d29 0a0a  set_ylim(ylim)..
+00028d30: 2020 2020 6178 322e 6c65 6765 6e64 2866      ax2.legend(f
+00028d40: 6f6e 7473 697a 653d 3729 0a0a 2020 2020  ontsize=7)..    
+00028d50: 6178 322e 6178 6573 2e67 6574 5f78 6178  ax2.axes.get_xax
+00028d60: 6973 2829 2e73 6574 5f76 6973 6962 6c65  is().set_visible
+00028d70: 2846 616c 7365 290a 2020 2020 6178 322e  (False).    ax2.
+00028d80: 6178 6573 2e67 6574 5f79 6178 6973 2829  axes.get_yaxis()
+00028d90: 2e73 6574 5f76 6973 6962 6c65 2846 616c  .set_visible(Fal
+00028da0: 7365 290a 2020 2020 6178 322e 7365 745f  se).    ax2.set_
+00028db0: 796c 6162 656c 2822 4465 6e73 6974 7922  ylabel("Density"
+00028dc0: 290a 0a20 2020 2023 2323 2323 2323 2323  )..    #########
+00028dd0: 2323 230a 2020 2020 2320 506c 6f74 2067  ###.    # Plot g
+00028de0: 7269 6473 0a0a 2020 2020 666f 7220 6920  rids..    for i 
+00028df0: 696e 206e 702e 6172 616e 6765 282d 3130  in np.arange(-10
+00028e00: 2c20 3130 2c20 302e 3529 3a0a 0a20 2020  , 10, 0.5):..   
+00028e10: 2020 2020 2061 7831 2e70 6c6f 7428 5b30       ax1.plot([0
+00028e20: 2c20 3330 5d2c 205b 692c 2069 5d2c 0a20  , 30], [i, i],. 
+00028e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028e40: 636f 6c6f 723d 2223 3636 3636 3636 222c  color="#666666",
+00028e50: 2061 6c70 6861 3d30 2e33 2c0a 2020 2020   alpha=0.3,.    
+00028e60: 2020 2020 2020 2020 2020 2020 206c 696e               lin
+00028e70: 6577 6964 7468 3d30 2e35 2c20 7a6f 7264  ewidth=0.5, zord
+00028e80: 6572 3d2d 3529 0a0a 2020 2020 2020 2020  er=-5)..        
+00028e90: 6178 322e 706c 6f74 285b 302c 2033 305d  ax2.plot([0, 30]
+00028ea0: 2c20 5b69 2c20 695d 2c0a 2020 2020 2020  , [i, i],.      
+00028eb0: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
+00028ec0: 3d22 2336 3636 3636 3622 2c20 616c 7068  ="#666666", alph
+00028ed0: 613d 302e 332c 0a20 2020 2020 2020 2020  a=0.3,.         
+00028ee0: 2020 2020 2020 2020 6c69 6e65 7769 6474          linewidt
+00028ef0: 683d 302e 352c 207a 6f72 6465 723d 2d35  h=0.5, zorder=-5
+00028f00: 290a 0a20 2020 2066 6f72 2069 2069 6e20  )..    for i in 
+00028f10: 6e70 2e61 7261 6e67 6528 2d31 302c 2031  np.arange(-10, 1
+00028f20: 302c 2030 2e31 293a 0a0a 2020 2020 2020  0, 0.1):..      
+00028f30: 2020 6178 312e 706c 6f74 285b 302c 2033    ax1.plot([0, 3
+00028f40: 305d 2c20 5b69 2c20 695d 2c0a 2020 2020  0], [i, i],.    
+00028f50: 2020 2020 2020 2020 2020 2020 2063 6f6c               col
+00028f60: 6f72 3d22 2336 3636 3636 3622 2c20 616c  or="#666666", al
+00028f70: 7068 613d 302e 312c 0a20 2020 2020 2020  pha=0.1,.       
+00028f80: 2020 2020 2020 2020 2020 6c69 6e65 7769            linewi
+00028f90: 6474 683d 302e 352c 207a 6f72 6465 723d  dth=0.5, zorder=
+00028fa0: 2d35 290a 0a20 2020 2020 2020 2061 7832  -5)..        ax2
+00028fb0: 2e70 6c6f 7428 5b30 2c20 3330 5d2c 205b  .plot([0, 30], [
+00028fc0: 692c 2069 5d2c 0a20 2020 2020 2020 2020  i, i],.         
+00028fd0: 2020 2020 2020 2020 636f 6c6f 723d 2223          color="#
+00028fe0: 3636 3636 3636 222c 2061 6c70 6861 3d30  666666", alpha=0
+00028ff0: 2e31 2c0a 2020 2020 2020 2020 2020 2020  .1,.            
+00029000: 2020 2020 206c 696e 6577 6964 7468 3d30       linewidth=0
+00029010: 2e35 2c20 7a6f 7264 6572 3d2d 3529 0a0a  .5, zorder=-5)..
+00029020: 2020 2020 666f 7220 6920 696e 206e 702e      for i in np.
+00029030: 6172 616e 6765 2831 2c20 3330 2c20 3129  arange(1, 30, 1)
+00029040: 3a0a 0a20 2020 2020 2020 2061 7831 2e70  :..        ax1.p
+00029050: 6c6f 7428 5b69 2c20 695d 2c20 5b2d 3130  lot([i, i], [-10
+00029060: 2c20 3130 5d2c 0a20 2020 2020 2020 2020  , 10],.         
+00029070: 2020 2020 2020 2020 636f 6c6f 723d 2223          color="#
+00029080: 3636 3636 3636 222c 206c 696e 6577 6964  666666", linewid
+00029090: 7468 3d30 2e35 2c0a 2020 2020 2020 2020  th=0.5,.        
+000290a0: 2020 2020 2020 2020 2061 6c70 6861 3d30           alpha=0
+000290b0: 2e31 2c20 7a6f 7264 6572 3d2d 3529 0a0a  .1, zorder=-5)..
+000290c0: 2020 2020 666f 7220 6920 696e 206e 702e      for i in np.
+000290d0: 6172 616e 6765 2832 2c20 3330 2c20 3229  arange(2, 30, 2)
+000290e0: 3a0a 0a20 2020 2020 2020 2061 7831 2e70  :..        ax1.p
+000290f0: 6c6f 7428 5b69 2c20 695d 2c20 5b2d 3130  lot([i, i], [-10
+00029100: 2c20 3130 5d2c 0a20 2020 2020 2020 2020  , 10],.         
+00029110: 2020 2020 2020 2020 636f 6c6f 723d 2223          color="#
+00029120: 3636 3636 3636 222c 206c 696e 6577 6964  666666", linewid
+00029130: 7468 3d30 2e35 2c0a 2020 2020 2020 2020  th=0.5,.        
+00029140: 2020 2020 2020 2020 2061 6c70 6861 3d30           alpha=0
+00029150: 2e33 2c20 7a6f 7264 6572 3d2d 3529 0a0a  .3, zorder=-5)..
+00029160: 2020 2020 706c 742e 7375 6270 6c6f 7473      plt.subplots
+00029170: 5f61 646a 7573 7428 746f 703d 302e 3938  _adjust(top=0.98
+00029180: 2c20 6c65 6674 3d30 2e31 2c20 7269 6768  , left=0.1, righ
+00029190: 743d 302e 3938 2c20 7773 7061 6365 3d30  t=0.98, wspace=0
+000291a0: 290a 0a20 2020 2070 6c74 2e73 6176 6566  )..    plt.savef
+000291b0: 6967 2873 6176 655f 6669 6c65 290a 2020  ig(save_file).  
+000291c0: 2020 706c 742e 636c 6628 290a 2020 2020    plt.clf().    
+000291d0: 706c 742e 636c 6f73 6528 290a 0a0a 2323  plt.close()...##
+000291e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000291f0: 2323 2323 2323 2323 230a 2320 5374 656c  #########.# Stel
+00029200: 6c61 7220 4c6f 6375 7320 6361 6c69 6272  lar Locus calibr
+00029210: 6174 696f 6e0a 0a64 6566 207a 705f 6573  ation..def zp_es
+00029220: 7469 6d61 7465 5f73 746c 6f63 7573 2863  timate_stlocus(c
+00029230: 6174 616c 6f67 2c20 7361 7665 5f66 696c  atalog, save_fil
+00029240: 652c 2073 746c 6f63 7573 5f72 6566 5f63  e, stlocus_ref_c
+00029250: 6174 2c0a 2020 2020 2020 2020 2020 2020  at,.            
+00029260: 2020 2020 2020 2020 2020 2020 6669 6c74              filt
+00029270: 735f 636f 6c6f 725f 7265 662c 2066 696c  s_color_ref, fil
+00029280: 745f 7265 662c 2066 696c 7473 5f74 6f5f  t_ref, filts_to_
+00029290: 6765 745f 7a70 2c0a 2020 2020 2020 2020  get_zp,.        
+000292a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000292b0: 636f 6c6f 725f 7261 6e67 652c 206e 6269  color_range, nbi
+000292c0: 6e73 2c20 706c 6f74 5f70 6174 6820 3d20  ns, plot_path = 
+000292d0: 4e6f 6e65 2c20 6669 656c 6420 3d20 4e6f  None, field = No
+000292e0: 6e65 293a 0a0a 2020 2020 2222 220a 2020  ne):..    """.  
+000292f0: 2020 4170 706c 6965 7320 7468 6520 7374    Applies the st
+00029300: 656c 6c61 7220 6c6f 6375 7320 7465 6368  ellar locus tech
+00029310: 6e69 7175 6520 746f 2064 6572 6976 6520  nique to derive 
+00029320: 7468 6520 7a65 726f 2d70 6f69 6e74 7320  the zero-points 
+00029330: 6f66 2061 206c 6973 740a 2020 2020 6f66  of a list.    of
+00029340: 2066 696c 7465 7273 2079 6574 2074 6f20   filters yet to 
+00029350: 6265 2063 616c 6962 7261 7465 642e 0a0a  be calibrated...
+00029360: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+00029370: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+00029380: 2020 6361 7461 6c6f 6720 3a20 7374 720a    catalog : str.
+00029390: 2020 2020 2020 2020 4c6f 6361 7469 6f6e          Location
+000293a0: 206f 6620 7468 6520 6361 7461 6c6f 6720   of the catalog 
+000293b0: 7769 7468 2066 696c 7465 7220 636f 6c75  with filter colu
+000293c0: 6d6e 7320 746f 2062 6520 6361 6c69 6272  mns to be calibr
+000293d0: 6174 6564 0a20 2020 2073 6176 655f 6669  ated.    save_fi
+000293e0: 6c65 203a 2073 7472 0a20 2020 2020 2020  le : str.       
+000293f0: 204c 6f63 6174 696f 6e20 6f66 2074 6865   Location of the
+00029400: 202e 7a70 206f 7574 7075 7420 6669 6c65   .zp output file
+00029410: 0a20 2020 2073 746c 6f63 7573 5f72 6566  .    stlocus_ref
+00029420: 5f63 6174 203a 2073 7472 0a20 2020 2020  _cat : str.     
+00029430: 2020 204c 6f63 6174 696f 6e20 6f66 2074     Location of t
+00029440: 6865 2063 6174 616c 6f67 2075 7365 6420  he catalog used 
+00029450: 6173 2074 6865 2072 6566 6572 656e 6365  as the reference
+00029460: 2066 6f72 2074 6865 2063 616c 6962 7261   for the calibra
+00029470: 7469 6f6e 0a20 2020 2066 696c 7473 5f63  tion.    filts_c
+00029480: 6f6c 6f72 5f72 6566 203a 206c 6973 740a  olor_ref : list.
+00029490: 2020 2020 2020 2020 636f 6c6f 7220 6669          color fi
+000294a0: 6c74 3120 2d20 6669 6c74 3220 6973 2063  lt1 - filt2 is c
+000294b0: 616c 6375 6c61 7465 6420 6672 6f6d 2074  alculated from t
+000294c0: 6865 2063 6f6c 756d 6e73 205b 6669 6c74  he columns [filt
+000294d0: 312c 2066 696c 7432 5d0a 2020 2020 6669  1, filt2].    fi
+000294e0: 6c74 5f72 6566 203a 2073 7472 0a20 2020  lt_ref : str.   
+000294f0: 2020 2020 2066 696c 7465 7220 7468 6174       filter that
+00029500: 2063 6f6d 706c 6574 6573 2074 6865 2063   completes the c
+00029510: 6f6c 6f72 2069 6e20 7468 6520 7920 6178  olor in the y ax
+00029520: 6973 0a20 2020 2066 696c 7473 5f74 6f5f  is.    filts_to_
+00029530: 6765 745f 7a70 203a 206c 6973 740a 2020  get_zp : list.  
+00029540: 2020 2020 2020 4c69 7374 206f 6620 6669        List of fi
+00029550: 6c74 6572 7320 746f 206f 6274 6169 6e20  lters to obtain 
+00029560: 7a70 2075 7369 6e67 2074 6865 2073 7465  zp using the ste
+00029570: 6c6c 6172 206c 6f63 7573 2074 6563 686e  llar locus techn
+00029580: 6971 7565 0a20 2020 2063 6f6c 6f72 5f72  ique.    color_r
+00029590: 616e 6765 203a 206c 6973 740a 2020 2020  ange : list.    
+000295a0: 2020 2020 782d 6178 6973 2063 6f6c 6f72      x-axis color
+000295b0: 2072 616e 6765 2063 6f6e 7369 6465 7265   range considere
+000295c0: 6420 696e 2074 6865 207a 7020 6669 7474  d in the zp fitt
+000295d0: 696e 6720 5b6d 696e 2c20 6d61 785d 0a20  ing [min, max]. 
+000295e0: 2020 206e 6269 6e73 203a 2069 6e74 0a20     nbins : int. 
+000295f0: 2020 2020 2020 204e 756d 6265 7220 6f66         Number of
+00029600: 2062 696e 7320 746f 2064 6976 6964 6520   bins to divide 
+00029610: 7468 6520 636f 6c6f 725f 7261 6e67 6520  the color_range 
+00029620: 696e 7465 7276 616c 0a20 2020 2070 6c6f  interval.    plo
+00029630: 745f 7061 7468 203a 2073 7472 0a20 2020  t_path : str.   
+00029640: 2020 2020 204c 6f63 6174 696f 6e20 6f66       Location of
+00029650: 2074 6865 2064 6972 6563 746f 7279 2074   the directory t
+00029660: 6f20 7361 7665 2070 6c6f 7473 2028 6361  o save plots (ca
+00029670: 6e20 6265 204e 6f6e 6529 0a20 2020 2066  n be None).    f
+00029680: 6965 6c64 203a 2073 7472 0a20 2020 2020  ield : str.     
+00029690: 2020 204e 616d 6520 6f66 2074 6865 2066     Name of the f
+000296a0: 6965 6c64 2028 7573 6564 206f 6e6c 7920  ield (used only 
+000296b0: 666f 7220 7468 6520 706c 6f74 7320 6669  for the plots fi
+000296c0: 6c65 206e 616d 6573 290a 0a20 2020 2052  le names)..    R
+000296d0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
+000296e0: 2d2d 0a20 2020 2053 6176 6573 2061 202e  --.    Saves a .
+000296f0: 7a70 2066 696c 6520 7769 7468 2074 6865  zp file with the
+00029700: 207a 6572 6f20 706f 696e 7473 2061 6e64   zero points and
+00029710: 2c20 6f70 7469 6f6e 616c 6c79 2c20 7361  , optionally, sa
+00029720: 7665 7320 706c 6f74 7320 6f66 2074 6865  ves plots of the
+00029730: 0a20 2020 2070 726f 6365 7373 0a20 2020  .    process.   
+00029740: 2022 2222 0a0a 2020 2020 2320 4c6f 6164   """..    # Load
+00029750: 2052 6566 6572 656e 6365 2061 6e64 2064   Reference and d
+00029760: 6174 610a 2020 2020 7265 6665 7265 6e63  ata.    referenc
+00029770: 6520 3d20 6c6f 6164 5f64 6174 6128 7374  e = load_data(st
+00029780: 6c6f 6375 735f 7265 665f 6361 7429 0a20  locus_ref_cat). 
+00029790: 2020 2063 6174 5f64 6174 6120 3d20 6c6f     cat_data = lo
+000297a0: 6164 5f64 6174 6128 6361 7461 6c6f 6729  ad_data(catalog)
+000297b0: 0a0a 2020 2020 2320 6465 6669 6e65 2078  ..    # define x
+000297c0: 2061 7869 7320 3d3e 2063 6f6c 6f72 203d   axis => color =
+000297d0: 2066 696c 745f 7830 202d 2066 696c 745f   filt_x0 - filt_
+000297e0: 7831 0a20 2020 2066 696c 745f 7830 203d  x1.    filt_x0 =
+000297f0: 2066 696c 7473 5f63 6f6c 6f72 5f72 6566   filts_color_ref
+00029800: 5b30 5d0a 2020 2020 6669 6c74 5f78 3120  [0].    filt_x1 
+00029810: 3d20 6669 6c74 735f 636f 6c6f 725f 7265  = filts_color_re
+00029820: 665b 315d 0a0a 2020 2020 2320 4361 6c63  f[1]..    # Calc
+00029830: 756c 6174 6520 636f 6c6f 7273 2066 726f  ulate colors fro
+00029840: 6d20 7265 6665 7265 6e63 6520 616e 6420  m reference and 
+00029850: 6672 6f6d 2063 6174 616c 6f67 2074 6f20  from catalog to 
+00029860: 6361 6c69 6272 6174 650a 2020 2020 7265  calibrate.    re
+00029870: 6665 7265 6e63 655f 7820 3d20 7265 6665  ference_x = refe
+00029880: 7265 6e63 652e 6c6f 635b 3a2c 2066 696c  rence.loc[:, fil
+00029890: 745f 7830 5d20 2d20 7265 6665 7265 6e63  t_x0] - referenc
+000298a0: 652e 6c6f 635b 3a2c 2066 696c 745f 7831  e.loc[:, filt_x1
+000298b0: 5d0a 2020 2020 6361 745f 6461 7461 5f78  ].    cat_data_x
+000298c0: 2020 3d20 6361 745f 6461 7461 2e6c 6f63    = cat_data.loc
+000298d0: 5b3a 2c20 6669 6c74 5f78 305d 202d 2063  [:, filt_x0] - c
+000298e0: 6174 5f64 6174 612e 6c6f 635b 3a2c 2066  at_data.loc[:, f
+000298f0: 696c 745f 7831 5d0a 0a20 2020 207a 705f  ilt_x1]..    zp_
+00029900: 6469 6374 203d 207b 7d0a 0a20 2020 2062  dict = {}..    b
+00029910: 696e 7320 3d20 6e70 2e6c 696e 7370 6163  ins = np.linspac
+00029920: 6528 636f 6c6f 725f 7261 6e67 655b 305d  e(color_range[0]
+00029930: 2c20 636f 6c6f 725f 7261 6e67 655b 315d  , color_range[1]
+00029940: 2c20 6e62 696e 7329 0a20 2020 2064 656c  , nbins).    del
+00029950: 7461 5f62 696e 203d 2062 696e 735b 315d  ta_bin = bins[1]
+00029960: 202d 2062 696e 735b 305d 0a0a 2020 2020   - bins[0]..    
+00029970: 2320 4f62 7461 696e 207a 6572 6f20 706f  # Obtain zero po
+00029980: 696e 7473 0a20 2020 2066 6f72 2066 696c  ints.    for fil
+00029990: 7420 696e 2066 696c 7473 5f74 6f5f 6765  t in filts_to_ge
+000299a0: 745f 7a70 3a0a 2020 2020 2020 2020 7072  t_zp:.        pr
+000299b0: 696e 7428 6622 4573 7469 6d61 7469 6e67  int(f"Estimating
+000299c0: 205a 5020 666f 7220 6669 6c74 6572 207b   ZP for filter {
+000299d0: 6669 6c74 7d20 7573 696e 6720 7468 6520  filt} using the 
+000299e0: 7374 656c 6c61 7220 6c6f 6375 7322 290a  stellar locus").
+000299f0: 0a20 2020 2020 2020 2064 656c 7461 5f6d  .        delta_m
+00029a00: 6167 203d 205b 5d0a 0a20 2020 2020 2020  ag = []..       
+00029a10: 2023 2323 230a 2020 2020 2020 2020 7265   ####.        re
+00029a20: 6665 7265 6e63 655f 6269 6e5f 795f 6c69  ference_bin_y_li
+00029a30: 7374 203d 205b 5d0a 2020 2020 2020 2020  st = [].        
+00029a40: 6461 7461 5f62 696e 5f79 5f6c 6973 7420  data_bin_y_list 
+00029a50: 3d20 5b5d 0a20 2020 2020 2020 2023 2323  = [].        ###
+00029a60: 230a 0a20 2020 2020 2020 2023 2052 656d  #..        # Rem
+00029a70: 6f76 6520 6d61 6720 3d20 3939 206f 7220  ove mag = 99 or 
+00029a80: 2d39 390a 2020 2020 2020 2020 7265 6d6f  -99.        remo
+00029a90: 7665 5f62 6164 5f64 6174 6120 3d20 2863  ve_bad_data = (c
+00029aa0: 6174 5f64 6174 612e 6c6f 635b 3a2c 2066  at_data.loc[:, f
+00029ab0: 696c 745d 2e76 616c 7565 7320 213d 202d  ilt].values != -
+00029ac0: 3939 2920 2620 5c0a 2020 2020 2020 2020  99) & \.        
+00029ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029ae0: 2020 2863 6174 5f64 6174 612e 6c6f 635b    (cat_data.loc[
+00029af0: 3a2c 2066 696c 745d 2e76 616c 7565 7320  :, filt].values 
+00029b00: 213d 2039 3929 2026 205c 0a20 2020 2020  != 99) & \.     
+00029b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029b20: 2020 2020 2028 6361 745f 6461 7461 2e6c       (cat_data.l
+00029b30: 6f63 5b3a 2c20 6669 6c74 5f72 6566 5d2e  oc[:, filt_ref].
+00029b40: 7661 6c75 6573 2021 3d20 2d39 3929 2026  values != -99) &
+00029b50: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
+00029b60: 2020 2020 2020 2020 2020 2020 2028 6361               (ca
+00029b70: 745f 6461 7461 2e6c 6f63 5b3a 2c20 6669  t_data.loc[:, fi
+00029b80: 6c74 5f72 6566 5d2e 7661 6c75 6573 2021  lt_ref].values !
+00029b90: 3d20 3939 2920 2620 5c0a 2020 2020 2020  = 99) & \.      
+00029ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029bb0: 2020 2020 2863 6174 5f64 6174 612e 6c6f      (cat_data.lo
+00029bc0: 635b 3a2c 2066 696c 745f 7830 5d2e 7661  c[:, filt_x0].va
+00029bd0: 6c75 6573 2021 3d20 2d39 3929 2026 205c  lues != -99) & \
+00029be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029bf0: 2020 2020 2020 2020 2020 2028 6361 745f             (cat_
+00029c00: 6461 7461 2e6c 6f63 5b3a 2c20 6669 6c74  data.loc[:, filt
+00029c10: 5f78 305d 2e76 616c 7565 7320 213d 2039  _x0].values != 9
+00029c20: 3929 2026 205c 0a20 2020 2020 2020 2020  9) & \.         
+00029c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029c40: 2028 6361 745f 6461 7461 2e6c 6f63 5b3a   (cat_data.loc[:
+00029c50: 2c20 6669 6c74 5f78 315d 2e76 616c 7565  , filt_x1].value
+00029c60: 7320 213d 202d 3939 2920 2620 5c0a 2020  s != -99) & \.  
+00029c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029c80: 2020 2020 2020 2020 2863 6174 5f64 6174          (cat_dat
+00029c90: 612e 6c6f 635b 3a2c 2066 696c 745f 7831  a.loc[:, filt_x1
+00029ca0: 5d2e 7661 6c75 6573 2021 3d20 3939 290a  ].values != 99).
+00029cb0: 0a20 2020 2020 2020 2066 6f72 2062 696e  .        for bin
+00029cc0: 5f69 2069 6e20 6269 6e73 5b3a 2d31 5d3a  _i in bins[:-1]:
+00029cd0: 0a0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00029ce0: 6665 7265 6e63 655f 6269 6e5f 6375 7420  ference_bin_cut 
+00029cf0: 3d20 2872 6566 6572 656e 6365 5f78 203e  = (reference_x >
+00029d00: 3d20 6269 6e5f 6929 2026 205c 0a20 2020  = bin_i) & \.   
+00029d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029d20: 2020 2020 2020 2020 2020 2020 2028 7265               (re
+00029d30: 6665 7265 6e63 655f 7820 3c20 6269 6e5f  ference_x < bin_
+00029d40: 6920 2b20 6465 6c74 615f 6269 6e29 0a0a  i + delta_bin)..
+00029d50: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00029d60: 5f62 696e 5f63 7574 203d 2028 6361 745f  _bin_cut = (cat_
+00029d70: 6461 7461 5f78 203e 3d20 6269 6e5f 6929  data_x >= bin_i)
+00029d80: 2026 205c 0a20 2020 2020 2020 2020 2020   & \.           
+00029d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029da0: 2863 6174 5f64 6174 615f 7820 3c20 6269  (cat_data_x < bi
+00029db0: 6e5f 6920 2b20 6465 6c74 615f 6269 6e29  n_i + delta_bin)
+00029dc0: 2026 205c 0a20 2020 2020 2020 2020 2020   & \.           
+00029dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029de0: 7265 6d6f 7665 5f62 6164 5f64 6174 610a  remove_bad_data.
+00029df0: 0a20 2020 2020 2020 2020 2020 2072 6566  .            ref
+00029e00: 6572 656e 6365 5f62 696e 5f79 203d 2072  erence_bin_y = r
+00029e10: 6566 6572 656e 6365 2e6c 6f63 5b72 6566  eference.loc[ref
+00029e20: 6572 656e 6365 5f62 696e 5f63 7574 2c20  erence_bin_cut, 
+00029e30: 6669 6c74 5d20 2d20 5c0a 2020 2020 2020  filt] - \.      
+00029e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029e50: 2020 2020 2020 2020 7265 6665 7265 6e63          referenc
+00029e60: 652e 6c6f 635b 7265 6665 7265 6e63 655f  e.loc[reference_
+00029e70: 6269 6e5f 6375 742c 2066 696c 745f 7265  bin_cut, filt_re
+00029e80: 665d 0a0a 2020 2020 2020 2020 2020 2020  f]..            
+00029e90: 6461 7461 5f62 696e 5f79 203d 2063 6174  data_bin_y = cat
+00029ea0: 5f64 6174 612e 6c6f 635b 6461 7461 5f62  _data.loc[data_b
+00029eb0: 696e 5f63 7574 2c20 6669 6c74 5d20 2d20  in_cut, filt] - 
+00029ec0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
+00029ed0: 2020 2020 2020 2020 2020 2063 6174 5f64             cat_d
+00029ee0: 6174 612e 6c6f 635b 6461 7461 5f62 696e  ata.loc[data_bin
+00029ef0: 5f63 7574 2c20 6669 6c74 5f72 6566 5d0a  _cut, filt_ref].
+00029f00: 0a20 2020 2020 2020 2020 2020 206d 6561  .            mea
+00029f10: 6e5f 7265 6665 7265 6e63 655f 6269 6e5f  n_reference_bin_
+00029f20: 7920 3d20 6d65 616e 5f72 6f62 7573 7428  y = mean_robust(
+00029f30: 7265 6665 7265 6e63 655f 6269 6e5f 7929  reference_bin_y)
+00029f40: 0a0a 2020 2020 2020 2020 2020 2020 6375  ..            cu
+00029f50: 745f 6f75 746c 6965 7273 203d 2028 6461  t_outliers = (da
+00029f60: 7461 5f62 696e 5f79 203e 202d 3529 2026  ta_bin_y > -5) &
+00029f70: 2028 6461 7461 5f62 696e 5f79 203c 2035   (data_bin_y < 5
+00029f80: 290a 2020 2020 2020 2020 2020 2020 6d65  ).            me
+00029f90: 616e 5f64 6174 615f 6269 6e5f 7920 3d20  an_data_bin_y = 
+00029fa0: 6d65 616e 5f72 6f62 7573 7428 6461 7461  mean_robust(data
+00029fb0: 5f62 696e 5f79 5b63 7574 5f6f 7574 6c69  _bin_y[cut_outli
+00029fc0: 6572 735d 2c20 302e 352c 2030 2e35 290a  ers], 0.5, 0.5).
+00029fd0: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
+00029fe0: 7461 5f6d 6167 2e61 7070 656e 6428 6d65  ta_mag.append(me
+00029ff0: 616e 5f72 6566 6572 656e 6365 5f62 696e  an_reference_bin
+0002a000: 5f79 202d 206d 6561 6e5f 6461 7461 5f62  _y - mean_data_b
+0002a010: 696e 5f79 290a 0a20 2020 2020 2020 2020  in_y)..         
+0002a020: 2020 2023 2323 230a 2020 2020 2020 2020     ####.        
+0002a030: 2020 2020 7265 6665 7265 6e63 655f 6269      reference_bi
+0002a040: 6e5f 795f 6c69 7374 2e61 7070 656e 6428  n_y_list.append(
+0002a050: 6d65 616e 5f72 6566 6572 656e 6365 5f62  mean_reference_b
+0002a060: 696e 5f79 290a 2020 2020 2020 2020 2020  in_y).          
+0002a070: 2020 6461 7461 5f62 696e 5f79 5f6c 6973    data_bin_y_lis
+0002a080: 742e 6170 7065 6e64 286d 6561 6e5f 6461  t.append(mean_da
+0002a090: 7461 5f62 696e 5f79 290a 2020 2020 2020  ta_bin_y).      
+0002a0a0: 2020 2020 2020 2323 2323 0a0a 2020 2020        ####..    
+0002a0b0: 2020 2020 2320 4361 6c63 756c 6174 6520      # Calculate 
+0002a0c0: 5a50 0a20 2020 2020 2020 2064 656c 7461  ZP.        delta
+0002a0d0: 5f6d 6167 203d 206e 702e 6172 7261 7928  _mag = np.array(
+0002a0e0: 6465 6c74 615f 6d61 6729 0a0a 2020 2020  delta_mag)..    
+0002a0f0: 2020 2020 7265 6665 7265 6e63 655f 6269      reference_bi
+0002a100: 6e5f 795f 6c69 7374 203d 206e 702e 6172  n_y_list = np.ar
+0002a110: 7261 7928 7265 6665 7265 6e63 655f 6269  ray(reference_bi
+0002a120: 6e5f 795f 6c69 7374 290a 2020 2020 2020  n_y_list).      
+0002a130: 2020 6461 7461 5f62 696e 5f79 5f6c 6973    data_bin_y_lis
+0002a140: 7420 3d20 6e70 2e61 7272 6179 2864 6174  t = np.array(dat
+0002a150: 615f 6269 6e5f 795f 6c69 7374 290a 0a20  a_bin_y_list).. 
+0002a160: 2020 2020 2020 2023 2047 6574 206f 7264         # Get ord
+0002a170: 6572 2074 6f20 7265 6d6f 7665 206d 6178  er to remove max
+0002a180: 2061 6e64 206d 696e 2076 616c 7565 730a   and min values.
+0002a190: 2020 2020 2020 2020 6f20 3d20 6e70 2e61          o = np.a
+0002a1a0: 7267 736f 7274 2864 656c 7461 5f6d 6167  rgsort(delta_mag
+0002a1b0: 290a 0a20 2020 2020 2020 207a 705f 6469  )..        zp_di
+0002a1c0: 6374 5b66 696c 745d 203d 206d 6561 6e5f  ct[filt] = mean_
+0002a1d0: 726f 6275 7374 2864 656c 7461 5f6d 6167  robust(delta_mag
+0002a1e0: 5b6f 5d5b 313a 2d31 5d29 0a20 2020 2020  [o][1:-1]).     
+0002a1f0: 2020 2070 7269 6e74 2866 227b 6669 6c74     print(f"{filt
+0002a200: 7d20 5a50 203d 207b 7a70 5f64 6963 745b  } ZP = {zp_dict[
+0002a210: 6669 6c74 5d3a 2e33 667d 2229 0a0a 2020  filt]:.3f}")..  
+0002a220: 2020 2020 2020 2323 2323 2323 230a 2020        #######.  
+0002a230: 2020 2020 2020 7361 7665 5f66 6967 5f6e        save_fig_n
+0002a240: 616d 6520 3d20 6622 7b66 6965 6c64 7d5f  ame = f"{field}_
+0002a250: 7b66 696c 747d 5f73 746c 6f63 7573 2e70  {filt}_stlocus.p
+0002a260: 6e67 220a 2020 2020 2020 2020 7361 7665  ng".        save
+0002a270: 5f66 6967 5f66 696c 6520 3d20 6f73 2e70  _fig_file = os.p
+0002a280: 6174 682e 6a6f 696e 2870 6c6f 745f 7061  ath.join(plot_pa
+0002a290: 7468 2c20 7361 7665 5f66 6967 5f6e 616d  th, save_fig_nam
+0002a2a0: 6529 0a0a 2020 2020 2020 2020 6966 2028  e)..        if (
+0002a2b0: 706c 6f74 5f70 6174 6820 6973 206e 6f74  plot_path is not
+0002a2c0: 204e 6f6e 6529 2061 6e64 2028 6e6f 7420   None) and (not 
+0002a2d0: 6f73 2e70 6174 682e 6578 6973 7473 2873  os.path.exists(s
+0002a2e0: 6176 655f 6669 675f 6669 6c65 2929 3a0a  ave_fig_file)):.
+0002a2f0: 0a20 2020 2020 2020 2020 2020 2078 203d  .            x =
+0002a300: 206e 702e 6172 7261 7928 6269 6e73 5b3a   np.array(bins[:
+0002a310: 2d31 5d29 202b 2064 656c 7461 5f62 696e  -1]) + delta_bin
+0002a320: 2f32 0a0a 2020 2020 2020 2020 2020 2020  /2..            
+0002a330: 706c 742e 7363 6174 7465 7228 7265 6665  plt.scatter(refe
+0002a340: 7265 6e63 655f 782c 0a20 2020 2020 2020  rence_x,.       
+0002a350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a360: 2072 6566 6572 656e 6365 2e6c 6f63 5b3a   reference.loc[:
+0002a370: 2c20 6669 6c74 5d20 2d20 7265 6665 7265  , filt] - refere
+0002a380: 6e63 652e 6c6f 635b 3a2c 2066 696c 745f  nce.loc[:, filt_
+0002a390: 7265 665d 2c0a 2020 2020 2020 2020 2020  ref],.          
+0002a3a0: 2020 2020 2020 2020 2020 2020 2020 7a6f                zo
+0002a3b0: 7264 6572 203d 2031 2c20 616c 7068 6120  rder = 1, alpha 
+0002a3c0: 3d20 302e 3032 2c20 636f 6c6f 7220 3d20  = 0.02, color = 
+0002a3d0: 2223 3434 3434 3434 2229 0a0a 2020 2020  "#444444")..    
+0002a3e0: 2020 2020 2020 2020 706c 742e 7363 6174          plt.scat
+0002a3f0: 7465 7228 785b 6f5d 5b31 3a2d 315d 2c20  ter(x[o][1:-1], 
+0002a400: 7265 6665 7265 6e63 655f 6269 6e5f 795f  reference_bin_y_
+0002a410: 6c69 7374 5b6f 5d5b 313a 2d31 5d2c 0a20  list[o][1:-1],. 
+0002a420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a430: 2020 2020 2020 2073 203d 2031 3030 2c20         s = 100, 
+0002a440: 6320 3d20 2223 3030 3030 3030 222c 207a  c = "#000000", z
+0002a450: 6f72 6465 7220 3d20 3329 0a0a 2020 2020  order = 3)..    
+0002a460: 2020 2020 2020 2020 706c 742e 7363 6174          plt.scat
+0002a470: 7465 7228 785b 6f5d 5b30 5d2c 2072 6566  ter(x[o][0], ref
+0002a480: 6572 656e 6365 5f62 696e 5f79 5f6c 6973  erence_bin_y_lis
+0002a490: 745b 6f5d 5b30 5d2c 0a20 2020 2020 2020  t[o][0],.       
+0002a4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a4b0: 2073 203d 2031 3030 2c20 6320 3d20 2223   s = 100, c = "#
+0002a4c0: 3030 3030 3030 222c 206d 6172 6b65 7220  000000", marker 
+0002a4d0: 3d20 2778 272c 207a 6f72 6465 7220 3d20  = 'x', zorder = 
+0002a4e0: 3329 0a0a 2020 2020 2020 2020 2020 2020  3)..            
+0002a4f0: 706c 742e 7363 6174 7465 7228 785b 6f5d  plt.scatter(x[o]
+0002a500: 5b2d 315d 2c20 7265 6665 7265 6e63 655f  [-1], reference_
+0002a510: 6269 6e5f 795f 6c69 7374 5b6f 5d5b 2d31  bin_y_list[o][-1
+0002a520: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0002a530: 2020 2020 2020 2020 2020 2073 203d 2031             s = 1
+0002a540: 3030 2c20 6320 3d20 2223 3030 3030 3030  00, c = "#000000
+0002a550: 222c 206d 6172 6b65 7220 3d20 2778 272c  ", marker = 'x',
+0002a560: 207a 6f72 6465 7220 3d20 3329 0a0a 2020   zorder = 3)..  
+0002a570: 2020 2020 2020 2020 2020 706c 742e 706c            plt.pl
+0002a580: 6f74 2878 2c20 7265 6665 7265 6e63 655f  ot(x, reference_
+0002a590: 6269 6e5f 795f 6c69 7374 2c20 636f 6c6f  bin_y_list, colo
+0002a5a0: 7220 3d20 2223 3030 3030 3030 222c 207a  r = "#000000", z
+0002a5b0: 6f72 6465 7220 3d20 3429 0a0a 2020 2020  order = 4)..    
+0002a5c0: 2020 2020 2020 2020 785f 6461 7461 203d          x_data =
+0002a5d0: 2063 6174 5f64 6174 615f 785b 7265 6d6f   cat_data_x[remo
+0002a5e0: 7665 5f62 6164 5f64 6174 615d 0a20 2020  ve_bad_data].   
+0002a5f0: 2020 2020 2020 2020 2079 5f64 6174 6120           y_data 
+0002a600: 3d20 6361 745f 6461 7461 2e6c 6f63 5b72  = cat_data.loc[r
+0002a610: 656d 6f76 655f 6261 645f 6461 7461 2c20  emove_bad_data, 
+0002a620: 6669 6c74 5d20 2d20 5c0a 2020 2020 2020  filt] - \.      
+0002a630: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0002a640: 6174 5f64 6174 612e 6c6f 635b 7265 6d6f  at_data.loc[remo
+0002a650: 7665 5f62 6164 5f64 6174 612c 2066 696c  ve_bad_data, fil
+0002a660: 745f 7265 665d 0a0a 2020 2020 2020 2020  t_ref]..        
+0002a670: 2020 2020 706c 742e 7363 6174 7465 7228      plt.scatter(
+0002a680: 785f 6461 7461 2c20 795f 6461 7461 2c20  x_data, y_data, 
+0002a690: 6320 3d20 2223 4141 3838 3030 222c 207a  c = "#AA8800", z
+0002a6a0: 6f72 6465 723d 322c 2061 6c70 6861 3d30  order=2, alpha=0
+0002a6b0: 2e32 290a 0a20 2020 2020 2020 2020 2020  .2)..           
+0002a6c0: 2070 6c74 2e73 6361 7474 6572 2878 5b6f   plt.scatter(x[o
+0002a6d0: 5d5b 313a 2d31 5d2c 2064 6174 615f 6269  ][1:-1], data_bi
+0002a6e0: 6e5f 795f 6c69 7374 5b6f 5d5b 313a 2d31  n_y_list[o][1:-1
+0002a6f0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0002a700: 2020 2020 2020 2020 2020 2073 203d 2031             s = 1
+0002a710: 3030 2c20 6320 3d20 2223 3636 3434 3030  00, c = "#664400
+0002a720: 222c 207a 6f72 6465 7220 3d20 3529 0a0a  ", zorder = 5)..
+0002a730: 2020 2020 2020 2020 2020 2020 706c 742e              plt.
+0002a740: 7363 6174 7465 7228 785b 6f5d 5b30 5d2c  scatter(x[o][0],
+0002a750: 2064 6174 615f 6269 6e5f 795f 6c69 7374   data_bin_y_list
+0002a760: 5b6f 5d5b 305d 2c0a 2020 2020 2020 2020  [o][0],.        
+0002a770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a780: 7320 3d20 3130 302c 2063 203d 2022 2330  s = 100, c = "#0
+0002a790: 3030 3030 3022 2c20 6d61 726b 6572 203d  00000", marker =
+0002a7a0: 2027 7827 2c20 7a6f 7264 6572 203d 2035   'x', zorder = 5
+0002a7b0: 290a 0a20 2020 2020 2020 2020 2020 2070  )..            p
+0002a7c0: 6c74 2e73 6361 7474 6572 2878 5b6f 5d5b  lt.scatter(x[o][
+0002a7d0: 2d31 5d2c 2064 6174 615f 6269 6e5f 795f  -1], data_bin_y_
+0002a7e0: 6c69 7374 5b6f 5d5b 2d31 5d2c 0a20 2020  list[o][-1],.   
+0002a7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a800: 2020 2020 2073 203d 2031 3030 2c20 6320       s = 100, c 
+0002a810: 3d20 2223 3030 3030 3030 222c 206d 6172  = "#000000", mar
+0002a820: 6b65 7220 3d20 2778 272c 207a 6f72 6465  ker = 'x', zorde
+0002a830: 7220 3d20 3529 0a0a 2020 2020 2020 2020  r = 5)..        
+0002a840: 2020 2020 706c 742e 706c 6f74 2878 2c20      plt.plot(x, 
+0002a850: 6461 7461 5f62 696e 5f79 5f6c 6973 742c  data_bin_y_list,
+0002a860: 2063 6f6c 6f72 203d 2022 2336 3634 3430   color = "#66440
+0002a870: 3022 2c20 7a6f 7264 6572 203d 2036 290a  0", zorder = 6).
+0002a880: 0a20 2020 2020 2020 2020 2020 2079 6d61  .            yma
+0002a890: 7820 3d20 6e70 2e6e 616e 6d61 7828 286e  x = np.nanmax((n
+0002a8a0: 702e 6d61 7828 7265 6665 7265 6e63 655f  p.max(reference_
+0002a8b0: 6269 6e5f 795f 6c69 7374 292c 0a20 2020  bin_y_list),.   
+0002a8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a8d0: 2020 2020 2020 206e 702e 6d61 7828 6461         np.max(da
+0002a8e0: 7461 5f62 696e 5f79 5f6c 6973 7429 2929  ta_bin_y_list)))
+0002a8f0: 202b 2031 0a20 2020 2020 2020 2020 2020   + 1.           
+0002a900: 2079 6d69 6e20 3d20 6e70 2e6e 616e 6d69   ymin = np.nanmi
+0002a910: 6e28 286e 702e 6d69 6e28 7265 6665 7265  n((np.min(refere
+0002a920: 6e63 655f 6269 6e5f 795f 6c69 7374 292c  nce_bin_y_list),
+0002a930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a940: 2020 2020 2020 2020 2020 206e 702e 6d69             np.mi
+0002a950: 6e28 6461 7461 5f62 696e 5f79 5f6c 6973  n(data_bin_y_lis
+0002a960: 7429 2929 202d 2031 0a0a 2020 2020 2020  t))) - 1..      
+0002a970: 2020 2020 2020 706c 742e 6763 6128 292e        plt.gca().
+0002a980: 7365 745f 786c 6162 656c 2866 227b 6669  set_xlabel(f"{fi
+0002a990: 6c74 5f78 307d 202d 207b 6669 6c74 5f78  lt_x0} - {filt_x
+0002a9a0: 317d 2229 0a20 2020 2020 2020 2020 2020  1}").           
+0002a9b0: 2070 6c74 2e67 6361 2829 2e73 6574 5f79   plt.gca().set_y
+0002a9c0: 6c61 6265 6c28 6622 7b66 696c 747d 202d  label(f"{filt} -
+0002a9d0: 207b 6669 6c74 5f72 6566 7d22 290a 2020   {filt_ref}").  
+0002a9e0: 2020 2020 2020 2020 2020 706c 742e 6763            plt.gc
+0002a9f0: 6128 292e 7365 745f 796c 696d 2828 796d  a().set_ylim((ym
+0002aa00: 696e 2c20 796d 6178 2929 0a20 2020 2020  in, ymax)).     
+0002aa10: 2020 2020 2020 2070 6c74 2e67 6361 2829         plt.gca()
+0002aa20: 2e73 6574 5f78 6c69 6d28 636f 6c6f 725f  .set_xlim(color_
+0002aa30: 7261 6e67 6529 0a20 2020 2020 2020 2020  range).         
+0002aa40: 2020 2070 6c74 2e73 6176 6566 6967 2873     plt.savefig(s
+0002aa50: 6176 655f 6669 675f 6669 6c65 290a 2020  ave_fig_file).  
+0002aa60: 2020 2020 2020 2020 2020 706c 742e 636c            plt.cl
+0002aa70: 6628 290a 2020 2020 2020 2020 2020 2020  f().            
+0002aa80: 706c 742e 636c 6f73 6528 290a 2020 2020  plt.close().    
+0002aa90: 2020 2020 2020 2020 2323 2323 2323 230a          #######.
+0002aaa0: 0a20 2020 2023 2057 7269 7465 207a 6572  .    # Write zer
+0002aab0: 6f2d 706f 696e 7473 2074 6f20 2e7a 7020  o-points to .zp 
+0002aac0: 6669 6c65 0a20 2020 207a 705f 7772 6974  file.    zp_writ
+0002aad0: 6528 7a70 5f64 6963 743d 7a70 5f64 6963  e(zp_dict=zp_dic
+0002aae0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0002aaf0: 7361 7665 5f66 696c 653d 7361 7665 5f66  save_file=save_f
+0002ab00: 696c 652c 0a20 2020 2020 2020 2020 2020  ile,.           
+0002ab10: 2020 6669 6c74 6572 735f 6c69 7374 3d66    filters_list=f
+0002ab20: 696c 7473 5f74 6f5f 6765 745f 7a70 290a  ilts_to_get_zp).
+0002ab30: 0a0a 6465 6620 7a70 5f63 6f6d 7061 7269  ..def zp_compari
+0002ab40: 736f 6e28 6669 656c 6473 5f7a 7073 2c20  son(fields_zps, 
+0002ab50: 7361 7665 5f66 696c 652c 2066 6965 6c64  save_file, field
+0002ab60: 735f 6c69 7374 293a 0a20 2020 2022 2222  s_list):.    """
+0002ab70: 0a20 2020 2043 7265 6174 6573 2061 2063  .    Creates a c
+0002ab80: 6f6d 7061 7269 736f 6e20 6669 6c65 2062  omparison file b
+0002ab90: 6574 7765 656e 2074 776f 207a 6572 6f20  etween two zero 
+0002aba0: 706f 696e 7473 2063 616c 6962 7261 7469  points calibrati
+0002abb0: 6f6e 7320 666f 7220 6120 6c69 7374 0a20  ons for a list. 
+0002abc0: 2020 206f 6620 6669 656c 6473 0a0a 2020     of fields..  
+0002abd0: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+0002abe0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+0002abf0: 6669 656c 6473 5f7a 7073 203a 2064 6963  fields_zps : dic
+0002ac00: 740a 2020 2020 2020 2020 4469 6374 696f  t.        Dictio
+0002ac10: 6e61 7279 2066 6f72 6d61 7465 6420 6173  nary formated as
+0002ac20: 2066 6965 6c64 735f 7a70 735b 2a66 6965   fields_zps[*fie
+0002ac30: 6c64 2a5d 203d 205b 7a70 5f66 696c 6531  ld*] = [zp_file1
+0002ac40: 2c20 7a70 5f66 696c 6532 5d2c 0a20 2020  , zp_file2],.   
+0002ac50: 2020 2020 2077 6865 7265 207a 705f 6669       where zp_fi
+0002ac60: 6c65 2063 6f72 7265 7370 6f6e 6473 2074  le corresponds t
+0002ac70: 6f20 7468 6520 2e7a 7020 6669 6c65 206f  o the .zp file o
+0002ac80: 6620 6561 6368 2063 616c 6962 7261 7469  f each calibrati
+0002ac90: 6f6e 2074 6f0a 2020 2020 2020 2020 636f  on to.        co
+0002aca0: 6d70 6172 650a 2020 2020 6669 656c 6473  mpare.    fields
+0002acb0: 5f6c 6973 7420 3a20 6c69 7374 0a20 2020  _list : list.   
+0002acc0: 2020 2020 204c 6973 7420 6f66 2066 696c       List of fil
+0002acd0: 7465 7273 2e20 4966 204e 6f6e 6520 7468  ters. If None th
+0002ace0: 6520 6c69 7374 2069 7320 7461 6b69 6e67  e list is taking
+0002acf0: 2066 726f 6d20 6669 656c 6473 5f7a 7073   from fields_zps
+0002ad00: 2e6b 6579 7328 292c 0a20 2020 2020 2020  .keys(),.       
+0002ad10: 2061 6c74 686f 7567 6820 696e 2074 6869   although in thi
+0002ad20: 7320 6361 7365 2074 6865 206f 7264 6572  s case the order
+0002ad30: 206f 6620 7468 6520 6669 656c 6473 2077   of the fields w
+0002ad40: 696c 6c20 6265 2072 616e 646f 6d69 7a65  ill be randomize
+0002ad50: 640a 2020 2020 7361 7665 5f66 696c 6520  d.    save_file 
+0002ad60: 3a20 7374 720a 2020 2020 2020 2020 4c6f  : str.        Lo
+0002ad70: 6361 7469 6f6e 2074 6f20 7361 7665 2074  cation to save t
+0002ad80: 6865 2072 6573 756c 7469 6e67 2063 6f6d  he resulting com
+0002ad90: 7061 7269 736f 6e20 6669 6c65 0a0a 2020  parison file..  
+0002ada0: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+0002adb0: 2d2d 2d2d 2d0a 2020 2020 5361 7665 7320  -----.    Saves 
+0002adc0: 6120 2e63 6174 2074 6162 6c65 2077 6974  a .cat table wit
+0002add0: 6820 7a65 726f 2070 6f69 6e74 7320 6672  h zero points fr
+0002ade0: 6f6d 2062 6f74 6820 6361 6c69 6272 6174  om both calibrat
+0002adf0: 696f 6e73 2061 6e64 2074 6865 6972 0a20  ions and their. 
+0002ae00: 2020 2064 6966 6665 7265 6e63 6573 0a20     differences. 
+0002ae10: 2020 2022 2222 0a0a 2020 2020 2323 2323     """..    ####
+0002ae20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0002ae30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0002ae40: 2323 2323 230a 2020 2020 2320 4765 7420  #####.    # Get 
+0002ae50: 6c69 7374 206f 6620 6669 6c74 6572 7320  list of filters 
+0002ae60: 6672 6f6d 2066 6972 7374 202e 7a70 2066  from first .zp f
+0002ae70: 696c 650a 2020 2020 6669 656c 6430 2020  ile.    field0  
+0002ae80: 203d 206c 6973 7428 6669 656c 6473 5f7a   = list(fields_z
+0002ae90: 7073 2e6b 6579 7328 2929 5b30 5d0a 2020  ps.keys())[0].  
+0002aea0: 2020 7a70 5f66 696c 6530 203d 2066 6965    zp_file0 = fie
+0002aeb0: 6c64 735f 7a70 735b 6669 656c 6430 5d5b  lds_zps[field0][
+0002aec0: 305d 0a0a 2020 2020 6669 6c74 6572 7320  0]..    filters 
+0002aed0: 3d20 6e70 2e67 656e 6672 6f6d 7478 7428  = np.genfromtxt(
+0002aee0: 7a70 5f66 696c 6530 2c20 6474 7970 653d  zp_file0, dtype=
+0002aef0: 7374 722c 2075 7365 636f 6c73 3d5b 305d  str, usecols=[0]
+0002af00: 290a 0a20 2020 2023 2323 2323 2323 2323  )..    #########
+0002af10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0002af20: 2323 2323 230a 2020 2020 2320 4372 6561  #####.    # Crea
+0002af30: 7465 2063 6f6d 7061 7269 736f 6e20 6461  te comparison da
+0002af40: 7461 2066 7261 6d65 0a20 2020 2069 6620  ta frame.    if 
+0002af50: 6669 656c 6473 5f6c 6973 7420 6973 204e  fields_list is N
+0002af60: 6f6e 653a 0a20 2020 2020 2020 2066 6965  one:.        fie
+0002af70: 6c64 7320 3d20 6669 656c 6473 5f7a 7073  lds = fields_zps
+0002af80: 2e6b 6579 7328 290a 2020 2020 656c 7365  .keys().    else
+0002af90: 3a0a 2020 2020 2020 2020 6669 656c 6473  :.        fields
+0002afa0: 203d 2066 6965 6c64 735f 6c69 7374 0a0a   = fields_list..
+0002afb0: 2020 2020 7a70 5f64 6174 6120 3d20 7064      zp_data = pd
+0002afc0: 2e44 6174 6146 7261 6d65 2829 0a0a 2020  .DataFrame()..  
+0002afd0: 2020 7a70 5f64 6174 615b 2766 6965 6c64    zp_data['field
+0002afe0: 275d 203d 2066 6965 6c64 730a 2020 2020  '] = fields.    
+0002aff0: 666f 7220 6669 6c74 2069 6e20 6669 6c74  for filt in filt
+0002b000: 6572 733a 0a20 2020 2020 2020 207a 705f  ers:.        zp_
+0002b010: 6461 7461 5b66 277a 705f 7b66 696c 747d  data[f'zp_{filt}
+0002b020: 5f31 275d 203d 206e 702e 6675 6c6c 286c  _1'] = np.full(l
+0002b030: 656e 2866 6965 6c64 7329 2c20 6e70 2e6e  en(fields), np.n
+0002b040: 616e 290a 2020 2020 2020 2020 7a70 5f64  an).        zp_d
+0002b050: 6174 615b 6627 7a70 5f7b 6669 6c74 7d5f  ata[f'zp_{filt}_
+0002b060: 3227 5d20 3d20 6e70 2e66 756c 6c28 6c65  2'] = np.full(le
+0002b070: 6e28 6669 656c 6473 292c 206e 702e 6e61  n(fields), np.na
+0002b080: 6e29 0a20 2020 2020 2020 207a 705f 6461  n).        zp_da
+0002b090: 7461 5b66 277a 705f 7b66 696c 747d 5f64  ta[f'zp_{filt}_d
+0002b0a0: 6966 6627 5d20 3d20 6e70 2e66 756c 6c28  iff'] = np.full(
+0002b0b0: 6c65 6e28 6669 656c 6473 292c 206e 702e  len(fields), np.
+0002b0c0: 6e61 6e29 0a0a 2020 2020 2323 2323 2323  nan)..    ######
+0002b0d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0002b0e0: 2323 2323 2323 0a20 2020 2023 2046 696c  ######.    # Fil
+0002b0f0: 6c20 636f 6d70 6172 6973 6f6e 2064 6174  l comparison dat
+0002b100: 6120 6672 616d 650a 2020 2020 666f 7220  a frame.    for 
+0002b110: 6920 696e 2072 616e 6765 286c 656e 2866  i in range(len(f
+0002b120: 6965 6c64 7329 293a 0a0a 2020 2020 2020  ields)):..      
+0002b130: 2020 6669 656c 6420 3d20 6669 656c 6473    field = fields
+0002b140: 5b69 5d0a 2020 2020 2020 2020 7472 793a  [i].        try:
+0002b150: 0a20 2020 2020 2020 2020 2020 207a 7031  .            zp1
+0002b160: 203d 207a 705f 7265 6164 2866 6965 6c64   = zp_read(field
+0002b170: 735f 7a70 735b 6669 656c 645d 5b30 5d29  s_zps[field][0])
+0002b180: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0002b190: 4f53 4572 726f 723a 0a20 2020 2020 2020  OSError:.       
+0002b1a0: 2020 2020 207a 7031 203d 204e 6f6e 650a       zp1 = None.
+0002b1b0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+0002b1c0: 2020 2020 2020 2020 2020 7a70 3220 3d20            zp2 = 
+0002b1d0: 7a70 5f72 6561 6428 6669 656c 6473 5f7a  zp_read(fields_z
+0002b1e0: 7073 5b66 6965 6c64 5d5b 315d 290a 2020  ps[field][1]).  
+0002b1f0: 2020 2020 2020 6578 6365 7074 204f 5345        except OSE
+0002b200: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+0002b210: 2020 7a70 3220 3d20 4e6f 6e65 0a0a 2020    zp2 = None..  
+0002b220: 2020 2020 2020 666f 7220 6669 6c74 2069        for filt i
+0002b230: 6e20 6669 6c74 6572 733a 0a0a 2020 2020  n filters:..    
+0002b240: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0002b250: 2020 2020 2020 2020 2020 2020 207a 705f               zp_
+0002b260: 6461 7461 2e6c 6f63 5b69 2c20 6627 7a70  data.loc[i, f'zp
+0002b270: 5f7b 6669 6c74 7d5f 3127 5d20 3d20 7a70  _{filt}_1'] = zp
+0002b280: 315b 6669 6c74 5d0a 2020 2020 2020 2020  1[filt].        
+0002b290: 2020 2020 6578 6365 7074 204b 6579 4572      except KeyEr
+0002b2a0: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0002b2b0: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
+0002b2c0: 2020 2020 2020 6578 6365 7074 2054 7970        except Typ
+0002b2d0: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
+0002b2e0: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
+0002b2f0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0002b300: 2020 2020 2020 2020 2020 2020 2020 207a                 z
+0002b310: 705f 6461 7461 2e6c 6f63 5b69 2c20 6627  p_data.loc[i, f'
+0002b320: 7a70 5f7b 6669 6c74 7d5f 3227 5d20 3d20  zp_{filt}_2'] = 
+0002b330: 7a70 325b 6669 6c74 5d0a 2020 2020 2020  zp2[filt].      
+0002b340: 2020 2020 2020 6578 6365 7074 204b 6579        except Key
+0002b350: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+0002b360: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
+0002b370: 2020 2020 2020 2020 6578 6365 7074 2054          except T
+0002b380: 7970 6545 7272 6f72 3a0a 2020 2020 2020  ypeError:.      
+0002b390: 2020 2020 2020 2020 2020 7061 7373 0a0a            pass..
+0002b3a0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+0002b3b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b3c0: 2064 6966 6620 3d20 7a70 315b 6669 6c74   diff = zp1[filt
+0002b3d0: 5d20 2d20 7a70 325b 6669 6c74 5d0a 2020  ] - zp2[filt].  
+0002b3e0: 2020 2020 2020 2020 2020 2020 2020 7a70                zp
+0002b3f0: 5f64 6174 612e 6c6f 635b 692c 2066 277a  _data.loc[i, f'z
+0002b400: 705f 7b66 696c 747d 5f64 6966 6627 5d20  p_{filt}_diff'] 
+0002b410: 3d20 6e70 2e61 726f 756e 6428 6469 6666  = np.around(diff
+0002b420: 2c20 3529 0a20 2020 2020 2020 2020 2020  , 5).           
+0002b430: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
+0002b440: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002b450: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
+0002b460: 2020 2065 7863 6570 7420 5479 7065 4572     except TypeEr
+0002b470: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0002b480: 2020 2020 2070 6173 730a 0a20 2020 2023       pass..    #
+0002b490: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0002b4a0: 0a20 2020 2023 2053 6176 6520 6461 7461  .    # Save data
+0002b4b0: 2066 7261 6d65 0a20 2020 2077 6974 6820   frame.    with 
+0002b4c0: 6f70 656e 2873 6176 655f 6669 6c65 2c20  open(save_file, 
+0002b4d0: 2777 2729 2061 7320 663a 0a20 2020 2020  'w') as f:.     
+0002b4e0: 2020 2066 2e77 7269 7465 2822 2320 2229     f.write("# ")
+0002b4f0: 0a20 2020 2020 2020 207a 705f 6461 7461  .        zp_data
+0002b500: 2e74 6f5f 6373 7628 662c 2069 6e64 6578  .to_csv(f, index
+0002b510: 203d 2046 616c 7365 2c20 7365 7020 3d20   = False, sep = 
+0002b520: 222c 2229 0a0a 0a64 6566 207a 705f 6669  ",")...def zp_fi
+0002b530: 745f 6f66 6673 6574 7328 7a70 5f63 6f6d  t_offsets(zp_com
+0002b540: 7061 7269 736f 6e5f 6669 6c65 2c20 7361  parison_file, sa
+0002b550: 7665 5f66 696c 652c 2066 696c 7465 7273  ve_file, filters
+0002b560: 293a 0a20 2020 2022 2222 0a20 2020 2066  ):.    """.    f
+0002b570: 6974 206f 6666 7365 7473 2062 6574 7765  it offsets betwe
+0002b580: 656e 2074 6865 207a 6572 6f2d 706f 696e  en the zero-poin
+0002b590: 7473 206f 6274 6169 6e65 6420 6672 6f6d  ts obtained from
+0002b5a0: 2074 776f 2064 6966 6665 7265 6e74 2063   two different c
+0002b5b0: 616c 6962 7261 7469 6f6e 730a 0a20 2020  alibrations..   
+0002b5c0: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+0002b5d0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 207a  ----------.    z
+0002b5e0: 705f 636f 6d70 6172 6973 6f6e 5f66 696c  p_comparison_fil
+0002b5f0: 6520 3a20 7374 720a 2020 2020 2020 2020  e : str.        
+0002b600: 4c6f 6361 7469 6f6e 206f 6620 7468 6520  Location of the 
+0002b610: 2e63 6174 207a 6572 6f2d 706f 696e 7420  .cat zero-point 
+0002b620: 636f 6d70 6172 6973 6f6e 2063 6174 616c  comparison catal
+0002b630: 6f67 0a20 2020 2020 2020 2028 6f75 7470  og.        (outp
+0002b640: 7574 206f 6620 6675 6e63 3a7a 705f 636f  ut of func:zp_co
+0002b650: 6d70 6172 6973 6f6e 290a 0a20 2020 2073  mparison)..    s
+0002b660: 6176 655f 6669 6c65 203a 2073 7472 0a20  ave_file : str. 
+0002b670: 2020 2020 2020 204c 6f63 6174 696f 6e20         Location 
+0002b680: 746f 2073 6176 6520 6f66 6673 6574 207a  to save offset z
+0002b690: 7020 6669 6c65 0a0a 2020 2020 6669 6c74  p file..    filt
+0002b6a0: 6572 7320 3a20 6c69 7374 0a20 2020 2020  ers : list.     
+0002b6b0: 2020 204c 6973 7420 6f66 2066 696c 7465     List of filte
+0002b6c0: 7273 2074 6f20 6573 7469 6d61 7465 206f  rs to estimate o
+0002b6d0: 6666 7365 7473 0a0a 2020 2020 5265 7475  ffsets..    Retu
+0002b6e0: 726e 730a 2020 2020 2d2d 2d2d 2d2d 2d0a  rns.    -------.
+0002b6f0: 2020 2020 5361 7665 7320 2e7a 7020 6669      Saves .zp fi
+0002b700: 6c65 2077 6974 6820 7468 6520 6f66 6673  le with the offs
+0002b710: 6574 7320 746f 2062 6520 6170 706c 6965  ets to be applie
+0002b720: 640a 2020 2020 2222 220a 0a20 2020 206f  d.    """..    o
+0002b730: 6666 7365 7473 203d 207b 7d0a 2020 2020  ffsets = {}.    
+0002b740: 7a70 5f64 6966 6620 3d20 7064 2e72 6561  zp_diff = pd.rea
+0002b750: 645f 6373 7628 7a70 5f63 6f6d 7061 7269  d_csv(zp_compari
+0002b760: 736f 6e5f 6669 6c65 2c20 6573 6361 7065  son_file, escape
+0002b770: 6368 6172 3d27 2327 2c0a 2020 2020 2020  char='#',.      
+0002b780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b790: 2020 2020 2020 2020 2073 6b69 7069 6e69           skipini
+0002b7a0: 7469 616c 7370 6163 653d 5472 7565 290a  tialspace=True).
+0002b7b0: 0a20 2020 2066 6f72 2066 696c 7420 696e  .    for filt in
+0002b7c0: 2066 696c 7465 7273 3a0a 2020 2020 2020   filters:.      
+0002b7d0: 2020 6469 6666 5f61 7272 6179 203d 206e    diff_array = n
+0002b7e0: 702e 6172 7261 7928 7a70 5f64 6966 665b  p.array(zp_diff[
+0002b7f0: 6627 7a70 5f7b 6669 6c74 7d5f 6469 6666  f'zp_{filt}_diff
+0002b800: 275d 290a 2020 2020 2020 2020 6469 6666  ']).        diff
+0002b810: 5f61 7272 6179 203d 2064 6966 665f 6172  _array = diff_ar
+0002b820: 7261 795b 7e6e 702e 6973 6e61 6e28 6469  ray[~np.isnan(di
+0002b830: 6666 5f61 7272 6179 295d 0a20 2020 2020  ff_array)].     
+0002b840: 2020 2064 6966 665f 6172 7261 7920 3d20     diff_array = 
+0002b850: 6469 6666 5f61 7272 6179 2e72 6573 6861  diff_array.resha
+0002b860: 7065 282d 312c 2031 290a 0a20 2020 2020  pe(-1, 1)..     
+0002b870: 2020 206b 6465 5f64 656e 7320 3d20 4b65     kde_dens = Ke
+0002b880: 726e 656c 4465 6e73 6974 7928 6b65 726e  rnelDensity(kern
+0002b890: 656c 3d27 6761 7573 7369 616e 272c 2062  el='gaussian', b
+0002b8a0: 616e 6477 6964 7468 3d30 2e30 3529 0a20  andwidth=0.05). 
+0002b8b0: 2020 2020 2020 206b 6465 5f64 656e 7320         kde_dens 
+0002b8c0: 3d20 6b64 655f 6465 6e73 2e66 6974 2864  = kde_dens.fit(d
+0002b8d0: 6966 665f 6172 7261 7929 0a0a 2020 2020  iff_array)..    
+0002b8e0: 2020 2020 2320 5472 616e 7366 6f72 6d20      # Transform 
+0002b8f0: 746f 206b 6465 0a20 2020 2020 2020 2078  to kde.        x
+0002b900: 203d 206e 702e 6172 616e 6765 282d 312c   = np.arange(-1,
+0002b910: 2031 2c20 302e 3030 3129 0a20 2020 2020   1, 0.001).     
+0002b920: 2020 2079 203d 206e 702e 6578 7028 6b64     y = np.exp(kd
+0002b930: 655f 6465 6e73 2e73 636f 7265 5f73 616d  e_dens.score_sam
+0002b940: 706c 6573 2878 2e72 6573 6861 7065 282d  ples(x.reshape(-
+0002b950: 312c 2031 2929 290a 0a20 2020 2020 2020  1, 1)))..       
+0002b960: 2023 2067 6574 206d 6f64 650a 2020 2020   # get mode.    
+0002b970: 2020 2020 6d6f 6465 203d 2078 5b79 203d      mode = x[y =
+0002b980: 3d20 6e70 2e6d 6178 2879 295d 5b30 5d0a  = np.max(y)][0].
+0002b990: 0a20 2020 2020 2020 206f 6666 7365 7473  .        offsets
+0002b9a0: 5b66 696c 745d 203d 206d 6f64 650a 0a20  [filt] = mode.. 
+0002b9b0: 2020 207a 705f 7772 6974 6528 7a70 5f64     zp_write(zp_d
+0002b9c0: 6963 743d 6f66 6673 6574 732c 0a20 2020  ict=offsets,.   
+0002b9d0: 2020 2020 2020 2020 2020 7361 7665 5f66            save_f
+0002b9e0: 696c 653d 7361 7665 5f66 696c 652c 0a20  ile=save_file,. 
+0002b9f0: 2020 2020 2020 2020 2020 2020 6669 6c74              filt
+0002ba00: 6572 735f 6c69 7374 3d66 696c 7465 7273  ers_list=filters
+0002ba10: 290a 0a0a 2323 2323 2323 2323 2323 2323  )...############
+0002ba20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0002ba30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0002ba40: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 0002ba50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002ba60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002ba70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002ba80: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002ba90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002baa0: 0a23 2043 6174 616c 6f67 2070 7265 7061  .# Catalog prepa
-0002bab0: 7261 7469 6f6e 0a0a 6465 6620 7365 7863  ration..def sexc
-0002bac0: 6174 616c 6f67 5f61 7070 6c79 5f63 616c  atalog_apply_cal
-0002bad0: 6962 7261 7469 6f6e 2863 6174 616c 6f67  ibration(catalog
-0002bae0: 5f66 696c 652c 207a 705f 6669 6c65 2c20  _file, zp_file, 
-0002baf0: 7361 7665 5f66 696c 652c 0a20 2020 2020  save_file,.     
+0002ba60: 2323 2323 0a23 2043 6174 616c 6f67 2070  ####.# Catalog p
+0002ba70: 7265 7061 7261 7469 6f6e 0a0a 6465 6620  reparation..def 
+0002ba80: 7365 7863 6174 616c 6f67 5f61 7070 6c79  sexcatalog_apply
+0002ba90: 5f63 616c 6962 7261 7469 6f6e 2863 6174  _calibration(cat
+0002baa0: 616c 6f67 5f66 696c 652c 207a 705f 6669  alog_file, zp_fi
+0002bab0: 6c65 2c20 7361 7665 5f66 696c 652c 0a20  le, save_file,. 
+0002bac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bae0: 6669 6c74 6572 5f6e 616d 652c 2066 6965  filter_name, fie
+0002baf0: 6c64 2c20 7365 785f 6d61 675f 7a70 2c0a  ld, sex_mag_zp,.
 0002bb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bb10: 2020 2020 2020 2020 2020 2020 6669 6c74              filt
-0002bb20: 6572 5f6e 616d 652c 2066 6965 6c64 2c20  er_name, field, 
-0002bb30: 7365 785f 6d61 675f 7a70 2c0a 2020 2020  sex_mag_zp,.    
-0002bb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bb50: 2020 2020 2020 2020 2020 2020 2063 616c               cal
-0002bb60: 6962 7261 7469 6f6e 5f66 6c61 672c 206d  ibration_flag, m
-0002bb70: 6f64 6520 3d20 2764 7561 6c27 2c0a 2020  ode = 'dual',.  
+0002bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bb20: 2063 616c 6962 7261 7469 6f6e 5f66 6c61   calibration_fla
+0002bb30: 672c 206d 6f64 6520 3d20 2764 7561 6c27  g, mode = 'dual'
+0002bb40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002bb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bb60: 2020 2063 616c 6962 7261 7469 6f6e 5f6e     calibration_n
+0002bb70: 616d 653d 4e6f 6e65 2c0a 2020 2020 2020  ame=None,.      
 0002bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bb90: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002bba0: 616c 6962 7261 7469 6f6e 5f6e 616d 653d  alibration_name=
-0002bbb0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-0002bbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bbd0: 2020 2020 2020 2064 726e 616d 653d 274e         drname='N
-0002bbe0: 6f44 526e 616d 6527 2c0a 2020 2020 2020  oDRname',.      
+0002bb90: 2020 2020 2020 2020 2020 2064 726e 616d             drnam
+0002bba0: 653d 274e 6f44 526e 616d 6527 2c0a 2020  e='NoDRname',.  
+0002bbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bbc0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0002bbd0: 7874 696e 6374 696f 6e5f 6d61 7073 5f70  xtinction_maps_p
+0002bbe0: 6174 683d 4e6f 6e65 2c0a 2020 2020 2020  ath=None,.      
 0002bbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0002bc00: 2020 2020 2020 2020 2020 2065 7874 696e             extin
-0002bc10: 6374 696f 6e5f 6d61 7073 5f70 6174 683d  ction_maps_path=
-0002bc20: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-0002bc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bc40: 2020 2020 2020 2065 7874 696e 6374 696f         extinctio
-0002bc50: 6e5f 636f 7272 6563 7469 6f6e 3d4e 6f6e  n_correction=Non
-0002bc60: 6529 3a0a 2020 2020 2222 220a 0a20 2020  e):.    """..   
-0002bc70: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-0002bc80: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063  ----------.    c
-0002bc90: 6174 616c 6f67 5f66 696c 650a 2020 2020  atalog_file.    
-0002bca0: 7a70 5f66 696c 650a 2020 2020 7361 7665  zp_file.    save
-0002bcb0: 5f66 696c 650a 2020 2020 6669 6c74 6572  _file.    filter
-0002bcc0: 5f6e 616d 650a 2020 2020 6170 6572 7475  _name.    apertu
-0002bcd0: 7265 730a 2020 2020 6f74 6865 725f 636f  res.    other_co
-0002bce0: 6c75 6d6e 730a 0a20 2020 2052 6574 7572  lumns..    Retur
-0002bcf0: 6e73 0a20 2020 202d 2d2d 2d2d 2d2d 0a0a  ns.    -------..
-0002bd00: 2020 2020 2222 220a 0a20 2020 2023 204c      """..    # L
-0002bd10: 6f61 6420 7068 6f74 6f6d 6574 7279 2063  oad photometry c
-0002bd20: 6174 616c 6f67 2028 7769 7468 2061 7065  atalog (with ape
-0002bd30: 7274 7572 6520 636f 7272 6563 7469 6f6e  rture correction
-0002bd40: 290a 2020 2020 7068 6f74 5f63 6174 203d  ).    phot_cat =
-0002bd50: 2066 6974 732e 6f70 656e 2863 6174 616c   fits.open(catal
-0002bd60: 6f67 5f66 696c 6529 0a20 2020 2070 686f  og_file).    pho
-0002bd70: 745f 6361 7420 3d20 7068 6f74 5f63 6174  t_cat = phot_cat
-0002bd80: 5b31 5d2e 6461 7461 0a0a 2020 2020 4e5f  [1].data..    N_
-0002bd90: 736f 7572 6365 7320 3d20 6c65 6e28 7068  sources = len(ph
-0002bda0: 6f74 5f63 6174 290a 0a20 2020 2023 204c  ot_cat)..    # L
-0002bdb0: 6f61 6420 5a50 0a20 2020 205a 5073 203d  oad ZP.    ZPs =
-0002bdc0: 207a 705f 7265 6164 287a 705f 6669 6c65   zp_read(zp_file
-0002bdd0: 290a 2020 2020 5a50 203d 205a 5073 5b66  ).    ZP = ZPs[f
-0002bde0: 2753 504c 5553 5f7b 6669 6c74 6572 5f6e  'SPLUS_{filter_n
-0002bdf0: 616d 657d 275d 0a0a 2020 2020 2320 5374  ame}']..    # St
-0002be00: 616e 6461 7264 2066 696c 7465 7220 6e61  andard filter na
-0002be10: 6d65 0a20 2020 2066 696c 745f 7374 616e  me.    filt_stan
-0002be20: 6461 7264 203d 2074 7261 6e73 6c61 7465  dard = translate
-0002be30: 5f66 696c 7465 725f 7374 616e 6461 7264  _filter_standard
-0002be40: 2866 696c 7465 725f 6e61 6d65 290a 0a20  (filter_name).. 
-0002be50: 2020 2023 2043 7265 6174 6520 6e65 7720     # Create new 
-0002be60: 6461 7461 2054 6162 6c65 0a20 2020 2063  data Table.    c
-0002be70: 6174 203d 205b 5d0a 0a20 2020 2023 2046  at = []..    # F
-0002be80: 696c 6c20 6e65 7720 6461 7461 2054 6162  ill new data Tab
-0002be90: 6c65 2023 2323 2323 2323 2323 2323 2323  le #############
-0002bea0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002beb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002bec0: 2323 2323 2323 2323 230a 0a20 2020 2023  #########..    #
-0002bed0: 2046 6965 6c64 2063 6f6c 756d 6e0a 2020   Field column.  
-0002bee0: 2020 6361 742e 6170 7065 6e64 2866 6974    cat.append(fit
-0002bef0: 732e 436f 6c75 6d6e 286e 616d 653d 2746  s.Column(name='F
-0002bf00: 6965 6c64 272c 0a20 2020 2020 2020 2020  ield',.         
-0002bf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bf20: 2020 666f 726d 6174 3d27 2564 4127 2025    format='%dA' %
-0002bf30: 206c 656e 2866 6965 6c64 292c 0a20 2020   len(field),.   
-0002bf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bf50: 2020 2020 2020 2020 6172 7261 793d 4e5f          array=N_
-0002bf60: 736f 7572 6365 732a 5b66 6965 6c64 5d29  sources*[field])
-0002bf70: 290a 0a20 2020 2023 2046 4945 4c44 2049  )..    # FIELD I
-0002bf80: 440a 2020 2020 7068 6f74 5f63 6174 2e63  D.    phot_cat.c
-0002bf90: 6f6c 756d 6e73 5b66 2746 4945 4c44 5f49  olumns[f'FIELD_I
-0002bfa0: 4427 5d2e 6e61 6d65 203d 2066 2749 4427  D'].name = f'ID'
-0002bfb0: 0a20 2020 2063 6174 2e61 7070 656e 6428  .    cat.append(
-0002bfc0: 7068 6f74 5f63 6174 2e63 6f6c 756d 6e73  phot_cat.columns
-0002bfd0: 5b66 2749 4427 5d29 0a20 2020 2070 686f  [f'ID']).    pho
-0002bfe0: 745f 6361 742e 636f 6c75 6d6e 735b 6627  t_cat.columns[f'
-0002bff0: 4649 454c 445f 4944 5f52 4127 5d2e 6e61  FIELD_ID_RA'].na
-0002c000: 6d65 203d 2066 2749 445f 5241 270a 2020  me = f'ID_RA'.  
-0002c010: 2020 6361 742e 6170 7065 6e64 2870 686f    cat.append(pho
-0002c020: 745f 6361 742e 636f 6c75 6d6e 735b 6627  t_cat.columns[f'
-0002c030: 4944 5f52 4127 5d29 0a20 2020 2070 686f  ID_RA']).    pho
-0002c040: 745f 6361 742e 636f 6c75 6d6e 735b 6627  t_cat.columns[f'
-0002c050: 4649 454c 445f 4944 5f44 4543 275d 2e6e  FIELD_ID_DEC'].n
-0002c060: 616d 6520 3d20 6627 4944 5f44 4543 270a  ame = f'ID_DEC'.
-0002c070: 2020 2020 6361 742e 6170 7065 6e64 2870      cat.append(p
-0002c080: 686f 745f 6361 742e 636f 6c75 6d6e 735b  hot_cat.columns[
-0002c090: 6627 4944 5f44 4543 275d 290a 0a20 2020  f'ID_DEC'])..   
-0002c0a0: 2023 2046 696c 7465 7220 4944 0a20 2020   # Filter ID.   
-0002c0b0: 2069 6620 6d6f 6465 203d 3d20 2273 696e   if mode == "sin
-0002c0c0: 676c 6522 3a0a 2020 2020 2020 2020 6361  gle":.        ca
-0002c0d0: 742e 6170 7065 6e64 2870 686f 745f 6361  t.append(phot_ca
-0002c0e0: 742e 636f 6c75 6d6e 735b 6627 5048 4f54  t.columns[f'PHOT
-0002c0f0: 5f49 445f 7369 6e67 6c65 275d 290a 2020  _ID_single']).  
-0002c100: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
-0002c110: 2870 686f 745f 6361 742e 636f 6c75 6d6e  (phot_cat.column
-0002c120: 735b 6627 5048 4f54 5f49 445f 5241 5f73  s[f'PHOT_ID_RA_s
+0002bc10: 6374 696f 6e5f 636f 7272 6563 7469 6f6e  ction_correction
+0002bc20: 3d4e 6f6e 6529 3a0a 2020 2020 2222 220a  =None):.    """.
+0002bc30: 0a20 2020 2050 6172 616d 6574 6572 730a  .    Parameters.
+0002bc40: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+0002bc50: 2020 2063 6174 616c 6f67 5f66 696c 650a     catalog_file.
+0002bc60: 2020 2020 7a70 5f66 696c 650a 2020 2020      zp_file.    
+0002bc70: 7361 7665 5f66 696c 650a 2020 2020 6669  save_file.    fi
+0002bc80: 6c74 6572 5f6e 616d 650a 2020 2020 6170  lter_name.    ap
+0002bc90: 6572 7475 7265 730a 2020 2020 6f74 6865  ertures.    othe
+0002bca0: 725f 636f 6c75 6d6e 730a 0a20 2020 2052  r_columns..    R
+0002bcb0: 6574 7572 6e73 0a20 2020 202d 2d2d 2d2d  eturns.    -----
+0002bcc0: 2d2d 0a0a 2020 2020 2222 220a 0a20 2020  --..    """..   
+0002bcd0: 2023 204c 6f61 6420 7068 6f74 6f6d 6574   # Load photomet
+0002bce0: 7279 2063 6174 616c 6f67 2028 7769 7468  ry catalog (with
+0002bcf0: 2061 7065 7274 7572 6520 636f 7272 6563   aperture correc
+0002bd00: 7469 6f6e 290a 2020 2020 7068 6f74 5f63  tion).    phot_c
+0002bd10: 6174 203d 2066 6974 732e 6f70 656e 2863  at = fits.open(c
+0002bd20: 6174 616c 6f67 5f66 696c 6529 0a20 2020  atalog_file).   
+0002bd30: 2070 686f 745f 6361 7420 3d20 7068 6f74   phot_cat = phot
+0002bd40: 5f63 6174 5b31 5d2e 6461 7461 0a0a 2020  _cat[1].data..  
+0002bd50: 2020 4e5f 736f 7572 6365 7320 3d20 6c65    N_sources = le
+0002bd60: 6e28 7068 6f74 5f63 6174 290a 0a20 2020  n(phot_cat)..   
+0002bd70: 2023 204c 6f61 6420 5a50 0a20 2020 205a   # Load ZP.    Z
+0002bd80: 5073 203d 207a 705f 7265 6164 287a 705f  Ps = zp_read(zp_
+0002bd90: 6669 6c65 290a 2020 2020 5a50 203d 205a  file).    ZP = Z
+0002bda0: 5073 5b66 2753 504c 5553 5f7b 6669 6c74  Ps[f'SPLUS_{filt
+0002bdb0: 6572 5f6e 616d 657d 275d 0a0a 2020 2020  er_name}']..    
+0002bdc0: 2320 5374 616e 6461 7264 2066 696c 7465  # Standard filte
+0002bdd0: 7220 6e61 6d65 0a20 2020 2066 696c 745f  r name.    filt_
+0002bde0: 7374 616e 6461 7264 203d 2074 7261 6e73  standard = trans
+0002bdf0: 6c61 7465 5f66 696c 7465 725f 7374 616e  late_filter_stan
+0002be00: 6461 7264 2866 696c 7465 725f 6e61 6d65  dard(filter_name
+0002be10: 290a 0a20 2020 2023 2043 7265 6174 6520  )..    # Create 
+0002be20: 6e65 7720 6461 7461 2054 6162 6c65 0a20  new data Table. 
+0002be30: 2020 2063 6174 203d 205b 5d0a 0a20 2020     cat = []..   
+0002be40: 2023 2046 696c 6c20 6e65 7720 6461 7461   # Fill new data
+0002be50: 2054 6162 6c65 2023 2323 2323 2323 2323   Table #########
+0002be60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0002be70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0002be80: 2323 2323 2323 2323 2323 2323 230a 0a20  #############.. 
+0002be90: 2020 2023 2046 6965 6c64 2063 6f6c 756d     # Field colum
+0002bea0: 6e0a 2020 2020 6361 742e 6170 7065 6e64  n.    cat.append
+0002beb0: 2866 6974 732e 436f 6c75 6d6e 286e 616d  (fits.Column(nam
+0002bec0: 653d 2746 6965 6c64 272c 0a20 2020 2020  e='Field',.     
+0002bed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bee0: 2020 2020 2020 666f 726d 6174 3d27 2564        format='%d
+0002bef0: 4127 2025 206c 656e 2866 6965 6c64 292c  A' % len(field),
+0002bf00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002bf10: 2020 2020 2020 2020 2020 2020 6172 7261              arra
+0002bf20: 793d 4e5f 736f 7572 6365 732a 5b66 6965  y=N_sources*[fie
+0002bf30: 6c64 5d29 290a 0a20 2020 2023 2046 4945  ld]))..    # FIE
+0002bf40: 4c44 2049 440a 2020 2020 7068 6f74 5f63  LD ID.    phot_c
+0002bf50: 6174 2e63 6f6c 756d 6e73 5b66 2746 4945  at.columns[f'FIE
+0002bf60: 4c44 5f49 4427 5d2e 6e61 6d65 203d 2066  LD_ID'].name = f
+0002bf70: 2749 4427 0a20 2020 2063 6174 2e61 7070  'ID'.    cat.app
+0002bf80: 656e 6428 7068 6f74 5f63 6174 2e63 6f6c  end(phot_cat.col
+0002bf90: 756d 6e73 5b66 2749 4427 5d29 0a20 2020  umns[f'ID']).   
+0002bfa0: 2070 686f 745f 6361 742e 636f 6c75 6d6e   phot_cat.column
+0002bfb0: 735b 6627 4649 454c 445f 4944 5f52 4127  s[f'FIELD_ID_RA'
+0002bfc0: 5d2e 6e61 6d65 203d 2066 2749 445f 5241  ].name = f'ID_RA
+0002bfd0: 270a 2020 2020 6361 742e 6170 7065 6e64  '.    cat.append
+0002bfe0: 2870 686f 745f 6361 742e 636f 6c75 6d6e  (phot_cat.column
+0002bff0: 735b 6627 4944 5f52 4127 5d29 0a20 2020  s[f'ID_RA']).   
+0002c000: 2070 686f 745f 6361 742e 636f 6c75 6d6e   phot_cat.column
+0002c010: 735b 6627 4649 454c 445f 4944 5f44 4543  s[f'FIELD_ID_DEC
+0002c020: 275d 2e6e 616d 6520 3d20 6627 4944 5f44  '].name = f'ID_D
+0002c030: 4543 270a 2020 2020 6361 742e 6170 7065  EC'.    cat.appe
+0002c040: 6e64 2870 686f 745f 6361 742e 636f 6c75  nd(phot_cat.colu
+0002c050: 6d6e 735b 6627 4944 5f44 4543 275d 290a  mns[f'ID_DEC']).
+0002c060: 0a20 2020 2023 2046 696c 7465 7220 4944  .    # Filter ID
+0002c070: 0a20 2020 2069 6620 6d6f 6465 203d 3d20  .    if mode == 
+0002c080: 2273 696e 676c 6522 3a0a 2020 2020 2020  "single":.      
+0002c090: 2020 6361 742e 6170 7065 6e64 2870 686f    cat.append(pho
+0002c0a0: 745f 6361 742e 636f 6c75 6d6e 735b 6627  t_cat.columns[f'
+0002c0b0: 5048 4f54 5f49 445f 7369 6e67 6c65 275d  PHOT_ID_single']
+0002c0c0: 290a 2020 2020 2020 2020 6361 742e 6170  ).        cat.ap
+0002c0d0: 7065 6e64 2870 686f 745f 6361 742e 636f  pend(phot_cat.co
+0002c0e0: 6c75 6d6e 735b 6627 5048 4f54 5f49 445f  lumns[f'PHOT_ID_
+0002c0f0: 5241 5f73 696e 676c 6527 5d29 0a20 2020  RA_single']).   
+0002c100: 2020 2020 2063 6174 2e61 7070 656e 6428       cat.append(
+0002c110: 7068 6f74 5f63 6174 2e63 6f6c 756d 6e73  phot_cat.columns
+0002c120: 5b66 2750 484f 545f 4944 5f44 4543 5f73  [f'PHOT_ID_DEC_s
 0002c130: 696e 676c 6527 5d29 0a20 2020 2020 2020  ingle']).       
 0002c140: 2063 6174 2e61 7070 656e 6428 7068 6f74   cat.append(phot
-0002c150: 5f63 6174 2e63 6f6c 756d 6e73 5b66 2750  _cat.columns[f'P
-0002c160: 484f 545f 4944 5f44 4543 5f73 696e 676c  HOT_ID_DEC_singl
-0002c170: 6527 5d29 0a20 2020 2020 2020 2063 6174  e']).        cat
-0002c180: 2e61 7070 656e 6428 7068 6f74 5f63 6174  .append(phot_cat
-0002c190: 2e63 6f6c 756d 6e73 5b66 277b 6669 6c74  .columns[f'{filt
-0002c1a0: 5f73 7461 6e64 6172 647d 5f49 445f 7369  _standard}_ID_si
-0002c1b0: 6e67 6c65 275d 290a 0a20 2020 2020 2020  ngle'])..       
-0002c1c0: 2023 2052 412c 2044 4543 0a20 2020 2020   # RA, DEC.     
-0002c1d0: 2020 2070 686f 745f 6361 742e 636f 6c75     phot_cat.colu
-0002c1e0: 6d6e 735b 6627 5241 5f7b 6669 6c74 5f73  mns[f'RA_{filt_s
-0002c1f0: 7461 6e64 6172 647d 275d 2e6e 616d 6520  tandard}'].name 
-0002c200: 3d20 6627 5241 5f7b 6669 6c74 5f73 7461  = f'RA_{filt_sta
-0002c210: 6e64 6172 647d 270a 2020 2020 2020 2020  ndard}'.        
-0002c220: 6361 742e 6170 7065 6e64 2870 686f 745f  cat.append(phot_
-0002c230: 6361 742e 636f 6c75 6d6e 735b 6627 5241  cat.columns[f'RA
-0002c240: 5f7b 6669 6c74 5f73 7461 6e64 6172 647d  _{filt_standard}
-0002c250: 275d 290a 2020 2020 2020 2020 7068 6f74  ']).        phot
-0002c260: 5f63 6174 2e63 6f6c 756d 6e73 5b66 2744  _cat.columns[f'D
-0002c270: 4543 5f7b 6669 6c74 5f73 7461 6e64 6172  EC_{filt_standar
-0002c280: 647d 275d 2e6e 616d 6520 3d20 6627 4445  d}'].name = f'DE
-0002c290: 435f 7b66 696c 745f 7374 616e 6461 7264  C_{filt_standard
-0002c2a0: 7d27 0a20 2020 2020 2020 2063 6174 2e61  }'.        cat.a
-0002c2b0: 7070 656e 6428 7068 6f74 5f63 6174 2e63  ppend(phot_cat.c
-0002c2c0: 6f6c 756d 6e73 5b66 2744 4543 5f7b 6669  olumns[f'DEC_{fi
-0002c2d0: 6c74 5f73 7461 6e64 6172 647d 275d 290a  lt_standard}']).
-0002c2e0: 0a0a 2020 2020 2320 4669 6c74 6572 2049  ..    # Filter I
-0002c2f0: 4420 6475 616c 2028 6861 7665 2074 6f20  D dual (have to 
-0002c300: 6765 6e65 7261 7465 290a 2020 2020 656c  generate).    el
-0002c310: 6966 206d 6f64 6520 3d3d 2022 6475 616c  if mode == "dual
-0002c320: 223a 0a20 2020 2020 2020 2063 6174 2e61  ":.        cat.a
-0002c330: 7070 656e 6428 7068 6f74 5f63 6174 2e63  ppend(phot_cat.c
-0002c340: 6f6c 756d 6e73 5b66 2750 484f 545f 4944  olumns[f'PHOT_ID
-0002c350: 5f64 7561 6c27 5d29 0a20 2020 2020 2020  _dual']).       
-0002c360: 2063 6174 2e61 7070 656e 6428 7068 6f74   cat.append(phot
-0002c370: 5f63 6174 2e63 6f6c 756d 6e73 5b66 2750  _cat.columns[f'P
-0002c380: 484f 545f 4944 5f52 415f 6475 616c 275d  HOT_ID_RA_dual']
-0002c390: 290a 2020 2020 2020 2020 6361 742e 6170  ).        cat.ap
-0002c3a0: 7065 6e64 2870 686f 745f 6361 742e 636f  pend(phot_cat.co
-0002c3b0: 6c75 6d6e 735b 6627 5048 4f54 5f49 445f  lumns[f'PHOT_ID_
-0002c3c0: 4445 435f 6475 616c 275d 290a 0a20 2020  DEC_dual'])..   
-0002c3d0: 2020 2020 2063 6174 2e61 7070 656e 6428       cat.append(
-0002c3e0: 6669 7473 2e43 6f6c 756d 6e28 6e61 6d65  fits.Column(name
-0002c3f0: 3d66 277b 6669 6c74 5f73 7461 6e64 6172  =f'{filt_standar
-0002c400: 647d 5f49 445f 6475 616c 272c 0a20 2020  d}_ID_dual',.   
-0002c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c420: 2020 2020 2020 2020 2020 2020 666f 726d              form
-0002c430: 6174 3d27 3530 4127 2c0a 2020 2020 2020  at='50A',.      
-0002c440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c450: 2020 2020 2020 2020 2061 7272 6179 3d70           array=p
-0002c460: 686f 745f 6361 742e 636f 6c75 6d6e 735b  hot_cat.columns[
-0002c470: 6627 5048 4f54 5f49 445f 6475 616c 275d  f'PHOT_ID_dual']
-0002c480: 2e61 7272 6179 2929 0a0a 2020 2020 2020  .array))..      
-0002c490: 2020 2320 5241 2c44 4543 0a20 2020 2020    # RA,DEC.     
-0002c4a0: 2020 2070 686f 745f 6361 742e 636f 6c75     phot_cat.colu
-0002c4b0: 6d6e 735b 2741 4c50 4841 5f4a 3230 3030  mns['ALPHA_J2000
-0002c4c0: 275d 2e6e 616d 6520 3d20 2752 4127 0a20  '].name = 'RA'. 
-0002c4d0: 2020 2020 2020 2063 6174 2e61 7070 656e         cat.appen
-0002c4e0: 6428 7068 6f74 5f63 6174 2e63 6f6c 756d  d(phot_cat.colum
-0002c4f0: 6e73 5b27 5241 275d 290a 2020 2020 2020  ns['RA']).      
-0002c500: 2020 7068 6f74 5f63 6174 2e63 6f6c 756d    phot_cat.colum
-0002c510: 6e73 5b27 4445 4c54 415f 4a32 3030 3027  ns['DELTA_J2000'
-0002c520: 5d2e 6e61 6d65 203d 2027 4445 4327 0a20  ].name = 'DEC'. 
-0002c530: 2020 2020 2020 2063 6174 2e61 7070 656e         cat.appen
-0002c540: 6428 7068 6f74 5f63 6174 2e63 6f6c 756d  d(phot_cat.colum
-0002c550: 6e73 5b27 4445 4327 5d29 0a0a 2020 2020  ns['DEC'])..    
-0002c560: 2320 5345 585f 4e55 4d42 4552 0a20 2020  # SEX_NUMBER.   
-0002c570: 2070 686f 745f 6361 742e 636f 6c75 6d6e   phot_cat.column
-0002c580: 735b 274e 554d 4245 5227 5d2e 6e61 6d65  s['NUMBER'].name
-0002c590: 203d 2066 2753 4558 5f4e 554d 4245 525f   = f'SEX_NUMBER_
-0002c5a0: 7b66 696c 745f 7374 616e 6461 7264 7d27  {filt_standard}'
-0002c5b0: 0a20 2020 2063 6174 2e61 7070 656e 6428  .    cat.append(
-0002c5c0: 7068 6f74 5f63 6174 2e63 6f6c 756d 6e73  phot_cat.columns
-0002c5d0: 5b66 2753 4558 5f4e 554d 4245 525f 7b66  [f'SEX_NUMBER_{f
-0002c5e0: 696c 745f 7374 616e 6461 7264 7d27 5d29  ilt_standard}'])
-0002c5f0: 0a0a 2020 2020 2320 5345 585f 464c 4147  ..    # SEX_FLAG
-0002c600: 0a20 2020 2070 686f 745f 6361 742e 636f  .    phot_cat.co
-0002c610: 6c75 6d6e 735b 2746 4c41 4753 275d 2e6e  lumns['FLAGS'].n
-0002c620: 616d 6520 3d20 6627 5345 585f 464c 4147  ame = f'SEX_FLAG
-0002c630: 535f 7b66 696c 745f 7374 616e 6461 7264  S_{filt_standard
-0002c640: 7d27 0a20 2020 2063 6174 2e61 7070 656e  }'.    cat.appen
-0002c650: 6428 7068 6f74 5f63 6174 2e63 6f6c 756d  d(phot_cat.colum
-0002c660: 6e73 5b66 2753 4558 5f46 4c41 4753 5f7b  ns[f'SEX_FLAGS_{
-0002c670: 6669 6c74 5f73 7461 6e64 6172 647d 275d  filt_standard}']
-0002c680: 290a 0a20 2020 2023 2043 414c 4942 5f46  )..    # CALIB_F
-0002c690: 4c41 470a 2020 2020 2363 6174 2e61 7070  LAG.    #cat.app
-0002c6a0: 656e 6428 6669 7473 2e43 6f6c 756d 6e28  end(fits.Column(
-0002c6b0: 6e61 6d65 3d27 6361 6c69 625f 666c 6167  name='calib_flag
-0002c6c0: 272c 0a20 2020 2023 2020 2020 2020 2020  ',.    #        
-0002c6d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002c6e0: 6f72 6d61 743d 2731 4a27 2c0a 2020 2020  ormat='1J',.    
-0002c6f0: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-0002c700: 2020 2020 2020 2020 6172 7261 793d 4e5f          array=N_
-0002c710: 736f 7572 6365 732a 5b63 616c 6962 7261  sources*[calibra
-0002c720: 7469 6f6e 5f66 6c61 675d 2929 0a0a 2020  tion_flag]))..  
-0002c730: 2020 2320 4341 4c49 4220 5354 5241 5445    # CALIB STRATE
-0002c740: 4759 0a20 2020 2069 6620 6361 6c69 6272  GY.    if calibr
-0002c750: 6174 696f 6e5f 6e61 6d65 2069 7320 6e6f  ation_name is no
-0002c760: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0002c770: 4e5f 7374 7220 3d20 6c65 6e28 6361 6c69  N_str = len(cali
-0002c780: 6272 6174 696f 6e5f 6e61 6d65 290a 2020  bration_name).  
-0002c790: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
-0002c7a0: 2866 6974 732e 436f 6c75 6d6e 286e 616d  (fits.Column(nam
-0002c7b0: 653d 6622 6361 6c69 625f 7374 7261 7422  e=f"calib_strat"
-0002c7c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002c7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c7e0: 2066 6f72 6d61 743d 6627 7b4e 5f73 7472   format=f'{N_str
-0002c7f0: 7d41 272c 0a20 2020 2020 2020 2020 2020  }A',.           
-0002c800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c810: 2020 2020 6172 7261 793d 5b63 616c 6962      array=[calib
-0002c820: 7261 7469 6f6e 5f6e 616d 655d 202a 204e  ration_name] * N
-0002c830: 5f73 6f75 7263 6573 2929 0a0a 2020 2020  _sources))..    
-0002c840: 6966 206d 6f64 6520 3d3d 2027 7369 6e67  if mode == 'sing
-0002c850: 6c65 273a 0a0a 2020 2020 2020 2020 2320  le':..        # 
-0002c860: 582c 2059 0a20 2020 2020 2020 2070 686f  X, Y.        pho
-0002c870: 745f 6361 742e 636f 6c75 6d6e 735b 2758  t_cat.columns['X
-0002c880: 5f49 4d41 4745 275d 2e6e 616d 6520 3d20  _IMAGE'].name = 
-0002c890: 6627 585f 7b66 696c 745f 7374 616e 6461  f'X_{filt_standa
-0002c8a0: 7264 7d27 0a20 2020 2020 2020 2063 6174  rd}'.        cat
-0002c8b0: 2e61 7070 656e 6428 7068 6f74 5f63 6174  .append(phot_cat
-0002c8c0: 2e63 6f6c 756d 6e73 5b66 2758 5f7b 6669  .columns[f'X_{fi
-0002c8d0: 6c74 5f73 7461 6e64 6172 647d 275d 290a  lt_standard}']).
-0002c8e0: 0a20 2020 2020 2020 2070 686f 745f 6361  .        phot_ca
-0002c8f0: 742e 636f 6c75 6d6e 735b 2759 5f49 4d41  t.columns['Y_IMA
-0002c900: 4745 275d 2e6e 616d 6520 3d20 6627 595f  GE'].name = f'Y_
-0002c910: 7b66 696c 745f 7374 616e 6461 7264 7d27  {filt_standard}'
-0002c920: 0a20 2020 2020 2020 2063 6174 2e61 7070  .        cat.app
-0002c930: 656e 6428 7068 6f74 5f63 6174 2e63 6f6c  end(phot_cat.col
-0002c940: 756d 6e73 5b66 2759 5f7b 6669 6c74 5f73  umns[f'Y_{filt_s
-0002c950: 7461 6e64 6172 647d 275d 290a 0a20 2020  tandard}'])..   
-0002c960: 2020 2020 2023 2041 2c20 422c 2054 4845       # A, B, THE
-0002c970: 5441 0a20 2020 2020 2020 2070 686f 745f  TA.        phot_
-0002c980: 6361 742e 636f 6c75 6d6e 735b 2741 5f57  cat.columns['A_W
-0002c990: 4f52 4c44 275d 2e6e 616d 6520 3d20 6627  ORLD'].name = f'
-0002c9a0: 415f 7b66 696c 745f 7374 616e 6461 7264  A_{filt_standard
-0002c9b0: 7d27 0a20 2020 2020 2020 2063 6174 2e61  }'.        cat.a
-0002c9c0: 7070 656e 6428 7068 6f74 5f63 6174 2e63  ppend(phot_cat.c
-0002c9d0: 6f6c 756d 6e73 5b66 2741 5f7b 6669 6c74  olumns[f'A_{filt
-0002c9e0: 5f73 7461 6e64 6172 647d 275d 290a 0a20  _standard}']).. 
-0002c9f0: 2020 2020 2020 2070 686f 745f 6361 742e         phot_cat.
-0002ca00: 636f 6c75 6d6e 735b 2742 5f57 4f52 4c44  columns['B_WORLD
-0002ca10: 275d 2e6e 616d 6520 3d20 6627 425f 7b66  '].name = f'B_{f
-0002ca20: 696c 745f 7374 616e 6461 7264 7d27 0a20  ilt_standard}'. 
-0002ca30: 2020 2020 2020 2063 6174 2e61 7070 656e         cat.appen
-0002ca40: 6428 7068 6f74 5f63 6174 2e63 6f6c 756d  d(phot_cat.colum
-0002ca50: 6e73 5b66 2742 5f7b 6669 6c74 5f73 7461  ns[f'B_{filt_sta
-0002ca60: 6e64 6172 647d 275d 290a 0a20 2020 2020  ndard}'])..     
-0002ca70: 2020 2070 686f 745f 6361 742e 636f 6c75     phot_cat.colu
-0002ca80: 6d6e 735b 2754 4845 5441 5f57 4f52 4c44  mns['THETA_WORLD
-0002ca90: 275d 2e6e 616d 6520 3d20 6627 5448 4554  '].name = f'THET
-0002caa0: 415f 7b66 696c 745f 7374 616e 6461 7264  A_{filt_standard
-0002cab0: 7d27 0a20 2020 2020 2020 2063 6174 2e61  }'.        cat.a
-0002cac0: 7070 656e 6428 7068 6f74 5f63 6174 2e63  ppend(phot_cat.c
-0002cad0: 6f6c 756d 6e73 5b66 2754 4845 5441 5f7b  olumns[f'THETA_{
-0002cae0: 6669 6c74 5f73 7461 6e64 6172 647d 275d  filt_standard}']
-0002caf0: 290a 0a20 2020 2020 2020 2023 2045 6c6f  )..        # Elo
-0002cb00: 6e67 6174 696f 6e2c 2045 6c6c 6970 7469  ngation, Ellipti
-0002cb10: 6369 7479 0a20 2020 2020 2020 2070 686f  city.        pho
-0002cb20: 745f 6361 742e 636f 6c75 6d6e 735b 2745  t_cat.columns['E
-0002cb30: 4c4f 4e47 4154 494f 4e27 5d2e 6e61 6d65  LONGATION'].name
-0002cb40: 203d 2066 2745 4c4f 4e47 4154 494f 4e5f   = f'ELONGATION_
-0002cb50: 7b66 696c 745f 7374 616e 6461 7264 7d27  {filt_standard}'
-0002cb60: 0a20 2020 2020 2020 2063 6174 2e61 7070  .        cat.app
-0002cb70: 656e 6428 7068 6f74 5f63 6174 2e63 6f6c  end(phot_cat.col
-0002cb80: 756d 6e73 5b66 2745 4c4f 4e47 4154 494f  umns[f'ELONGATIO
-0002cb90: 4e5f 7b66 696c 745f 7374 616e 6461 7264  N_{filt_standard
-0002cba0: 7d27 5d29 0a20 2020 2020 2020 2070 686f  }']).        pho
-0002cbb0: 745f 6361 742e 636f 6c75 6d6e 735b 2745  t_cat.columns['E
-0002cbc0: 4c4c 4950 5449 4349 5459 275d 2e6e 616d  LLIPTICITY'].nam
-0002cbd0: 6520 3d20 6627 454c 4c49 5054 4943 4954  e = f'ELLIPTICIT
-0002cbe0: 595f 7b66 696c 745f 7374 616e 6461 7264  Y_{filt_standard
-0002cbf0: 7d27 0a20 2020 2020 2020 2063 6174 2e61  }'.        cat.a
-0002cc00: 7070 656e 6428 7068 6f74 5f63 6174 2e63  ppend(phot_cat.c
-0002cc10: 6f6c 756d 6e73 5b66 2745 4c4c 4950 5449  olumns[f'ELLIPTI
-0002cc20: 4349 5459 5f7b 6669 6c74 5f73 7461 6e64  CITY_{filt_stand
-0002cc30: 6172 647d 275d 290a 0a20 2020 2020 2020  ard}'])..       
-0002cc40: 2023 2049 534f 6172 6561 0a20 2020 2020   # ISOarea.     
-0002cc50: 2020 2070 686f 745f 6361 742e 636f 6c75     phot_cat.colu
-0002cc60: 6d6e 735b 2749 534f 4152 4541 5f57 4f52  mns['ISOAREA_WOR
-0002cc70: 4c44 275d 2e6e 616d 6520 3d20 6627 4953  LD'].name = f'IS
-0002cc80: 4f61 7265 615f 7b66 696c 745f 7374 616e  Oarea_{filt_stan
-0002cc90: 6461 7264 7d27 0a20 2020 2020 2020 2063  dard}'.        c
-0002cca0: 6174 2e61 7070 656e 6428 7068 6f74 5f63  at.append(phot_c
-0002ccb0: 6174 2e63 6f6c 756d 6e73 5b66 2749 534f  at.columns[f'ISO
-0002ccc0: 6172 6561 5f7b 6669 6c74 5f73 7461 6e64  area_{filt_stand
-0002ccd0: 6172 647d 275d 290a 0a20 2020 2020 2020  ard}'])..       
-0002cce0: 2023 204b 524f 4e2f 5045 5452 4f53 4941   # KRON/PETROSIA
-0002ccf0: 4e2f 464c 5558 2052 6164 6975 730a 2020  N/FLUX Radius.  
-0002cd00: 2020 2020 2020 7068 6f74 5f63 6174 2e63        phot_cat.c
-0002cd10: 6f6c 756d 6e73 5b27 4b52 4f4e 5f52 4144  olumns['KRON_RAD
-0002cd20: 4955 5327 5d2e 6e61 6d65 203d 2066 274b  IUS'].name = f'K
-0002cd30: 524f 4e5f 5241 4449 5553 5f7b 6669 6c74  RON_RADIUS_{filt
-0002cd40: 5f73 7461 6e64 6172 647d 270a 2020 2020  _standard}'.    
-0002cd50: 2020 2020 6361 742e 6170 7065 6e64 2870      cat.append(p
-0002cd60: 686f 745f 6361 742e 636f 6c75 6d6e 735b  hot_cat.columns[
-0002cd70: 6627 4b52 4f4e 5f52 4144 4955 535f 7b66  f'KRON_RADIUS_{f
-0002cd80: 696c 745f 7374 616e 6461 7264 7d27 5d29  ilt_standard}'])
-0002cd90: 0a0a 2020 2020 2020 2020 7068 6f74 5f63  ..        phot_c
-0002cda0: 6174 2e63 6f6c 756d 6e73 5b27 5045 5452  at.columns['PETR
-0002cdb0: 4f5f 5241 4449 5553 275d 2e6e 616d 6520  O_RADIUS'].name 
-0002cdc0: 3d20 6627 5045 5452 4f5f 5241 4449 5553  = f'PETRO_RADIUS
-0002cdd0: 5f7b 6669 6c74 5f73 7461 6e64 6172 647d  _{filt_standard}
-0002cde0: 270a 2020 2020 2020 2020 6361 742e 6170  '.        cat.ap
-0002cdf0: 7065 6e64 2870 686f 745f 6361 742e 636f  pend(phot_cat.co
-0002ce00: 6c75 6d6e 735b 6627 5045 5452 4f5f 5241  lumns[f'PETRO_RA
-0002ce10: 4449 5553 5f7b 6669 6c74 5f73 7461 6e64  DIUS_{filt_stand
-0002ce20: 6172 647d 275d 290a 0a20 2020 2020 2020  ard}'])..       
-0002ce30: 2023 2041 6464 2046 4c55 585f 5241 4449   # Add FLUX_RADI
-0002ce40: 5553 0a20 2020 2020 2020 2066 6f72 206a  US.        for j
-0002ce50: 2c20 7220 696e 207a 6970 2872 616e 6765  , r in zip(range
-0002ce60: 2834 292c 205b 3230 2c20 3530 2c20 3730  (4), [20, 50, 70
-0002ce70: 2c20 3930 5d29 3a0a 2020 2020 2020 2020  , 90]):.        
-0002ce80: 2020 2020 6361 742e 6170 7065 6e64 2866      cat.append(f
-0002ce90: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
-0002cea0: 6627 464c 5558 5f52 4144 4955 535f 7b72  f'FLUX_RADIUS_{r
-0002ceb0: 7d5f 7b66 696c 745f 7374 616e 6461 7264  }_{filt_standard
-0002cec0: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-0002ced0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cee0: 2020 2020 2020 2066 6f72 6d61 743d 2731         format='1
-0002cef0: 4527 2c0a 2020 2020 2020 2020 2020 2020  E',.            
-0002cf00: 2020 2020 2020 2020 2020 2020 6172 7261              arra
-0002cf10: 793d 7068 6f74 5f63 6174 2e63 6f6c 756d  y=phot_cat.colum
-0002cf20: 6e73 5b27 464c 5558 5f52 4144 4955 5327  ns['FLUX_RADIUS'
-0002cf30: 5d2e 6172 7261 795b 3a2c 206a 5d29 290a  ].array[:, j])).
-0002cf40: 0a20 2020 2020 2020 2023 2043 4c41 5353  .        # CLASS
-0002cf50: 5f53 5441 520a 2020 2020 2020 2020 7068  _STAR.        ph
-0002cf60: 6f74 5f63 6174 2e63 6f6c 756d 6e73 5b27  ot_cat.columns['
-0002cf70: 434c 4153 535f 5354 4152 275d 2e6e 616d  CLASS_STAR'].nam
-0002cf80: 6520 3d20 6627 434c 4153 535f 5354 4152  e = f'CLASS_STAR
-0002cf90: 5f7b 6669 6c74 5f73 7461 6e64 6172 647d  _{filt_standard}
-0002cfa0: 270a 2020 2020 2020 2020 6361 742e 6170  '.        cat.ap
-0002cfb0: 7065 6e64 2870 686f 745f 6361 742e 636f  pend(phot_cat.co
-0002cfc0: 6c75 6d6e 735b 6627 434c 4153 535f 5354  lumns[f'CLASS_ST
-0002cfd0: 4152 5f7b 6669 6c74 5f73 7461 6e64 6172  AR_{filt_standar
-0002cfe0: 647d 275d 290a 0a20 2020 2023 2046 5748  d}'])..    # FWH
-0002cff0: 4d0a 2020 2020 7068 6f74 5f63 6174 2e63  M.    phot_cat.c
-0002d000: 6f6c 756d 6e73 5b27 4657 484d 5f57 4f52  olumns['FWHM_WOR
-0002d010: 4c44 275d 2e6e 616d 6520 3d20 6627 4657  LD'].name = f'FW
-0002d020: 484d 5f7b 6669 6c74 5f73 7461 6e64 6172  HM_{filt_standar
-0002d030: 647d 270a 2020 2020 6361 742e 6170 7065  d}'.    cat.appe
-0002d040: 6e64 2870 686f 745f 6361 742e 636f 6c75  nd(phot_cat.colu
-0002d050: 6d6e 735b 6627 4657 484d 5f7b 6669 6c74  mns[f'FWHM_{filt
-0002d060: 5f73 7461 6e64 6172 647d 275d 290a 0a20  _standard}']).. 
-0002d070: 2020 2023 2323 204e 6f72 6d61 6c69 7a65     ### Normalize
-0002d080: 6420 4657 484d 0a20 2020 2063 6f6c 5f73  d FWHM.    col_s
-0002d090: 326e 5f61 7574 6f20 3d20 7068 6f74 5f63  2n_auto = phot_c
-0002d0a0: 6174 5b27 464c 5558 5f41 5554 4f27 5d20  at['FLUX_AUTO'] 
-0002d0b0: 2f20 7068 6f74 5f63 6174 5b27 464c 5558  / phot_cat['FLUX
-0002d0c0: 4552 525f 4155 544f 275d 0a20 2020 2063  ERR_AUTO'].    c
-0002d0d0: 6f6c 5f73 326e 5f61 7574 6f20 3d20 6e70  ol_s2n_auto = np
-0002d0e0: 2e77 6865 7265 2863 6f6c 5f73 326e 5f61  .where(col_s2n_a
-0002d0f0: 7574 6f20 3e20 302e 2c20 636f 6c5f 7332  uto > 0., col_s2
-0002d100: 6e5f 6175 746f 2c20 2d31 2e30 3029 0a0a  n_auto, -1.00)..
-0002d110: 2020 2020 6966 206d 6f64 6520 3d3d 2022      if mode == "
-0002d120: 7369 6e67 6c65 223a 0a20 2020 2020 2020  single":.       
-0002d130: 2063 6f6c 5f63 6c61 7373 5f73 7461 7220   col_class_star 
-0002d140: 3d20 7068 6f74 5f63 6174 5b66 2743 4c41  = phot_cat[f'CLA
-0002d150: 5353 5f53 5441 525f 7b66 696c 745f 7374  SS_STAR_{filt_st
-0002d160: 616e 6461 7264 7d27 5d0a 2020 2020 656c  andard}'].    el
-0002d170: 6966 206d 6f64 6520 3d3d 2022 6475 616c  if mode == "dual
-0002d180: 223a 0a20 2020 2020 2020 2063 6f6c 5f63  ":.        col_c
-0002d190: 6c61 7373 5f73 7461 7220 3d20 7068 6f74  lass_star = phot
-0002d1a0: 5f63 6174 5b66 2743 4c41 5353 5f53 5441  _cat[f'CLASS_STA
-0002d1b0: 5227 5d0a 0a20 2020 2073 656c 6563 7469  R']..    selecti
-0002d1c0: 6f6e 203d 2028 636f 6c5f 7332 6e5f 6175  on = (col_s2n_au
-0002d1d0: 746f 203e 3d20 3130 3029 2026 2028 636f  to >= 100) & (co
-0002d1e0: 6c5f 7332 6e5f 6175 746f 203c 3d20 3130  l_s2n_auto <= 10
-0002d1f0: 3030 2920 2620 2863 6f6c 5f63 6c61 7373  00) & (col_class
-0002d200: 5f73 7461 7220 3e20 302e 3929 0a20 2020  _star > 0.9).   
-0002d210: 206d 6561 6e5f 4657 484d 203d 206d 6561   mean_FWHM = mea
-0002d220: 6e5f 726f 6275 7374 2870 686f 745f 6361  n_robust(phot_ca
-0002d230: 745b 6627 4657 484d 5f7b 6669 6c74 5f73  t[f'FWHM_{filt_s
-0002d240: 7461 6e64 6172 647d 275d 5b73 656c 6563  tandard}'][selec
-0002d250: 7469 6f6e 5d29 0a0a 2020 2020 636f 6c5f  tion])..    col_
-0002d260: 4657 484d 5f6e 203d 2070 686f 745f 6361  FWHM_n = phot_ca
-0002d270: 745b 6627 4657 484d 5f7b 6669 6c74 5f73  t[f'FWHM_{filt_s
-0002d280: 7461 6e64 6172 647d 275d 202f 206d 6561  tandard}'] / mea
-0002d290: 6e5f 4657 484d 0a0a 2020 2020 6361 742e  n_FWHM..    cat.
-0002d2a0: 6170 7065 6e64 2866 6974 732e 436f 6c75  append(fits.Colu
-0002d2b0: 6d6e 286e 616d 653d 6627 4657 484d 5f6e  mn(name=f'FWHM_n
-0002d2c0: 5f7b 6669 6c74 5f73 7461 6e64 6172 647d  _{filt_standard}
-0002d2d0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0002d2e0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0002d2f0: 726d 6174 3d27 3145 272c 0a20 2020 2020  rmat='1E',.     
-0002d300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d310: 2020 2020 2020 6172 7261 793d 636f 6c5f        array=col_
-0002d320: 4657 484d 5f6e 2929 0a0a 2020 2020 2320  FWHM_n))..    # 
-0002d330: 4d55 5f4d 4158 2c20 4d55 5f54 4852 4553  MU_MAX, MU_THRES
-0002d340: 484f 4c44 2c20 4241 434b 4752 4f55 4e44  HOLD, BACKGROUND
-0002d350: 2c20 5448 5245 5348 4f4c 440a 2020 2020  , THRESHOLD.    
-0002d360: 4d55 5f4d 4158 203d 2070 686f 745f 6361  MU_MAX = phot_ca
-0002d370: 742e 636f 6c75 6d6e 735b 274d 555f 4d41  t.columns['MU_MA
-0002d380: 5827 5d2e 6172 7261 7920 2d20 7365 785f  X'].array - sex_
-0002d390: 6d61 675f 7a70 202b 205a 500a 2020 2020  mag_zp + ZP.    
-0002d3a0: 6361 742e 6170 7065 6e64 2866 6974 732e  cat.append(fits.
-0002d3b0: 436f 6c75 6d6e 286e 616d 653d 6627 4d55  Column(name=f'MU
-0002d3c0: 5f4d 4158 5f7b 6669 6c74 5f73 7461 6e64  _MAX_{filt_stand
-0002d3d0: 6172 647d 272c 0a20 2020 2020 2020 2020  ard}',.         
-0002d3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d3f0: 2020 666f 726d 6174 3d27 3145 272c 0a20    format='1E',. 
-0002d400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d410: 2020 2020 2020 2020 2020 6172 7261 793d            array=
-0002d420: 4d55 5f4d 4158 2929 0a0a 2020 2020 4d55  MU_MAX))..    MU
-0002d430: 5f54 4852 4553 484f 4c44 203d 2070 686f  _THRESHOLD = pho
-0002d440: 745f 6361 742e 636f 6c75 6d6e 735b 274d  t_cat.columns['M
-0002d450: 555f 5448 5245 5348 4f4c 4427 5d2e 6172  U_THRESHOLD'].ar
-0002d460: 7261 7920 2d20 7365 785f 6d61 675f 7a70  ray - sex_mag_zp
-0002d470: 202b 205a 500a 2020 2020 6361 742e 6170   + ZP.    cat.ap
-0002d480: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
-0002d490: 286e 616d 653d 6627 4d55 5f54 4852 4553  (name=f'MU_THRES
-0002d4a0: 484f 4c44 5f7b 6669 6c74 5f73 7461 6e64  HOLD_{filt_stand
-0002d4b0: 6172 647d 272c 0a20 2020 2020 2020 2020  ard}',.         
-0002d4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d4d0: 2020 666f 726d 6174 3d27 3145 272c 0a20    format='1E',. 
-0002d4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d4f0: 2020 2020 2020 2020 2020 6172 7261 793d            array=
-0002d500: 4d55 5f54 4852 4553 484f 4c44 2929 0a0a  MU_THRESHOLD))..
-0002d510: 2020 2020 4241 434b 4752 4f55 4e44 203d      BACKGROUND =
-0002d520: 2070 686f 745f 6361 742e 636f 6c75 6d6e   phot_cat.column
-0002d530: 735b 2742 4143 4b47 524f 554e 4427 5d2e  s['BACKGROUND'].
-0002d540: 6172 7261 790a 2020 2020 6361 742e 6170  array.    cat.ap
-0002d550: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
-0002d560: 286e 616d 653d 6627 4241 434b 4752 4f55  (name=f'BACKGROU
-0002d570: 4e44 5f7b 6669 6c74 5f73 7461 6e64 6172  ND_{filt_standar
-0002d580: 647d 272c 0a20 2020 2020 2020 2020 2020  d}',.           
-0002d590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d5a0: 666f 726d 6174 3d27 3145 272c 0a20 2020  format='1E',.   
-0002d5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d5c0: 2020 2020 2020 2020 6172 7261 793d 4241          array=BA
-0002d5d0: 434b 4752 4f55 4e44 2929 0a0a 2020 2020  CKGROUND))..    
-0002d5e0: 5448 5245 5348 4f4c 4420 3d20 7068 6f74  THRESHOLD = phot
-0002d5f0: 5f63 6174 2e63 6f6c 756d 6e73 5b27 5448  _cat.columns['TH
-0002d600: 5245 5348 4f4c 4427 5d2e 6172 7261 790a  RESHOLD'].array.
-0002d610: 2020 2020 6361 742e 6170 7065 6e64 2866      cat.append(f
-0002d620: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
-0002d630: 6627 5448 5245 5348 4f4c 445f 7b66 696c  f'THRESHOLD_{fil
-0002d640: 745f 7374 616e 6461 7264 7d27 2c0a 2020  t_standard}',.  
-0002d650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d660: 2020 2020 2020 2020 2066 6f72 6d61 743d           format=
-0002d670: 2731 4527 2c0a 2020 2020 2020 2020 2020  '1E',.          
-0002d680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d690: 2061 7272 6179 3d54 4852 4553 484f 4c44   array=THRESHOLD
-0002d6a0: 2929 0a0a 2020 2020 2320 464c 5558 4553  ))..    # FLUXES
-0002d6b0: 2061 6e64 204d 4147 4e49 5455 4445 5320   and MAGNITUDES 
-0002d6c0: 666f 7220 6469 6666 6572 656e 7420 6170  for different ap
-0002d6d0: 6572 7475 7265 730a 0a20 2020 2061 7065  ertures..    ape
-0002d6e0: 7274 7572 6573 203d 205b 2741 5554 4f27  rtures = ['AUTO'
-0002d6f0: 2c20 2750 4554 524f 272c 2027 4953 4f27  , 'PETRO', 'ISO'
-0002d700: 5d0a 2020 2020 666f 7220 6170 6572 2069  ].    for aper i
-0002d710: 6e20 6170 6572 7475 7265 733a 0a0a 2020  n apertures:..  
-0002d720: 2020 2020 2020 666d 7420 3d20 2731 4527        fmt = '1E'
-0002d730: 0a0a 2020 2020 2020 2020 6620 3d20 7068  ..        f = ph
-0002d740: 6f74 5f63 6174 2e63 6f6c 756d 6e73 5b66  ot_cat.columns[f
-0002d750: 274d 4147 5f7b 6170 6572 7d27 5d2e 6172  'MAG_{aper}'].ar
-0002d760: 7261 7920 213d 2039 390a 0a20 2020 2020  ray != 99..     
-0002d770: 2020 2023 2046 4c55 580a 2020 2020 2020     # FLUX.      
-0002d780: 2020 464c 5558 2020 2020 203d 2070 686f    FLUX     = pho
+0002c150: 5f63 6174 2e63 6f6c 756d 6e73 5b66 277b  _cat.columns[f'{
+0002c160: 6669 6c74 5f73 7461 6e64 6172 647d 5f49  filt_standard}_I
+0002c170: 445f 7369 6e67 6c65 275d 290a 0a20 2020  D_single'])..   
+0002c180: 2020 2020 2023 2052 412c 2044 4543 0a20       # RA, DEC. 
+0002c190: 2020 2020 2020 2070 686f 745f 6361 742e         phot_cat.
+0002c1a0: 636f 6c75 6d6e 735b 6627 5241 5f7b 6669  columns[f'RA_{fi
+0002c1b0: 6c74 5f73 7461 6e64 6172 647d 275d 2e6e  lt_standard}'].n
+0002c1c0: 616d 6520 3d20 6627 5241 5f7b 6669 6c74  ame = f'RA_{filt
+0002c1d0: 5f73 7461 6e64 6172 647d 270a 2020 2020  _standard}'.    
+0002c1e0: 2020 2020 6361 742e 6170 7065 6e64 2870      cat.append(p
+0002c1f0: 686f 745f 6361 742e 636f 6c75 6d6e 735b  hot_cat.columns[
+0002c200: 6627 5241 5f7b 6669 6c74 5f73 7461 6e64  f'RA_{filt_stand
+0002c210: 6172 647d 275d 290a 2020 2020 2020 2020  ard}']).        
+0002c220: 7068 6f74 5f63 6174 2e63 6f6c 756d 6e73  phot_cat.columns
+0002c230: 5b66 2744 4543 5f7b 6669 6c74 5f73 7461  [f'DEC_{filt_sta
+0002c240: 6e64 6172 647d 275d 2e6e 616d 6520 3d20  ndard}'].name = 
+0002c250: 6627 4445 435f 7b66 696c 745f 7374 616e  f'DEC_{filt_stan
+0002c260: 6461 7264 7d27 0a20 2020 2020 2020 2063  dard}'.        c
+0002c270: 6174 2e61 7070 656e 6428 7068 6f74 5f63  at.append(phot_c
+0002c280: 6174 2e63 6f6c 756d 6e73 5b66 2744 4543  at.columns[f'DEC
+0002c290: 5f7b 6669 6c74 5f73 7461 6e64 6172 647d  _{filt_standard}
+0002c2a0: 275d 290a 0a0a 2020 2020 2320 4669 6c74  '])...    # Filt
+0002c2b0: 6572 2049 4420 6475 616c 2028 6861 7665  er ID dual (have
+0002c2c0: 2074 6f20 6765 6e65 7261 7465 290a 2020   to generate).  
+0002c2d0: 2020 656c 6966 206d 6f64 6520 3d3d 2022    elif mode == "
+0002c2e0: 6475 616c 223a 0a20 2020 2020 2020 2063  dual":.        c
+0002c2f0: 6174 2e61 7070 656e 6428 7068 6f74 5f63  at.append(phot_c
+0002c300: 6174 2e63 6f6c 756d 6e73 5b66 2750 484f  at.columns[f'PHO
+0002c310: 545f 4944 5f64 7561 6c27 5d29 0a20 2020  T_ID_dual']).   
+0002c320: 2020 2020 2063 6174 2e61 7070 656e 6428       cat.append(
+0002c330: 7068 6f74 5f63 6174 2e63 6f6c 756d 6e73  phot_cat.columns
+0002c340: 5b66 2750 484f 545f 4944 5f52 415f 6475  [f'PHOT_ID_RA_du
+0002c350: 616c 275d 290a 2020 2020 2020 2020 6361  al']).        ca
+0002c360: 742e 6170 7065 6e64 2870 686f 745f 6361  t.append(phot_ca
+0002c370: 742e 636f 6c75 6d6e 735b 6627 5048 4f54  t.columns[f'PHOT
+0002c380: 5f49 445f 4445 435f 6475 616c 275d 290a  _ID_DEC_dual']).
+0002c390: 0a20 2020 2020 2020 2063 6174 2e61 7070  .        cat.app
+0002c3a0: 656e 6428 6669 7473 2e43 6f6c 756d 6e28  end(fits.Column(
+0002c3b0: 6e61 6d65 3d66 277b 6669 6c74 5f73 7461  name=f'{filt_sta
+0002c3c0: 6e64 6172 647d 5f49 445f 6475 616c 272c  ndard}_ID_dual',
+0002c3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c3f0: 666f 726d 6174 3d27 3530 4127 2c0a 2020  format='50A',.  
+0002c400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c410: 2020 2020 2020 2020 2020 2020 2061 7272               arr
+0002c420: 6179 3d70 686f 745f 6361 742e 636f 6c75  ay=phot_cat.colu
+0002c430: 6d6e 735b 6627 5048 4f54 5f49 445f 6475  mns[f'PHOT_ID_du
+0002c440: 616c 275d 2e61 7272 6179 2929 0a0a 2020  al'].array))..  
+0002c450: 2020 2020 2020 2320 5241 2c44 4543 0a20        # RA,DEC. 
+0002c460: 2020 2020 2020 2070 686f 745f 6361 742e         phot_cat.
+0002c470: 636f 6c75 6d6e 735b 2741 4c50 4841 5f4a  columns['ALPHA_J
+0002c480: 3230 3030 275d 2e6e 616d 6520 3d20 2752  2000'].name = 'R
+0002c490: 4127 0a20 2020 2020 2020 2063 6174 2e61  A'.        cat.a
+0002c4a0: 7070 656e 6428 7068 6f74 5f63 6174 2e63  ppend(phot_cat.c
+0002c4b0: 6f6c 756d 6e73 5b27 5241 275d 290a 2020  olumns['RA']).  
+0002c4c0: 2020 2020 2020 7068 6f74 5f63 6174 2e63        phot_cat.c
+0002c4d0: 6f6c 756d 6e73 5b27 4445 4c54 415f 4a32  olumns['DELTA_J2
+0002c4e0: 3030 3027 5d2e 6e61 6d65 203d 2027 4445  000'].name = 'DE
+0002c4f0: 4327 0a20 2020 2020 2020 2063 6174 2e61  C'.        cat.a
+0002c500: 7070 656e 6428 7068 6f74 5f63 6174 2e63  ppend(phot_cat.c
+0002c510: 6f6c 756d 6e73 5b27 4445 4327 5d29 0a0a  olumns['DEC'])..
+0002c520: 2020 2020 2320 5345 585f 4e55 4d42 4552      # SEX_NUMBER
+0002c530: 0a20 2020 2070 686f 745f 6361 742e 636f  .    phot_cat.co
+0002c540: 6c75 6d6e 735b 274e 554d 4245 5227 5d2e  lumns['NUMBER'].
+0002c550: 6e61 6d65 203d 2066 2753 4558 5f4e 554d  name = f'SEX_NUM
+0002c560: 4245 525f 7b66 696c 745f 7374 616e 6461  BER_{filt_standa
+0002c570: 7264 7d27 0a20 2020 2063 6174 2e61 7070  rd}'.    cat.app
+0002c580: 656e 6428 7068 6f74 5f63 6174 2e63 6f6c  end(phot_cat.col
+0002c590: 756d 6e73 5b66 2753 4558 5f4e 554d 4245  umns[f'SEX_NUMBE
+0002c5a0: 525f 7b66 696c 745f 7374 616e 6461 7264  R_{filt_standard
+0002c5b0: 7d27 5d29 0a0a 2020 2020 2320 5345 585f  }'])..    # SEX_
+0002c5c0: 464c 4147 0a20 2020 2070 686f 745f 6361  FLAG.    phot_ca
+0002c5d0: 742e 636f 6c75 6d6e 735b 2746 4c41 4753  t.columns['FLAGS
+0002c5e0: 275d 2e6e 616d 6520 3d20 6627 5345 585f  '].name = f'SEX_
+0002c5f0: 464c 4147 535f 7b66 696c 745f 7374 616e  FLAGS_{filt_stan
+0002c600: 6461 7264 7d27 0a20 2020 2063 6174 2e61  dard}'.    cat.a
+0002c610: 7070 656e 6428 7068 6f74 5f63 6174 2e63  ppend(phot_cat.c
+0002c620: 6f6c 756d 6e73 5b66 2753 4558 5f46 4c41  olumns[f'SEX_FLA
+0002c630: 4753 5f7b 6669 6c74 5f73 7461 6e64 6172  GS_{filt_standar
+0002c640: 647d 275d 290a 0a20 2020 2023 2043 414c  d}'])..    # CAL
+0002c650: 4942 5f46 4c41 470a 2020 2020 2363 6174  IB_FLAG.    #cat
+0002c660: 2e61 7070 656e 6428 6669 7473 2e43 6f6c  .append(fits.Col
+0002c670: 756d 6e28 6e61 6d65 3d27 6361 6c69 625f  umn(name='calib_
+0002c680: 666c 6167 272c 0a20 2020 2023 2020 2020  flag',.    #    
+0002c690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c6a0: 2020 2066 6f72 6d61 743d 2731 4a27 2c0a     format='1J',.
+0002c6b0: 2020 2020 2320 2020 2020 2020 2020 2020      #           
+0002c6c0: 2020 2020 2020 2020 2020 2020 6172 7261              arra
+0002c6d0: 793d 4e5f 736f 7572 6365 732a 5b63 616c  y=N_sources*[cal
+0002c6e0: 6962 7261 7469 6f6e 5f66 6c61 675d 2929  ibration_flag]))
+0002c6f0: 0a0a 2020 2020 2320 4341 4c49 4220 5354  ..    # CALIB ST
+0002c700: 5241 5445 4759 0a20 2020 2069 6620 6361  RATEGY.    if ca
+0002c710: 6c69 6272 6174 696f 6e5f 6e61 6d65 2069  libration_name i
+0002c720: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0002c730: 2020 2020 4e5f 7374 7220 3d20 6c65 6e28      N_str = len(
+0002c740: 6361 6c69 6272 6174 696f 6e5f 6e61 6d65  calibration_name
+0002c750: 290a 2020 2020 2020 2020 6361 742e 6170  ).        cat.ap
+0002c760: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
+0002c770: 286e 616d 653d 6622 6361 6c69 625f 7374  (name=f"calib_st
+0002c780: 7261 7422 2c0a 2020 2020 2020 2020 2020  rat",.          
+0002c790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c7a0: 2020 2020 2066 6f72 6d61 743d 6627 7b4e       format=f'{N
+0002c7b0: 5f73 7472 7d41 272c 0a20 2020 2020 2020  _str}A',.       
+0002c7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c7d0: 2020 2020 2020 2020 6172 7261 793d 5b63          array=[c
+0002c7e0: 616c 6962 7261 7469 6f6e 5f6e 616d 655d  alibration_name]
+0002c7f0: 202a 204e 5f73 6f75 7263 6573 2929 0a0a   * N_sources))..
+0002c800: 2020 2020 6966 206d 6f64 6520 3d3d 2027      if mode == '
+0002c810: 7369 6e67 6c65 273a 0a0a 2020 2020 2020  single':..      
+0002c820: 2020 2320 582c 2059 0a20 2020 2020 2020    # X, Y.       
+0002c830: 2070 686f 745f 6361 742e 636f 6c75 6d6e   phot_cat.column
+0002c840: 735b 2758 5f49 4d41 4745 275d 2e6e 616d  s['X_IMAGE'].nam
+0002c850: 6520 3d20 6627 585f 7b66 696c 745f 7374  e = f'X_{filt_st
+0002c860: 616e 6461 7264 7d27 0a20 2020 2020 2020  andard}'.       
+0002c870: 2063 6174 2e61 7070 656e 6428 7068 6f74   cat.append(phot
+0002c880: 5f63 6174 2e63 6f6c 756d 6e73 5b66 2758  _cat.columns[f'X
+0002c890: 5f7b 6669 6c74 5f73 7461 6e64 6172 647d  _{filt_standard}
+0002c8a0: 275d 290a 0a20 2020 2020 2020 2070 686f  '])..        pho
+0002c8b0: 745f 6361 742e 636f 6c75 6d6e 735b 2759  t_cat.columns['Y
+0002c8c0: 5f49 4d41 4745 275d 2e6e 616d 6520 3d20  _IMAGE'].name = 
+0002c8d0: 6627 595f 7b66 696c 745f 7374 616e 6461  f'Y_{filt_standa
+0002c8e0: 7264 7d27 0a20 2020 2020 2020 2063 6174  rd}'.        cat
+0002c8f0: 2e61 7070 656e 6428 7068 6f74 5f63 6174  .append(phot_cat
+0002c900: 2e63 6f6c 756d 6e73 5b66 2759 5f7b 6669  .columns[f'Y_{fi
+0002c910: 6c74 5f73 7461 6e64 6172 647d 275d 290a  lt_standard}']).
+0002c920: 0a20 2020 2020 2020 2023 2041 2c20 422c  .        # A, B,
+0002c930: 2054 4845 5441 0a20 2020 2020 2020 2070   THETA.        p
+0002c940: 686f 745f 6361 742e 636f 6c75 6d6e 735b  hot_cat.columns[
+0002c950: 2741 5f57 4f52 4c44 275d 2e6e 616d 6520  'A_WORLD'].name 
+0002c960: 3d20 6627 415f 7b66 696c 745f 7374 616e  = f'A_{filt_stan
+0002c970: 6461 7264 7d27 0a20 2020 2020 2020 2063  dard}'.        c
+0002c980: 6174 2e61 7070 656e 6428 7068 6f74 5f63  at.append(phot_c
+0002c990: 6174 2e63 6f6c 756d 6e73 5b66 2741 5f7b  at.columns[f'A_{
+0002c9a0: 6669 6c74 5f73 7461 6e64 6172 647d 275d  filt_standard}']
+0002c9b0: 290a 0a20 2020 2020 2020 2070 686f 745f  )..        phot_
+0002c9c0: 6361 742e 636f 6c75 6d6e 735b 2742 5f57  cat.columns['B_W
+0002c9d0: 4f52 4c44 275d 2e6e 616d 6520 3d20 6627  ORLD'].name = f'
+0002c9e0: 425f 7b66 696c 745f 7374 616e 6461 7264  B_{filt_standard
+0002c9f0: 7d27 0a20 2020 2020 2020 2063 6174 2e61  }'.        cat.a
+0002ca00: 7070 656e 6428 7068 6f74 5f63 6174 2e63  ppend(phot_cat.c
+0002ca10: 6f6c 756d 6e73 5b66 2742 5f7b 6669 6c74  olumns[f'B_{filt
+0002ca20: 5f73 7461 6e64 6172 647d 275d 290a 0a20  _standard}']).. 
+0002ca30: 2020 2020 2020 2070 686f 745f 6361 742e         phot_cat.
+0002ca40: 636f 6c75 6d6e 735b 2754 4845 5441 5f57  columns['THETA_W
+0002ca50: 4f52 4c44 275d 2e6e 616d 6520 3d20 6627  ORLD'].name = f'
+0002ca60: 5448 4554 415f 7b66 696c 745f 7374 616e  THETA_{filt_stan
+0002ca70: 6461 7264 7d27 0a20 2020 2020 2020 2063  dard}'.        c
+0002ca80: 6174 2e61 7070 656e 6428 7068 6f74 5f63  at.append(phot_c
+0002ca90: 6174 2e63 6f6c 756d 6e73 5b66 2754 4845  at.columns[f'THE
+0002caa0: 5441 5f7b 6669 6c74 5f73 7461 6e64 6172  TA_{filt_standar
+0002cab0: 647d 275d 290a 0a20 2020 2020 2020 2023  d}'])..        #
+0002cac0: 2045 6c6f 6e67 6174 696f 6e2c 2045 6c6c   Elongation, Ell
+0002cad0: 6970 7469 6369 7479 0a20 2020 2020 2020  ipticity.       
+0002cae0: 2070 686f 745f 6361 742e 636f 6c75 6d6e   phot_cat.column
+0002caf0: 735b 2745 4c4f 4e47 4154 494f 4e27 5d2e  s['ELONGATION'].
+0002cb00: 6e61 6d65 203d 2066 2745 4c4f 4e47 4154  name = f'ELONGAT
+0002cb10: 494f 4e5f 7b66 696c 745f 7374 616e 6461  ION_{filt_standa
+0002cb20: 7264 7d27 0a20 2020 2020 2020 2063 6174  rd}'.        cat
+0002cb30: 2e61 7070 656e 6428 7068 6f74 5f63 6174  .append(phot_cat
+0002cb40: 2e63 6f6c 756d 6e73 5b66 2745 4c4f 4e47  .columns[f'ELONG
+0002cb50: 4154 494f 4e5f 7b66 696c 745f 7374 616e  ATION_{filt_stan
+0002cb60: 6461 7264 7d27 5d29 0a20 2020 2020 2020  dard}']).       
+0002cb70: 2070 686f 745f 6361 742e 636f 6c75 6d6e   phot_cat.column
+0002cb80: 735b 2745 4c4c 4950 5449 4349 5459 275d  s['ELLIPTICITY']
+0002cb90: 2e6e 616d 6520 3d20 6627 454c 4c49 5054  .name = f'ELLIPT
+0002cba0: 4943 4954 595f 7b66 696c 745f 7374 616e  ICITY_{filt_stan
+0002cbb0: 6461 7264 7d27 0a20 2020 2020 2020 2063  dard}'.        c
+0002cbc0: 6174 2e61 7070 656e 6428 7068 6f74 5f63  at.append(phot_c
+0002cbd0: 6174 2e63 6f6c 756d 6e73 5b66 2745 4c4c  at.columns[f'ELL
+0002cbe0: 4950 5449 4349 5459 5f7b 6669 6c74 5f73  IPTICITY_{filt_s
+0002cbf0: 7461 6e64 6172 647d 275d 290a 0a20 2020  tandard}'])..   
+0002cc00: 2020 2020 2023 2049 534f 6172 6561 0a20       # ISOarea. 
+0002cc10: 2020 2020 2020 2070 686f 745f 6361 742e         phot_cat.
+0002cc20: 636f 6c75 6d6e 735b 2749 534f 4152 4541  columns['ISOAREA
+0002cc30: 5f57 4f52 4c44 275d 2e6e 616d 6520 3d20  _WORLD'].name = 
+0002cc40: 6627 4953 4f61 7265 615f 7b66 696c 745f  f'ISOarea_{filt_
+0002cc50: 7374 616e 6461 7264 7d27 0a20 2020 2020  standard}'.     
+0002cc60: 2020 2063 6174 2e61 7070 656e 6428 7068     cat.append(ph
+0002cc70: 6f74 5f63 6174 2e63 6f6c 756d 6e73 5b66  ot_cat.columns[f
+0002cc80: 2749 534f 6172 6561 5f7b 6669 6c74 5f73  'ISOarea_{filt_s
+0002cc90: 7461 6e64 6172 647d 275d 290a 0a20 2020  tandard}'])..   
+0002cca0: 2020 2020 2023 204b 524f 4e2f 5045 5452       # KRON/PETR
+0002ccb0: 4f53 4941 4e2f 464c 5558 2052 6164 6975  OSIAN/FLUX Radiu
+0002ccc0: 730a 2020 2020 2020 2020 7068 6f74 5f63  s.        phot_c
+0002ccd0: 6174 2e63 6f6c 756d 6e73 5b27 4b52 4f4e  at.columns['KRON
+0002cce0: 5f52 4144 4955 5327 5d2e 6e61 6d65 203d  _RADIUS'].name =
+0002ccf0: 2066 274b 524f 4e5f 5241 4449 5553 5f7b   f'KRON_RADIUS_{
+0002cd00: 6669 6c74 5f73 7461 6e64 6172 647d 270a  filt_standard}'.
+0002cd10: 2020 2020 2020 2020 6361 742e 6170 7065          cat.appe
+0002cd20: 6e64 2870 686f 745f 6361 742e 636f 6c75  nd(phot_cat.colu
+0002cd30: 6d6e 735b 6627 4b52 4f4e 5f52 4144 4955  mns[f'KRON_RADIU
+0002cd40: 535f 7b66 696c 745f 7374 616e 6461 7264  S_{filt_standard
+0002cd50: 7d27 5d29 0a0a 2020 2020 2020 2020 7068  }'])..        ph
+0002cd60: 6f74 5f63 6174 2e63 6f6c 756d 6e73 5b27  ot_cat.columns['
+0002cd70: 5045 5452 4f5f 5241 4449 5553 275d 2e6e  PETRO_RADIUS'].n
+0002cd80: 616d 6520 3d20 6627 5045 5452 4f5f 5241  ame = f'PETRO_RA
+0002cd90: 4449 5553 5f7b 6669 6c74 5f73 7461 6e64  DIUS_{filt_stand
+0002cda0: 6172 647d 270a 2020 2020 2020 2020 6361  ard}'.        ca
+0002cdb0: 742e 6170 7065 6e64 2870 686f 745f 6361  t.append(phot_ca
+0002cdc0: 742e 636f 6c75 6d6e 735b 6627 5045 5452  t.columns[f'PETR
+0002cdd0: 4f5f 5241 4449 5553 5f7b 6669 6c74 5f73  O_RADIUS_{filt_s
+0002cde0: 7461 6e64 6172 647d 275d 290a 0a20 2020  tandard}'])..   
+0002cdf0: 2020 2020 2023 2041 6464 2046 4c55 585f       # Add FLUX_
+0002ce00: 5241 4449 5553 0a20 2020 2020 2020 2066  RADIUS.        f
+0002ce10: 6f72 206a 2c20 7220 696e 207a 6970 2872  or j, r in zip(r
+0002ce20: 616e 6765 2834 292c 205b 3230 2c20 3530  ange(4), [20, 50
+0002ce30: 2c20 3730 2c20 3930 5d29 3a0a 2020 2020  , 70, 90]):.    
+0002ce40: 2020 2020 2020 2020 6361 742e 6170 7065          cat.appe
+0002ce50: 6e64 2866 6974 732e 436f 6c75 6d6e 286e  nd(fits.Column(n
+0002ce60: 616d 653d 6627 464c 5558 5f52 4144 4955  ame=f'FLUX_RADIU
+0002ce70: 535f 7b72 7d5f 7b66 696c 745f 7374 616e  S_{r}_{filt_stan
+0002ce80: 6461 7264 7d27 2c0a 2020 2020 2020 2020  dard}',.        
+0002ce90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cea0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+0002ceb0: 743d 2731 4527 2c0a 2020 2020 2020 2020  t='1E',.        
+0002cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ced0: 6172 7261 793d 7068 6f74 5f63 6174 2e63  array=phot_cat.c
+0002cee0: 6f6c 756d 6e73 5b27 464c 5558 5f52 4144  olumns['FLUX_RAD
+0002cef0: 4955 5327 5d2e 6172 7261 795b 3a2c 206a  IUS'].array[:, j
+0002cf00: 5d29 290a 0a20 2020 2020 2020 2023 2043  ]))..        # C
+0002cf10: 4c41 5353 5f53 5441 520a 2020 2020 2020  LASS_STAR.      
+0002cf20: 2020 7068 6f74 5f63 6174 2e63 6f6c 756d    phot_cat.colum
+0002cf30: 6e73 5b27 434c 4153 535f 5354 4152 275d  ns['CLASS_STAR']
+0002cf40: 2e6e 616d 6520 3d20 6627 434c 4153 535f  .name = f'CLASS_
+0002cf50: 5354 4152 5f7b 6669 6c74 5f73 7461 6e64  STAR_{filt_stand
+0002cf60: 6172 647d 270a 2020 2020 2020 2020 6361  ard}'.        ca
+0002cf70: 742e 6170 7065 6e64 2870 686f 745f 6361  t.append(phot_ca
+0002cf80: 742e 636f 6c75 6d6e 735b 6627 434c 4153  t.columns[f'CLAS
+0002cf90: 535f 5354 4152 5f7b 6669 6c74 5f73 7461  S_STAR_{filt_sta
+0002cfa0: 6e64 6172 647d 275d 290a 0a20 2020 2023  ndard}'])..    #
+0002cfb0: 2046 5748 4d0a 2020 2020 7068 6f74 5f63   FWHM.    phot_c
+0002cfc0: 6174 2e63 6f6c 756d 6e73 5b27 4657 484d  at.columns['FWHM
+0002cfd0: 5f57 4f52 4c44 275d 2e6e 616d 6520 3d20  _WORLD'].name = 
+0002cfe0: 6627 4657 484d 5f7b 6669 6c74 5f73 7461  f'FWHM_{filt_sta
+0002cff0: 6e64 6172 647d 270a 2020 2020 6361 742e  ndard}'.    cat.
+0002d000: 6170 7065 6e64 2870 686f 745f 6361 742e  append(phot_cat.
+0002d010: 636f 6c75 6d6e 735b 6627 4657 484d 5f7b  columns[f'FWHM_{
+0002d020: 6669 6c74 5f73 7461 6e64 6172 647d 275d  filt_standard}']
+0002d030: 290a 0a20 2020 2023 2323 204e 6f72 6d61  )..    ### Norma
+0002d040: 6c69 7a65 6420 4657 484d 0a20 2020 2063  lized FWHM.    c
+0002d050: 6f6c 5f73 326e 5f61 7574 6f20 3d20 7068  ol_s2n_auto = ph
+0002d060: 6f74 5f63 6174 5b27 464c 5558 5f41 5554  ot_cat['FLUX_AUT
+0002d070: 4f27 5d20 2f20 7068 6f74 5f63 6174 5b27  O'] / phot_cat['
+0002d080: 464c 5558 4552 525f 4155 544f 275d 0a20  FLUXERR_AUTO']. 
+0002d090: 2020 2063 6f6c 5f73 326e 5f61 7574 6f20     col_s2n_auto 
+0002d0a0: 3d20 6e70 2e77 6865 7265 2863 6f6c 5f73  = np.where(col_s
+0002d0b0: 326e 5f61 7574 6f20 3e20 302e 2c20 636f  2n_auto > 0., co
+0002d0c0: 6c5f 7332 6e5f 6175 746f 2c20 2d31 2e30  l_s2n_auto, -1.0
+0002d0d0: 3029 0a0a 2020 2020 6966 206d 6f64 6520  0)..    if mode 
+0002d0e0: 3d3d 2022 7369 6e67 6c65 223a 0a20 2020  == "single":.   
+0002d0f0: 2020 2020 2063 6f6c 5f63 6c61 7373 5f73       col_class_s
+0002d100: 7461 7220 3d20 7068 6f74 5f63 6174 5b66  tar = phot_cat[f
+0002d110: 2743 4c41 5353 5f53 5441 525f 7b66 696c  'CLASS_STAR_{fil
+0002d120: 745f 7374 616e 6461 7264 7d27 5d0a 2020  t_standard}'].  
+0002d130: 2020 656c 6966 206d 6f64 6520 3d3d 2022    elif mode == "
+0002d140: 6475 616c 223a 0a20 2020 2020 2020 2063  dual":.        c
+0002d150: 6f6c 5f63 6c61 7373 5f73 7461 7220 3d20  ol_class_star = 
+0002d160: 7068 6f74 5f63 6174 5b66 2743 4c41 5353  phot_cat[f'CLASS
+0002d170: 5f53 5441 5227 5d0a 0a20 2020 2073 656c  _STAR']..    sel
+0002d180: 6563 7469 6f6e 203d 2028 636f 6c5f 7332  ection = (col_s2
+0002d190: 6e5f 6175 746f 203e 3d20 3130 3029 2026  n_auto >= 100) &
+0002d1a0: 2028 636f 6c5f 7332 6e5f 6175 746f 203c   (col_s2n_auto <
+0002d1b0: 3d20 3130 3030 2920 2620 2863 6f6c 5f63  = 1000) & (col_c
+0002d1c0: 6c61 7373 5f73 7461 7220 3e20 302e 3929  lass_star > 0.9)
+0002d1d0: 0a20 2020 206d 6561 6e5f 4657 484d 203d  .    mean_FWHM =
+0002d1e0: 206d 6561 6e5f 726f 6275 7374 2870 686f   mean_robust(pho
+0002d1f0: 745f 6361 745b 6627 4657 484d 5f7b 6669  t_cat[f'FWHM_{fi
+0002d200: 6c74 5f73 7461 6e64 6172 647d 275d 5b73  lt_standard}'][s
+0002d210: 656c 6563 7469 6f6e 5d29 0a0a 2020 2020  election])..    
+0002d220: 636f 6c5f 4657 484d 5f6e 203d 2070 686f  col_FWHM_n = pho
+0002d230: 745f 6361 745b 6627 4657 484d 5f7b 6669  t_cat[f'FWHM_{fi
+0002d240: 6c74 5f73 7461 6e64 6172 647d 275d 202f  lt_standard}'] /
+0002d250: 206d 6561 6e5f 4657 484d 0a0a 2020 2020   mean_FWHM..    
+0002d260: 6361 742e 6170 7065 6e64 2866 6974 732e  cat.append(fits.
+0002d270: 436f 6c75 6d6e 286e 616d 653d 6627 4657  Column(name=f'FW
+0002d280: 484d 5f6e 5f7b 6669 6c74 5f73 7461 6e64  HM_n_{filt_stand
+0002d290: 6172 647d 272c 0a20 2020 2020 2020 2020  ard}',.         
+0002d2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d2b0: 2020 666f 726d 6174 3d27 3145 272c 0a20    format='1E',. 
+0002d2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d2d0: 2020 2020 2020 2020 2020 6172 7261 793d            array=
+0002d2e0: 636f 6c5f 4657 484d 5f6e 2929 0a0a 2020  col_FWHM_n))..  
+0002d2f0: 2020 2320 4d55 5f4d 4158 2c20 4d55 5f54    # MU_MAX, MU_T
+0002d300: 4852 4553 484f 4c44 2c20 4241 434b 4752  HRESHOLD, BACKGR
+0002d310: 4f55 4e44 2c20 5448 5245 5348 4f4c 440a  OUND, THRESHOLD.
+0002d320: 2020 2020 4d55 5f4d 4158 203d 2070 686f      MU_MAX = pho
+0002d330: 745f 6361 742e 636f 6c75 6d6e 735b 274d  t_cat.columns['M
+0002d340: 555f 4d41 5827 5d2e 6172 7261 7920 2d20  U_MAX'].array - 
+0002d350: 7365 785f 6d61 675f 7a70 202b 205a 500a  sex_mag_zp + ZP.
+0002d360: 2020 2020 6361 742e 6170 7065 6e64 2866      cat.append(f
+0002d370: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
+0002d380: 6627 4d55 5f4d 4158 5f7b 6669 6c74 5f73  f'MU_MAX_{filt_s
+0002d390: 7461 6e64 6172 647d 272c 0a20 2020 2020  tandard}',.     
+0002d3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d3b0: 2020 2020 2020 666f 726d 6174 3d27 3145        format='1E
+0002d3c0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0002d3d0: 2020 2020 2020 2020 2020 2020 2020 6172                ar
+0002d3e0: 7261 793d 4d55 5f4d 4158 2929 0a0a 2020  ray=MU_MAX))..  
+0002d3f0: 2020 4d55 5f54 4852 4553 484f 4c44 203d    MU_THRESHOLD =
+0002d400: 2070 686f 745f 6361 742e 636f 6c75 6d6e   phot_cat.column
+0002d410: 735b 274d 555f 5448 5245 5348 4f4c 4427  s['MU_THRESHOLD'
+0002d420: 5d2e 6172 7261 7920 2d20 7365 785f 6d61  ].array - sex_ma
+0002d430: 675f 7a70 202b 205a 500a 2020 2020 6361  g_zp + ZP.    ca
+0002d440: 742e 6170 7065 6e64 2866 6974 732e 436f  t.append(fits.Co
+0002d450: 6c75 6d6e 286e 616d 653d 6627 4d55 5f54  lumn(name=f'MU_T
+0002d460: 4852 4553 484f 4c44 5f7b 6669 6c74 5f73  HRESHOLD_{filt_s
+0002d470: 7461 6e64 6172 647d 272c 0a20 2020 2020  tandard}',.     
+0002d480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d490: 2020 2020 2020 666f 726d 6174 3d27 3145        format='1E
+0002d4a0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0002d4b0: 2020 2020 2020 2020 2020 2020 2020 6172                ar
+0002d4c0: 7261 793d 4d55 5f54 4852 4553 484f 4c44  ray=MU_THRESHOLD
+0002d4d0: 2929 0a0a 2020 2020 4241 434b 4752 4f55  ))..    BACKGROU
+0002d4e0: 4e44 203d 2070 686f 745f 6361 742e 636f  ND = phot_cat.co
+0002d4f0: 6c75 6d6e 735b 2742 4143 4b47 524f 554e  lumns['BACKGROUN
+0002d500: 4427 5d2e 6172 7261 790a 2020 2020 6361  D'].array.    ca
+0002d510: 742e 6170 7065 6e64 2866 6974 732e 436f  t.append(fits.Co
+0002d520: 6c75 6d6e 286e 616d 653d 6627 4241 434b  lumn(name=f'BACK
+0002d530: 4752 4f55 4e44 5f7b 6669 6c74 5f73 7461  GROUND_{filt_sta
+0002d540: 6e64 6172 647d 272c 0a20 2020 2020 2020  ndard}',.       
+0002d550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d560: 2020 2020 666f 726d 6174 3d27 3145 272c      format='1E',
+0002d570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d580: 2020 2020 2020 2020 2020 2020 6172 7261              arra
+0002d590: 793d 4241 434b 4752 4f55 4e44 2929 0a0a  y=BACKGROUND))..
+0002d5a0: 2020 2020 5448 5245 5348 4f4c 4420 3d20      THRESHOLD = 
+0002d5b0: 7068 6f74 5f63 6174 2e63 6f6c 756d 6e73  phot_cat.columns
+0002d5c0: 5b27 5448 5245 5348 4f4c 4427 5d2e 6172  ['THRESHOLD'].ar
+0002d5d0: 7261 790a 2020 2020 6361 742e 6170 7065  ray.    cat.appe
+0002d5e0: 6e64 2866 6974 732e 436f 6c75 6d6e 286e  nd(fits.Column(n
+0002d5f0: 616d 653d 6627 5448 5245 5348 4f4c 445f  ame=f'THRESHOLD_
+0002d600: 7b66 696c 745f 7374 616e 6461 7264 7d27  {filt_standard}'
+0002d610: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002d620: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0002d630: 6d61 743d 2731 4527 2c0a 2020 2020 2020  mat='1E',.      
+0002d640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d650: 2020 2020 2061 7272 6179 3d54 4852 4553       array=THRES
+0002d660: 484f 4c44 2929 0a0a 2020 2020 2320 464c  HOLD))..    # FL
+0002d670: 5558 4553 2061 6e64 204d 4147 4e49 5455  UXES and MAGNITU
+0002d680: 4445 5320 666f 7220 6469 6666 6572 656e  DES for differen
+0002d690: 7420 6170 6572 7475 7265 730a 0a20 2020  t apertures..   
+0002d6a0: 2061 7065 7274 7572 6573 203d 205b 2741   apertures = ['A
+0002d6b0: 5554 4f27 2c20 2750 4554 524f 272c 2027  UTO', 'PETRO', '
+0002d6c0: 4953 4f27 5d0a 2020 2020 666f 7220 6170  ISO'].    for ap
+0002d6d0: 6572 2069 6e20 6170 6572 7475 7265 733a  er in apertures:
+0002d6e0: 0a0a 2020 2020 2020 2020 666d 7420 3d20  ..        fmt = 
+0002d6f0: 2731 4527 0a0a 2020 2020 2020 2020 6620  '1E'..        f 
+0002d700: 3d20 7068 6f74 5f63 6174 2e63 6f6c 756d  = phot_cat.colum
+0002d710: 6e73 5b66 274d 4147 5f7b 6170 6572 7d27  ns[f'MAG_{aper}'
+0002d720: 5d2e 6172 7261 7920 213d 2039 390a 0a20  ].array != 99.. 
+0002d730: 2020 2020 2020 2023 2046 4c55 580a 2020         # FLUX.  
+0002d740: 2020 2020 2020 464c 5558 2020 2020 203d        FLUX     =
+0002d750: 2070 686f 745f 6361 742e 636f 6c75 6d6e   phot_cat.column
+0002d760: 735b 6627 464c 5558 5f7b 6170 6572 7d27  s[f'FLUX_{aper}'
+0002d770: 5d2e 6172 7261 790a 2020 2020 2020 2020  ].array.        
+0002d780: 655f 464c 5558 2020 2020 203d 2070 686f  e_FLUX     = pho
 0002d790: 745f 6361 742e 636f 6c75 6d6e 735b 6627  t_cat.columns[f'
-0002d7a0: 464c 5558 5f7b 6170 6572 7d27 5d2e 6172  FLUX_{aper}'].ar
-0002d7b0: 7261 790a 2020 2020 2020 2020 655f 464c  ray.        e_FL
-0002d7c0: 5558 2020 2020 203d 2070 686f 745f 6361  UX     = phot_ca
-0002d7d0: 742e 636f 6c75 6d6e 735b 6627 464c 5558  t.columns[f'FLUX
-0002d7e0: 4552 525f 7b61 7065 727d 275d 2e61 7272  ERR_{aper}'].arr
-0002d7f0: 6179 0a0a 2020 2020 2020 2020 2320 5369  ay..        # Si
-0002d800: 676e 616c 2074 6f20 6e6f 6973 650a 2020  gnal to noise.  
-0002d810: 2020 2020 2020 7332 6e20 3d20 464c 5558        s2n = FLUX
-0002d820: 2f65 5f46 4c55 580a 0a20 2020 2020 2020  /e_FLUX..       
-0002d830: 2023 2041 4220 6d61 676e 6974 7564 650a   # AB magnitude.
-0002d840: 2020 2020 2020 2020 6d61 6720 2020 2020          mag     
-0002d850: 3d20 7068 6f74 5f63 6174 2e63 6f6c 756d  = phot_cat.colum
-0002d860: 6e73 5b66 274d 4147 5f7b 6170 6572 7d27  ns[f'MAG_{aper}'
-0002d870: 5d2e 6172 7261 790a 2020 2020 2020 2020  ].array.        
-0002d880: 6d61 675b 665d 202b 3d20 5a50 202d 2073  mag[f] += ZP - s
-0002d890: 6578 5f6d 6167 5f7a 700a 0a20 2020 2020  ex_mag_zp..     
-0002d8a0: 2020 2065 5f6d 6167 203d 2070 686f 745f     e_mag = phot_
-0002d8b0: 6361 742e 636f 6c75 6d6e 735b 6627 4d41  cat.columns[f'MA
-0002d8c0: 4745 5252 5f7b 6170 6572 7d27 5d2e 6172  GERR_{aper}'].ar
-0002d8d0: 7261 790a 0a20 2020 2020 2020 2063 6174  ray..        cat
-0002d8e0: 2e61 7070 656e 6428 6669 7473 2e43 6f6c  .append(fits.Col
-0002d8f0: 756d 6e28 6e61 6d65 3d66 277b 6669 6c74  umn(name=f'{filt
-0002d900: 5f73 7461 6e64 6172 647d 5f7b 6170 6572  _standard}_{aper
-0002d910: 2e6c 6f77 6572 2829 7d27 2c0a 2020 2020  .lower()}',.    
-0002d920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d930: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
-0002d940: 743d 666d 742c 0a20 2020 2020 2020 2020  t=fmt,.         
-0002d950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d960: 2020 2020 2020 6172 7261 793d 6d61 6729        array=mag)
-0002d970: 290a 0a20 2020 2020 2020 2063 6174 2e61  )..        cat.a
-0002d980: 7070 656e 6428 6669 7473 2e43 6f6c 756d  ppend(fits.Colum
-0002d990: 6e28 6e61 6d65 3d66 2765 5f7b 6669 6c74  n(name=f'e_{filt
-0002d9a0: 5f73 7461 6e64 6172 647d 5f7b 6170 6572  _standard}_{aper
-0002d9b0: 2e6c 6f77 6572 2829 7d27 2c0a 2020 2020  .lower()}',.    
-0002d9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d9d0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
-0002d9e0: 743d 666d 742c 0a20 2020 2020 2020 2020  t=fmt,.         
-0002d9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002da00: 2020 2020 2020 6172 7261 793d 655f 6d61        array=e_ma
-0002da10: 6729 290a 0a20 2020 2020 2020 2063 6174  g))..        cat
-0002da20: 2e61 7070 656e 6428 6669 7473 2e43 6f6c  .append(fits.Col
-0002da30: 756d 6e28 6e61 6d65 3d66 2773 326e 5f7b  umn(name=f's2n_{
-0002da40: 6669 6c74 5f73 7461 6e64 6172 647d 5f7b  filt_standard}_{
-0002da50: 6170 6572 2e6c 6f77 6572 2829 7d27 2c0a  aper.lower()}',.
-0002da60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002da70: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002da80: 6f72 6d61 743d 666d 742c 0a20 2020 2020  ormat=fmt,.     
-0002da90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002daa0: 2020 2020 2020 2020 2020 6172 7261 793d            array=
-0002dab0: 7332 6e29 290a 0a20 2020 2023 2049 6e63  s2n))..    # Inc
-0002dac0: 6c75 6469 6e67 2041 5045 525f 330a 2020  luding APER_3.  
-0002dad0: 2020 6620 3d20 7068 6f74 5f63 6174 2e63    f = phot_cat.c
-0002dae0: 6f6c 756d 6e73 5b66 274d 4147 5f41 5045  olumns[f'MAG_APE
-0002daf0: 5227 5d2e 6172 7261 795b 3a2c 325d 2021  R'].array[:,2] !
-0002db00: 3d20 3939 0a0a 2020 2020 464c 5558 203d  = 99..    FLUX =
-0002db10: 2070 686f 745f 6361 742e 636f 6c75 6d6e   phot_cat.column
-0002db20: 735b 6627 464c 5558 5f41 5045 5227 5d2e  s[f'FLUX_APER'].
-0002db30: 6172 7261 795b 3a2c 325d 0a20 2020 2065  array[:,2].    e
-0002db40: 5f46 4c55 5820 3d20 7068 6f74 5f63 6174  _FLUX = phot_cat
-0002db50: 2e63 6f6c 756d 6e73 5b66 2746 4c55 5845  .columns[f'FLUXE
-0002db60: 5252 5f41 5045 5227 5d2e 6172 7261 795b  RR_APER'].array[
-0002db70: 3a2c 2032 5d0a 0a20 2020 2073 326e 5f61  :, 2]..    s2n_a
-0002db80: 7065 725f 3320 3d20 464c 5558 202f 2065  per_3 = FLUX / e
-0002db90: 5f46 4c55 580a 0a20 2020 206d 6167 203d  _FLUX..    mag =
-0002dba0: 2070 686f 745f 6361 742e 636f 6c75 6d6e   phot_cat.column
-0002dbb0: 735b 6627 4d41 475f 4150 4552 275d 2e61  s[f'MAG_APER'].a
-0002dbc0: 7272 6179 5b3a 2c20 325d 0a20 2020 206d  rray[:, 2].    m
-0002dbd0: 6167 5b66 5d20 2b3d 205a 5020 2d20 7365  ag[f] += ZP - se
-0002dbe0: 785f 6d61 675f 7a70 0a0a 2020 2020 655f  x_mag_zp..    e_
-0002dbf0: 6d61 6720 3d20 7068 6f74 5f63 6174 2e63  mag = phot_cat.c
-0002dc00: 6f6c 756d 6e73 5b66 274d 4147 4552 525f  olumns[f'MAGERR_
-0002dc10: 4150 4552 275d 2e61 7272 6179 5b3a 2c20  APER'].array[:, 
-0002dc20: 325d 0a0a 2020 2020 6361 742e 6170 7065  2]..    cat.appe
-0002dc30: 6e64 2866 6974 732e 436f 6c75 6d6e 286e  nd(fits.Column(n
-0002dc40: 616d 653d 6627 7b66 696c 745f 7374 616e  ame=f'{filt_stan
-0002dc50: 6461 7264 7d5f 6170 6572 5f33 272c 0a20  dard}_aper_3',. 
-0002dc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dc70: 2020 2020 2020 2020 2020 666f 726d 6174            format
-0002dc80: 3d66 6d74 2c0a 2020 2020 2020 2020 2020  =fmt,.          
-0002dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dca0: 2061 7272 6179 3d6d 6167 2929 0a0a 2020   array=mag))..  
-0002dcb0: 2020 6361 742e 6170 7065 6e64 2866 6974    cat.append(fit
-0002dcc0: 732e 436f 6c75 6d6e 286e 616d 653d 6627  s.Column(name=f'
-0002dcd0: 655f 7b66 696c 745f 7374 616e 6461 7264  e_{filt_standard
-0002dce0: 7d5f 6170 6572 5f33 272c 0a20 2020 2020  }_aper_3',.     
-0002dcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dd00: 2020 2020 2020 666f 726d 6174 3d66 6d74        format=fmt
-0002dd10: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002dd20: 2020 2020 2020 2020 2020 2020 2061 7272               arr
-0002dd30: 6179 3d65 5f6d 6167 2929 0a0a 2020 2020  ay=e_mag))..    
-0002dd40: 6361 742e 6170 7065 6e64 2866 6974 732e  cat.append(fits.
-0002dd50: 436f 6c75 6d6e 286e 616d 653d 6627 7332  Column(name=f's2
-0002dd60: 6e5f 7b66 696c 745f 7374 616e 6461 7264  n_{filt_standard
-0002dd70: 7d5f 6170 6572 5f33 272c 0a20 2020 2020  }_aper_3',.     
-0002dd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dd90: 2020 2020 2020 666f 726d 6174 3d66 6d74        format=fmt
-0002dda0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002ddb0: 2020 2020 2020 2020 2020 2020 2061 7272               arr
-0002ddc0: 6179 3d73 326e 5f61 7065 725f 3329 290a  ay=s2n_aper_3)).
-0002ddd0: 0a20 2020 2023 2049 6e63 6c75 6469 6e67  .    # Including
-0002dde0: 2041 5045 525f 360a 2020 2020 6620 3d20   APER_6.    f = 
+0002d7a0: 464c 5558 4552 525f 7b61 7065 727d 275d  FLUXERR_{aper}']
+0002d7b0: 2e61 7272 6179 0a0a 2020 2020 2020 2020  .array..        
+0002d7c0: 2320 5369 676e 616c 2074 6f20 6e6f 6973  # Signal to nois
+0002d7d0: 650a 2020 2020 2020 2020 7332 6e20 3d20  e.        s2n = 
+0002d7e0: 464c 5558 2f65 5f46 4c55 580a 0a20 2020  FLUX/e_FLUX..   
+0002d7f0: 2020 2020 2023 2041 4220 6d61 676e 6974       # AB magnit
+0002d800: 7564 650a 2020 2020 2020 2020 6d61 6720  ude.        mag 
+0002d810: 2020 2020 3d20 7068 6f74 5f63 6174 2e63      = phot_cat.c
+0002d820: 6f6c 756d 6e73 5b66 274d 4147 5f7b 6170  olumns[f'MAG_{ap
+0002d830: 6572 7d27 5d2e 6172 7261 790a 2020 2020  er}'].array.    
+0002d840: 2020 2020 6d61 675b 665d 202b 3d20 5a50      mag[f] += ZP
+0002d850: 202d 2073 6578 5f6d 6167 5f7a 700a 0a20   - sex_mag_zp.. 
+0002d860: 2020 2020 2020 2065 5f6d 6167 203d 2070         e_mag = p
+0002d870: 686f 745f 6361 742e 636f 6c75 6d6e 735b  hot_cat.columns[
+0002d880: 6627 4d41 4745 5252 5f7b 6170 6572 7d27  f'MAGERR_{aper}'
+0002d890: 5d2e 6172 7261 790a 0a20 2020 2020 2020  ].array..       
+0002d8a0: 2063 6174 2e61 7070 656e 6428 6669 7473   cat.append(fits
+0002d8b0: 2e43 6f6c 756d 6e28 6e61 6d65 3d66 277b  .Column(name=f'{
+0002d8c0: 6669 6c74 5f73 7461 6e64 6172 647d 5f7b  filt_standard}_{
+0002d8d0: 6170 6572 2e6c 6f77 6572 2829 7d27 2c0a  aper.lower()}',.
+0002d8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d8f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002d900: 6f72 6d61 743d 666d 742c 0a20 2020 2020  ormat=fmt,.     
+0002d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d920: 2020 2020 2020 2020 2020 6172 7261 793d            array=
+0002d930: 6d61 6729 290a 0a20 2020 2020 2020 2063  mag))..        c
+0002d940: 6174 2e61 7070 656e 6428 6669 7473 2e43  at.append(fits.C
+0002d950: 6f6c 756d 6e28 6e61 6d65 3d66 2765 5f7b  olumn(name=f'e_{
+0002d960: 6669 6c74 5f73 7461 6e64 6172 647d 5f7b  filt_standard}_{
+0002d970: 6170 6572 2e6c 6f77 6572 2829 7d27 2c0a  aper.lower()}',.
+0002d980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d990: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0002d9a0: 6f72 6d61 743d 666d 742c 0a20 2020 2020  ormat=fmt,.     
+0002d9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d9c0: 2020 2020 2020 2020 2020 6172 7261 793d            array=
+0002d9d0: 655f 6d61 6729 290a 0a20 2020 2020 2020  e_mag))..       
+0002d9e0: 2063 6174 2e61 7070 656e 6428 6669 7473   cat.append(fits
+0002d9f0: 2e43 6f6c 756d 6e28 6e61 6d65 3d66 2773  .Column(name=f's
+0002da00: 326e 5f7b 6669 6c74 5f73 7461 6e64 6172  2n_{filt_standar
+0002da10: 647d 5f7b 6170 6572 2e6c 6f77 6572 2829  d}_{aper.lower()
+0002da20: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
+0002da30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002da40: 2020 2066 6f72 6d61 743d 666d 742c 0a20     format=fmt,. 
+0002da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002da60: 2020 2020 2020 2020 2020 2020 2020 6172                ar
+0002da70: 7261 793d 7332 6e29 290a 0a20 2020 2023  ray=s2n))..    #
+0002da80: 2049 6e63 6c75 6469 6e67 2041 5045 525f   Including APER_
+0002da90: 330a 2020 2020 6620 3d20 7068 6f74 5f63  3.    f = phot_c
+0002daa0: 6174 2e63 6f6c 756d 6e73 5b66 274d 4147  at.columns[f'MAG
+0002dab0: 5f41 5045 5227 5d2e 6172 7261 795b 3a2c  _APER'].array[:,
+0002dac0: 325d 2021 3d20 3939 0a0a 2020 2020 464c  2] != 99..    FL
+0002dad0: 5558 203d 2070 686f 745f 6361 742e 636f  UX = phot_cat.co
+0002dae0: 6c75 6d6e 735b 6627 464c 5558 5f41 5045  lumns[f'FLUX_APE
+0002daf0: 5227 5d2e 6172 7261 795b 3a2c 325d 0a20  R'].array[:,2]. 
+0002db00: 2020 2065 5f46 4c55 5820 3d20 7068 6f74     e_FLUX = phot
+0002db10: 5f63 6174 2e63 6f6c 756d 6e73 5b66 2746  _cat.columns[f'F
+0002db20: 4c55 5845 5252 5f41 5045 5227 5d2e 6172  LUXERR_APER'].ar
+0002db30: 7261 795b 3a2c 2032 5d0a 0a20 2020 2073  ray[:, 2]..    s
+0002db40: 326e 5f61 7065 725f 3320 3d20 464c 5558  2n_aper_3 = FLUX
+0002db50: 202f 2065 5f46 4c55 580a 0a20 2020 206d   / e_FLUX..    m
+0002db60: 6167 203d 2070 686f 745f 6361 742e 636f  ag = phot_cat.co
+0002db70: 6c75 6d6e 735b 6627 4d41 475f 4150 4552  lumns[f'MAG_APER
+0002db80: 275d 2e61 7272 6179 5b3a 2c20 325d 0a20  '].array[:, 2]. 
+0002db90: 2020 206d 6167 5b66 5d20 2b3d 205a 5020     mag[f] += ZP 
+0002dba0: 2d20 7365 785f 6d61 675f 7a70 0a0a 2020  - sex_mag_zp..  
+0002dbb0: 2020 655f 6d61 6720 3d20 7068 6f74 5f63    e_mag = phot_c
+0002dbc0: 6174 2e63 6f6c 756d 6e73 5b66 274d 4147  at.columns[f'MAG
+0002dbd0: 4552 525f 4150 4552 275d 2e61 7272 6179  ERR_APER'].array
+0002dbe0: 5b3a 2c20 325d 0a0a 2020 2020 6361 742e  [:, 2]..    cat.
+0002dbf0: 6170 7065 6e64 2866 6974 732e 436f 6c75  append(fits.Colu
+0002dc00: 6d6e 286e 616d 653d 6627 7b66 696c 745f  mn(name=f'{filt_
+0002dc10: 7374 616e 6461 7264 7d5f 6170 6572 5f33  standard}_aper_3
+0002dc20: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0002dc30: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0002dc40: 726d 6174 3d66 6d74 2c0a 2020 2020 2020  rmat=fmt,.      
+0002dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dc60: 2020 2020 2061 7272 6179 3d6d 6167 2929       array=mag))
+0002dc70: 0a0a 2020 2020 6361 742e 6170 7065 6e64  ..    cat.append
+0002dc80: 2866 6974 732e 436f 6c75 6d6e 286e 616d  (fits.Column(nam
+0002dc90: 653d 6627 655f 7b66 696c 745f 7374 616e  e=f'e_{filt_stan
+0002dca0: 6461 7264 7d5f 6170 6572 5f33 272c 0a20  dard}_aper_3',. 
+0002dcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dcc0: 2020 2020 2020 2020 2020 666f 726d 6174            format
+0002dcd0: 3d66 6d74 2c0a 2020 2020 2020 2020 2020  =fmt,.          
+0002dce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dcf0: 2061 7272 6179 3d65 5f6d 6167 2929 0a0a   array=e_mag))..
+0002dd00: 2020 2020 6361 742e 6170 7065 6e64 2866      cat.append(f
+0002dd10: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
+0002dd20: 6627 7332 6e5f 7b66 696c 745f 7374 616e  f's2n_{filt_stan
+0002dd30: 6461 7264 7d5f 6170 6572 5f33 272c 0a20  dard}_aper_3',. 
+0002dd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dd50: 2020 2020 2020 2020 2020 666f 726d 6174            format
+0002dd60: 3d66 6d74 2c0a 2020 2020 2020 2020 2020  =fmt,.          
+0002dd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dd80: 2061 7272 6179 3d73 326e 5f61 7065 725f   array=s2n_aper_
+0002dd90: 3329 290a 0a20 2020 2023 2049 6e63 6c75  3))..    # Inclu
+0002dda0: 6469 6e67 2041 5045 525f 360a 2020 2020  ding APER_6.    
+0002ddb0: 6620 3d20 7068 6f74 5f63 6174 2e63 6f6c  f = phot_cat.col
+0002ddc0: 756d 6e73 5b66 274d 4147 5f41 5045 5227  umns[f'MAG_APER'
+0002ddd0: 5d2e 6172 7261 795b 3a2c 2034 5d20 213d  ].array[:, 4] !=
+0002dde0: 2039 390a 0a20 2020 2046 4c55 5820 3d20   99..    FLUX = 
 0002ddf0: 7068 6f74 5f63 6174 2e63 6f6c 756d 6e73  phot_cat.columns
-0002de00: 5b66 274d 4147 5f41 5045 5227 5d2e 6172  [f'MAG_APER'].ar
-0002de10: 7261 795b 3a2c 2034 5d20 213d 2039 390a  ray[:, 4] != 99.
-0002de20: 0a20 2020 2046 4c55 5820 3d20 7068 6f74  .    FLUX = phot
-0002de30: 5f63 6174 2e63 6f6c 756d 6e73 5b66 2746  _cat.columns[f'F
-0002de40: 4c55 585f 4150 4552 275d 2e61 7272 6179  LUX_APER'].array
-0002de50: 5b3a 2c20 345d 0a20 2020 2065 5f46 4c55  [:, 4].    e_FLU
-0002de60: 5820 3d20 7068 6f74 5f63 6174 2e63 6f6c  X = phot_cat.col
-0002de70: 756d 6e73 5b66 2746 4c55 5845 5252 5f41  umns[f'FLUXERR_A
-0002de80: 5045 5227 5d2e 6172 7261 795b 3a2c 2034  PER'].array[:, 4
-0002de90: 5d0a 0a20 2020 2073 326e 5f61 7065 725f  ]..    s2n_aper_
-0002dea0: 3620 3d20 464c 5558 202f 2065 5f46 4c55  6 = FLUX / e_FLU
-0002deb0: 580a 0a20 2020 206d 6167 203d 2070 686f  X..    mag = pho
-0002dec0: 745f 6361 742e 636f 6c75 6d6e 735b 6627  t_cat.columns[f'
-0002ded0: 4d41 475f 4150 4552 275d 2e61 7272 6179  MAG_APER'].array
-0002dee0: 5b3a 2c20 345d 0a20 2020 206d 6167 5b66  [:, 4].    mag[f
-0002def0: 5d20 2b3d 205a 5020 2d20 7365 785f 6d61  ] += ZP - sex_ma
-0002df00: 675f 7a70 0a0a 2020 2020 655f 6d61 6720  g_zp..    e_mag 
-0002df10: 3d20 7068 6f74 5f63 6174 2e63 6f6c 756d  = phot_cat.colum
-0002df20: 6e73 5b66 274d 4147 4552 525f 4150 4552  ns[f'MAGERR_APER
-0002df30: 275d 2e61 7272 6179 5b3a 2c20 345d 0a0a  '].array[:, 4]..
-0002df40: 2020 2020 6361 742e 6170 7065 6e64 2866      cat.append(f
-0002df50: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
-0002df60: 6627 7b66 696c 745f 7374 616e 6461 7264  f'{filt_standard
-0002df70: 7d5f 6170 6572 5f36 272c 0a20 2020 2020  }_aper_6',.     
-0002df80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002df90: 2020 2020 2020 666f 726d 6174 3d66 6d74        format=fmt
-0002dfa0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002dfb0: 2020 2020 2020 2020 2020 2020 2061 7272               arr
-0002dfc0: 6179 3d6d 6167 2929 0a0a 2020 2020 6361  ay=mag))..    ca
-0002dfd0: 742e 6170 7065 6e64 2866 6974 732e 436f  t.append(fits.Co
-0002dfe0: 6c75 6d6e 286e 616d 653d 6627 655f 7b66  lumn(name=f'e_{f
-0002dff0: 696c 745f 7374 616e 6461 7264 7d5f 6170  ilt_standard}_ap
-0002e000: 6572 5f36 272c 0a20 2020 2020 2020 2020  er_6',.         
-0002e010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e020: 2020 666f 726d 6174 3d66 6d74 2c0a 2020    format=fmt,.  
-0002e030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e040: 2020 2020 2020 2020 2061 7272 6179 3d65           array=e
-0002e050: 5f6d 6167 2929 0a0a 2020 2020 6361 742e  _mag))..    cat.
-0002e060: 6170 7065 6e64 2866 6974 732e 436f 6c75  append(fits.Colu
-0002e070: 6d6e 286e 616d 653d 6627 7332 6e5f 7b66  mn(name=f's2n_{f
-0002e080: 696c 745f 7374 616e 6461 7264 7d5f 6170  ilt_standard}_ap
-0002e090: 6572 5f36 272c 0a20 2020 2020 2020 2020  er_6',.         
-0002e0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e0b0: 2020 666f 726d 6174 3d66 6d74 2c0a 2020    format=fmt,.  
-0002e0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e0d0: 2020 2020 2020 2020 2061 7272 6179 3d73           array=s
-0002e0e0: 326e 5f61 7065 725f 3629 290a 0a20 2020  2n_aper_6))..   
-0002e0f0: 2023 2050 5374 6f74 616c 2066 6c75 7865   # PStotal fluxe
-0002e100: 7320 616e 6420 6d61 676e 6974 7564 6573  s and magnitudes
-0002e110: 0a20 2020 2023 206d 6167 0a20 2020 206d  .    # mag.    m
-0002e120: 6167 203d 2070 686f 745f 6361 742e 636f  ag = phot_cat.co
-0002e130: 6c75 6d6e 735b 6627 4d41 475f 5053 746f  lumns[f'MAG_PSto
-0002e140: 7461 6c27 5d2e 6172 7261 790a 2020 2020  tal'].array.    
-0002e150: 6620 3d20 6d61 6720 213d 2039 390a 0a20  f = mag != 99.. 
-0002e160: 2020 206d 6167 5b66 5d20 2b3d 205a 5020     mag[f] += ZP 
-0002e170: 2d20 7365 785f 6d61 675f 7a70 0a0a 2020  - sex_mag_zp..  
-0002e180: 2020 655f 6d61 6720 3d20 7068 6f74 5f63    e_mag = phot_c
-0002e190: 6174 2e63 6f6c 756d 6e73 5b66 274d 4147  at.columns[f'MAG
-0002e1a0: 4552 525f 4150 4552 275d 2e61 7272 6179  ERR_APER'].array
-0002e1b0: 5b3a 2c32 5d0a 0a20 2020 2063 6174 2e61  [:,2]..    cat.a
-0002e1c0: 7070 656e 6428 6669 7473 2e43 6f6c 756d  ppend(fits.Colum
-0002e1d0: 6e28 6e61 6d65 3d66 277b 6669 6c74 5f73  n(name=f'{filt_s
-0002e1e0: 7461 6e64 6172 647d 5f50 5374 6f74 616c  tandard}_PStotal
-0002e1f0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0002e200: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0002e210: 726d 6174 3d27 3145 272c 0a20 2020 2020  rmat='1E',.     
-0002e220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e230: 2020 2020 2020 6172 7261 793d 6d61 6729        array=mag)
-0002e240: 290a 0a20 2020 2063 6174 2e61 7070 656e  )..    cat.appen
-0002e250: 6428 6669 7473 2e43 6f6c 756d 6e28 6e61  d(fits.Column(na
-0002e260: 6d65 3d66 2765 5f7b 6669 6c74 5f73 7461  me=f'e_{filt_sta
-0002e270: 6e64 6172 647d 5f50 5374 6f74 616c 272c  ndard}_PStotal',
-0002e280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e290: 2020 2020 2020 2020 2020 2020 666f 726d              form
-0002e2a0: 6174 3d27 3145 272c 0a20 2020 2020 2020  at='1E',.       
-0002e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e2c0: 2020 2020 6172 7261 793d 655f 6d61 6729      array=e_mag)
-0002e2d0: 290a 0a20 2020 2023 2053 324e 0a20 2020  )..    # S2N.   
-0002e2e0: 2073 326e 203d 206e 702e 6675 6c6c 286c   s2n = np.full(l
-0002e2f0: 656e 286d 6167 292c 202d 312e 290a 2020  en(mag), -1.).  
-0002e300: 2020 7332 6e5b 665d 203d 2073 326e 5f61    s2n[f] = s2n_a
-0002e310: 7065 725f 335b 665d 0a0a 2020 2020 6361  per_3[f]..    ca
-0002e320: 742e 6170 7065 6e64 2866 6974 732e 436f  t.append(fits.Co
-0002e330: 6c75 6d6e 286e 616d 653d 6627 7332 6e5f  lumn(name=f's2n_
-0002e340: 7b66 696c 745f 7374 616e 6461 7264 7d5f  {filt_standard}_
-0002e350: 5053 746f 7461 6c27 2c0a 2020 2020 2020  PStotal',.      
-0002e360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e370: 2020 2020 2066 6f72 6d61 743d 2731 4527       format='1E'
-0002e380: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002e390: 2020 2020 2020 2020 2020 2020 2061 7272               arr
-0002e3a0: 6179 3d73 326e 2929 0a0a 2020 2020 6966  ay=s2n))..    if
-0002e3b0: 2065 7874 696e 6374 696f 6e5f 6d61 7073   extinction_maps
-0002e3c0: 5f70 6174 6820 6973 206e 6f74 204e 6f6e  _path is not Non
-0002e3d0: 653a 0a20 2020 2020 2020 2069 6620 6578  e:.        if ex
-0002e3e0: 7469 6e63 7469 6f6e 5f63 6f72 7265 6374  tinction_correct
-0002e3f0: 696f 6e2e 6c6f 7765 7228 2920 3d3d 2027  ion.lower() == '
-0002e400: 7363 686c 6567 656c 273a 0a0a 2020 2020  schlegel':..    
-0002e410: 2020 2020 2020 2020 5241 203d 2070 686f          RA = pho
-0002e420: 745f 6361 742e 636f 6c75 6d6e 735b 6627  t_cat.columns[f'
-0002e430: 5241 5f7b 6669 6c74 5f73 7461 6e64 6172  RA_{filt_standar
-0002e440: 647d 275d 2e61 7272 6179 0a20 2020 2020  d}'].array.     
-0002e450: 2020 2020 2020 2044 4543 203d 2070 686f         DEC = pho
-0002e460: 745f 6361 742e 636f 6c75 6d6e 735b 6627  t_cat.columns[f'
-0002e470: 4445 435f 7b66 696c 745f 7374 616e 6461  DEC_{filt_standa
-0002e480: 7264 7d27 5d2e 6172 7261 790a 0a20 2020  rd}'].array..   
-0002e490: 2020 2020 2020 2020 2045 4256 203d 2067           EBV = g
-0002e4a0: 6574 5f45 4256 5f73 6368 6c65 6765 6c28  et_EBV_schlegel(
-0002e4b0: 5241 2020 3d20 5241 2c0a 2020 2020 2020  RA  = RA,.      
-0002e4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e4d0: 2020 2020 2020 2020 2020 2020 2044 4543               DEC
-0002e4e0: 203d 2044 4543 2c0a 2020 2020 2020 2020   = DEC,.        
-0002e4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e500: 2020 2020 2020 2020 2020 2065 6276 5f6d             ebv_m
-0002e510: 6170 735f 7061 7468 203d 2065 7874 696e  aps_path = extin
-0002e520: 6374 696f 6e5f 6d61 7073 5f70 6174 6829  ction_maps_path)
-0002e530: 0a0a 2020 2020 2020 2020 2020 2020 6361  ..            ca
-0002e540: 742e 6170 7065 6e64 2866 6974 732e 436f  t.append(fits.Co
-0002e550: 6c75 6d6e 286e 616d 653d 6627 4542 565f  lumn(name=f'EBV_
-0002e560: 5343 4827 2c0a 2020 2020 2020 2020 2020  SCH',.          
-0002e570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e580: 2020 2020 2020 2020 2066 6f72 6d61 743d           format=
-0002e590: 2731 4527 2c0a 2020 2020 2020 2020 2020  '1E',.          
-0002e5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e5b0: 2020 2020 2020 2020 2061 7272 6179 3d45           array=E
-0002e5c0: 4256 2929 0a0a 2020 2020 2320 4765 6e65  BV))..    # Gene
-0002e5d0: 7261 7465 2048 4455 2066 726f 6d20 636f  rate HDU from co
-0002e5e0: 6c75 6d6e 730a 2020 2020 6864 7520 3d20  lumns.    hdu = 
-0002e5f0: 6669 7473 2e42 696e 5461 626c 6548 4455  fits.BinTableHDU
-0002e600: 2e66 726f 6d5f 636f 6c75 6d6e 7328 6361  .from_columns(ca
-0002e610: 7429 0a0a 2020 2020 2320 5361 7665 2048  t)..    # Save H
-0002e620: 4455 0a20 2020 2068 6475 2e77 7269 7465  DU.    hdu.write
-0002e630: 746f 2873 6176 655f 6669 6c65 290a 0a0a  to(save_file)...
-0002e640: 6465 6620 7365 7863 6174 616c 6f67 5f64  def sexcatalog_d
-0002e650: 6574 6563 7469 6f6e 2864 6574 6563 7469  etection(detecti
-0002e660: 6f6e 5f66 696c 652c 2073 6176 655f 6669  on_file, save_fi
-0002e670: 6c65 2c20 6669 656c 642c 0a20 2020 2020  le, field,.     
-0002e680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e690: 2020 2020 6361 6c69 6272 6174 696f 6e5f      calibration_
-0002e6a0: 666c 6167 2c20 6578 7469 6e63 7469 6f6e  flag, extinction
-0002e6b0: 5f6d 6170 735f 7061 7468 3d4e 6f6e 652c  _maps_path=None,
-0002e6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e6d0: 2020 2020 2020 2020 2020 6578 7469 6e63            extinc
-0002e6e0: 7469 6f6e 5f63 6f72 7265 6374 696f 6e3d  tion_correction=
-0002e6f0: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-0002e700: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002e710: 616c 6962 7261 7469 6f6e 5f6e 616d 653d  alibration_name=
-0002e720: 4e6f 6e65 293a 0a20 2020 2022 2222 0a0a  None):.    """..
-0002e730: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-0002e740: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-0002e750: 2020 6361 7461 6c6f 675f 6669 6c65 0a20    catalog_file. 
-0002e760: 2020 207a 705f 6669 6c65 0a20 2020 2073     zp_file.    s
-0002e770: 6176 655f 6669 6c65 0a20 2020 2066 696c  ave_file.    fil
-0002e780: 7465 725f 6e61 6d65 0a20 2020 2061 7065  ter_name.    ape
-0002e790: 7274 7572 6573 0a20 2020 206f 7468 6572  rtures.    other
-0002e7a0: 5f63 6f6c 756d 6e73 0a0a 2020 2020 5265  _columns..    Re
-0002e7b0: 7475 726e 730a 2020 2020 2d2d 2d2d 2d2d  turns.    ------
-0002e7c0: 2d0a 0a20 2020 2022 2222 0a0a 2020 2020  -..    """..    
-0002e7d0: 2320 4c6f 6164 2070 686f 746f 6d65 7472  # Load photometr
-0002e7e0: 7920 6361 7461 6c6f 6720 2877 6974 6820  y catalog (with 
-0002e7f0: 6170 6572 7475 7265 2063 6f72 7265 6374  aperture correct
-0002e800: 696f 6e29 0a20 2020 2064 6574 5f63 6174  ion).    det_cat
-0002e810: 203d 2066 6974 732e 6f70 656e 2864 6574   = fits.open(det
-0002e820: 6563 7469 6f6e 5f66 696c 6529 0a20 2020  ection_file).   
-0002e830: 2064 6574 5f63 6174 203d 2064 6574 5f63   det_cat = det_c
-0002e840: 6174 5b31 5d2e 6461 7461 0a0a 2020 2020  at[1].data..    
-0002e850: 4e5f 736f 7572 6365 7320 3d20 6c65 6e28  N_sources = len(
-0002e860: 6465 745f 6361 7429 0a0a 2020 2020 2320  det_cat)..    # 
-0002e870: 4372 6561 7465 206e 6577 2064 6174 6120  Create new data 
-0002e880: 5461 626c 650a 2020 2020 6361 7420 3d20  Table.    cat = 
-0002e890: 5b5d 0a0a 2020 2020 2320 4669 6c6c 206e  []..    # Fill n
-0002e8a0: 6577 2064 6174 6120 5461 626c 6520 2323  ew data Table ##
-0002e8b0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002e8c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002e8d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002e8e0: 2323 2323 0a0a 2020 2020 2320 4669 656c  ####..    # Fiel
-0002e8f0: 6420 636f 6c75 6d6e 0a20 2020 2063 6174  d column.    cat
-0002e900: 2e61 7070 656e 6428 6669 7473 2e43 6f6c  .append(fits.Col
-0002e910: 756d 6e28 6e61 6d65 3d27 4669 656c 6427  umn(name='Field'
-0002e920: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002e930: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0002e940: 6d61 743d 2725 6441 2720 2520 6c65 6e28  mat='%dA' % len(
-0002e950: 6669 656c 6429 2c0a 2020 2020 2020 2020  field),.        
-0002e960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e970: 2020 2061 7272 6179 3d4e 5f73 6f75 7263     array=N_sourc
-0002e980: 6573 202a 205b 6669 656c 645d 2929 0a0a  es * [field]))..
-0002e990: 2020 2020 2320 4649 454c 4420 4944 0a20      # FIELD ID. 
-0002e9a0: 2020 2064 6574 5f63 6174 2e63 6f6c 756d     det_cat.colum
-0002e9b0: 6e73 5b66 2746 4945 4c44 5f49 4427 5d2e  ns[f'FIELD_ID'].
-0002e9c0: 6e61 6d65 203d 2066 2749 4427 0a20 2020  name = f'ID'.   
-0002e9d0: 2063 6174 2e61 7070 656e 6428 6465 745f   cat.append(det_
-0002e9e0: 6361 742e 636f 6c75 6d6e 735b 6627 4944  cat.columns[f'ID
-0002e9f0: 275d 290a 2020 2020 6465 745f 6361 742e  ']).    det_cat.
-0002ea00: 636f 6c75 6d6e 735b 6627 4649 454c 445f  columns[f'FIELD_
-0002ea10: 4944 5f52 4127 5d2e 6e61 6d65 203d 2066  ID_RA'].name = f
-0002ea20: 2749 445f 5241 270a 2020 2020 6361 742e  'ID_RA'.    cat.
-0002ea30: 6170 7065 6e64 2864 6574 5f63 6174 2e63  append(det_cat.c
-0002ea40: 6f6c 756d 6e73 5b66 2749 445f 5241 275d  olumns[f'ID_RA']
-0002ea50: 290a 2020 2020 6465 745f 6361 742e 636f  ).    det_cat.co
-0002ea60: 6c75 6d6e 735b 6627 4649 454c 445f 4944  lumns[f'FIELD_ID
-0002ea70: 5f44 4543 275d 2e6e 616d 6520 3d20 6627  _DEC'].name = f'
-0002ea80: 4944 5f44 4543 270a 2020 2020 6361 742e  ID_DEC'.    cat.
-0002ea90: 6170 7065 6e64 2864 6574 5f63 6174 2e63  append(det_cat.c
-0002eaa0: 6f6c 756d 6e73 5b66 2749 445f 4445 4327  olumns[f'ID_DEC'
-0002eab0: 5d29 0a0a 2020 2020 2320 4164 6420 5048  ])..    # Add PH
-0002eac0: 4f54 2049 4473 0a20 2020 2063 6174 2e61  OT IDs.    cat.a
-0002ead0: 7070 656e 6428 6465 745f 6361 742e 636f  ppend(det_cat.co
-0002eae0: 6c75 6d6e 735b 6627 5048 4f54 5f49 445f  lumns[f'PHOT_ID_
-0002eaf0: 6475 616c 275d 290a 2020 2020 6361 742e  dual']).    cat.
-0002eb00: 6170 7065 6e64 2864 6574 5f63 6174 2e63  append(det_cat.c
-0002eb10: 6f6c 756d 6e73 5b66 2750 484f 545f 4944  olumns[f'PHOT_ID
-0002eb20: 5f52 415f 6475 616c 275d 290a 2020 2020  _RA_dual']).    
-0002eb30: 6361 742e 6170 7065 6e64 2864 6574 5f63  cat.append(det_c
-0002eb40: 6174 2e63 6f6c 756d 6e73 5b66 2750 484f  at.columns[f'PHO
-0002eb50: 545f 4944 5f44 4543 5f64 7561 6c27 5d29  T_ID_DEC_dual'])
-0002eb60: 0a0a 2020 2020 6361 742e 6170 7065 6e64  ..    cat.append
-0002eb70: 2866 6974 732e 436f 6c75 6d6e 286e 616d  (fits.Column(nam
-0002eb80: 653d 6627 4445 545f 4944 5f64 7561 6c27  e=f'DET_ID_dual'
-0002eb90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002eba0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0002ebb0: 6d61 743d 2735 3041 272c 0a20 2020 2020  mat='50A',.     
-0002ebc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ebd0: 2020 2020 2020 6172 7261 793d 6465 745f        array=det_
-0002ebe0: 6361 742e 636f 6c75 6d6e 735b 6627 5048  cat.columns[f'PH
-0002ebf0: 4f54 5f49 445f 6475 616c 275d 2e61 7272  OT_ID_dual'].arr
-0002ec00: 6179 2929 0a0a 2020 2020 2320 5241 2c44  ay))..    # RA,D
-0002ec10: 4543 0a20 2020 2064 6574 5f63 6174 2e63  EC.    det_cat.c
-0002ec20: 6f6c 756d 6e73 5b27 414c 5048 415f 4a32  olumns['ALPHA_J2
-0002ec30: 3030 3027 5d2e 6e61 6d65 203d 2027 5241  000'].name = 'RA
-0002ec40: 270a 2020 2020 6361 742e 6170 7065 6e64  '.    cat.append
-0002ec50: 2864 6574 5f63 6174 2e63 6f6c 756d 6e73  (det_cat.columns
-0002ec60: 5b27 5241 275d 290a 2020 2020 6465 745f  ['RA']).    det_
-0002ec70: 6361 742e 636f 6c75 6d6e 735b 2744 454c  cat.columns['DEL
-0002ec80: 5441 5f4a 3230 3030 275d 2e6e 616d 6520  TA_J2000'].name 
-0002ec90: 3d20 2744 4543 270a 2020 2020 6361 742e  = 'DEC'.    cat.
-0002eca0: 6170 7065 6e64 2864 6574 5f63 6174 2e63  append(det_cat.c
-0002ecb0: 6f6c 756d 6e73 5b27 4445 4327 5d29 0a0a  olumns['DEC'])..
-0002ecc0: 2020 2020 2320 5345 585f 4e55 4d42 4552      # SEX_NUMBER
-0002ecd0: 0a20 2020 2064 6574 5f63 6174 2e63 6f6c  .    det_cat.col
-0002ece0: 756d 6e73 5b27 4e55 4d42 4552 275d 2e6e  umns['NUMBER'].n
-0002ecf0: 616d 6520 3d20 6627 5345 585f 4e55 4d42  ame = f'SEX_NUMB
-0002ed00: 4552 5f44 4554 270a 2020 2020 6361 742e  ER_DET'.    cat.
-0002ed10: 6170 7065 6e64 2864 6574 5f63 6174 2e63  append(det_cat.c
-0002ed20: 6f6c 756d 6e73 5b66 2753 4558 5f4e 554d  olumns[f'SEX_NUM
-0002ed30: 4245 525f 4445 5427 5d29 0a0a 2020 2020  BER_DET'])..    
-0002ed40: 2320 5345 585f 464c 4147 0a20 2020 2064  # SEX_FLAG.    d
-0002ed50: 6574 5f63 6174 2e63 6f6c 756d 6e73 5b27  et_cat.columns['
-0002ed60: 464c 4147 5327 5d2e 6e61 6d65 203d 2066  FLAGS'].name = f
-0002ed70: 2753 4558 5f46 4c41 4753 5f44 4554 270a  'SEX_FLAGS_DET'.
-0002ed80: 2020 2020 6361 742e 6170 7065 6e64 2864      cat.append(d
-0002ed90: 6574 5f63 6174 2e63 6f6c 756d 6e73 5b66  et_cat.columns[f
-0002eda0: 2753 4558 5f46 4c41 4753 5f44 4554 275d  'SEX_FLAGS_DET']
-0002edb0: 290a 0a20 2020 2023 2043 414c 4942 5f46  )..    # CALIB_F
-0002edc0: 4c41 470a 2020 2020 2363 6174 2e61 7070  LAG.    #cat.app
-0002edd0: 656e 6428 6669 7473 2e43 6f6c 756d 6e28  end(fits.Column(
-0002ede0: 6e61 6d65 3d27 6361 6c69 625f 666c 6167  name='calib_flag
-0002edf0: 272c 0a20 2020 2023 2020 2020 2020 2020  ',.    #        
-0002ee00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002ee10: 6f72 6d61 743d 2731 4a27 2c0a 2020 2020  ormat='1J',.    
-0002ee20: 2320 2020 2020 2020 2020 2020 2020 2020  #               
-0002ee30: 2020 2020 2020 2020 6172 7261 793d 4e5f          array=N_
-0002ee40: 736f 7572 6365 7320 2a20 5b63 616c 6962  sources * [calib
-0002ee50: 7261 7469 6f6e 5f66 6c61 675d 2929 0a0a  ration_flag]))..
-0002ee60: 2020 2020 2320 4341 4c49 4220 5354 5241      # CALIB STRA
-0002ee70: 5445 4759 0a20 2020 2069 6620 6361 6c69  TEGY.    if cali
-0002ee80: 6272 6174 696f 6e5f 6e61 6d65 2069 7320  bration_name is 
-0002ee90: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0002eea0: 2020 4e5f 7374 7220 3d20 6c65 6e28 6361    N_str = len(ca
-0002eeb0: 6c69 6272 6174 696f 6e5f 6e61 6d65 290a  libration_name).
-0002eec0: 2020 2020 2020 2020 6361 742e 6170 7065          cat.appe
-0002eed0: 6e64 2866 6974 732e 436f 6c75 6d6e 286e  nd(fits.Column(n
-0002eee0: 616d 653d 6622 6361 6c69 625f 7374 7261  ame=f"calib_stra
-0002eef0: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
-0002ef00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ef10: 2020 2066 6f72 6d61 743d 6627 7b4e 5f73     format=f'{N_s
-0002ef20: 7472 7d41 272c 0a20 2020 2020 2020 2020  tr}A',.         
-0002ef30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ef40: 2020 2020 2020 6172 7261 793d 5b63 616c        array=[cal
-0002ef50: 6962 7261 7469 6f6e 5f6e 616d 655d 202a  ibration_name] *
-0002ef60: 204e 5f73 6f75 7263 6573 2929 0a0a 2020   N_sources))..  
-0002ef70: 2020 2320 582c 2059 0a20 2020 2064 6574    # X, Y.    det
-0002ef80: 5f63 6174 2e63 6f6c 756d 6e73 5b27 585f  _cat.columns['X_
-0002ef90: 494d 4147 4527 5d2e 6e61 6d65 203d 2027  IMAGE'].name = '
-0002efa0: 5827 0a20 2020 2063 6174 2e61 7070 656e  X'.    cat.appen
-0002efb0: 6428 6465 745f 6361 742e 636f 6c75 6d6e  d(det_cat.column
-0002efc0: 735b 2758 275d 290a 0a20 2020 2064 6574  s['X'])..    det
-0002efd0: 5f63 6174 2e63 6f6c 756d 6e73 5b27 595f  _cat.columns['Y_
-0002efe0: 494d 4147 4527 5d2e 6e61 6d65 203d 2027  IMAGE'].name = '
-0002eff0: 5927 0a20 2020 2063 6174 2e61 7070 656e  Y'.    cat.appen
-0002f000: 6428 6465 745f 6361 742e 636f 6c75 6d6e  d(det_cat.column
-0002f010: 735b 2759 275d 290a 0a20 2020 2023 2041  s['Y'])..    # A
-0002f020: 2c20 422c 2054 4845 5441 0a20 2020 2064  , B, THETA.    d
-0002f030: 6574 5f63 6174 2e63 6f6c 756d 6e73 5b27  et_cat.columns['
-0002f040: 415f 574f 524c 4427 5d2e 6e61 6d65 203d  A_WORLD'].name =
-0002f050: 2027 4127 0a20 2020 2063 6174 2e61 7070   'A'.    cat.app
-0002f060: 656e 6428 6465 745f 6361 742e 636f 6c75  end(det_cat.colu
-0002f070: 6d6e 735b 2741 275d 290a 0a20 2020 2064  mns['A'])..    d
-0002f080: 6574 5f63 6174 2e63 6f6c 756d 6e73 5b27  et_cat.columns['
-0002f090: 425f 574f 524c 4427 5d2e 6e61 6d65 203d  B_WORLD'].name =
-0002f0a0: 2027 4227 0a20 2020 2063 6174 2e61 7070   'B'.    cat.app
-0002f0b0: 656e 6428 6465 745f 6361 742e 636f 6c75  end(det_cat.colu
-0002f0c0: 6d6e 735b 2742 275d 290a 0a20 2020 2064  mns['B'])..    d
-0002f0d0: 6574 5f63 6174 2e63 6f6c 756d 6e73 5b27  et_cat.columns['
-0002f0e0: 5448 4554 415f 574f 524c 4427 5d2e 6e61  THETA_WORLD'].na
-0002f0f0: 6d65 203d 2027 5448 4554 4127 0a20 2020  me = 'THETA'.   
-0002f100: 2063 6174 2e61 7070 656e 6428 6465 745f   cat.append(det_
-0002f110: 6361 742e 636f 6c75 6d6e 735b 2754 4845  cat.columns['THE
-0002f120: 5441 275d 290a 0a20 2020 2023 2045 6c6f  TA'])..    # Elo
-0002f130: 6e67 6174 696f 6e2c 2045 6c6c 6970 7469  ngation, Ellipti
-0002f140: 6369 7479 0a20 2020 2063 6174 2e61 7070  city.    cat.app
-0002f150: 656e 6428 6465 745f 6361 742e 636f 6c75  end(det_cat.colu
-0002f160: 6d6e 735b 2745 4c4f 4e47 4154 494f 4e27  mns['ELONGATION'
-0002f170: 5d29 0a20 2020 2063 6174 2e61 7070 656e  ]).    cat.appen
-0002f180: 6428 6465 745f 6361 742e 636f 6c75 6d6e  d(det_cat.column
-0002f190: 735b 2745 4c4c 4950 5449 4349 5459 275d  s['ELLIPTICITY']
-0002f1a0: 290a 0a20 2020 2023 2049 534f 6172 6561  )..    # ISOarea
-0002f1b0: 0a20 2020 2064 6574 5f63 6174 2e63 6f6c  .    det_cat.col
-0002f1c0: 756d 6e73 5b27 4953 4f41 5245 415f 574f  umns['ISOAREA_WO
-0002f1d0: 524c 4427 5d2e 6e61 6d65 203d 2027 4953  RLD'].name = 'IS
-0002f1e0: 4f61 7265 6127 0a20 2020 2063 6174 2e61  Oarea'.    cat.a
-0002f1f0: 7070 656e 6428 6465 745f 6361 742e 636f  ppend(det_cat.co
-0002f200: 6c75 6d6e 735b 2749 534f 6172 6561 275d  lumns['ISOarea']
-0002f210: 290a 0a20 2020 2023 204b 524f 4e2f 5045  )..    # KRON/PE
-0002f220: 5452 4f53 4941 4e2f 464c 5558 2052 6164  TROSIAN/FLUX Rad
-0002f230: 6975 730a 2020 2020 6465 745f 6361 742e  ius.    det_cat.
-0002f240: 636f 6c75 6d6e 735b 274b 524f 4e5f 5241  columns['KRON_RA
-0002f250: 4449 5553 275d 2e6e 616d 6520 3d20 274b  DIUS'].name = 'K
-0002f260: 524f 4e5f 5241 4449 5553 270a 2020 2020  RON_RADIUS'.    
-0002f270: 6361 742e 6170 7065 6e64 2864 6574 5f63  cat.append(det_c
-0002f280: 6174 2e63 6f6c 756d 6e73 5b27 4b52 4f4e  at.columns['KRON
-0002f290: 5f52 4144 4955 5327 5d29 0a0a 2020 2020  _RADIUS'])..    
-0002f2a0: 6465 745f 6361 742e 636f 6c75 6d6e 735b  det_cat.columns[
-0002f2b0: 2750 4554 524f 5f52 4144 4955 5327 5d2e  'PETRO_RADIUS'].
-0002f2c0: 6e61 6d65 203d 2027 5045 5452 4f5f 5241  name = 'PETRO_RA
-0002f2d0: 4449 5553 270a 2020 2020 6361 742e 6170  DIUS'.    cat.ap
-0002f2e0: 7065 6e64 2864 6574 5f63 6174 2e63 6f6c  pend(det_cat.col
-0002f2f0: 756d 6e73 5b27 5045 5452 4f5f 5241 4449  umns['PETRO_RADI
-0002f300: 5553 275d 290a 0a20 2020 2023 2041 6464  US'])..    # Add
-0002f310: 2046 4c55 585f 5241 4449 5553 0a20 2020   FLUX_RADIUS.   
-0002f320: 2066 6f72 206a 2c20 7220 696e 207a 6970   for j, r in zip
-0002f330: 2872 616e 6765 2834 292c 205b 3230 2c20  (range(4), [20, 
-0002f340: 3530 2c20 3730 2c20 3930 5d29 3a0a 2020  50, 70, 90]):.  
-0002f350: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
-0002f360: 2866 6974 732e 436f 6c75 6d6e 286e 616d  (fits.Column(nam
-0002f370: 653d 6627 464c 5558 5f52 4144 4955 535f  e=f'FLUX_RADIUS_
-0002f380: 7b72 7d27 2c0a 2020 2020 2020 2020 2020  {r}',.          
-0002f390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f3a0: 2020 2020 2066 6f72 6d61 743d 2731 4527       format='1E'
-0002f3b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002f3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f3d0: 2061 7272 6179 3d64 6574 5f63 6174 2e63   array=det_cat.c
-0002f3e0: 6f6c 756d 6e73 5b27 464c 5558 5f52 4144  olumns['FLUX_RAD
-0002f3f0: 4955 5327 5d2e 6172 7261 795b 3a2c 206a  IUS'].array[:, j
-0002f400: 5d29 290a 0a20 2020 2023 2043 4c41 5353  ]))..    # CLASS
-0002f410: 5f53 5441 520a 2020 2020 6465 745f 6361  _STAR.    det_ca
-0002f420: 742e 636f 6c75 6d6e 735b 2743 4c41 5353  t.columns['CLASS
-0002f430: 5f53 5441 5227 5d2e 6e61 6d65 203d 2027  _STAR'].name = '
-0002f440: 434c 4153 535f 5354 4152 270a 2020 2020  CLASS_STAR'.    
-0002f450: 6361 742e 6170 7065 6e64 2864 6574 5f63  cat.append(det_c
-0002f460: 6174 2e63 6f6c 756d 6e73 5b27 434c 4153  at.columns['CLAS
-0002f470: 535f 5354 4152 275d 290a 0a20 2020 2023  S_STAR'])..    #
-0002f480: 2046 5748 4d0a 2020 2020 6465 745f 6361   FWHM.    det_ca
-0002f490: 742e 636f 6c75 6d6e 735b 2746 5748 4d5f  t.columns['FWHM_
-0002f4a0: 574f 524c 4427 5d2e 6e61 6d65 203d 2027  WORLD'].name = '
-0002f4b0: 4657 484d 270a 2020 2020 6361 742e 6170  FWHM'.    cat.ap
-0002f4c0: 7065 6e64 2864 6574 5f63 6174 2e63 6f6c  pend(det_cat.col
-0002f4d0: 756d 6e73 5b27 4657 484d 275d 290a 0a20  umns['FWHM']).. 
-0002f4e0: 2020 2023 2323 204e 6f72 6d61 6c69 7a65     ### Normalize
-0002f4f0: 6420 4657 484d 0a20 2020 2063 6f6c 5f73  d FWHM.    col_s
-0002f500: 326e 5f44 6574 5f61 7574 6f20 3d20 6465  2n_Det_auto = de
-0002f510: 745f 6361 745b 2746 4c55 585f 4155 544f  t_cat['FLUX_AUTO
-0002f520: 275d 202f 2064 6574 5f63 6174 5b27 464c  '] / det_cat['FL
-0002f530: 5558 4552 525f 4155 544f 275d 0a20 2020  UXERR_AUTO'].   
-0002f540: 2063 6f6c 5f73 326e 5f44 6574 5f61 7574   col_s2n_Det_aut
-0002f550: 6f20 3d20 6e70 2e77 6865 7265 2863 6f6c  o = np.where(col
-0002f560: 5f73 326e 5f44 6574 5f61 7574 6f20 3e20  _s2n_Det_auto > 
-0002f570: 302e 2c20 636f 6c5f 7332 6e5f 4465 745f  0., col_s2n_Det_
-0002f580: 6175 746f 2c20 2d31 2e30 3029 0a0a 2020  auto, -1.00)..  
-0002f590: 2020 7365 6c65 6374 696f 6e20 3d20 2863    selection = (c
-0002f5a0: 6f6c 5f73 326e 5f44 6574 5f61 7574 6f20  ol_s2n_Det_auto 
-0002f5b0: 3e3d 2031 3030 2920 2620 2863 6f6c 5f73  >= 100) & (col_s
-0002f5c0: 326e 5f44 6574 5f61 7574 6f20 3c3d 2031  2n_Det_auto <= 1
-0002f5d0: 3030 3029 2026 2028 6465 745f 6361 745b  000) & (det_cat[
-0002f5e0: 2743 4c41 5353 5f53 5441 5227 5d20 3e20  'CLASS_STAR'] > 
-0002f5f0: 302e 3929 0a20 2020 206d 6561 6e5f 4657  0.9).    mean_FW
-0002f600: 484d 203d 206d 6561 6e5f 726f 6275 7374  HM = mean_robust
-0002f610: 2864 6574 5f63 6174 5b27 4657 484d 275d  (det_cat['FWHM']
-0002f620: 5b73 656c 6563 7469 6f6e 5d29 0a0a 2020  [selection])..  
-0002f630: 2020 636f 6c5f 4657 484d 5f6e 203d 2064    col_FWHM_n = d
-0002f640: 6574 5f63 6174 5b27 4657 484d 275d 202f  et_cat['FWHM'] /
-0002f650: 206d 6561 6e5f 4657 484d 0a0a 2020 2020   mean_FWHM..    
-0002f660: 6361 742e 6170 7065 6e64 2866 6974 732e  cat.append(fits.
-0002f670: 436f 6c75 6d6e 286e 616d 653d 2746 5748  Column(name='FWH
-0002f680: 4d5f 6e27 2c0a 2020 2020 2020 2020 2020  M_n',.          
-0002f690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f6a0: 2066 6f72 6d61 743d 2731 4527 2c0a 2020   format='1E',.  
-0002f6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f6c0: 2020 2020 2020 2020 2061 7272 6179 3d63           array=c
-0002f6d0: 6f6c 5f46 5748 4d5f 6e29 290a 0a20 2020  ol_FWHM_n))..   
-0002f6e0: 2023 204d 555f 4d41 582c 204d 555f 5448   # MU_MAX, MU_TH
-0002f6f0: 5245 5348 4f4c 442c 2042 4143 4b47 524f  RESHOLD, BACKGRO
-0002f700: 554e 442c 2054 4852 4553 484f 4c44 0a20  UND, THRESHOLD. 
-0002f710: 2020 204d 555f 4d41 5820 3d20 6465 745f     MU_MAX = det_
-0002f720: 6361 742e 636f 6c75 6d6e 735b 274d 555f  cat.columns['MU_
-0002f730: 4d41 5827 5d2e 6172 7261 790a 2020 2020  MAX'].array.    
-0002f740: 6361 742e 6170 7065 6e64 2866 6974 732e  cat.append(fits.
-0002f750: 436f 6c75 6d6e 286e 616d 653d 6627 4d55  Column(name=f'MU
-0002f760: 5f4d 4158 5f49 4e53 5427 2c0a 2020 2020  _MAX_INST',.    
-0002f770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f780: 2020 2020 2020 2066 6f72 6d61 743d 2731         format='1
-0002f790: 4527 2c0a 2020 2020 2020 2020 2020 2020  E',.            
-0002f7a0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0002f7b0: 7272 6179 3d4d 555f 4d41 5829 290a 0a20  rray=MU_MAX)).. 
-0002f7c0: 2020 204d 555f 4d41 5820 3d20 6465 745f     MU_MAX = det_
-0002f7d0: 6361 742e 636f 6c75 6d6e 735b 274d 555f  cat.columns['MU_
-0002f7e0: 5448 5245 5348 4f4c 4427 5d2e 6172 7261  THRESHOLD'].arra
-0002f7f0: 790a 2020 2020 6361 742e 6170 7065 6e64  y.    cat.append
-0002f800: 2866 6974 732e 436f 6c75 6d6e 286e 616d  (fits.Column(nam
-0002f810: 653d 6627 4d55 5f54 4852 4553 484f 4c44  e=f'MU_THRESHOLD
-0002f820: 5f49 4e53 5427 2c0a 2020 2020 2020 2020  _INST',.        
-0002f830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f840: 2020 2066 6f72 6d61 743d 2731 4527 2c0a     format='1E',.
-0002f850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f860: 2020 2020 2020 2020 2020 2061 7272 6179             array
-0002f870: 3d4d 555f 4d41 5829 290a 0a20 2020 2063  =MU_MAX))..    c
-0002f880: 6174 2e61 7070 656e 6428 6465 745f 6361  at.append(det_ca
-0002f890: 742e 636f 6c75 6d6e 735b 2742 4143 4b47  t.columns['BACKG
-0002f8a0: 524f 554e 4427 5d29 0a20 2020 2063 6174  ROUND']).    cat
-0002f8b0: 2e61 7070 656e 6428 6465 745f 6361 742e  .append(det_cat.
-0002f8c0: 636f 6c75 6d6e 735b 2754 4852 4553 484f  columns['THRESHO
-0002f8d0: 4c44 275d 290a 0a20 2020 2023 2323 2053  LD'])..    ### S
-0002f8e0: 324e 5f41 5554 4f0a 2020 2020 636f 6c5f  2N_AUTO.    col_
-0002f8f0: 7332 6e5f 4465 745f 6175 746f 203d 2064  s2n_Det_auto = d
-0002f900: 6574 5f63 6174 5b27 464c 5558 5f41 5554  et_cat['FLUX_AUT
-0002f910: 4f27 5d20 2f20 6465 745f 6361 745b 2746  O'] / det_cat['F
-0002f920: 4c55 5845 5252 5f41 5554 4f27 5d0a 2020  LUXERR_AUTO'].  
-0002f930: 2020 636f 6c5f 7332 6e5f 4465 745f 6175    col_s2n_Det_au
-0002f940: 746f 203d 206e 702e 7768 6572 6528 636f  to = np.where(co
-0002f950: 6c5f 7332 6e5f 4465 745f 6175 746f 203e  l_s2n_Det_auto >
-0002f960: 2030 2e2c 2063 6f6c 5f73 326e 5f44 6574   0., col_s2n_Det
-0002f970: 5f61 7574 6f2c 202d 312e 3030 290a 0a20  _auto, -1.00).. 
-0002f980: 2020 2063 6174 2e61 7070 656e 6428 6669     cat.append(fi
-0002f990: 7473 2e43 6f6c 756d 6e28 6e61 6d65 3d27  ts.Column(name='
-0002f9a0: 7332 6e5f 4445 545f 6175 746f 272c 0a20  s2n_DET_auto',. 
-0002f9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f9c0: 2020 2020 2020 2020 2020 666f 726d 6174            format
-0002f9d0: 3d27 3145 272c 0a20 2020 2020 2020 2020  ='1E',.         
-0002f9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f9f0: 2020 6172 7261 793d 636f 6c5f 7332 6e5f    array=col_s2n_
-0002fa00: 4465 745f 6175 746f 2929 0a0a 2020 2020  Det_auto))..    
-0002fa10: 2323 2320 5332 4e5f 5045 5452 4f0a 2020  ### S2N_PETRO.  
-0002fa20: 2020 636f 6c5f 7332 6e5f 4465 745f 7065    col_s2n_Det_pe
-0002fa30: 7472 6f20 3d20 6465 745f 6361 745b 2746  tro = det_cat['F
-0002fa40: 4c55 585f 5045 5452 4f27 5d20 2f20 6465  LUX_PETRO'] / de
-0002fa50: 745f 6361 745b 2746 4c55 5845 5252 5f50  t_cat['FLUXERR_P
-0002fa60: 4554 524f 275d 0a20 2020 2063 6f6c 5f73  ETRO'].    col_s
-0002fa70: 326e 5f44 6574 5f70 6574 726f 203d 206e  2n_Det_petro = n
-0002fa80: 702e 7768 6572 6528 636f 6c5f 7332 6e5f  p.where(col_s2n_
-0002fa90: 4465 745f 7065 7472 6f20 3e20 302e 2c20  Det_petro > 0., 
-0002faa0: 636f 6c5f 7332 6e5f 4465 745f 7065 7472  col_s2n_Det_petr
-0002fab0: 6f2c 202d 312e 3030 290a 0a20 2020 2063  o, -1.00)..    c
-0002fac0: 6174 2e61 7070 656e 6428 6669 7473 2e43  at.append(fits.C
-0002fad0: 6f6c 756d 6e28 6e61 6d65 3d27 7332 6e5f  olumn(name='s2n_
-0002fae0: 4445 545f 7065 7472 6f27 2c0a 2020 2020  DET_petro',.    
-0002faf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fb00: 2020 2020 2020 2066 6f72 6d61 743d 2731         format='1
-0002fb10: 4527 2c0a 2020 2020 2020 2020 2020 2020  E',.            
-0002fb20: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0002fb30: 7272 6179 3d63 6f6c 5f73 326e 5f44 6574  rray=col_s2n_Det
-0002fb40: 5f70 6574 726f 2929 0a0a 2020 2020 2323  _petro))..    ##
-0002fb50: 2320 5332 4e5f 4953 4f0a 2020 2020 636f  # S2N_ISO.    co
-0002fb60: 6c5f 7332 6e5f 4465 745f 6973 6f20 3d20  l_s2n_Det_iso = 
-0002fb70: 6465 745f 6361 745b 2746 4c55 585f 4953  det_cat['FLUX_IS
-0002fb80: 4f27 5d20 2f20 6465 745f 6361 745b 2746  O'] / det_cat['F
-0002fb90: 4c55 5845 5252 5f49 534f 275d 0a20 2020  LUXERR_ISO'].   
-0002fba0: 2063 6f6c 5f73 326e 5f44 6574 5f69 736f   col_s2n_Det_iso
-0002fbb0: 203d 206e 702e 7768 6572 6528 636f 6c5f   = np.where(col_
-0002fbc0: 7332 6e5f 4465 745f 6973 6f20 3e20 302e  s2n_Det_iso > 0.
-0002fbd0: 2c20 636f 6c5f 7332 6e5f 4465 745f 6973  , col_s2n_Det_is
-0002fbe0: 6f2c 202d 312e 3030 290a 0a20 2020 2063  o, -1.00)..    c
-0002fbf0: 6174 2e61 7070 656e 6428 6669 7473 2e43  at.append(fits.C
-0002fc00: 6f6c 756d 6e28 6e61 6d65 3d27 7332 6e5f  olumn(name='s2n_
-0002fc10: 4445 545f 6973 6f27 2c0a 2020 2020 2020  DET_iso',.      
-0002fc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fc30: 2020 2020 2066 6f72 6d61 743d 2731 4527       format='1E'
-0002fc40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002fc50: 2020 2020 2020 2020 2020 2020 2061 7272               arr
-0002fc60: 6179 3d63 6f6c 5f73 326e 5f44 6574 5f69  ay=col_s2n_Det_i
-0002fc70: 736f 2929 0a0a 2020 2020 2323 2320 4649  so))..    ### FI
-0002fc80: 5845 4420 4150 4552 5455 5245 530a 2020  XED APERTURES.  
-0002fc90: 2020 636f 6c5f 7332 6e5f 6170 6572 5f33    col_s2n_aper_3
-0002fca0: 203d 2064 6574 5f63 6174 2e63 6f6c 756d   = det_cat.colum
-0002fcb0: 6e73 5b27 464c 5558 5f41 5045 5227 5d2e  ns['FLUX_APER'].
-0002fcc0: 6172 7261 795b 3a2c 2032 5d20 2f20 6465  array[:, 2] / de
-0002fcd0: 745f 6361 742e 636f 6c75 6d6e 735b 2746  t_cat.columns['F
-0002fce0: 4c55 5845 5252 5f41 5045 5227 5d2e 6172  LUXERR_APER'].ar
-0002fcf0: 7261 795b 3a2c 2032 5d0a 2020 2020 636f  ray[:, 2].    co
-0002fd00: 6c5f 7332 6e5f 6170 6572 5f33 203d 206e  l_s2n_aper_3 = n
-0002fd10: 702e 7768 6572 6528 636f 6c5f 7332 6e5f  p.where(col_s2n_
-0002fd20: 6170 6572 5f33 203e 2030 2e2c 2063 6f6c  aper_3 > 0., col
-0002fd30: 5f73 326e 5f61 7065 725f 332c 202d 312e  _s2n_aper_3, -1.
-0002fd40: 3030 290a 0a20 2020 2063 6174 2e61 7070  00)..    cat.app
-0002fd50: 656e 6428 6669 7473 2e43 6f6c 756d 6e28  end(fits.Column(
-0002fd60: 6e61 6d65 3d27 7332 6e5f 4445 545f 6170  name='s2n_DET_ap
-0002fd70: 6572 5f33 272c 0a20 2020 2020 2020 2020  er_3',.         
-0002fd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fd90: 2020 666f 726d 6174 3d27 3145 272c 0a20    format='1E',. 
-0002fda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fdb0: 2020 2020 2020 2020 2020 6172 7261 793d            array=
-0002fdc0: 636f 6c5f 7332 6e5f 6170 6572 5f33 2929  col_s2n_aper_3))
-0002fdd0: 0a0a 2020 2020 636f 6c5f 7332 6e5f 6170  ..    col_s2n_ap
-0002fde0: 6572 5f36 203d 2064 6574 5f63 6174 2e63  er_6 = det_cat.c
-0002fdf0: 6f6c 756d 6e73 5b27 464c 5558 5f41 5045  olumns['FLUX_APE
-0002fe00: 5227 5d2e 6172 7261 795b 3a2c 2034 5d20  R'].array[:, 4] 
-0002fe10: 2f20 6465 745f 6361 742e 636f 6c75 6d6e  / det_cat.column
-0002fe20: 735b 2746 4c55 5845 5252 5f41 5045 5227  s['FLUXERR_APER'
-0002fe30: 5d2e 6172 7261 795b 3a2c 2034 5d0a 2020  ].array[:, 4].  
-0002fe40: 2020 636f 6c5f 7332 6e5f 6170 6572 5f36    col_s2n_aper_6
-0002fe50: 203d 206e 702e 7768 6572 6528 636f 6c5f   = np.where(col_
-0002fe60: 7332 6e5f 6170 6572 5f36 203e 2030 2e2c  s2n_aper_6 > 0.,
-0002fe70: 2063 6f6c 5f73 326e 5f61 7065 725f 362c   col_s2n_aper_6,
-0002fe80: 202d 312e 3030 290a 0a20 2020 2063 6174   -1.00)..    cat
-0002fe90: 2e61 7070 656e 6428 6669 7473 2e43 6f6c  .append(fits.Col
-0002fea0: 756d 6e28 6e61 6d65 3d27 7332 6e5f 4445  umn(name='s2n_DE
-0002feb0: 545f 6170 6572 5f36 272c 0a20 2020 2020  T_aper_6',.     
-0002fec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fed0: 2020 2020 2020 666f 726d 6174 3d27 3145        format='1E
-0002fee0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0002fef0: 2020 2020 2020 2020 2020 2020 2020 6172                ar
-0002ff00: 7261 793d 636f 6c5f 7332 6e5f 6170 6572  ray=col_s2n_aper
-0002ff10: 5f36 2929 0a0a 2020 2020 6361 742e 6170  _6))..    cat.ap
-0002ff20: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
-0002ff30: 286e 616d 653d 2773 326e 5f44 4554 5f50  (name='s2n_DET_P
-0002ff40: 5374 6f74 616c 272c 0a20 2020 2020 2020  Stotal',.       
-0002ff50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ff60: 2020 2020 666f 726d 6174 3d27 3145 272c      format='1E',
-0002ff70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ff80: 2020 2020 2020 2020 2020 2020 6172 7261              arra
-0002ff90: 793d 636f 6c5f 7332 6e5f 6170 6572 5f33  y=col_s2n_aper_3
-0002ffa0: 2929 0a0a 2020 2020 6966 2065 7874 696e  ))..    if extin
-0002ffb0: 6374 696f 6e5f 6d61 7073 5f70 6174 6820  ction_maps_path 
-0002ffc0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0002ffd0: 2020 2020 2069 6620 6578 7469 6e63 7469       if extincti
-0002ffe0: 6f6e 5f63 6f72 7265 6374 696f 6e2e 6c6f  on_correction.lo
-0002fff0: 7765 7228 2920 3d3d 2027 7363 686c 6567  wer() == 'schleg
-00030000: 656c 273a 0a0a 2020 2020 2020 2020 2020  el':..          
-00030010: 2020 5241 203d 2064 6574 5f63 6174 2e63    RA = det_cat.c
-00030020: 6f6c 756d 6e73 5b66 2752 4127 5d2e 6172  olumns[f'RA'].ar
-00030030: 7261 790a 2020 2020 2020 2020 2020 2020  ray.            
-00030040: 4445 4320 3d20 6465 745f 6361 742e 636f  DEC = det_cat.co
-00030050: 6c75 6d6e 735b 6627 4445 4327 5d2e 6172  lumns[f'DEC'].ar
-00030060: 7261 790a 0a20 2020 2020 2020 2020 2020  ray..           
-00030070: 2045 4256 203d 2067 6574 5f45 4256 5f73   EBV = get_EBV_s
-00030080: 6368 6c65 6765 6c28 5241 2020 3d20 5241  chlegel(RA  = RA
-00030090: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000300a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000300b0: 2020 2020 2044 4543 203d 2044 4543 2c0a       DEC = DEC,.
-000300c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000300d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000300e0: 2020 2065 6276 5f6d 6170 735f 7061 7468     ebv_maps_path
-000300f0: 203d 2065 7874 696e 6374 696f 6e5f 6d61   = extinction_ma
-00030100: 7073 5f70 6174 6829 0a0a 2020 2020 2020  ps_path)..      
-00030110: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
-00030120: 2866 6974 732e 436f 6c75 6d6e 286e 616d  (fits.Column(nam
-00030130: 653d 6627 4542 565f 5343 4827 2c0a 2020  e=f'EBV_SCH',.  
+0002de00: 5b66 2746 4c55 585f 4150 4552 275d 2e61  [f'FLUX_APER'].a
+0002de10: 7272 6179 5b3a 2c20 345d 0a20 2020 2065  rray[:, 4].    e
+0002de20: 5f46 4c55 5820 3d20 7068 6f74 5f63 6174  _FLUX = phot_cat
+0002de30: 2e63 6f6c 756d 6e73 5b66 2746 4c55 5845  .columns[f'FLUXE
+0002de40: 5252 5f41 5045 5227 5d2e 6172 7261 795b  RR_APER'].array[
+0002de50: 3a2c 2034 5d0a 0a20 2020 2073 326e 5f61  :, 4]..    s2n_a
+0002de60: 7065 725f 3620 3d20 464c 5558 202f 2065  per_6 = FLUX / e
+0002de70: 5f46 4c55 580a 0a20 2020 206d 6167 203d  _FLUX..    mag =
+0002de80: 2070 686f 745f 6361 742e 636f 6c75 6d6e   phot_cat.column
+0002de90: 735b 6627 4d41 475f 4150 4552 275d 2e61  s[f'MAG_APER'].a
+0002dea0: 7272 6179 5b3a 2c20 345d 0a20 2020 206d  rray[:, 4].    m
+0002deb0: 6167 5b66 5d20 2b3d 205a 5020 2d20 7365  ag[f] += ZP - se
+0002dec0: 785f 6d61 675f 7a70 0a0a 2020 2020 655f  x_mag_zp..    e_
+0002ded0: 6d61 6720 3d20 7068 6f74 5f63 6174 2e63  mag = phot_cat.c
+0002dee0: 6f6c 756d 6e73 5b66 274d 4147 4552 525f  olumns[f'MAGERR_
+0002def0: 4150 4552 275d 2e61 7272 6179 5b3a 2c20  APER'].array[:, 
+0002df00: 345d 0a0a 2020 2020 6361 742e 6170 7065  4]..    cat.appe
+0002df10: 6e64 2866 6974 732e 436f 6c75 6d6e 286e  nd(fits.Column(n
+0002df20: 616d 653d 6627 7b66 696c 745f 7374 616e  ame=f'{filt_stan
+0002df30: 6461 7264 7d5f 6170 6572 5f36 272c 0a20  dard}_aper_6',. 
+0002df40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002df50: 2020 2020 2020 2020 2020 666f 726d 6174            format
+0002df60: 3d66 6d74 2c0a 2020 2020 2020 2020 2020  =fmt,.          
+0002df70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002df80: 2061 7272 6179 3d6d 6167 2929 0a0a 2020   array=mag))..  
+0002df90: 2020 6361 742e 6170 7065 6e64 2866 6974    cat.append(fit
+0002dfa0: 732e 436f 6c75 6d6e 286e 616d 653d 6627  s.Column(name=f'
+0002dfb0: 655f 7b66 696c 745f 7374 616e 6461 7264  e_{filt_standard
+0002dfc0: 7d5f 6170 6572 5f36 272c 0a20 2020 2020  }_aper_6',.     
+0002dfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dfe0: 2020 2020 2020 666f 726d 6174 3d66 6d74        format=fmt
+0002dff0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002e000: 2020 2020 2020 2020 2020 2020 2061 7272               arr
+0002e010: 6179 3d65 5f6d 6167 2929 0a0a 2020 2020  ay=e_mag))..    
+0002e020: 6361 742e 6170 7065 6e64 2866 6974 732e  cat.append(fits.
+0002e030: 436f 6c75 6d6e 286e 616d 653d 6627 7332  Column(name=f's2
+0002e040: 6e5f 7b66 696c 745f 7374 616e 6461 7264  n_{filt_standard
+0002e050: 7d5f 6170 6572 5f36 272c 0a20 2020 2020  }_aper_6',.     
+0002e060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e070: 2020 2020 2020 666f 726d 6174 3d66 6d74        format=fmt
+0002e080: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002e090: 2020 2020 2020 2020 2020 2020 2061 7272               arr
+0002e0a0: 6179 3d73 326e 5f61 7065 725f 3629 290a  ay=s2n_aper_6)).
+0002e0b0: 0a20 2020 2023 2050 5374 6f74 616c 2066  .    # PStotal f
+0002e0c0: 6c75 7865 7320 616e 6420 6d61 676e 6974  luxes and magnit
+0002e0d0: 7564 6573 0a20 2020 2023 206d 6167 0a20  udes.    # mag. 
+0002e0e0: 2020 206d 6167 203d 2070 686f 745f 6361     mag = phot_ca
+0002e0f0: 742e 636f 6c75 6d6e 735b 6627 4d41 475f  t.columns[f'MAG_
+0002e100: 5053 746f 7461 6c27 5d2e 6172 7261 790a  PStotal'].array.
+0002e110: 2020 2020 6620 3d20 6d61 6720 213d 2039      f = mag != 9
+0002e120: 390a 0a20 2020 206d 6167 5b66 5d20 2b3d  9..    mag[f] +=
+0002e130: 205a 5020 2d20 7365 785f 6d61 675f 7a70   ZP - sex_mag_zp
+0002e140: 0a0a 2020 2020 655f 6d61 6720 3d20 7068  ..    e_mag = ph
+0002e150: 6f74 5f63 6174 2e63 6f6c 756d 6e73 5b66  ot_cat.columns[f
+0002e160: 274d 4147 4552 525f 4150 4552 275d 2e61  'MAGERR_APER'].a
+0002e170: 7272 6179 5b3a 2c32 5d0a 0a20 2020 2063  rray[:,2]..    c
+0002e180: 6174 2e61 7070 656e 6428 6669 7473 2e43  at.append(fits.C
+0002e190: 6f6c 756d 6e28 6e61 6d65 3d66 277b 6669  olumn(name=f'{fi
+0002e1a0: 6c74 5f73 7461 6e64 6172 647d 5f50 5374  lt_standard}_PSt
+0002e1b0: 6f74 616c 272c 0a20 2020 2020 2020 2020  otal',.         
+0002e1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e1d0: 2020 666f 726d 6174 3d27 3145 272c 0a20    format='1E',. 
+0002e1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e1f0: 2020 2020 2020 2020 2020 6172 7261 793d            array=
+0002e200: 6d61 6729 290a 0a20 2020 2063 6174 2e61  mag))..    cat.a
+0002e210: 7070 656e 6428 6669 7473 2e43 6f6c 756d  ppend(fits.Colum
+0002e220: 6e28 6e61 6d65 3d66 2765 5f7b 6669 6c74  n(name=f'e_{filt
+0002e230: 5f73 7461 6e64 6172 647d 5f50 5374 6f74  _standard}_PStot
+0002e240: 616c 272c 0a20 2020 2020 2020 2020 2020  al',.           
+0002e250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e260: 666f 726d 6174 3d27 3145 272c 0a20 2020  format='1E',.   
+0002e270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e280: 2020 2020 2020 2020 6172 7261 793d 655f          array=e_
+0002e290: 6d61 6729 290a 0a20 2020 2023 2053 324e  mag))..    # S2N
+0002e2a0: 0a20 2020 2073 326e 203d 206e 702e 6675  .    s2n = np.fu
+0002e2b0: 6c6c 286c 656e 286d 6167 292c 202d 312e  ll(len(mag), -1.
+0002e2c0: 290a 2020 2020 7332 6e5b 665d 203d 2073  ).    s2n[f] = s
+0002e2d0: 326e 5f61 7065 725f 335b 665d 0a0a 2020  2n_aper_3[f]..  
+0002e2e0: 2020 6361 742e 6170 7065 6e64 2866 6974    cat.append(fit
+0002e2f0: 732e 436f 6c75 6d6e 286e 616d 653d 6627  s.Column(name=f'
+0002e300: 7332 6e5f 7b66 696c 745f 7374 616e 6461  s2n_{filt_standa
+0002e310: 7264 7d5f 5053 746f 7461 6c27 2c0a 2020  rd}_PStotal',.  
+0002e320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e330: 2020 2020 2020 2020 2066 6f72 6d61 743d           format=
+0002e340: 2731 4527 2c0a 2020 2020 2020 2020 2020  '1E',.          
+0002e350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e360: 2061 7272 6179 3d73 326e 2929 0a0a 2020   array=s2n))..  
+0002e370: 2020 6966 2065 7874 696e 6374 696f 6e5f    if extinction_
+0002e380: 6d61 7073 5f70 6174 6820 6973 206e 6f74  maps_path is not
+0002e390: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+0002e3a0: 6620 6578 7469 6e63 7469 6f6e 5f63 6f72  f extinction_cor
+0002e3b0: 7265 6374 696f 6e2e 6c6f 7765 7228 2920  rection.lower() 
+0002e3c0: 3d3d 2027 7363 686c 6567 656c 273a 0a0a  == 'schlegel':..
+0002e3d0: 2020 2020 2020 2020 2020 2020 5241 203d              RA =
+0002e3e0: 2070 686f 745f 6361 742e 636f 6c75 6d6e   phot_cat.column
+0002e3f0: 735b 6627 5241 5f7b 6669 6c74 5f73 7461  s[f'RA_{filt_sta
+0002e400: 6e64 6172 647d 275d 2e61 7272 6179 0a20  ndard}'].array. 
+0002e410: 2020 2020 2020 2020 2020 2044 4543 203d             DEC =
+0002e420: 2070 686f 745f 6361 742e 636f 6c75 6d6e   phot_cat.column
+0002e430: 735b 6627 4445 435f 7b66 696c 745f 7374  s[f'DEC_{filt_st
+0002e440: 616e 6461 7264 7d27 5d2e 6172 7261 790a  andard}'].array.
+0002e450: 0a20 2020 2020 2020 2020 2020 2045 4256  .            EBV
+0002e460: 203d 2067 6574 5f45 4256 5f73 6368 6c65   = get_EBV_schle
+0002e470: 6765 6c28 5241 2020 3d20 5241 2c0a 2020  gel(RA  = RA,.  
+0002e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e4a0: 2044 4543 203d 2044 4543 2c0a 2020 2020   DEC = DEC,.    
+0002e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e4c0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0002e4d0: 6276 5f6d 6170 735f 7061 7468 203d 2065  bv_maps_path = e
+0002e4e0: 7874 696e 6374 696f 6e5f 6d61 7073 5f70  xtinction_maps_p
+0002e4f0: 6174 6829 0a0a 2020 2020 2020 2020 2020  ath)..          
+0002e500: 2020 6361 742e 6170 7065 6e64 2866 6974    cat.append(fit
+0002e510: 732e 436f 6c75 6d6e 286e 616d 653d 6627  s.Column(name=f'
+0002e520: 4542 565f 5343 4827 2c0a 2020 2020 2020  EBV_SCH',.      
+0002e530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e540: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0002e550: 6d61 743d 2731 4527 2c0a 2020 2020 2020  mat='1E',.      
+0002e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e570: 2020 2020 2020 2020 2020 2020 2061 7272               arr
+0002e580: 6179 3d45 4256 2929 0a0a 2020 2020 2320  ay=EBV))..    # 
+0002e590: 4765 6e65 7261 7465 2048 4455 2066 726f  Generate HDU fro
+0002e5a0: 6d20 636f 6c75 6d6e 730a 2020 2020 6864  m columns.    hd
+0002e5b0: 7520 3d20 6669 7473 2e42 696e 5461 626c  u = fits.BinTabl
+0002e5c0: 6548 4455 2e66 726f 6d5f 636f 6c75 6d6e  eHDU.from_column
+0002e5d0: 7328 6361 7429 0a0a 2020 2020 2320 5361  s(cat)..    # Sa
+0002e5e0: 7665 2048 4455 0a20 2020 2068 6475 2e77  ve HDU.    hdu.w
+0002e5f0: 7269 7465 746f 2873 6176 655f 6669 6c65  riteto(save_file
+0002e600: 290a 0a0a 6465 6620 7365 7863 6174 616c  )...def sexcatal
+0002e610: 6f67 5f64 6574 6563 7469 6f6e 2864 6574  og_detection(det
+0002e620: 6563 7469 6f6e 5f66 696c 652c 2073 6176  ection_file, sav
+0002e630: 655f 6669 6c65 2c20 6669 656c 642c 0a20  e_file, field,. 
+0002e640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e650: 2020 2020 2020 2020 6361 6c69 6272 6174          calibrat
+0002e660: 696f 6e5f 666c 6167 2c20 6578 7469 6e63  ion_flag, extinc
+0002e670: 7469 6f6e 5f6d 6170 735f 7061 7468 3d4e  tion_maps_path=N
+0002e680: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0002e690: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0002e6a0: 7469 6e63 7469 6f6e 5f63 6f72 7265 6374  tinction_correct
+0002e6b0: 696f 6e3d 4e6f 6e65 2c0a 2020 2020 2020  ion=None,.      
+0002e6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e6d0: 2020 2063 616c 6962 7261 7469 6f6e 5f6e     calibration_n
+0002e6e0: 616d 653d 4e6f 6e65 293a 0a20 2020 2022  ame=None):.    "
+0002e6f0: 2222 0a0a 2020 2020 5061 7261 6d65 7465  ""..    Paramete
+0002e700: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
+0002e710: 2d0a 2020 2020 6361 7461 6c6f 675f 6669  -.    catalog_fi
+0002e720: 6c65 0a20 2020 207a 705f 6669 6c65 0a20  le.    zp_file. 
+0002e730: 2020 2073 6176 655f 6669 6c65 0a20 2020     save_file.   
+0002e740: 2066 696c 7465 725f 6e61 6d65 0a20 2020   filter_name.   
+0002e750: 2061 7065 7274 7572 6573 0a20 2020 206f   apertures.    o
+0002e760: 7468 6572 5f63 6f6c 756d 6e73 0a0a 2020  ther_columns..  
+0002e770: 2020 5265 7475 726e 730a 2020 2020 2d2d    Returns.    --
+0002e780: 2d2d 2d2d 2d0a 0a20 2020 2022 2222 0a0a  -----..    """..
+0002e790: 2020 2020 2320 4c6f 6164 2070 686f 746f      # Load photo
+0002e7a0: 6d65 7472 7920 6361 7461 6c6f 6720 2877  metry catalog (w
+0002e7b0: 6974 6820 6170 6572 7475 7265 2063 6f72  ith aperture cor
+0002e7c0: 7265 6374 696f 6e29 0a20 2020 2064 6574  rection).    det
+0002e7d0: 5f63 6174 203d 2066 6974 732e 6f70 656e  _cat = fits.open
+0002e7e0: 2864 6574 6563 7469 6f6e 5f66 696c 6529  (detection_file)
+0002e7f0: 0a20 2020 2064 6574 5f63 6174 203d 2064  .    det_cat = d
+0002e800: 6574 5f63 6174 5b31 5d2e 6461 7461 0a0a  et_cat[1].data..
+0002e810: 2020 2020 4e5f 736f 7572 6365 7320 3d20      N_sources = 
+0002e820: 6c65 6e28 6465 745f 6361 7429 0a0a 2020  len(det_cat)..  
+0002e830: 2020 2320 4372 6561 7465 206e 6577 2064    # Create new d
+0002e840: 6174 6120 5461 626c 650a 2020 2020 6361  ata Table.    ca
+0002e850: 7420 3d20 5b5d 0a0a 2020 2020 2320 4669  t = []..    # Fi
+0002e860: 6c6c 206e 6577 2064 6174 6120 5461 626c  ll new data Tabl
+0002e870: 6520 2323 2323 2323 2323 2323 2323 2323  e ##############
+0002e880: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0002e890: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0002e8a0: 2323 2323 2323 2323 0a0a 2020 2020 2320  ########..    # 
+0002e8b0: 4669 656c 6420 636f 6c75 6d6e 0a20 2020  Field column.   
+0002e8c0: 2063 6174 2e61 7070 656e 6428 6669 7473   cat.append(fits
+0002e8d0: 2e43 6f6c 756d 6e28 6e61 6d65 3d27 4669  .Column(name='Fi
+0002e8e0: 656c 6427 2c0a 2020 2020 2020 2020 2020  eld',.          
+0002e8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e900: 2066 6f72 6d61 743d 2725 6441 2720 2520   format='%dA' % 
+0002e910: 6c65 6e28 6669 656c 6429 2c0a 2020 2020  len(field),.    
+0002e920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e930: 2020 2020 2020 2061 7272 6179 3d4e 5f73         array=N_s
+0002e940: 6f75 7263 6573 202a 205b 6669 656c 645d  ources * [field]
+0002e950: 2929 0a0a 2020 2020 2320 4649 454c 4420  ))..    # FIELD 
+0002e960: 4944 0a20 2020 2064 6574 5f63 6174 2e63  ID.    det_cat.c
+0002e970: 6f6c 756d 6e73 5b66 2746 4945 4c44 5f49  olumns[f'FIELD_I
+0002e980: 4427 5d2e 6e61 6d65 203d 2066 2749 4427  D'].name = f'ID'
+0002e990: 0a20 2020 2063 6174 2e61 7070 656e 6428  .    cat.append(
+0002e9a0: 6465 745f 6361 742e 636f 6c75 6d6e 735b  det_cat.columns[
+0002e9b0: 6627 4944 275d 290a 2020 2020 6465 745f  f'ID']).    det_
+0002e9c0: 6361 742e 636f 6c75 6d6e 735b 6627 4649  cat.columns[f'FI
+0002e9d0: 454c 445f 4944 5f52 4127 5d2e 6e61 6d65  ELD_ID_RA'].name
+0002e9e0: 203d 2066 2749 445f 5241 270a 2020 2020   = f'ID_RA'.    
+0002e9f0: 6361 742e 6170 7065 6e64 2864 6574 5f63  cat.append(det_c
+0002ea00: 6174 2e63 6f6c 756d 6e73 5b66 2749 445f  at.columns[f'ID_
+0002ea10: 5241 275d 290a 2020 2020 6465 745f 6361  RA']).    det_ca
+0002ea20: 742e 636f 6c75 6d6e 735b 6627 4649 454c  t.columns[f'FIEL
+0002ea30: 445f 4944 5f44 4543 275d 2e6e 616d 6520  D_ID_DEC'].name 
+0002ea40: 3d20 6627 4944 5f44 4543 270a 2020 2020  = f'ID_DEC'.    
+0002ea50: 6361 742e 6170 7065 6e64 2864 6574 5f63  cat.append(det_c
+0002ea60: 6174 2e63 6f6c 756d 6e73 5b66 2749 445f  at.columns[f'ID_
+0002ea70: 4445 4327 5d29 0a0a 2020 2020 2320 4164  DEC'])..    # Ad
+0002ea80: 6420 5048 4f54 2049 4473 0a20 2020 2063  d PHOT IDs.    c
+0002ea90: 6174 2e61 7070 656e 6428 6465 745f 6361  at.append(det_ca
+0002eaa0: 742e 636f 6c75 6d6e 735b 6627 5048 4f54  t.columns[f'PHOT
+0002eab0: 5f49 445f 6475 616c 275d 290a 2020 2020  _ID_dual']).    
+0002eac0: 6361 742e 6170 7065 6e64 2864 6574 5f63  cat.append(det_c
+0002ead0: 6174 2e63 6f6c 756d 6e73 5b66 2750 484f  at.columns[f'PHO
+0002eae0: 545f 4944 5f52 415f 6475 616c 275d 290a  T_ID_RA_dual']).
+0002eaf0: 2020 2020 6361 742e 6170 7065 6e64 2864      cat.append(d
+0002eb00: 6574 5f63 6174 2e63 6f6c 756d 6e73 5b66  et_cat.columns[f
+0002eb10: 2750 484f 545f 4944 5f44 4543 5f64 7561  'PHOT_ID_DEC_dua
+0002eb20: 6c27 5d29 0a0a 2020 2020 6361 742e 6170  l'])..    cat.ap
+0002eb30: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
+0002eb40: 286e 616d 653d 6627 4445 545f 4944 5f64  (name=f'DET_ID_d
+0002eb50: 7561 6c27 2c0a 2020 2020 2020 2020 2020  ual',.          
+0002eb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eb70: 2066 6f72 6d61 743d 2735 3041 272c 0a20   format='50A',. 
+0002eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eb90: 2020 2020 2020 2020 2020 6172 7261 793d            array=
+0002eba0: 6465 745f 6361 742e 636f 6c75 6d6e 735b  det_cat.columns[
+0002ebb0: 6627 5048 4f54 5f49 445f 6475 616c 275d  f'PHOT_ID_dual']
+0002ebc0: 2e61 7272 6179 2929 0a0a 2020 2020 2320  .array))..    # 
+0002ebd0: 5241 2c44 4543 0a20 2020 2064 6574 5f63  RA,DEC.    det_c
+0002ebe0: 6174 2e63 6f6c 756d 6e73 5b27 414c 5048  at.columns['ALPH
+0002ebf0: 415f 4a32 3030 3027 5d2e 6e61 6d65 203d  A_J2000'].name =
+0002ec00: 2027 5241 270a 2020 2020 6361 742e 6170   'RA'.    cat.ap
+0002ec10: 7065 6e64 2864 6574 5f63 6174 2e63 6f6c  pend(det_cat.col
+0002ec20: 756d 6e73 5b27 5241 275d 290a 2020 2020  umns['RA']).    
+0002ec30: 6465 745f 6361 742e 636f 6c75 6d6e 735b  det_cat.columns[
+0002ec40: 2744 454c 5441 5f4a 3230 3030 275d 2e6e  'DELTA_J2000'].n
+0002ec50: 616d 6520 3d20 2744 4543 270a 2020 2020  ame = 'DEC'.    
+0002ec60: 6361 742e 6170 7065 6e64 2864 6574 5f63  cat.append(det_c
+0002ec70: 6174 2e63 6f6c 756d 6e73 5b27 4445 4327  at.columns['DEC'
+0002ec80: 5d29 0a0a 2020 2020 2320 5345 585f 4e55  ])..    # SEX_NU
+0002ec90: 4d42 4552 0a20 2020 2064 6574 5f63 6174  MBER.    det_cat
+0002eca0: 2e63 6f6c 756d 6e73 5b27 4e55 4d42 4552  .columns['NUMBER
+0002ecb0: 275d 2e6e 616d 6520 3d20 6627 5345 585f  '].name = f'SEX_
+0002ecc0: 4e55 4d42 4552 5f44 4554 270a 2020 2020  NUMBER_DET'.    
+0002ecd0: 6361 742e 6170 7065 6e64 2864 6574 5f63  cat.append(det_c
+0002ece0: 6174 2e63 6f6c 756d 6e73 5b66 2753 4558  at.columns[f'SEX
+0002ecf0: 5f4e 554d 4245 525f 4445 5427 5d29 0a0a  _NUMBER_DET'])..
+0002ed00: 2020 2020 2320 5345 585f 464c 4147 0a20      # SEX_FLAG. 
+0002ed10: 2020 2064 6574 5f63 6174 2e63 6f6c 756d     det_cat.colum
+0002ed20: 6e73 5b27 464c 4147 5327 5d2e 6e61 6d65  ns['FLAGS'].name
+0002ed30: 203d 2066 2753 4558 5f46 4c41 4753 5f44   = f'SEX_FLAGS_D
+0002ed40: 4554 270a 2020 2020 6361 742e 6170 7065  ET'.    cat.appe
+0002ed50: 6e64 2864 6574 5f63 6174 2e63 6f6c 756d  nd(det_cat.colum
+0002ed60: 6e73 5b66 2753 4558 5f46 4c41 4753 5f44  ns[f'SEX_FLAGS_D
+0002ed70: 4554 275d 290a 0a20 2020 2023 2043 414c  ET'])..    # CAL
+0002ed80: 4942 5f46 4c41 470a 2020 2020 2363 6174  IB_FLAG.    #cat
+0002ed90: 2e61 7070 656e 6428 6669 7473 2e43 6f6c  .append(fits.Col
+0002eda0: 756d 6e28 6e61 6d65 3d27 6361 6c69 625f  umn(name='calib_
+0002edb0: 666c 6167 272c 0a20 2020 2023 2020 2020  flag',.    #    
+0002edc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002edd0: 2020 2066 6f72 6d61 743d 2731 4a27 2c0a     format='1J',.
+0002ede0: 2020 2020 2320 2020 2020 2020 2020 2020      #           
+0002edf0: 2020 2020 2020 2020 2020 2020 6172 7261              arra
+0002ee00: 793d 4e5f 736f 7572 6365 7320 2a20 5b63  y=N_sources * [c
+0002ee10: 616c 6962 7261 7469 6f6e 5f66 6c61 675d  alibration_flag]
+0002ee20: 2929 0a0a 2020 2020 2320 4341 4c49 4220  ))..    # CALIB 
+0002ee30: 5354 5241 5445 4759 0a20 2020 2069 6620  STRATEGY.    if 
+0002ee40: 6361 6c69 6272 6174 696f 6e5f 6e61 6d65  calibration_name
+0002ee50: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0002ee60: 2020 2020 2020 4e5f 7374 7220 3d20 6c65        N_str = le
+0002ee70: 6e28 6361 6c69 6272 6174 696f 6e5f 6e61  n(calibration_na
+0002ee80: 6d65 290a 2020 2020 2020 2020 6361 742e  me).        cat.
+0002ee90: 6170 7065 6e64 2866 6974 732e 436f 6c75  append(fits.Colu
+0002eea0: 6d6e 286e 616d 653d 6622 6361 6c69 625f  mn(name=f"calib_
+0002eeb0: 7374 7261 7422 2c0a 2020 2020 2020 2020  strat",.        
+0002eec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eed0: 2020 2020 2020 2066 6f72 6d61 743d 6627         format=f'
+0002eee0: 7b4e 5f73 7472 7d41 272c 0a20 2020 2020  {N_str}A',.     
+0002eef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ef00: 2020 2020 2020 2020 2020 6172 7261 793d            array=
+0002ef10: 5b63 616c 6962 7261 7469 6f6e 5f6e 616d  [calibration_nam
+0002ef20: 655d 202a 204e 5f73 6f75 7263 6573 2929  e] * N_sources))
+0002ef30: 0a0a 2020 2020 2320 582c 2059 0a20 2020  ..    # X, Y.   
+0002ef40: 2064 6574 5f63 6174 2e63 6f6c 756d 6e73   det_cat.columns
+0002ef50: 5b27 585f 494d 4147 4527 5d2e 6e61 6d65  ['X_IMAGE'].name
+0002ef60: 203d 2027 5827 0a20 2020 2063 6174 2e61   = 'X'.    cat.a
+0002ef70: 7070 656e 6428 6465 745f 6361 742e 636f  ppend(det_cat.co
+0002ef80: 6c75 6d6e 735b 2758 275d 290a 0a20 2020  lumns['X'])..   
+0002ef90: 2064 6574 5f63 6174 2e63 6f6c 756d 6e73   det_cat.columns
+0002efa0: 5b27 595f 494d 4147 4527 5d2e 6e61 6d65  ['Y_IMAGE'].name
+0002efb0: 203d 2027 5927 0a20 2020 2063 6174 2e61   = 'Y'.    cat.a
+0002efc0: 7070 656e 6428 6465 745f 6361 742e 636f  ppend(det_cat.co
+0002efd0: 6c75 6d6e 735b 2759 275d 290a 0a20 2020  lumns['Y'])..   
+0002efe0: 2023 2041 2c20 422c 2054 4845 5441 0a20   # A, B, THETA. 
+0002eff0: 2020 2064 6574 5f63 6174 2e63 6f6c 756d     det_cat.colum
+0002f000: 6e73 5b27 415f 574f 524c 4427 5d2e 6e61  ns['A_WORLD'].na
+0002f010: 6d65 203d 2027 4127 0a20 2020 2063 6174  me = 'A'.    cat
+0002f020: 2e61 7070 656e 6428 6465 745f 6361 742e  .append(det_cat.
+0002f030: 636f 6c75 6d6e 735b 2741 275d 290a 0a20  columns['A']).. 
+0002f040: 2020 2064 6574 5f63 6174 2e63 6f6c 756d     det_cat.colum
+0002f050: 6e73 5b27 425f 574f 524c 4427 5d2e 6e61  ns['B_WORLD'].na
+0002f060: 6d65 203d 2027 4227 0a20 2020 2063 6174  me = 'B'.    cat
+0002f070: 2e61 7070 656e 6428 6465 745f 6361 742e  .append(det_cat.
+0002f080: 636f 6c75 6d6e 735b 2742 275d 290a 0a20  columns['B']).. 
+0002f090: 2020 2064 6574 5f63 6174 2e63 6f6c 756d     det_cat.colum
+0002f0a0: 6e73 5b27 5448 4554 415f 574f 524c 4427  ns['THETA_WORLD'
+0002f0b0: 5d2e 6e61 6d65 203d 2027 5448 4554 4127  ].name = 'THETA'
+0002f0c0: 0a20 2020 2063 6174 2e61 7070 656e 6428  .    cat.append(
+0002f0d0: 6465 745f 6361 742e 636f 6c75 6d6e 735b  det_cat.columns[
+0002f0e0: 2754 4845 5441 275d 290a 0a20 2020 2023  'THETA'])..    #
+0002f0f0: 2045 6c6f 6e67 6174 696f 6e2c 2045 6c6c   Elongation, Ell
+0002f100: 6970 7469 6369 7479 0a20 2020 2063 6174  ipticity.    cat
+0002f110: 2e61 7070 656e 6428 6465 745f 6361 742e  .append(det_cat.
+0002f120: 636f 6c75 6d6e 735b 2745 4c4f 4e47 4154  columns['ELONGAT
+0002f130: 494f 4e27 5d29 0a20 2020 2063 6174 2e61  ION']).    cat.a
+0002f140: 7070 656e 6428 6465 745f 6361 742e 636f  ppend(det_cat.co
+0002f150: 6c75 6d6e 735b 2745 4c4c 4950 5449 4349  lumns['ELLIPTICI
+0002f160: 5459 275d 290a 0a20 2020 2023 2049 534f  TY'])..    # ISO
+0002f170: 6172 6561 0a20 2020 2064 6574 5f63 6174  area.    det_cat
+0002f180: 2e63 6f6c 756d 6e73 5b27 4953 4f41 5245  .columns['ISOARE
+0002f190: 415f 574f 524c 4427 5d2e 6e61 6d65 203d  A_WORLD'].name =
+0002f1a0: 2027 4953 4f61 7265 6127 0a20 2020 2063   'ISOarea'.    c
+0002f1b0: 6174 2e61 7070 656e 6428 6465 745f 6361  at.append(det_ca
+0002f1c0: 742e 636f 6c75 6d6e 735b 2749 534f 6172  t.columns['ISOar
+0002f1d0: 6561 275d 290a 0a20 2020 2023 204b 524f  ea'])..    # KRO
+0002f1e0: 4e2f 5045 5452 4f53 4941 4e2f 464c 5558  N/PETROSIAN/FLUX
+0002f1f0: 2052 6164 6975 730a 2020 2020 6465 745f   Radius.    det_
+0002f200: 6361 742e 636f 6c75 6d6e 735b 274b 524f  cat.columns['KRO
+0002f210: 4e5f 5241 4449 5553 275d 2e6e 616d 6520  N_RADIUS'].name 
+0002f220: 3d20 274b 524f 4e5f 5241 4449 5553 270a  = 'KRON_RADIUS'.
+0002f230: 2020 2020 6361 742e 6170 7065 6e64 2864      cat.append(d
+0002f240: 6574 5f63 6174 2e63 6f6c 756d 6e73 5b27  et_cat.columns['
+0002f250: 4b52 4f4e 5f52 4144 4955 5327 5d29 0a0a  KRON_RADIUS'])..
+0002f260: 2020 2020 6465 745f 6361 742e 636f 6c75      det_cat.colu
+0002f270: 6d6e 735b 2750 4554 524f 5f52 4144 4955  mns['PETRO_RADIU
+0002f280: 5327 5d2e 6e61 6d65 203d 2027 5045 5452  S'].name = 'PETR
+0002f290: 4f5f 5241 4449 5553 270a 2020 2020 6361  O_RADIUS'.    ca
+0002f2a0: 742e 6170 7065 6e64 2864 6574 5f63 6174  t.append(det_cat
+0002f2b0: 2e63 6f6c 756d 6e73 5b27 5045 5452 4f5f  .columns['PETRO_
+0002f2c0: 5241 4449 5553 275d 290a 0a20 2020 2023  RADIUS'])..    #
+0002f2d0: 2041 6464 2046 4c55 585f 5241 4449 5553   Add FLUX_RADIUS
+0002f2e0: 0a20 2020 2066 6f72 206a 2c20 7220 696e  .    for j, r in
+0002f2f0: 207a 6970 2872 616e 6765 2834 292c 205b   zip(range(4), [
+0002f300: 3230 2c20 3530 2c20 3730 2c20 3930 5d29  20, 50, 70, 90])
+0002f310: 3a0a 2020 2020 2020 2020 6361 742e 6170  :.        cat.ap
+0002f320: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
+0002f330: 286e 616d 653d 6627 464c 5558 5f52 4144  (name=f'FLUX_RAD
+0002f340: 4955 535f 7b72 7d27 2c0a 2020 2020 2020  IUS_{r}',.      
+0002f350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f360: 2020 2020 2020 2020 2066 6f72 6d61 743d           format=
+0002f370: 2731 4527 2c0a 2020 2020 2020 2020 2020  '1E',.          
+0002f380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f390: 2020 2020 2061 7272 6179 3d64 6574 5f63       array=det_c
+0002f3a0: 6174 2e63 6f6c 756d 6e73 5b27 464c 5558  at.columns['FLUX
+0002f3b0: 5f52 4144 4955 5327 5d2e 6172 7261 795b  _RADIUS'].array[
+0002f3c0: 3a2c 206a 5d29 290a 0a20 2020 2023 2043  :, j]))..    # C
+0002f3d0: 4c41 5353 5f53 5441 520a 2020 2020 6465  LASS_STAR.    de
+0002f3e0: 745f 6361 742e 636f 6c75 6d6e 735b 2743  t_cat.columns['C
+0002f3f0: 4c41 5353 5f53 5441 5227 5d2e 6e61 6d65  LASS_STAR'].name
+0002f400: 203d 2027 434c 4153 535f 5354 4152 270a   = 'CLASS_STAR'.
+0002f410: 2020 2020 6361 742e 6170 7065 6e64 2864      cat.append(d
+0002f420: 6574 5f63 6174 2e63 6f6c 756d 6e73 5b27  et_cat.columns['
+0002f430: 434c 4153 535f 5354 4152 275d 290a 0a20  CLASS_STAR']).. 
+0002f440: 2020 2023 2046 5748 4d0a 2020 2020 6465     # FWHM.    de
+0002f450: 745f 6361 742e 636f 6c75 6d6e 735b 2746  t_cat.columns['F
+0002f460: 5748 4d5f 574f 524c 4427 5d2e 6e61 6d65  WHM_WORLD'].name
+0002f470: 203d 2027 4657 484d 270a 2020 2020 6361   = 'FWHM'.    ca
+0002f480: 742e 6170 7065 6e64 2864 6574 5f63 6174  t.append(det_cat
+0002f490: 2e63 6f6c 756d 6e73 5b27 4657 484d 275d  .columns['FWHM']
+0002f4a0: 290a 0a20 2020 2023 2323 204e 6f72 6d61  )..    ### Norma
+0002f4b0: 6c69 7a65 6420 4657 484d 0a20 2020 2063  lized FWHM.    c
+0002f4c0: 6f6c 5f73 326e 5f44 6574 5f61 7574 6f20  ol_s2n_Det_auto 
+0002f4d0: 3d20 6465 745f 6361 745b 2746 4c55 585f  = det_cat['FLUX_
+0002f4e0: 4155 544f 275d 202f 2064 6574 5f63 6174  AUTO'] / det_cat
+0002f4f0: 5b27 464c 5558 4552 525f 4155 544f 275d  ['FLUXERR_AUTO']
+0002f500: 0a20 2020 2063 6f6c 5f73 326e 5f44 6574  .    col_s2n_Det
+0002f510: 5f61 7574 6f20 3d20 6e70 2e77 6865 7265  _auto = np.where
+0002f520: 2863 6f6c 5f73 326e 5f44 6574 5f61 7574  (col_s2n_Det_aut
+0002f530: 6f20 3e20 302e 2c20 636f 6c5f 7332 6e5f  o > 0., col_s2n_
+0002f540: 4465 745f 6175 746f 2c20 2d31 2e30 3029  Det_auto, -1.00)
+0002f550: 0a0a 2020 2020 7365 6c65 6374 696f 6e20  ..    selection 
+0002f560: 3d20 2863 6f6c 5f73 326e 5f44 6574 5f61  = (col_s2n_Det_a
+0002f570: 7574 6f20 3e3d 2031 3030 2920 2620 2863  uto >= 100) & (c
+0002f580: 6f6c 5f73 326e 5f44 6574 5f61 7574 6f20  ol_s2n_Det_auto 
+0002f590: 3c3d 2031 3030 3029 2026 2028 6465 745f  <= 1000) & (det_
+0002f5a0: 6361 745b 2743 4c41 5353 5f53 5441 5227  cat['CLASS_STAR'
+0002f5b0: 5d20 3e20 302e 3929 0a20 2020 206d 6561  ] > 0.9).    mea
+0002f5c0: 6e5f 4657 484d 203d 206d 6561 6e5f 726f  n_FWHM = mean_ro
+0002f5d0: 6275 7374 2864 6574 5f63 6174 5b27 4657  bust(det_cat['FW
+0002f5e0: 484d 275d 5b73 656c 6563 7469 6f6e 5d29  HM'][selection])
+0002f5f0: 0a0a 2020 2020 636f 6c5f 4657 484d 5f6e  ..    col_FWHM_n
+0002f600: 203d 2064 6574 5f63 6174 5b27 4657 484d   = det_cat['FWHM
+0002f610: 275d 202f 206d 6561 6e5f 4657 484d 0a0a  '] / mean_FWHM..
+0002f620: 2020 2020 6361 742e 6170 7065 6e64 2866      cat.append(f
+0002f630: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
+0002f640: 2746 5748 4d5f 6e27 2c0a 2020 2020 2020  'FWHM_n',.      
+0002f650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f660: 2020 2020 2066 6f72 6d61 743d 2731 4527       format='1E'
+0002f670: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002f680: 2020 2020 2020 2020 2020 2020 2061 7272               arr
+0002f690: 6179 3d63 6f6c 5f46 5748 4d5f 6e29 290a  ay=col_FWHM_n)).
+0002f6a0: 0a20 2020 2023 204d 555f 4d41 582c 204d  .    # MU_MAX, M
+0002f6b0: 555f 5448 5245 5348 4f4c 442c 2042 4143  U_THRESHOLD, BAC
+0002f6c0: 4b47 524f 554e 442c 2054 4852 4553 484f  KGROUND, THRESHO
+0002f6d0: 4c44 0a20 2020 204d 555f 4d41 5820 3d20  LD.    MU_MAX = 
+0002f6e0: 6465 745f 6361 742e 636f 6c75 6d6e 735b  det_cat.columns[
+0002f6f0: 274d 555f 4d41 5827 5d2e 6172 7261 790a  'MU_MAX'].array.
+0002f700: 2020 2020 6361 742e 6170 7065 6e64 2866      cat.append(f
+0002f710: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
+0002f720: 6627 4d55 5f4d 4158 5f49 4e53 5427 2c0a  f'MU_MAX_INST',.
+0002f730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f740: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+0002f750: 743d 2731 4527 2c0a 2020 2020 2020 2020  t='1E',.        
+0002f760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f770: 2020 2061 7272 6179 3d4d 555f 4d41 5829     array=MU_MAX)
+0002f780: 290a 0a20 2020 204d 555f 4d41 5820 3d20  )..    MU_MAX = 
+0002f790: 6465 745f 6361 742e 636f 6c75 6d6e 735b  det_cat.columns[
+0002f7a0: 274d 555f 5448 5245 5348 4f4c 4427 5d2e  'MU_THRESHOLD'].
+0002f7b0: 6172 7261 790a 2020 2020 6361 742e 6170  array.    cat.ap
+0002f7c0: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
+0002f7d0: 286e 616d 653d 6627 4d55 5f54 4852 4553  (name=f'MU_THRES
+0002f7e0: 484f 4c44 5f49 4e53 5427 2c0a 2020 2020  HOLD_INST',.    
+0002f7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f800: 2020 2020 2020 2066 6f72 6d61 743d 2731         format='1
+0002f810: 4527 2c0a 2020 2020 2020 2020 2020 2020  E',.            
+0002f820: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0002f830: 7272 6179 3d4d 555f 4d41 5829 290a 0a20  rray=MU_MAX)).. 
+0002f840: 2020 2063 6174 2e61 7070 656e 6428 6465     cat.append(de
+0002f850: 745f 6361 742e 636f 6c75 6d6e 735b 2742  t_cat.columns['B
+0002f860: 4143 4b47 524f 554e 4427 5d29 0a20 2020  ACKGROUND']).   
+0002f870: 2063 6174 2e61 7070 656e 6428 6465 745f   cat.append(det_
+0002f880: 6361 742e 636f 6c75 6d6e 735b 2754 4852  cat.columns['THR
+0002f890: 4553 484f 4c44 275d 290a 0a20 2020 2023  ESHOLD'])..    #
+0002f8a0: 2323 2053 324e 5f41 5554 4f0a 2020 2020  ## S2N_AUTO.    
+0002f8b0: 636f 6c5f 7332 6e5f 4465 745f 6175 746f  col_s2n_Det_auto
+0002f8c0: 203d 2064 6574 5f63 6174 5b27 464c 5558   = det_cat['FLUX
+0002f8d0: 5f41 5554 4f27 5d20 2f20 6465 745f 6361  _AUTO'] / det_ca
+0002f8e0: 745b 2746 4c55 5845 5252 5f41 5554 4f27  t['FLUXERR_AUTO'
+0002f8f0: 5d0a 2020 2020 636f 6c5f 7332 6e5f 4465  ].    col_s2n_De
+0002f900: 745f 6175 746f 203d 206e 702e 7768 6572  t_auto = np.wher
+0002f910: 6528 636f 6c5f 7332 6e5f 4465 745f 6175  e(col_s2n_Det_au
+0002f920: 746f 203e 2030 2e2c 2063 6f6c 5f73 326e  to > 0., col_s2n
+0002f930: 5f44 6574 5f61 7574 6f2c 202d 312e 3030  _Det_auto, -1.00
+0002f940: 290a 0a20 2020 2063 6174 2e61 7070 656e  )..    cat.appen
+0002f950: 6428 6669 7473 2e43 6f6c 756d 6e28 6e61  d(fits.Column(na
+0002f960: 6d65 3d27 7332 6e5f 4445 545f 6175 746f  me='s2n_DET_auto
+0002f970: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0002f980: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0002f990: 726d 6174 3d27 3145 272c 0a20 2020 2020  rmat='1E',.     
+0002f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f9b0: 2020 2020 2020 6172 7261 793d 636f 6c5f        array=col_
+0002f9c0: 7332 6e5f 4465 745f 6175 746f 2929 0a0a  s2n_Det_auto))..
+0002f9d0: 2020 2020 2323 2320 5332 4e5f 5045 5452      ### S2N_PETR
+0002f9e0: 4f0a 2020 2020 636f 6c5f 7332 6e5f 4465  O.    col_s2n_De
+0002f9f0: 745f 7065 7472 6f20 3d20 6465 745f 6361  t_petro = det_ca
+0002fa00: 745b 2746 4c55 585f 5045 5452 4f27 5d20  t['FLUX_PETRO'] 
+0002fa10: 2f20 6465 745f 6361 745b 2746 4c55 5845  / det_cat['FLUXE
+0002fa20: 5252 5f50 4554 524f 275d 0a20 2020 2063  RR_PETRO'].    c
+0002fa30: 6f6c 5f73 326e 5f44 6574 5f70 6574 726f  ol_s2n_Det_petro
+0002fa40: 203d 206e 702e 7768 6572 6528 636f 6c5f   = np.where(col_
+0002fa50: 7332 6e5f 4465 745f 7065 7472 6f20 3e20  s2n_Det_petro > 
+0002fa60: 302e 2c20 636f 6c5f 7332 6e5f 4465 745f  0., col_s2n_Det_
+0002fa70: 7065 7472 6f2c 202d 312e 3030 290a 0a20  petro, -1.00).. 
+0002fa80: 2020 2063 6174 2e61 7070 656e 6428 6669     cat.append(fi
+0002fa90: 7473 2e43 6f6c 756d 6e28 6e61 6d65 3d27  ts.Column(name='
+0002faa0: 7332 6e5f 4445 545f 7065 7472 6f27 2c0a  s2n_DET_petro',.
+0002fab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fac0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+0002fad0: 743d 2731 4527 2c0a 2020 2020 2020 2020  t='1E',.        
+0002fae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002faf0: 2020 2061 7272 6179 3d63 6f6c 5f73 326e     array=col_s2n
+0002fb00: 5f44 6574 5f70 6574 726f 2929 0a0a 2020  _Det_petro))..  
+0002fb10: 2020 2323 2320 5332 4e5f 4953 4f0a 2020    ### S2N_ISO.  
+0002fb20: 2020 636f 6c5f 7332 6e5f 4465 745f 6973    col_s2n_Det_is
+0002fb30: 6f20 3d20 6465 745f 6361 745b 2746 4c55  o = det_cat['FLU
+0002fb40: 585f 4953 4f27 5d20 2f20 6465 745f 6361  X_ISO'] / det_ca
+0002fb50: 745b 2746 4c55 5845 5252 5f49 534f 275d  t['FLUXERR_ISO']
+0002fb60: 0a20 2020 2063 6f6c 5f73 326e 5f44 6574  .    col_s2n_Det
+0002fb70: 5f69 736f 203d 206e 702e 7768 6572 6528  _iso = np.where(
+0002fb80: 636f 6c5f 7332 6e5f 4465 745f 6973 6f20  col_s2n_Det_iso 
+0002fb90: 3e20 302e 2c20 636f 6c5f 7332 6e5f 4465  > 0., col_s2n_De
+0002fba0: 745f 6973 6f2c 202d 312e 3030 290a 0a20  t_iso, -1.00).. 
+0002fbb0: 2020 2063 6174 2e61 7070 656e 6428 6669     cat.append(fi
+0002fbc0: 7473 2e43 6f6c 756d 6e28 6e61 6d65 3d27  ts.Column(name='
+0002fbd0: 7332 6e5f 4445 545f 6973 6f27 2c0a 2020  s2n_DET_iso',.  
+0002fbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fbf0: 2020 2020 2020 2020 2066 6f72 6d61 743d           format=
+0002fc00: 2731 4527 2c0a 2020 2020 2020 2020 2020  '1E',.          
+0002fc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fc20: 2061 7272 6179 3d63 6f6c 5f73 326e 5f44   array=col_s2n_D
+0002fc30: 6574 5f69 736f 2929 0a0a 2020 2020 2323  et_iso))..    ##
+0002fc40: 2320 4649 5845 4420 4150 4552 5455 5245  # FIXED APERTURE
+0002fc50: 530a 2020 2020 636f 6c5f 7332 6e5f 6170  S.    col_s2n_ap
+0002fc60: 6572 5f33 203d 2064 6574 5f63 6174 2e63  er_3 = det_cat.c
+0002fc70: 6f6c 756d 6e73 5b27 464c 5558 5f41 5045  olumns['FLUX_APE
+0002fc80: 5227 5d2e 6172 7261 795b 3a2c 2032 5d20  R'].array[:, 2] 
+0002fc90: 2f20 6465 745f 6361 742e 636f 6c75 6d6e  / det_cat.column
+0002fca0: 735b 2746 4c55 5845 5252 5f41 5045 5227  s['FLUXERR_APER'
+0002fcb0: 5d2e 6172 7261 795b 3a2c 2032 5d0a 2020  ].array[:, 2].  
+0002fcc0: 2020 636f 6c5f 7332 6e5f 6170 6572 5f33    col_s2n_aper_3
+0002fcd0: 203d 206e 702e 7768 6572 6528 636f 6c5f   = np.where(col_
+0002fce0: 7332 6e5f 6170 6572 5f33 203e 2030 2e2c  s2n_aper_3 > 0.,
+0002fcf0: 2063 6f6c 5f73 326e 5f61 7065 725f 332c   col_s2n_aper_3,
+0002fd00: 202d 312e 3030 290a 0a20 2020 2063 6174   -1.00)..    cat
+0002fd10: 2e61 7070 656e 6428 6669 7473 2e43 6f6c  .append(fits.Col
+0002fd20: 756d 6e28 6e61 6d65 3d27 7332 6e5f 4445  umn(name='s2n_DE
+0002fd30: 545f 6170 6572 5f33 272c 0a20 2020 2020  T_aper_3',.     
+0002fd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fd50: 2020 2020 2020 666f 726d 6174 3d27 3145        format='1E
+0002fd60: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+0002fd70: 2020 2020 2020 2020 2020 2020 2020 6172                ar
+0002fd80: 7261 793d 636f 6c5f 7332 6e5f 6170 6572  ray=col_s2n_aper
+0002fd90: 5f33 2929 0a0a 2020 2020 636f 6c5f 7332  _3))..    col_s2
+0002fda0: 6e5f 6170 6572 5f36 203d 2064 6574 5f63  n_aper_6 = det_c
+0002fdb0: 6174 2e63 6f6c 756d 6e73 5b27 464c 5558  at.columns['FLUX
+0002fdc0: 5f41 5045 5227 5d2e 6172 7261 795b 3a2c  _APER'].array[:,
+0002fdd0: 2034 5d20 2f20 6465 745f 6361 742e 636f   4] / det_cat.co
+0002fde0: 6c75 6d6e 735b 2746 4c55 5845 5252 5f41  lumns['FLUXERR_A
+0002fdf0: 5045 5227 5d2e 6172 7261 795b 3a2c 2034  PER'].array[:, 4
+0002fe00: 5d0a 2020 2020 636f 6c5f 7332 6e5f 6170  ].    col_s2n_ap
+0002fe10: 6572 5f36 203d 206e 702e 7768 6572 6528  er_6 = np.where(
+0002fe20: 636f 6c5f 7332 6e5f 6170 6572 5f36 203e  col_s2n_aper_6 >
+0002fe30: 2030 2e2c 2063 6f6c 5f73 326e 5f61 7065   0., col_s2n_ape
+0002fe40: 725f 362c 202d 312e 3030 290a 0a20 2020  r_6, -1.00)..   
+0002fe50: 2063 6174 2e61 7070 656e 6428 6669 7473   cat.append(fits
+0002fe60: 2e43 6f6c 756d 6e28 6e61 6d65 3d27 7332  .Column(name='s2
+0002fe70: 6e5f 4445 545f 6170 6572 5f36 272c 0a20  n_DET_aper_6',. 
+0002fe80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe90: 2020 2020 2020 2020 2020 666f 726d 6174            format
+0002fea0: 3d27 3145 272c 0a20 2020 2020 2020 2020  ='1E',.         
+0002feb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fec0: 2020 6172 7261 793d 636f 6c5f 7332 6e5f    array=col_s2n_
+0002fed0: 6170 6572 5f36 2929 0a0a 2020 2020 6361  aper_6))..    ca
+0002fee0: 742e 6170 7065 6e64 2866 6974 732e 436f  t.append(fits.Co
+0002fef0: 6c75 6d6e 286e 616d 653d 2773 326e 5f44  lumn(name='s2n_D
+0002ff00: 4554 5f50 5374 6f74 616c 272c 0a20 2020  ET_PStotal',.   
+0002ff10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff20: 2020 2020 2020 2020 666f 726d 6174 3d27          format='
+0002ff30: 3145 272c 0a20 2020 2020 2020 2020 2020  1E',.           
+0002ff40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff50: 6172 7261 793d 636f 6c5f 7332 6e5f 6170  array=col_s2n_ap
+0002ff60: 6572 5f33 2929 0a0a 2020 2020 6966 2065  er_3))..    if e
+0002ff70: 7874 696e 6374 696f 6e5f 6d61 7073 5f70  xtinction_maps_p
+0002ff80: 6174 6820 6973 206e 6f74 204e 6f6e 653a  ath is not None:
+0002ff90: 0a20 2020 2020 2020 2069 6620 6578 7469  .        if exti
+0002ffa0: 6e63 7469 6f6e 5f63 6f72 7265 6374 696f  nction_correctio
+0002ffb0: 6e2e 6c6f 7765 7228 2920 3d3d 2027 7363  n.lower() == 'sc
+0002ffc0: 686c 6567 656c 273a 0a0a 2020 2020 2020  hlegel':..      
+0002ffd0: 2020 2020 2020 5241 203d 2064 6574 5f63        RA = det_c
+0002ffe0: 6174 2e63 6f6c 756d 6e73 5b66 2752 4127  at.columns[f'RA'
+0002fff0: 5d2e 6172 7261 790a 2020 2020 2020 2020  ].array.        
+00030000: 2020 2020 4445 4320 3d20 6465 745f 6361      DEC = det_ca
+00030010: 742e 636f 6c75 6d6e 735b 6627 4445 4327  t.columns[f'DEC'
+00030020: 5d2e 6172 7261 790a 0a20 2020 2020 2020  ].array..       
+00030030: 2020 2020 2045 4256 203d 2067 6574 5f45       EBV = get_E
+00030040: 4256 5f73 6368 6c65 6765 6c28 5241 2020  BV_schlegel(RA  
+00030050: 3d20 5241 2c0a 2020 2020 2020 2020 2020  = RA,.          
+00030060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030070: 2020 2020 2020 2020 2044 4543 203d 2044           DEC = D
+00030080: 4543 2c0a 2020 2020 2020 2020 2020 2020  EC,.            
+00030090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000300a0: 2020 2020 2020 2065 6276 5f6d 6170 735f         ebv_maps_
+000300b0: 7061 7468 203d 2065 7874 696e 6374 696f  path = extinctio
+000300c0: 6e5f 6d61 7073 5f70 6174 6829 0a0a 2020  n_maps_path)..  
+000300d0: 2020 2020 2020 2020 2020 6361 742e 6170            cat.ap
+000300e0: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
+000300f0: 286e 616d 653d 6627 4542 565f 5343 4827  (name=f'EBV_SCH'
+00030100: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00030110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030120: 2020 2020 2066 6f72 6d61 743d 2731 4527       format='1E'
+00030130: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00030140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030160: 2066 6f72 6d61 743d 2731 4527 2c0a 2020   format='1E',.  
-00030170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030190: 2061 7272 6179 3d45 4256 2929 0a0a 2020   array=EBV))..  
-000301a0: 2020 2320 4765 6e65 7261 7465 2048 4455    # Generate HDU
-000301b0: 2066 726f 6d20 636f 6c75 6d6e 730a 2020   from columns.  
-000301c0: 2020 6864 7520 3d20 6669 7473 2e42 696e    hdu = fits.Bin
-000301d0: 5461 626c 6548 4455 2e66 726f 6d5f 636f  TableHDU.from_co
-000301e0: 6c75 6d6e 7328 6361 7429 0a0a 2020 2020  lumns(cat)..    
-000301f0: 2320 5361 7665 2048 4455 0a20 2020 2068  # Save HDU.    h
-00030200: 6475 2e77 7269 7465 746f 2873 6176 655f  du.writeto(save_
-00030210: 6669 6c65 290a 0a0a 0a64 6566 2070 7366  file)....def psf
-00030220: 6361 7461 6c6f 675f 6170 706c 795f 6361  catalog_apply_ca
-00030230: 6c69 6272 6174 696f 6e28 6361 7461 6c6f  libration(catalo
-00030240: 675f 6669 6c65 2c20 7a70 5f66 696c 652c  g_file, zp_file,
-00030250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030270: 2020 7361 7665 5f66 696c 652c 2066 696c    save_file, fil
-00030280: 7465 725f 6e61 6d65 2c20 6669 656c 642c  ter_name, field,
-00030290: 2069 6e73 745f 6d61 675f 7a70 2c0a 2020   inst_mag_zp,.  
-000302a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000302b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000302c0: 616c 6962 7261 7469 6f6e 5f66 6c61 672c  alibration_flag,
-000302d0: 2065 7874 696e 6374 696f 6e5f 6d61 7073   extinction_maps
-000302e0: 5f70 6174 683d 4e6f 6e65 2c0a 2020 2020  _path=None,.    
+00030150: 2020 2020 2061 7272 6179 3d45 4256 2929       array=EBV))
+00030160: 0a0a 2020 2020 2320 4765 6e65 7261 7465  ..    # Generate
+00030170: 2048 4455 2066 726f 6d20 636f 6c75 6d6e   HDU from column
+00030180: 730a 2020 2020 6864 7520 3d20 6669 7473  s.    hdu = fits
+00030190: 2e42 696e 5461 626c 6548 4455 2e66 726f  .BinTableHDU.fro
+000301a0: 6d5f 636f 6c75 6d6e 7328 6361 7429 0a0a  m_columns(cat)..
+000301b0: 2020 2020 2320 5361 7665 2048 4455 0a20      # Save HDU. 
+000301c0: 2020 2068 6475 2e77 7269 7465 746f 2873     hdu.writeto(s
+000301d0: 6176 655f 6669 6c65 290a 0a0a 0a64 6566  ave_file)....def
+000301e0: 2070 7366 6361 7461 6c6f 675f 6170 706c   psfcatalog_appl
+000301f0: 795f 6361 6c69 6272 6174 696f 6e28 6361  y_calibration(ca
+00030200: 7461 6c6f 675f 6669 6c65 2c20 7a70 5f66  talog_file, zp_f
+00030210: 696c 652c 0a20 2020 2020 2020 2020 2020  ile,.           
+00030220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030230: 2020 2020 2020 7361 7665 5f66 696c 652c        save_file,
+00030240: 2066 696c 7465 725f 6e61 6d65 2c20 6669   filter_name, fi
+00030250: 656c 642c 2069 6e73 745f 6d61 675f 7a70  eld, inst_mag_zp
+00030260: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00030270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030280: 2020 2063 616c 6962 7261 7469 6f6e 5f66     calibration_f
+00030290: 6c61 672c 2065 7874 696e 6374 696f 6e5f  lag, extinction_
+000302a0: 6d61 7073 5f70 6174 683d 4e6f 6e65 2c0a  maps_path=None,.
+000302b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000302c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000302d0: 2065 7874 696e 6374 696f 6e5f 636f 7272   extinction_corr
+000302e0: 6563 7469 6f6e 3d4e 6f6e 652c 0a20 2020  ection=None,.   
 000302f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030300: 2020 2020 2020 2020 2020 2020 2065 7874               ext
-00030310: 696e 6374 696f 6e5f 636f 7272 6563 7469  inction_correcti
-00030320: 6f6e 3d4e 6f6e 652c 0a20 2020 2020 2020  on=None,.       
-00030330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030340: 2020 2020 2020 2020 2020 6361 6c69 6272            calibr
-00030350: 6174 696f 6e5f 6e61 6d65 3d4e 6f6e 6529  ation_name=None)
-00030360: 3a0a 2020 2020 2222 220a 0a20 2020 2050  :.    """..    P
-00030370: 6172 616d 6574 6572 730a 2020 2020 2d2d  arameters.    --
-00030380: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2063 6174  --------.    cat
-00030390: 616c 6f67 5f66 696c 650a 2020 2020 7a70  alog_file.    zp
-000303a0: 5f66 696c 650a 2020 2020 7361 7665 5f66  _file.    save_f
-000303b0: 696c 650a 2020 2020 6669 6c74 6572 5f6e  ile.    filter_n
-000303c0: 616d 650a 2020 2020 6170 6572 7475 7265  ame.    aperture
-000303d0: 730a 2020 2020 6f74 6865 725f 636f 6c75  s.    other_colu
-000303e0: 6d6e 730a 0a20 2020 2052 6574 7572 6e73  mns..    Returns
-000303f0: 0a20 2020 202d 2d2d 2d2d 2d2d 0a0a 2020  .    -------..  
-00030400: 2020 2222 220a 0a20 2020 2023 204c 6f61    """..    # Loa
-00030410: 6420 6669 6c74 6572 2063 6174 616c 6f67  d filter catalog
-00030420: 7565 0a20 2020 2063 6174 5f64 6174 6120  ue.    cat_data 
-00030430: 3d20 7064 2e72 6561 645f 6373 7628 6361  = pd.read_csv(ca
-00030440: 7461 6c6f 675f 6669 6c65 290a 0a20 2020  talog_file)..   
-00030450: 204e 5f73 6f75 7263 6573 203d 206c 656e   N_sources = len
-00030460: 2863 6174 5f64 6174 6129 0a0a 2020 2020  (cat_data)..    
-00030470: 2320 4c6f 6164 205a 500a 2020 2020 5a50  # Load ZP.    ZP
-00030480: 7320 3d20 7a70 5f72 6561 6428 7a70 5f66  s = zp_read(zp_f
-00030490: 696c 6529 0a20 2020 205a 5020 3d20 5a50  ile).    ZP = ZP
-000304a0: 735b 6627 5350 4c55 535f 7b66 696c 7465  s[f'SPLUS_{filte
-000304b0: 725f 6e61 6d65 7d27 5d0a 0a20 2020 2023  r_name}']..    #
-000304c0: 2053 7461 6e64 6172 6420 6669 6c74 6572   Standard filter
-000304d0: 206e 616d 650a 2020 2020 6669 6c74 5f73   name.    filt_s
-000304e0: 7461 6e64 6172 6420 3d20 7472 616e 736c  tandard = transl
-000304f0: 6174 655f 6669 6c74 6572 5f73 7461 6e64  ate_filter_stand
-00030500: 6172 6428 6669 6c74 6572 5f6e 616d 6529  ard(filter_name)
-00030510: 0a0a 2020 2020 2320 4372 6561 7465 206e  ..    # Create n
-00030520: 6577 2064 6174 6120 5461 626c 650a 2020  ew data Table.  
-00030530: 2020 6361 7420 3d20 5b5d 0a0a 2020 2020    cat = []..    
-00030540: 2320 4669 6c6c 206e 6577 2064 6174 6120  # Fill new data 
-00030550: 5461 626c 6520 2323 2323 2323 2323 2323  Table ##########
-00030560: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00030570: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00030580: 2323 2323 2323 2323 2323 2323 0a0a 2020  ############..  
-00030590: 2020 2320 4669 656c 6420 636f 6c75 6d6e    # Field column
-000305a0: 0a20 2020 2063 6174 2e61 7070 656e 6428  .    cat.append(
-000305b0: 6669 7473 2e43 6f6c 756d 6e28 6e61 6d65  fits.Column(name
-000305c0: 3d27 4669 656c 6427 2c0a 2020 2020 2020  ='Field',.      
-000305d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000305e0: 2020 2020 2066 6f72 6d61 743d 2725 6441       format='%dA
-000305f0: 2720 2520 6c65 6e28 6669 656c 6429 2c0a  ' % len(field),.
-00030600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030610: 2020 2020 2020 2020 2020 2061 7272 6179             array
-00030620: 3d4e 5f73 6f75 7263 6573 202a 205b 6669  =N_sources * [fi
-00030630: 656c 645d 2929 0a0a 2020 2020 2320 4669  eld]))..    # Fi
-00030640: 656c 6420 4944 0a20 2020 2074 7279 3a0a  eld ID.    try:.
-00030650: 2020 2020 2020 2020 4e5f 7374 7220 3d20          N_str = 
-00030660: 6c65 6e28 6361 745f 6461 7461 2e6c 6f63  len(cat_data.loc
-00030670: 5b3a 2c20 6627 4649 454c 445f 4944 275d  [:, f'FIELD_ID']
-00030680: 2e76 616c 7565 735b 305d 290a 2020 2020  .values[0]).    
-00030690: 6578 6365 7074 2054 7970 6545 7272 6f72  except TypeError
-000306a0: 3a0a 2020 2020 2020 2020 4e5f 7374 7220  :.        N_str 
-000306b0: 3d20 3530 0a0a 2020 2020 6361 742e 6170  = 50..    cat.ap
-000306c0: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
-000306d0: 286e 616d 653d 6627 4944 272c 0a20 2020  (name=f'ID',.   
-000306e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000306f0: 2020 2020 2020 2020 666f 726d 6174 3d66          format=f
-00030700: 277b 4e5f 7374 723a 647d 4127 2c0a 2020  '{N_str:d}A',.  
-00030710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030720: 2020 2020 2020 2020 2061 7272 6179 3d63           array=c
-00030730: 6174 5f64 6174 612e 6c6f 635b 3a2c 2066  at_data.loc[:, f
-00030740: 2746 4945 4c44 5f49 4427 5d2e 7661 6c75  'FIELD_ID'].valu
-00030750: 6573 2929 0a0a 2020 2020 6361 742e 6170  es))..    cat.ap
-00030760: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
-00030770: 286e 616d 653d 6627 4944 5f52 4127 2c0a  (name=f'ID_RA',.
-00030780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030790: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
-000307a0: 743d 6627 3145 272c 0a20 2020 2020 2020  t=f'1E',.       
-000307b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000307c0: 2020 2020 6172 7261 793d 6361 745f 6461      array=cat_da
-000307d0: 7461 2e6c 6f63 5b3a 2c20 6627 4649 454c  ta.loc[:, f'FIEL
-000307e0: 445f 4944 5f52 4127 5d2e 7661 6c75 6573  D_ID_RA'].values
-000307f0: 2929 0a0a 2020 2020 6361 742e 6170 7065  ))..    cat.appe
-00030800: 6e64 2866 6974 732e 436f 6c75 6d6e 286e  nd(fits.Column(n
-00030810: 616d 653d 6627 4944 5f44 4543 272c 0a20  ame=f'ID_DEC',. 
-00030820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030830: 2020 2020 2020 2020 2020 666f 726d 6174            format
-00030840: 3d66 2731 4527 2c0a 2020 2020 2020 2020  =f'1E',.        
-00030850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030860: 2020 2061 7272 6179 3d63 6174 5f64 6174     array=cat_dat
-00030870: 612e 6c6f 635b 3a2c 2066 2746 4945 4c44  a.loc[:, f'FIELD
-00030880: 5f49 445f 4445 4327 5d2e 7661 6c75 6573  _ID_DEC'].values
-00030890: 2929 0a0a 2020 2020 2320 4164 6420 5048  ))..    # Add PH
-000308a0: 4f54 2049 4473 0a20 2020 204e 5f73 7472  OT IDs.    N_str
-000308b0: 203d 206c 656e 2863 6174 5f64 6174 612e   = len(cat_data.
-000308c0: 6c6f 635b 3a2c 2066 2750 484f 545f 4944  loc[:, f'PHOT_ID
-000308d0: 5f70 7366 275d 2e76 616c 7565 735b 305d  _psf'].values[0]
-000308e0: 290a 0a20 2020 2063 6174 2e61 7070 656e  )..    cat.appen
-000308f0: 6428 6669 7473 2e43 6f6c 756d 6e28 6e61  d(fits.Column(na
-00030900: 6d65 3d66 2750 484f 545f 4944 5f70 7366  me=f'PHOT_ID_psf
-00030910: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00030920: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00030930: 726d 6174 3d66 277b 4e5f 7374 723a 647d  rmat=f'{N_str:d}
-00030940: 4127 2c0a 2020 2020 2020 2020 2020 2020  A',.            
-00030950: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00030960: 7272 6179 3d63 6174 5f64 6174 612e 6c6f  rray=cat_data.lo
-00030970: 635b 3a2c 2066 2750 484f 545f 4944 5f70  c[:, f'PHOT_ID_p
-00030980: 7366 275d 2e76 616c 7565 7329 290a 0a20  sf'].values)).. 
-00030990: 2020 2063 6174 2e61 7070 656e 6428 6669     cat.append(fi
-000309a0: 7473 2e43 6f6c 756d 6e28 6e61 6d65 3d66  ts.Column(name=f
-000309b0: 2750 484f 545f 4944 5f52 415f 7073 6627  'PHOT_ID_RA_psf'
-000309c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000309d0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000309e0: 6d61 743d 6627 3145 272c 0a20 2020 2020  mat=f'1E',.     
-000309f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030a00: 2020 2020 2020 6172 7261 793d 6361 745f        array=cat_
-00030a10: 6461 7461 2e6c 6f63 5b3a 2c20 6627 5048  data.loc[:, f'PH
-00030a20: 4f54 5f49 445f 5241 5f70 7366 275d 2e76  OT_ID_RA_psf'].v
-00030a30: 616c 7565 7329 290a 0a20 2020 2063 6174  alues))..    cat
-00030a40: 2e61 7070 656e 6428 6669 7473 2e43 6f6c  .append(fits.Col
-00030a50: 756d 6e28 6e61 6d65 3d66 2750 484f 545f  umn(name=f'PHOT_
-00030a60: 4944 5f44 4543 5f70 7366 272c 0a20 2020  ID_DEC_psf',.   
-00030a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030a80: 2020 2020 2020 2020 666f 726d 6174 3d66          format=f
-00030a90: 2731 4527 2c0a 2020 2020 2020 2020 2020  '1E',.          
-00030aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ab0: 2061 7272 6179 3d63 6174 5f64 6174 612e   array=cat_data.
-00030ac0: 6c6f 635b 3a2c 2066 2750 484f 545f 4944  loc[:, f'PHOT_ID
-00030ad0: 5f44 4543 5f70 7366 275d 2e76 616c 7565  _DEC_psf'].value
-00030ae0: 7329 290a 0a20 2020 2023 2046 696c 7465  s))..    # Filte
-00030af0: 7220 4944 0a20 2020 204e 5f73 7472 203d  r ID.    N_str =
-00030b00: 206c 656e 2863 6174 5f64 6174 612e 6c6f   len(cat_data.lo
-00030b10: 635b 3a2c 2066 277b 6669 6c74 5f73 7461  c[:, f'{filt_sta
-00030b20: 6e64 6172 647d 5f49 445f 7073 6627 5d2e  ndard}_ID_psf'].
-00030b30: 7661 6c75 6573 5b30 5d29 0a20 2020 2061  values[0]).    a
-00030b40: 7272 6179 203d 2063 6174 5f64 6174 612e  rray = cat_data.
-00030b50: 6c6f 635b 3a2c 2066 277b 6669 6c74 5f73  loc[:, f'{filt_s
-00030b60: 7461 6e64 6172 647d 5f49 445f 7073 6627  tandard}_ID_psf'
-00030b70: 5d2e 7661 6c75 6573 0a20 2020 2063 6174  ].values.    cat
-00030b80: 2e61 7070 656e 6428 6669 7473 2e43 6f6c  .append(fits.Col
-00030b90: 756d 6e28 6e61 6d65 3d66 277b 6669 6c74  umn(name=f'{filt
-00030ba0: 5f73 7461 6e64 6172 647d 5f49 445f 7073  _standard}_ID_ps
-00030bb0: 6627 2c0a 2020 2020 2020 2020 2020 2020  f',.            
-00030bc0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00030bd0: 6f72 6d61 743d 6627 7b4e 5f73 7472 3a64  ormat=f'{N_str:d
-00030be0: 7d41 272c 0a20 2020 2020 2020 2020 2020  }A',.           
-00030bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030c00: 6172 7261 793d 6172 7261 7929 290a 0a20  array=array)).. 
-00030c10: 2020 2063 6174 2e61 7070 656e 6428 6669     cat.append(fi
-00030c20: 7473 2e43 6f6c 756d 6e28 6e61 6d65 3d66  ts.Column(name=f
-00030c30: 2752 415f 7b66 696c 745f 7374 616e 6461  'RA_{filt_standa
-00030c40: 7264 7d27 2c0a 2020 2020 2020 2020 2020  rd}',.          
-00030c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030c60: 2066 6f72 6d61 743d 2731 4527 2c0a 2020   format='1E',.  
-00030c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030c80: 2020 2020 2020 2020 2061 7272 6179 3d63           array=c
-00030c90: 6174 5f64 6174 612e 6c6f 635b 3a2c 2066  at_data.loc[:, f
-00030ca0: 2752 415f 7b66 696c 745f 7374 616e 6461  'RA_{filt_standa
-00030cb0: 7264 7d27 5d2e 7661 6c75 6573 2929 0a0a  rd}'].values))..
-00030cc0: 2020 2020 6361 742e 6170 7065 6e64 2866      cat.append(f
-00030cd0: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
-00030ce0: 6627 4445 435f 7b66 696c 745f 7374 616e  f'DEC_{filt_stan
-00030cf0: 6461 7264 7d27 2c0a 2020 2020 2020 2020  dard}',.        
-00030d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030d10: 2020 2066 6f72 6d61 743d 2731 4527 2c0a     format='1E',.
-00030d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030d30: 2020 2020 2020 2020 2020 2061 7272 6179             array
-00030d40: 3d63 6174 5f64 6174 612e 6c6f 635b 3a2c  =cat_data.loc[:,
-00030d50: 2066 2744 4543 5f7b 6669 6c74 5f73 7461   f'DEC_{filt_sta
-00030d60: 6e64 6172 647d 275d 2e76 616c 7565 7329  ndard}'].values)
-00030d70: 290a 0a20 2020 2023 2053 7461 725f 6e75  )..    # Star_nu
-00030d80: 6d62 6572 0a20 2020 2064 6f70 686f 745f  mber.    dophot_
-00030d90: 6669 6c74 6572 5f6e 756d 6265 7220 3d20  filter_number = 
-00030da0: 6361 745f 6461 7461 2e6c 6f63 5b3a 2c20  cat_data.loc[:, 
-00030db0: 2753 7461 725f 6e75 6d62 6572 275d 2e76  'Star_number'].v
-00030dc0: 616c 7565 730a 2020 2020 6361 742e 6170  alues.    cat.ap
-00030dd0: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
-00030de0: 286e 616d 653d 6627 446f 5048 4f54 5f53  (name=f'DoPHOT_S
-00030df0: 7461 725f 6e75 6d62 6572 5f7b 6669 6c74  tar_number_{filt
-00030e00: 5f73 7461 6e64 6172 647d 272c 0a20 2020  _standard}',.   
-00030e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030e20: 2020 2020 2020 2020 666f 726d 6174 3d27          format='
-00030e30: 314a 272c 0a20 2020 2020 2020 2020 2020  1J',.           
-00030e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030e50: 6172 7261 793d 646f 7068 6f74 5f66 696c  array=dophot_fil
-00030e60: 7465 725f 6e75 6d62 6572 2929 0a0a 0a20  ter_number))... 
-00030e70: 2020 2023 2043 414c 4942 5f46 4c41 470a     # CALIB_FLAG.
-00030e80: 2020 2020 2363 6174 2e61 7070 656e 6428      #cat.append(
-00030e90: 6669 7473 2e43 6f6c 756d 6e28 6e61 6d65  fits.Column(name
-00030ea0: 3d27 6361 6c69 625f 666c 6167 272c 0a20  ='calib_flag',. 
-00030eb0: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-00030ec0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
-00030ed0: 743d 2731 4a27 2c0a 2020 2020 2320 2020  t='1J',.    #   
-00030ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ef0: 2020 2020 6172 7261 793d 4e5f 736f 7572      array=N_sour
-00030f00: 6365 7320 2a20 5b63 616c 6962 7261 7469  ces * [calibrati
-00030f10: 6f6e 5f66 6c61 675d 2929 0a0a 2020 2020  on_flag]))..    
-00030f20: 2320 4341 4c49 4220 5354 5241 5445 4759  # CALIB STRATEGY
-00030f30: 0a20 2020 2069 6620 6361 6c69 6272 6174  .    if calibrat
-00030f40: 696f 6e5f 6e61 6d65 2069 7320 6e6f 7420  ion_name is not 
-00030f50: 4e6f 6e65 3a0a 2020 2020 2020 2020 4e5f  None:.        N_
-00030f60: 7374 7220 3d20 6c65 6e28 6361 6c69 6272  str = len(calibr
-00030f70: 6174 696f 6e5f 6e61 6d65 290a 2020 2020  ation_name).    
-00030f80: 2020 2020 6361 742e 6170 7065 6e64 2866      cat.append(f
-00030f90: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
-00030fa0: 6622 6361 6c69 625f 7374 7261 7422 2c0a  f"calib_strat",.
+00030300: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+00030310: 6c69 6272 6174 696f 6e5f 6e61 6d65 3d4e  libration_name=N
+00030320: 6f6e 6529 3a0a 2020 2020 2222 220a 0a20  one):.    """.. 
+00030330: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
+00030340: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
+00030350: 2063 6174 616c 6f67 5f66 696c 650a 2020   catalog_file.  
+00030360: 2020 7a70 5f66 696c 650a 2020 2020 7361    zp_file.    sa
+00030370: 7665 5f66 696c 650a 2020 2020 6669 6c74  ve_file.    filt
+00030380: 6572 5f6e 616d 650a 2020 2020 6170 6572  er_name.    aper
+00030390: 7475 7265 730a 2020 2020 6f74 6865 725f  tures.    other_
+000303a0: 636f 6c75 6d6e 730a 0a20 2020 2052 6574  columns..    Ret
+000303b0: 7572 6e73 0a20 2020 202d 2d2d 2d2d 2d2d  urns.    -------
+000303c0: 0a0a 2020 2020 2222 220a 0a20 2020 2023  ..    """..    #
+000303d0: 204c 6f61 6420 6669 6c74 6572 2063 6174   Load filter cat
+000303e0: 616c 6f67 7565 0a20 2020 2063 6174 5f64  alogue.    cat_d
+000303f0: 6174 6120 3d20 7064 2e72 6561 645f 6373  ata = pd.read_cs
+00030400: 7628 6361 7461 6c6f 675f 6669 6c65 290a  v(catalog_file).
+00030410: 0a20 2020 204e 5f73 6f75 7263 6573 203d  .    N_sources =
+00030420: 206c 656e 2863 6174 5f64 6174 6129 0a0a   len(cat_data)..
+00030430: 2020 2020 2320 4c6f 6164 205a 500a 2020      # Load ZP.  
+00030440: 2020 5a50 7320 3d20 7a70 5f72 6561 6428    ZPs = zp_read(
+00030450: 7a70 5f66 696c 6529 0a20 2020 205a 5020  zp_file).    ZP 
+00030460: 3d20 5a50 735b 6627 5350 4c55 535f 7b66  = ZPs[f'SPLUS_{f
+00030470: 696c 7465 725f 6e61 6d65 7d27 5d0a 0a20  ilter_name}'].. 
+00030480: 2020 2023 2053 7461 6e64 6172 6420 6669     # Standard fi
+00030490: 6c74 6572 206e 616d 650a 2020 2020 6669  lter name.    fi
+000304a0: 6c74 5f73 7461 6e64 6172 6420 3d20 7472  lt_standard = tr
+000304b0: 616e 736c 6174 655f 6669 6c74 6572 5f73  anslate_filter_s
+000304c0: 7461 6e64 6172 6428 6669 6c74 6572 5f6e  tandard(filter_n
+000304d0: 616d 6529 0a0a 2020 2020 2320 4372 6561  ame)..    # Crea
+000304e0: 7465 206e 6577 2064 6174 6120 5461 626c  te new data Tabl
+000304f0: 650a 2020 2020 6361 7420 3d20 5b5d 0a0a  e.    cat = []..
+00030500: 2020 2020 2320 4669 6c6c 206e 6577 2064      # Fill new d
+00030510: 6174 6120 5461 626c 6520 2323 2323 2323  ata Table ######
+00030520: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00030530: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00030540: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00030550: 0a0a 2020 2020 2320 4669 656c 6420 636f  ..    # Field co
+00030560: 6c75 6d6e 0a20 2020 2063 6174 2e61 7070  lumn.    cat.app
+00030570: 656e 6428 6669 7473 2e43 6f6c 756d 6e28  end(fits.Column(
+00030580: 6e61 6d65 3d27 4669 656c 6427 2c0a 2020  name='Field',.  
+00030590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000305a0: 2020 2020 2020 2020 2066 6f72 6d61 743d           format=
+000305b0: 2725 6441 2720 2520 6c65 6e28 6669 656c  '%dA' % len(fiel
+000305c0: 6429 2c0a 2020 2020 2020 2020 2020 2020  d),.            
+000305d0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000305e0: 7272 6179 3d4e 5f73 6f75 7263 6573 202a  rray=N_sources *
+000305f0: 205b 6669 656c 645d 2929 0a0a 2020 2020   [field]))..    
+00030600: 2320 4669 656c 6420 4944 0a20 2020 2074  # Field ID.    t
+00030610: 7279 3a0a 2020 2020 2020 2020 4e5f 7374  ry:.        N_st
+00030620: 7220 3d20 6c65 6e28 6361 745f 6461 7461  r = len(cat_data
+00030630: 2e6c 6f63 5b3a 2c20 6627 4649 454c 445f  .loc[:, f'FIELD_
+00030640: 4944 275d 2e76 616c 7565 735b 305d 290a  ID'].values[0]).
+00030650: 2020 2020 6578 6365 7074 2054 7970 6545      except TypeE
+00030660: 7272 6f72 3a0a 2020 2020 2020 2020 4e5f  rror:.        N_
+00030670: 7374 7220 3d20 3530 0a0a 2020 2020 6361  str = 50..    ca
+00030680: 742e 6170 7065 6e64 2866 6974 732e 436f  t.append(fits.Co
+00030690: 6c75 6d6e 286e 616d 653d 6627 4944 272c  lumn(name=f'ID',
+000306a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000306b0: 2020 2020 2020 2020 2020 2020 666f 726d              form
+000306c0: 6174 3d66 277b 4e5f 7374 723a 647d 4127  at=f'{N_str:d}A'
+000306d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000306e0: 2020 2020 2020 2020 2020 2020 2061 7272               arr
+000306f0: 6179 3d63 6174 5f64 6174 612e 6c6f 635b  ay=cat_data.loc[
+00030700: 3a2c 2066 2746 4945 4c44 5f49 4427 5d2e  :, f'FIELD_ID'].
+00030710: 7661 6c75 6573 2929 0a0a 2020 2020 6361  values))..    ca
+00030720: 742e 6170 7065 6e64 2866 6974 732e 436f  t.append(fits.Co
+00030730: 6c75 6d6e 286e 616d 653d 6627 4944 5f52  lumn(name=f'ID_R
+00030740: 4127 2c0a 2020 2020 2020 2020 2020 2020  A',.            
+00030750: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00030760: 6f72 6d61 743d 6627 3145 272c 0a20 2020  ormat=f'1E',.   
+00030770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030780: 2020 2020 2020 2020 6172 7261 793d 6361          array=ca
+00030790: 745f 6461 7461 2e6c 6f63 5b3a 2c20 6627  t_data.loc[:, f'
+000307a0: 4649 454c 445f 4944 5f52 4127 5d2e 7661  FIELD_ID_RA'].va
+000307b0: 6c75 6573 2929 0a0a 2020 2020 6361 742e  lues))..    cat.
+000307c0: 6170 7065 6e64 2866 6974 732e 436f 6c75  append(fits.Colu
+000307d0: 6d6e 286e 616d 653d 6627 4944 5f44 4543  mn(name=f'ID_DEC
+000307e0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000307f0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00030800: 726d 6174 3d66 2731 4527 2c0a 2020 2020  rmat=f'1E',.    
+00030810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030820: 2020 2020 2020 2061 7272 6179 3d63 6174         array=cat
+00030830: 5f64 6174 612e 6c6f 635b 3a2c 2066 2746  _data.loc[:, f'F
+00030840: 4945 4c44 5f49 445f 4445 4327 5d2e 7661  IELD_ID_DEC'].va
+00030850: 6c75 6573 2929 0a0a 2020 2020 2320 4164  lues))..    # Ad
+00030860: 6420 5048 4f54 2049 4473 0a20 2020 204e  d PHOT IDs.    N
+00030870: 5f73 7472 203d 206c 656e 2863 6174 5f64  _str = len(cat_d
+00030880: 6174 612e 6c6f 635b 3a2c 2066 2750 484f  ata.loc[:, f'PHO
+00030890: 545f 4944 5f70 7366 275d 2e76 616c 7565  T_ID_psf'].value
+000308a0: 735b 305d 290a 0a20 2020 2063 6174 2e61  s[0])..    cat.a
+000308b0: 7070 656e 6428 6669 7473 2e43 6f6c 756d  ppend(fits.Colum
+000308c0: 6e28 6e61 6d65 3d66 2750 484f 545f 4944  n(name=f'PHOT_ID
+000308d0: 5f70 7366 272c 0a20 2020 2020 2020 2020  _psf',.         
+000308e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000308f0: 2020 666f 726d 6174 3d66 277b 4e5f 7374    format=f'{N_st
+00030900: 723a 647d 4127 2c0a 2020 2020 2020 2020  r:d}A',.        
+00030910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030920: 2020 2061 7272 6179 3d63 6174 5f64 6174     array=cat_dat
+00030930: 612e 6c6f 635b 3a2c 2066 2750 484f 545f  a.loc[:, f'PHOT_
+00030940: 4944 5f70 7366 275d 2e76 616c 7565 7329  ID_psf'].values)
+00030950: 290a 0a20 2020 2063 6174 2e61 7070 656e  )..    cat.appen
+00030960: 6428 6669 7473 2e43 6f6c 756d 6e28 6e61  d(fits.Column(na
+00030970: 6d65 3d66 2750 484f 545f 4944 5f52 415f  me=f'PHOT_ID_RA_
+00030980: 7073 6627 2c0a 2020 2020 2020 2020 2020  psf',.          
+00030990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000309a0: 2066 6f72 6d61 743d 6627 3145 272c 0a20   format=f'1E',. 
+000309b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000309c0: 2020 2020 2020 2020 2020 6172 7261 793d            array=
+000309d0: 6361 745f 6461 7461 2e6c 6f63 5b3a 2c20  cat_data.loc[:, 
+000309e0: 6627 5048 4f54 5f49 445f 5241 5f70 7366  f'PHOT_ID_RA_psf
+000309f0: 275d 2e76 616c 7565 7329 290a 0a20 2020  '].values))..   
+00030a00: 2063 6174 2e61 7070 656e 6428 6669 7473   cat.append(fits
+00030a10: 2e43 6f6c 756d 6e28 6e61 6d65 3d66 2750  .Column(name=f'P
+00030a20: 484f 545f 4944 5f44 4543 5f70 7366 272c  HOT_ID_DEC_psf',
+00030a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030a40: 2020 2020 2020 2020 2020 2020 666f 726d              form
+00030a50: 6174 3d66 2731 4527 2c0a 2020 2020 2020  at=f'1E',.      
+00030a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030a70: 2020 2020 2061 7272 6179 3d63 6174 5f64       array=cat_d
+00030a80: 6174 612e 6c6f 635b 3a2c 2066 2750 484f  ata.loc[:, f'PHO
+00030a90: 545f 4944 5f44 4543 5f70 7366 275d 2e76  T_ID_DEC_psf'].v
+00030aa0: 616c 7565 7329 290a 0a20 2020 2023 2046  alues))..    # F
+00030ab0: 696c 7465 7220 4944 0a20 2020 204e 5f73  ilter ID.    N_s
+00030ac0: 7472 203d 206c 656e 2863 6174 5f64 6174  tr = len(cat_dat
+00030ad0: 612e 6c6f 635b 3a2c 2066 277b 6669 6c74  a.loc[:, f'{filt
+00030ae0: 5f73 7461 6e64 6172 647d 5f49 445f 7073  _standard}_ID_ps
+00030af0: 6627 5d2e 7661 6c75 6573 5b30 5d29 0a20  f'].values[0]). 
+00030b00: 2020 2061 7272 6179 203d 2063 6174 5f64     array = cat_d
+00030b10: 6174 612e 6c6f 635b 3a2c 2066 277b 6669  ata.loc[:, f'{fi
+00030b20: 6c74 5f73 7461 6e64 6172 647d 5f49 445f  lt_standard}_ID_
+00030b30: 7073 6627 5d2e 7661 6c75 6573 0a20 2020  psf'].values.   
+00030b40: 2063 6174 2e61 7070 656e 6428 6669 7473   cat.append(fits
+00030b50: 2e43 6f6c 756d 6e28 6e61 6d65 3d66 277b  .Column(name=f'{
+00030b60: 6669 6c74 5f73 7461 6e64 6172 647d 5f49  filt_standard}_I
+00030b70: 445f 7073 6627 2c0a 2020 2020 2020 2020  D_psf',.        
+00030b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030b90: 2020 2066 6f72 6d61 743d 6627 7b4e 5f73     format=f'{N_s
+00030ba0: 7472 3a64 7d41 272c 0a20 2020 2020 2020  tr:d}A',.       
+00030bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030bc0: 2020 2020 6172 7261 793d 6172 7261 7929      array=array)
+00030bd0: 290a 0a20 2020 2063 6174 2e61 7070 656e  )..    cat.appen
+00030be0: 6428 6669 7473 2e43 6f6c 756d 6e28 6e61  d(fits.Column(na
+00030bf0: 6d65 3d66 2752 415f 7b66 696c 745f 7374  me=f'RA_{filt_st
+00030c00: 616e 6461 7264 7d27 2c0a 2020 2020 2020  andard}',.      
+00030c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030c20: 2020 2020 2066 6f72 6d61 743d 2731 4527       format='1E'
+00030c30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00030c40: 2020 2020 2020 2020 2020 2020 2061 7272               arr
+00030c50: 6179 3d63 6174 5f64 6174 612e 6c6f 635b  ay=cat_data.loc[
+00030c60: 3a2c 2066 2752 415f 7b66 696c 745f 7374  :, f'RA_{filt_st
+00030c70: 616e 6461 7264 7d27 5d2e 7661 6c75 6573  andard}'].values
+00030c80: 2929 0a0a 2020 2020 6361 742e 6170 7065  ))..    cat.appe
+00030c90: 6e64 2866 6974 732e 436f 6c75 6d6e 286e  nd(fits.Column(n
+00030ca0: 616d 653d 6627 4445 435f 7b66 696c 745f  ame=f'DEC_{filt_
+00030cb0: 7374 616e 6461 7264 7d27 2c0a 2020 2020  standard}',.    
+00030cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030cd0: 2020 2020 2020 2066 6f72 6d61 743d 2731         format='1
+00030ce0: 4527 2c0a 2020 2020 2020 2020 2020 2020  E',.            
+00030cf0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00030d00: 7272 6179 3d63 6174 5f64 6174 612e 6c6f  rray=cat_data.lo
+00030d10: 635b 3a2c 2066 2744 4543 5f7b 6669 6c74  c[:, f'DEC_{filt
+00030d20: 5f73 7461 6e64 6172 647d 275d 2e76 616c  _standard}'].val
+00030d30: 7565 7329 290a 0a20 2020 2023 2053 7461  ues))..    # Sta
+00030d40: 725f 6e75 6d62 6572 0a20 2020 2064 6f70  r_number.    dop
+00030d50: 686f 745f 6669 6c74 6572 5f6e 756d 6265  hot_filter_numbe
+00030d60: 7220 3d20 6361 745f 6461 7461 2e6c 6f63  r = cat_data.loc
+00030d70: 5b3a 2c20 2753 7461 725f 6e75 6d62 6572  [:, 'Star_number
+00030d80: 275d 2e76 616c 7565 730a 2020 2020 6361  '].values.    ca
+00030d90: 742e 6170 7065 6e64 2866 6974 732e 436f  t.append(fits.Co
+00030da0: 6c75 6d6e 286e 616d 653d 6627 446f 5048  lumn(name=f'DoPH
+00030db0: 4f54 5f53 7461 725f 6e75 6d62 6572 5f7b  OT_Star_number_{
+00030dc0: 6669 6c74 5f73 7461 6e64 6172 647d 272c  filt_standard}',
+00030dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030de0: 2020 2020 2020 2020 2020 2020 666f 726d              form
+00030df0: 6174 3d27 314a 272c 0a20 2020 2020 2020  at='1J',.       
+00030e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030e10: 2020 2020 6172 7261 793d 646f 7068 6f74      array=dophot
+00030e20: 5f66 696c 7465 725f 6e75 6d62 6572 2929  _filter_number))
+00030e30: 0a0a 0a20 2020 2023 2043 414c 4942 5f46  ...    # CALIB_F
+00030e40: 4c41 470a 2020 2020 2363 6174 2e61 7070  LAG.    #cat.app
+00030e50: 656e 6428 6669 7473 2e43 6f6c 756d 6e28  end(fits.Column(
+00030e60: 6e61 6d65 3d27 6361 6c69 625f 666c 6167  name='calib_flag
+00030e70: 272c 0a20 2020 2023 2020 2020 2020 2020  ',.    #        
+00030e80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00030e90: 6f72 6d61 743d 2731 4a27 2c0a 2020 2020  ormat='1J',.    
+00030ea0: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+00030eb0: 2020 2020 2020 2020 6172 7261 793d 4e5f          array=N_
+00030ec0: 736f 7572 6365 7320 2a20 5b63 616c 6962  sources * [calib
+00030ed0: 7261 7469 6f6e 5f66 6c61 675d 2929 0a0a  ration_flag]))..
+00030ee0: 2020 2020 2320 4341 4c49 4220 5354 5241      # CALIB STRA
+00030ef0: 5445 4759 0a20 2020 2069 6620 6361 6c69  TEGY.    if cali
+00030f00: 6272 6174 696f 6e5f 6e61 6d65 2069 7320  bration_name is 
+00030f10: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00030f20: 2020 4e5f 7374 7220 3d20 6c65 6e28 6361    N_str = len(ca
+00030f30: 6c69 6272 6174 696f 6e5f 6e61 6d65 290a  libration_name).
+00030f40: 2020 2020 2020 2020 6361 742e 6170 7065          cat.appe
+00030f50: 6e64 2866 6974 732e 436f 6c75 6d6e 286e  nd(fits.Column(n
+00030f60: 616d 653d 6622 6361 6c69 625f 7374 7261  ame=f"calib_stra
+00030f70: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+00030f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030f90: 2020 2066 6f72 6d61 743d 6627 7b4e 5f73     format=f'{N_s
+00030fa0: 7472 7d41 272c 0a20 2020 2020 2020 2020  tr}A',.         
 00030fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030fc0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00030fd0: 6f72 6d61 743d 6627 7b4e 5f73 7472 7d41  ormat=f'{N_str}A
-00030fe0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00030ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031000: 2020 6172 7261 793d 5b63 616c 6962 7261    array=[calibra
-00031010: 7469 6f6e 5f6e 616d 655d 202a 204e 5f73  tion_name] * N_s
-00031020: 6f75 7263 6573 2929 0a0a 2020 2020 2320  ources))..    # 
-00031030: 5241 2c20 4445 432c 2058 2c20 590a 2020  RA, DEC, X, Y.  
-00031040: 2020 6361 742e 6170 7065 6e64 2866 6974    cat.append(fit
-00031050: 732e 436f 6c75 6d6e 286e 616d 653d 6627  s.Column(name=f'
-00031060: 585f 7b66 696c 745f 7374 616e 6461 7264  X_{filt_standard
-00031070: 7d27 2c0a 2020 2020 2020 2020 2020 2020  }',.            
-00031080: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00031090: 6f72 6d61 743d 2731 4527 2c0a 2020 2020  ormat='1E',.    
-000310a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000310b0: 2020 2020 2020 2061 7272 6179 3d63 6174         array=cat
-000310c0: 5f64 6174 612e 6c6f 635b 3a2c 2027 7870  _data.loc[:, 'xp
-000310d0: 6f73 275d 2e76 616c 7565 7329 290a 0a20  os'].values)).. 
-000310e0: 2020 2063 6174 2e61 7070 656e 6428 6669     cat.append(fi
-000310f0: 7473 2e43 6f6c 756d 6e28 6e61 6d65 3d66  ts.Column(name=f
-00031100: 2759 5f7b 6669 6c74 5f73 7461 6e64 6172  'Y_{filt_standar
-00031110: 647d 272c 0a20 2020 2020 2020 2020 2020  d}',.           
-00031120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031130: 666f 726d 6174 3d27 3145 272c 0a20 2020  format='1E',.   
-00031140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031150: 2020 2020 2020 2020 6172 7261 793d 6361          array=ca
-00031160: 745f 6461 7461 2e6c 6f63 5b3a 2c20 2779  t_data.loc[:, 'y
-00031170: 706f 7327 5d2e 7661 6c75 6573 2929 0a0a  pos'].values))..
-00031180: 2020 2020 2320 446f 5048 4f54 2070 6172      # DoPHOT par
-00031190: 616d 6574 6572 730a 2020 2020 2363 6174  ameters.    #cat
-000311a0: 2e61 7070 656e 6428 6669 7473 2e43 6f6c  .append(fits.Col
-000311b0: 756d 6e28 6e61 6d65 3d66 2744 6f50 484f  umn(name=f'DoPHO
-000311c0: 545f 6669 7473 6b79 5f7b 6669 6c74 5f73  T_fitsky_{filt_s
-000311d0: 7461 6e64 6172 647d 272c 0a20 2020 2023  tandard}',.    #
-000311e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000311f0: 2020 2020 2020 2066 6f72 6d61 743d 2731         format='1
-00031200: 4527 2c0a 2020 2020 2320 2020 2020 2020  E',.    #       
-00031210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031220: 6172 7261 793d 6361 745f 6461 7461 2e6c  array=cat_data.l
-00031230: 6f63 5b3a 2c20 2766 6974 736b 7927 5d2e  oc[:, 'fitsky'].
-00031240: 7661 6c75 6573 2929 0a0a 2020 2020 2363  values))..    #c
-00031250: 6174 2e61 7070 656e 6428 6669 7473 2e43  at.append(fits.C
-00031260: 6f6c 756d 6e28 6e61 6d65 3d66 2744 6f50  olumn(name=f'DoP
-00031270: 484f 545f 6f62 6a74 7970 655f 7b66 696c  HOT_objtype_{fil
-00031280: 745f 7374 616e 6461 7264 7d27 2c0a 2020  t_standard}',.  
-00031290: 2020 2320 2020 2020 2020 2020 2020 2020    #             
-000312a0: 2020 2020 2020 2020 2020 666f 726d 6174            format
-000312b0: 3d27 314a 272c 0a20 2020 2023 2020 2020  ='1J',.    #    
-000312c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000312d0: 2020 2061 7272 6179 3d63 6174 5f64 6174     array=cat_dat
-000312e0: 612e 6c6f 635b 3a2c 2027 6f62 6a74 7970  a.loc[:, 'objtyp
-000312f0: 6527 5d2e 7661 6c75 6573 2929 0a0a 2020  e'].values))..  
-00031300: 2020 2363 6174 2e61 7070 656e 6428 6669    #cat.append(fi
-00031310: 7473 2e43 6f6c 756d 6e28 6e61 6d65 3d66  ts.Column(name=f
-00031320: 2744 6f50 484f 545f 6368 695f 7b66 696c  'DoPHOT_chi_{fil
-00031330: 745f 7374 616e 6461 7264 7d27 2c0a 2020  t_standard}',.  
-00031340: 2020 2320 2020 2020 2020 2020 2020 2020    #             
-00031350: 2020 2020 2020 2020 2020 666f 726d 6174            format
-00031360: 3d27 3145 272c 0a20 2020 2023 2020 2020  ='1E',.    #    
-00031370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031380: 2020 2061 7272 6179 3d63 6174 5f64 6174     array=cat_dat
-00031390: 612e 6c6f 635b 3a2c 2027 6368 6927 5d2e  a.loc[:, 'chi'].
-000313a0: 7661 6c75 6573 2929 0a0a 2020 2020 2363  values))..    #c
-000313b0: 6174 2e61 7070 656e 6428 6669 7473 2e43  at.append(fits.C
-000313c0: 6f6c 756d 6e28 6e61 6d65 3d66 2744 6f50  olumn(name=f'DoP
-000313d0: 484f 545f 6170 636f 7272 5f7b 6669 6c74  HOT_apcorr_{filt
-000313e0: 5f73 7461 6e64 6172 647d 272c 0a20 2020  _standard}',.   
-000313f0: 2023 2020 2020 2020 2020 2020 2020 2020   #              
-00031400: 2020 2020 2020 2020 2066 6f72 6d61 743d           format=
-00031410: 2731 4527 2c0a 2020 2020 2320 2020 2020  '1E',.    #     
-00031420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031430: 2020 6172 7261 793d 6361 745f 6461 7461    array=cat_data
-00031440: 2e6c 6f63 5b3a 2c20 2761 7063 6f72 7227  .loc[:, 'apcorr'
-00031450: 5d2e 7661 6c75 6573 2929 0a0a 2020 2020  ].values))..    
-00031460: 2320 434c 4153 535f 5354 4152 0a20 2020  # CLASS_STAR.   
-00031470: 2063 6174 2e61 7070 656e 6428 6669 7473   cat.append(fits
-00031480: 2e43 6f6c 756d 6e28 6e61 6d65 3d66 2743  .Column(name=f'C
-00031490: 4c41 5353 5f53 5441 525f 7b66 696c 745f  LASS_STAR_{filt_
-000314a0: 7374 616e 6461 7264 7d27 2c0a 2020 2020  standard}',.    
-000314b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000314c0: 2020 2020 2020 2066 6f72 6d61 743d 2731         format='1
-000314d0: 4a27 2c0a 2020 2020 2020 2020 2020 2020  J',.            
-000314e0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000314f0: 7272 6179 3d63 6174 5f64 6174 612e 6c6f  rray=cat_data.lo
-00031500: 635b 3a2c 2027 464c 4147 5f53 5441 5227  c[:, 'FLAG_STAR'
-00031510: 5d2e 7661 6c75 6573 2929 0a0a 2020 2020  ].values))..    
-00031520: 2320 4d61 676e 6974 7564 6573 2061 6e64  # Magnitudes and
-00031530: 2066 6c75 7865 730a 2020 2020 6669 746d   fluxes.    fitm
-00031540: 6167 203d 2063 6174 5f64 6174 612e 6c6f  ag = cat_data.lo
-00031550: 635b 3a2c 2027 6669 746d 6167 275d 2e76  c[:, 'fitmag'].v
-00031560: 616c 7565 730a 2020 2020 6572 725f 6669  alues.    err_fi
-00031570: 746d 6167 203d 2063 6174 5f64 6174 612e  tmag = cat_data.
-00031580: 6c6f 635b 3a2c 2027 6572 725f 6669 746d  loc[:, 'err_fitm
-00031590: 6167 275d 2e76 616c 7565 730a 0a20 2020  ag'].values..   
-000315a0: 206d 6167 2020 203d 2066 6974 6d61 6720   mag   = fitmag 
-000315b0: 2b20 5a50 202d 2069 6e73 745f 6d61 675f  + ZP - inst_mag_
-000315c0: 7a70 0a20 2020 2065 5f6d 6167 203d 2065  zp.    e_mag = e
-000315d0: 7272 5f66 6974 6d61 670a 0a20 2020 2066  rr_fitmag..    f
-000315e0: 6c75 7820 3d20 3130 2a2a 2828 2d6d 6167  lux = 10**((-mag
-000315f0: 2d34 382e 3629 2f32 2e35 290a 2020 2020  -48.6)/2.5).    
-00031600: 655f 666c 7578 203d 2028 666c 7578 2a65  e_flux = (flux*e
-00031610: 5f6d 6167 292f 312e 3038 330a 0a20 2020  _mag)/1.083..   
-00031620: 2073 326e 203d 2066 6c75 782f 655f 666c   s2n = flux/e_fl
-00031630: 7578 0a0a 2020 2020 6361 742e 6170 7065  ux..    cat.appe
-00031640: 6e64 2866 6974 732e 436f 6c75 6d6e 286e  nd(fits.Column(n
-00031650: 616d 653d 6627 7b66 696c 745f 7374 616e  ame=f'{filt_stan
-00031660: 6461 7264 7d5f 7073 6627 2c0a 2020 2020  dard}_psf',.    
-00031670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031680: 2020 2020 2020 2066 6f72 6d61 743d 2731         format='1
-00031690: 4527 2c0a 2020 2020 2020 2020 2020 2020  E',.            
-000316a0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000316b0: 7272 6179 3d6d 6167 2929 0a0a 2020 2020  rray=mag))..    
-000316c0: 6361 742e 6170 7065 6e64 2866 6974 732e  cat.append(fits.
-000316d0: 436f 6c75 6d6e 286e 616d 653d 6627 655f  Column(name=f'e_
-000316e0: 7b66 696c 745f 7374 616e 6461 7264 7d5f  {filt_standard}_
-000316f0: 7073 6627 2c0a 2020 2020 2020 2020 2020  psf',.          
-00031700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031710: 2066 6f72 6d61 743d 2731 4527 2c0a 2020   format='1E',.  
-00031720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031730: 2020 2020 2020 2020 2061 7272 6179 3d65           array=e
-00031740: 5f6d 6167 2929 0a0a 2020 2020 6361 742e  _mag))..    cat.
-00031750: 6170 7065 6e64 2866 6974 732e 436f 6c75  append(fits.Colu
-00031760: 6d6e 286e 616d 653d 6627 7332 6e5f 7b66  mn(name=f's2n_{f
-00031770: 696c 745f 7374 616e 6461 7264 7d5f 7073  ilt_standard}_ps
-00031780: 6627 2c0a 2020 2020 2020 2020 2020 2020  f',.            
-00031790: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000317a0: 6f72 6d61 743d 2731 4527 2c0a 2020 2020  ormat='1E',.    
-000317b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000317c0: 2020 2020 2020 2061 7272 6179 3d73 326e         array=s2n
-000317d0: 2929 0a0a 2020 2020 6966 2065 7874 696e  ))..    if extin
-000317e0: 6374 696f 6e5f 6d61 7073 5f70 6174 6820  ction_maps_path 
-000317f0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00031800: 2020 2020 2069 6620 6578 7469 6e63 7469       if extincti
-00031810: 6f6e 5f63 6f72 7265 6374 696f 6e2e 6c6f  on_correction.lo
-00031820: 7765 7228 2920 3d3d 2027 7363 686c 6567  wer() == 'schleg
-00031830: 656c 273a 0a0a 2020 2020 2020 2020 2020  el':..          
-00031840: 2020 5241 203d 2063 6174 5f64 6174 612e    RA = cat_data.
-00031850: 6c6f 635b 3a2c 2066 2752 415f 7b66 696c  loc[:, f'RA_{fil
-00031860: 745f 7374 616e 6461 7264 7d27 5d2e 7661  t_standard}'].va
-00031870: 6c75 6573 0a20 2020 2020 2020 2020 2020  lues.           
-00031880: 2044 4543 203d 2063 6174 5f64 6174 612e   DEC = cat_data.
-00031890: 6c6f 635b 3a2c 2066 2744 4543 5f7b 6669  loc[:, f'DEC_{fi
-000318a0: 6c74 5f73 7461 6e64 6172 647d 275d 2e76  lt_standard}'].v
-000318b0: 616c 7565 730a 0a20 2020 2020 2020 2020  alues..         
-000318c0: 2020 2045 4256 203d 2067 6574 5f45 4256     EBV = get_EBV
-000318d0: 5f73 6368 6c65 6765 6c28 5241 2020 3d20  _schlegel(RA  = 
-000318e0: 5241 2c0a 2020 2020 2020 2020 2020 2020  RA,.            
-000318f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031900: 2020 2020 2020 2044 4543 203d 2044 4543         DEC = DEC
-00031910: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00031920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031930: 2020 2020 2065 6276 5f6d 6170 735f 7061       ebv_maps_pa
-00031940: 7468 203d 2065 7874 696e 6374 696f 6e5f  th = extinction_
-00031950: 6d61 7073 5f70 6174 6829 0a0a 2020 2020  maps_path)..    
-00031960: 2020 2020 2020 2020 6361 742e 6170 7065          cat.appe
-00031970: 6e64 2866 6974 732e 436f 6c75 6d6e 286e  nd(fits.Column(n
-00031980: 616d 653d 6627 4542 565f 5343 4827 2c0a  ame=f'EBV_SCH',.
+00030fc0: 2020 2020 2020 6172 7261 793d 5b63 616c        array=[cal
+00030fd0: 6962 7261 7469 6f6e 5f6e 616d 655d 202a  ibration_name] *
+00030fe0: 204e 5f73 6f75 7263 6573 2929 0a0a 2020   N_sources))..  
+00030ff0: 2020 2320 5241 2c20 4445 432c 2058 2c20    # RA, DEC, X, 
+00031000: 590a 2020 2020 6361 742e 6170 7065 6e64  Y.    cat.append
+00031010: 2866 6974 732e 436f 6c75 6d6e 286e 616d  (fits.Column(nam
+00031020: 653d 6627 585f 7b66 696c 745f 7374 616e  e=f'X_{filt_stan
+00031030: 6461 7264 7d27 2c0a 2020 2020 2020 2020  dard}',.        
+00031040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031050: 2020 2066 6f72 6d61 743d 2731 4527 2c0a     format='1E',.
+00031060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031070: 2020 2020 2020 2020 2020 2061 7272 6179             array
+00031080: 3d63 6174 5f64 6174 612e 6c6f 635b 3a2c  =cat_data.loc[:,
+00031090: 2027 7870 6f73 275d 2e76 616c 7565 7329   'xpos'].values)
+000310a0: 290a 0a20 2020 2063 6174 2e61 7070 656e  )..    cat.appen
+000310b0: 6428 6669 7473 2e43 6f6c 756d 6e28 6e61  d(fits.Column(na
+000310c0: 6d65 3d66 2759 5f7b 6669 6c74 5f73 7461  me=f'Y_{filt_sta
+000310d0: 6e64 6172 647d 272c 0a20 2020 2020 2020  ndard}',.       
+000310e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000310f0: 2020 2020 666f 726d 6174 3d27 3145 272c      format='1E',
+00031100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031110: 2020 2020 2020 2020 2020 2020 6172 7261              arra
+00031120: 793d 6361 745f 6461 7461 2e6c 6f63 5b3a  y=cat_data.loc[:
+00031130: 2c20 2779 706f 7327 5d2e 7661 6c75 6573  , 'ypos'].values
+00031140: 2929 0a0a 2020 2020 2320 446f 5048 4f54  ))..    # DoPHOT
+00031150: 2070 6172 616d 6574 6572 730a 2020 2020   parameters.    
+00031160: 2363 6174 2e61 7070 656e 6428 6669 7473  #cat.append(fits
+00031170: 2e43 6f6c 756d 6e28 6e61 6d65 3d66 2744  .Column(name=f'D
+00031180: 6f50 484f 545f 6669 7473 6b79 5f7b 6669  oPHOT_fitsky_{fi
+00031190: 6c74 5f73 7461 6e64 6172 647d 272c 0a20  lt_standard}',. 
+000311a0: 2020 2023 2020 2020 2020 2020 2020 2020     #            
+000311b0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+000311c0: 743d 2731 4527 2c0a 2020 2020 2320 2020  t='1E',.    #   
+000311d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000311e0: 2020 2020 6172 7261 793d 6361 745f 6461      array=cat_da
+000311f0: 7461 2e6c 6f63 5b3a 2c20 2766 6974 736b  ta.loc[:, 'fitsk
+00031200: 7927 5d2e 7661 6c75 6573 2929 0a0a 2020  y'].values))..  
+00031210: 2020 2363 6174 2e61 7070 656e 6428 6669    #cat.append(fi
+00031220: 7473 2e43 6f6c 756d 6e28 6e61 6d65 3d66  ts.Column(name=f
+00031230: 2744 6f50 484f 545f 6f62 6a74 7970 655f  'DoPHOT_objtype_
+00031240: 7b66 696c 745f 7374 616e 6461 7264 7d27  {filt_standard}'
+00031250: 2c0a 2020 2020 2320 2020 2020 2020 2020  ,.    #         
+00031260: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00031270: 726d 6174 3d27 314a 272c 0a20 2020 2023  rmat='1J',.    #
+00031280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031290: 2020 2020 2020 2061 7272 6179 3d63 6174         array=cat
+000312a0: 5f64 6174 612e 6c6f 635b 3a2c 2027 6f62  _data.loc[:, 'ob
+000312b0: 6a74 7970 6527 5d2e 7661 6c75 6573 2929  jtype'].values))
+000312c0: 0a0a 2020 2020 2363 6174 2e61 7070 656e  ..    #cat.appen
+000312d0: 6428 6669 7473 2e43 6f6c 756d 6e28 6e61  d(fits.Column(na
+000312e0: 6d65 3d66 2744 6f50 484f 545f 6368 695f  me=f'DoPHOT_chi_
+000312f0: 7b66 696c 745f 7374 616e 6461 7264 7d27  {filt_standard}'
+00031300: 2c0a 2020 2020 2320 2020 2020 2020 2020  ,.    #         
+00031310: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00031320: 726d 6174 3d27 3145 272c 0a20 2020 2023  rmat='1E',.    #
+00031330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031340: 2020 2020 2020 2061 7272 6179 3d63 6174         array=cat
+00031350: 5f64 6174 612e 6c6f 635b 3a2c 2027 6368  _data.loc[:, 'ch
+00031360: 6927 5d2e 7661 6c75 6573 2929 0a0a 2020  i'].values))..  
+00031370: 2020 2363 6174 2e61 7070 656e 6428 6669    #cat.append(fi
+00031380: 7473 2e43 6f6c 756d 6e28 6e61 6d65 3d66  ts.Column(name=f
+00031390: 2744 6f50 484f 545f 6170 636f 7272 5f7b  'DoPHOT_apcorr_{
+000313a0: 6669 6c74 5f73 7461 6e64 6172 647d 272c  filt_standard}',
+000313b0: 0a20 2020 2023 2020 2020 2020 2020 2020  .    #          
+000313c0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000313d0: 6d61 743d 2731 4527 2c0a 2020 2020 2320  mat='1E',.    # 
+000313e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000313f0: 2020 2020 2020 6172 7261 793d 6361 745f        array=cat_
+00031400: 6461 7461 2e6c 6f63 5b3a 2c20 2761 7063  data.loc[:, 'apc
+00031410: 6f72 7227 5d2e 7661 6c75 6573 2929 0a0a  orr'].values))..
+00031420: 2020 2020 2320 434c 4153 535f 5354 4152      # CLASS_STAR
+00031430: 0a20 2020 2063 6174 2e61 7070 656e 6428  .    cat.append(
+00031440: 6669 7473 2e43 6f6c 756d 6e28 6e61 6d65  fits.Column(name
+00031450: 3d66 2743 4c41 5353 5f53 5441 525f 7b66  =f'CLASS_STAR_{f
+00031460: 696c 745f 7374 616e 6461 7264 7d27 2c0a  ilt_standard}',.
+00031470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031480: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+00031490: 743d 2731 4a27 2c0a 2020 2020 2020 2020  t='1J',.        
+000314a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000314b0: 2020 2061 7272 6179 3d63 6174 5f64 6174     array=cat_dat
+000314c0: 612e 6c6f 635b 3a2c 2027 464c 4147 5f53  a.loc[:, 'FLAG_S
+000314d0: 5441 5227 5d2e 7661 6c75 6573 2929 0a0a  TAR'].values))..
+000314e0: 2020 2020 2320 4d61 676e 6974 7564 6573      # Magnitudes
+000314f0: 2061 6e64 2066 6c75 7865 730a 2020 2020   and fluxes.    
+00031500: 6669 746d 6167 203d 2063 6174 5f64 6174  fitmag = cat_dat
+00031510: 612e 6c6f 635b 3a2c 2027 6669 746d 6167  a.loc[:, 'fitmag
+00031520: 275d 2e76 616c 7565 730a 2020 2020 6572  '].values.    er
+00031530: 725f 6669 746d 6167 203d 2063 6174 5f64  r_fitmag = cat_d
+00031540: 6174 612e 6c6f 635b 3a2c 2027 6572 725f  ata.loc[:, 'err_
+00031550: 6669 746d 6167 275d 2e76 616c 7565 730a  fitmag'].values.
+00031560: 0a20 2020 206d 6167 2020 203d 2066 6974  .    mag   = fit
+00031570: 6d61 6720 2b20 5a50 202d 2069 6e73 745f  mag + ZP - inst_
+00031580: 6d61 675f 7a70 0a20 2020 2065 5f6d 6167  mag_zp.    e_mag
+00031590: 203d 2065 7272 5f66 6974 6d61 670a 0a20   = err_fitmag.. 
+000315a0: 2020 2066 6c75 7820 3d20 3130 2a2a 2828     flux = 10**((
+000315b0: 2d6d 6167 2d34 382e 3629 2f32 2e35 290a  -mag-48.6)/2.5).
+000315c0: 2020 2020 655f 666c 7578 203d 2028 666c      e_flux = (fl
+000315d0: 7578 2a65 5f6d 6167 292f 312e 3038 330a  ux*e_mag)/1.083.
+000315e0: 0a20 2020 2073 326e 203d 2066 6c75 782f  .    s2n = flux/
+000315f0: 655f 666c 7578 0a0a 2020 2020 6361 742e  e_flux..    cat.
+00031600: 6170 7065 6e64 2866 6974 732e 436f 6c75  append(fits.Colu
+00031610: 6d6e 286e 616d 653d 6627 7b66 696c 745f  mn(name=f'{filt_
+00031620: 7374 616e 6461 7264 7d5f 7073 6627 2c0a  standard}_psf',.
+00031630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031640: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+00031650: 743d 2731 4527 2c0a 2020 2020 2020 2020  t='1E',.        
+00031660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031670: 2020 2061 7272 6179 3d6d 6167 2929 0a0a     array=mag))..
+00031680: 2020 2020 6361 742e 6170 7065 6e64 2866      cat.append(f
+00031690: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
+000316a0: 6627 655f 7b66 696c 745f 7374 616e 6461  f'e_{filt_standa
+000316b0: 7264 7d5f 7073 6627 2c0a 2020 2020 2020  rd}_psf',.      
+000316c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000316d0: 2020 2020 2066 6f72 6d61 743d 2731 4527       format='1E'
+000316e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000316f0: 2020 2020 2020 2020 2020 2020 2061 7272               arr
+00031700: 6179 3d65 5f6d 6167 2929 0a0a 2020 2020  ay=e_mag))..    
+00031710: 6361 742e 6170 7065 6e64 2866 6974 732e  cat.append(fits.
+00031720: 436f 6c75 6d6e 286e 616d 653d 6627 7332  Column(name=f's2
+00031730: 6e5f 7b66 696c 745f 7374 616e 6461 7264  n_{filt_standard
+00031740: 7d5f 7073 6627 2c0a 2020 2020 2020 2020  }_psf',.        
+00031750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031760: 2020 2066 6f72 6d61 743d 2731 4527 2c0a     format='1E',.
+00031770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031780: 2020 2020 2020 2020 2020 2061 7272 6179             array
+00031790: 3d73 326e 2929 0a0a 2020 2020 6966 2065  =s2n))..    if e
+000317a0: 7874 696e 6374 696f 6e5f 6d61 7073 5f70  xtinction_maps_p
+000317b0: 6174 6820 6973 206e 6f74 204e 6f6e 653a  ath is not None:
+000317c0: 0a20 2020 2020 2020 2069 6620 6578 7469  .        if exti
+000317d0: 6e63 7469 6f6e 5f63 6f72 7265 6374 696f  nction_correctio
+000317e0: 6e2e 6c6f 7765 7228 2920 3d3d 2027 7363  n.lower() == 'sc
+000317f0: 686c 6567 656c 273a 0a0a 2020 2020 2020  hlegel':..      
+00031800: 2020 2020 2020 5241 203d 2063 6174 5f64        RA = cat_d
+00031810: 6174 612e 6c6f 635b 3a2c 2066 2752 415f  ata.loc[:, f'RA_
+00031820: 7b66 696c 745f 7374 616e 6461 7264 7d27  {filt_standard}'
+00031830: 5d2e 7661 6c75 6573 0a20 2020 2020 2020  ].values.       
+00031840: 2020 2020 2044 4543 203d 2063 6174 5f64       DEC = cat_d
+00031850: 6174 612e 6c6f 635b 3a2c 2066 2744 4543  ata.loc[:, f'DEC
+00031860: 5f7b 6669 6c74 5f73 7461 6e64 6172 647d  _{filt_standard}
+00031870: 275d 2e76 616c 7565 730a 0a20 2020 2020  '].values..     
+00031880: 2020 2020 2020 2045 4256 203d 2067 6574         EBV = get
+00031890: 5f45 4256 5f73 6368 6c65 6765 6c28 5241  _EBV_schlegel(RA
+000318a0: 2020 3d20 5241 2c0a 2020 2020 2020 2020    = RA,.        
+000318b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000318c0: 2020 2020 2020 2020 2020 2044 4543 203d             DEC =
+000318d0: 2044 4543 2c0a 2020 2020 2020 2020 2020   DEC,.          
+000318e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000318f0: 2020 2020 2020 2020 2065 6276 5f6d 6170           ebv_map
+00031900: 735f 7061 7468 203d 2065 7874 696e 6374  s_path = extinct
+00031910: 696f 6e5f 6d61 7073 5f70 6174 6829 0a0a  ion_maps_path)..
+00031920: 2020 2020 2020 2020 2020 2020 6361 742e              cat.
+00031930: 6170 7065 6e64 2866 6974 732e 436f 6c75  append(fits.Colu
+00031940: 6d6e 286e 616d 653d 6627 4542 565f 5343  mn(name=f'EBV_SC
+00031950: 4827 2c0a 2020 2020 2020 2020 2020 2020  H',.            
+00031960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031970: 2020 2020 2020 2066 6f72 6d61 743d 2731         format='1
+00031980: 4527 2c0a 2020 2020 2020 2020 2020 2020  E',.            
 00031990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000319a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000319b0: 2020 2066 6f72 6d61 743d 2731 4527 2c0a     format='1E',.
-000319c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000319d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000319e0: 2020 2061 7272 6179 3d45 4256 2929 0a0a     array=EBV))..
-000319f0: 2020 2020 2320 4765 6e65 7261 7465 2048      # Generate H
-00031a00: 4455 2066 726f 6d20 636f 6c75 6d6e 730a  DU from columns.
-00031a10: 2020 2020 6864 7520 3d20 6669 7473 2e42      hdu = fits.B
-00031a20: 696e 5461 626c 6548 4455 2e66 726f 6d5f  inTableHDU.from_
-00031a30: 636f 6c75 6d6e 7328 6361 7429 0a0a 2020  columns(cat)..  
-00031a40: 2020 2320 5361 7665 2048 4455 0a20 2020    # Save HDU.   
-00031a50: 2068 6475 2e77 7269 7465 746f 2873 6176   hdu.writeto(sav
-00031a60: 655f 6669 6c65 290a 0a64 6566 2063 6865  e_file)..def che
-00031a70: 636b 5f70 686f 746f 6d65 7472 7928 6669  ck_photometry(fi
-00031a80: 656c 642c 2073 6176 655f 7061 7468 2c20  eld, save_path, 
-00031a90: 7068 6f74 6f6d 6574 7279 2c20 6669 6c74  photometry, filt
-00031aa0: 6572 5f6c 6973 7429 3a0a 2020 2020 2222  er_list):.    ""
-00031ab0: 220a 2020 2020 4368 6563 6b73 2069 6620  ".    Checks if 
-00031ac0: 7068 6f74 6f6d 6574 7279 2068 6173 2062  photometry has b
-00031ad0: 6565 6e20 616c 7265 6164 7920 646f 6e65  een already done
-00031ae0: 2066 6f72 2061 2067 6976 656e 2066 6965   for a given fie
-00031af0: 6c64 0a0a 2020 2020 5061 7261 6d65 7465  ld..    Paramete
-00031b00: 7273 0a20 2020 202d 2d2d 2d2d 2d2d 2d2d  rs.    ---------
-00031b10: 2d0a 2020 2020 6669 656c 643a 2073 7472  -.    field: str
-00031b20: 0a20 2020 2020 2020 204e 616d 6520 6f66  .        Name of
-00031b30: 2074 6865 2053 2d50 4c55 5320 6669 656c   the S-PLUS fiel
-00031b40: 640a 2020 2020 7361 7665 5f70 6174 683a  d.    save_path:
-00031b50: 2073 7472 0a20 2020 2020 2020 2043 6f6e   str.        Con
-00031b60: 6669 6775 7261 7469 6f6e 2066 696c 6520  figuration file 
-00031b70: 2773 6176 655f 7061 7468 2720 7061 7261  'save_path' para
-00031b80: 6d65 7465 720a 2020 2020 7068 6f74 6f6d  meter.    photom
-00031b90: 6574 7279 3a20 7374 720a 2020 2020 2020  etry: str.      
-00031ba0: 2020 5068 6f74 6f6d 6574 7279 206d 6f64    Photometry mod
-00031bb0: 6520 2873 696e 676c 652c 2064 7561 6c2c  e (single, dual,
-00031bc0: 2070 7366 290a 2020 2020 6669 6c74 6572   psf).    filter
-00031bd0: 5f6c 6973 743a 206c 6973 740a 2020 2020  _list: list.    
-00031be0: 2020 2020 4c69 7374 206f 6620 532d 504c      List of S-PL
-00031bf0: 5553 2066 696c 7465 7273 0a0a 2020 2020  US filters..    
-00031c00: 5265 7475 726e 730a 2020 2020 2d2d 2d2d  Returns.    ----
-00031c10: 2d2d 2d0a 2020 2020 626f 6f6c 0a20 2020  ---.    bool.   
-00031c20: 2020 2020 2054 7275 6520 6966 2070 686f       True if pho
-00031c30: 746f 6d65 7472 7920 6973 2063 6f6d 706c  tometry is compl
-00031c40: 6574 2061 6e64 2046 616c 7365 2069 6620  et and False if 
-00031c50: 6e6f 740a 2020 2020 2222 220a 0a20 2020  not.    """..   
-00031c60: 2069 6620 7068 6f74 6f6d 6574 7279 2e6c   if photometry.l
-00031c70: 6f77 6572 2829 203d 3d20 2773 696e 676c  ower() == 'singl
-00031c80: 6527 3a0a 2020 2020 2020 2020 6368 6563  e':.        chec
-00031c90: 6b5f 6669 6c65 203d 206f 732e 7061 7468  k_file = os.path
-00031ca0: 2e6a 6f69 6e28 7361 7665 5f70 6174 682c  .join(save_path,
-00031cb0: 2027 7b66 6965 6c64 7d27 2c20 2750 686f   '{field}', 'Pho
-00031cc0: 746f 6d65 7472 7927 2c0a 2020 2020 2020  tometry',.      
+000319a0: 2020 2020 2020 2061 7272 6179 3d45 4256         array=EBV
+000319b0: 2929 0a0a 2020 2020 2320 4765 6e65 7261  ))..    # Genera
+000319c0: 7465 2048 4455 2066 726f 6d20 636f 6c75  te HDU from colu
+000319d0: 6d6e 730a 2020 2020 6864 7520 3d20 6669  mns.    hdu = fi
+000319e0: 7473 2e42 696e 5461 626c 6548 4455 2e66  ts.BinTableHDU.f
+000319f0: 726f 6d5f 636f 6c75 6d6e 7328 6361 7429  rom_columns(cat)
+00031a00: 0a0a 2020 2020 2320 5361 7665 2048 4455  ..    # Save HDU
+00031a10: 0a20 2020 2068 6475 2e77 7269 7465 746f  .    hdu.writeto
+00031a20: 2873 6176 655f 6669 6c65 290a 0a64 6566  (save_file)..def
+00031a30: 2063 6865 636b 5f70 686f 746f 6d65 7472   check_photometr
+00031a40: 7928 6669 656c 642c 2073 6176 655f 7061  y(field, save_pa
+00031a50: 7468 2c20 7068 6f74 6f6d 6574 7279 2c20  th, photometry, 
+00031a60: 6669 6c74 6572 5f6c 6973 7429 3a0a 2020  filter_list):.  
+00031a70: 2020 2222 220a 2020 2020 4368 6563 6b73    """.    Checks
+00031a80: 2069 6620 7068 6f74 6f6d 6574 7279 2068   if photometry h
+00031a90: 6173 2062 6565 6e20 616c 7265 6164 7920  as been already 
+00031aa0: 646f 6e65 2066 6f72 2061 2067 6976 656e  done for a given
+00031ab0: 2066 6965 6c64 0a0a 2020 2020 5061 7261   field..    Para
+00031ac0: 6d65 7465 7273 0a20 2020 202d 2d2d 2d2d  meters.    -----
+00031ad0: 2d2d 2d2d 2d0a 2020 2020 6669 656c 643a  -----.    field:
+00031ae0: 2073 7472 0a20 2020 2020 2020 204e 616d   str.        Nam
+00031af0: 6520 6f66 2074 6865 2053 2d50 4c55 5320  e of the S-PLUS 
+00031b00: 6669 656c 640a 2020 2020 7361 7665 5f70  field.    save_p
+00031b10: 6174 683a 2073 7472 0a20 2020 2020 2020  ath: str.       
+00031b20: 2043 6f6e 6669 6775 7261 7469 6f6e 2066   Configuration f
+00031b30: 696c 6520 2773 6176 655f 7061 7468 2720  ile 'save_path' 
+00031b40: 7061 7261 6d65 7465 720a 2020 2020 7068  parameter.    ph
+00031b50: 6f74 6f6d 6574 7279 3a20 7374 720a 2020  otometry: str.  
+00031b60: 2020 2020 2020 5068 6f74 6f6d 6574 7279        Photometry
+00031b70: 206d 6f64 6520 2873 696e 676c 652c 2064   mode (single, d
+00031b80: 7561 6c2c 2070 7366 290a 2020 2020 6669  ual, psf).    fi
+00031b90: 6c74 6572 5f6c 6973 743a 206c 6973 740a  lter_list: list.
+00031ba0: 2020 2020 2020 2020 4c69 7374 206f 6620          List of 
+00031bb0: 532d 504c 5553 2066 696c 7465 7273 0a0a  S-PLUS filters..
+00031bc0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00031bd0: 2d2d 2d2d 2d2d 2d0a 2020 2020 626f 6f6c  -------.    bool
+00031be0: 0a20 2020 2020 2020 2054 7275 6520 6966  .        True if
+00031bf0: 2070 686f 746f 6d65 7472 7920 6973 2063   photometry is c
+00031c00: 6f6d 706c 6574 2061 6e64 2046 616c 7365  omplet and False
+00031c10: 2069 6620 6e6f 740a 2020 2020 2222 220a   if not.    """.
+00031c20: 0a20 2020 2069 6620 7068 6f74 6f6d 6574  .    if photomet
+00031c30: 7279 2e6c 6f77 6572 2829 203d 3d20 2773  ry.lower() == 's
+00031c40: 696e 676c 6527 3a0a 2020 2020 2020 2020  ingle':.        
+00031c50: 6368 6563 6b5f 6669 6c65 203d 206f 732e  check_file = os.
+00031c60: 7061 7468 2e6a 6f69 6e28 7361 7665 5f70  path.join(save_p
+00031c70: 6174 682c 2027 7b66 6965 6c64 7d27 2c20  ath, '{field}', 
+00031c80: 2750 686f 746f 6d65 7472 7927 2c0a 2020  'Photometry',.  
+00031c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031cb0: 2773 696e 676c 6527 2c20 2763 6174 616c  'single', 'catal
+00031cc0: 6f67 7327 2c0a 2020 2020 2020 2020 2020  ogs',.          
 00031cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031ce0: 2020 2020 2020 2020 2020 2020 2773 696e              'sin
-00031cf0: 676c 6527 2c20 2763 6174 616c 6f67 7327  gle', 'catalogs'
-00031d00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00031d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031d20: 2020 2020 2773 6578 5f7b 6669 656c 647d      'sex_{field}
-00031d30: 5f7b 6669 6c74 7d5f 7369 6e67 6c65 2e66  _{filt}_single.f
-00031d40: 6974 7327 290a 0a20 2020 2065 6c69 6620  its')..    elif 
-00031d50: 7068 6f74 6f6d 6574 7279 2e6c 6f77 6572  photometry.lower
-00031d60: 2829 203d 3d20 2764 7561 6c27 3a0a 2020  () == 'dual':.  
-00031d70: 2020 2020 2020 6368 6563 6b5f 6669 6c65        check_file
-00031d80: 203d 206f 732e 7061 7468 2e6a 6f69 6e28   = os.path.join(
-00031d90: 7361 7665 5f70 6174 682c 2027 7b66 6965  save_path, '{fie
-00031da0: 6c64 7d27 2c20 2750 686f 746f 6d65 7472  ld}', 'Photometr
-00031db0: 7927 2c0a 2020 2020 2020 2020 2020 2020  y',.            
+00031ce0: 2020 2020 2020 2020 2773 6578 5f7b 6669          'sex_{fi
+00031cf0: 656c 647d 5f7b 6669 6c74 7d5f 7369 6e67  eld}_{filt}_sing
+00031d00: 6c65 2e66 6974 7327 290a 0a20 2020 2065  le.fits')..    e
+00031d10: 6c69 6620 7068 6f74 6f6d 6574 7279 2e6c  lif photometry.l
+00031d20: 6f77 6572 2829 203d 3d20 2764 7561 6c27  ower() == 'dual'
+00031d30: 3a0a 2020 2020 2020 2020 6368 6563 6b5f  :.        check_
+00031d40: 6669 6c65 203d 206f 732e 7061 7468 2e6a  file = os.path.j
+00031d50: 6f69 6e28 7361 7665 5f70 6174 682c 2027  oin(save_path, '
+00031d60: 7b66 6965 6c64 7d27 2c20 2750 686f 746f  {field}', 'Photo
+00031d70: 6d65 7472 7927 2c0a 2020 2020 2020 2020  metry',.        
+00031d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031d90: 2020 2020 2020 2020 2020 2764 7561 6c27            'dual'
+00031da0: 2c20 2763 6174 616c 6f67 7327 2c0a 2020  , 'catalogs',.  
+00031db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00031dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031dd0: 2020 2020 2020 2764 7561 6c27 2c20 2763        'dual', 'c
-00031de0: 6174 616c 6f67 7327 2c0a 2020 2020 2020  atalogs',.      
-00031df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031e00: 2020 2020 2020 2020 2020 2020 2773 6578              'sex
-00031e10: 5f7b 6669 656c 647d 5f7b 6669 6c74 7d5f  _{field}_{filt}_
-00031e20: 6475 616c 2e66 6974 7327 290a 0a20 2020  dual.fits')..   
-00031e30: 2065 6c69 6620 7068 6f74 6f6d 6574 7279   elif photometry
-00031e40: 2e6c 6f77 6572 2829 203d 3d20 2770 7366  .lower() == 'psf
-00031e50: 273a 0a20 2020 2020 2020 2063 6865 636b  ':.        check
-00031e60: 5f66 696c 6520 3d20 6f73 2e70 6174 682e  _file = os.path.
-00031e70: 6a6f 696e 2873 6176 655f 7061 7468 2c20  join(save_path, 
-00031e80: 277b 6669 656c 647d 272c 2027 5068 6f74  '{field}', 'Phot
-00031e90: 6f6d 6574 7279 272c 0a20 2020 2020 2020  ometry',.       
+00031dd0: 2773 6578 5f7b 6669 656c 647d 5f7b 6669  'sex_{field}_{fi
+00031de0: 6c74 7d5f 6475 616c 2e66 6974 7327 290a  lt}_dual.fits').
+00031df0: 0a20 2020 2065 6c69 6620 7068 6f74 6f6d  .    elif photom
+00031e00: 6574 7279 2e6c 6f77 6572 2829 203d 3d20  etry.lower() == 
+00031e10: 2770 7366 273a 0a20 2020 2020 2020 2063  'psf':.        c
+00031e20: 6865 636b 5f66 696c 6520 3d20 6f73 2e70  heck_file = os.p
+00031e30: 6174 682e 6a6f 696e 2873 6176 655f 7061  ath.join(save_pa
+00031e40: 7468 2c20 277b 6669 656c 647d 272c 2027  th, '{field}', '
+00031e50: 5068 6f74 6f6d 6574 7279 272c 0a20 2020  Photometry',.   
+00031e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031e70: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00031e80: 7073 6627 2c20 2763 6174 616c 6f67 7327  psf', 'catalogs'
+00031e90: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00031ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031eb0: 2020 2020 2020 2020 2020 2027 7073 6627             'psf'
-00031ec0: 2c20 2763 6174 616c 6f67 7327 2c0a 2020  , 'catalogs',.  
-00031ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031ef0: 277b 6669 656c 647d 5f7b 6669 6c74 7d5f  '{field}_{filt}_
-00031f00: 7073 662e 6361 7427 290a 0a20 2020 2065  psf.cat')..    e
-00031f10: 6c73 653a 0a20 2020 2020 2020 2072 6169  lse:.        rai
-00031f20: 7365 2056 616c 7565 4572 726f 7228 6622  se ValueError(f"
-00031f30: 556e 7375 7070 6f72 7465 6420 7068 6f74  Unsupported phot
-00031f40: 6f6d 6574 7279 206d 6f64 653a 207b 7068  ometry mode: {ph
-00031f50: 6f74 6f6d 6574 7279 7d22 290a 0a20 2020  otometry}")..   
-00031f60: 2068 6173 5f61 6c6c 5f70 686f 746f 6d65   has_all_photome
-00031f70: 7472 7920 3d20 5472 7565 0a0a 2020 2020  try = True..    
-00031f80: 666f 7220 6669 6c74 2069 6e20 6669 6c74  for filt in filt
-00031f90: 6572 5f6c 6973 743a 0a20 2020 2020 2020  er_list:.       
-00031fa0: 2066 696c 745f 6669 6c65 203d 2063 6865   filt_file = che
-00031fb0: 636b 5f66 696c 652e 666f 726d 6174 2866  ck_file.format(f
-00031fc0: 6965 6c64 203d 2066 6965 6c64 2c20 6669  ield = field, fi
-00031fd0: 6c74 203d 2066 696c 7429 0a0a 2020 2020  lt = filt)..    
-00031fe0: 2020 2020 6966 206e 6f74 206f 732e 7061      if not os.pa
-00031ff0: 7468 2e65 7869 7374 7328 6669 6c74 5f66  th.exists(filt_f
-00032000: 696c 6529 3a0a 2020 2020 2020 2020 2020  ile):.          
-00032010: 2020 6861 735f 616c 6c5f 7068 6f74 6f6d    has_all_photom
-00032020: 6574 7279 203d 2046 616c 7365 0a0a 2020  etry = False..  
-00032030: 2020 7265 7475 726e 2068 6173 5f61 6c6c    return has_all
-00032040: 5f70 686f 746f 6d65 7472 790a 0a0a 2320  _photometry...# 
-00032050: 4372 6561 7465 2033 3220 6170 6572 2063  Create 32 aper c
-00032060: 6174 616c 6f67 730a 6465 6620 7365 7863  atalogs.def sexc
-00032070: 6174 616c 6f67 5f61 7070 6c79 5f63 616c  atalog_apply_cal
-00032080: 6962 7261 7469 6f6e 5f61 7065 7228 6361  ibration_aper(ca
-00032090: 7461 6c6f 675f 6669 6c65 2c20 7a70 5f66  talog_file, zp_f
-000320a0: 696c 652c 2073 6176 655f 6669 6c65 2c0a  ile, save_file,.
+00031eb0: 2020 2020 277b 6669 656c 647d 5f7b 6669      '{field}_{fi
+00031ec0: 6c74 7d5f 7073 662e 6361 7427 290a 0a20  lt}_psf.cat').. 
+00031ed0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00031ee0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00031ef0: 7228 6622 556e 7375 7070 6f72 7465 6420  r(f"Unsupported 
+00031f00: 7068 6f74 6f6d 6574 7279 206d 6f64 653a  photometry mode:
+00031f10: 207b 7068 6f74 6f6d 6574 7279 7d22 290a   {photometry}").
+00031f20: 0a20 2020 2068 6173 5f61 6c6c 5f70 686f  .    has_all_pho
+00031f30: 746f 6d65 7472 7920 3d20 5472 7565 0a0a  tometry = True..
+00031f40: 2020 2020 666f 7220 6669 6c74 2069 6e20      for filt in 
+00031f50: 6669 6c74 6572 5f6c 6973 743a 0a20 2020  filter_list:.   
+00031f60: 2020 2020 2066 696c 745f 6669 6c65 203d       filt_file =
+00031f70: 2063 6865 636b 5f66 696c 652e 666f 726d   check_file.form
+00031f80: 6174 2866 6965 6c64 203d 2066 6965 6c64  at(field = field
+00031f90: 2c20 6669 6c74 203d 2066 696c 7429 0a0a  , filt = filt)..
+00031fa0: 2020 2020 2020 2020 6966 206e 6f74 206f          if not o
+00031fb0: 732e 7061 7468 2e65 7869 7374 7328 6669  s.path.exists(fi
+00031fc0: 6c74 5f66 696c 6529 3a0a 2020 2020 2020  lt_file):.      
+00031fd0: 2020 2020 2020 6861 735f 616c 6c5f 7068        has_all_ph
+00031fe0: 6f74 6f6d 6574 7279 203d 2046 616c 7365  otometry = False
+00031ff0: 0a0a 2020 2020 7265 7475 726e 2068 6173  ..    return has
+00032000: 5f61 6c6c 5f70 686f 746f 6d65 7472 790a  _all_photometry.
+00032010: 0a0a 2320 4372 6561 7465 2033 3220 6170  ..# Create 32 ap
+00032020: 6572 2063 6174 616c 6f67 730a 6465 6620  er catalogs.def 
+00032030: 7365 7863 6174 616c 6f67 5f61 7070 6c79  sexcatalog_apply
+00032040: 5f63 616c 6962 7261 7469 6f6e 5f61 7065  _calibration_ape
+00032050: 7228 6361 7461 6c6f 675f 6669 6c65 2c20  r(catalog_file, 
+00032060: 7a70 5f66 696c 652c 2073 6176 655f 6669  zp_file, save_fi
+00032070: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
+00032080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032090: 2020 2020 2066 696c 7465 725f 6e61 6d65       filter_name
+000320a0: 2c20 7365 785f 6d61 675f 7a70 2c0a 2020  , sex_mag_zp,.  
 000320b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000320c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000320d0: 2066 696c 7465 725f 6e61 6d65 2c20 7365   filter_name, se
-000320e0: 785f 6d61 675f 7a70 2c0a 2020 2020 2020  x_mag_zp,.      
-000320f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032100: 2020 2020 2020 2020 2020 206d 6f64 6520             mode 
-00032110: 3d20 2764 7561 6c27 2c20 6669 656c 6420  = 'dual', field 
-00032120: 3d20 274e 6f46 6965 6c64 4e61 6d65 272c  = 'NoFieldName',
-00032130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032150: 2020 6472 6e61 6d65 203d 2027 4e6f 4452    drname = 'NoDR
-00032160: 6e61 6d65 2729 3a0a 0a20 2020 2023 204c  name'):..    # L
-00032170: 6f61 6420 7068 6f74 6f6d 6574 7279 2063  oad photometry c
-00032180: 6174 616c 6f67 2028 7769 7468 2061 7065  atalog (with ape
-00032190: 7274 7572 6520 636f 7272 6563 7469 6f6e  rture correction
-000321a0: 290a 2020 2020 7068 6f74 5f63 6174 203d  ).    phot_cat =
-000321b0: 2066 6974 732e 6f70 656e 2863 6174 616c   fits.open(catal
-000321c0: 6f67 5f66 696c 6529 0a20 2020 2070 686f  og_file).    pho
-000321d0: 745f 6361 7420 3d20 7068 6f74 5f63 6174  t_cat = phot_cat
-000321e0: 5b31 5d2e 6461 7461 0a0a 2020 2020 4e5f  [1].data..    N_
-000321f0: 736f 7572 6365 7320 3d20 6c65 6e28 7068  sources = len(ph
-00032200: 6f74 5f63 6174 290a 0a20 2020 2023 204c  ot_cat)..    # L
-00032210: 6f61 6420 5a50 0a20 2020 205a 5073 203d  oad ZP.    ZPs =
-00032220: 207a 705f 7265 6164 287a 705f 6669 6c65   zp_read(zp_file
-00032230: 290a 2020 2020 5a50 203d 205a 5073 5b66  ).    ZP = ZPs[f
-00032240: 2753 504c 5553 5f7b 6669 6c74 6572 5f6e  'SPLUS_{filter_n
-00032250: 616d 657d 275d 0a0a 2020 2020 2320 5374  ame}']..    # St
-00032260: 616e 6461 7264 2066 696c 7465 7220 6e61  andard filter na
-00032270: 6d65 0a20 2020 2066 696c 745f 7374 616e  me.    filt_stan
-00032280: 6461 7264 203d 2074 7261 6e73 6c61 7465  dard = translate
-00032290: 5f66 696c 7465 725f 7374 616e 6461 7264  _filter_standard
-000322a0: 2866 696c 7465 725f 6e61 6d65 290a 0a20  (filter_name).. 
-000322b0: 2020 2023 2043 7265 6174 6520 6e65 7720     # Create new 
-000322c0: 6461 7461 2054 6162 6c65 0a20 2020 2063  data Table.    c
-000322d0: 6174 203d 205b 5d0a 0a20 2020 2023 2046  at = []..    # F
-000322e0: 4945 4c44 2049 440a 2020 2020 7068 6f74  IELD ID.    phot
-000322f0: 5f63 6174 2e63 6f6c 756d 6e73 5b66 2746  _cat.columns[f'F
-00032300: 4945 4c44 5f49 4427 5d2e 6e61 6d65 203d  IELD_ID'].name =
-00032310: 2066 2749 4427 0a20 2020 2063 6174 2e61   f'ID'.    cat.a
-00032320: 7070 656e 6428 7068 6f74 5f63 6174 2e63  ppend(phot_cat.c
-00032330: 6f6c 756d 6e73 5b66 2749 4427 5d29 0a20  olumns[f'ID']). 
-00032340: 2020 2070 686f 745f 6361 742e 636f 6c75     phot_cat.colu
-00032350: 6d6e 735b 6627 4649 454c 445f 4944 5f52  mns[f'FIELD_ID_R
-00032360: 4127 5d2e 6e61 6d65 203d 2066 2749 445f  A'].name = f'ID_
-00032370: 5241 270a 2020 2020 6361 742e 6170 7065  RA'.    cat.appe
-00032380: 6e64 2870 686f 745f 6361 742e 636f 6c75  nd(phot_cat.colu
-00032390: 6d6e 735b 6627 4944 5f52 4127 5d29 0a20  mns[f'ID_RA']). 
-000323a0: 2020 2070 686f 745f 6361 742e 636f 6c75     phot_cat.colu
-000323b0: 6d6e 735b 6627 4649 454c 445f 4944 5f44  mns[f'FIELD_ID_D
-000323c0: 4543 275d 2e6e 616d 6520 3d20 6627 4944  EC'].name = f'ID
-000323d0: 5f44 4543 270a 2020 2020 6361 742e 6170  _DEC'.    cat.ap
-000323e0: 7065 6e64 2870 686f 745f 6361 742e 636f  pend(phot_cat.co
-000323f0: 6c75 6d6e 735b 6627 4944 5f44 4543 275d  lumns[f'ID_DEC']
-00032400: 290a 0a0a 2020 2020 2320 4164 6420 5048  )...    # Add PH
-00032410: 4f54 2049 4473 0a20 2020 2069 6620 6d6f  OT IDs.    if mo
-00032420: 6465 203d 3d20 2264 7561 6c22 3a0a 2020  de == "dual":.  
-00032430: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
-00032440: 2870 686f 745f 6361 742e 636f 6c75 6d6e  (phot_cat.column
-00032450: 735b 6627 5048 4f54 5f49 445f 6475 616c  s[f'PHOT_ID_dual
-00032460: 275d 290a 2020 2020 2020 2020 6361 742e  ']).        cat.
-00032470: 6170 7065 6e64 2870 686f 745f 6361 742e  append(phot_cat.
-00032480: 636f 6c75 6d6e 735b 6627 5048 4f54 5f49  columns[f'PHOT_I
-00032490: 445f 5241 5f64 7561 6c27 5d29 0a20 2020  D_RA_dual']).   
-000324a0: 2020 2020 2063 6174 2e61 7070 656e 6428       cat.append(
-000324b0: 7068 6f74 5f63 6174 2e63 6f6c 756d 6e73  phot_cat.columns
-000324c0: 5b66 2750 484f 545f 4944 5f44 4543 5f64  [f'PHOT_ID_DEC_d
-000324d0: 7561 6c27 5d29 0a0a 2020 2020 2020 2020  ual'])..        
-000324e0: 6361 742e 6170 7065 6e64 2866 6974 732e  cat.append(fits.
-000324f0: 436f 6c75 6d6e 286e 616d 653d 6627 7b66  Column(name=f'{f
-00032500: 696c 745f 7374 616e 6461 7264 7d5f 4944  ilt_standard}_ID
-00032510: 5f64 7561 6c27 2c0a 2020 2020 2020 2020  _dual',.        
-00032520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032530: 2020 2020 2020 2066 6f72 6d61 743d 2735         format='5
-00032540: 3041 272c 0a20 2020 2020 2020 2020 2020  0A',.           
-00032550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032560: 2020 2020 6172 7261 793d 7068 6f74 5f63      array=phot_c
-00032570: 6174 2e63 6f6c 756d 6e73 5b66 2750 484f  at.columns[f'PHO
-00032580: 545f 4944 5f64 7561 6c27 5d2e 6172 7261  T_ID_dual'].arra
-00032590: 7929 290a 0a20 2020 2065 6c69 6620 6d6f  y))..    elif mo
-000325a0: 6465 203d 3d20 2273 696e 676c 6522 3a0a  de == "single":.
-000325b0: 2020 2020 2020 2020 6361 742e 6170 7065          cat.appe
-000325c0: 6e64 2870 686f 745f 6361 742e 636f 6c75  nd(phot_cat.colu
-000325d0: 6d6e 735b 6627 5048 4f54 5f49 445f 7369  mns[f'PHOT_ID_si
-000325e0: 6e67 6c65 275d 290a 2020 2020 2020 2020  ngle']).        
-000325f0: 6361 742e 6170 7065 6e64 2870 686f 745f  cat.append(phot_
-00032600: 6361 742e 636f 6c75 6d6e 735b 6627 5048  cat.columns[f'PH
-00032610: 4f54 5f49 445f 5241 5f73 696e 676c 6527  OT_ID_RA_single'
-00032620: 5d29 0a20 2020 2020 2020 2063 6174 2e61  ]).        cat.a
-00032630: 7070 656e 6428 7068 6f74 5f63 6174 2e63  ppend(phot_cat.c
-00032640: 6f6c 756d 6e73 5b66 2750 484f 545f 4944  olumns[f'PHOT_ID
-00032650: 5f44 4543 5f73 696e 676c 6527 5d29 0a0a  _DEC_single'])..
-00032660: 2020 2020 2020 2020 6361 742e 6170 7065          cat.appe
-00032670: 6e64 2870 686f 745f 6361 742e 636f 6c75  nd(phot_cat.colu
-00032680: 6d6e 735b 6627 7b66 696c 745f 7374 616e  mns[f'{filt_stan
-00032690: 6461 7264 7d5f 4944 5f73 696e 676c 6527  dard}_ID_single'
-000326a0: 5d29 0a0a 0a20 2020 2069 6620 6d6f 6465  ])...    if mode
-000326b0: 203d 3d20 2273 696e 676c 6522 3a0a 2020   == "single":.  
+000320c0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000320d0: 6f64 6520 3d20 2764 7561 6c27 2c20 6669  ode = 'dual', fi
+000320e0: 656c 6420 3d20 274e 6f46 6965 6c64 4e61  eld = 'NoFieldNa
+000320f0: 6d65 272c 0a20 2020 2020 2020 2020 2020  me',.           
+00032100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032110: 2020 2020 2020 6472 6e61 6d65 203d 2027        drname = '
+00032120: 4e6f 4452 6e61 6d65 2729 3a0a 0a20 2020  NoDRname'):..   
+00032130: 2023 204c 6f61 6420 7068 6f74 6f6d 6574   # Load photomet
+00032140: 7279 2063 6174 616c 6f67 2028 7769 7468  ry catalog (with
+00032150: 2061 7065 7274 7572 6520 636f 7272 6563   aperture correc
+00032160: 7469 6f6e 290a 2020 2020 7068 6f74 5f63  tion).    phot_c
+00032170: 6174 203d 2066 6974 732e 6f70 656e 2863  at = fits.open(c
+00032180: 6174 616c 6f67 5f66 696c 6529 0a20 2020  atalog_file).   
+00032190: 2070 686f 745f 6361 7420 3d20 7068 6f74   phot_cat = phot
+000321a0: 5f63 6174 5b31 5d2e 6461 7461 0a0a 2020  _cat[1].data..  
+000321b0: 2020 4e5f 736f 7572 6365 7320 3d20 6c65    N_sources = le
+000321c0: 6e28 7068 6f74 5f63 6174 290a 0a20 2020  n(phot_cat)..   
+000321d0: 2023 204c 6f61 6420 5a50 0a20 2020 205a   # Load ZP.    Z
+000321e0: 5073 203d 207a 705f 7265 6164 287a 705f  Ps = zp_read(zp_
+000321f0: 6669 6c65 290a 2020 2020 5a50 203d 205a  file).    ZP = Z
+00032200: 5073 5b66 2753 504c 5553 5f7b 6669 6c74  Ps[f'SPLUS_{filt
+00032210: 6572 5f6e 616d 657d 275d 0a0a 2020 2020  er_name}']..    
+00032220: 2320 5374 616e 6461 7264 2066 696c 7465  # Standard filte
+00032230: 7220 6e61 6d65 0a20 2020 2066 696c 745f  r name.    filt_
+00032240: 7374 616e 6461 7264 203d 2074 7261 6e73  standard = trans
+00032250: 6c61 7465 5f66 696c 7465 725f 7374 616e  late_filter_stan
+00032260: 6461 7264 2866 696c 7465 725f 6e61 6d65  dard(filter_name
+00032270: 290a 0a20 2020 2023 2043 7265 6174 6520  )..    # Create 
+00032280: 6e65 7720 6461 7461 2054 6162 6c65 0a20  new data Table. 
+00032290: 2020 2063 6174 203d 205b 5d0a 0a20 2020     cat = []..   
+000322a0: 2023 2046 4945 4c44 2049 440a 2020 2020   # FIELD ID.    
+000322b0: 7068 6f74 5f63 6174 2e63 6f6c 756d 6e73  phot_cat.columns
+000322c0: 5b66 2746 4945 4c44 5f49 4427 5d2e 6e61  [f'FIELD_ID'].na
+000322d0: 6d65 203d 2066 2749 4427 0a20 2020 2063  me = f'ID'.    c
+000322e0: 6174 2e61 7070 656e 6428 7068 6f74 5f63  at.append(phot_c
+000322f0: 6174 2e63 6f6c 756d 6e73 5b66 2749 4427  at.columns[f'ID'
+00032300: 5d29 0a20 2020 2070 686f 745f 6361 742e  ]).    phot_cat.
+00032310: 636f 6c75 6d6e 735b 6627 4649 454c 445f  columns[f'FIELD_
+00032320: 4944 5f52 4127 5d2e 6e61 6d65 203d 2066  ID_RA'].name = f
+00032330: 2749 445f 5241 270a 2020 2020 6361 742e  'ID_RA'.    cat.
+00032340: 6170 7065 6e64 2870 686f 745f 6361 742e  append(phot_cat.
+00032350: 636f 6c75 6d6e 735b 6627 4944 5f52 4127  columns[f'ID_RA'
+00032360: 5d29 0a20 2020 2070 686f 745f 6361 742e  ]).    phot_cat.
+00032370: 636f 6c75 6d6e 735b 6627 4649 454c 445f  columns[f'FIELD_
+00032380: 4944 5f44 4543 275d 2e6e 616d 6520 3d20  ID_DEC'].name = 
+00032390: 6627 4944 5f44 4543 270a 2020 2020 6361  f'ID_DEC'.    ca
+000323a0: 742e 6170 7065 6e64 2870 686f 745f 6361  t.append(phot_ca
+000323b0: 742e 636f 6c75 6d6e 735b 6627 4944 5f44  t.columns[f'ID_D
+000323c0: 4543 275d 290a 0a0a 2020 2020 2320 4164  EC'])...    # Ad
+000323d0: 6420 5048 4f54 2049 4473 0a20 2020 2069  d PHOT IDs.    i
+000323e0: 6620 6d6f 6465 203d 3d20 2264 7561 6c22  f mode == "dual"
+000323f0: 3a0a 2020 2020 2020 2020 6361 742e 6170  :.        cat.ap
+00032400: 7065 6e64 2870 686f 745f 6361 742e 636f  pend(phot_cat.co
+00032410: 6c75 6d6e 735b 6627 5048 4f54 5f49 445f  lumns[f'PHOT_ID_
+00032420: 6475 616c 275d 290a 2020 2020 2020 2020  dual']).        
+00032430: 6361 742e 6170 7065 6e64 2870 686f 745f  cat.append(phot_
+00032440: 6361 742e 636f 6c75 6d6e 735b 6627 5048  cat.columns[f'PH
+00032450: 4f54 5f49 445f 5241 5f64 7561 6c27 5d29  OT_ID_RA_dual'])
+00032460: 0a20 2020 2020 2020 2063 6174 2e61 7070  .        cat.app
+00032470: 656e 6428 7068 6f74 5f63 6174 2e63 6f6c  end(phot_cat.col
+00032480: 756d 6e73 5b66 2750 484f 545f 4944 5f44  umns[f'PHOT_ID_D
+00032490: 4543 5f64 7561 6c27 5d29 0a0a 2020 2020  EC_dual'])..    
+000324a0: 2020 2020 6361 742e 6170 7065 6e64 2866      cat.append(f
+000324b0: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
+000324c0: 6627 7b66 696c 745f 7374 616e 6461 7264  f'{filt_standard
+000324d0: 7d5f 4944 5f64 7561 6c27 2c0a 2020 2020  }_ID_dual',.    
+000324e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000324f0: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+00032500: 743d 2735 3041 272c 0a20 2020 2020 2020  t='50A',.       
+00032510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032520: 2020 2020 2020 2020 6172 7261 793d 7068          array=ph
+00032530: 6f74 5f63 6174 2e63 6f6c 756d 6e73 5b66  ot_cat.columns[f
+00032540: 2750 484f 545f 4944 5f64 7561 6c27 5d2e  'PHOT_ID_dual'].
+00032550: 6172 7261 7929 290a 0a20 2020 2065 6c69  array))..    eli
+00032560: 6620 6d6f 6465 203d 3d20 2273 696e 676c  f mode == "singl
+00032570: 6522 3a0a 2020 2020 2020 2020 6361 742e  e":.        cat.
+00032580: 6170 7065 6e64 2870 686f 745f 6361 742e  append(phot_cat.
+00032590: 636f 6c75 6d6e 735b 6627 5048 4f54 5f49  columns[f'PHOT_I
+000325a0: 445f 7369 6e67 6c65 275d 290a 2020 2020  D_single']).    
+000325b0: 2020 2020 6361 742e 6170 7065 6e64 2870      cat.append(p
+000325c0: 686f 745f 6361 742e 636f 6c75 6d6e 735b  hot_cat.columns[
+000325d0: 6627 5048 4f54 5f49 445f 5241 5f73 696e  f'PHOT_ID_RA_sin
+000325e0: 676c 6527 5d29 0a20 2020 2020 2020 2063  gle']).        c
+000325f0: 6174 2e61 7070 656e 6428 7068 6f74 5f63  at.append(phot_c
+00032600: 6174 2e63 6f6c 756d 6e73 5b66 2750 484f  at.columns[f'PHO
+00032610: 545f 4944 5f44 4543 5f73 696e 676c 6527  T_ID_DEC_single'
+00032620: 5d29 0a0a 2020 2020 2020 2020 6361 742e  ])..        cat.
+00032630: 6170 7065 6e64 2870 686f 745f 6361 742e  append(phot_cat.
+00032640: 636f 6c75 6d6e 735b 6627 7b66 696c 745f  columns[f'{filt_
+00032650: 7374 616e 6461 7264 7d5f 4944 5f73 696e  standard}_ID_sin
+00032660: 676c 6527 5d29 0a0a 0a20 2020 2069 6620  gle'])...    if 
+00032670: 6d6f 6465 203d 3d20 2273 696e 676c 6522  mode == "single"
+00032680: 3a0a 2020 2020 2020 2020 6361 742e 6170  :.        cat.ap
+00032690: 7065 6e64 2870 686f 745f 6361 742e 636f  pend(phot_cat.co
+000326a0: 6c75 6d6e 735b 6622 5241 5f7b 6669 6c74  lumns[f"RA_{filt
+000326b0: 5f73 7461 6e64 6172 647d 225d 290a 2020  _standard}"]).  
 000326c0: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
 000326d0: 2870 686f 745f 6361 742e 636f 6c75 6d6e  (phot_cat.column
-000326e0: 735b 6622 5241 5f7b 6669 6c74 5f73 7461  s[f"RA_{filt_sta
-000326f0: 6e64 6172 647d 225d 290a 2020 2020 2020  ndard}"]).      
-00032700: 2020 6361 742e 6170 7065 6e64 2870 686f    cat.append(pho
-00032710: 745f 6361 742e 636f 6c75 6d6e 735b 6622  t_cat.columns[f"
-00032720: 4445 435f 7b66 696c 745f 7374 616e 6461  DEC_{filt_standa
-00032730: 7264 7d22 5d29 0a20 2020 2065 6c69 6620  rd}"]).    elif 
-00032740: 6d6f 6465 203d 3d20 2264 7561 6c22 3a0a  mode == "dual":.
-00032750: 2020 2020 2020 2020 7068 6f74 5f63 6174          phot_cat
-00032760: 2e63 6f6c 756d 6e73 5b27 414c 5048 415f  .columns['ALPHA_
-00032770: 4a32 3030 3027 5d2e 6e61 6d65 203d 2027  J2000'].name = '
-00032780: 5241 270a 2020 2020 2020 2020 6361 742e  RA'.        cat.
-00032790: 6170 7065 6e64 2870 686f 745f 6361 742e  append(phot_cat.
-000327a0: 636f 6c75 6d6e 735b 2752 4127 5d29 0a20  columns['RA']). 
-000327b0: 2020 2020 2020 2070 686f 745f 6361 742e         phot_cat.
-000327c0: 636f 6c75 6d6e 735b 2744 454c 5441 5f4a  columns['DELTA_J
-000327d0: 3230 3030 275d 2e6e 616d 6520 3d20 2744  2000'].name = 'D
-000327e0: 4543 270a 2020 2020 2020 2020 6361 742e  EC'.        cat.
-000327f0: 6170 7065 6e64 2870 686f 745f 6361 742e  append(phot_cat.
-00032800: 636f 6c75 6d6e 735b 2744 4543 275d 290a  columns['DEC']).
-00032810: 0a20 2020 206e 636f 6c73 203d 2070 686f  .    ncols = pho
-00032820: 745f 6361 742e 636f 6c75 6d6e 735b 6622  t_cat.columns[f"
-00032830: 4d41 475f 4150 4552 225d 2e61 7272 6179  MAG_APER"].array
-00032840: 2e73 6861 7065 5b31 5d0a 0a20 2020 2066  .shape[1]..    f
-00032850: 6f72 2069 2069 6e20 7261 6e67 6528 6e63  or i in range(nc
-00032860: 6f6c 7329 3a0a 0a20 2020 2020 2020 2066  ols):..        f
-00032870: 6d74 203d 2027 3145 270a 2020 2020 2020  mt = '1E'.      
-00032880: 2020 6620 3d20 7068 6f74 5f63 6174 2e63    f = phot_cat.c
-00032890: 6f6c 756d 6e73 5b66 274d 4147 5f41 5045  olumns[f'MAG_APE
-000328a0: 5227 5d2e 6172 7261 795b 3a2c 695d 2021  R'].array[:,i] !
-000328b0: 3d20 3939 0a0a 2020 2020 2020 2020 2320  = 99..        # 
-000328c0: 464c 5558 0a20 2020 2020 2020 2046 4c55  FLUX.        FLU
-000328d0: 5820 3d20 7068 6f74 5f63 6174 2e63 6f6c  X = phot_cat.col
-000328e0: 756d 6e73 5b66 2746 4c55 585f 4150 4552  umns[f'FLUX_APER
-000328f0: 275d 2e61 7272 6179 5b3a 2c69 5d0a 2020  '].array[:,i].  
-00032900: 2020 2020 2020 655f 464c 5558 203d 2070        e_FLUX = p
-00032910: 686f 745f 6361 742e 636f 6c75 6d6e 735b  hot_cat.columns[
-00032920: 6627 464c 5558 4552 525f 4150 4552 275d  f'FLUXERR_APER']
-00032930: 2e61 7272 6179 5b3a 2c69 5d0a 0a20 2020  .array[:,i]..   
-00032940: 2020 2020 2023 2053 6967 6e61 6c20 746f       # Signal to
-00032950: 206e 6f69 7365 0a20 2020 2020 2020 2073   noise.        s
-00032960: 326e 203d 2046 4c55 5820 2f20 655f 464c  2n = FLUX / e_FL
-00032970: 5558 0a0a 2020 2020 2020 2020 2320 4142  UX..        # AB
-00032980: 206d 6167 6e69 7475 6465 0a20 2020 2020   magnitude.     
-00032990: 2020 206d 6167 203d 2070 686f 745f 6361     mag = phot_ca
-000329a0: 742e 636f 6c75 6d6e 735b 6627 4d41 475f  t.columns[f'MAG_
-000329b0: 4150 4552 275d 2e61 7272 6179 5b3a 2c69  APER'].array[:,i
-000329c0: 5d0a 2020 2020 2020 2020 6d61 675b 665d  ].        mag[f]
-000329d0: 202b 3d20 5a50 202d 2073 6578 5f6d 6167   += ZP - sex_mag
-000329e0: 5f7a 700a 0a20 2020 2020 2020 2065 5f6d  _zp..        e_m
-000329f0: 6167 203d 2070 686f 745f 6361 742e 636f  ag = phot_cat.co
-00032a00: 6c75 6d6e 735b 6627 4d41 4745 5252 5f41  lumns[f'MAGERR_A
-00032a10: 5045 5227 5d2e 6172 7261 795b 3a2c 695d  PER'].array[:,i]
-00032a20: 0a0a 2020 2020 2020 2020 6361 742e 6170  ..        cat.ap
-00032a30: 7065 6e64 2866 6974 732e 436f 6c75 6d6e  pend(fits.Column
-00032a40: 286e 616d 653d 6627 7b66 696c 745f 7374  (name=f'{filt_st
-00032a50: 616e 6461 7264 7d5f 6170 6572 5f69 647b  andard}_aper_id{
-00032a60: 697d 272c 0a20 2020 2020 2020 2020 2020  i}',.           
-00032a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032a80: 2020 2020 666f 726d 6174 3d66 6d74 2c0a      format=fmt,.
-00032a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032aa0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00032ab0: 7272 6179 3d6d 6167 2929 0a0a 2020 2020  rray=mag))..    
-00032ac0: 2020 2020 6361 742e 6170 7065 6e64 2866      cat.append(f
-00032ad0: 6974 732e 436f 6c75 6d6e 286e 616d 653d  its.Column(name=
-00032ae0: 6627 655f 7b66 696c 745f 7374 616e 6461  f'e_{filt_standa
-00032af0: 7264 7d5f 6170 6572 5f69 647b 697d 272c  rd}_aper_id{i}',
-00032b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032b20: 666f 726d 6174 3d66 6d74 2c0a 2020 2020  format=fmt,.    
-00032b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032b40: 2020 2020 2020 2020 2020 2061 7272 6179             array
-00032b50: 3d65 5f6d 6167 2929 0a0a 2020 2020 2020  =e_mag))..      
-00032b60: 2020 6361 742e 6170 7065 6e64 2866 6974    cat.append(fit
-00032b70: 732e 436f 6c75 6d6e 286e 616d 653d 6627  s.Column(name=f'
-00032b80: 7332 6e5f 7b66 696c 745f 7374 616e 6461  s2n_{filt_standa
-00032b90: 7264 7d5f 6170 6572 5f69 647b 697d 272c  rd}_aper_id{i}',
-00032ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032bc0: 666f 726d 6174 3d66 6d74 2c0a 2020 2020  format=fmt,.    
-00032bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032be0: 2020 2020 2020 2020 2020 2061 7272 6179             array
-00032bf0: 3d73 326e 2929 0a0a 2020 2020 6864 756c  =s2n))..    hdul
-00032c00: 5f76 6163 203d 2066 6974 732e 4269 6e54  _vac = fits.BinT
-00032c10: 6162 6c65 4844 552e 6672 6f6d 5f63 6f6c  ableHDU.from_col
-00032c20: 756d 6e73 2863 6174 290a 2020 2020 6864  umns(cat).    hd
-00032c30: 756c 5f76 6163 2e77 7269 7465 746f 2873  ul_vac.writeto(s
-00032c40: 6176 655f 6669 6c65 290a 0a0a 6465 6620  ave_file)...def 
-00032c50: 6578 7472 6163 745f 7661 635f 6665 6174  extract_vac_feat
-00032c60: 7572 6573 2863 6174 616c 6f67 2c20 7361  ures(catalog, sa
-00032c70: 7665 5f66 696c 652c 2066 696c 7429 3a0a  ve_file, filt):.
-00032c80: 0a20 2020 2023 204c 6f61 6420 7068 6f74  .    # Load phot
-00032c90: 6f6d 6574 7279 2063 6174 616c 6f67 0a20  ometry catalog. 
-00032ca0: 2020 2070 686f 745f 6361 7420 3d20 6669     phot_cat = fi
-00032cb0: 7473 2e6f 7065 6e28 6361 7461 6c6f 6729  ts.open(catalog)
-00032cc0: 0a20 2020 2070 686f 745f 6361 7420 3d20  .    phot_cat = 
-00032cd0: 7068 6f74 5f63 6174 5b31 5d2e 6461 7461  phot_cat[1].data
-00032ce0: 0a0a 2020 2020 6361 7420 3d20 5b5d 0a0a  ..    cat = []..
-00032cf0: 2020 2020 6966 2066 696c 7420 3d3d 2022      if filt == "
-00032d00: 6465 7465 6374 696f 6e22 3a0a 2020 2020  detection":.    
-00032d10: 2020 2020 6361 742e 6170 7065 6e64 2870      cat.append(p
-00032d20: 686f 745f 6361 742e 636f 6c75 6d6e 735b  hot_cat.columns[
-00032d30: 2749 4427 5d29 0a20 2020 2020 2020 2063  'ID']).        c
-00032d40: 6174 2e61 7070 656e 6428 7068 6f74 5f63  at.append(phot_c
-00032d50: 6174 2e63 6f6c 756d 6e73 5b27 5048 4f54  at.columns['PHOT
-00032d60: 5f49 445f 6475 616c 275d 290a 2020 2020  _ID_dual']).    
-00032d70: 2020 2020 6361 742e 6170 7065 6e64 2870      cat.append(p
-00032d80: 686f 745f 6361 742e 636f 6c75 6d6e 735b  hot_cat.columns[
-00032d90: 2752 4127 5d29 0a20 2020 2020 2020 2063  'RA']).        c
-00032da0: 6174 2e61 7070 656e 6428 7068 6f74 5f63  at.append(phot_c
-00032db0: 6174 2e63 6f6c 756d 6e73 5b27 4445 4327  at.columns['DEC'
-00032dc0: 5d29 0a20 2020 2020 2020 2063 6174 2e61  ]).        cat.a
-00032dd0: 7070 656e 6428 7068 6f74 5f63 6174 2e63  ppend(phot_cat.c
-00032de0: 6f6c 756d 6e73 5b27 4127 5d29 0a20 2020  olumns['A']).   
-00032df0: 2020 2020 2063 6174 2e61 7070 656e 6428       cat.append(
-00032e00: 7068 6f74 5f63 6174 2e63 6f6c 756d 6e73  phot_cat.columns
-00032e10: 5b27 4227 5d29 0a20 2020 2020 2020 2063  ['B']).        c
-00032e20: 6174 2e61 7070 656e 6428 7068 6f74 5f63  at.append(phot_c
-00032e30: 6174 2e63 6f6c 756d 6e73 5b27 4b52 4f4e  at.columns['KRON
-00032e40: 5f52 4144 4955 5327 5d29 0a20 2020 2020  _RADIUS']).     
-00032e50: 2020 2063 6174 2e61 7070 656e 6428 7068     cat.append(ph
-00032e60: 6f74 5f63 6174 2e63 6f6c 756d 6e73 5b27  ot_cat.columns['
-00032e70: 4657 484d 5f6e 275d 290a 2020 2020 2020  FWHM_n']).      
-00032e80: 2020 6361 742e 6170 7065 6e64 2870 686f    cat.append(pho
-00032e90: 745f 6361 742e 636f 6c75 6d6e 735b 274d  t_cat.columns['M
-00032ea0: 555f 4d41 585f 494e 5354 275d 290a 2020  U_MAX_INST']).  
-00032eb0: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
-00032ec0: 2870 686f 745f 6361 742e 636f 6c75 6d6e  (phot_cat.column
-00032ed0: 735b 2749 534f 6172 6561 275d 290a 2020  s['ISOarea']).  
-00032ee0: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
-00032ef0: 2870 686f 745f 6361 742e 636f 6c75 6d6e  (phot_cat.column
-00032f00: 735b 2753 4558 5f46 4c41 4753 5f44 4554  s['SEX_FLAGS_DET
-00032f10: 275d 290a 2020 2020 2020 2020 6361 742e  ']).        cat.
-00032f20: 6170 7065 6e64 2870 686f 745f 6361 742e  append(phot_cat.
-00032f30: 636f 6c75 6d6e 735b 2773 326e 5f44 4554  columns['s2n_DET
-00032f40: 5f61 7065 725f 3627 5d29 0a0a 2020 2020  _aper_6'])..    
-00032f50: 656c 7365 3a0a 2020 2020 2020 2020 6669  else:.        fi
-00032f60: 6c74 203d 2074 7261 6e73 6c61 7465 5f66  lt = translate_f
-00032f70: 696c 7465 725f 7374 616e 6461 7264 2866  ilter_standard(f
-00032f80: 696c 7429 0a20 2020 2020 2020 2063 6174  ilt).        cat
-00032f90: 2e61 7070 656e 6428 7068 6f74 5f63 6174  .append(phot_cat
-00032fa0: 2e63 6f6c 756d 6e73 5b27 5048 4f54 5f49  .columns['PHOT_I
-00032fb0: 445f 6475 616c 275d 290a 2020 2020 2020  D_dual']).      
-00032fc0: 2020 6361 742e 6170 7065 6e64 2870 686f    cat.append(pho
-00032fd0: 745f 6361 742e 636f 6c75 6d6e 735b 6627  t_cat.columns[f'
-00032fe0: 5345 585f 464c 4147 535f 7b66 696c 747d  SEX_FLAGS_{filt}
-00032ff0: 275d 290a 2020 2020 2020 2020 6361 742e  ']).        cat.
-00033000: 6170 7065 6e64 2870 686f 745f 6361 742e  append(phot_cat.
-00033010: 636f 6c75 6d6e 735b 6627 7b66 696c 747d  columns[f'{filt}
-00033020: 5f69 736f 275d 290a 2020 2020 2020 2020  _iso']).        
-00033030: 6361 742e 6170 7065 6e64 2870 686f 745f  cat.append(phot_
-00033040: 6361 742e 636f 6c75 6d6e 735b 6627 655f  cat.columns[f'e_
-00033050: 7b66 696c 747d 5f69 736f 275d 290a 2020  {filt}_iso']).  
-00033060: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
-00033070: 2870 686f 745f 6361 742e 636f 6c75 6d6e  (phot_cat.column
-00033080: 735b 6627 7b66 696c 747d 5f61 7065 725f  s[f'{filt}_aper_
-00033090: 3327 5d29 0a20 2020 2020 2020 2063 6174  3']).        cat
-000330a0: 2e61 7070 656e 6428 7068 6f74 5f63 6174  .append(phot_cat
-000330b0: 2e63 6f6c 756d 6e73 5b66 2765 5f7b 6669  .columns[f'e_{fi
-000330c0: 6c74 7d5f 6170 6572 5f33 275d 290a 2020  lt}_aper_3']).  
-000330d0: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
-000330e0: 2870 686f 745f 6361 742e 636f 6c75 6d6e  (phot_cat.column
-000330f0: 735b 6627 7b66 696c 747d 5f61 7065 725f  s[f'{filt}_aper_
-00033100: 3627 5d29 0a20 2020 2020 2020 2063 6174  6']).        cat
-00033110: 2e61 7070 656e 6428 7068 6f74 5f63 6174  .append(phot_cat
-00033120: 2e63 6f6c 756d 6e73 5b66 2765 5f7b 6669  .columns[f'e_{fi
-00033130: 6c74 7d5f 6170 6572 5f36 275d 290a 2020  lt}_aper_6']).  
-00033140: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
-00033150: 2870 686f 745f 6361 742e 636f 6c75 6d6e  (phot_cat.column
-00033160: 735b 6627 7b66 696c 747d 5f61 7574 6f27  s[f'{filt}_auto'
-00033170: 5d29 0a20 2020 2020 2020 2063 6174 2e61  ]).        cat.a
-00033180: 7070 656e 6428 7068 6f74 5f63 6174 2e63  ppend(phot_cat.c
-00033190: 6f6c 756d 6e73 5b66 2765 5f7b 6669 6c74  olumns[f'e_{filt
-000331a0: 7d5f 6175 746f 275d 290a 2020 2020 2020  }_auto']).      
-000331b0: 2020 6361 742e 6170 7065 6e64 2870 686f    cat.append(pho
-000331c0: 745f 6361 742e 636f 6c75 6d6e 735b 6627  t_cat.columns[f'
-000331d0: 7b66 696c 747d 5f70 6574 726f 275d 290a  {filt}_petro']).
-000331e0: 2020 2020 2020 2020 6361 742e 6170 7065          cat.appe
-000331f0: 6e64 2870 686f 745f 6361 742e 636f 6c75  nd(phot_cat.colu
-00033200: 6d6e 735b 6627 655f 7b66 696c 747d 5f70  mns[f'e_{filt}_p
-00033210: 6574 726f 275d 290a 2020 2020 2020 2020  etro']).        
-00033220: 6361 742e 6170 7065 6e64 2870 686f 745f  cat.append(phot_
-00033230: 6361 742e 636f 6c75 6d6e 735b 6627 7b66  cat.columns[f'{f
-00033240: 696c 747d 5f50 5374 6f74 616c 275d 290a  ilt}_PStotal']).
-00033250: 2020 2020 2020 2020 6361 742e 6170 7065          cat.appe
-00033260: 6e64 2870 686f 745f 6361 742e 636f 6c75  nd(phot_cat.colu
-00033270: 6d6e 735b 6627 655f 7b66 696c 747d 5f50  mns[f'e_{filt}_P
-00033280: 5374 6f74 616c 275d 290a 2020 2020 2020  Stotal']).      
-00033290: 2020 6361 742e 6170 7065 6e64 2870 686f    cat.append(pho
-000332a0: 745f 6361 742e 636f 6c75 6d6e 735b 6627  t_cat.columns[f'
-000332b0: 4657 484d 5f6e 5f7b 6669 6c74 7d27 5d29  FWHM_n_{filt}'])
-000332c0: 0a20 2020 2020 2020 2063 6174 2e61 7070  .        cat.app
-000332d0: 656e 6428 7068 6f74 5f63 6174 2e63 6f6c  end(phot_cat.col
-000332e0: 756d 6e73 5b66 274d 555f 4d41 585f 7b66  umns[f'MU_MAX_{f
-000332f0: 696c 747d 275d 290a 0a20 2020 2068 6475  ilt}'])..    hdu
-00033300: 6c5f 7661 6320 3d20 6669 7473 2e42 696e  l_vac = fits.Bin
-00033310: 5461 626c 6548 4455 2e66 726f 6d5f 636f  TableHDU.from_co
-00033320: 6c75 6d6e 7328 6361 7429 0a20 2020 2068  lumns(cat).    h
-00033330: 6475 6c5f 7661 632e 7772 6974 6574 6f28  dul_vac.writeto(
-00033340: 7361 7665 5f66 696c 6529 0a0a 0a23 2323  save_file)...###
+000326e0: 735b 6622 4445 435f 7b66 696c 745f 7374  s[f"DEC_{filt_st
+000326f0: 616e 6461 7264 7d22 5d29 0a20 2020 2065  andard}"]).    e
+00032700: 6c69 6620 6d6f 6465 203d 3d20 2264 7561  lif mode == "dua
+00032710: 6c22 3a0a 2020 2020 2020 2020 7068 6f74  l":.        phot
+00032720: 5f63 6174 2e63 6f6c 756d 6e73 5b27 414c  _cat.columns['AL
+00032730: 5048 415f 4a32 3030 3027 5d2e 6e61 6d65  PHA_J2000'].name
+00032740: 203d 2027 5241 270a 2020 2020 2020 2020   = 'RA'.        
+00032750: 6361 742e 6170 7065 6e64 2870 686f 745f  cat.append(phot_
+00032760: 6361 742e 636f 6c75 6d6e 735b 2752 4127  cat.columns['RA'
+00032770: 5d29 0a20 2020 2020 2020 2070 686f 745f  ]).        phot_
+00032780: 6361 742e 636f 6c75 6d6e 735b 2744 454c  cat.columns['DEL
+00032790: 5441 5f4a 3230 3030 275d 2e6e 616d 6520  TA_J2000'].name 
+000327a0: 3d20 2744 4543 270a 2020 2020 2020 2020  = 'DEC'.        
+000327b0: 6361 742e 6170 7065 6e64 2870 686f 745f  cat.append(phot_
+000327c0: 6361 742e 636f 6c75 6d6e 735b 2744 4543  cat.columns['DEC
+000327d0: 275d 290a 0a20 2020 206e 636f 6c73 203d  '])..    ncols =
+000327e0: 2070 686f 745f 6361 742e 636f 6c75 6d6e   phot_cat.column
+000327f0: 735b 6622 4d41 475f 4150 4552 225d 2e61  s[f"MAG_APER"].a
+00032800: 7272 6179 2e73 6861 7065 5b31 5d0a 0a20  rray.shape[1].. 
+00032810: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+00032820: 6528 6e63 6f6c 7329 3a0a 0a20 2020 2020  e(ncols):..     
+00032830: 2020 2066 6d74 203d 2027 3145 270a 2020     fmt = '1E'.  
+00032840: 2020 2020 2020 6620 3d20 7068 6f74 5f63        f = phot_c
+00032850: 6174 2e63 6f6c 756d 6e73 5b66 274d 4147  at.columns[f'MAG
+00032860: 5f41 5045 5227 5d2e 6172 7261 795b 3a2c  _APER'].array[:,
+00032870: 695d 2021 3d20 3939 0a0a 2020 2020 2020  i] != 99..      
+00032880: 2020 2320 464c 5558 0a20 2020 2020 2020    # FLUX.       
+00032890: 2046 4c55 5820 3d20 7068 6f74 5f63 6174   FLUX = phot_cat
+000328a0: 2e63 6f6c 756d 6e73 5b66 2746 4c55 585f  .columns[f'FLUX_
+000328b0: 4150 4552 275d 2e61 7272 6179 5b3a 2c69  APER'].array[:,i
+000328c0: 5d0a 2020 2020 2020 2020 655f 464c 5558  ].        e_FLUX
+000328d0: 203d 2070 686f 745f 6361 742e 636f 6c75   = phot_cat.colu
+000328e0: 6d6e 735b 6627 464c 5558 4552 525f 4150  mns[f'FLUXERR_AP
+000328f0: 4552 275d 2e61 7272 6179 5b3a 2c69 5d0a  ER'].array[:,i].
+00032900: 0a20 2020 2020 2020 2023 2053 6967 6e61  .        # Signa
+00032910: 6c20 746f 206e 6f69 7365 0a20 2020 2020  l to noise.     
+00032920: 2020 2073 326e 203d 2046 4c55 5820 2f20     s2n = FLUX / 
+00032930: 655f 464c 5558 0a0a 2020 2020 2020 2020  e_FLUX..        
+00032940: 2320 4142 206d 6167 6e69 7475 6465 0a20  # AB magnitude. 
+00032950: 2020 2020 2020 206d 6167 203d 2070 686f         mag = pho
+00032960: 745f 6361 742e 636f 6c75 6d6e 735b 6627  t_cat.columns[f'
+00032970: 4d41 475f 4150 4552 275d 2e61 7272 6179  MAG_APER'].array
+00032980: 5b3a 2c69 5d0a 2020 2020 2020 2020 6d61  [:,i].        ma
+00032990: 675b 665d 202b 3d20 5a50 202d 2073 6578  g[f] += ZP - sex
+000329a0: 5f6d 6167 5f7a 700a 0a20 2020 2020 2020  _mag_zp..       
+000329b0: 2065 5f6d 6167 203d 2070 686f 745f 6361   e_mag = phot_ca
+000329c0: 742e 636f 6c75 6d6e 735b 6627 4d41 4745  t.columns[f'MAGE
+000329d0: 5252 5f41 5045 5227 5d2e 6172 7261 795b  RR_APER'].array[
+000329e0: 3a2c 695d 0a0a 2020 2020 2020 2020 6361  :,i]..        ca
+000329f0: 742e 6170 7065 6e64 2866 6974 732e 436f  t.append(fits.Co
+00032a00: 6c75 6d6e 286e 616d 653d 6627 7b66 696c  lumn(name=f'{fil
+00032a10: 745f 7374 616e 6461 7264 7d5f 6170 6572  t_standard}_aper
+00032a20: 5f69 647b 697d 272c 0a20 2020 2020 2020  _id{i}',.       
+00032a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032a40: 2020 2020 2020 2020 666f 726d 6174 3d66          format=f
+00032a50: 6d74 2c0a 2020 2020 2020 2020 2020 2020  mt,.            
+00032a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032a70: 2020 2061 7272 6179 3d6d 6167 2929 0a0a     array=mag))..
+00032a80: 2020 2020 2020 2020 6361 742e 6170 7065          cat.appe
+00032a90: 6e64 2866 6974 732e 436f 6c75 6d6e 286e  nd(fits.Column(n
+00032aa0: 616d 653d 6627 655f 7b66 696c 745f 7374  ame=f'e_{filt_st
+00032ab0: 616e 6461 7264 7d5f 6170 6572 5f69 647b  andard}_aper_id{
+00032ac0: 697d 272c 0a20 2020 2020 2020 2020 2020  i}',.           
+00032ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032ae0: 2020 2020 666f 726d 6174 3d66 6d74 2c0a      format=fmt,.
+00032af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032b00: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00032b10: 7272 6179 3d65 5f6d 6167 2929 0a0a 2020  rray=e_mag))..  
+00032b20: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
+00032b30: 2866 6974 732e 436f 6c75 6d6e 286e 616d  (fits.Column(nam
+00032b40: 653d 6627 7332 6e5f 7b66 696c 745f 7374  e=f's2n_{filt_st
+00032b50: 616e 6461 7264 7d5f 6170 6572 5f69 647b  andard}_aper_id{
+00032b60: 697d 272c 0a20 2020 2020 2020 2020 2020  i}',.           
+00032b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032b80: 2020 2020 666f 726d 6174 3d66 6d74 2c0a      format=fmt,.
+00032b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032ba0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00032bb0: 7272 6179 3d73 326e 2929 0a0a 2020 2020  rray=s2n))..    
+00032bc0: 6864 756c 5f76 6163 203d 2066 6974 732e  hdul_vac = fits.
+00032bd0: 4269 6e54 6162 6c65 4844 552e 6672 6f6d  BinTableHDU.from
+00032be0: 5f63 6f6c 756d 6e73 2863 6174 290a 2020  _columns(cat).  
+00032bf0: 2020 6864 756c 5f76 6163 2e77 7269 7465    hdul_vac.write
+00032c00: 746f 2873 6176 655f 6669 6c65 290a 0a0a  to(save_file)...
+00032c10: 6465 6620 6578 7472 6163 745f 7661 635f  def extract_vac_
+00032c20: 6665 6174 7572 6573 2863 6174 616c 6f67  features(catalog
+00032c30: 2c20 7361 7665 5f66 696c 652c 2066 696c  , save_file, fil
+00032c40: 7429 3a0a 0a20 2020 2023 204c 6f61 6420  t):..    # Load 
+00032c50: 7068 6f74 6f6d 6574 7279 2063 6174 616c  photometry catal
+00032c60: 6f67 0a20 2020 2070 686f 745f 6361 7420  og.    phot_cat 
+00032c70: 3d20 6669 7473 2e6f 7065 6e28 6361 7461  = fits.open(cata
+00032c80: 6c6f 6729 0a20 2020 2070 686f 745f 6361  log).    phot_ca
+00032c90: 7420 3d20 7068 6f74 5f63 6174 5b31 5d2e  t = phot_cat[1].
+00032ca0: 6461 7461 0a0a 2020 2020 6361 7420 3d20  data..    cat = 
+00032cb0: 5b5d 0a0a 2020 2020 6966 2066 696c 7420  []..    if filt 
+00032cc0: 3d3d 2022 6465 7465 6374 696f 6e22 3a0a  == "detection":.
+00032cd0: 2020 2020 2020 2020 6361 742e 6170 7065          cat.appe
+00032ce0: 6e64 2870 686f 745f 6361 742e 636f 6c75  nd(phot_cat.colu
+00032cf0: 6d6e 735b 2749 4427 5d29 0a20 2020 2020  mns['ID']).     
+00032d00: 2020 2063 6174 2e61 7070 656e 6428 7068     cat.append(ph
+00032d10: 6f74 5f63 6174 2e63 6f6c 756d 6e73 5b27  ot_cat.columns['
+00032d20: 5048 4f54 5f49 445f 6475 616c 275d 290a  PHOT_ID_dual']).
+00032d30: 2020 2020 2020 2020 6361 742e 6170 7065          cat.appe
+00032d40: 6e64 2870 686f 745f 6361 742e 636f 6c75  nd(phot_cat.colu
+00032d50: 6d6e 735b 2752 4127 5d29 0a20 2020 2020  mns['RA']).     
+00032d60: 2020 2063 6174 2e61 7070 656e 6428 7068     cat.append(ph
+00032d70: 6f74 5f63 6174 2e63 6f6c 756d 6e73 5b27  ot_cat.columns['
+00032d80: 4445 4327 5d29 0a20 2020 2020 2020 2063  DEC']).        c
+00032d90: 6174 2e61 7070 656e 6428 7068 6f74 5f63  at.append(phot_c
+00032da0: 6174 2e63 6f6c 756d 6e73 5b27 4127 5d29  at.columns['A'])
+00032db0: 0a20 2020 2020 2020 2063 6174 2e61 7070  .        cat.app
+00032dc0: 656e 6428 7068 6f74 5f63 6174 2e63 6f6c  end(phot_cat.col
+00032dd0: 756d 6e73 5b27 4227 5d29 0a20 2020 2020  umns['B']).     
+00032de0: 2020 2063 6174 2e61 7070 656e 6428 7068     cat.append(ph
+00032df0: 6f74 5f63 6174 2e63 6f6c 756d 6e73 5b27  ot_cat.columns['
+00032e00: 4b52 4f4e 5f52 4144 4955 5327 5d29 0a20  KRON_RADIUS']). 
+00032e10: 2020 2020 2020 2063 6174 2e61 7070 656e         cat.appen
+00032e20: 6428 7068 6f74 5f63 6174 2e63 6f6c 756d  d(phot_cat.colum
+00032e30: 6e73 5b27 4657 484d 5f6e 275d 290a 2020  ns['FWHM_n']).  
+00032e40: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
+00032e50: 2870 686f 745f 6361 742e 636f 6c75 6d6e  (phot_cat.column
+00032e60: 735b 274d 555f 4d41 585f 494e 5354 275d  s['MU_MAX_INST']
+00032e70: 290a 2020 2020 2020 2020 6361 742e 6170  ).        cat.ap
+00032e80: 7065 6e64 2870 686f 745f 6361 742e 636f  pend(phot_cat.co
+00032e90: 6c75 6d6e 735b 2749 534f 6172 6561 275d  lumns['ISOarea']
+00032ea0: 290a 2020 2020 2020 2020 6361 742e 6170  ).        cat.ap
+00032eb0: 7065 6e64 2870 686f 745f 6361 742e 636f  pend(phot_cat.co
+00032ec0: 6c75 6d6e 735b 2753 4558 5f46 4c41 4753  lumns['SEX_FLAGS
+00032ed0: 5f44 4554 275d 290a 2020 2020 2020 2020  _DET']).        
+00032ee0: 6361 742e 6170 7065 6e64 2870 686f 745f  cat.append(phot_
+00032ef0: 6361 742e 636f 6c75 6d6e 735b 2773 326e  cat.columns['s2n
+00032f00: 5f44 4554 5f61 7065 725f 3627 5d29 0a0a  _DET_aper_6'])..
+00032f10: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00032f20: 2020 6669 6c74 203d 2074 7261 6e73 6c61    filt = transla
+00032f30: 7465 5f66 696c 7465 725f 7374 616e 6461  te_filter_standa
+00032f40: 7264 2866 696c 7429 0a20 2020 2020 2020  rd(filt).       
+00032f50: 2063 6174 2e61 7070 656e 6428 7068 6f74   cat.append(phot
+00032f60: 5f63 6174 2e63 6f6c 756d 6e73 5b27 5048  _cat.columns['PH
+00032f70: 4f54 5f49 445f 6475 616c 275d 290a 2020  OT_ID_dual']).  
+00032f80: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
+00032f90: 2870 686f 745f 6361 742e 636f 6c75 6d6e  (phot_cat.column
+00032fa0: 735b 6627 5345 585f 464c 4147 535f 7b66  s[f'SEX_FLAGS_{f
+00032fb0: 696c 747d 275d 290a 2020 2020 2020 2020  ilt}']).        
+00032fc0: 6361 742e 6170 7065 6e64 2870 686f 745f  cat.append(phot_
+00032fd0: 6361 742e 636f 6c75 6d6e 735b 6627 7b66  cat.columns[f'{f
+00032fe0: 696c 747d 5f69 736f 275d 290a 2020 2020  ilt}_iso']).    
+00032ff0: 2020 2020 6361 742e 6170 7065 6e64 2870      cat.append(p
+00033000: 686f 745f 6361 742e 636f 6c75 6d6e 735b  hot_cat.columns[
+00033010: 6627 655f 7b66 696c 747d 5f69 736f 275d  f'e_{filt}_iso']
+00033020: 290a 2020 2020 2020 2020 6361 742e 6170  ).        cat.ap
+00033030: 7065 6e64 2870 686f 745f 6361 742e 636f  pend(phot_cat.co
+00033040: 6c75 6d6e 735b 6627 7b66 696c 747d 5f61  lumns[f'{filt}_a
+00033050: 7065 725f 3327 5d29 0a20 2020 2020 2020  per_3']).       
+00033060: 2063 6174 2e61 7070 656e 6428 7068 6f74   cat.append(phot
+00033070: 5f63 6174 2e63 6f6c 756d 6e73 5b66 2765  _cat.columns[f'e
+00033080: 5f7b 6669 6c74 7d5f 6170 6572 5f33 275d  _{filt}_aper_3']
+00033090: 290a 2020 2020 2020 2020 6361 742e 6170  ).        cat.ap
+000330a0: 7065 6e64 2870 686f 745f 6361 742e 636f  pend(phot_cat.co
+000330b0: 6c75 6d6e 735b 6627 7b66 696c 747d 5f61  lumns[f'{filt}_a
+000330c0: 7065 725f 3627 5d29 0a20 2020 2020 2020  per_6']).       
+000330d0: 2063 6174 2e61 7070 656e 6428 7068 6f74   cat.append(phot
+000330e0: 5f63 6174 2e63 6f6c 756d 6e73 5b66 2765  _cat.columns[f'e
+000330f0: 5f7b 6669 6c74 7d5f 6170 6572 5f36 275d  _{filt}_aper_6']
+00033100: 290a 2020 2020 2020 2020 6361 742e 6170  ).        cat.ap
+00033110: 7065 6e64 2870 686f 745f 6361 742e 636f  pend(phot_cat.co
+00033120: 6c75 6d6e 735b 6627 7b66 696c 747d 5f61  lumns[f'{filt}_a
+00033130: 7574 6f27 5d29 0a20 2020 2020 2020 2063  uto']).        c
+00033140: 6174 2e61 7070 656e 6428 7068 6f74 5f63  at.append(phot_c
+00033150: 6174 2e63 6f6c 756d 6e73 5b66 2765 5f7b  at.columns[f'e_{
+00033160: 6669 6c74 7d5f 6175 746f 275d 290a 2020  filt}_auto']).  
+00033170: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
+00033180: 2870 686f 745f 6361 742e 636f 6c75 6d6e  (phot_cat.column
+00033190: 735b 6627 7b66 696c 747d 5f70 6574 726f  s[f'{filt}_petro
+000331a0: 275d 290a 2020 2020 2020 2020 6361 742e  ']).        cat.
+000331b0: 6170 7065 6e64 2870 686f 745f 6361 742e  append(phot_cat.
+000331c0: 636f 6c75 6d6e 735b 6627 655f 7b66 696c  columns[f'e_{fil
+000331d0: 747d 5f70 6574 726f 275d 290a 2020 2020  t}_petro']).    
+000331e0: 2020 2020 6361 742e 6170 7065 6e64 2870      cat.append(p
+000331f0: 686f 745f 6361 742e 636f 6c75 6d6e 735b  hot_cat.columns[
+00033200: 6627 7b66 696c 747d 5f50 5374 6f74 616c  f'{filt}_PStotal
+00033210: 275d 290a 2020 2020 2020 2020 6361 742e  ']).        cat.
+00033220: 6170 7065 6e64 2870 686f 745f 6361 742e  append(phot_cat.
+00033230: 636f 6c75 6d6e 735b 6627 655f 7b66 696c  columns[f'e_{fil
+00033240: 747d 5f50 5374 6f74 616c 275d 290a 2020  t}_PStotal']).  
+00033250: 2020 2020 2020 6361 742e 6170 7065 6e64        cat.append
+00033260: 2870 686f 745f 6361 742e 636f 6c75 6d6e  (phot_cat.column
+00033270: 735b 6627 4657 484d 5f6e 5f7b 6669 6c74  s[f'FWHM_n_{filt
+00033280: 7d27 5d29 0a20 2020 2020 2020 2063 6174  }']).        cat
+00033290: 2e61 7070 656e 6428 7068 6f74 5f63 6174  .append(phot_cat
+000332a0: 2e63 6f6c 756d 6e73 5b66 274d 555f 4d41  .columns[f'MU_MA
+000332b0: 585f 7b66 696c 747d 275d 290a 0a20 2020  X_{filt}'])..   
+000332c0: 2068 6475 6c5f 7661 6320 3d20 6669 7473   hdul_vac = fits
+000332d0: 2e42 696e 5461 626c 6548 4455 2e66 726f  .BinTableHDU.fro
+000332e0: 6d5f 636f 6c75 6d6e 7328 6361 7429 0a20  m_columns(cat). 
+000332f0: 2020 2068 6475 6c5f 7661 632e 7772 6974     hdul_vac.writ
+00033300: 6574 6f28 7361 7665 5f66 696c 6529 0a0a  eto(save_file)..
+00033310: 0a23 2323 2323 2323 2323 2323 2323 2323  .###############
+00033320: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00033330: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00033340: 2323 2323 2323 2323 2323 2323 2323 2323  ################
 00033350: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00033360: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00033370: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00033380: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00033390: 2323 2323 2323 2323 2323 2323 230a 2320  #############.# 
-000333a0: 4669 7420 7073 6620 7068 6f74 6f6d 6574  Fit psf photomet
-000333b0: 7279 206f 6666 7365 7473 0a0a 6465 6620  ry offsets..def 
-000333c0: 6573 7469 6d61 7465 5f66 6965 6c64 5f64  estimate_field_d
-000333d0: 7561 6c5f 7073 665f 6f66 6673 6574 2863  ual_psf_offset(c
-000333e0: 6174 616c 6f67 2c20 7361 7665 5f66 696c  atalog, save_fil
-000333f0: 652c 2066 696c 7465 7273 293a 0a0a 2020  e, filters):..  
-00033400: 2020 2320 4c6f 6164 2070 686f 746f 6d65    # Load photome
-00033410: 7472 7920 6361 7461 6c6f 670a 2020 2020  try catalog.    
-00033420: 6361 7420 3d20 6669 7473 2e6f 7065 6e28  cat = fits.open(
-00033430: 6361 7461 6c6f 6729 0a20 2020 2063 6174  catalog).    cat
-00033440: 203d 2063 6174 5b31 5d2e 6461 7461 0a0a   = cat[1].data..
-00033450: 2020 2020 6f66 6673 6574 203d 207b 7d0a      offset = {}.
-00033460: 0a20 2020 2066 6f72 2066 696c 7420 696e  .    for filt in
-00033470: 2066 696c 7465 7273 3a0a 2020 2020 2020   filters:.      
-00033480: 2020 6d61 675f 6475 616c 203d 2063 6174    mag_dual = cat
-00033490: 2e63 6f6c 756d 6e73 5b66 227b 6669 6c74  .columns[f"{filt
-000334a0: 7d5f 3122 5d2e 6172 7261 790a 2020 2020  }_1"].array.    
-000334b0: 2020 2020 655f 6d61 675f 6475 616c 203d      e_mag_dual =
-000334c0: 2063 6174 2e63 6f6c 756d 6e73 5b66 227b   cat.columns[f"{
-000334d0: 6669 6c74 7d5f 6572 725f 3122 5d2e 6172  filt}_err_1"].ar
-000334e0: 7261 790a 2020 2020 2020 2020 6475 616c  ray.        dual
-000334f0: 5f63 6c61 7373 5f73 7461 7220 3d20 6361  _class_star = ca
-00033500: 742e 636f 6c75 6d6e 735b 6622 434c 4153  t.columns[f"CLAS
-00033510: 535f 5354 4152 5f31 225d 2e61 7272 6179  S_STAR_1"].array
-00033520: 0a20 2020 2020 2020 206d 6167 5f70 7366  .        mag_psf
-00033530: 203d 2063 6174 2e63 6f6c 756d 6e73 5b66   = cat.columns[f
-00033540: 227b 6669 6c74 7d5f 3222 5d2e 6172 7261  "{filt}_2"].arra
-00033550: 790a 0a20 2020 2020 2020 2066 203d 2028  y..        f = (
-00033560: 6475 616c 5f63 6c61 7373 5f73 7461 7220  dual_class_star 
-00033570: 3e20 302e 3929 2026 2028 655f 6d61 675f  > 0.9) & (e_mag_
-00033580: 6475 616c 203c 2030 2e30 3229 0a0a 2020  dual < 0.02)..  
-00033590: 2020 2020 2020 6f66 6673 6574 5b66 696c        offset[fil
-000335a0: 745d 203d 206d 6561 6e5f 726f 6275 7374  t] = mean_robust
-000335b0: 286d 6167 5f64 7561 6c5b 665d 202d 206d  (mag_dual[f] - m
-000335c0: 6167 5f70 7366 5b66 5d29 0a0a 2020 2020  ag_psf[f])..    
-000335d0: 7072 696e 7428 6f66 6673 6574 290a 0a20  print(offset).. 
-000335e0: 2020 207a 705f 7772 6974 6528 7a70 5f64     zp_write(zp_d
-000335f0: 6963 7420 3d20 6f66 6673 6574 2c20 7361  ict = offset, sa
-00033600: 7665 5f66 696c 6520 3d20 7361 7665 5f66  ve_file = save_f
-00033610: 696c 652c 2066 696c 7465 7273 5f6c 6973  ile, filters_lis
-00033620: 7420 3d20 6669 6c74 6572 7329 0a0a 0a64  t = filters)...d
-00033630: 6566 2065 7374 696d 6174 655f 6f76 6572  ef estimate_over
-00033640: 616c 6c5f 6475 616c 5f70 7366 5f6f 6666  all_dual_psf_off
-00033650: 7365 7428 6f66 6673 6574 5f66 696c 6573  set(offset_files
-00033660: 2c20 7361 7665 5f66 696c 652c 2066 696c  , save_file, fil
-00033670: 7465 7273 293a 0a0a 2020 2020 6f76 6572  ters):..    over
-00033680: 616c 6c5f 6f66 6673 6574 7320 3d20 7b7d  all_offsets = {}
-00033690: 0a0a 2020 2020 666f 7220 6669 6c74 2069  ..    for filt i
-000336a0: 6e20 6669 6c74 6572 733a 0a0a 2020 2020  n filters:..    
-000336b0: 2020 2020 6669 6c74 6572 5f6f 6666 7365      filter_offse
-000336c0: 7473 203d 206e 702e 6675 6c6c 286c 656e  ts = np.full(len
-000336d0: 286f 6666 7365 745f 6669 6c65 7329 2c20  (offset_files), 
-000336e0: 6e70 2e6e 616e 290a 0a20 2020 2020 2020  np.nan)..       
-000336f0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-00033700: 6c65 6e28 6f66 6673 6574 5f66 696c 6573  len(offset_files
-00033710: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00033720: 6669 656c 645f 6f66 6673 6574 7320 3d20  field_offsets = 
-00033730: 7a70 5f72 6561 6428 6f66 6673 6574 5f66  zp_read(offset_f
-00033740: 696c 6573 5b69 5d29 0a20 2020 2020 2020  iles[i]).       
-00033750: 2020 2020 2066 696c 7465 725f 6f66 6673       filter_offs
-00033760: 6574 735b 695d 203d 2066 6965 6c64 5f6f  ets[i] = field_o
-00033770: 6666 7365 7473 5b66 696c 745d 0a0a 2020  ffsets[filt]..  
-00033780: 2020 2020 2020 6669 6c74 6572 5f6f 6666        filter_off
-00033790: 7365 7473 203d 2066 696c 7465 725f 6f66  sets = filter_of
-000337a0: 6673 6574 732e 7265 7368 6170 6528 2d31  fsets.reshape(-1
-000337b0: 2c20 3129 0a0a 2020 2020 2020 2020 6b64  , 1)..        kd
-000337c0: 655f 6465 6e73 203d 204b 6572 6e65 6c44  e_dens = KernelD
-000337d0: 656e 7369 7479 286b 6572 6e65 6c3d 2767  ensity(kernel='g
-000337e0: 6175 7373 6961 6e27 2c20 6261 6e64 7769  aussian', bandwi
-000337f0: 6474 683d 302e 3035 292e 6669 7428 6669  dth=0.05).fit(fi
-00033800: 6c74 6572 5f6f 6666 7365 7473 290a 0a20  lter_offsets).. 
-00033810: 2020 2020 2020 2023 2054 7261 6e73 666f         # Transfo
-00033820: 726d 2074 6f20 6b64 650a 2020 2020 2020  rm to kde.      
-00033830: 2020 7820 3d20 6e70 2e61 7261 6e67 6528    x = np.arange(
-00033840: 2d31 302c 2031 302c 2030 2e30 3031 290a  -10, 10, 0.001).
-00033850: 2020 2020 2020 2020 7920 3d20 6e70 2e65          y = np.e
-00033860: 7870 286b 6465 5f64 656e 732e 7363 6f72  xp(kde_dens.scor
-00033870: 655f 7361 6d70 6c65 7328 782e 7265 7368  e_samples(x.resh
-00033880: 6170 6528 2d31 2c20 3129 2929 0a0a 2020  ape(-1, 1)))..  
-00033890: 2020 2020 2020 2320 6765 7420 6d6f 6465        # get mode
-000338a0: 0a20 2020 2020 2020 206d 6f64 6520 3d20  .        mode = 
-000338b0: 785b 7920 3d3d 206e 702e 6d61 7828 7929  x[y == np.max(y)
-000338c0: 5d5b 305d 0a0a 2020 2020 2020 2020 6f76  ][0]..        ov
-000338d0: 6572 616c 6c5f 6f66 6673 6574 735b 6669  erall_offsets[fi
-000338e0: 6c74 5d20 3d20 6d6f 6465 0a0a 2020 2020  lt] = mode..    
-000338f0: 7a70 5f77 7269 7465 287a 705f 6469 6374  zp_write(zp_dict
-00033900: 3d6f 7665 7261 6c6c 5f6f 6666 7365 7473  =overall_offsets
-00033910: 2c20 7361 7665 5f66 696c 653d 7361 7665  , save_file=save
-00033920: 5f66 696c 652c 0a20 2020 2020 2020 2020  _file,.         
-00033930: 2020 2020 6669 6c74 6572 735f 6c69 7374      filters_list
-00033940: 3d66 696c 7465 7273 290a 0a0a 6465 6620  =filters)...def 
-00033950: 6164 645f 696e 7374 5f6f 6666 7365 7428  add_inst_offset(
-00033960: 6361 7461 6c6f 672c 206f 6666 7365 745f  catalog, offset_
-00033970: 6669 6c65 2c20 7361 7665 5f66 696c 6529  file, save_file)
-00033980: 3a0a 0a20 2020 2023 204c 6f61 6420 7068  :..    # Load ph
-00033990: 6f74 6f6d 6574 7279 2063 6174 616c 6f67  otometry catalog
-000339a0: 0a20 2020 2063 6174 203d 2066 6974 732e  .    cat = fits.
-000339b0: 6f70 656e 2863 6174 616c 6f67 290a 0a20  open(catalog).. 
-000339c0: 2020 2023 204c 6f61 6420 6f66 6673 6574     # Load offset
-000339d0: 730a 2020 2020 6f66 6673 6574 7320 3d20  s.    offsets = 
-000339e0: 7a70 5f72 6561 6428 6f66 6673 6574 5f66  zp_read(offset_f
-000339f0: 696c 6529 0a0a 2020 2020 666f 7220 6669  ile)..    for fi
-00033a00: 6c74 2069 6e20 6f66 6673 6574 732e 6b65  lt in offsets.ke
-00033a10: 7973 2829 3a0a 2020 2020 2020 2020 6620  ys():.        f 
-00033a20: 3d20 6361 745b 315d 2e64 6174 612e 636f  = cat[1].data.co
-00033a30: 6c75 6d6e 735b 6669 6c74 5d2e 6172 7261  lumns[filt].arra
-00033a40: 7920 213d 2039 390a 2020 2020 2020 2020  y != 99.        
-00033a50: 6361 745b 315d 2e64 6174 612e 636f 6c75  cat[1].data.colu
-00033a60: 6d6e 735b 6669 6c74 5d2e 6172 7261 795b  mns[filt].array[
-00033a70: 665d 202b 3d20 6f66 6673 6574 735b 6669  f] += offsets[fi
-00033a80: 6c74 5d0a 0a20 2020 2063 6174 2e77 7269  lt]..    cat.wri
-00033a90: 7465 746f 2873 6176 655f 6669 6c65 290a  teto(save_file).
+00033360: 230a 2320 4669 7420 7073 6620 7068 6f74  #.# Fit psf phot
+00033370: 6f6d 6574 7279 206f 6666 7365 7473 0a0a  ometry offsets..
+00033380: 6465 6620 6573 7469 6d61 7465 5f66 6965  def estimate_fie
+00033390: 6c64 5f64 7561 6c5f 7073 665f 6f66 6673  ld_dual_psf_offs
+000333a0: 6574 2863 6174 616c 6f67 2c20 7361 7665  et(catalog, save
+000333b0: 5f66 696c 652c 2066 696c 7465 7273 293a  _file, filters):
+000333c0: 0a0a 2020 2020 2320 4c6f 6164 2070 686f  ..    # Load pho
+000333d0: 746f 6d65 7472 7920 6361 7461 6c6f 670a  tometry catalog.
+000333e0: 2020 2020 6361 7420 3d20 6669 7473 2e6f      cat = fits.o
+000333f0: 7065 6e28 6361 7461 6c6f 6729 0a20 2020  pen(catalog).   
+00033400: 2063 6174 203d 2063 6174 5b31 5d2e 6461   cat = cat[1].da
+00033410: 7461 0a0a 2020 2020 6f66 6673 6574 203d  ta..    offset =
+00033420: 207b 7d0a 0a20 2020 2066 6f72 2066 696c   {}..    for fil
+00033430: 7420 696e 2066 696c 7465 7273 3a0a 2020  t in filters:.  
+00033440: 2020 2020 2020 6d61 675f 6475 616c 203d        mag_dual =
+00033450: 2063 6174 2e63 6f6c 756d 6e73 5b66 227b   cat.columns[f"{
+00033460: 6669 6c74 7d5f 3122 5d2e 6172 7261 790a  filt}_1"].array.
+00033470: 2020 2020 2020 2020 655f 6d61 675f 6475          e_mag_du
+00033480: 616c 203d 2063 6174 2e63 6f6c 756d 6e73  al = cat.columns
+00033490: 5b66 227b 6669 6c74 7d5f 6572 725f 3122  [f"{filt}_err_1"
+000334a0: 5d2e 6172 7261 790a 2020 2020 2020 2020  ].array.        
+000334b0: 6475 616c 5f63 6c61 7373 5f73 7461 7220  dual_class_star 
+000334c0: 3d20 6361 742e 636f 6c75 6d6e 735b 6622  = cat.columns[f"
+000334d0: 434c 4153 535f 5354 4152 5f31 225d 2e61  CLASS_STAR_1"].a
+000334e0: 7272 6179 0a20 2020 2020 2020 206d 6167  rray.        mag
+000334f0: 5f70 7366 203d 2063 6174 2e63 6f6c 756d  _psf = cat.colum
+00033500: 6e73 5b66 227b 6669 6c74 7d5f 3222 5d2e  ns[f"{filt}_2"].
+00033510: 6172 7261 790a 0a20 2020 2020 2020 2066  array..        f
+00033520: 203d 2028 6475 616c 5f63 6c61 7373 5f73   = (dual_class_s
+00033530: 7461 7220 3e20 302e 3929 2026 2028 655f  tar > 0.9) & (e_
+00033540: 6d61 675f 6475 616c 203c 2030 2e30 3229  mag_dual < 0.02)
+00033550: 0a0a 2020 2020 2020 2020 6f66 6673 6574  ..        offset
+00033560: 5b66 696c 745d 203d 206d 6561 6e5f 726f  [filt] = mean_ro
+00033570: 6275 7374 286d 6167 5f64 7561 6c5b 665d  bust(mag_dual[f]
+00033580: 202d 206d 6167 5f70 7366 5b66 5d29 0a0a   - mag_psf[f])..
+00033590: 2020 2020 7072 696e 7428 6f66 6673 6574      print(offset
+000335a0: 290a 0a20 2020 207a 705f 7772 6974 6528  )..    zp_write(
+000335b0: 7a70 5f64 6963 7420 3d20 6f66 6673 6574  zp_dict = offset
+000335c0: 2c20 7361 7665 5f66 696c 6520 3d20 7361  , save_file = sa
+000335d0: 7665 5f66 696c 652c 2066 696c 7465 7273  ve_file, filters
+000335e0: 5f6c 6973 7420 3d20 6669 6c74 6572 7329  _list = filters)
+000335f0: 0a0a 0a64 6566 2065 7374 696d 6174 655f  ...def estimate_
+00033600: 6f76 6572 616c 6c5f 6475 616c 5f70 7366  overall_dual_psf
+00033610: 5f6f 6666 7365 7428 6f66 6673 6574 5f66  _offset(offset_f
+00033620: 696c 6573 2c20 7361 7665 5f66 696c 652c  iles, save_file,
+00033630: 2066 696c 7465 7273 293a 0a0a 2020 2020   filters):..    
+00033640: 6f76 6572 616c 6c5f 6f66 6673 6574 7320  overall_offsets 
+00033650: 3d20 7b7d 0a0a 2020 2020 666f 7220 6669  = {}..    for fi
+00033660: 6c74 2069 6e20 6669 6c74 6572 733a 0a0a  lt in filters:..
+00033670: 2020 2020 2020 2020 6669 6c74 6572 5f6f          filter_o
+00033680: 6666 7365 7473 203d 206e 702e 6675 6c6c  ffsets = np.full
+00033690: 286c 656e 286f 6666 7365 745f 6669 6c65  (len(offset_file
+000336a0: 7329 2c20 6e70 2e6e 616e 290a 0a20 2020  s), np.nan)..   
+000336b0: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
+000336c0: 6e67 6528 6c65 6e28 6f66 6673 6574 5f66  nge(len(offset_f
+000336d0: 696c 6573 2929 3a0a 2020 2020 2020 2020  iles)):.        
+000336e0: 2020 2020 6669 656c 645f 6f66 6673 6574      field_offset
+000336f0: 7320 3d20 7a70 5f72 6561 6428 6f66 6673  s = zp_read(offs
+00033700: 6574 5f66 696c 6573 5b69 5d29 0a20 2020  et_files[i]).   
+00033710: 2020 2020 2020 2020 2066 696c 7465 725f           filter_
+00033720: 6f66 6673 6574 735b 695d 203d 2066 6965  offsets[i] = fie
+00033730: 6c64 5f6f 6666 7365 7473 5b66 696c 745d  ld_offsets[filt]
+00033740: 0a0a 2020 2020 2020 2020 6669 6c74 6572  ..        filter
+00033750: 5f6f 6666 7365 7473 203d 2066 696c 7465  _offsets = filte
+00033760: 725f 6f66 6673 6574 732e 7265 7368 6170  r_offsets.reshap
+00033770: 6528 2d31 2c20 3129 0a0a 2020 2020 2020  e(-1, 1)..      
+00033780: 2020 6b64 655f 6465 6e73 203d 204b 6572    kde_dens = Ker
+00033790: 6e65 6c44 656e 7369 7479 286b 6572 6e65  nelDensity(kerne
+000337a0: 6c3d 2767 6175 7373 6961 6e27 2c20 6261  l='gaussian', ba
+000337b0: 6e64 7769 6474 683d 302e 3035 292e 6669  ndwidth=0.05).fi
+000337c0: 7428 6669 6c74 6572 5f6f 6666 7365 7473  t(filter_offsets
+000337d0: 290a 0a20 2020 2020 2020 2023 2054 7261  )..        # Tra
+000337e0: 6e73 666f 726d 2074 6f20 6b64 650a 2020  nsform to kde.  
+000337f0: 2020 2020 2020 7820 3d20 6e70 2e61 7261        x = np.ara
+00033800: 6e67 6528 2d31 302c 2031 302c 2030 2e30  nge(-10, 10, 0.0
+00033810: 3031 290a 2020 2020 2020 2020 7920 3d20  01).        y = 
+00033820: 6e70 2e65 7870 286b 6465 5f64 656e 732e  np.exp(kde_dens.
+00033830: 7363 6f72 655f 7361 6d70 6c65 7328 782e  score_samples(x.
+00033840: 7265 7368 6170 6528 2d31 2c20 3129 2929  reshape(-1, 1)))
+00033850: 0a0a 2020 2020 2020 2020 2320 6765 7420  ..        # get 
+00033860: 6d6f 6465 0a20 2020 2020 2020 206d 6f64  mode.        mod
+00033870: 6520 3d20 785b 7920 3d3d 206e 702e 6d61  e = x[y == np.ma
+00033880: 7828 7929 5d5b 305d 0a0a 2020 2020 2020  x(y)][0]..      
+00033890: 2020 6f76 6572 616c 6c5f 6f66 6673 6574    overall_offset
+000338a0: 735b 6669 6c74 5d20 3d20 6d6f 6465 0a0a  s[filt] = mode..
+000338b0: 2020 2020 7a70 5f77 7269 7465 287a 705f      zp_write(zp_
+000338c0: 6469 6374 3d6f 7665 7261 6c6c 5f6f 6666  dict=overall_off
+000338d0: 7365 7473 2c20 7361 7665 5f66 696c 653d  sets, save_file=
+000338e0: 7361 7665 5f66 696c 652c 0a20 2020 2020  save_file,.     
+000338f0: 2020 2020 2020 2020 6669 6c74 6572 735f          filters_
+00033900: 6c69 7374 3d66 696c 7465 7273 290a 0a0a  list=filters)...
+00033910: 6465 6620 6164 645f 696e 7374 5f6f 6666  def add_inst_off
+00033920: 7365 7428 6361 7461 6c6f 672c 206f 6666  set(catalog, off
+00033930: 7365 745f 6669 6c65 2c20 7361 7665 5f66  set_file, save_f
+00033940: 696c 6529 3a0a 0a20 2020 2023 204c 6f61  ile):..    # Loa
+00033950: 6420 7068 6f74 6f6d 6574 7279 2063 6174  d photometry cat
+00033960: 616c 6f67 0a20 2020 2063 6174 203d 2066  alog.    cat = f
+00033970: 6974 732e 6f70 656e 2863 6174 616c 6f67  its.open(catalog
+00033980: 290a 0a20 2020 2023 204c 6f61 6420 6f66  )..    # Load of
+00033990: 6673 6574 730a 2020 2020 6f66 6673 6574  fsets.    offset
+000339a0: 7320 3d20 7a70 5f72 6561 6428 6f66 6673  s = zp_read(offs
+000339b0: 6574 5f66 696c 6529 0a0a 2020 2020 666f  et_file)..    fo
+000339c0: 7220 6669 6c74 2069 6e20 6f66 6673 6574  r filt in offset
+000339d0: 732e 6b65 7973 2829 3a0a 2020 2020 2020  s.keys():.      
+000339e0: 2020 6620 3d20 6361 745b 315d 2e64 6174    f = cat[1].dat
+000339f0: 612e 636f 6c75 6d6e 735b 6669 6c74 5d2e  a.columns[filt].
+00033a00: 6172 7261 7920 213d 2039 390a 2020 2020  array != 99.    
+00033a10: 2020 2020 6361 745b 315d 2e64 6174 612e      cat[1].data.
+00033a20: 636f 6c75 6d6e 735b 6669 6c74 5d2e 6172  columns[filt].ar
+00033a30: 7261 795b 665d 202b 3d20 6f66 6673 6574  ray[f] += offset
+00033a40: 735b 6669 6c74 5d0a 0a20 2020 2063 6174  s[filt]..    cat
+00033a50: 2e77 7269 7465 746f 2873 6176 655f 6669  .writeto(save_fi
+00033a60: 6c65 290a                                le).
```

## Comparing `spluscalib-0.3.4.dist-info/LICENSE` & `spluscalib-0.3.5.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `spluscalib-0.3.4.dist-info/METADATA` & `spluscalib-0.3.5.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: spluscalib
-Version: 0.3.4
+Version: 0.3.5
 Summary: S-PLUS calibration pipeline
 Home-page: https://github.com/felipefer42/spluscalib
 Author: Felipe Almeida Fernandes
 Author-email: felipefer42@gmail.com
 License: UNKNOWN
 Platform: UNKNOWN
 Requires-Python: >3.6.0
```

## Comparing `spluscalib-0.3.4.dist-info/RECORD` & `spluscalib-0.3.5.dist-info/RECORD`

 * *Files 8% similar despite different names*

```diff
@@ -2,15 +2,15 @@
 spluscalib/dust_laws.py,sha256=hdoLYqKL_FZCWi_amOZfiz-POGzhsiinCzvL58z9FSY,5765
 spluscalib/pipeline.py,sha256=Xk15eaRnEX4eZROvmGOM5K8a8CSkzb0lSzIu3Ezh9eU,18909
 spluscalib/pipeline_backup.py,sha256=E5sBhePbdD5Y1Q07Qsl8tXPJnT8R_WBEYTaQea2KO8k,24012
 spluscalib/quality_check.py,sha256=QL_hZJ9XZM2j-vIDn5WZ3BkAZ679tT7kbvue-el660c,22256
 spluscalib/quality_check_PSF.py,sha256=FjfKV7MJgtRimxhoE3J-7m5-Dx5XJ7Hd36DGinIV5Ak,12013
 spluscalib/quality_check_PSFbackup.py,sha256=Q74hs6EezdORxnhZLHDpPvTB6eSFLdmzdN-6GCRHYUE,12039
 spluscalib/sed_fitting.py,sha256=G-MXyKAzODmJsffuNK19JfB5fDJUWFmt3UqyNgMca1Y,12938
-spluscalib/utils.py,sha256=sdxGg12n1ChNT26Nk8ofEF--PT6T_4UpzaozDdqek4Q,211616
+spluscalib/utils.py,sha256=gAwZjnYk4c0B_ARIifAj4yZigshoGvHJKQ-Nc4lKwUU,211556
 spluscalib/additionalsteps/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 spluscalib/additionalsteps/combine_calibration_catalogs.py,sha256=54WYLrVzeJorS0KaeROfCitqh9HafRqCp7MygddtM3o,10844
 spluscalib/additionalsteps/compute_XY_maps.py,sha256=8tEpJOCfoJkVLuFLzSDTLkv5G3t5LDFsYyVDiebKjzo,8615
 spluscalib/additionalsteps/fit_inst_offsets.py,sha256=QPh_0H0n17jNpG6dwYgKAR4QHruMfsWeA1lfY1GKHIo,6498
 spluscalib/additionalsteps/fit_zp_offsets.py,sha256=PaRIo1RINVoiw674bhsCySkVRvywpxf0i0unbpQ8xCw,7383
 spluscalib/steps/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 spluscalib/steps/calibration_catalog.py,sha256=M17J4JFsks785NWZggQvokatLX6b1bp_IAa-6hTZRTs,19310
@@ -39,12 +39,12 @@
 spluscalib/vacs/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 stellarlibrary/__init__.py,sha256=AbpHGcgLb-kRsJGnwFEktk7uzpZOCcBY74-YBdrKVGs,1
 stellarlibrary/dust_laws.py,sha256=Vl0unAHUYGg6NVG01PJBzDkAZYlSqnZftxct72HEg7w,5766
 stellarlibrary/generate_models_photometry.py,sha256=ftxuZ2VCHFAcTaCtbB-lcymrRE5M1XaNnVhzBhg0Pjw,2789
 stellarlibrary/generate_models_photometry_iDR5.py,sha256=eplonDLmFVNFfXAinnaqsC0lr3S-97KCJ-RUw0vpZdQ,2840
 stellarlibrary/models.py,sha256=eveTaN7n_cLnHOpLCzBgJ5S4uVmscIJA1_6hPm3rsFQ,23858
 stellarlibrary/prior.py,sha256=Amsfbc1h9WOQm66mgKc-wxNw--Nq2WlsUfVVlvhXHFE,11821
-spluscalib-0.3.4.dist-info/LICENSE,sha256=OXLcl0T2SZ8Pmy2_dmlvKuetivmyPd5m1q-Gyd-zaYY,35149
-spluscalib-0.3.4.dist-info/METADATA,sha256=9oWvL9CgzYVW9g-MS-2urUZU2-n01INfk8NZzgZu9cc,558
-spluscalib-0.3.4.dist-info/WHEEL,sha256=OqRkF0eY5GHssMorFjlbTIq072vpHpF60fIQA6lS9xA,92
-spluscalib-0.3.4.dist-info/top_level.txt,sha256=N3vgNwg_Oe8WlUh9yWdZZeI3SN8J8zI3yItBm2Bkkos,26
-spluscalib-0.3.4.dist-info/RECORD,,
+spluscalib-0.3.5.dist-info/LICENSE,sha256=OXLcl0T2SZ8Pmy2_dmlvKuetivmyPd5m1q-Gyd-zaYY,35149
+spluscalib-0.3.5.dist-info/METADATA,sha256=JAymB245PzzzgZ6cCAhuvX1BYVXkiMpXVqxBlGl-M9Q,558
+spluscalib-0.3.5.dist-info/WHEEL,sha256=OqRkF0eY5GHssMorFjlbTIq072vpHpF60fIQA6lS9xA,92
+spluscalib-0.3.5.dist-info/top_level.txt,sha256=N3vgNwg_Oe8WlUh9yWdZZeI3SN8J8zI3yItBm2Bkkos,26
+spluscalib-0.3.5.dist-info/RECORD,,
```

